<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <link rel="icon" type="image/png" href="/image/simbol.png" media="(prefers-color-scheme: light)">
    <link rel="icon" type="image/png" href="/image/dark_simbol.png" media="(prefers-color-scheme: dark)">
    <meta name="description" content="전국 중학교의 오늘 급식, 주간 급식표를 간편하게 확인하세요. 서울, 부산, 대구 등 지역별 중학교 급식 정보 제공">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>N-MATE | 학교별 급식</title> <!-- 타이틀이 동적으로 변경됩니다. -->
    <!-- Tailwind CSS CDN을 로드합니다. -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Pretendard 폰트 (모든 굵기 포함) 로드 -->
    <link rel="stylesheet" as="style" crossorigin href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard@v1.3.9/dist/web/static/pretendard.css" />
    <style>
        /* Body 스타일: Pretendard 폰트를 기본으로 설정 */
        body {
            font-family: 'Pretendard', sans-serif; /* 'Pretendard'는 위 CSS 파일에서 정의됩니다. */
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            display: flex;
            flex-direction: column;
            min-height: 100vh;
            background-color: #ffffff; /* 라이트 그레이 배경 */
        }
        /* 스켈레톤 로더 애니메이션 */
        .skeleton {
            animation: pulse 1.5s infinite ease-in-out;
            background: linear-gradient(-90deg, #f0f0f0 0%, #f8f8f8 50%, #f0f0f0 100%);
            background-size: 200% 100%;
        }
        @keyframes pulse {
            0% {
                background-position: -200% 0;
            }
            50% {
                background-position: 200% 0;
            }
            100% {
                background-position: -200% 0;
            }
        }
        .skeleton-text {
            height: 1em; /* 필요에 따라 조정 */
            width: 80%; /* 필요에 따라 조정 */
            margin-bottom: 0.5em;
            border-radius: 4px;
        }

        /* 메인 콘텐츠 컨테이너 */
        .main-content-container {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            align-items: flex-start; /* 콘텐츠를 왼쪽으로 정렬 */
            max-width: 36rem; /* 콘텐츠 최대 너비 */
            margin-left: auto;
            margin-right: auto;
            width: 100%;
            position: relative; /* 드롭다운 메뉴 절대 위치 지정을 위해 */
            padding-bottom: 70px; /* 하단 고정 내비게이션 바를 위한 공간 */
        }

        /* 드롭다운 메뉴 스타일 */
        .dropdown-menu {
            position: absolute; /* position: relative인 부모에 상대적 */
            background-color: white;
            border-radius: 0.5rem; /* rounded-md */
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06); /* shadow-lg */
            padding-top: 0.25rem; /* py-1 */
            padding-bottom: 0.25rem;
            min-width: 8rem; /* w-40 */
            right: 0; /* 계정 탭 버튼의 오른쪽에 정렬 */
            top: calc(100% + 0.5rem); /* 버튼 아래 0.5rem 간격으로 배치 */
            z-index: 20; /* 다른 콘텐츠 위에 표시되도록 보장 */
        }

        .dropdown-menu button {
            width: 100%;
            text-align: left;
            padding: 0.5rem 1rem; /* px-4 py-2 */
            font-size: 0.875rem; /* text-sm */
            color: #374151; /* text-gray-700 */
            transition: background-color 0.2s ease;
        }

        .dropdown-menu button:hover {
            background-color: #f3f4f6; /* hover:bg-gray-100 */
        }

        /* 탭 버튼 컨테이너 스타일 */
        .tab-buttons-container {
            display: flex;
            width: 100%; /* px-6 부모의 전체 너비를 차지하도록 조정 */
            margin-top: 1.5rem; /* 상단 여백 */
            margin-bottom: 0.5rem; /* 하단 여백 */
            border-bottom: 2px solid #e5e7eb; /* 구분선 */
        }
        .tab-button {
            flex-grow: 1;
            padding: 0.75rem 1rem;
            font-size: 1rem;
            font-weight: 600;
            color: #374151; /* 대비율 개선을 위해 Gray-500(#6b7280)에서 Gray-700으로 조정 */
            background-color: transparent;
            border: none;
            border-bottom: 2px solid transparent; /* 비활성 상태 투명 테두리 */
            transition: all 0.2s ease;
            cursor: pointer;
            outline: none;
            text-align: center;
        }
        .tab-button.active {
            color: #3b82f6; /* Blue-500 */
            border-bottom-color: #3b82f6; /* 활성 탭에 Blue-500 테두리 */
        }
        .tab-button:hover:not(.active) {
            color: #4f46e5; /* 호버 시 Indigo-600 */
            background-color: #f9fafb; /* 호버 시 더 밝은 배경 */
        }

        /* 급식 콘텐츠 영역 특정 스타일 */
        .meal-content-box {
            background-color: #ffffff;
            border-radius: 0.75rem;
            border: 1px solid #e2e8f0;
            padding: 1.5rem;
            text-align: left;
            min-height: 150px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: flex-start;
            width: 100%; /* 추가: 부모의 전체 너비를 차지하도록 */
        }
        .meal-content-box p {
            margin-bottom: 0.5rem;
            font-size: 0.875rem;
            line-height: 1.5;
            color: #374151; /* Gray-700 */
        }
        .meal-content-box p:last-child {
            margin-bottom: 0;
        }
        /* 날짜 선택 버튼 스타일 (급식) */
        .date-button-container {
            display: flex;
            justify-content: space-around;
            width: 100%;
            background-color: #f8f8f8;
            border-radius: 0.5rem;
            overflow: hidden;
            padding: 0.25rem;
            gap: 0.25rem;
        }
        .date-button {
            flex-grow: 1;
            padding: 0.75rem 0.5rem;
            border-radius: 0.375rem;
            font-size: 0.875rem;
            font-weight: 500;
            color: #374151; /* 대비율 개선을 위해 Gray-600(#4b5563)에서 Gray-700으로 조정 */
            background-color: transparent;
            transition: all 0.2s ease;
            text-align: center;
            cursor: pointer;
            border: none;
            outline: none;
        }
        .date-button.active {
            background-color: #3b82f6;
            color: #ffffff;
            box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
        }
        .date-button:not(.active):hover {
            background-color: #e5e7eb;
        }
    </style>
</head>
<body>

    <!-- 메인 콘텐츠 영역 -->
    <div class="main-content-container">

        <!-- 헤더: 로고 및 계정/로그인 섹션 -->
        <div class="w-full flex justify-between items-center px-4 pt-4">
            <!-- 로고 -->
            <div class="flex items-center">
                <!-- LCP 개선: 이미지에 width, height 속성 추가 및 .webp 형식 사용 -->
                <img src="/image/logo.webp" alt="N-MATE 로고" class="h-12 w-auto" width="192" height="48">
            </div>

            <!-- 드롭다운이 있는 계정/로그인 섹션 -->
            <div class="relative">
                <div id="accountStatusArea" class="flex items-center">
                    <!-- JavaScript로 주입되는 조건부 콘텐츠 -->
                </div>
                <!-- 드롭다운 메뉴 (초기에는 숨김) -->
                <div id="accountDropdown" class="dropdown-menu hidden">
                    <button id="settingsButton" class="block">설정</button>
                    <button id="logoutButton" class="block">로그아웃</button>
                </div>
            </div>
        </div>

        <!-- 학교생활 섹션 컨테이너 -->
        <div class="w-full flex flex-col items-start px-4 mt-8 mb-4">
            <!-- 섹션 제목 -->
            <h2 class="text-left text-xl font-bold text-gray-800" id="schoolLifeTitle">학교생활</h2>

            <!-- 섹션 간 전환을 위한 탭 버튼 (시간표, 급식, 학사일정) -->
            <div class="tab-buttons-container">
                <!-- data-path를 각 페이지 경로로 설정하여 페이지 이동 처리 -->
                <button id="tab-timetable" class="tab-button" data-tab-id="timetableContent" data-path="/timetable">시간표</button>
                <button id="tab-meal" class="tab-button" data-tab-id="mealContent" data-path="/meal">급식</button>
                <button id="tab-academic" class="tab-button" data-tab-id="academicScheduleContent" data-path="/schedule">학사일정</button>
            </div>

            <!-- 급식 섹션 (이 페이지에서는 급식만 표시됩니다) -->
            <div id="mealContent" class="tab-content w-full flex flex-col items-start gap-y-2 mt-4">
                <!-- 날짜 선택 버튼 -->
                <div id="meal-date-buttons-container" class="date-button-container">
                    <!-- 날짜 버튼은 JavaScript에 의해 여기에 렌더링됩니다. -->
                </div>

                <!-- 날짜 선택기 입력, 초기에는 숨김 -->
                <input type="date" id="mealDatePicker" class="hidden w-full mt-2 p-2 border border-gray-300 rounded-md text-gray-700 focus:ring-blue-500 focus:border-blue-500">

                <!-- 급식 표시 영역 -->
                <div id="meal-display-section" class="w-full meal-content-box mt-4">
                    <!-- 급식 콘텐츠용 스켈레톤 로더 -->
                    <div class="w-full">
                        <div class="skeleton skeleton-text w-full"></div>
                        <div class="skeleton skeleton-text w-5/6"></div>
                        <div class="skeleton skeleton-text w-3/4"></div>
                        <div class="skeleton skeleton-text w-1/2"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 하단 내비게이션 바 -->
    <nav class="fixed bottom-0 left-0 right-0 bg-white p-3 border-t border-gray-300 max-w-xl mx-auto w-full z-10">
        <div class="flex justify-around items-center h-12">
            <!-- 홈 내비게이션 아이템 -->
            <button id="nav-home" class="nav-item flex flex-col items-center justify-center p-2 rounded-xl transition-all duration-300 text-gray-500 hover:text-blue-500 hover:bg-gray-50" data-tab="홈" data-path="/">
                <svg viewBox="0 0 24 24" fill="currentColor" class="w-6 h-6 mb-1" xmlns="http://www.w3.org/2000/svg">
                    <path d="M10 20V14H14V20H19V12H22L12 3L2 12H5V20H10Z"/>
                </svg>
                <span class="text-xs font-medium">홈</span>
            </button>

            <!-- 학교생활 내비게이션 아이템 -->
            <button id="nav-school-life" class="nav-item flex flex-col items-center justify-center p-2 rounded-xl transition-all duration-300 text-gray-500 hover:text-blue-500 hover:bg-gray-50" data-tab="학교생활" data-path="/sclife">
                <svg viewBox="0 0 24 24" fill="currentColor" class="w-6 h-6 mb-1" xmlns="http://www.w3.org/2000/svg">
                    <path d="M4 19V6.5C4 5.94772 4.44772 5.5 5 5.5H19C19.5523 5.5 20 5.94772 20 6.5V19C20 19.5523 19.5523 20 19 20H5C4.44772 20 4 19.5523 4 19ZM6 17H18V7.5H6V17ZM9 10H15V12H9V10Z"/>
                </svg>
                <span class="text-xs font-medium">학교생활</span>
            </button>

            <!-- 커뮤니티 내비게이션 아이템 -->
            <button id="nav-community" class="nav-item flex flex-col items-center justify-center p-2 rounded-xl transition-all duration-300 text-gray-500 hover:text-blue-500 hover:bg-gray-50" data-tab="커뮤니티" data-path="/community">
                <svg viewBox="0 0 24 24" fill="currentColor" class="w-6 h-6 mb-1" xmlns="http://www.w3.org/2000/svg">
                    <path d="M16 11C18.21 11 20 9.21 20 7C20 4.79 18.21 3 16 3C13.79 3 12 4.79 12 7C12 9.21 13.79 11 16 11ZM8 11C10.21 11 12 9.21 12 7C12 4.79 10.21 3 8 3C5.79 3 4 4.79 4 7C4 9.21 5.79 11 8 11ZM16 13C13.67 13 9.34 14.28 9 17V19H23V17C22.66 14.28 18.33 13 16 13ZM8 13C5.33 13 0 14.33 0 17V19H9V17C8.67 14.33 4.33 13 8 13Z"/>
                </svg>
                <span class="text-xs font-medium">커뮤니티</span>
            </button>

            <!-- 캘린더 내비게이션 아이템 -->
            <button id="nav-calendar" class="nav-item flex flex-col items-center justify-center p-2 rounded-xl transition-all duration-300 text-gray-500 hover:text-blue-500 hover:bg-gray-50" data-tab="캘린더" data-path="/calendar">
                <svg viewBox="0 0 24 24" fill="currentColor" class="w-6 h-6 mb-1" xmlns="http://www.w3.org/2000/svg">
                    <path d="M19 4H18V2H16V4H8V2H6V4H5C3.89 4 3 4.9 3 6V20C3 21.1 3.89 22 5 22H19C20.1 22 21 21.1 21 20V6C21 4.9 20.1 4 19 4ZM19 20H5V9H19V20Z"/>
                </svg>
                <span class="text-xs font-medium">캘린더</span>
            </button>

            <!-- 더보기 내비게이션 아이템 -->
            <button id="nav-more" class="nav-item flex flex-col items-center justify-center p-2 rounded-xl transition-all duration-300 text-gray-500 hover:text-blue-500 hover:bg-blue-50" data-tab="더보기" data-path="/more">
                <svg viewBox="0 0 24 24" fill="currentColor" class="w-6 h-6 mb-1" xmlns="http://www.w3.org/2000/svg">
                    <path d="M12 10C10.9 10 10 10.9 10 12C10 13.1 10.9 14 12 14C13.1 14 14 13.1 14 12C14 10.9 13.1 10 12 10ZM19 10C17.9 10 17 10.9 17 12C17 13.1 17.9 14 19 14C20.1 14 21 13.1 21 12C21 10.9 20.1 10 19 10ZM5 10C3.9 10 3 10.9 3 12C3 13.1 3.9 14 5 14C6.1 14 7 13.1 7 12C7 10.9 6.1 10 5 10Z"/>
                </svg>
                <span class="text-xs font-medium">더보기</span>
            </button>
        </div>
    </nav>

    <!-- Firebase SDK CDN - defer 속성을 사용하여 렌더링 차단 방지 -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js" defer></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js" defer></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js" defer></script>
    <!-- Lucide Icons CDN - defer 속성을 사용하여 렌더링 차단 방지 -->
    <script src="https://unpkg.com/lucide@latest" defer></script>

    <script>
        // Firebase 구성 정보를 위한 전역 변수 (Canvas 환경에서 제공)
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = {
            apiKey: "AIzaSyC_SHRcQ9hXmjVbP3km4rdR4UvKIoqpLHo",
            authDomain: "n-mate.firebaseapp.com",
            projectId: "n-mate",
            storageBucket: "n-mate.firebasestorage.app",
            appId: "1:691313471077:web:3066aaeca0a1d9e448e08c",
            measurementId: "G-0LCGVBKXLQ",
            messagingSenderId: "691313471077"
        };

        // Firebase 앱, 인증, Firestore 인스턴스
        let app;
        let auth;
        let db;

        // NEIS API 공통 정보 (API 키)
        const neisApiKey = "cbb4da48e87445f68c2732368454ebc3"; // 실제 API 키로 교체
        
        // User's school information (default to Busan Namjung Middle School)
        // 이 변수들은 URL 파라미터나 Firebase 사용자 프로필에 의해 동적으로 설정됩니다.
        let currentEffectiveEduCode = "C10"; // 현재 유효한 교육청 코드 (부산광역시 교육청)
        let currentEffectiveSchoolCode = "7171018"; // 현재 유효한 학교 코드 (남중학교)
        let currentEffectiveSchoolName = "학교 이름"; // 현재 유효한 학교 이름 (동적으로 설정됨)

        // DOM elements (general)
        const accountStatusArea = document.getElementById('accountStatusArea');
        const accountDropdown = document.getElementById('accountDropdown');
        const schoolLifeTitle = document.getElementById('schoolLifeTitle');
        const pageTitleElement = document.querySelector('title');


        // DOM elements (tabs)
        const tabButtons = document.querySelectorAll('.tab-button');
        const mealContent = document.getElementById('mealContent'); // 이 페이지에서 유일하게 표시될 콘텐츠

        // DOM elements (Meal)
        const mealDisplaySection = document.getElementById('meal-display-section');
        const mealDateButtonsContainer = document.getElementById('meal-date-buttons-container');
        const mealDatePicker = document.getElementById('mealDatePicker');
        let mealCurrentSelectedDate = ''; // 급식을 위해 현재 선택된 날짜 추적

        // 각 탭의 데이터 로딩 여부 추적 (불필요한 API 호출 방지)
        // 이 페이지는 급식만 담당하므로 'mealContent'만 유지
        const loadedTabs = {
            mealContent: false
        };

        /**
         * URL에서 쿼리 파라미터를 파싱하여 객체로 반환합니다.
         * @returns {Object} 쿼리 파라미터를 포함하는 객체.
         */
        function getQueryParams() {
            const params = {};
            window.location.search.substring(1).split('&').forEach(param => {
                const parts = param.split('=');
                if (parts.length === 2) {
                    params[decodeURIComponent(parts[0])] = decodeURIComponent(parts[1]);
                }
            });
            return params;
        }

        /**
         * 지정된 탭 콘텐츠를 표시하고 탭 버튼의 활성 상태를 업데이트합니다.
         * 이 페이지는 급식만 담당하므로 'mealContent' 탭만 표시하고 데이터를 가져옵니다.
         * 다른 탭 ID가 호출되면 무시합니다.
         * @param {string} tabId - 표시할 탭 콘텐츠의 ID (예: 'mealContent').
         */
        async function showTab(tabId) {
            // 이 페이지는 오직 'mealContent'만 표시합니다.
            if (tabId !== 'mealContent') {
                return; // 다른 탭 ID는 무시합니다.
            }

            // 모든 탭 버튼 비활성화 (현재 페이지의 탭 버튼에만 적용)
            tabButtons.forEach(button => {
                button.classList.remove('active');
            });

            // 선택된 탭 콘텐츠 표시
            mealContent.classList.remove('hidden');
            // 해당 탭 버튼 활성화
            const mealTabButton = document.querySelector(`.tab-button[data-tab-id="${tabId}"]`);
            if (mealTabButton) {
                mealTabButton.classList.add('active');
            }


            // 유효한 학교 정보를 확인
            if (!currentEffectiveEduCode || !currentEffectiveSchoolCode) {
                mealDisplaySection.innerHTML = '<p class="text-base text-gray-700 text-center mt-4">학교 정보가 설정되지 않았습니다. 설정 페이지에서 학교를 선택해주세요.</p>';
                return;
            }

            // 탭의 데이터를 아직 로드하지 않았다면 로드합니다.
            if (!loadedTabs[tabId]) {
                // 급식 섹션용 스켈레톤 로더
                mealDisplaySection.innerHTML = `
                    <div class="w-full">
                        <div class="skeleton skeleton-text w-full"></div>
                        <div class="skeleton skeleton-text w-5/6"></div>
                        <div class="skeleton skeleton-text w-3/4"></div>
                        <div class="skeleton skeleton-text w-1/2"></div>
                    </div>
                `;
                // Initialize meal date buttons and fetch for today
                const todayDate = new Date();
                const year = todayDate.getFullYear();
                const month = String(todayDate.getMonth() + 1).padStart(2, '0');
                const day = String(todayDate.getDate()).padStart(2, '0');
                const todayYYYYMMDD = `${year}${month}${day}`;
                renderMealDateButtons(todayYYYYMMDD); // Render date buttons with today as active
                await fetchMealData(todayYYYYMMDD, currentEffectiveEduCode, currentEffectiveSchoolCode); // Fetch meal for today's date initially
                loadedTabs[tabId] = true; // 로드됨으로 표시
            }
        }

        // --- 급식 함수 ---

        /**
         * 현재 주의 월요일부터 금요일까지의 날짜와 이름을 계산합니다.
         * @returns {Array<Object>} `dayName`(요일 이름), `date`(YYYYMMDD 형식의 날짜)를 포함하는 객체 배열.
         */
        function getMealWeekdaysInfo() {
            const today = new Date();
            const dayOfWeek = today.getDay(); // 0: 일요일, 1: 월요일, ..., 6: 토요일
            const monday = new Date(today);
            monday.setDate(today.getDate() - dayOfWeek + (dayOfWeek === 0 ? -6 : 1));

            const weekdaysInfo = [];
            const dayNames = ['월', '화', '수', '목', '금'];

            for (let i = 0; i < 5; i++) {
                const date = new Date(monday);
                date.setDate(monday.getDate() + i);
                const year = date.getFullYear();
                const month = String(date.getMonth() + 1).padStart(2, '0');
                const day = String(date.getDate()).padStart(2, '0');
                weekdaysInfo.push({
                    dayName: dayNames[i],
                    date: `${year}${month}${day}`
                });
            }
            return weekdaysInfo;
        }

        /**
         * 급식을 위한 날짜 선택 버튼(월~금)과 "날짜 선택" 버튼을 렌더링합니다.
         * 이벤트 리스너를 연결합니다.
         * @param {string} initialDateYYYYMMDD - 초기 선택/활성 상태로 설정할 날짜.
         */
        function renderMealDateButtons(initialDateYYYYMMDD) {
            const weekdaysInfo = getMealWeekdaysInfo();
            mealDateButtonsContainer.innerHTML = '';
            mealDatePicker.classList.add('hidden');

            weekdaysInfo.forEach(dayInfo => {
                const button = document.createElement('button');
                button.classList.add('date-button');
                button.textContent = dayInfo.dayName;
                button.dataset.date = dayInfo.date;

                button.addEventListener('click', () => {
                    handleMealDateButtonClick(button, dayInfo.date);
                });
                mealDateButtonsContainer.appendChild(button);
            });

            const customDateButton = document.createElement('button');
            customDateButton.id = 'mealCustomDateSelectButton';
            customDateButton.classList.add('date-button');
            customDateButton.textContent = '날짜 선택';
            customDateButton.addEventListener('click', showMealDatePicker);
            mealDateButtonsContainer.appendChild(customDateButton);

            let foundActiveWeekday = false;
            weekdaysInfo.forEach(dayInfo => {
                if (dayInfo.date === initialDateYYYYMMDD) {
                    const targetButton = document.querySelector(`#meal-date-buttons-container .date-button[data-date="${dayInfo.date}"]`);
                    if (targetButton) {
                        targetButton.classList.add('active');
                        foundActiveWeekday = true;
                    }
                }
            });

            if (!foundActiveWeekday) {
                customDateButton.classList.add('active');
            }
        }

        /**
         * 급식용 요일 날짜 버튼 클릭을 처리합니다.
         * @param {HTMLElement} clickedButton - 클릭된 버튼 요소.
         * @param {string} selectedDate - 버튼과 관련된 날짜 문자열.
         */
        function handleMealDateButtonClick(clickedButton, selectedDate) {
            mealDatePicker.classList.add('hidden');

            document.querySelectorAll('#meal-date-buttons-container .date-button').forEach(btn => btn.classList.remove('active'));
            clickedButton.classList.add('active');

            mealCurrentSelectedDate = selectedDate;
            fetchMealData(mealCurrentSelectedDate, currentEffectiveEduCode, currentEffectiveSchoolCode);
        }

        /**
         * 급식용 날짜 선택기 입력을 표시하고 다른 버튼의 활성 상태를 지웁니다.
         */
        function showMealDatePicker() {
            document.querySelectorAll('#meal-date-buttons-container .date-button').forEach(btn => btn.classList.remove('active'));
            document.getElementById('mealCustomDateSelectButton').classList.add('active');

            mealDatePicker.classList.remove('hidden');
            if (mealCurrentSelectedDate) {
                mealDatePicker.value = `${mealCurrentSelectedDate.substring(0,4)}-${mealCurrentSelectedDate.substring(4,6)}-${mealCurrentSelectedDate.substring(6,8)}`;
            } else {
                const today = new Date();
                const year = today.getFullYear();
                const month = String(today.getMonth() + 1).padStart(2, '0');
                const day = String(today.getDate()).padStart(2, '0');
                mealDatePicker.value = `${year}-${month}-${day}`;
            }
        }

        /**
         * 급식용 날짜 선택기 입력에서 날짜 선택을 처리합니다.
         */
        function handleMealDatePickerChange() {
            const selectedDate = mealDatePicker.value.replace(/-/g, '');
            if (selectedDate) {
                document.querySelectorAll('#meal-date-buttons-container .date-button').forEach(btn => btn.classList.remove('active'));
                document.getElementById('mealCustomDateSelectButton').classList.add('active');

                mealCurrentSelectedDate = selectedDate;
                fetchMealData(mealCurrentSelectedDate, currentEffectiveEduCode, currentEffectiveSchoolCode);
            }
        }

        /**
         * NEIS API에서 특정 날짜의 급식 데이터를 가져와 표시합니다.
         * @param {string} date - 급식 데이터를 가져올NESDAYMMDD 형식의 날짜.
         * @param {string} eduCode - 교육청 코드.
         * @param {string} schoolCode - 학교 코드.
         */
        async function fetchMealData(date, eduCode, schoolCode) {
            mealDisplaySection.innerHTML = `
                <div class="w-full">
                    <div class="skeleton skeleton-text w-full"></div>
                    <div class="skeleton skeleton-text w-5/6"></div>
                    <div class="skeleton skeleton-text w-3/4"></div>
                    <div class="skeleton skeleton-text w-1/2"></div>
                </div>
            `;

            if (!eduCode || !schoolCode) {
                mealDisplaySection.innerHTML = '<p class="text-base text-gray-700 text-center">학교 정보가 설정되지 않았습니다. 설정 페이지에서 학교를 선택해주세요.</p>';
                return;
            }

            const apiUrl = `https://open.neis.go.kr/hub/mealServiceDietInfo?KEY=${neisApiKey}&Type=json&pIndex=1&pSize=100&ATPT_OFCDC_SC_CODE=${eduCode}&SD_SCHUL_CODE=${schoolCode}&MLSV_YMD=${date}`;

            try {
                const response = await fetch(apiUrl);
                const data = await response.json();

                if (data.mealServiceDietInfo && data.mealServiceDietInfo[1] && data.mealServiceDietInfo[1].row) {
                    const meals = data.mealServiceDietInfo[1].row;
                    const lunchMeal = meals.find(meal => meal.MMEAL_SC_NM === '중식');

                    if (lunchMeal) {
                        // 괄호 안의 알레르기 정보 및 기타 불필요한 정보 제거
                        const menu = lunchMeal.DDISH_NM.replace(/\([^)]*\)/g, '').replace(/[0-9.]/g, '').trim();
                        const menuItems = menu.split('<br/>').map(item => item.trim()).filter(item => item !== '');

                        let menuHtml = '<div class="text-left">';
                        if (menuItems.length > 0) {
                            menuItems.forEach(item => {
                                menuHtml += `<p class="text-base font-medium text-gray-800">${item}</p>`;
                            });
                        } else {
                            menuHtml += `<p class="text-base text-gray-700">이 날짜의 중식 메뉴는 비어 있습니다.</p>`;
                        }
                        menuHtml += '</div>';
                        mealDisplaySection.innerHTML = menuHtml;
                    } else {
                        mealDisplaySection.innerHTML = '<p class="text-base text-gray-700 text-center">선택된 날짜의 중식 정보가 없어요.</p>';
                    }
                } else if (data.RESULT && data.RESULT.CODE === 'INFO-200') {
                    mealDisplaySection.innerHTML = '<p class="text-base text-gray-700 text-center">등록된 급식이 없어요.</p>';
                } else {
                    mealDisplaySection.innerHTML = '<p class="text-base text-red-500 text-center">급식 정보를 가져오는 데 실패했습니다.</p>';
                }
            } catch (error) {
                console.error('급식 데이터 가져오기 오류:', error);
                mealDisplaySection.innerHTML = '<p class="text-base text-red-500 text-center">급식 정보를 가져오는 중 오류가 발생했습니다.</p>';
            }
        }


        // --- 공통 함수 (계정, 내비게이션, 학교 정보) ---

        /**
         * 계정 드롭다운 메뉴의 가시성을 토글합니다.
         */
        function toggleDropdown() {
            accountDropdown.classList.toggle('hidden');
        }

        /**
         * 사용자 로그아웃을 처리합니다.
         */
        async function handleLogout() {
            if (auth) {
                try {
                    await auth.signOut();
                    console.log('로그아웃 성공.');
                    window.location.href = '/login';
                } catch (error) {
                    console.error('로그아웃 오류:', error);
                }
            }
        }

        /**
         * 설정 페이지로 이동을 처리합니다.
         */
        function handleSettingsClick() {
            window.location.href = '/settings';
        }

        /**
         * 사용자 인증 상태에 따라 계정 UI를 업데이트합니다.
         * 로그인된 경우 이메일 접두사를 표시하고, 그렇지 않은 경우 "로그인" 버튼을 표시합니다.
         * @param {firebase.User} user - 인증된 사용자 객체 또는 null.
         */
        async function updateAccountUI(user) {
            if (user && user.email) {
                const emailPrefix = user.email.split('@')[0];
                accountStatusArea.innerHTML = `
                    <button id="accountTabButton" class="flex items-center space-x-2 p-2 rounded-full hover:bg-gray-100 focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <span class="text-gray-700 text-sm font-medium">${emailPrefix}</span>
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-user-circle-2"><path d="M18 20a6 6 0 0 0-12 0"/><circle cx="12" cy="10" r="4"/><circle cx="12" cy="12" r="10"/></svg>
                    </button>
                `;
                document.getElementById('accountTabButton').addEventListener('click', toggleDropdown);

                const settingsButton = document.getElementById('settingsButton');
                if (settingsButton && !settingsButton.dataset.listenerAdded) {
                    settingsButton.addEventListener('click', handleSettingsClick);
                    settingsButton.dataset.listenerAdded = 'true';
                }
                const logoutButton = document.getElementById('logoutButton');
                if (logoutButton && !logoutButton.dataset.listenerAdded) {
                    logoutButton.addEventListener('click', handleLogout);
                    logoutButton.dataset.listenerAdded = 'true';
                }
            } else {
                accountStatusArea.innerHTML = `
                    <button id="loginRedirectButton" class="bg-blue-500 hover:bg-blue-600 text-white font-medium py-2 px-4 rounded-full shadow transition duration-300">
                        로그인
                    </button>
                `;
                document.getElementById('loginRedirectButton').addEventListener('click', () => {
                    window.location.href = '/login';
                });
                accountDropdown.classList.add('hidden');
            }
            lucide.createIcons(); // 계정 상태 영역의 Lucide 아이콘(user-circle-2)을 생성해야 함
        }

        /**
         * 현재 URL 경로에 따라 내비게이션 바 버튼의 활성 상태를 업데이트합니다.
         */
        function updateNavigationActiveState() {
            const currentPathname = window.location.pathname; // 현재 페이지의 경로

            const navItems = document.querySelectorAll('.nav-item');
            navItems.forEach(item => {
                const itemPath = item.dataset.path;
                const spanElement = item.querySelector('span');
                const svgElement = item.querySelector('svg');

                // 스타일 초기화
                item.classList.remove('text-blue-600');
                item.classList.add('text-gray-500', 'hover:text-blue-500', 'hover:bg-gray-50');
                if (spanElement) {
                    spanElement.classList.remove('font-bold');
                    spanElement.classList.add('font-medium');
                }
                if (svgElement) {
                    svgElement.classList.remove('text-blue-600');
                    svgElement.classList.add('text-gray-500'); // SVG도 회색 기본 색상을 갖도록 보장
                }

                // 활성화 로직
                let isActive = false;
                if (currentPathname === itemPath) {
                    isActive = true; // 정확한 경로 일치
                } else if (itemPath === '/sclife' && (currentPathname === '/meal' || currentPathname === '/timetable' || currentPathname === '/schedule')) {
                    isActive = true; // '학교생활' 내비게이션 항목은 학교생활 관련 페이지에서 활성화
                }

                if (isActive) {
                    item.classList.add('text-blue-600');
                    item.classList.remove('text-gray-500', 'hover:text-blue-500', 'hover:bg-gray-50');
                    if (spanElement) {
                        spanElement.classList.add('font-bold');
                        spanElement.classList.remove('font-medium');
                    }
                    if (svgElement) {
                        svgElement.classList.add('text-blue-600'); // 활성 SVG에 파란색 적용
                        svgElement.classList.remove('text-gray-500');
                    }
                }
            });

            // 현재 페이지가 /meal인 경우, 급식 탭 버튼 활성화
            const mealTabButton = document.querySelector(`.tab-button[data-path="/meal"]`);
            if (mealTabButton && window.location.pathname === '/meal') {
                tabButtons.forEach(button => button.classList.remove('active')); // 모든 탭 버튼 비활성화
                mealTabButton.classList.add('active'); // 급식 탭만 활성화
            }
        }

        /**
         * 내비게이션 항목에 클릭 이벤트 리스너를 설정합니다.
         */
        function setupNavigationEvents() {
            const navItems = document.querySelectorAll('.nav-item');
            navItems.forEach(item => {
                item.addEventListener('click', () => {
                    const path = item.dataset.path;
                    if (path && window.location.pathname !== path) {
                        // 현재 URL에 쿼리 파라미터가 있다면 새 경로로 이동 시에도 유지
                        const currentQueryParams = window.location.search;
                        window.location.href = path + currentQueryParams;
                    }
                    // 현재 경로와 동일한 path를 가진 nav item을 클릭하면 아무것도 하지 않음 (이미 해당 페이지이므로)
                });
            });

            // 상단 탭 버튼에도 동일한 네비게이션 동작 적용
            tabButtons.forEach(button => {
                button.addEventListener('click', () => {
                    const path = button.dataset.path;
                    // 현재 페이지 경로가 /meal이고, 클릭된 탭도 /meal이라면 데이터만 다시 로드
                    if (path === '/meal' && window.location.pathname === '/meal') {
                        tabButtons.forEach(btn => btn.classList.remove('active')); // 모든 탭 버튼 비활성화
                        button.classList.add('active'); // 클릭된 급식 탭만 활성화

                        const todayDate = new Date();
                        const year = todayDate.getFullYear();
                        const month = String(todayDate.getMonth() + 1).padStart(2, '0');
                        const day = String(todayDate.getDate()).padStart(2, '0');
                        const todayYYYYMMDD = `${year}${month}${day}`;
                        renderMealDateButtons(todayYYYYMMDD);
                        fetchMealData(todayYYYYMMDD, currentEffectiveEduCode, currentEffectiveSchoolCode);
                    } else if (path && window.location.pathname !== path) {
                        // 다른 탭을 클릭하면 해당 경로로 이동 (쿼리 파라미터 유지)
                        const currentQueryParams = window.location.search;
                        window.location.href = path + currentQueryParams;
                    }
                });
            });
        }

        /**
         * NEIS API를 통해 학교 이름을 가져와서 페이지 제목과 학교 생활 섹션 제목을 업데이트합니다.
         * @param {string} eduCode - 교육청 코드.
         * @param {string} schoolCode - 학교 코드.
         */
        async function fetchSchoolNameAndSetTitle(eduCode, schoolCode) {
            const apiUrl = `https://open.neis.go.kr/hub/schoolInfo?KEY=${neisApiKey}&Type=json&pIndex=1&pSize=1&ATPT_OFCDC_SC_CODE=${eduCode}&SD_SCHUL_CODE=${schoolCode}`;

            try {
                const response = await fetch(apiUrl);
                const data = await response.json();

                if (data.schoolInfo && data.schoolInfo[1] && data.schoolInfo[1].row && data.schoolInfo[1].row.length > 0) {
                    currentEffectiveSchoolName = data.schoolInfo[1].row[0].SCHUL_NM;
                    pageTitleElement.textContent = `${currentEffectiveSchoolName} 급식 | N-MATE`;
                    schoolLifeTitle.textContent = `${currentEffectiveSchoolName} 급식`; // 학교 생활 섹션 제목도 업데이트
                } else {
                    console.log('학교 이름을 찾을 수 없습니다. 기본 이름을 사용합니다.');
                    pageTitleElement.textContent = `N-MATE | 급식`;
                    schoolLifeTitle.textContent = `학교생활`;
                }
            } catch (error) {
                console.error('학교 이름 가져오기 오류:', error);
                pageTitleElement.textContent = `N-MATE | 급식`;
                schoolLifeTitle.textContent = `학교생활`;
            }
        }

        /**
         * Firestore에서 사용자 프로필을 가져옵니다.
         * @param {string} userId - 현재 사용자의 고유 ID.
         * @returns {Object|null} 사용자 프로필 데이터 또는 찾을 수 없거나 오류가 발생하면 null.
         */
        async function getUserProfile(userId) {
            if (!db) {
                console.error('Firestore 인스턴스가 초기화되지 않았습니다.');
                return null;
            }
            const userProfileRef = db.collection(`artifacts/${appId}/users/${userId}/profile`).doc('user_data');
            try {
                const doc = await userProfileRef.get();
                if (doc.exists) {
                    return doc.data();
                } else {
                    console.log('사용자 프로필 데이터를 찾을 수 없습니다.');
                    return null;
                }
            } catch (error) {
                console.error('사용자 프로필 가져오기 오류:', error);
                return null;
            }
        }

        // --- DOMContentLoaded 시 초기화 ---
        document.addEventListener('DOMContentLoaded', async () => {
            // Firebase 초기화
            if (firebaseConfig && firebaseConfig.apiKey) {
                if (firebase.apps.length === 0) {
                    try {
                        app = firebase.initializeApp(firebaseConfig);
                        auth = firebase.auth();
                        db = firebase.firestore();
                        console.log('Firebase 앱, 인증, Firestore 초기화 성공.');

                        auth.onAuthStateChanged(async (user) => {
                            await updateAccountUI(user);

                            const queryParams = getQueryParams();
                            const urlEduCode = queryParams.eduCode;
                            const urlSchoolCode = queryParams.schoolCode;

                            // URL 파라미터가 있을 경우 우선적으로 사용
                            if (urlEduCode && urlSchoolCode) {
                                currentEffectiveEduCode = urlEduCode;
                                currentEffectiveSchoolCode = urlSchoolCode;
                                console.log('URL 파라미터에서 학교 정보 설정됨:', currentEffectiveEduCode, currentEffectiveSchoolCode);
                            } else if (user) {
                                // URL 파라미터가 없고 사용자가 로그인되어 있다면 Firebase 프로필에서 가져옴
                                const profile = await getUserProfile(user.uid);
                                if (profile) {
                                    currentEffectiveEduCode = profile.atptOfcdcScCode || currentEffectiveEduCode;
                                    currentEffectiveSchoolCode = profile.sdSchulCode || currentEffectiveSchoolCode;

                                    if (!profile.atptOfcdcScCode || !profile.sdSchulCode) {
                                        console.warn('사용자 프로필 정보(학교)가 불완전합니다. 기본값을 사용합니다. 설정 페이지에서 업데이트해주세요.');
                                    }
                                    console.log('Firebase 프로필에서 학교 정보 설정됨:', currentEffectiveEduCode, currentEffectiveSchoolCode);
                                } else {
                                    console.warn('사용자 프로필을 찾을 수 없습니다. 기본 학교 정보를 사용합니다. 설정 페이지에서 프로필을 설정해주세요.');
                                }
                            } else {
                                console.log('인증되지 않았습니다. 기본 학교 정보를 사용합니다. (URL 파라미터 없음)');
                            }
                            
                            // 학교 이름 가져와서 페이지 제목 및 섹션 제목 업데이트
                            await fetchSchoolNameAndSetTitle(currentEffectiveEduCode, currentEffectiveSchoolCode);

                            // 이 페이지는 항상 'mealContent'만 표시합니다.
                            showTab('mealContent');
                        });

                    } catch (error) {
                        console.error('Firebase 초기화 실패:', error);
                        await updateAccountUI(null);
                        // Firebase 초기화 실패 시에도 기본 학교 이름으로 설정
                        await fetchSchoolNameAndSetTitle(currentEffectiveEduCode, currentEffectiveSchoolCode);
                        showTab('mealContent');
                    }
                } else {
                    app = firebase.app();
                    auth = firebase.auth();
                    db = firebase.firestore();
                    console.log('Firebase 앱이 이미 초기화되었습니다. 기존 인스턴스를 사용합니다.');
                    auth.onAuthStateChanged(async (user) => {
                        await updateAccountUI(user);

                        const queryParams = getQueryParams();
                        const urlEduCode = queryParams.eduCode;
                        const urlSchoolCode = queryParams.schoolCode;

                        if (urlEduCode && urlSchoolCode) {
                            currentEffectiveEduCode = urlEduCode;
                            currentEffectiveSchoolCode = urlSchoolCode;
                        } else if (user) {
                            const profile = await getUserProfile(user.uid);
                            if (profile) {
                                currentEffectiveEduCode = profile.atptOfcdcScCode || currentEffectiveEduCode;
                                currentEffectiveSchoolCode = profile.sdSchulCode || currentEffectiveSchoolCode;
                            }
                        }
                        
                        await fetchSchoolNameAndSetTitle(currentEffectiveEduCode, currentEffectiveSchoolCode);
                        showTab('mealContent');
                    });
                }
            } else {
                console.warn('Firebase 구성이 제대로 제공되지 않았습니다. Firebase를 초기화할 수 없습니다.');
                await updateAccountUI(null);
                await fetchSchoolNameAndSetTitle(currentEffectiveEduCode, currentEffectiveSchoolCode);
                showTab('mealContent');
            }

            // 급식 날짜 선택기 이벤트 리스너 연결
            mealDatePicker.addEventListener('change', handleMealDatePickerChange);

            // 외부 클릭 시 드롭다운 닫기 위한 전역 클릭 리스너
            window.addEventListener('click', function(e) {
                const accountTabButton = document.getElementById('accountTabButton');
                if (accountTabButton && !accountTabButton.contains(e.target) && !accountDropdown.contains(e.target)) {
                    accountDropdown.classList.add('hidden');
                }
            });

            // 내비게이션 클릭 핸들러 설정 (상단 탭 포함)
            setupNavigationEvents();
            // 초기 로드 시 내비게이션 활성 상태 업데이트
            updateNavigationActiveState();
        });
    </script>
</body>
</html>
