<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <link rel="icon" type="image/png" href="/image/simbol.png" media="(prefers-color-scheme: light)">
    <link rel="icon" type="image/png" href="/image/dark_simbol.png" media="(prefers-color-scheme: dark)">
    <meta name="naver-site-verification" content="aaafe41f7a0c71624b1fa0fe8913a0520113a2df" />
    <meta name="description" content="부산남중 학생을 위한 정보 플랫폼 Nmate! 급식표, 시간표, 학사일정, 커뮤니티까지 모두 한 곳에서 간편하게 확인하세요.">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>부산남중학교 N-MATE - 홈</title>
    <!-- Pretendard-Regular 웹폰트 프리로드: 폰트 로딩으로 인한 CLS 및 FOUT 방지 -->
    <link rel="preload" href="https://fastly.jsdelivr.net/gh/Project-Noonnu/noonfonts_2107@1.1/Pretendard-Regular.woff" as="font" type="font/woff" crossorigin>
    <style>
        /* Pretendard-Regular 웹폰트 정의 */
        @font-face {
            font-family: 'Pretendard-Regular';
            src: url('https://fastly.jsdelivr.net/gh/Project-Noonnu/noonfonts_2107@1.1/Pretendard-Regular.woff') format('woff');
            font-weight: 400;
            font-style: normal;
            font-display: swap; /* 폰트 로딩 중에도 텍스트가 보이도록 설정 */
        }
        
        /* Body styles for overall layout */
        body {
            font-family: 'Pretendard-Regular', sans-serif;
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            display: flex;
            flex-direction: column;
            min-height: 100vh;
            background-color: #ffffff; /* Light gray background */
        }
        /* Skeleton Loader animation for loading states */
        .skeleton {
            animation: pulse 1.5s infinite ease-in-out;
            background: linear-gradient(-90deg, #f0f0f0 0%, #f8f8f8 50%, #f0f0f0 100%);
            background-size: 200% 100%;
        }
        @keyframes pulse {
            0% {
                background-position: -200% 0;
            }
            100% {
                background-position: 200% 0;
            }
        }
        .skeleton-text {
            height: 1em; /* Adjust as needed */
            width: 80%; /* Adjust as needed */
            margin-bottom: 0.5em;
            border-radius: 4px;
        }

        /* Main content container for centering and max-width */
        .main-content-container {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            align-items: flex-start; /* Aligns content to the left */
            max-width: 36rem; /* Max width for content (reduced from 42rem) */
            margin-left: auto;
            margin-right: auto;
            width: 100%;
            position: relative; /* For absolute positioning of dropdown menu */
            padding-bottom: 70px; /* Space for fixed bottom navigation */
        }

        /* Dropdown menu styles */
        .dropdown-menu {
            position: absolute; /* Relative to the parent with position: relative */
            background-color: white;
            border-radius: 0.5rem; /* rounded-md */
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06); /* shadow-lg */
            padding-top: 0.25rem; /* py-1 */
            padding-bottom: 0.25rem;
            min-width: 8rem; /* w-40 */
            right: 0; /* Aligns to the right of the account tab button */
            top: calc(100% + 0.5rem); /* Positions below the button with 0.5rem gap */
            z-index: 20; /* Ensures it appears above other content */
        }

        .dropdown-menu button {
            width: 100%;
            text-align: left;
            padding: 0.5rem 1rem; /* px-4 py-2 */
            font-size: 0.875rem; /* text-sm */
            color: #374151; /* text-gray-700 */
            transition: background-color 0.2s ease;
        }

        .dropdown-menu button:hover {
            background-color: #f3f4f6; /* hover:bg-gray-100 */
        }

        /* Bottom Navigation Bar Styles */
        .nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 0.5rem; /* p-2 */
            border-radius: 0.75rem; /* rounded-xl */
            transition: all 0.3s ease; /* transition-all duration-300 */
            color: #374151; /* text-gray-700로 변경하여 대비 개선 */
        }
        .nav-item:hover {
            color: #3b82f6; /* hover:text-blue-500 */
            background-color: #f9fafb; /* hover:bg-gray-50 */
        }
        .nav-item.active {
            color: #2563eb; /* text-blue-600 */
        }
        .nav-item.active span {
            font-weight: 700; /* font-bold */
        }
        .nav-item.active svg {
            color: #2563eb; /* text-blue-600 */
        }
    </style>
</head>
<body>

    <!-- Main content area -->
    <div class="main-content-container">

        <!-- Header: Logo and Account/Login section -->
        <div class="w-full flex justify-between items-center px-6 pt-4">
            <!-- Logo -->
            <div class="flex items-center">
                <!-- 이미지 태그에 width와 height 속성 추가하여 CLS 방지 및 성능 개선 -->
                <img src="/image/logo.png" alt="가로형 로고" class="h-12" width="160" height="48">
            </div>

            <!-- Account/Login section with dropdown -->
            <div class="relative">
                <div id="accountStatusArea" class="flex items-center">
                    <!-- Conditional content injected by JavaScript -->
                </div>
                <!-- Dropdown menu (initially hidden) -->
                <div id="accountDropdown" class="dropdown-menu hidden">
                    <button id="settingsButton" class="block">설정</button>
                    <button id="logoutButton" class="block">로그아웃</button>
                </div>
            </div>
        </div>

        <!-- Summer vacation countdown box -->
        <div class="w-full flex flex-col items-start gap-y-4 px-6 mt-8 mb-4">
            <div id="countdownBox" class="w-full h-16 bg-white rounded-xl border border-gray-300 flex items-center justify-center text-gray-800 text-lg font-medium p-4">
                <!-- Countdown will be injected here by JavaScript -->
                <p class="skeleton skeleton-text w-3/4"></p>
            </div>
        </div>

        <!-- Timetable/Meal section container -->
        <div class="w-full flex flex-col items-start gap-y-2 px-6 mt-1 mb-4">
            <!-- Section title -->
            <h2 class="text-left text-xl font-bold text-gray-800">시간표/급식</h2>
            <!-- Horizontal rectangular box split into two parts -->
            <!-- Using flex to always arrange children horizontally -->
            <div class="w-full min-h-40 bg-white rounded-xl border border-gray-300 flex">
                <!-- Left half: Timetable information -->
                <!-- Fixed 1/2 width, right border, and both overflow-y/x for scrolling -->
                <div id="timetable-display-section" class="w-1/2 bg-white rounded-l-xl flex flex-col items-start p-4 border-r border-gray-300 overflow-y-auto overflow-x-auto">
                    <!-- Skeleton Loader for Timetable content -->
                    <div class="flex w-full h-full text-left">
                        <div class="flex-1 flex flex-col items-start">
                            <div class="skeleton skeleton-text w-3/4"></div>
                            <div class="skeleton skeleton-text"></div>
                            <div class="skeleton skeleton-text w-1/2"></div>
                            <div class="skeleton skeleton-text w-2/3"></div>
                        </div>
                        <div class="flex-1 flex flex-col items-start">
                            <div class="skeleton skeleton-text w-3/4"></div>
                            <div class="skeleton skeleton-text"></div>
                            <div class="skeleton skeleton-text w-1/2"></div>
                        </div>
                    </div>
                </div>
                <!-- Right half: Meal information -->
                <!-- Fixed 1/2 width, and both overflow-y/x for scrolling -->
                <div id="meal-display-section" class="w-1/2 bg-white rounded-r-xl flex items-start justify-start text-gray-800 text-xl font-bold p-4 overflow-y-auto overflow-x-auto">
                    <!-- Skeleton Loader for Meal content -->
                    <div class="w-full text-left">
                        <div class="skeleton skeleton-text w-full"></div>
                        <div class="skeleton skeleton-text w-5/6"></div>
                        <div class="skeleton skeleton-text w-3/4"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Trivia section container -->
        <div class="w-full flex flex-col items-start gap-y-2 px-6 mt-1 mb-4">
            <!-- Section title changed to 오늘의 잡학 상식 -->
            <h2 class="text-left text-xl font-bold text-gray-800">오늘의 잡학 상식</h2>
            <!-- Trivia content box -->
            <div id="triviaDisplaySection" class="w-full min-h-20 bg-white rounded-xl border border-gray-300 flex items-center justify-center text-gray-800 text-lg font-medium p-4">
                <!-- Skeleton Loader for Trivia content -->
                <p class="skeleton skeleton-text w-full"></p>
            </div>
        </div>

        <!-- Placeholder for additional content -->
        <p class="text-2xl text-gray-700 px-6 mt-1"></p>
    </div>

    <!-- Bottom Navigation Bar -->
    <nav class="fixed bottom-0 left-0 right-0 bg-white p-3 border-t border-gray-300 max-w-xl mx-auto w-full z-10">
        <div class="flex justify-around items-center h-12">
            <!-- Home Navigation Item -->
            <button id="nav-home" class="nav-item flex flex-col items-center justify-center p-2 rounded-xl transition-all duration-300 text-gray-700 hover:text-blue-500 hover:bg-gray-50" data-tab="홈" data-path="/">
                <svg viewBox="0 0 24 24" fill="currentColor" class="w-6 h-6 mb-1" xmlns="http://www.w3.org/2000/svg">
                    <path d="M10 20V14H14V20H19V12H22L12 3L2 12H5V20H10Z"/>
                </svg>
                <span class="text-xs font-medium">홈</span>
            </button>

            <!-- School Life Navigation Item (consolidated) -->
            <button id="nav-school-life" class="nav-item flex flex-col items-center justify-center p-2 rounded-xl transition-all duration-300 text-gray-700 hover:text-blue-500 hover:bg-gray-50" data-tab="학교생활" data-path="/sclife/timetable">
                <svg viewBox="0 0 24 24" fill="currentColor" class="w-6 h-6 mb-1" xmlns="http://www.w3.org/2000/svg">
                    <path d="M4 19V6.5C4 5.94772 4.44772 5.5 5 5.5H19C19.5523 5.5 20 5.94772 20 6.5V19C20 19.5523 19.5523 20 19 20H5C4.44772 20 4 19.5523 4 19ZM6 17H18V7.5H6V17ZM9 10H15V12H9V10Z"/>
                </svg>
                <span class="text-xs font-medium">학교생활</span>
            </button>

            <!-- Community Navigation Item -->
            <button id="nav-community" class="nav-item flex flex-col items-center justify-center p-2 rounded-xl transition-all duration-300 text-gray-700 hover:text-blue-500 hover:bg-gray-50" data-tab="커뮤니티" data-path="/community">
                <svg viewBox="0 0 24 24" fill="currentColor" class="w-6 h-6 mb-1" xmlns="http://www.w3.org/2000/svg">
                    <path d="M16 11C18.21 11 20 9.21 20 7C20 4.79 18.21 3 16 3C13.79 3 12 4.79 12 7C12 9.21 13.79 11 16 11ZM8 11C10.21 11 12 9.21 12 7C12 4.79 10.21 3 8 3C5.79 3 4 4.79 4 7C4 9.21 5.79 11 8 11ZM16 13C13.67 13 9.34 14.28 9 17V19H23V17C22.66 14.28 18.33 13 16 13ZM8 13C5.33 13 0 14.33 0 17V19H9V17C8.67 14.33 4.33 13 8 13Z"/>
                </svg>
                <span class="text-xs font-medium">커뮤니티</span>
            </button>

            <!-- Calendar Navigation Item -->
            <button id="nav-calendar" class="nav-item flex flex-col items-center justify-center p-2 rounded-xl transition-all duration-300 text-gray-700 hover:text-blue-500 hover:bg-gray-50" data-tab="캘린더" data-path="/calendar">
                <svg viewBox="0 0 24 24" fill="currentColor" class="w-6 h-6 mb-1" xmlns="http://www.w3.org/2000/svg">
                    <path d="M19 4H18V2H16V4H8V2H6V4H5C3.89 4 3 4.9 3 6V20C3 21.1 3.89 22 5 22H19C20.1 22 21 21.1 21 20V6C21 4.9 20.1 4 19 4ZM19 20H5V9H19V20Z"/>
                </svg>
                <span class="text-xs font-medium">캘린더</span>
            </button>

            <!-- More Navigation Item -->
            <button id="nav-more" class="nav-item flex flex-col items-center justify-center p-2 rounded-xl transition-all duration-300 text-gray-700 hover:text-blue-500 hover:bg-blue-50" data-tab="더보기" data-path="/more">
                <svg viewBox="0 0 24 24" fill="currentColor" class="w-6 h-6 mb-1" xmlns="http://www.w3.org/2000/svg">
                    <path d="M12 10C10.9 10 10 10.9 10 12C10 13.1 10.9 14 12 14C13.1 14 14 13.1 14 12C14 10.9 13.1 10 12 10ZM19 10C17.9 10 17 10.9 17 12C17 13.1 17.9 14 19 14C20.1 14 21 13.1 21 12C21 10.9 20.1 10 19 10ZM5 10C3.9 10 3 10.9 3 12C3 13.1 3.9 14 5 14C6.1 14 7 13.1 7 12C7 10.9 6.1 10 5 10Z"/>
                </svg>
                <span class="text-xs font-medium">더보기</span>
            </button>
        </div>
    </nav>

    <!-- Tailwind CSS CDN (defer 속성 추가) -->
    <script src="https://cdn.tailwindcss.com" defer></script>
    <!-- Lucide Icons CDN (defer 속성 추가) -->
    <script src="https://unpkg.com/lucide@latest" defer></script>
    <!-- Firebase SDK CDN (defer 속성 추가) -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js" defer></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js" defer></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js" defer></script>

    <script>
        // Global variables for Firebase configuration (provided by Canvas environment)
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = {
            apiKey: "AIzaSyC_SHRcQ9hXmjVbP3km4rdR4UvKIoqpLHo",
            authDomain: "n-mate.firebaseapp.com",
            projectId: "n-mate",
            storageBucket: "n-mate.firebasestorage.app",
            appId: "1:691313471077:web:3066aaeca0a1d9e448e08c",
            measurementId: "G-0LCGVBKXLQ",
            messagingSenderId: "691313471077"
        };

        // Firebase app, auth, and firestore instances
        let app;
        let auth;
        let db;

        // DOM elements
        const mealDisplaySection = document.getElementById('meal-display-section');
        const timetableDisplaySection = document.getElementById('timetable-display-section');
        const accountStatusArea = document.getElementById('accountStatusArea');
        const accountDropdown = document.getElementById('accountDropdown');
        const countdownBox = document.getElementById('countdownBox'); // Get countdown box element
        const triviaDisplaySection = document.getElementById('triviaDisplaySection'); // Get trivia display section

        // NEIS API common information
        const neisApiKey = "cbb4da48e87445f68c2732368454ebc3"; // Replace with your API key
        const eduCode = "C10"; // Replace with your school's education office code
        const schoolCode = "7171018"; // Replace with your school's standard code

        // Function to get today's date inYYYYMMDD format
        function getTodayDate() {
            const today = new Date();
            const year = today.getFullYear();
            const month = String(today.getMonth() + 1).padStart(2, '0'); // Month is 0-indexed, so add 1
            const day = String(today.getDate()).padStart(2, '0');
            return `${year}${month}${day}`;
        }

        // Function to fetch user profile from Firestore
        async function getUserProfile(userId) {
            if (!db) {
                console.error('Firestore instance is not initialized.');
                return null;
            }
            // Using Firestore security rules path: artifacts/{appId}/users/{userId}/profile/user_data
            const userProfileRef = db.collection(`artifacts/${appId}/users/${userId}/profile`).doc('user_data');
            try {
                const doc = await userProfileRef.get();
                if (doc.exists) {
                    return doc.data();
                } else {
                    console.log('User profile data not found.');
                    return null;
                }
            } catch (error) {
                console.error('Error fetching user profile:', error);
                return null;
            }
        }

        // Function to fetch and display meal data from NEIS API
        async function fetchMealData() {
            // Skeleton loader for meal section (Home page specific)
            mealDisplaySection.innerHTML = `
                <div class="w-full text-left">
                    <div class="skeleton skeleton-text w-full"></div>
                    <div class="skeleton skeleton-text w-5/6"></div>
                    <div class="skeleton skeleton-text w-3/4"></div>
                </div>
            `;

            const date = getTodayDate();
            const apiUrl = `https://open.neis.go.kr/hub/mealServiceDietInfo?KEY=${neisApiKey}&Type=json&pIndex=1&pSize=100&ATPT_OFCDC_SC_CODE=${eduCode}&SD_SCHUL_CODE=${schoolCode}&MLSV_YMD=${date}`;

            try {
                const response = await fetch(apiUrl);
                const data = await response.json();

                if (data.mealServiceDietInfo && data.mealServiceDietInfo[1] && data.mealServiceDietInfo[1].row) {
                    const meals = data.mealServiceDietInfo[1].row;
                    let mealHtml = '<div class="text-left">';
                    meals.forEach(meal => {
                        const menu = meal.DDISH_NM.replace(/\([^)]*\)/g, '').trim();
                        mealHtml += `<p class="text-sm font-medium text-gray-800">${meal.MMEAL_SC_NM}: ${menu}</p>`;
                    });
                    mealHtml += '</div>';
                    mealDisplaySection.innerHTML = mealHtml;
                } else if (data.RESULT && data.RESULT.CODE === 'INFO-200') {
                    mealDisplaySection.innerHTML = '<p class="text-lg text-gray-800">등록된 급식이 없어요.</p>';
                } else {
                    mealDisplaySection.innerHTML = '<p class="text-lg text-red-500">급식 정보를 가져오는 데 실패했습니다.</p>';
                    console.error('API response error (meal):', data);
                }
            } catch (error) {
                console.error('Error fetching meal data:', error);
                mealDisplaySection.innerHTML = '<p class="text-lg text-red-500">급식 정보를 가져오는 중 오류가 발생했습니다.</p>';
            }
        }

        // Function to fetch and display timetable data from NEIS API
        // Modified to take grade and classNum as arguments
        async function fetchTimetableData(grade, classNum) {
            // Skeleton loader for timetable section (Home page specific)
            timetableDisplaySection.innerHTML = `
                <div class="flex w-full h-full text-left">
                    <div class="flex-1 flex flex-col items-start">
                        <div class="skeleton skeleton-text w-3/4"></div>
                        <div class="skeleton skeleton-text"></div>
                        <div class="skeleton skeleton-text w-1/2"></div>
                        <div class="skeleton skeleton-text w-2/3"></div>
                    </div>
                    <div class="flex-1 flex flex-col items-start">
                        <div class="skeleton skeleton-text w-3/4"></div>
                        <div class="skeleton skeleton-text"></div>
                        <div class="skeleton skeleton-text w-1/2"></div>
                    </div>
                </div>
            `;

            const date = getTodayDate();
            const apiUrl = `https://open.neis.go.kr/hub/misTimetable?KEY=${neisApiKey}&Type=json&pIndex=1&pSize=100&ATPT_OFCDC_SC_CODE=${eduCode}&SD_SCHUL_CODE=${schoolCode}&ALL_TI_YMD=${date}&GRADE=${grade}&CLASS_NM=${classNum}`;

            try {
                const response = await fetch(apiUrl);
                const data = await response.json();

                if (data.misTimetable && data.misTimetable[1] && data.misTimetable[1].row) {
                    const timetable = data.misTimetable[1].row;
                    let leftColumnHtml = '';
                    let rightColumnHtml = '';

                    timetable.sort((a, b) => parseInt(a.PERIO) - parseInt(b.PERIO));

                    // Determine if it's a mobile view based on screen width
                    const isMobileView = window.innerWidth < 768; // Tailwind's 'md' breakpoint

                    timetable.forEach(period => {
                        // Transform special activity names
                        let content = period.ITRT_CNTNT.replace('(자)주제선택활동', '주제선택');
                        content = content.replace('(자)진로탐색활동', '진로탐색');
                        content = content.replace('(창)동아리활동', '동아리');
                        content = content.replace('(창)자율·자치활동', '창체');


                        // Conditionally render "교시" based on device type
                        const periodNumberDisplay = isMobileView ? period.PERIO : `${period.PERIO}교시`;

                        // Apply whitespace-nowrap and text-sm to both period number and content
                        // Removed fixed width for period number and added mr-1 for spacing
                        const periodHtml = `<p class="flex text-sm font-medium text-gray-800 items-baseline">
                                            <strong class="text-gray-400 font-semibold whitespace-nowrap text-sm text-left mr-1">${periodNumberDisplay}</strong>
                                            <span class="flex-grow whitespace-nowrap text-sm">${content}</span>
                                        </p>`;
                        if (parseInt(period.PERIO) <= 4) {
                            leftColumnHtml += periodHtml;
                        } else {
                            rightColumnHtml += periodHtml;
                        }
                    });

                    timetableDisplaySection.innerHTML = `
                        <div class="flex w-full h-full text-left">
                            <div class="flex-1 flex flex-col items-start">
                                ${leftColumnHtml || '<p class="text-sm text-gray-500">오전 시간표 없음</p>'}
                            </div>
                            <div class="flex-1 flex flex-col items-start">
                                ${rightColumnHtml || '<p class="text-sm text-gray-500">오후 시간표 없음</p>'}
                            </div>
                        </div>
                    `;
                } else if (data.RESULT && data.RESULT.CODE === 'INFO-200') {
                    timetableDisplaySection.innerHTML = '<p class="text-lg text-gray-800">등록된 시간표가 없어요.</p>';
                } else {
                    timetableDisplaySection.innerHTML = '<p class="text-lg text-red-500">시간표 정보를 가져오는 데 실패했습니다.</p>';
                    console.error('API response error (timetable):', data);
                }
            } catch (error) {
                console.error('Error fetching timetable data:', error);
                timetableDisplaySection.innerHTML = '<p class="text-lg text-red-500">시간표 정보를 가져오는 중 오류가 발생했습니다.</p>';
            }
        }

        // Function to toggle dropdown menu visibility
        function toggleDropdown() {
            accountDropdown.classList.toggle('hidden');
        }

        // Function to handle user logout
        async function handleLogout() {
            if (auth) {
                try {
                    await auth.signOut();
                    console.log('Logout successful.');
                    // Redirect to login page after logout
                    window.location.href = '/login';
                } catch (error) {
                    console.error('Logout error:', error);
                    // Display error message to user
                }
            }
        }

        /**
         * Handles navigation to the settings page.
         */
        function handleSettingsClick() {
            window.location.href = '/settings';
        }

        // Function to update account UI based on user authentication status
        async function updateAccountUI(user) {
            if (user && user.email) { // Check if a user is logged in and has an email
                const emailPrefix = user.email.split('@')[0];
                accountStatusArea.innerHTML = `
                    <button id="accountTabButton" class="flex items-center space-x-2 p-2 rounded-full hover:bg-gray-100 focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <span class="text-gray-700 text-sm font-medium">${emailPrefix}</span>
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-user-circle-2"><path d="M18 20a6 6 0 0 0-12 0"/><circle cx="12" cy="10" r="4"/><circle cx="12" cy="12" r="10"/></svg>
                    </button>
                `;
                document.getElementById('accountTabButton').addEventListener('click', toggleDropdown);

                // Attach event listeners for dropdown buttons
                const settingsButton = document.getElementById('settingsButton');
                if (settingsButton && !settingsButton.dataset.listenerAdded) {
                    settingsButton.addEventListener('click', handleSettingsClick);
                    settingsButton.dataset.listenerAdded = 'true';
                }
                const logoutButton = document.getElementById('logoutButton');
                if (logoutButton && !logoutButton.dataset.listenerAdded) {
                    logoutButton.addEventListener('click', handleLogout);
                    logoutButton.dataset.listenerAdded = 'true';
                }

            } else {
                // User is logged out or does not have an email (e.g., anonymous, but we don't use it now)
                accountStatusArea.innerHTML = `
                    <button id="loginRedirectButton" class="bg-blue-500 hover:bg-blue-600 text-white font-medium py-2 px-4 rounded-full shadow transition duration-300">
                        로그인
                    </button>
                `;
                document.getElementById('loginRedirectButton').addEventListener('click', () => {
                    window.location.href = '/login'; // Redirect to login page
                });
                accountDropdown.classList.add('hidden'); // Hide dropdown if no user or email
            }
            lucide.createIcons(); // Refresh Lucide icons
        }

        /**
         * Updates the active state of the navigation bar buttons based on the current URL path.
         */
        function updateNavigationActiveState() {
            const currentPath = window.location.pathname;
            const navItems = document.querySelectorAll('.nav-item');

            navItems.forEach(item => {
                const itemPath = item.dataset.path;
                const spanElement = item.querySelector('span');
                const svgElement = item.querySelector('svg');

                // Reset all nav items to default (inactive) state
                item.classList.remove('text-blue-600');
                item.classList.add('text-gray-700', 'hover:text-blue-500', 'hover:bg-gray-50'); /* text-gray-700로 변경 */
                if (spanElement) {
                    spanElement.classList.remove('font-bold');
                    spanElement.classList.add('font-medium');
                }
                if (svgElement) {
                    svgElement.classList.remove('text-blue-600');
                    svgElement.classList.add('text-gray-700'); /* SVG도 text-gray-700으로 변경 */
                }

                // Check for exact path match or if it's the school-life button and current path is within /sclife section
                // The nav-school-life itemPath is now /sclife/timetable
                if (currentPath === itemPath || (item.id === 'nav-school-life' && currentPath.startsWith('/sclife'))) {
                    item.classList.add('text-blue-600');
                    item.classList.remove('text-gray-700', 'hover:text-blue-500', 'hover:bg-gray-50'); /* text-gray-700 제거 */
                    if (spanElement) {
                        spanElement.classList.add('font-bold');
                        spanElement.classList.remove('font-medium');
                    }
                    if (svgElement) {
                        svgElement.classList.add('text-blue-600'); // Apply blue color to active SVG
                        svgElement.classList.remove('text-gray-700'); /* text-gray-700 제거 */
                    }
                }
            });
        }

        /**
         * Sets up click event listeners for navigation items.
         */
        function setupNavigationEvents() {
            const navItems = document.querySelectorAll('.nav-item');
            navItems.forEach(item => {
                item.addEventListener('click', () => {
                    const path = item.dataset.path;
                    const currentPathname = window.location.pathname;

                    // If the target path is different from the current path, navigate.
                    if (currentPathname !== path) {
                        // Special handling for School Life button to set initial tab in localStorage
                        if (item.id === 'nav-school-life') {
                            // When the "School Life" nav button is clicked, always go to the timetable tab
                            localStorage.setItem('initialSchoolLifeTab', 'timetableContent');
                        } else {
                            // For other navigation items, clear any stored school life tab state
                            localStorage.removeItem('initialSchoolLifeTab');
                        }
                        window.location.href = path;
                    }
                    // If clicking on the currently active page's nav item, do nothing
                });
            });
        }

        // Function to update the summer vacation countdown
        function updateSummerVacationCountdown() {
            if (!countdownBox) {
                console.error("Countdown box element not found.");
                return;
            }

            const today = new Date();
            today.setHours(0, 0, 0, 0); // Normalize to start of day for accurate comparison

            let currentYear = today.getFullYear();
            let vacationStartDate = new Date(currentYear, 6, 21); // July 21st (0-indexed month: 6 for July)
            vacationStartDate.setHours(0, 0, 0, 0);
            let vacationEndDate = new Date(currentYear, 7, 18); // August 18th (0-indexed month: 7 for August)
            vacationEndDate.setHours(0, 0, 0, 0);

            let countdownMessage = '';
            const oneDayInMs = 1000 * 60 * 60 * 24;

            // If today is past the end of this year's vacation, calculate for next year's vacation
            if (today > vacationEndDate) {
                currentYear++;
                vacationStartDate = new Date(currentYear, 6, 21);
                vacationStartDate.setHours(0, 0, 0, 0);
                vacationEndDate = new Date(currentYear, 7, 18);
                vacationEndDate.setHours(0, 0, 0, 0);
            }

            if (today < vacationStartDate) {
                // Before vacation starts
                const diffTime = vacationStartDate.getTime() - today.getTime();
                const diffDays = Math.ceil(diffTime / oneDayInMs);
                countdownMessage = `여름방학까지 ${diffDays}일 남았어요!`;
            } else if (today >= vacationStartDate && today < vacationEndDate) {
                // During vacation (until the day before end date)
                const diffTime = vacationEndDate.getTime() - today.getTime();
                const diffDays = Math.ceil(diffTime / oneDayInMs); // Days remaining UNTIL the end day
                countdownMessage = `여름방학이 ${diffDays}일 남았어요!`;
            } else if (today.getTime() === vacationEndDate.getTime()) {
                // On the day of vacation end
                countdownMessage = `방학이 끝났어요...`;
            } else {
                // After vacation ends (and the year has already been advanced if needed)
                // This case handles days after the vacationEndDate, pointing towards the next year's vacation.
                const diffTime = vacationStartDate.getTime() - today.getTime();
                const diffDays = Math.ceil(diffTime / oneDayInMs);
                countdownMessage = `이번 겨울방학은 12월 31에 시작해요!`;
            }

            countdownBox.innerHTML = `<p class="text-gray-800 text-lg font-medium">${countdownMessage}</p>`;
        }


        // Function to fetch and display trivia data from facts.json
        async function fetchTriviaData() {
            // Skeleton loader for trivia section
            triviaDisplaySection.innerHTML = `
                <p class="skeleton skeleton-text w-full h-8"></p>
            `;

            try {
                // Fetch facts from facts.json
                const response = await fetch('/data/facts.json'); // Assumes facts.json is in a /data directory
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const allFacts = await response.json();
                
                if (allFacts.length > 0) {
                    const randomIndex = Math.floor(Math.random() * allFacts.length);
                    const randomFact = allFacts[randomIndex];
                    triviaDisplaySection.innerHTML = `<p class="text-gray-800 text-lg font-medium text-left">${randomFact}</p>`;
                } else {
                    triviaDisplaySection.innerHTML = '<p class="text-lg text-gray-800">잡학 상식 정보가 없습니다.</p>';
                }
            } catch (error) {
                console.error('Error fetching trivia data:', error);
                triviaDisplaySection.innerHTML = '<p class="text-lg text-red-500">잡학 상식 정보를 가져오는 중 오류가 발생했습니다.</p>';
            }
        }


        // Function to initialize data fetching for home page
        async function initializeHomePageData() {
            let userGrade = "1";
            let userClassNum = "1";

            if (auth.currentUser) {
                const user = auth.currentUser;
                const profile = await getUserProfile(user.uid);
                if (profile && profile.grade && profile.classNum) {
                    userGrade = profile.grade;
                    userClassNum = profile.classNum;
                    console.log(`Loading data for: ${userGrade}학년 ${userClassNum}반`);
                } else {
                    console.warn('User logged in but profile information incomplete. Loading default 1st grade, 1st class data.');
                }
            } else {
                console.log('Not authenticated. Loading default 1st grade, 1st class data.');
            }

            fetchTimetableData(userGrade, userClassNum);
            fetchMealData();
            fetchTriviaData(); // Fetch trivia data on home page load
        }

        document.addEventListener('DOMContentLoaded', async () => {
            // Firebase initialization
            if (firebaseConfig && firebaseConfig.apiKey && firebase.apps.length === 0) {
                try {
                    app = firebase.initializeApp(firebaseConfig);
                    auth = firebase.auth();
                    db = firebase.firestore();
                    console.log('Firebase app, auth, Firestore initialized successfully.');

                    // onAuthStateChanged will automatically handle session persistence
                    auth.onAuthStateChanged(async (user) => {
                        await updateAccountUI(user);
                        initializeHomePageData(); // Only initialize home page data here
                    });

                } catch (error) {
                    console.error('Firebase initialization failed:', error);
                    await updateAccountUI(null); // Ensure UI shows "Login" if Firebase fails
                    initializeHomePageData();
                }
            } else if (firebase.apps.length > 0) {
                app = firebase.app();
                auth = firebase.auth();
                db = firebase.firestore();
                console.log('Firebase app already initialized. Using existing instance.');

                auth.onAuthStateChanged(async (user) => {
                    await updateAccountUI(user);
                    initializeHomePageData();
                });
            } else {
                console.warn('Firebase configuration not properly provided.');
                await updateAccountUI(null);
                initializeHomePageData();
            }

            // Global click listener to close dropdown when clicking outside
            window.addEventListener('click', function(e) {
                const accountTabButton = document.getElementById('accountTabButton');
                if (accountTabButton && !accountTabButton.contains(e.target) && !accountDropdown.contains(e.target)) {
                    accountDropdown.classList.add('hidden');
                }
            });

            // Setup navigation click handlers
            setupNavigationEvents();
            // Update navigation active state on initial load
            updateNavigationActiveState();

            // Initial call to update countdown
            updateSummerVacationCountdown();
            // Update countdown every second to make it a real-time counter
            setInterval(updateSummerVacationCountdown, 1000); // Changed to 1 second for real-time counting

            // Re-render timetable/meal sections on window resize (for "교시" text adjustment)
            let resizeTimeout;
            window.addEventListener('resize', () => {
                clearTimeout(resizeTimeout);
                resizeTimeout = setTimeout(() => {
                    initializeHomePageData(); // Re-fetch or re-render data based on new window size
                }, 200);
            });

            // Initial icon creation
            lucide.createIcons();
        });
    </script>

            <script>
  if ('serviceWorker' in navigator) {
    navigator.serviceWorker.register('/service-worker.js')
      .then(reg => console.log('Service Worker 등록됨:', reg.scope))
      .catch(err => console.error('Service Worker 등록 실패:', err));
  }
            </script>
</body>
</html>
