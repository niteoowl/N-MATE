<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>hanilians</title>
    <!-- 
        ⚠️ 경고: Tailwind CSS CDN은 개발 환경에서만 사용해야 합니다.
        실제 배포 시에는 빌드 도구를 사용하여 필요한 CSS만 추출하는 과정을 거쳐야 성능이 향상됩니다.
    -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts Material Symbols -->
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@24,400,0,0" />
    
    <!-- Firebase SDKs -->
    <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
      import { getAuth, signInWithCustomToken, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
      import { getFirestore, doc, getDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

      window.firebase = {
        initializeApp,
        getAuth,
        signInWithCustomToken,
        onAuthStateChanged,
        signOut,
        getFirestore,
        doc,
        getDoc
      };
    </script>
    
    <style>
        /* CSS 변수를 사용하여 색상을 정의합니다. */
        :root {
            --bg-primary: #121212;
            --bg-secondary: #1F1F1F;
            --text-primary: #E0E0E0;
            --text-secondary: #A0A0A0;
            --color-blue: #007BFF;
            --border-color: #1F1F1F; /* 배경색과 동일하게 설정하여 선이 보이지 않게 합니다. */
        }

        /* wanted-sans 폰트를 로드합니다. */
        @import url('https://fastly.jsdelivr.dev/gh/wanteddev/wanted-sans@v1.0.1/packages/wanted-sans/fonts/webfonts/variable/split/WantedSansVariable.min.css');
        
        body {
            font-family: 'WantedSansVariable', sans-serif;
            background-color: var(--bg-primary);
            color: var(--text-primary);
            padding-bottom: 5rem;
        }
        
        /* 스크롤바 숨기기 */
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        
        /* 슬라이드 패널 애니메이션 */
        .slide-panel { transform: translateY(100%); transition: transform 0.3s ease-in-out; z-index: 60; }
        .slide-panel.is-visible { transform: translateY(0); }
        
        /* 스크롤 시 헤더 스타일 */
        .header-scrolled {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 50;
            background-color: rgba(18, 18, 18, 0.8);
            backdrop-filter: blur(8px);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }
        .header-scrolled .header-inner { padding: 0.5rem; }
        .header-scrolled .header-inner img { height: 2rem; }
        
        header, .header-inner, .header-inner img, .header-inner button { transition: all 0.3s ease-in-out; }
        
        .nav-inner { width: 100%; }
        @media (min-width: 768px) { .nav-inner { max-width: 768px; margin-left: auto; margin-right: auto; } }
        
        .invert-icon { filter: invert(1); }
        
        /* 새로운 시간표 그리드 셀 스타일 */
        /* 격자선 삭제 및 배경색 통일 */
        .timetable-grid > div {
            border-right: 1px solid var(--border-color);
            border-bottom: 1px solid var(--border-color);
            background-color: var(--bg-secondary);
        }
        .timetable-grid > div:nth-child(6n) { border-right: none; }
        .timetable-grid > div:nth-last-child(-n+6) { border-bottom: none; }
        .timetable-grid .grid-cell-day,
        .timetable-grid .grid-cell-hour {
            min-height: 3rem;
            background-color: var(--bg-secondary); /* 배경색 통일 */
            font-weight: bold;
            color: var(--text-primary);
            font-size: 0.875rem;
            padding: 1rem 0.75rem;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        .timetable-grid .grid-cell-hour {
            min-height: 5rem;
            font-size: 1.125rem; /* text-lg */
            padding: 0.5rem;
        }
        .timetable-grid .grid-cell {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            padding: 0.5rem;
            min-height: 5rem;
            transition: background-color 0.2s;
        }
        .timetable-grid .grid-cell:hover {
            background-color: #333333; /* hover:bg-gray-700 */
        }
    </style>
</head>
<body class="bg-[--bg-primary] text-white">

    <!-- 메인 컨테이너 -->
    <div class="container mx-auto p-4 md:p-8 max-w-screen-md pt-24 md:pt-28">

        <!-- 헤더 섹션 -->
        <header id="main-header" class="fixed top-0 left-0 right-0 z-50 bg-[--bg-primary] transition-all duration-300">
            <div class="header-inner container mx-auto max-w-screen-md p-4 md:p-8 flex items-center justify-between">
                <div class="flex items-center">
                    <img src="https://i.postimg.cc/XvKJktcP/001-2025-08-01-T220040-650.png" alt="hanilians 로고" class="h-8 md:h-10 w-auto transition-all duration-300">
                </div>
                <!-- 인증 상태에 따라 동적으로 변경될 컨테이너 -->
                <div id="auth-container" class="flex items-center space-x-4 relative">
                    <!-- JavaScript가 여기에 로그인 버튼 또는 사용자 프로필을 렌더링합니다. -->
                </div>
            </div>
        </header>

        <!-- 알림/정보 섹션 -->
        <div class="bg-[--bg-secondary] rounded-2xl p-4 flex items-start space-x-4 mb-6">
            <span class="text-2xl mt-1">✨</span>
            <div>
                <p class="font-medium">불편하게 시간표 옮길 필요 없어요</p>
                <p class="text-[--color-blue] font-medium text-sm">시간표 이미지 다운로드하기</p>
            </div>
            <button class="ml-auto p-2 rounded-full text-white hover:bg-gray-700 transition-colors duration-200">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucude-chevron-right"><path d="m9 18 6-6-6-6"/></svg>
            </button>
        </div>

        <!-- 커뮤니티 섹션 -->
        <div class="relative bg-gray-800 rounded-3xl overflow-hidden mb-6">
            <img src="https://i.postimg.cc/wv0jSJrc/001-88.png" alt="커뮤니티 배경" class="w-full h-auto object-cover">
            <div class="absolute inset-0 bg-black bg-opacity-50 p-6 flex flex-col justify-between">
                <button class="ml-auto p-2 rounded-full text-white hover:bg-gray-700 transition-colors duration-200">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-x"><path d="M18 6 6 18"/><path d="m6 6 12 12"/></svg>
                </button>
                <div class="mt-auto">
                    <h2 class="text-white text-2xl font-bold mb-2">N-MATE 3.0으로 완전히 달라졌어요!</h2>
                    <p class="text-white text-sm mb-4">오늘도 N-MATE는 변화합니다</p>
                    <button class="bg-gray-700 bg-opacity-50 hover:bg-opacity-75 text-white font-medium py-2 px-4 rounded-full flex items-center space-x-2 transition-colors duration-200">
                        <span>더 보기</span>
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-arrow-right"><path d="M5 12h14"/><path d="m12 5 7 7-7 7"/></svg>
                    </button>
                </div>
            </div>
        </div>

        <!-- 오늘의 메뉴 & 날씨 탭 섹션 -->
        <div class="mb-4">
            <div class="flex items-end justify-between">
                <div class="flex items-center space-x-4">
                    <button id="menu-tab" class="font-bold text-xl pb-1 border-b-2 border-white transition-colors duration-200">오늘의 급식</button>
                    <button id="weather-tab" class="font-bold text-xl pb-1 text-gray-400 border-b-2 border-transparent hover:text-white transition-colors duration-200">날씨</button>
                </div>
                <button id="date-picker-toggle" class="p-2 rounded-full text-white hover:bg-gray-700 transition-colors duration-200">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-chevron-down"><path d="m6 9 6 6 6-6"/></svg>
                </button>
            </div>
            <div id="date-display" class="text-gray-400 text-sm mt-2"></div>
        </div>

        <!-- 오늘의 메뉴 카드 섹션 (동적 콘텐츠) -->
        <div id="menu-content" class="mb-8">
            <div id="meal-card" class="bg-[--bg-secondary] p-4 rounded-2xl w-full flex items-center justify-center min-h-[10rem]">
                <p class="text-gray-400">급식 정보를 불러오는 중...</p>
            </div>
        </div>
        
        <!-- 날씨 섹션 (동적 콘텐츠) -->
        <div id="weather-content" class="hidden mb-8">
            <div id="weather-card" class="bg-[--bg-secondary] p-6 rounded-2xl flex items-center justify-center min-h-[10rem]">
                <p class="text-gray-400">날씨 정보를 불러오는 중...</p>
            </div>
        </div>
        
        <!-- 이미지에 맞춰 추가된 섹션들 -->
        <div class="space-y-4 mt-6">
            <div class="flex items-center justify-between mb-4">
                <div class="flex items-center">
                    <h1 id="timetable-title" class="text-xl font-bold">시간표</h1>
                    <div class="flex items-center ml-2">
                        <button id="prev-week-button" class="p-2 rounded-full text-white hover:bg-gray-700 transition-colors duration-200">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-chevron-left"><path d="m15 18-6-6 6-6"/></svg>
                        </button>
                        <button id="next-week-button" class="p-2 rounded-full text-white hover:bg-gray-700 transition-colors duration-200">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-chevron-right"><path d="m9 18 6-6-6-6"/></svg>
                        </button>
                    </div>
                </div>
                <span id="current-week-display" class="text-sm text-gray-400"></span>
            </div>

            <!-- 시간표 섹션 -->
            <div id="timetable-content" class="bg-[--bg-secondary] rounded-3xl overflow-hidden shadow-lg mb-4">
                <!-- 동적으로 생성될 주간 시간표 컨테이너 -->
                <div class="text-center text-gray-400 flex flex-col items-center justify-center min-h-[35rem]">
                    <p>시간표를 불러오는 중...</p>
                </div>
            </div>
            
            <!-- 2025 수능 디데이 섹션 -->
            <div class="mt-8">
                <h3 class="text-xl font-bold mb-4">2025 수능 디데이</h3>
                <div class="grid grid-cols-4 text-center">
                    <div><p class="font-medium">3모</p><p class="text-sm text-gray-400">종료됨</p></div>
                    <div><p class="font-medium">6모</p><p class="text-sm text-gray-400">종료됨</p></div>
                    <div class="flex flex-col items-center"><p class="font-bold text-[--color-blue]">9모</p><p class="font-bold text-[--color-blue]">D-33</p><div class="mt-1 w-1 h-1 bg-[--color-blue] rounded-full"></div></div>
                    <div><p class="font-bold">수능</p><p class="font-bold">D-104</p></div>
                </div>
            </div>
            
            <hr class="my-6 border-gray-700">

            <!-- 학사일정 섹션 -->
            <div>
                <h3 class="text-xl font-bold mb-4">학사일정</h3>
                <div class="space-y-4">
                    <div class="flex items-center justify-between">
                        <div class="flex items-center"><span class="text-xs text-gray-400 rounded-full px-2 py-1 mr-2 bg-gray-700">일반</span><span class="font-medium">개학식</span></div>
                        <span class="text-sm text-gray-400">08.07 (목)</span>
                    </div>
                    <div class="flex items-center justify-between">
                        <div class="flex items-center"><span class="text-xs text-[--color-blue] rounded-full px-2 py-1 mr-2 bg-blue-900 bg-opacity-30">모의고사</span><span class="font-medium">전국연합(1,2년) 대수능모의평가(3년)</span></div>
                        <span class="text-sm text-gray-400">09.03 (수)</span>
                    </div>
                </div>
                <div class="flex justify-center mt-4">
                    <button class="flex items-center space-x-2 text-sm text-gray-400 p-2 rounded-lg hover:bg-gray-700 hover:text-white transition-colors duration-200">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-calendar"><path d="M8 2v4"/><path d="M16 2v4"/><rect width="18" height="18" x="3" y="4" rx="2"/><path d="M3 10h18"/></svg>
                        <span>전체 일정 보기</span>
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-chevron-right"><path d="m9 18 6-6-6-6"/></svg>
                    </button>
                </div>
            </div>
            
            <hr class="my-6 border-gray-700">
        </div>
    </div>

    <!-- 날짜 선택 패널 -->
    <div id="date-picker-panel" class="fixed bottom-0 left-0 right-0 bg-[--bg-secondary] rounded-t-3xl shadow-lg transition-transform duration-300 slide-panel">
        <div class="flex justify-between items-center p-4 border-b border-gray-700">
            <h3 class="text-lg font-bold">날짜 선택</h3>
            <button id="close-panel" class="p-2 rounded-full text-white hover:bg-gray-700 transition-colors duration-200">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-x"><path d="M18 6 6 18"/><path d="m6 6 12 12"/></svg>
            </button>
        </div>
        <!-- 달력 UI가 들어갈 곳 -->
        <div id="calendar-container" class="p-4 h-64 overflow-y-auto no-scrollbar">
            <!-- JavaScript로 달력이 여기에 동적으로 생성됩니다. -->
        </div>
    </div>

    <!-- 하단 내비게이션 바 -->
    <nav class="fixed bottom-0 left-0 right-0 bg-[--bg-primary] border-t border-gray-700 z-50">
        <div class="nav-inner py-1 px-4 flex justify-around items-center">
            <a href="#" class="flex flex-col items-center p-1.5 rounded-xl text-[--color-blue] hover:bg-gray-700 hover:text-[--color-blue] transition-colors duration-200">
                <img src="https://www.hanilians.xyz/header/home-filled.svg" alt="홈 아이콘" class="w-7 h-7 invert-icon">
                <span class="text-xs mt-0.5">홈</span>
            </a>
            <a href="#" class="flex flex-col items-center p-1.5 rounded-xl text-white hover:bg-gray-700 transition-colors duration-200">
                <span class="material-symbols-outlined text-2xl">group</span><span class="text-xs mt-0.5">커뮤니티</span>
            </a>
            <a href="#" class="flex flex-col items-center p-1.5 rounded-xl text-white hover:bg-gray-700 transition-colors duration-200">
                <span class="material-symbols-outlined text-2xl">calendar_month</span><span class="text-xs mt-0.5">시간표</span>
            </a>
            <a href="#" class="flex flex-col items-center p-1.5 rounded-xl text-white hover:bg-gray-700 transition-colors duration-200">
                <span class="material-symbols-outlined text-2xl">bookmark</span><span class="text-xs mt-0.5">메모</span>
            </a>
        </div>
    </nav>
    
    <script type="module">
        document.addEventListener('DOMContentLoaded', async () => {
            const datePickerToggle = document.getElementById('date-picker-toggle');
            const datePickerPanel = document.getElementById('date-picker-panel');
            const closePanelButton = document.getElementById('close-panel');
            const mainHeader = document.getElementById('main-header');
            const menuTab = document.getElementById('menu-tab');
            const weatherTab = document.getElementById('weather-tab');
            const menuContent = document.getElementById('menu-content');
            const weatherContent = document.getElementById('weather-content');
            const mealCard = document.getElementById('meal-card');
            const weatherCard = document.getElementById('weather-card');
            const dateDisplay = document.getElementById('date-display');
            const calendarContainer = document.getElementById('calendar-container');
            const timetableContent = document.getElementById('timetable-content');
            const prevWeekButton = document.getElementById('prev-week-button');
            const nextWeekButton = document.getElementById('next-week-button');
            const currentWeekDisplay = document.getElementById('current-week-display');
            const timetableTitle = document.getElementById('timetable-title');
            const authContainer = document.getElementById('auth-container');

            let currentDate = new Date();
            let currentWeekMonday = getMonday(currentDate);
            let userProfile = null;
            let db, auth;

            // Firebase 설정 (사용자 제공)
            const firebaseConfig = {
                apiKey: "AIzaSyC_SHRcQ9hXmjVbP3km4rdR4UvKIoqpLHo",
                authDomain: "n-mate.firebaseapp.com",
                projectId: "n-mate",
                storageBucket: "n-mate.firebasestorage.app",
                messagingSenderId: "691313471077",
                appId: "1:691313471077:web:3066aaeca0a1d9e448e08c",
                measurementId: "G-0LCGVBKXLQ"
            };

            const app = firebase.initializeApp(firebaseConfig);
            auth = firebase.getAuth(app);
            db = firebase.getFirestore(app);
            const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

            // 드롭다운 메뉴 토글 함수
            function toggleDropdown() {
                const dropdown = document.getElementById('logout-dropdown');
                if (dropdown) {
                    dropdown.classList.toggle('hidden');
                }
            }

            // 인증 UI 렌더링 함수
            async function renderAuthUI(user) {
                authContainer.innerHTML = ''; // 기존 내용 초기화
                // 사용자 프로필이 없거나 로그인하지 않은 경우 기본값
                const defaultProfile = {
                    schoolName: "남서울중학교",
                    schoolCode: "7132131",
                    atptOfcdcScCode: "B10",
                    grade: "1",
                    classNumber: "1"
                };

                if (user) {
                    try {
                        const userId = user.uid;
                        const userProfileRef = firebase.doc(db, `artifacts/${appId}/users/${userId}/profile/userProfile`);
                        const docSnap = await firebase.getDoc(userProfileRef);
                        
                        if (docSnap.exists()) {
                            userProfile = docSnap.data();
                            // 사용자 이름과 드롭다운 UI 렌더링
                            authContainer.innerHTML = `
                                <div class="relative">
                                    <button id="user-profile-button" class="bg-gray-700 bg-opacity-50 hover:bg-gray-700 text-white font-medium py-1.5 px-4 rounded-full flex items-center transition-colors duration-200">
                                        <span>${userProfile.name}</span>
                                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-chevron-down ml-1"><path d="m6 9 6 6 6-6"/></svg>
                                    </button>
                                    <div id="logout-dropdown" class="hidden absolute right-0 mt-2 py-2 w-48 bg-[--bg-secondary] rounded-md shadow-xl z-50">
                                        <button id="logout-button" class="block w-full text-left px-4 py-2 text-sm text-gray-300 hover:bg-gray-700">로그아웃</button>
                                    </div>
                                </div>
                            `;
                            // 로그아웃 버튼 이벤트 리스너 추가
                            document.getElementById('user-profile-button').addEventListener('click', toggleDropdown);
                            document.getElementById('logout-button').addEventListener('click', () => {
                                firebase.signOut(auth)
                                    .then(() => console.log("User signed out"))
                                    .catch(error => console.error("Sign out error", error));
                            });

                            // 사용자 정보로 데이터 로드
                            loadDataWithUserProfile(userProfile);
                        } else {
                            // 프로필 문서가 없는 경우, 프로필 설정 버튼 표시
                            authContainer.innerHTML = `<a href="/profile-setup"><button class="login-button bg-gray-700 bg-opacity-50 font-medium py-1.5 px-4 rounded-full text-sm border border-gray-700 hover:bg-gray-700 transition-colors duration-200">프로필 설정</button></a>`;
                            loadDataWithUserProfile(defaultProfile); // 기본값으로 데이터 로드
                        }
                    } catch (e) {
                        console.error("Error fetching user profile:", e);
                        // 에러 발생 시 로그인 버튼 렌더링
                        authContainer.innerHTML = `<a href="/login"><button class="login-button bg-transparent font-medium py-1.5 px-4 rounded-full text-sm border border-gray-700 hover:bg-gray-700 transition-colors duration-200">로그인</button></a>`;
                        loadDataWithUserProfile(defaultProfile);
                    }
                } else {
                    // 로그인되지 않은 경우
                    authContainer.innerHTML = `<a href="/login"><button class="login-button bg-transparent font-medium py-1.5 px-4 rounded-full text-sm border border-gray-700 hover:bg-gray-700 transition-colors duration-200">로그인</button></a>`;
                    loadDataWithUserProfile(defaultProfile);
                }
            }
            
            // Firebase 인증 상태 변화 감지
            firebase.onAuthStateChanged(auth, async (user) => {
                await renderAuthUI(user);
            });

            // 프로필 정보에 따라 데이터 로드
            function loadDataWithUserProfile(profile) {
                // 사용자가 로그인되어 있다면 프로필 정보를, 아니라면 기본값을 사용
                const atptOfcdcScCode = profile ? profile.atptOfcdcScCode : 'B10';
                const sdSchulCode = profile ? profile.sdSchulCode : '7132131';
                const grade = profile ? profile.grade : '1';
                const classNm = profile ? profile.classNumber : '1';

                // 제목 업데이트
                if (profile && profile.grade && profile.classNumber && profile.schoolName) {
                    timetableTitle.textContent = `${profile.schoolName} ${profile.grade}학년 ${profile.classNumber}반 시간표`;
                } else {
                    timetableTitle.textContent = `시간표`;
                }

                // 급식 및 시간표 데이터 로드
                const today = new Date();
                const year = today.getFullYear();
                const month = String(today.getMonth() + 1).padStart(2, '0');
                const day = String(today.getDate()).padStart(2, '0');
                const dateStr = `${year}${month}${day}`;
                
                const selectedDate = new Date(year, parseInt(month, 10) - 1, parseInt(day, 10));
                const daysOfWeek = ['일', '월', '화', '수', '목', '금', '토'];
                const dayName = daysOfWeek[selectedDate.getDay()];
                dateDisplay.textContent = `${year}년 ${parseInt(month, 10)}월 ${parseInt(day, 10)}일 (${dayName})`;
                
                fetchMealData(dateStr, atptOfcdcScCode, sdSchulCode);
                fetchAndRenderWeeklyTimetable(currentWeekMonday, atptOfcdcScCode, sdSchulCode, grade, classNm);
            }

            // 해당 날짜가 속한 주의 월요일을 구하는 함수
            function getMonday(d) {
                d = new Date(d);
                const day = d.getDay();
                const diff = d.getDate() - day + (day === 0 ? -6 : 1); // 월요일(1)부터 시작
                return new Date(d.setDate(diff));
            }

            // NEIS API에서 급식 데이터를 가져오는 함수
            async function fetchMealData(mlsYmd, atptOfcdcScCode, sdSchulCode) {
                const year = parseInt(mlsYmd.substring(0, 4), 10);
                const month = parseInt(mlsYmd.substring(4, 6), 10) - 1;
                const day = parseInt(mlsYmd.substring(6, 8), 10);
                const selectedDate = new Date(year, month, day);
                const dayOfWeek = selectedDate.getDay();

                mealCard.innerHTML = `<p class="text-gray-400">급식 정보를 불러오는 중...</p>`;

                if (dayOfWeek === 0 || dayOfWeek === 6) {
                    mealCard.innerHTML = `
                        <div class="text-center p-4">
                            <p class="font-medium text-lg">주말에는 급식 정보가 제공되지 않아요</p>
                            <p class="text-sm text-gray-400 mt-1">즐거운 주말 보내세요!</p>
                        </div>
                    `;
                    return;
                }
                
                const apiKey = ''; // Canvas 환경에서는 비워둡니다
                
                const apiUrl = `https://open.neis.go.kr/hub/mealServiceDietInfo?KEY=${apiKey}&Type=json&pIndex=1&pSize=100&ATPT_OFCDC_SC_CODE=${atptOfcdcScCode}&SD_SCHUL_CODE=${sdSchulCode}&MLSV_YMD=${mlsYmd}`;
                
                try {
                    const response = await fetch(apiUrl);
                    const data = await response.json();
                    
                    if (data.RESULT && data.RESULT.CODE === 'INFO-200') {
                        mealCard.innerHTML = `
                            <div class="text-center p-4">
                                <p class="font-medium text-lg">선택한 날짜에 급식 정보가 없습니다.</p>
                                <p class="text-sm text-gray-400 mt-1">다른 날짜를 선택해주세요.</p>
                            </div>
                        `;
                        return;
                    }
                    
                    if (data.mealServiceDietInfo && data.mealServiceDietInfo.length > 1 && data.mealServiceDietInfo[1].row) {
                        const mealInfo = data.mealServiceDietInfo[1].row;
                        const lunchMeal = mealInfo.find(meal => meal.MMEAL_SC_NM === '중식');

                        if (lunchMeal) {
                            const rawDishName = lunchMeal.DDISH_NM;
                            // 알레르기 정보 등 괄호 안의 숫자 제거
                            const cleanedDishName = rawDishName
                                .split('<br/>')
                                .filter(item => item.trim() !== '')
                                .map(item => item.replace(/\s*\(\d+\.?\d*\.?\d*\.?\d*\.?\d*\.?\d*\.?\d*\.?\d*\.?\d*\)?/g, '').trim())
                                .join('</li><li>');

                            const mealHtml = `
                                <div class="p-4 rounded-2xl w-full">
                                    <h3 class="font-bold text-lg mb-2">${lunchMeal.MMEAL_SC_NM}</h3>
                                    <p class="text-sm text-gray-400 mb-2">${lunchMeal.CAL_INFO || ''}</p>
                                    <ul class="text-sm space-y-1 text-white list-disc list-inside">
                                        <li>${cleanedDishName}</li>
                                    </ul>
                                </div>
                            `;
                            mealCard.innerHTML = mealHtml;
                        } else {
                            mealCard.innerHTML = `
                                <div class="text-center p-4">
                                    <p class="font-medium text-lg">선택한 날짜에 중식 정보가 없습니다.</p>
                                    <p class="text-sm text-gray-400 mt-1">다른 식사 정보를 확인해보세요.</p>
                                </div>
                            `;
                        }
                    } else {
                        mealCard.innerHTML = `
                            <div class="text-center p-4">
                                <p class="font-medium text-lg">급식 정보를 가져올 수 없습니다.</p>
                                <p class="text-sm text-gray-400 mt-1">API 응답 구조를 확인하세요.</p>
                            </div>
                        `;
                    }
                } catch (error) {
                    console.error('Failed to fetch meal data:', error);
                    mealCard.innerHTML = `<p class="text-red-500">네트워크 오류가 발생했습니다. 잠시 후 다시 시도해주세요.</p>`;
                }
            }

            // NEIS API에서 주간 시간표 데이터를 가져와서 렌더링하는 함수
            async function fetchAndRenderWeeklyTimetable(mondayDate, atptOfcdcScCode, sdSchulCode, grade, classNm) {
                // 데이터를 불러오는 중 상태 표시
                timetableContent.innerHTML = `
                    <div class="text-center text-gray-400 flex flex-col items-center justify-center min-h-[35rem] p-4">
                        <p>시간표를 불러오는 중...</p>
                    </div>
                `;

                // 이번 주 월요일과 금요일 날짜 계산
                const tiFromYmd = formatDate(mondayDate);
                const fridayDate = new Date(mondayDate);
                fridayDate.setDate(mondayDate.getDate() + 4);
                const tiToYmd = formatDate(fridayDate);

                const fromYear = mondayDate.getFullYear();
                const fromMonth = mondayDate.getMonth() + 1;
                const fromDay = mondayDate.getDate();
                const toYear = fridayDate.getFullYear();
                const toMonth = fridayDate.getMonth() + 1;
                const toDay = fridayDate.getDate();
                currentWeekDisplay.textContent = `${fromYear}.${fromMonth}.${fromDay} ~ ${toYear}.${toMonth}.${toDay}`;

                const apiKey = ''; // Canvas 환경에서는 비워둡니다
                
                const apiUrl = `https://open.neis.go.kr/hub/misTimetable?KEY=${apiKey}&Type=json&pIndex=1&pSize=100&ATPT_OFCDC_SC_CODE=${atptOfcdcScCode}&SD_SCHUL_CODE=${sdSchulCode}&GRADE=${grade}&CLASS_NM=${classNm}&TI_FROM_YMD=${tiFromYmd}&TI_TO_YMD=${tiToYmd}`;
                
                try {
                    const response = await fetch(apiUrl);
                    const data = await response.json();
                    
                    if (data.RESULT && data.RESULT.CODE === 'INFO-200') {
                        const today = new Date();
                        const dayOfWeek = today.getDay(); // 0 = Sunday, 6 = Saturday
                        let messageHtml = '';

                        if (dayOfWeek === 0 || dayOfWeek === 6) {
                             messageHtml = `
                                <div class="text-center text-gray-400 flex flex-col items-center justify-center min-h-[35rem] p-4">
                                    <p class="font-medium text-lg text-white">주말에는 시간표 정보가 제공되지 않아요</p>
                                    <p class="text-sm text-gray-400 mt-1">즐거운 주말 보내세요!</p>
                                </div>
                            `;
                        } else {
                            messageHtml = `
                                <div class="text-center text-gray-400 flex flex-col items-center justify-center min-h-[35rem] p-4">
                                    <p class="font-medium text-lg text-white">해당 주간의 시간표 정보가 없습니다.</p>
                                    <p class="text-sm text-gray-400 mt-1">다른 주간을 확인하거나, 정보가 등록되었는지 확인해주세요.</p>
                                </div>
                            `;
                        }
                        timetableContent.innerHTML = messageHtml;
                        return;
                    }
                    
                    if (data.misTimetable && data.misTimetable.length > 1 && data.misTimetable[1].row) {
                        const timetableData = data.misTimetable[1].row;
                        renderWeeklyTimetable(timetableData);
                    } else {
                        timetableContent.innerHTML = `<p class="text-red-500">시간표 정보를 가져올 수 없습니다. API 응답 구조를 확인하세요.</p>`;
                    }

                } catch (error) {
                    console.error('Failed to fetch weekly timetable data:', error);
                    timetableContent.innerHTML = `<p class="text-red-500">네트워크 오류가 발생했습니다. 잠시 후 다시 시도해주세요.</p>`;
                }
            }
            
            // 주간 시간표 데이터를 받아와서 동적으로 HTML 테이블을 그리는 함수 (그리드 버전)
            function renderWeeklyTimetable(data) {
                // NEIS API 데이터의 ITRT_CNTNT와 PRFN_GRNM을 사용하여 HTML 그리드를 생성합니다.
                data.sort((a, b) => parseInt(a.PERIO) - parseInt(b.PERIO));

                const days = ['월', '화', '수', '목', '금'];
                const timetableByDay = {};
                days.forEach(day => timetableByDay[day] = []);

                data.forEach(item => {
                    const date = item.ALL_TI_YMD;
                    const dayOfWeek = new Date(date.slice(0, 4), date.slice(4, 6) - 1, date.slice(6, 8)).getDay();
                    if (dayOfWeek >= 1 && dayOfWeek <= 5) {
                        const dayName = days[dayOfWeek - 1];
                        timetableByDay[dayName].push(item);
                    }
                });

                let gridHtml = `
                    <div class="grid grid-cols-6 text-center text-sm font-medium timetable-grid">
                        <div class="grid-cell-day rounded-tl-3xl">교시</div>
                        <div class="grid-cell-day">월</div>
                        <div class="grid-cell-day">화</div>
                        <div class="grid-cell-day">수</div>
                        <div class="grid-cell-day">목</div>
                        <div class="grid-cell-day rounded-tr-3xl">금</div>
                `;
                
                const maxPeriods = Math.max(...Object.values(timetableByDay).map(dayData => dayData.length));
                
                for (let period = 1; period <= maxPeriods; period++) {
                    gridHtml += `<div class="grid-cell-hour">${period}</div>`;
                    days.forEach((day, index) => {
                        const subject = timetableByDay[day].find(item => parseInt(item.PERIO) === period);
                        const isLastRow = period === maxPeriods;
                        const isLastCol = index === days.length - 1;
                        let cellClasses = 'grid-cell';

                        if (isLastRow) {
                            cellClasses += (index === 0) ? ' rounded-bl-3xl' : '';
                            cellClasses += (isLastCol) ? ' rounded-br-3xl' : '';
                        }

                        gridHtml += `<div class="${cellClasses}">`;
                        if (subject) {
                            gridHtml += `
                                <span class="font-medium text-sm">${subject.ITRT_CNTNT}</span>
                                ${subject.PRFN_GRNM ? `<span class="text-xs text-gray-400 mt-1">${subject.PRFN_GRNM}</span>` : ''}
                            `;
                        } else {
                            gridHtml += `<span class="font-medium text-sm">-</span><span class="text-xs text-gray-400 mt-1">-</span>`;
                        }
                        gridHtml += `</div>`;
                    });
                }
                gridHtml += `</div>`;
                
                timetableContent.innerHTML = gridHtml;
            }

            // 날씨 데이터를 가져오는 함수 (실제 API 호출을 시뮬레이션)
            async function fetchWeatherData() {
                weatherCard.innerHTML = `<p class="text-gray-400">날씨 정보를 불러오는 중...</p>`;

                try {
                    const dummyWeatherData = {
                        description: '맑음, 구름 조금',
                        temp: 25,
                        temp_max: 28,
                        temp_min: 20
                    };

                    await new Promise(resolve => setTimeout(resolve, 1000));

                    const description = dummyWeatherData.description;
                    const temp = dummyWeatherData.temp;
                    const tempMax = dummyWeatherData.temp_max;
                    const tempMin = dummyWeatherData.temp_min;

                    const weatherHtml = `
                        <div class="bg-[--bg-secondary] p-6 rounded-2xl flex items-center space-x-4 w-full">
                            <svg xmlns="http://www.w3.org/2000/svg" width="60" height="60" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-cloud-sun text-[--text-primary]">
                                <path d="M12 2v2"/><path d="m4.93 4.93 1.41 1.41"/><path d="M2 12h2"/><path d="M4.93 19.07l1.41-1.41"/><path d="M12 12a4 4 0 1 0 0-8 4 4 0 0 0 0 8Z"/><path d="M20 16a5 5 0 0 0-8.5-4H11a6 6 0 0 0-6 6v1a3 3 0 0 0 3 3h13a4 4 0 0 0 0-8Z"/>
                            </svg>
                            <div>
                                <p class="text-3xl font-bold">${temp}°C</p>
                                <p class="text-gray-400">${description}</p>
                                <p class="text-sm text-gray-500">최고 ${tempMax}°C / 최저 ${tempMin}°C</p>
                            </div>
                        </div>
                    `;
                    weatherCard.innerHTML = weatherHtml;
                } catch (error) {
                    console.error('Failed to fetch weather data:', error);
                    weatherCard.innerHTML = `<p class="text-red-500">날씨 정보를 가져오는 데 실패했습니다.</p>`;
                }
            }

            // 달력을 렌더링하는 함수
            function renderCalendar(date) {
                const year = date.getFullYear();
                const month = date.getMonth();
                const today = new Date();
                const todayYear = today.getFullYear();
                const todayMonth = today.getMonth();
                const todayDay = today.getDate();

                const firstDayOfMonth = new Date(year, month, 1);
                const lastDayOfMonth = new Date(year, month + 1, 0);
                const daysInMonth = lastDayOfMonth.getDate();
                const firstDayOfWeek = firstDayOfMonth.getDay();

                currentDate = date;

                let calendarHtml = `
                    <div class="flex justify-between items-center mb-4">
                        <button id="prev-month-button" class="p-2 rounded-full hover:bg-gray-700">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-chevron-left"><path d="m15 18-6-6 6-6"/></svg>
                        </button>
                        <span id="current-month-year" class="font-bold text-lg">${year}년 ${month + 1}월</span>
                        <button id="next-month-button" class="p-2 rounded-full hover:bg-gray-700">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-chevron-right"><path d="m9 18 6-6-6-6"/></svg>
                        </button>
                    </div>
                    <div class="grid grid-cols-7 text-center text-sm font-medium text-gray-400 mb-2">
                        <div>일</div><div>월</div><div>화</div><div>수</div><div>목</div><div>금</div><div>토</div>
                    </div>
                    <div id="calendar-days-grid" class="grid grid-cols-7 text-center">
                `;

                for (let i = 0; i < firstDayOfWeek; i++) {
                    calendarHtml += `<div class="p-2"></div>`;
                }

                for (let day = 1; day <= daysInMonth; day++) {
                    const isToday = todayYear === year && todayMonth === month && todayDay === day;
                    const dateStr = `${year}${String(month + 1).padStart(2, '0')}${String(day).padStart(2, '0')}`;
                    
                    calendarHtml += `
                        <button class="p-2 rounded-full font-medium ${isToday ? 'bg-[--color-blue] text-white' : 'hover:bg-gray-700'}" data-date="${dateStr}">
                            ${day}
                        </button>
                    `;
                }
                
                calendarHtml += `</div>`;
                calendarContainer.innerHTML = calendarHtml;
                
                document.getElementById('prev-month-button').addEventListener('click', () => {
                    const prevMonth = new Date(currentDate.getFullYear(), currentDate.getMonth() - 1, 1);
                    renderCalendar(prevMonth);
                });
                document.getElementById('next-month-button').addEventListener('click', () => {
                    const nextMonth = new Date(currentDate.getFullYear(), currentDate.getMonth() + 1, 1);
                    renderCalendar(nextMonth);
                });
                
                document.querySelectorAll('#calendar-days-grid button').forEach(button => {
                    button.addEventListener('click', (event) => {
                        const selectedDate = event.target.dataset.date;
                        handleDateClick(selectedDate);
                    });
                });
            }
            
            // 날짜 선택 시 호출되는 핸들러
            function handleDateClick(dateStr) {
                const year = dateStr.substring(0, 4);
                const month = dateStr.substring(4, 6);
                const day = dateStr.substring(6, 8);
                
                const selectedDate = new Date(year, parseInt(month, 10) - 1, parseInt(day, 10));
                const daysOfWeek = ['일', '월', '화', '수', '목', '금', '토'];
                const dayName = daysOfWeek[selectedDate.getDay()];

                dateDisplay.textContent = `${year}년 ${parseInt(month, 10)}월 ${parseInt(day, 10)}일 (${dayName})`;
                fetchMealData(dateStr, userProfile ? userProfile.atptOfcdcScCode : 'B10', userProfile ? userProfile.sdSchulCode : '7132131');
                datePickerPanel.classList.remove('is-visible');
            }

            const togglePanel = () => {
                datePickerPanel.classList.toggle('is-visible');
            };

            window.addEventListener('scroll', () => {
                if (window.scrollY > 50) {
                    mainHeader.classList.add('header-scrolled');
                } else {
                    mainHeader.classList.remove('header-scrolled');
                }
            });

            const switchTab = (activeTab) => {
                const isMenu = activeTab === 'menu';
                menuTab.classList.toggle('border-white', isMenu);
                menuTab.classList.toggle('text-gray-400', !isMenu);
                menuTab.classList.toggle('border-transparent', !isMenu);
                
                weatherTab.classList.toggle('border-white', !isMenu);
                weatherTab.classList.toggle('text-gray-400', isMenu);
                weatherTab.classList.toggle('border-transparent', isMenu);

                menuContent.classList.toggle('hidden', !isMenu);
                weatherContent.classList.toggle('hidden', isMenu);
                
                if (isMenu) {
                    // 급식 탭 선택 시 사용자 프로필 기반으로 데이터 로드
                    const today = new Date();
                    const year = today.getFullYear();
                    const month = String(today.getMonth() + 1).padStart(2, '0');
                    const day = String(today.getDate()).padStart(2, '0');
                    const dateStr = `${year}${month}${day}`;
                    
                    const selectedDate = new Date(year, parseInt(month, 10) - 1, parseInt(day, 10));
                    const daysOfWeek = ['일', '월', '화', '수', '목', '금', '토'];
                    const dayName = daysOfWeek[selectedDate.getDay()];
                    dateDisplay.textContent = `${year}년 ${parseInt(month, 10)}월 ${parseInt(day, 10)}일 (${dayName})`;
                    
                    fetchMealData(dateStr, userProfile ? userProfile.atptOfcdcScCode : 'B10', userProfile ? userProfile.sdSchulCode : '7132131');
                } else {
                    fetchWeatherData();
                }
            };

            // 날짜를 YYYYMMDD 형식의 문자열로 변환하는 헬퍼 함수
            function formatDate(date) {
                const year = date.getFullYear();
                const month = String(date.getMonth() + 1).padStart(2, '0');
                const day = String(date.getDate()).padStart(2, '0');
                return `${year}${month}${day}`;
            }

            // 주간 네비게이션 버튼 이벤트 리스너
            prevWeekButton.addEventListener('click', () => {
                currentWeekMonday.setDate(currentWeekMonday.getDate() - 7);
                if (userProfile) {
                    fetchAndRenderWeeklyTimetable(currentWeekMonday, userProfile.atptOfcdcScCode, userProfile.sdSchulCode, userProfile.grade, userProfile.classNumber);
                } else {
                    fetchAndRenderWeeklyTimetable(currentWeekMonday, 'B10', '7132131', '1', '1');
                }
            });
            nextWeekButton.addEventListener('click', () => {
                currentWeekMonday.setDate(currentWeekMonday.getDate() + 7);
                if (userProfile) {
                    fetchAndRenderWeeklyTimetable(currentWeekMonday, userProfile.atptOfcdcScCode, userProfile.sdSchulCode, userProfile.grade, userProfile.classNumber);
                } else {
                    fetchAndRenderWeeklyTimetable(currentWeekMonday, 'B10', '7132131', '1', '1');
                }
            });

            // 초기 탭 로드 시 데이터 가져오기
            switchTab('menu');
            // 초기 달력 렌더링
            renderCalendar(currentDate);

            datePickerToggle.addEventListener('click', togglePanel);
            closePanelButton.addEventListener('click', togglePanel);
            menuTab.addEventListener('click', () => switchTab('menu'));
            weatherTab.addEventListener('click', () => switchTab('weather'));
        });
    </script>
</body>
</html>
