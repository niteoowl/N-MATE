<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <link rel="icon" type="image/png" href="/image/simbol.png" media="(prefers-color-scheme: light)">
    <link rel="icon" type="image/png" href="/image/dark_simbol.png" media="(prefers-color-scheme: dark)">
    <meta name="naver-site-verification" content="aaafe41f7a0c71624b1fa0fe8913a0520113a2df" />
    <meta name="description" content="중학생을 위한 정보 플랫폼 Nmate! 급식표, 시간표, 학사일정, 커뮤니티까지 모두 한 곳에서 간편하게 확인하세요.">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>N-MATE | 전국 중학생을 위한 시간표, 급식표, 학사일정 통합 플랫폼</title>
    <!-- Tailwind CSS CDN을 로드합니다. -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Pretendard 폰트 (모든 굵기 포함) 로드 -->
    <link rel="stylesheet" as="style" crossorigin href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard@v1.3.9/dist/web/static/pretendard.css" />
    <style>
        /* Body 스타일: Pretendard 폰트를 기본으로 설정 */
        body {
            font-family: 'Pretendard', sans-serif; /* 'Pretendard'는 위 CSS 파일에서 정의됩니다. */
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            display: flex;
            flex-direction: column;
            min-height: 100vh;
            background-color: #ffffff; /* 라이트 그레이 배경 */
            transition: background-color 0.3s ease; /* 테마 변경 시 부드러운 전환 */
        }

        /* Dark mode styles */
        body.dark {
            background-color: #121212; /* Dark background */
            color: #e2e8f0; /* Light text color */
        }

        body.dark .main-content-container,
        body.dark .dropdown-menu,
        body.dark .dropdown-menu button,
        body.dark #countdownBox,
        body.dark #triviaDisplaySection {
            background-color: #121212; /* Darker background for elements */
            border-color: #4a5568; /* Darker border color */
            color: #e2e8f0; /* Light text color */
        }

        /* Specific background for timetable and meal sections in dark mode */
        body.dark #timetable-display-section,
        body.dark #meal-display-section {
            background-color: #121212;
        }

        body.dark .text-gray-800 {
            color: #e2e8f0; /* Light text for titles */
        }

        body.dark .text-gray-700 {
            color: #cbd5e0; /* Lighter gray text */
        }

        body.dark .text-gray-600 {
            color: #a0aec0; /* Even lighter gray text */
        }

        body.dark .text-gray-500 {
            color: #a0aec0; /* Lighter gray for icons and inactive nav */
        }

        body.dark .dropdown-menu button:hover {
            background-color: #1F1F1F; /* Darker hover state */
        }

        body.dark .nav-item.active {
            color: #63b3ed; /* Lighter blue for active nav item in dark mode */
        }

        body.dark .nav-item.active svg {
            color: #63b3ed; /* Lighter blue for active nav icon in dark mode */
        }

        body.dark .nav-item:hover {
            background-color: #1F1F1F; /* Darker hover for nav items */
            color: #63b3ed; /* Lighter blue hover for nav items */
        }

        /* Ensure all elements using border-gray-300 have the correct dark mode border color */
        body.dark .border-gray-300 {
            border-color: #1F1F1F;
            border-style: solid; /* 명시적으로 테두리 스타일 설정 */
            border-width: 1px; /* 명시적으로 테두리 두께 설정 */
        }

        body.dark .shadow-sm {
            box-shadow: none; /* Remove shadows in dark mode */
        }

        /* Dark mode for Bottom Navigation Bar */
        body.dark .bottom-nav-bar {
            background-color: #121212; /* Dark background for nav bar */
            border-color: #1F1F1F; /* Darker border for nav bar */
        }

        body.dark .bottom-nav-bar .nav-item {
            color: #a0aec0; /* Lighter gray for nav items in dark mode */
        }

        body.dark .bottom-nav-bar .nav-item:hover {
            background-color: #1F1F1F; /* Darker hover for nav items */
            color: #63b3ed; /* Lighter blue hover for nav items */
        }

        body.dark .bottom-nav-bar .nav-item.active {
            color: #63b3ed; /* Lighter blue for active nav item in dark mode */
        }

        body.dark .bottom-nav-bar .nav-item.active svg {
            color: #63b3ed; /* Lighter blue for active nav icon in dark mode */
        }

        /* Dark mode for skeleton loader */
        body.dark .skeleton {
            background-color: #2d3748; /* Darker skeleton background */
        }

        /* 메인 콘텐츠 컨테이너 */
        .main-content-container {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            align-items: flex-start;
            max-width: 36rem;
            margin-left: auto;
            margin-right: auto;
            width: 100%;
            position: relative;
            padding-bottom: 70px;
        }

        /* 드롭다운 메뉴 스타일 */
        .dropdown-menu {
            position: absolute;
            background-color: white;
            border-radius: 0.5rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            padding-top: 0.25rem;
            padding-bottom: 0.25rem;
            min-width: 8rem;
            right: 0;
            top: calc(100% + 0.5rem);
            z-index: 20;
        }

        .dropdown-menu button {
            width: 100%;
            text-align: left;
            padding: 0.5rem 1rem;
            font-size: 0.875rem;
            color: #374151;
            transition: background-color 0.2s ease;
        }

        .dropdown-menu button:hover {
            background-color: #f3f4f6;
        }

        /* 하단 내비게이션 바 스타일 */
        .nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 0.5rem;
            border-radius: 0.75rem;
            transition: all 0.3s ease;
            color: #6b7280;
        }
        .nav-item:hover {
            color: #3b82f6;
            background-color: #f9fafb;
        }
        .nav-item.active {
            color: #2563eb;
        }
        .nav-item.active span {
            font-weight: 700;
        }
        .nav-item.active svg {
            color: #2563eb;
        }

        /* Dark mode for text inside timetable and meal sections */
        body.dark #countdownBox p,
        body.dark #timetable-display-section p,
        body.dark #timetable-display-section strong,
        body.dark #meal-display-section p,
        body.dark #meal-display-section strong,
        body.dark #triviaDisplaySection p {
            color: #e2e8f0 !important; /* Ensure text is light in dark mode, use !important to override Tailwind */
        }

        /* Dark mode for skeleton loader text */
        body.dark .skeleton.skeleton-text {
            color: transparent; /* Ensure skeleton text itself is transparent */
        }

        /* Popup Specific Styles */
        .backdrop-blur-custom {
            backdrop-filter: blur(8px); /* Subtle blur for the overlay */
            -webkit-backdrop-filter: blur(8px);
        }
        .popup-scroll-content {
            max-height: 50vh; /* Maintain reduced popup height */
            overflow-y: auto; /* Enable vertical scrolling */
            -webkit-overflow-scrolling: touch; /* Smooth scrolling on iOS */
        }
        .popup-scroll-content::-webkit-scrollbar {
            display: none;
        }
        .popup-scroll-content {
            -ms-overflow-style: none;  /* IE and Edge */
            scrollbar-width: none;  /* Firefox */
        }

        /* Styles for the button fill effect */
        #closePopupBtn {
            position: relative; /* Needed for pseudo-element positioning */
            overflow: hidden; /* Hide overflow of the filling effect */
            z-index: 1; /* Ensure button text is above the pseudo-element */
            transition: color 0.3s ease-in-out; /* Smooth text color transition */
        }

        #closePopupBtn::before {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 0%; /* Initial height (not filled) */
            background-color: #dc2626; /* Tailwind red-600 color */
            transition: height 0.3s ease-in-out; /* Smooth filling animation */
            z-index: -1; /* Place behind the button text */
        }

        /* Class to apply when the button should be "filled" */
        #closePopupBtn.do-not-show-again-active::before {
            height: 100%; /* Fill up completely */
        }

        /* Adjust text color when the button is filled */
        #closePopupBtn.do-not-show-again-active {
            color: white; /* Text becomes white on red background */
        }

        /* Dark mode for Popups */
        body.dark #popupContent,
        body.dark #updateInfoPopupContent {
            background-color: #1F1F1F; /* Dark background for popup containers */
            box-shadow: none; /* Remove shadows in dark mode */
        }

        body.dark #popupContent .border-gray-200,
        body.dark #updateInfoPopupContent .border-gray-200 {
            border-color: #2d3748; /* Darker border for popup headers/footers */
        }

        body.dark #popupContent .text-gray-900,
        body.dark #updateInfoPopupContent .text-gray-900 {
            color: #e2e8f0; /* Light text for popup titles */
        }

        body.dark #popupContent .text-gray-800,
        body.dark #updateInfoPopupContent .text-gray-800 {
            color: #cbd5e0; /* Lighter gray text for popup body */
        }

        body.dark #popupContent .text-gray-500,
        body.dark #updateInfoPopupContent .text-gray-500 {
            color: #a0aec0; /* Even lighter gray for info icon */
        }

        body.dark #closePopupBtn,
        body.dark #closeUpdateInfoPopupBtn {
            color: #63b3ed; /* Lighter blue for buttons in dark mode */
        }

        body.dark #closePopupBtn:hover,
        body.dark #closeUpdateInfoPopupBtn:hover {
            background-color: #2d3748; /* Darker hover for buttons */
        }
    </style>
</head>
<body>

    <!-- 메인 콘텐츠 영역 -->
    <div class="main-content-container">

        <!-- 헤더: 로고 및 계정/로그인 섹션 -->
        <div class="w-full flex justify-between items-center px-4 pt-4">
            <!-- 로고 -->
            <div class="flex items-center">
                <img src="/image/logo.webp" alt="N-MATE 로고" class="h-12">
            </div>

            <!-- 드롭다운이 있는 계정/로그인 섹션 -->
            <div class="relative">
                <div id="accountStatusArea" class="flex items-center">
                    <!-- JavaScript로 주입되는 조건부 콘텐츠 -->
                </div>
                <!-- 드롭다운 메뉴 (초기에는 숨김) -->
                <div id="accountDropdown" class="dropdown-menu hidden">
                    <button id="settingsButton" class="block">설정</button>
                    <button id="logoutButton" class="block">로그아웃</button>
                </div>
            </div>
        </div>

        <!-- 여름방학 카운트다운 박스 -->
        <div class="w-full flex flex-col items-start gap-y-4 px-4 mt-8 mb-4">
            <div id="countdownBox" class="w-full h-16 bg-white rounded-xl border border-gray-300 flex items-center justify-center text-gray-800 text-lg font-medium p-4">
                <!-- 카운트다운은 JavaScript에 의해 여기에 주입됩니다. -->
                <p class="skeleton skeleton-text w-3/4"></p>
            </div>
        </div>

        <!-- 시간표/급식 섹션 컨테이너 -->
        <div class="w-full flex flex-col items-start gap-y-2 px-4 mt-1 mb-4">
            <!-- 섹션 제목: font-extrabold (font-weight: 800) 적용 -->
            <h2 class="text-left text-xl font-extrabold text-gray-800">시간표/급식</h2>
            <!-- 두 부분으로 분할된 가로 직사각형 상자 -->
            <div class="w-full min-h-40 bg-white rounded-xl border border-gray-300 flex">
                <!-- 왼쪽 절반: 시간표 정보 -->
                <div id="timetable-display-section" class="w-1/2 bg-white rounded-l-xl flex flex-col items-start p-4 overflow-y-auto overflow-x-auto">
                    <!-- 시간표 콘텐츠용 스켈레톤 로더 -->
                    <div class="flex w-full h-full text-left">
                        <div class="flex-1 flex flex-col items-start">
                            <div class="skeleton skeleton-text w-3/4"></div>
                            <div class="skeleton skeleton-text"></div>
                            <div class="skeleton skeleton-text w-1/2"></div>
                            <div class="skeleton skeleton-text w-2/3"></div>
                        </div>
                        <div class="flex-1 flex flex-col items-start">
                            <div class="skeleton skeleton-text w-3/4"></div>
                            <div class="skeleton skeleton-text"></div>
                            <div class="skeleton skeleton-text w-1/2"></div>
                        </div>
                    </div>
                </div>
                <!-- 구분선 추가 -->
                <div class="border-l border-gray-300"></div>
                <!-- 오른쪽 절반: 급식 정보 -->
                <div id="meal-display-section" class="w-1/2 bg-white rounded-r-xl flex items-start justify-start text-gray-800 text-xl font-bold p-4 overflow-y-auto overflow-x-auto">
                    <!-- 급식 콘텐츠용 스켈레톤 로더 -->
                    <div class="w-full text-left">
                        <div class="skeleton skeleton-text w-full"></div>
                        <div class="skeleton skeleton-text w-5/6"></div>
                        <div class="skeleton skeleton-text w-3/4"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 잡학 상식 섹션 컨테이너 -->
        <div class="w-full flex flex-col items-start gap-y-2 px-4 mt-1 mb-4">
            <!-- 섹션 제목: 오늘의 잡학 상식 (font-extrabold (font-weight: 800) 적용) -->
            <h2 class="text-left text-xl font-extrabold text-gray-800">눈이 번쩍! 뇌가 짜릿! 신기한 잡학 상식</h2>
            <!-- 잡학 상식 콘텐츠 박스 -->
            <div id="triviaDisplaySection" class="w-full min-h-20 bg-white rounded-xl border border-gray-300 flex items-center justify-center text-gray-800 text-lg font-medium p-4">
                <!-- 잡학 상식 콘텐츠용 스켈레톤 로더 -->
                <p class="skeleton skeleton-text w-full"></p>
            </div>
        </div>

        <!-- 추가 콘텐츠를 위한 플레이스홀더 -->
        <p class="text-2xl text-gray-700 px-4 mt-1"></p>
    </div>

    <!-- 하단 내비게이션 바 -->
    <nav class="fixed bottom-0 left-0 right-0 bg-white p-3 border-t border-gray-300 max-w-xl mx-auto w-full z-10 bottom-nav-bar">
        <div class="flex justify-around items-center h-12">
            <!-- 홈 내비게이션 아이템 -->
            <button id="nav-home" class="nav-item flex flex-col items-center justify-center p-2 rounded-xl transition-all duration-300 text-gray-500 hover:text-blue-500 hover:bg-gray-50" data-tab="홈" data-path="/">
                <svg viewBox="0 0 24 24" fill="currentColor" class="w-6 h-6 mb-1" xmlns="http://www.w3.org/2000/svg">
                    <path d="M10 20V14H14V20H19V12H22L12 3L2 12H5V20H10Z"/>
                </svg>
                <span class="text-xs font-medium">홈</span>
            </button>

            <!-- 학교생활 내비게이션 아이템 -->
            <button id="nav-school-life" class="nav-item flex flex-col items-center justify-center p-2 rounded-xl transition-all duration-300 text-gray-500 hover:text-blue-500 hover:bg-gray-50" data-tab="학교생활" data-path="/sclife/timetable">
                <svg viewBox="0 0 24 24" fill="currentColor" class="w-6 h-6 mb-1" xmlns="http://www.w3.org/2000/svg">
                    <path d="M4 19V6.5C4 5.94772 4.44772 5.5 5 5.5H19C19.5523 5.5 20 5.94772 20 6.5V19C20 19.5523 19.5523 20 19 20H5C4.44772 20 4 19.5523 4 19ZM6 17H18V7.5H6V17ZM9 10H15V12H9V10Z"/>
                </svg>
                <span class="text-xs font-medium">학교생활</span>
            </button>

            <!-- 커뮤니티 내비게이션 아이템 -->
            <button id="nav-community" class="nav-item flex flex-col items-center justify-center p-2 rounded-xl transition-all duration-300 text-gray-500 hover:text-blue-500 hover:bg-gray-50" data-tab="커뮤니티" data-path="/community">
                <svg viewBox="0 0 24 24" fill="currentColor" class="w-6 h-6 mb-1" xmlns="http://www.w3.org/2000/svg">
                    <path d="M16 11C18.21 11 20 9.21 20 7C20 4.79 18.21 3 16 3C13.79 3 12 4.79 12 7C12 9.21 13.79 11 16 11ZM8 11C10.21 11 12 9.21 12 7C12 4.79 10.21 3 8 3C5.79 3 4 4.79 4 7C4 9.21 5.79 11 8 11ZM16 13C13.67 13 9.34 14.28 9 17V19H23V17C22.66 14.28 18.33 13 16 13ZM8 13C5.33 13 0 14.33 0 17V19H9V17C8.67 14.33 4.33 13 8 13Z"/>
                </svg>
                <span class="text-xs font-medium">커뮤니티</span>
            </button>

            <!-- 캘린더 내비게이션 아이템 -->
            <button id="nav-calendar" class="nav-item flex flex-col items-center justify-center p-2 rounded-xl transition-all duration-300 text-gray-500 hover:text-blue-500 hover:bg-gray-50" data-tab="캘린더" data-path="/calendar">
                <svg viewBox="0 0 24 24" fill="currentColor" class="w-6 h-6 mb-1" xmlns="http://www.w3.org/2000/svg">
                    <path d="M19 4H18V2H16V4H8V2H6V4H5C3.89 4 3 4.9 3 6V20C3 21.1 3.89 22 5 22H19C20.1 22 21 21.1 21 20V6C21 4.9 20.1 4 19 4ZM19 20H5V9H19V20Z"/>
                </svg>
                <span class="text-xs font-medium">캘린더</span>
            </button>

            <!-- 더보기 내비게이션 아이템 -->
            <button id="nav-more" class="nav-item flex flex-col items-center justify-center p-2 rounded-xl transition-all duration-300 text-gray-500 hover:text-blue-500 hover:bg-blue-50" data-tab="더보기" data-path="/more">
                <svg viewBox="0 0 24 24" fill="currentColor" class="w-6 h-6 mb-1" xmlns="http://www.w3.org/2000/svg">
                    <path d="M12 10C10.9 10 10 10.9 10 12C10 13.1 10.9 14 12 14C13.1 14 14 13.1 14 12C14 10.9 13.1 10 12 10ZM19 10C17.9 10 17 10.9 17 12C17 13.1 17.9 14 19 14C20.1 14 21 13.1 21 12C21 10.9 20.1 10 19 10ZM5 10C3.9 10 3 10.9 3 12C3 13.1 3.9 14 5 14C6.1 14 7 13.1 7 12C7 10.9 6.1 10 5 10Z"/>
                </svg>
                <span class="text-xs font-medium">더보기</span>
            </button>
        </div>
    </nav>

    <!-- Main Popup Overlay -->
    <div id="threadsPopup" class="fixed inset-0 bg-black bg-opacity-40 backdrop-blur-custom flex items-center justify-center z-50 hidden p-4">
        <!-- Main Popup Container -->
        <div class="bg-white rounded-2xl shadow-xl max-w-sm w-full mx-auto overflow-hidden transform transition-all duration-300 scale-95 opacity-0" id="popupContent">
            <!-- Main Popup Header -->
            <div class="px-6 py-4 border-b border-gray-200 text-center flex items-center justify-center relative">
                <h3 class="text-lg font-semibold text-gray-900">N-MATE 서버 점검 안내</h3>
                <!-- Info Icon Button -->
                <button id="infoIconBtn" class="absolute right-4 top-1/2 -translate-y-1/2 text-gray-500 hover:text-blue-600 transition duration-200">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-6 h-6">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M11.25 11.25l.041-.02a.75.75 0 011.063.852l-.708 2.836a.75.75 0 001.063.853l.041-.021M21 12a9 9 0 11-18 0 9 9 0 0118 0zm-9-3.75h.008v.008H12V8.25z" />
                    </svg>
                </button>
            </div>

            <!-- Main Popup Body/Content -->
            <div class="p-6 text-left popup-scroll-content" id="scrollContent">
                <p class="text-gray-800 text-sm mb-4">
                    안녕하세요, N-MATE 운영팀입니다.<br>
                    보다 안정적인 서비스 제공을 위해 아래와 같이 서버 점검을 진행할 예정입니다. 이용에 불편을 드리는 점 양해 부탁드립니다.
                </p>
                <p class="text-gray-800 text-sm font-semibold mb-2">점검 일시</p>
                <p class="text-gray-800 text-sm mb-4">
                    2025년 7월 4일(금) 오전 2시부터 2025년 7월 5일 오후 5시까지
                </p>
                <p class="text-gray-800 text-sm font-semibold mb-2">점검 내용</p>
                <ul class="list-disc list-inside text-gray-800 text-sm mb-4 pl-4">
                    <li><strong>커뮤니티 기능 일시 중단</strong>
                        <ul class="list-none pl-4">
                            <li>(글쓰기, 댓글 작성, 회원가입 및 로그인 등)</li>
                        </ul>
                    </li>
                    <li>일부 시스템 안정화 및 기능 개선 작업</li>
                </ul>
                <p class="text-gray-800 text-sm font-semibold mb-2">서비스 이용 가능 항목</p>
                <p class="text-gray-800 text-sm mb-4">
                    시간표, 학사일정, 급식 정보 등 핵심 기능은 점검 중에도 정상적으로 이용 가능합니다.
                </p>
                <p class="text-gray-800 text-sm font-semibold mb-2">안내 사항</p>
                <ul class="list-disc list-inside text-gray-800 text-sm mb-4 pl-4">
                    <li>점검 일정은 작업 상황에 따라 변경될 수 있으며, 변동 시 별도 공지를 통해 안내드리겠습니다.</li>
                    <li>점검 이후 서비스 이용 중 문제가 발생할 경우, support@onebox.kro.kr로 문의해주시기 바랍니다.</li>
                </ul>
                <p class="text-gray-800 text-sm mb-4">
                    점검 이후, N-MATE는 3.0으로 새롭게 돌아옵니다.<br>
                    더 똑똑하게, 더 빠르게, 더 편리하게.<br>
                    완전히 새로워진 N-MATE 3.0을 기대해주세요.
                </p>
                <p class="text-gray-800 text-sm mb-4">감사합니다.</p>
                <p class="text-gray-800 text-sm text-right">2025년 7월 3일<br>N-MATE 운영팀 드림</p>
            </div>

            <!-- Main Popup Button -->
            <div class="border-t border-gray-200 flex flex-row">
                <button class="w-full py-3 text-blue-600 font-semibold text-base hover:bg-gray-50 transition duration-200" id="closePopupBtn">
                    확인
                </button>
            </div>
        </div>
    </div>

    <!-- New Popup Overlay for Update Info -->
    <div id="updateInfoPopup" class="fixed inset-0 bg-black bg-opacity-40 backdrop-blur-custom flex items-center justify-center z-50 hidden p-4">
        <!-- New Popup Container -->
        <div class="bg-white rounded-2xl shadow-xl max-w-sm w-full mx-auto overflow-hidden transform transition-all duration-300 scale-95 opacity-0" id="updateInfoPopupContent">
            <!-- New Popup Header -->
            <div class="px-6 py-4 border-b border-gray-200 text-center">
                <h3 class="text-lg font-semibold text-gray-900">N-MATE 3.0 업데이트 안내</h3>
            </div>

            <!-- New Popup Body/Content -->
            <div class="p-6 text-left popup-scroll-content">
                <p class="text-gray-800 text-sm mb-4">
                    N-MATE 3.0은 사용자 경험을 혁신적으로 개선하기 위해 다음과 같은 주요 변경 사항을 포함합니다:
                </p>
                <ul class="list-disc list-inside text-gray-800 text-sm mb-4 pl-4">
                    <li><strong>AI 기반 개인화된 학습 경로:</strong> 사용자 학습 패턴을 분석하여 최적화된 콘텐츠를 추천합니다.</li>
                    <li><strong>실시간 협업 기능 강화:</strong> 그룹 프로젝트 및 스터디를 위한 실시간 문서 편집 및 공유 기능을 제공합니다.</li>
                    <li><strong>새로운 UI/UX 디자인:</strong> 더 직관적이고 시각적으로 매력적인 인터페이스로 사용 편의성을 높였습니다.</li>
                    <li><strong>모바일 최적화:</strong> 모든 기기에서 끊김 없는 학습 경험을 위한 완벽한 반응형 디자인을 적용했습니다.</li>
                    <li><strong>성능 최적화:</strong> 로딩 속도 개선 및 안정성 향상으로 더욱 쾌적한 환경을 제공합니다.</li>
                </ul>
                <p class="text-gray-800 text-sm mb-4">
                    새로운 N-MATE 3.0에서 더 스마트하고 효율적인 학습을 경험해보세요!
                </p>
            </div>

            <!-- New Popup Button -->
            <div class="border-t border-gray-200 flex flex-row">
                <button class="w-full py-3 text-blue-600 font-semibold text-base hover:bg-gray-50 transition duration-200" id="closeUpdateInfoPopupBtn">
                    닫기
                </button>
            </div>
        </div>
    </div>

    <!-- Lucide Icons CDN (Deferred) -->
    <script src="https://unpkg.com/lucide@latest" defer></script>
    <!-- Firebase SDK CDN (Deferred) -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js" defer></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js" defer></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js" defer></script>

    <script>
        // Firebase 구성 정보를 위한 전역 변수 (Canvas 환경에서 제공)
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = {
            apiKey: "AIzaSyC_SHRcQ9hXmjVbP3km4rdR4UvKIoqpLHo",
            authDomain: "n-mate.firebaseapp.com",
            projectId: "n-mate",
            storageBucket: "n-mate.firebasestorage.app",
            appId: "1:691313471077:web:3066aaeca0a1d9e448e08c",
            measurementId: "G-0LCGVBKXLQ",
            messagingSenderId: "691313471077"
        };

        // Firebase 앱, 인증, Firestore 인스턴스
        let app;
        let auth;
        let db;

        // DOM 요소
        const mealDisplaySection = document.getElementById('meal-display-section');
        const timetableDisplaySection = document.getElementById('timetable-display-section');
        const accountStatusArea = document.getElementById('accountStatusArea');
        const accountDropdown = document.getElementById('accountDropdown');
        const countdownBox = document.getElementById('countdownBox'); // 카운트다운 박스 요소 가져오기
        const triviaDisplaySection = document.getElementById('triviaDisplaySection'); // 잡학 상식 표시 섹션 가져오기

        // Popup DOM elements
        // const openPopupBtn = document.getElementById('openPopupBtn'); // Removed
        const threadsPopup = document.getElementById('threadsPopup');
        const popupContent = document.getElementById('popupContent');
        const scrollContent = document.getElementById('scrollContent');
        const closePopupBtn = document.getElementById('closePopupBtn');
        const infoIconBtn = document.getElementById('infoIconBtn'); // Info icon button

        const updateInfoPopup = document.getElementById('updateInfoPopup'); // Update info popup overlay
        const updateInfoPopupContent = document.getElementById('updateInfoPopupContent'); // Update info popup content
        const closeUpdateInfoPopupBtn = document.getElementById('closeUpdateInfoPopupBtn'); // Close button for update info popup


        // NEIS API 공통 정보 (더 이상 하드코딩되지 않음)
        const neisApiKey = "cbb4da48e87445f68c2732368454ebc3"; // API 키로 대체

        // 로컬 스토리지에서 테마 로드, 없으면 시스템 기본
        let currentSelectedTheme = localStorage.getItem('theme') || 'system';

        /**
         * Applies the selected theme to the body element.
         * @param {string} theme - The theme to apply ('light', 'dark', 'system').
         */
        function applyTheme(theme) {
            const body = document.body;
            if (theme === 'dark') {
                body.classList.add('dark');
            } else if (theme === 'light') {
                body.classList.remove('dark');
            } else if (theme === 'system') {
                // 시스템 설정에 따라 다크 모드 적용
                if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
                    body.classList.add('dark');
                } else {
                    body.classList.remove('dark');
                }
            }
        }

        // 시스템 테마 변경 감지 리스너 (system 테마 선택 시에만 동작)
        window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', event => {
            if (currentSelectedTheme === 'system') {
                applyTheme('system');
            }
        });

        // 오늘 날짜를YYYYMMDD 형식으로 가져오는 함수
        function getTodayDate() {
            const today = new Date();
            const year = today.getFullYear();
            const month = String(today.getMonth() + 1).padStart(2, '0'); // 월은 0부터 시작하므로 1을 더합니다.
            const day = String(today.getDate()).padStart(2, '0');
            return `${year}${month}${day}`;
        }

        // Firestore에서 사용자 프로필을 가져오는 함수
        async function getUserProfile(userId) {
            if (!db) {
                console.error('Firestore 인스턴스가 초기화되지 않았습니다.');
                return null;
            }
            // Firestore 보안 규칙 경로 사용: artifacts/{appId}/users/{userId}/profile/user_data
            const userProfileRef = db.collection(`artifacts/${appId}/users/${userId}/profile`).doc('user_data');
            try {
                const doc = await userProfileRef.get();
                if (doc.exists) {
                    return doc.data();
                } else {
                    console.log('사용자 프로필 데이터를 찾을 수 없습니다.');
                    return null;
                }
            } catch (error) {
                console.error('사용자 프로필 가져오기 오류:', error);
                return null;
            }
        }

        // NEIS API에서 급식 데이터를 가져와 표시하는 함수
        // 교육청 코드와 학교 표준 코드를 인수로 받도록 수정됨
        async function fetchMealData(atptOfcdcScCode, sdSchulCode) {
            // 급식 섹션용 스켈레톤 로더 (홈 페이지 전용)
            mealDisplaySection.innerHTML = `
                <div class="w-full text-left">
                    <div class="skeleton skeleton-text w-full"></div>
                    <div class="skeleton skeleton-text w-5/6"></div>
                    <div class="skeleton skeleton-text w-3/4"></div>
                </div>
            `;

            if (!atptOfcdcScCode || !sdSchulCode) {
                mealDisplaySection.innerHTML = '<p class="text-lg text-red-500">학교 정보가 설정되지 않았습니다. 설정 페이지에서 학교를 선택해주세요.</p>';
                return;
            }

            const date = getTodayDate();
            const apiUrl = `https://open.neis.go.kr/hub/mealServiceDietInfo?KEY=${neisApiKey}&Type=json&pIndex=1&pSize=100&ATPT_OFCDC_SC_CODE=${atptOfcdcScCode}&SD_SCHUL_CODE=${sdSchulCode}&MLSV_YMD=${date}`;

            try {
                const response = await fetch(apiUrl);
                const data = await response.json();

                if (data.mealServiceDietInfo && data.mealServiceDietInfo[1] && data.mealServiceDietInfo[1].row) {
                    const meals = data.mealServiceDietInfo[1].row;
                    let mealHtml = '<div class="text-left">';
                    meals.forEach(meal => {
                        const menu = meal.DDISH_NM.replace(/\([^)]*\)/g, '').trim();
                        mealHtml += `<p class="text-sm font-medium text-gray-800">${meal.MMEAL_SC_NM}: ${menu}</p>`;
                    });
                    mealHtml += '</div>';
                    mealDisplaySection.innerHTML = mealHtml;
                } else if (data.RESULT && data.RESULT.CODE === 'INFO-200') {
                    mealDisplaySection.innerHTML = '<p class="text-lg text-gray-800">등록된 급식이 없어요.</p>';
                } else {
                    mealDisplaySection.innerHTML = '<p class="text-lg text-red-500">급식 정보를 가져오는 데 실패했습니다.</p>';
                    console.error('API 응답 오류 (급식):', data);
                }
            } catch (error) {
                console.error('급식 데이터 가져오기 오류:', error);
                mealDisplaySection.innerHTML = '<p class="text-lg text-red-500">급식 정보를 가져오는 중 오류가 발생했습니다.</p>';
            }
        }

        // NEIS API에서 시간표 데이터를 가져와 표시하는 함수
        // 교육청 코드, 학교 표준 코드, 학년, 반 번호를 인수로 받도록 수정됨
        async function fetchTimetableData(atptOfcdcScCode, sdSchulCode, grade, classNum) {
            // 시간표 섹션용 스켈레톤 로더 (홈 페이지 전용)
            timetableDisplaySection.innerHTML = `
                <div class="flex w-full h-full text-left">
                    <div class="flex-1 flex flex-col items-start">
                        <div class="skeleton skeleton-text w-3/4"></div>
                        <div class="skeleton skeleton-text"></div>
                        <div class="skeleton skeleton-text w-1/2"></div>
                        <div class="skeleton skeleton-text w-2/3"></div>
                    </div>
                    <div class="flex-1 flex flex-col items-start">
                        <div class="skeleton skeleton-text w-3/4"></div>
                        <div class="skeleton skeleton-text"></div>
                        <div class="skeleton skeleton-text w-1/2"></div>
                    </div>
                </div>
            `;

            if (!atptOfcdcScCode || !sdSchulCode) {
                timetableDisplaySection.innerHTML = '<p class="text-lg text-red-500">학교 정보가 설정되지 않았습니다. 설정 페이지에서 학교를 선택해주세요.</p>';
                return;
            }
            if (!grade || !classNum) {
                timetableDisplaySection.innerHTML = '<p class="text-lg text-red-500">학년 또는 반 정보가 설정되지 않았습니다. 설정 페이지에서 업데이트해주세요.</p>';
                return;
            }


            const date = getTodayDate();
            const apiUrl = `https://open.neis.go.kr/hub/misTimetable?KEY=${neisApiKey}&Type=json&pIndex=1&pSize=100&ATPT_OFCDC_SC_CODE=${atptOfcdcScCode}&SD_SCHUL_CODE=${sdSchulCode}&ALL_TI_YMD=${date}&GRADE=${grade}&CLASS_NM=${classNum}`;

            try {
                const response = await fetch(apiUrl);
                const data = await response.json();

                if (data.misTimetable && data.misTimetable[1] && data.misTimetable[1].row) {
                    const timetable = data.misTimetable[1].row;
                    let leftColumnHtml = '';
                    let rightColumnHtml = '';

                    timetable.sort((a, b) => parseInt(a.PERIO) - parseInt(b.PERIO));

                    // 화면 너비에 따라 모바일 뷰인지 확인
                    const isMobileView = window.innerWidth < 768; // Tailwind의 'md' 브레이크포인트

                    timetable.forEach(period => {
                        // 특수 활동명 변환
                        let content = period.ITRT_CNTNT.replace(/\(자\)(주제선택활동|진로탐색활동)/g, (match, p1) => {
                            return p1 === '주제선택활동' ? '주제선택' : '진로탐색';
                        });
                        content = content.replace(/\(창\)동아리활동/g, '동아리');
                        content = content.replace(/\(창\)자율·자치활동/g, '창체');


                        // 기기 유형에 따라 "교시" 조건부 렌더링
                        const periodNumberDisplay = isMobileView ? period.PERIO : `${period.PERIO}교시`;

                        // 텍스트 줄바꿈 방지 및 폰트 크기 적용
                        const periodHtml = `<p class="flex text-sm font-medium text-gray-800 items-baseline">
                                            <strong class="text-gray-700 font-semibold whitespace-nowrap text-sm text-left mr-1">${periodNumberDisplay}</strong>
                                            <span class="flex-grow whitespace-nowrap text-sm">${content}</span>
                                        </p>`;
                        if (parseInt(period.PERIO) <= 4) {
                            leftColumnHtml += periodHtml;
                        } else {
                            rightColumnHtml += periodHtml;
                        }
                    });

                    timetableDisplaySection.innerHTML = `
                        <div class="flex w-full h-full text-left">
                            <div class="flex-1 flex flex-col items-start">
                                ${leftColumnHtml || '<p class="text-sm text-gray-500">오전 시간표 없음</p>'}
                            </div>
                            <div class="flex-1 flex flex-col items-start">
                                ${rightColumnHtml || '<p class="text-sm text-gray-500">오후 시간표 없음</p>'}
                            </div>
                        </div>
                    `;
                } else if (data.RESULT && data.RESULT.CODE === 'INFO-200') {
                    timetableDisplaySection.innerHTML = '<p class="text-lg text-gray-800">등록된 시간표가 없어요.</p>';
                } else {
                    timetableDisplaySection.innerHTML = '<p class="text-lg text-red-500">시간표 정보를 가져오는 데 실패했습니다.</p>';
                    console.error('API 응답 오류 (시간표):', data);
                }
            } catch (error) {
                console.error('시간표 데이터 가져오기 오류:', error);
                timetableDisplaySection.innerHTML = '<p class="text-lg text-red-500">시간표 정보를 가져오는 중 오류가 발생했습니다.</p>';
            }
        }

        // 드롭다운 메뉴 가시성 토글 함수
        function toggleDropdown() {
            accountDropdown.classList.toggle('hidden');
        }

        // 사용자 로그아웃 처리 함수
        async function handleLogout() {
            if (auth) {
                try {
                    await auth.signOut();
                    console.log('로그아웃 성공.');
                    // 로그아웃 후 로그인 페이지로 리디렉션
                    window.location.href = '/login';
                } catch (error) {
                    console.error('로그아웃 오류:', error);
                    // 사용자에게 오류 메시지 표시
                }
            }
        }

        /**
         * 설정 페이지로 이동을 처리합니다.
         */
        function handleSettingsClick() {
            window.location.href = '/settings';
        }

        // 사용자 인증 상태에 따라 계정 UI를 업데이트하는 함수
        async function updateAccountUI(user) {
            if (user && user.email) { // 사용자가 로그인되어 있고 이메일이 있는지 확인
                const emailPrefix = user.email.split('@')[0];
                accountStatusArea.innerHTML = `
                    <button id="accountTabButton" class="flex items-center space-x-2 p-2 rounded-full hover:bg-gray-100 focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <span class="text-gray-700 text-sm font-medium">${emailPrefix}</span>
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-user-circle-2"><path d="M18 20a6 6 0 0 0-12 0"/><circle cx="12" cy="10" r="4"/><circle cx="12" cy="12" r="10"/></svg>
                    </button>
                `;
                document.getElementById('accountTabButton').addEventListener('click', toggleDropdown);

                // 드롭다운 버튼에 이벤트 리스너 연결
                const settingsButton = document.getElementById('settingsButton');
                if (settingsButton && !settingsButton.dataset.listenerAdded) {
                    settingsButton.addEventListener('click', handleSettingsClick);
                    settingsButton.dataset.listenerAdded = 'true';
                }
                const logoutButton = document.getElementById('logoutButton');
                if (logoutButton && !logoutButton.dataset.listenerAdded) {
                    logoutButton.addEventListener('click', handleLogout);
                    logoutButton.dataset.listenerAdded = 'true';
                }

            } else {
                // 사용자가 로그아웃되었거나 이메일이 없는 경우
                accountStatusArea.innerHTML = `
                    <button id="loginRedirectButton" class="bg-blue-500 hover:bg-blue-600 text-white font-medium py-2 px-4 rounded-full shadow transition duration-300">
                        로그인
                    </button>
                `;
                document.getElementById('loginRedirectButton').addEventListener('click', () => {
                    window.location.href = '/login'; // 로그인 페이지로 리디렉션
                });
                accountDropdown.classList.add('hidden'); // 사용자 또는 이메일이 없으면 드롭다운 숨김
            }
        }

        /**
         * 현재 URL 경로에 따라 내비게이션 바 버튼의 활성 상태를 업데이트합니다.
         */
        function updateNavigationActiveState() {
            const currentPath = window.location.pathname;
            const navItems = document.querySelectorAll('.nav-item');

            navItems.forEach(item => {
                const itemPath = item.dataset.path;
                const spanElement = item.querySelector('span');
                const svgElement = item.querySelector('svg');

                // 모든 내비게이션 아이템을 기본(비활성) 상태로 재설정
                item.classList.remove('text-blue-600');
                item.classList.add('text-gray-500', 'hover:text-blue-500', 'hover:bg-gray-50');
                if (spanElement) {
                    spanElement.classList.remove('font-bold');
                    spanElement.classList.add('font-medium');
                }
                if (svgElement) {
                    svgElement.classList.remove('text-blue-600');
                    svgElement.classList.add('text-gray-500');
                }

                // 정확한 경로 일치 또는 학교생활 버튼이고 현재 경로가 /sclife 섹션 내에 있는지 확인
                if (currentPath === itemPath || (item.id === 'nav-school-life' && currentPath.startsWith('/sclife'))) {
                    item.classList.add('text-blue-600');
                    item.classList.remove('text-gray-500', 'hover:text-blue-500', 'hover:bg-gray-50');
                    if (spanElement) {
                        spanElement.classList.add('font-bold');
                        spanElement.classList.remove('font-medium');
                    }
                    if (svgElement) {
                        svgElement.classList.add('text-blue-600');
                        svgElement.classList.remove('text-gray-500');
                    }
                }
            });
        }

        /**
         * 내비게이션 아이템에 클릭 이벤트 리스너를 설정합니다.
         */
        function setupNavigationEvents() {
            const navItems = document.querySelectorAll('.nav-item');
            navItems.forEach(item => {
                item.addEventListener('click', () => {
                    const path = item.dataset.path;
                    const currentPathname = window.location.pathname;

                    // 대상 경로가 현재 경로와 다르면 이동합니다.
                    if (currentPathname !== path) {
                        // 학교생활 버튼에 대한 특별 처리 (localStorage에 초기 탭 설정)
                        if (item.id === 'nav-school-life') {
                            localStorage.setItem('initialSchoolLifeTab', 'timetableContent');
                        } else {
                            // 다른 내비게이션 아이템의 경우, 저장된 학교생활 탭 상태를 지웁니다.
                            localStorage.removeItem('initialSchoolLifeTab');
                        }
                        window.location.href = path;
                    }
                });
            });
        }

        // 여름방학 카운트다운을 업데이트하는 함수
        function updateSummerVacationCountdown() {
            if (!countdownBox) {
                console.error("카운트다운 박스 요소를 찾을 수 없습니다.");
                return;
            }

            const today = new Date();
            today.setHours(0, 0, 0, 0); // 정확한 비교를 위해 하루의 시작으로 정규화

            let currentYear = today.getFullYear();
            let vacationStartDate = new Date(currentYear, 6, 21); // 7월 21일 (월은 0부터 시작: 7월은 6)
            vacationStartDate.setHours(0, 0, 0, 0);
            let vacationEndDate = new Date(currentYear, 7, 18); // 8월 18일 (월은 0부터 시작: 8월은 7)
            vacationEndDate.setHours(0, 0, 0, 0);

            let countdownMessage = '';
            const oneDayInMs = 1000 * 60 * 60 * 24;

            // 오늘이 올해 방학 종료일보다 지난 경우, 내년 방학을 계산
            if (today > vacationEndDate) {
                currentYear++;
                vacationStartDate = new Date(currentYear, 6, 21);
                vacationStartDate.setHours(0, 0, 0, 0);
                vacationEndDate = new Date(currentYear, 7, 18);
                vacationEndDate.setHours(0, 0, 0, 0);
            }

            if (today < vacationStartDate) {
                // 방학 시작 전
                const diffTime = vacationStartDate.getTime() - today.getTime();
                const diffDays = Math.ceil(diffTime / oneDayInMs);
                countdownMessage = `여름방학까지 ${diffDays}일 남았어요!`;
            } else if (today >= vacationStartDate && today < vacationEndDate) {
                // 방학 중 (종료일 전까지)
                const diffTime = vacationEndDate.getTime() - today.getTime();
                const diffDays = Math.ceil(diffTime / oneDayInMs); // 종료일까지 남은 일수
                countdownMessage = `여름방학이 ${diffDays}일 남았어요!`;
            } else if (today.getTime() === vacationEndDate.getTime()) {
                // 방학 종료일
                countdownMessage = `방학이 끝났어요...`;
            } else {
                // 방학 종료 후 (필요한 경우 연도가 이미 증가됨)
                // 이 경우는 vacationEndDate 이후의 날짜를 처리하며, 다음 해 방학을 가리킵니다.
                const diffTime = vacationStartDate.getTime() - today.getTime();
                const diffDays = Math.ceil(diffTime / oneDayInMs);
                countdownMessage = `이번 겨울방학은 12월 31에 시작해요!`;
            }

            countdownBox.innerHTML = `<p class="text-gray-800 text-lg font-medium">${countdownMessage}</p>`;
        }


        // facts.json에서 잡학 상식 데이터를 가져와 표시하는 함수
        async function fetchTriviaData() {
            // 잡학 상식 섹션용 스켈레톤 로더
            triviaDisplaySection.innerHTML = `
                <p class="skeleton skeleton-text w-full h-8"></p>
            `;

            try {
                // facts.json에서 사실 정보 가져오기
                const response = await fetch('/data/facts.json'); // /data 디렉토리에 facts.json이 있다고 가정
                if (!response.ok) {
                    throw new Error(`HTTP 오류! 상태: ${response.status}`);
                }
                const allFacts = await response.json();
                
                if (allFacts.length > 0) {
                    const randomIndex = Math.floor(Math.random() * allFacts.length);
                    const randomFact = allFacts[randomIndex];
                    triviaDisplaySection.innerHTML = `<p class="text-gray-800 text-lg font-medium text-left">${randomFact}</p>`;
                } else {
                    triviaDisplaySection.innerHTML = '<p class="text-lg text-gray-800">잡학 상식 정보가 없습니다.</p>';
                }
            } catch (error) {
                console.error('잡학 상식 데이터 가져오기 오류:', error);
                triviaDisplaySection.innerHTML = '<p class="text-lg text-red-500">잡학 상식 정보를 가져오는 중 오류가 발생했습니다.</p>';
            }
        }


        // 홈 페이지 데이터 가져오기를 초기화하는 함수
        async function initializeHomePageData() {
            let userGrade = "1";
            let userClassNum = "1";
            // 기본값으로 부산남중 교육청 코드와 학교 코드를 설정합니다.
            let userEduCode = "C10";
            let userSchoolCode = "7171018";

            if (auth.currentUser) {
                const user = auth.currentUser;
                const profile = await getUserProfile(user.uid);
                if (profile) {
                    if (profile.grade) {
                        userGrade = profile.grade;
                    } else {
                        console.warn('사용자 프로필에 학년 정보가 없습니다. 기본 1학년을 사용합니다.');
                    }
                    if (profile.classNum) {
                        userClassNum = profile.classNum;
                    } else {
                        console.warn('사용자 프로필에 반 정보가 없습니다. 기본 1반을 사용합니다.');
                    }
                    if (profile.atptOfcdcScCode) {
                        userEduCode = profile.atptOfcdcScCode;
                    } else {
                        console.warn('사용자 프로필에 교육청 코드 정보가 없습니다. 기본 교육청 코드를 사용합니다.');
                    }
                    if (profile.sdSchulCode) {
                        userSchoolCode = profile.sdSchulCode;
                    } else {
                        console.warn('사용자 프로필에 학교 표준 코드 정보가 없습니다. 기본 학교 표준 코드를 사용합니다.');
                    }
                    console.log(`데이터 로드 중: ${userEduCode} ${userSchoolCode} ${userGrade}학년 ${userClassNum}반`);
                } else {
                    console.warn('사용자가 로그인되었지만 프로필 정보가 없습니다. 기본 학교 정보와 1학년 1반 데이터를 로드합니다.');
                }
            } else {
                console.log('인증되지 않았습니다. 기본 학교 정보와 1학년 1반 데이터를 로드합니다.');
            }

            // fetch 함수에 동적으로 가져온 코드와 학년, 반 정보를 전달합니다.
            fetchTimetableData(userEduCode, userSchoolCode, userGrade, userClassNum);
            fetchMealData(userEduCode, userSchoolCode);
            fetchTriviaData(); // 홈 페이지 로드 시 잡학 상식 데이터 가져오기
        }

        document.addEventListener('DOMContentLoaded', async () => {
            // 페이지 로드 시 저장된 테마 적용
            applyTheme(currentSelectedTheme);

            // Firebase 초기화
            if (firebaseConfig && firebase.apps.length === 0) {
                try {
                    app = firebase.initializeApp(firebaseConfig);
                    auth = firebase.auth();
                    db = firebase.firestore();
                    console.log('Firebase 앱, 인증, Firestore가 성공적으로 초기화되었습니다.');

                    // onAuthStateChanged는 세션 지속성을 자동으로 처리합니다.
                    auth.onAuthStateChanged(async (user) => {
                        await updateAccountUI(user);
                        initializeHomePageData(); // 여기에서만 홈 페이지 데이터 초기화
                    });

                } catch (error) {
                    console.error('Firebase 초기화 실패:', error);
                    await updateAccountUI(null); // Firebase 실패 시 UI에 "로그인"이 표시되도록 보장
                    initializeHomePageData();
                }
            } else if (firebase.apps.length > 0) {
                app = firebase.app();
                auth = firebase.auth();
                db = firebase.firestore();
                console.log('Firebase 앱이 이미 초기화되었습니다. 기존 인스턴스를 사용합니다.');

                auth.onAuthStateChanged(async (user) => {
                    await updateAccountUI(user);
                    initializeHomePageData();
                });
            } else {
                console.warn('Firebase 구성이 제대로 제공되지 않았습니다.');
                await updateAccountUI(null);
                initializeHomePageData();
            }

            // 외부 클릭 시 드롭다운 닫기 위한 전역 클릭 리스너
            window.addEventListener('click', function(e) {
                const accountTabButton = document.getElementById('accountTabButton');
                if (accountTabButton && !accountTabButton.contains(e.target) && !accountDropdown.contains(e.target)) {
                    accountDropdown.classList.add('hidden');
                }
            });

            // 내비게이션 클릭 핸들러 설정
            setupNavigationEvents();
            // 초기 로드 시 내비게이션 활성 상태 업데이트
            updateNavigationActiveState();

            // 카운트다운 초기 호출
            updateSummerVacationCountdown();
            // 실시간 카운터를 위해 매초 카운트다운 업데이트
            setInterval(updateSummerVacationCountdown, 1000); // 실시간 카운팅을 위해 1초로 변경

            // 창 크기 조정 시 시간표/급식 섹션 다시 렌더링 ("교시" 텍스트 조정용)
            let resizeTimeout;
            window.addEventListener('resize', () => {
                clearTimeout(resizeTimeout);
                resizeTimeout = setTimeout(() => {
                    // Only re-fetch if the timetable tab is currently active
                    // Since this is the home page, it should always re-initialize if the window size changes
                    initializeHomePageData(); // Re-fetch/re-render data based on new window size
                }, 200);
            });

            // 초기 아이콘 생성 - Lucide 아이콘이 스크립트 로드 후 생성되도록 보장
            // Lucide가 지연되므로, 정의되었는지 확인 후 호출해야 합니다.
            if (typeof lucide !== 'undefined' && lucide.createIcons) {
                lucide.createIcons();
            } else {
                // lucide가 아직 정의되지 않은 경우, 짧은 지연 후 다시 시도
                const checkLucide = setInterval(() => {
                    if (typeof lucide !== 'undefined' && lucide.createIcons) {
                        lucide.createIcons();
                        clearInterval(checkLucide);
                    }
                }, 100);
            }

            // Popup Functions (from threads-popup-html)

            // Function to show the main popup with animation
            function showMainPopup() {
                threadsPopup.classList.remove('hidden');
                setTimeout(() => {
                    popupContent.classList.remove('scale-95', 'opacity-0');
                    popupContent.classList.add('scale-100', 'opacity-100');
                }, 10);

                // Reset scroll position and button state when popup opens
                scrollContent.scrollTop = 0;
                closePopupBtn.textContent = '확인';
                closePopupBtn.classList.remove('do-not-show-again-active');
                closePopupBtn.classList.remove('text-red-600');
                closePopupBtn.classList.add('text-blue-600');
            }

            // Function to hide the main popup with animation
            function hideMainPopup() {
                popupContent.classList.remove('scale-100', 'opacity-100');
                popupContent.classList.add('scale-95', 'opacity-0');
                setTimeout(() => {
                    threadsPopup.classList.add('hidden');
                }, 300);
            }

            // Function to show the update info popup with animation
            function showUpdateInfoPopup() {
                updateInfoPopup.classList.remove('hidden');
                setTimeout(() => {
                    updateInfoPopupContent.classList.remove('scale-95', 'opacity-0');
                    updateInfoPopupContent.classList.add('scale-100', 'opacity-100');
                }, 10);
            }

            // Function to hide the update info popup with animation
            function hideUpdateInfoPopup() {
                updateInfoPopupContent.classList.remove('scale-100', 'opacity-100');
                updateInfoPopupContent.classList.add('scale-95', 'opacity-0');
                setTimeout(() => {
                    updateInfoPopup.classList.add('hidden');
                }, 300);
            }

            // Event listeners for popups
            // openPopupBtn.addEventListener('click', showMainPopup); // Removed this button

            // Check if the popup should be shown automatically
            const doNotShowPopup = localStorage.getItem('doNotShowPopup');
            if (doNotShowPopup !== 'true') {
                showMainPopup(); // Show the main popup automatically
            } else {
                console.log('팝업이 "다시 보지 않기" 설정으로 인해 자동으로 열리지 않습니다.');
            }


            closePopupBtn.addEventListener('click', () => {
                if (closePopupBtn.textContent === '다시 보지 않기') {
                    console.log('버튼 클릭됨: 다시 보지 않기 (스크롤 후)');
                    localStorage.setItem('doNotShowPopup', 'true'); // Set the flag
                } else {
                    console.log('버튼 클릭됨: 확인 (스크롤 전)');
                }
                hideMainPopup();
            });

            scrollContent.addEventListener('scroll', () => {
                if (scrollContent.scrollHeight - scrollContent.scrollTop <= scrollContent.clientHeight + 1) {
                    closePopupBtn.textContent = '다시 보지 않기';
                    closePopupBtn.classList.add('do-not-show-again-active');
                    closePopupBtn.classList.remove('text-blue-600');
                } else {
                    closePopupBtn.textContent = '확인';
                    closePopupBtn.classList.remove('do-not-show-again-active');
                    closePopupBtn.classList.remove('text-red-600');
                    closePopupBtn.classList.add('text-blue-600');
                }
            });

            infoIconBtn.addEventListener('click', (event) => {
                event.stopPropagation(); // Prevent the main popup from closing if clicked on icon
                showUpdateInfoPopup();
            });

            closeUpdateInfoPopupBtn.addEventListener('click', hideUpdateInfoPopup);

            threadsPopup.addEventListener('click', (event) => {
                if (event.target === threadsPopup) {
                    hideMainPopup();
                }
            });

            updateInfoPopup.addEventListener('click', (event) => {
                if (event.target === updateInfoPopup) {
                    hideUpdateInfoPopup();
                }
            });

            popupContent.addEventListener('click', (event) => {
                event.stopPropagation();
            });

            updateInfoPopupContent.addEventListener('click', (event) => {
                event.stopPropagation();
            });
        });
    </script>

    <script>
  if ('serviceWorker' in navigator) {
    navigator.serviceWorker.register('/service-worker.js')
      .then(reg => console.log('서비스 워커 등록됨:', reg.scope))
      .catch(err => console.error('서비스 워커 등록 실패:', err));
  }
    </script>
</body>
</html>
