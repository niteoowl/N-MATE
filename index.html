<!DOCTYPE html>
<html lang="ko">
<head>
    <link rel="icon" type="image/png" href="/image/favicon.png">
    <meta name="naver-site-verification" content="aaafe41f7a0c71624b1fa0fe8913a0520113a2df" />
    <meta name="description" content="중학생을 위한 정보 플랫폼 Nmate! 급식표, 시간표, 학사일정, 커뮤니티까지 모두 한 곳에서 간편하게 확인하세요.">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>N-MATE | 전국 중학생을 위한 시간표, 급식표, 학사일정 통합 플랫폼</title>
    <link rel="stylesheet" href="output.css">
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>

    <style>
        /* CSS 변수를 사용하여 색상을 정의합니다. */
        :root {
            --bg-primary: #17171c;
            --bg-secondary: #201f27;
            --text-primary: #E0E0E0;
            --text-secondary: #A0A0A0;
            --color-blue: #007BFF;
            --border-color: #201f27;
            --bg-hover: #33323a;
        }

        /* wanted-sans 폰트를 로드합니다. */
        @import url('https://fastly.jsdelivr.dev/gh/wanteddev/wanted-sans@v1.0.1/packages/wanted-sans/fonts/webfonts/variable/split/WantedSansVariable.min.css');

        body {
            font-family: 'WantedSansVariable', sans-serif;
            background-color: var(--bg-primary);
            color: var(--text-primary);
            padding-bottom: 5rem;
            opacity: 0;
            transition: opacity 0.5s ease-in-out;
        }

        body.loaded {
            opacity: 1;
        }
        
        /* 스크롤바 숨기기 */
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

        /* 슬라이드 패널 애니메이션 */
        .slide-panel { transform: translateY(100%); transition: transform 0.3s ease-in-out; z-index: 60; }
        .slide-panel.is-visible { transform: translateY(0); }
        
        /* 헤더 스타일을 항상 고정된 작은 크기로 변경 */
        .header-fixed {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 50;
            background-color: rgba(23, 23, 28, 0.8);
            backdrop-filter: blur(8px);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }

        .nav-inner { width: 100%; }
        @media (min-width: 768px) { .nav-inner { max-width: 768px; margin-left: auto; margin-right: auto; } }

        .invert-icon { filter: invert(1); }

        /* 새로운 시간표 그리드 셀 스타일 */
        .timetable-grid > div {
            border-right: 1px solid var(--border-color);
            border-bottom: 1px solid var(--border-color);
            background-color: var(--bg-secondary);
        }
        .timetable-grid > div:nth-child(6n) { border-right: none; }
        .timetable-grid > div:nth-last-child(-n+6) { border-bottom: none; }
        .timetable-grid .grid-cell-day,
        .timetable-grid .grid-cell-hour {
            min-height: 3rem;
            background-color: var(--bg-secondary);
            font-weight: bold;
            color: var(--text-primary);
            font-size: 0.875rem;
            padding: 1rem 0.75rem;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        .timetable-grid .grid-cell-hour {
            min-height: 5rem;
            font-size: 1.125rem;
            padding: 0.5rem;
        }
        .timetable-grid .grid-cell {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            padding: 0.5rem;
            min-height: 5rem;
            transition: background-color 0.2s;
        }
        .timetable-grid .grid-cell:hover {
            background-color: var(--bg-hover);
        }
        .dropdown-menu {
            opacity: 0;
            visibility: hidden;
            transform: translateY(10px);
            transition: all 0.2s ease-in-out;
        }
        .dropdown-menu.is-visible {
            opacity: 1;
            visibility: visible;
            transform: translateY(0);
        }

        /* 커뮤니티 배너 컨테이너의 최소 높이 상향 조정 */
        .community-banner {
            min-height: 200px;
            position: relative;
        }

        /* 텍스트 컨테이너의 높이를 조정 */
        .community-text-container {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            padding: 1rem;
            display: flex;
            flex-direction: column;
            justify-content: flex-end;
            min-height: 100px;
            background: linear-gradient(to top, rgba(0, 0, 0, 0.8) 0%, rgba(0, 0, 0, 0) 100%);
        }

        /* 반응형 폰트 크기 및 패딩 재조정 */
        @media (min-width: 768px) {
            .community-banner {
                min-height: 250px;
            }
            .community-text-container {
                padding: 1.5rem;
                min-height: 120px;
            }
        }

        /* 새로운 애니메이션 정의 */
        @keyframes fadeInUp {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @keyframes slideInUp {
            from { opacity: 0; transform: translateY(100%); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* 개별 요소에 애니메이션 적용 */
        .animate-fadeInUp {
            animation: fadeInUp 0.6s ease-out forwards;
            opacity: 0;
        }
        .animate-fadeIn {
            animation: fadeIn 0.6s ease-out forwards;
            opacity: 0;
        }

        .active-nav-link {
            filter: invert(1);
            color: white;
        }
    </style>
</head>
<body class="bg-[--bg-primary] text-white">

    <!-- 메인 컨테이너 -->
    <div id="app-container" class="container mx-auto px-4 md:px-8 max-w-screen-md pt-24 md:pt-28">

        <!-- 헤더 섹션: 항상 고정된 작은 크기로 변경 -->
        <header id="main-header" class="header-fixed animate-fadeIn" style="animation-delay: 0.1s;">
            <div class="header-inner container mx-auto max-w-screen-md px-4 md:px-8 py-2 flex items-center justify-between">
                <div class="flex items-center">
                    <img src="https://i.postimg.cc/XvKJktcP/001-2025-08-01-T220040-650.png" alt="hanilians 로고" class="h-8 md:h-8 w-auto">
                </div>
                <div id="auth-ui-container" class="flex items-center space-x-2">
                    <!-- JavaScript로 로그인 버튼 또는 사용자 프로필이 여기에 동적으로 추가됩니다 -->
                </div>
            </div>
        </header>

        <!-- 동적으로 페이지 콘텐츠가 로드될 메인 영역 -->
        <main id="main-content-area">
            <!-- 초기 홈 페이지 콘텐츠가 여기에 로드됩니다 -->
        </main>

    </div>

    <!-- 날짜 선택 패널 (모든 페이지에서 공유) -->
    <div id="date-picker-panel" class="fixed bottom-0 left-0 right-0 bg-[--bg-secondary] rounded-t-3xl shadow-lg transition-transform duration-300 slide-panel">
        <div class="flex justify-between items-center p-4 border-b border-gray-700">
            <h3 class="text-lg font-bold">날짜 선택</h3>
            <button id="close-panel" class="p-2 rounded-full text-white hover:bg-[--bg-hover] transition-colors duration-200">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-x"><path d="M18 6 6 18"/><path d="m6 6 12 12"/></svg>
            </button>
        </div>
        <!-- 달력 UI가 들어갈 곳 -->
        <div id="calendar-container" class="p-4 h-64 overflow-y-auto no-scrollbar">
            <!-- JavaScript로 달력이 여기에 동적으로 생성됩니다. -->
        </div>
    </div>

    <!-- 하단 내비게이션 바 (모든 페이지에서 공유) -->
    <nav class="fixed bottom-0 left-0 right-0 bg-[#17171b] border-t border-gray-700 z-50">
        <div class="nav-inner py-1 px-4 flex justify-around items-center">
            <a href="/" id="nav-home" class="flex flex-col items-center p-1 rounded-xl text-white hover:bg-[--bg-hover] transition-colors duration-200" data-page="home">
                <img src="https://www.hanilians.xyz/header/home-filled.svg" alt="홈 아이콘" class="w-7 h-7 invert-icon">
                <span class="text-xs">홈</span>
            </a>
            <a href="sclife.html" id="nav-sclife" class="flex flex-col items-center p-1 rounded-xl text-[--text-secondary] hover:bg-[--bg-hover] hover:text-white transition-colors duration-200" data-page="sclife">
                <img src="https://www.hanilians.xyz/header/news.svg" alt="학교생활 아이콘" class="w-7 h-7" style="filter: brightness(0) invert(0.6);">
                <span class="text-xs">학교생활</span>
            </a>
            <a href="community.html" id="nav-community" class="flex flex-col items-center p-1 rounded-xl text-[--text-secondary] hover:bg-[--bg-hover] hover:text-white transition-colors duration-200" data-page="community">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" class="w-6 h-6" style="transform: translateY(-2px);">
                    <path d="M3.5 6.5C3.5 5.39543 4.39543 4.5 5.5 4.5H18.5C19.6046 4.5 20.5 5.39543 20.5 6.5V15.5C20.5 16.6046 19.6046 17.5 18.5 17.5H9.5L5.5 20.5V17.5H5.5C4.39543 17.5 3.5 16.6046 3.5 15.5V6.5Z"
                        stroke="#9D9D9D" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
                <span class="text-xs">커뮤니티</span>
            </a>
            <a href="more.html" id="nav-more" class="flex flex-col items-center p-1 rounded-xl text-[--text-secondary] hover:bg-[--bg-hover] hover:text-white transition-colors duration-200" data-page="more">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" class="w-7 h-7">
                    <circle cx="6" cy="12" r="2" fill="#9D9D9D"/>
                    <circle cx="12" cy="12" r="2" fill="#9D9D9D"/>
                    <circle cx="18" cy="12" r="2" fill="#9D9D9D"/>
                </svg>
                <span class="text-xs">더보기</span>
            </a>
        </div>
    </nav>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.0.0/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.0.0/firebase-auth.js";
        import { getFirestore, doc, getDoc } from "https://www.gstatic.com/firebasejs/10.0.0/firebase-firestore.js";

        // Firebase 설정. 사용자가 제공한 설정 정보를 사용합니다.
        const firebaseConfig = {
            apiKey: "AIzaSyC_SHRcQ9hXmjVbP3km4rdR4UvKIoqpLHo",
            authDomain: "n-mate.firebaseapp.com",
            projectId: "n-mate",
            storageBucket: "n-mate.firebasestorage.app",
            messagingSenderId: "691313471077",
            appId: "1:691313471077:web:3066aaeca0a1d9e448e08c",
            measurementId: "G-0LCGVBKXLQ"
        };
        
        // 앱 ID를 전역 변수에서 가져옵니다. 없을 경우 'default-app-id'를 사용합니다.
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

        // Firebase 앱 초기화
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // 전역 변수 설정
        window.auth = auth;
        window.db = db;
        window.appId = appId;

        const mainContentArea = document.getElementById('main-content-area');
        const datePickerPanel = document.getElementById('date-picker-panel');
        const closePanelButton = document.getElementById('close-panel');
        const authUiContainer = document.getElementById('auth-ui-container');
        const navLinks = document.querySelectorAll('nav a');

        let currentDate = new Date();
        let currentWeekMonday = getMonday(currentDate);
        let userProfile = null;
        let isAuthListenerReady = false;

        // 페이지 로드 시 애니메이션 활성화
        window.addEventListener('load', () => {
            document.body.classList.add('loaded');
        });

        // Firebase Auth 상태 변화를 감지하는 리스너
        onAuthStateChanged(auth, async (user) => {
            isAuthListenerReady = true;
            if (user) {
                try {
                    const profileRef = doc(db, 'artifacts', appId, 'users', user.uid, 'profile', 'user_data');
                    const profileSnap = await getDoc(profileRef);

                    if (profileSnap.exists()) {
                        userProfile = profileSnap.data();
                        
                        if (!userProfile.sdSchulCode || !userProfile.atptOfcdcScCode) {
                            console.error("사용자 프로필에 학교 정보가 없거나 코드가 누락되었습니다.");
                            userProfile = null; // 프로필 정보가 불완전하면 null로 설정
                        } else {
                            console.log("User profile loaded:", userProfile);
                        }
                    } else {
                        console.log("No user profile document found, but user is logged in.");
                        userProfile = null;
                    }
                    
                    // Firestore에 저장된 Name 값 또는 이메일(없을 경우)을 사용하도록 수정
                    const displayName = userProfile && Name ? Name : '사용자';
                    updateAuthUI(displayName);
                } catch (error) {
                    console.error("Error fetching user profile:", error);
                    userProfile = null;
                    // 오류 발생 시에도 기본값으로 UI 업데이트
                    updateAuthUI('사용자');
                }
            } else {
                console.log("User is signed out.");
                userProfile = null;
                updateAuthUI(null);
            }
            // 최초 페이지 로드
            const initialPath = window.location.pathname.split('/').pop() || 'index.html';
            loadPageContent(initialPath);
        });

        // 로그인 상태에 따라 UI를 업데이트하는 함수
        function updateAuthUI(userName) {
            authUiContainer.innerHTML = '';
            if (userName) {
                const dropdownHtml = `
                    <div class="relative group">
                        <button id="user-name-button" class="bg-gray-700 bg-opacity-50 hover:bg-opacity-75 text-white font-medium py-1.5 px-4 rounded-full flex items-center space-x-2 transition-colors duration-200">
                            <span>${userName}</span>
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-chevron-down"><path d="m6 9 6 6 6-6"/></svg>
                        </button>
                        <div id="dropdown-menu" class="dropdown-menu absolute right-0 mt-2 py-2 w-48 bg-[--bg-secondary] rounded-md shadow-lg z-50">
                            <button id="logout-button" class="block w-full text-left px-4 py-2 text-sm text-white hover:bg-[--bg-hover]">로그아웃</button>
                        </div>
                    </div>
                `;
                authUiContainer.innerHTML = dropdownHtml;

                const dropdownButton = document.getElementById('user-name-button');
                const dropdownMenu = document.getElementById('dropdown-menu');
                const logoutButton = document.getElementById('logout-button');

                dropdownButton.addEventListener('click', (event) => {
                    dropdownMenu.classList.toggle('is-visible');
                    event.stopPropagation();
                });
                document.addEventListener('click', (event) => {
                    if (!dropdownButton.contains(event.target) && !dropdownMenu.contains(event.target)) {
                        dropdownMenu.classList.remove('is-visible');
                    }
                });
                logoutButton.addEventListener('click', () => {
                    signOut(auth)
                        .then(() => console.log('Signed out successfully.'))
                        .catch(error => console.error('Sign out error:', error));
                });
            } else {
                const loginButtonHtml = `
                    <button id="login-button" class="login-button bg-transparent font-medium py-1.5 px-4 rounded-full text-sm border border-gray-700 hover:bg-[--bg-hover] transition-colors duration-200">로그인</button>
                `;
                authUiContainer.innerHTML = loginButtonHtml;
                document.getElementById('login-button').addEventListener('click', () => {
                    window.location.href = '/login';
                });
            }
        }
        
        // 페이지 콘텐츠를 정의하는 딕셔너리 (이제 사용하지 않음)
        // const pageTemplates = {...};

        // 내비게이션 바 상태 업데이트 함수
        function updateNavActiveState(pageName) {
            navLinks.forEach(link => {
                const linkPage = link.getAttribute('href').split('/').pop().replace('.html', '');
                const isActive = (pageName === linkPage) || (pageName === 'index.html' && linkPage === '');
                const img = link.querySelector('img');
                const svgPath = link.querySelector('svg path');
                
                if (isActive) {
                    link.classList.add('text-white', 'active-nav-link');
                    link.classList.remove('text-[--text-secondary]');
                    if (img) img.style.filter = 'invert(1)';
                    if (svgPath) svgPath.setAttribute('stroke', '#fff');
                } else {
                    link.classList.remove('text-white', 'active-nav-link');
                    link.classList.add('text-[--text-secondary]');
                    if (img) img.style.filter = 'brightness(0) invert(0.6)';
                    if (svgPath) svgPath.setAttribute('stroke', '#9D9D9D');
                }
            });
        }
        
        // --- SPA 라우팅 로직 시작 (Fetch를 사용한 동적 로딩) ---
        
        // 페이지 로드 함수 (파일에서 콘텐츠를 가져옴)
        async function loadPageContent(pageUrl) {
            // URL을 변경하고 히스토리에 상태를 추가
            history.pushState({ path: pageUrl }, '', pageUrl);

            // 내비게이션 바 상태 업데이트
            const pageName = pageUrl.split('/').pop().replace('.html', '');
            updateNavActiveState(pageName);
            
            // 메인 콘텐츠 영역 초기화 (로딩 스켈레톤)
            mainContentArea.innerHTML = `
                <div class="space-y-4 animate-pulse">
                    <div class="h-8 bg-gray-700 rounded w-1/4"></div>
                    <div class="h-4 bg-gray-700 rounded w-full"></div>
                    <div class="h-4 bg-gray-700 rounded w-5/6"></div>
                    <div class="h-4 bg-gray-700 rounded w-2/3"></div>
                </div>
            `;
            
            try {
                // home 페이지는 index.html에 포함된 내용을 사용
                if (pageUrl === 'index.html' || pageUrl === '/') {
                    mainContentArea.innerHTML = `
                        <!-- 알림/정보 섹션 -->
                        <div class="bg-[--bg-secondary] rounded-2xl p-4 flex items-start space-x-2 mb-6 animate-fadeInUp" style="animation-delay: 0.2s;">
                            <span class="text-2xl mt-1 flex-shrink-0">✨</span>
                            <div>
                                <p class="font-medium text-base">새로워진 N-MATE, 어떠세요?</p>
                                <p class="text-white font-medium text-sm">피드백하러 가기</p>
                            </div>
                            <button class="ml-auto p-1.5 rounded-full text-white hover:bg-[--bg-secondary] transition-colors duration-200">
                                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-chevron-right"><path d="m9 18 6-6-6-6"/></svg>
                            </button>
                        </div>

                        <!-- 커뮤니티 섹션 -->
                        <div class="relative bg-gray-800 rounded-3xl overflow-hidden mb-6 community-banner animate-fadeInUp" style="animation-delay: 0.3s;">
                            <img src="https://i.postimg.cc/wv0jSJrc/001-88.png" alt="커뮤니티 배경" class="w-full h-full absolute top-0 left-0 object-cover">
                            <div class="absolute inset-0 bg-black bg-opacity-50 p-4 md:p-6 flex flex-col justify-between">
                                <button class="ml-auto p-2 rounded-full text-white hover:bg-gray-700 hover:bg-opacity-75 transition-colors duration-200">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-x"><path d="M18 6 6 18"/><path d="m6 6 12 12"/></svg>
                                </button>
                                <div class="mt-auto">
                                    <h2 class="text-white text-base md:text-xl font-bold mb-2">N-MATE 3.0으로 완전히 달라졌어요!</h2>
                                    <p class="text-white text-xs md:text-sm mb-4">오늘도 N-MATE는 변화합니다</p>
                                    <button class="bg-gray-700 bg-opacity-50 hover:bg-opacity-75 text-white font-medium py-2 px-4 rounded-full flex items-center space-x-2 transition-colors duration-200">
                                        <span>더 보기</span>
                                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-arrow-right"><path d="M5 12h14"/><path d="m12 5 7 7-7 7"/></svg>
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- 오늘의 메뉴 섹션 -->
                        <div class="mb-4 animate-fadeInUp" style="animation-delay: 0.4s;">
                            <div class="flex items-end justify-between">
                                <div class="font-bold text-xl pb-1">오늘의 급식</div>
                                <button id="date-picker-toggle" class="p-2 rounded-full text-white hover:bg-[--bg-secondary] transition-colors duration-200">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-chevron-down"><path d="m6 9 6 6 6-6"/></svg>
                                </button>
                            </div>
                            <div id="date-display" class="text-gray-400 text-sm mt-2"></div>
                        </div>

                        <!-- 오늘의 메뉴 카드 섹션 (동적 콘텐츠) -->
                        <div id="menu-content" class="mb-8 animate-fadeInUp" style="animation-delay: 0.5s;">
                            <div id="meal-card" class="bg-[--bg-secondary] p-4 rounded-2xl w-full flex flex-col justify-start min-h-[10rem]">
                                <!-- 스켈레톤 로딩 UI -->
                                <div class="animate-pulse flex flex-col space-y-4">
                                    <div class="h-6 bg-gray-700 rounded-lg w-2/4"></div>
                                    <div class="h-4 bg-gray-700 rounded-lg w-1/4"></div>
                                    <div class="h-4 bg-gray-700 rounded-lg w-full"></div>
                                    <div class="h-4 bg-gray-700 rounded-lg w-5/6"></div>
                                    <div class="h-4 bg-gray-700 rounded-lg w-4/6"></div>
                                </div>
                            </div>
                        </div>

                        <!-- 시간표 섹션 -->
                        <div class="space-y-4 mt-6 animate-fadeInUp" style="animation-delay: 0.6s;">
                            <div class="flex items-center justify-between mb-4">
                                <h1 id="timetable-title" class="text-xl font-bold">시간표</h1>
                                <div class="flex items-center ml-2">
                                    <span id="current-week-display" class="text-sm text-gray-400 mr-2"></span>
                                    <button id="prev-week-button" class="p-2 rounded-full text-white hover:bg-[--bg-secondary] transition-colors duration-200">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-chevron-left"><path d="m15 18-6-6 6-6"/></svg>
                                    </button>
                                    <button id="next-week-button" class="p-2 rounded-full text-white hover:bg-[--bg-secondary] transition-colors duration-200">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucude-chevron-right"><path d="m9 18 6-6-6-6"/></svg>
                                    </button>
                                </div>
                            </div>

                            <div id="timetable-content" class="bg-[--bg-secondary] rounded-3xl overflow-hidden shadow-lg mb-4">
                                <!-- 스켈레톤 로딩 UI -->
                                <div class="animate-pulse grid grid-cols-6 text-center text-sm font-medium timetable-grid overflow-x-auto no-scrollbar">
                                    <div class="grid-cell-day rounded-tl-3xl min-w-[50px] md:min-w-0">교시</div>
                                    <div class="grid-cell-day min-w-[100px] md:min-w-0">월</div>
                                    <div class="grid-cell-day min-w-[100px] md:min-w-0">화</div>
                                    <div class="grid-cell-day min-w-[100px] md:min-w-0">수</div>
                                    <div class="grid-cell-day min-w-[100px] md:min-w-0">목</div>
                                    <div class="grid-cell-day rounded-tr-3xl min-w-[100px] md:min-w-0">금</div>
                                    <div class="grid-cell-hour min-w-[50px] md:min-w-0">1</div><div class="grid-cell min-w-[100px] md:min-w-0"><div class="h-4 bg-gray-700 rounded w-4/5"></div></div><div class="grid-cell min-w-[100px] md:min-w-0"><div class="h-4 bg-gray-700 rounded w-4/5"></div></div><div class="grid-cell min-w-[100px] md:min-w-0"><div class="h-4 bg-gray-700 rounded w-4/5"></div></div><div class="grid-cell min-w-[100px] md:min-w-0"><div class="h-4 bg-gray-700 rounded w-4/5"></div></div><div class="grid-cell min-w-[100px] md:min-w-0"><div class="h-4 bg-gray-700 rounded w-4/5"></div></div>
                                    <div class="grid-cell-hour min-w-[50px] md:min-w-0">2</div><div class="grid-cell min-w-[100px] md:min-w-0"><div class="h-4 bg-gray-700 rounded w-4/5"></div></div><div class="grid-cell min-w-[100px] md:min-w-0"><div class="h-4 bg-gray-700 rounded w-4/5"></div></div><div class="grid-cell min-w-[100px] md:min-w-0"><div class="h-4 bg-gray-700 rounded w-4/5"></div></div><div class="grid-cell min-w-[100px] md:min-w-0"><div class="h-4 bg-gray-700 rounded w-4/5"></div></div><div class="grid-cell min-w-[100px] md:min-w-0"><div class="h-4 bg-gray-700 rounded w-4/5"></div></div>
                                    <div class="grid-cell-hour min-w-[50px] md:min-w-0">3</div><div class="grid-cell min-w-[100px] md:min-w-0"><div class="h-4 bg-gray-700 rounded w-4/5"></div></div><div class="grid-cell min-w-[100px] md:min-w-0"><div class="h-4 bg-gray-700 rounded w-4/5"></div></div><div class="grid-cell min-w-[100px] md:min-w-0"><div class="h-4 bg-gray-700 rounded w-4/5"></div></div><div class="grid-cell min-w-[100px] md:min-w-0"><div class="h-4 bg-gray-700 rounded w-4/5"></div></div><div class="grid-cell min-w-[100px] md:min-w-0"><div class="h-4 bg-gray-700 rounded w-4/5"></div></div>
                                    <div class="grid-cell-hour min-w-[50px] md:min-w-0">4</div><div class="grid-cell min-w-[100px] md:min-w-0"><div class="h-4 bg-gray-700 rounded w-4/5"></div></div><div class="grid-cell min-w-[100px] md:min-w-0"><div class="h-4 bg-gray-700 rounded w-4/5"></div></div><div class="grid-cell min-w-[100px] md:min-w-0"><div class="h-4 bg-gray-700 rounded w-4/5"></div></div><div class="grid-cell min-w-[100px] md:min-w-0"><div class="h-4 bg-gray-700 rounded w-4/5"></div></div><div class="grid-cell min-w-[100px] md:min-w-0"><div class="h-4 bg-gray-700 rounded w-4/5"></div></div>
                                    <div class="grid-cell-hour min-w-[50px] md:min-w-0">5</div><div class="grid-cell min-w-[100px] md:min-w-0"><div class="h-4 bg-gray-700 rounded w-4/5"></div></div><div class="grid-cell min-w-[100px] md:min-w-0"><div class="h-4 bg-gray-700 rounded w-4/5"></div></div><div class="grid-cell min-w-[100px] md:min-w-0"><div class="h-4 bg-gray-700 rounded w-4/5"></div></div><div class="grid-cell min-w-[100px] md:min-w-0"><div class="h-4 bg-gray-700 rounded w-4/5"></div></div><div class="grid-cell min-w-[100px] md:min-w-0"><div class="h-4 bg-gray-700 rounded w-4/5"></div></div>
                                    <div class="grid-cell-hour min-w-[50px] md:min-w-0">6</div><div class="grid-cell min-w-[100px] md:min-w-0"><div class="h-4 bg-gray-700 rounded w-4/5"></div></div><div class="grid-cell min-w-[100px] md:min-w-0"><div class="h-4 bg-gray-700 rounded w-4/5"></div></div><div class="grid-cell min-w-[100px] md:min-w-0"><div class="h-4 bg-gray-700 rounded w-4/5"></div></div><div class="grid-cell min-w-[100px] md:min-w-0"><div class="h-4 bg-gray-700 rounded w-4/5"></div></div><div class="grid-cell min-w-[100px] md:min-w-0"><div class="h-4 bg-gray-700 rounded w-4/5"></div></div>
                                    <div class="grid-cell-hour min-w-[50px] md:min-w-0">7</div><div class="grid-cell min-w-[100px] md:min-w-0"><div class="h-4 bg-gray-700 rounded w-4/5"></div></div><div class="grid-cell min-w-[100px] md:min-w-0"><div class="h-4 bg-gray-700 rounded w-4/5"></div></div><div class="grid-cell min-w-[100px] md:min-w-0"><div class="h-4 bg-gray-700 rounded w-4/5"></div></div><div class="grid-cell min-w-[100px] md:min-w-0"><div class="h-4 bg-gray-700 rounded w-4/5"></div></div><div class="grid-cell min-w-[100px] md:min-w-0"><div class="h-4 bg-gray-700 rounded w-4/5"></div></div>
                                </div>
                            </div>

                            <!-- 두근두근 설레는 시험 섹션 -->
                            <div class="mt-8">
                                <h3 class="text-xl font-bold mb-4">두근두근 설레는 시험</h3>
                                <div id="exam-dday-section" class="grid grid-cols-2 sm:grid-cols-3 gap-4 text-center">
                                    <!-- 스켈레톤 로딩 UI -->
                                    <div class="animate-pulse p-4 bg-[--bg-secondary] rounded-2xl flex flex-col items-center justify-center h-24">
                                        <div class="h-4 bg-gray-700 rounded w-3/4 mb-2"></div>
                                        <div class="h-6 bg-gray-700 rounded w-1/2"></div>
                                    </div>
                                    <div class="animate-pulse p-4 bg-[--bg-secondary] rounded-2xl flex flex-col items-center justify-center h-24">
                                        <div class="h-4 bg-gray-700 rounded w-3/4 mb-2"></div>
                                        <div class="h-6 bg-gray-700 rounded w-1/2"></div>
                                    </div>
                                    <div class="animate-pulse p-4 bg-[--bg-secondary] rounded-2xl flex flex-col items-center justify-center h-24">
                                        <div class="h-4 bg-gray-700 rounded w-3/4 mb-2"></div>
                                        <div class="h-6 bg-gray-700 rounded w-1/2"></div>
                                    </div>
                                </div>
                            </div>

                            <hr class="my-6 border-gray-700">

                            <!-- 학사일정 섹션 (동적으로 생성될 컨테이너) -->
                            <div>
                                <h3 class="text-xl font-bold mb-4">학사일정</h3>
                                <div id="academic-schedule-content" class="space-y-4">
                                    <!-- 스켈레톤 로딩 UI -->
                                    <div class="animate-pulse flex items-center justify-between p-4 rounded-2xl bg-[--bg-secondary]">
                                        <div class="h-4 bg-gray-700 rounded w-1/3"></div>
                                        <div class="h-4 bg-gray-700 rounded w-1/4"></div>
                                    </div>
                                    <div class="animate-pulse flex items-center justify-between p-4 rounded-2xl bg-[--bg-secondary]">
                                        <div class="h-4 bg-gray-700 rounded w-2/3"></div>
                                        <div class="h-4 bg-gray-700 rounded w-1/4"></div>
                                    </div>
                                </div>
                            </div>

                            <hr class="my-6 border-gray-700">
                        </div>
                    `;
                    initializeHomePageContent();
                } else {
                    const response = await fetch(pageUrl);
                    if (!response.ok) throw new Error('페이지를 불러오지 못했습니다.');
                    
                    const text = await response.text();
                    mainContentArea.innerHTML = text;

                    // 다른 페이지로 이동 시 패널 닫기
                    datePickerPanel.classList.remove('is-visible');
                }
            } catch (error) {
                console.error('Failed to load page content:', error);
                mainContentArea.innerHTML = `<div class="p-6 text-center min-h-[calc(100vh-10rem)] flex flex-col items-center justify-center"><h2 class="text-4xl font-bold mb-4">오류 발생</h2><p class="text-lg text-gray-400">페이지를 불러오는 중 문제가 발생했습니다.</p></div>`;
            }
        }
        
        // 홈 페이지 전용 초기화 함수 (모든 기존 로직 포함)
        function initializeHomePageContent() {
            // DOM이 업데이트된 후에만 요소에 접근
            const datePickerToggle = document.getElementById('date-picker-toggle');
            const dateDisplay = document.getElementById('date-display');
            const mealCard = document.getElementById('meal-card');
            const timetableContent = document.getElementById('timetable-content');
            const prevWeekButton = document.getElementById('prev-week-button');
            const nextWeekButton = document.getElementById('next-week-button');
            const currentWeekDisplay = document.getElementById('current-week-display');
            const timetableTitle = document.getElementById('timetable-title');
            const academicScheduleContent = document.getElementById('academic-schedule-content');
            const examDdaySection = document.getElementById('exam-dday-section');
            
            // 이벤트 리스너 재등록
            if (datePickerToggle) datePickerToggle.addEventListener('click', togglePanel);
            if (prevWeekButton) prevWeekButton.addEventListener('click', () => {
                if (userProfile) {
                    currentWeekMonday.setDate(currentWeekMonday.getDate() - 7);
                    fetchAndRenderWeeklyTimetable(currentWeekMonday, userProfile.sdSchulCode, userProfile.grade, userProfile.classNum, userProfile.atptOfcdcScCode, timetableContent, currentWeekDisplay);
                }
            });
            if (nextWeekButton) nextWeekButton.addEventListener('click', () => {
                if (userProfile) {
                    currentWeekMonday.setDate(currentWeekMonday.getDate() + 7);
                    fetchAndRenderWeeklyTimetable(currentWeekMonday, userProfile.sdSchulCode, userProfile.grade, userProfile.classNum, userProfile.atptOfcdcScCode, timetableContent, currentWeekDisplay);
                }
            });
            
            // onAuthStateChanged 리스너가 이미 실행되었는지 확인 후 콘텐츠 로드
            if (isAuthListenerReady) {
                if (userProfile) {
                    timetableTitle.textContent = `${userProfile.grade}학년 ${userProfile.classNum}반 시간표`;
                    const today = new Date();
                    const todayStr = formatDate(today);
                    
                    const dayOfWeek = today.getDay();
                    if (dayOfWeek === 0 || dayOfWeek === 6) {
                        mealCard.innerHTML = `<div class="p-4 text-center"><p class="text-gray-400">주말에는 급식 정보가 제공되지 않아요.</p></div>`;
                        timetableContent.innerHTML = `<div class="text-center text-gray-400 flex flex-col items-center justify-center min-h-[35rem] p-4"><p>주말에는 시간표 정보가 제공되지 않아요.</p></div>`;
                    } else {
                        fetchMealData(todayStr, userProfile.sdSchulCode, userProfile.atptOfcdcScCode, mealCard, dateDisplay);
                        fetchAndRenderWeeklyTimetable(currentWeekMonday, userProfile.sdSchulCode, userProfile.grade, userProfile.classNum, userProfile.atptOfcdcScCode, timetableContent, currentWeekDisplay);
                    }
                    
                    fetchAcademicSchedule(userProfile.sdSchulCode, userProfile.atptOfcdcScCode, academicScheduleContent);
                    fetchAndRenderExamDdays(userProfile.sdSchulCode, userProfile.atptOfcdcScCode, examDdaySection);
                } else {
                    showProfileSetupRequiredState(mealCard, timetableTitle, timetableContent, academicScheduleContent, examDdaySection);
                }
            } else {
                 showLoginRequiredState(mealCard, timetableTitle, timetableContent, academicScheduleContent, examDdaySection);
            }
        }
        
        // 브라우저 뒤로가기/앞으로가기 버튼 처리
        window.addEventListener('popstate', (event) => {
            const pagePath = event.state ? event.state.path : 'index.html';
            loadPageContent(pagePath);
        });

        // 내비게이션 버튼 클릭 이벤트 리스너 등록
        navLinks.forEach(link => {
            link.addEventListener('click', (event) => {
                event.preventDefault(); // 기본 페이지 이동 방지
                const pageUrl = event.currentTarget.getAttribute('href');
                loadPageContent(pageUrl);
            });
        });
        
        // 날짜 패널 토글
        const togglePanel = () => {
            datePickerPanel.classList.toggle('is-visible');
            renderCalendar(currentDate);
        };
        if (closePanelButton) closePanelButton.addEventListener('click', togglePanel);

        // --- 기존 기능 함수들 (수정 없음) ---
        function getMonday(d) {
            d = new Date(d);
            const day = d.getDay();
            const diff = d.getDate() - day + (day === 0 ? -6 : 1);
            return new Date(d.setDate(diff));
        }

        function formatDate(date) {
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            return `${year}${month}${day}`;
        }
        
        function formatDisplayDate(dateStr) {
            const year = dateStr.substring(0, 4);
            const month = dateStr.substring(4, 6);
            const day = dateStr.substring(6, 8);
            return `${year}.${month}.${day}`;
        }
        
        function calculateDday(targetDateStr) {
            const today = new Date();
            const targetDate = new Date(targetDateStr.substring(0, 4), parseInt(targetDateStr.substring(4, 6)) - 1, targetDateStr.substring(6, 8));
            
            today.setHours(0, 0, 0, 0);
            targetDate.setHours(0, 0, 0, 0);

            const diffTime = targetDate.getTime() - today.getTime();
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
            
            if (diffDays === 0) {
                return 'D-Day';
            } else if (diffDays > 0) {
                return `D-${diffDays}`;
            } else {
                return `D+${Math.abs(diffDays)}`;
            }
        }
        
        async function fetchMealData(mlsYmd, schoolCode, officeCode, mealCard, dateDisplay) {
            mealCard.innerHTML = `
                <div class="animate-pulse flex flex-col space-y-4">
                    <div class="h-6 bg-gray-700 rounded-lg w-2/4"></div>
                    <div class="h-4 bg-gray-700 rounded-lg w-1/4"></div>
                    <div class="h-4 bg-gray-700 rounded-lg w-full"></div>
                    <div class="h-4 bg-gray-700 rounded-lg w-5/6"></div>
                    <div class="h-4 bg-gray-700 rounded-lg w-4/6"></div>
                </div>
            `;
            const selectedDate = new Date(mlsYmd.substring(0, 4), parseInt(mlsYmd.substring(4, 6)) - 1, parseInt(mlsYmd.substring(6, 8)));
            const daysOfWeek = ['일', '월', '화', '수', '목', '금', '토'];
            const dayName = daysOfWeek[selectedDate.getDay()];
            dateDisplay.textContent = `${selectedDate.getFullYear()}년 ${selectedDate.getMonth() + 1}월 ${selectedDate.getDate()}일 (${dayName})`;
            
            const apiKey = '0c3b4def034a4eb5b75e830500a30898';
            const apiUrl = `https://open.neis.go.kr/hub/mealServiceDietInfo?KEY=${apiKey}&Type=json&pIndex=1&pSize=100&ATPT_OFCDC_SC_CODE=${officeCode}&SD_SCHUL_CODE=${schoolCode}&MLSV_YMD=${mlsYmd}`;

            try {
                const response = await fetch(apiUrl);
                const data = await response.json();
                
                if (data.RESULT && data.RESULT.CODE === 'INFO-200') {
                    mealCard.innerHTML = `<div class="p-4 text-center"><p class="text-gray-400">급식 정보가 없어요. 학사 일정을 확인해주세요!</p></div>`;
                    return;
                }
                
                if (data.mealServiceDietInfo && data.mealServiceDietInfo.length > 1 && data.mealServiceDietInfo[1].row) {
                    const mealInfo = data.mealServiceDietInfo[1].row;
                    const lunchMeal = mealInfo.find(meal => meal.MMEAL_SC_NM === '중식');
                    if (lunchMeal) {
                        const rawDishName = lunchMeal.DDISH_NM;
                        const cleanedDishName = rawDishName
                            .split('<br/>')
                            .filter(item => item.trim() !== '')
                            .map(item => item.replace(/\s*\(\d+\.?\d*\.?\d*\.?\d*\.?\d*\.?\d*\.?\d*\.?\d*\.?\d*\.?\d*\.?\d*\.?\d*\.?\d*\.?\d*\.?\d*\.?\d*\.?\d*\.?\d*\.?\d*\)?/g, '').trim())
                            .join('</li><li>');

                        const mealHtml = `
                            <div class="p-4 rounded-2xl w-full">
                                <h3 class="font-bold text-lg mb-2">${lunchMeal.MMEAL_SC_NM}</h3>
                                <p class="text-sm text-gray-400 mb-2">${lunchMeal.CAL_INFO || ''}</p>
                                <ul class="text-sm space-y-1 text-white">
                                    <li>${cleanedDishName}</li>
                                </ul>
                            </div>
                        `;
                        mealCard.innerHTML = mealHtml;
                    } else {
                        mealCard.innerHTML = `<div class="p-4 text-center"><p class="text-gray-400">선택한 날짜에 중식 정보가 없습니다.</p></div>`;
                    }
                } else {
                    mealCard.innerHTML = `<div class="p-4 text-center"><p class="text-red-500">급식 정보를 가져올 수 없습니다.</p></div>`;
                }
            } catch (error) {
                console.error('Failed to fetch meal data:', error);
                mealCard.innerHTML = `<div class="p-4 text-center"><p class="text-red-500">네트워크 오류가 발생했습니다. 잠시 후 다시 시도해주세요.</p></div>`;
            }
        }
        
        async function fetchAndRenderWeeklyTimetable(mondayDate, schoolCode, grade, classNm, officeCode, timetableContent, currentWeekDisplay) {
            timetableContent.innerHTML = `
                <div class="animate-pulse grid grid-cols-6 text-center text-sm font-medium timetable-grid overflow-x-auto no-scrollbar">
                    <div class="grid-cell-day rounded-tl-3xl min-w-[50px] md:min-w-0">교시</div>
                    <div class="grid-cell-day min-w-[100px] md:min-w-0">월</div>
                    <div class="grid-cell-day min-w-[100px] md:min-w-0">화</div>
                    <div class="grid-cell-day min-w-[100px] md:min-w-0">수</div>
                    <div class="grid-cell-day min-w-[100px] md:min-w-0">목</div>
                    <div class="grid-cell-day rounded-tr-3xl min-w-[100px] md:min-w-0">금</div>
                    <div class="grid-cell-hour min-w-[50px] md:min-w-0">1</div><div class="grid-cell min-w-[100px] md:min-w-0"><div class="h-4 bg-gray-700 rounded w-4/5"></div></div><div class="grid-cell min-w-[100px] md:min-w-0"><div class="h-4 bg-gray-700 rounded w-4/5"></div></div><div class="grid-cell min-w-[100px] md:min-w-0"><div class="h-4 bg-gray-700 rounded w-4/5"></div></div><div class="grid-cell min-w-[100px] md:min-w-0"><div class="h-4 bg-gray-700 rounded w-4/5"></div></div><div class="grid-cell min-w-[100px] md:min-w-0"><div class="h-4 bg-gray-700 rounded w-4/5"></div></div>
                    <div class="grid-cell-hour min-w-[50px] md:min-w-0">2</div><div class="grid-cell min-w-[100px] md:min-w-0"><div class="h-4 bg-gray-700 rounded w-4/5"></div></div><div class="grid-cell min-w-[100px] md:min-w-0"><div class="h-4 bg-gray-700 rounded w-4/5"></div></div><div class="grid-cell min-w-[100px] md:min-w-0"><div class="h-4 bg-gray-700 rounded w-4/5"></div></div><div class="grid-cell min-w-[100px] md:min-w-0"><div class="h-4 bg-gray-700 rounded w-4/5"></div></div><div class="grid-cell min-w-[100px] md:min-w-0"><div class="h-4 bg-gray-700 rounded w-4/5"></div></div>
                    <div class="grid-cell-hour min-w-[50px] md:min-w-0">3</div><div class="grid-cell min-w-[100px] md:min-w-0"><div class="h-4 bg-gray-700 rounded w-4/5"></div></div><div class="grid-cell min-w-[100px] md:min-w-0"><div class="h-4 bg-gray-700 rounded w-4/5"></div></div><div class="grid-cell min-w-[100px] md:min-w-0"><div class="h-4 bg-gray-700 rounded w-4/5"></div></div><div class="grid-cell min-w-[100px] md:min-w-0"><div class="h-4 bg-gray-700 rounded w-4/5"></div></div><div class="grid-cell min-w-[100px] md:min-w-0"><div class="h-4 bg-gray-700 rounded w-4/5"></div></div>
                    <div class="grid-cell-hour min-w-[50px] md:min-w-0">4</div><div class="grid-cell min-w-[100px] md:min-w-0"><div class="h-4 bg-gray-700 rounded w-4/5"></div></div><div class="grid-cell min-w-[100px] md:min-w-0"><div class="h-4 bg-gray-700 rounded w-4/5"></div></div><div class="grid-cell min-w-[100px] md:min-w-0"><div class="h-4 bg-gray-700 rounded w-4/5"></div></div><div class="grid-cell min-w-[100px] md:min-w-0"><div class="h-4 bg-gray-700 rounded w-4/5"></div></div><div class="grid-cell min-w-[100px] md:min-w-0"><div class="h-4 bg-gray-700 rounded w-4/5"></div></div>
                    <div class="grid-cell-hour min-w-[50px] md:min-w-0">5</div><div class="grid-cell min-w-[100px] md:min-w-0"><div class="h-4 bg-gray-700 rounded w-4/5"></div></div><div class="grid-cell min-w-[100px] md:min-w-0"><div class="h-4 bg-gray-700 rounded w-4/5"></div></div><div class="grid-cell min-w-[100px] md:min-w-0"><div class="h-4 bg-gray-700 rounded w-4/5"></div></div><div class="grid-cell min-w-[100px] md:min-w-0"><div class="h-4 bg-gray-700 rounded w-4/5"></div></div><div class="grid-cell min-w-[100px] md:min-w-0"><div class="h-4 bg-gray-700 rounded w-4/5"></div></div>
                    <div class="grid-cell-hour min-w-[50px] md:min-w-0">6</div><div class="grid-cell min-w-[100px] md:min-w-0"><div class="h-4 bg-gray-700 rounded w-4/5"></div></div><div class="grid-cell min-w-[100px] md:min-w-0"><div class="h-4 bg-gray-700 rounded w-4/5"></div></div><div class="grid-cell min-w-[100px] md:min-w-0"><div class="h-4 bg-gray-700 rounded w-4/5"></div></div><div class="grid-cell min-w-[100px] md:min-w-0"><div class="h-4 bg-gray-700 rounded w-4/5"></div></div><div class="grid-cell min-w-[100px] md:min-w-0"><div class="h-4 bg-gray-700 rounded w-4/5"></div></div>
                    <div class="grid-cell-hour min-w-[50px] md:min-w-0">7</div><div class="grid-cell min-w-[100px] md:min-w-0"><div class="h-4 bg-gray-700 rounded w-4/5"></div></div><div class="grid-cell min-w-[100px] md:min-w-0"><div class="h-4 bg-gray-700 rounded w-4/5"></div></div><div class="grid-cell min-w-[100px] md:min-w-0"><div class="h-4 bg-gray-700 rounded w-4/5"></div></div><div class="grid-cell min-w-[100px] md:min-w-0"><div class="h-4 bg-gray-700 rounded w-4/5"></div></div><div class="grid-cell min-w-[100px] md:min-w-0"><div class="h-4 bg-gray-700 rounded w-4/5"></div></div>
                </div>
            `;
            const tiFromYmd = formatDate(mondayDate);
            const fridayDate = new Date(mondayDate);
            fridayDate.setDate(mondayDate.getDate() + 4);
            const tiToYmd = formatDate(fridayDate);

            const fromYear = mondayDate.getFullYear();
            const fromMonth = mondayDate.getMonth() + 1;
            const fromDay = mondayDate.getDate();
            const toYear = fridayDate.getFullYear();
            const toMonth = fridayDate.getMonth() + 1;
            const toDay = fridayDate.getDate();
            currentWeekDisplay.textContent = `${fromYear}.${fromMonth}.${fromDay} ~ ${toYear}.${toMonth}.${toDay}`;

            const apiKey = '0c3b4def034a4eb5b75e830500a30898';
            const apiUrl = `https://open.neis.go.kr/hub/misTimetable?KEY=${apiKey}&Type=json&pIndex=1&pSize=100&ATPT_OFCDC_SC_CODE=${officeCode}&SD_SCHUL_CODE=${schoolCode}&GRADE=${grade}&CLASS_NM=${classNm}&TI_FROM_YMD=${tiFromYmd}&TI_TO_YMD=${tiToYmd}`;

            try {
                const response = await fetch(apiUrl);
                const data = await response.json();

                if (data.RESULT && data.RESULT.CODE === 'INFO-200') {
                    timetableContent.innerHTML = `<div class="text-center text-gray-400 flex flex-col items-center justify-center min-h-[35rem] p-4"><p class="font-medium text-lg text-white">시간표 정보가 없어요</p><p class="text-sm text-gray-400 mt-1">학사 일정 또는 주말/방학 기간인지 확인해주세요!</p></div>`;
                    return;
                }

                if (data.misTimetable && data.misTimetable.length > 1 && data.misTimetable[1].row) {
                    const timetableData = data.misTimetable[1].row;
                    renderWeeklyTimetable(timetableData, timetableContent);
                } else {
                    timetableContent.innerHTML = `<div class="text-center p-4"><p class="text-red-500">시간표 정보를 가져올 수 없습니다. API 응답 구조를 확인하세요.</p></div>`;
                }
            } catch (error) {
                console.error('Failed to fetch weekly timetable data:', error);
                timetableContent.innerHTML = `<div class="text-center p-4"><p class="text-red-500">네트워크 오류가 발생했습니다. 잠시 후 다시 시도해주세요.</p></div>`;
            }
        }
        
        function renderWeeklyTimetable(data, timetableContent) {
            data.sort((a, b) => parseInt(a.PERIO) - parseInt(b.PERIO));
            const days = ['월', '화', '수', '목', '금'];
            const timetableByDay = {};
            days.forEach(day => timetableByDay[day] = []);

            data.forEach(item => {
                const date = item.ALL_TI_YMD;
                const dayOfWeek = new Date(date.slice(0, 4), date.slice(4, 6) - 1, date.slice(6, 8)).getDay();
                if (dayOfWeek >= 1 && dayOfWeek <= 5) {
                    const dayName = days[dayOfWeek - 1];
                    timetableByDay[dayName].push(item);
                }
            });
            let gridHtml = `<div class="grid grid-cols-6 text-center text-sm font-medium timetable-grid overflow-x-auto no-scrollbar"><div class="grid-cell-day rounded-tl-3xl min-w-[50px] md:min-w-0">교시</div><div class="grid-cell-day min-w-[100px] md:min-w-0">월</div><div class="grid-cell-day min-w-[100px] md:min-w-0">화</div><div class="grid-cell-day min-w-[100px] md:min-w-0">수</div><div class="grid-cell-day min-w-[100px] md:min-w-0">목</div><div class="grid-cell-day rounded-tr-3xl min-w-[100px] md:min-w-0">금</div>`;
            const maxPeriods = Math.max(...Object.values(timetableByDay).map(dayData => dayData.length));
            for (let period = 1; period <= maxPeriods; period++) {
                gridHtml += `<div class="grid-cell-hour min-w-[50px] md:min-w-0">${period}</div>`;
                days.forEach((day, index) => {
                    const subject = timetableByDay[day].find(item => parseInt(item.PERIO) === period);
                    const isLastRow = period === maxPeriods;
                    const isLastCol = index === days.length - 1;
                    let cellClasses = 'grid-cell';
                    if (isLastRow) {
                        cellClasses += (index === 0) ? ' rounded-bl-3xl' : '';
                        cellClasses += (isLastCol) ? ' rounded-br-3xl' : '';
                    }
                    gridHtml += `<div class="${cellClasses} min-w-[100px] md:min-w-0">`;
                    if (subject) {
                        gridHtml += `<span class="font-medium text-sm">${subject.ITRT_CNTNT}</span>${subject.PRFN_GRNM ? `<span class="text-xs text-gray-400 mt-1">${subject.PRFN_GRNM}</span>` : ''}`;
                    } else {
                        gridHtml += `<span class="font-medium text-sm">-</span><span class="text-xs text-gray-400 mt-1">-</span>`;
                    }
                    gridHtml += `</div>`;
                });
            }
            gridHtml += `</div>`;
            timetableContent.innerHTML = gridHtml;
        }
        
        async function fetchAndRenderExamDdays(schoolCode, officeCode, examDdaySection) {
             examDdaySection.innerHTML = `
                <div class="animate-pulse p-4 bg-[--bg-secondary] rounded-2xl flex flex-col items-center justify-center h-24">
                    <div class="h-4 bg-gray-700 rounded w-3/4 mb-2"></div>
                    <div class="h-6 bg-gray-700 rounded w-1/2"></div>
                </div>
                <div class="animate-pulse p-4 bg-[--bg-secondary] rounded-2xl flex flex-col items-center justify-center h-24">
                    <div class="h-4 bg-gray-700 rounded w-3/4 mb-2"></div>
                    <div class="h-6 bg-gray-700 rounded w-1/2"></div>
                </div>
                <div class="animate-pulse p-4 bg-[--bg-secondary] rounded-2xl flex flex-col items-center justify-center h-24">
                    <div class="h-4 bg-gray-700 rounded w-3/4 mb-2"></div>
                    <div class="h-6 bg-gray-700 rounded w-1/2"></div>
                </div>
            `;
            const currentYear = new Date().getFullYear();
            const AA_FROM_YMD = `${currentYear}0101`;
            const AA_TO_YMD = `${currentYear}1231`;
            const apiKey = '0c3b4def034a4eb5b75e830500a30898';
            const apiUrl = `https://open.neis.go.kr/hub/SchoolSchedule?KEY=${apiKey}&Type=json&pIndex=1&pSize=100&ATPT_OFCDC_SC_CODE=${officeCode}&SD_SCHUL_CODE=${schoolCode}&AA_FROM_YMD=${AA_FROM_YMD}&AA_TO_YMD=${AA_TO_YMD}`;

            try {
                const response = await fetch(apiUrl);
                const data = await response.json();
                
                if (data.RESULT && data.RESULT.CODE === 'INFO-200') {
                    examDdaySection.innerHTML = `<div class="flex items-center justify-center col-span-2 sm:col-span-3 h-24"><p class="text-gray-400">시험 정보가 없습니다.</p></div>`;
                    return;
                }

                if (data.SchoolSchedule && data.SchoolSchedule.length > 1 && data.SchoolSchedule[1].row) {
                    const scheduleData = data.SchoolSchedule[1].row;
                    const today = new Date();
                    today.setHours(0, 0, 0, 0);
                    const exams = {'1학기 중간고사': null, '1학기 기말고사': null, '2학기 중간고사': null, '2학기 기말고사': null,};
                    scheduleData.sort((a, b) => a.AA_YMD.localeCompare(b.AA_YMD));
                    
                    scheduleData.forEach(event => {
                        const eventName = event.EVENT_NM;
                        const eventDate = new Date(event.AA_YMD.slice(0, 4), parseInt(event.AA_YMD.slice(4, 6)) - 1, event.AA_YMD.slice(6, 8));
                        eventDate.setHours(0, 0, 0, 0);

                        if (eventDate >= today) {
                            if (eventName.includes('1학기') && eventName.includes('중간') && eventName.includes('고사') && !exams['1학기 중간고사']) { exams['1학기 중간고사'] = event.AA_YMD; }
                            else if (eventName.includes('1학기') && eventName.includes('기말') && eventName.includes('고사') && !exams['1학기 기말고사']) { exams['1학기 기말고사'] = event.AA_YMD; }
                            else if (eventName.includes('2학기') && eventName.includes('중간') && eventName.includes('고사') && !exams['2학기 중간고사']) { exams['2학기 중간고사'] = event.AA_YMD; }
                            else if (eventName.includes('2학기') && eventName.includes('기말') && eventName.includes('고사') && !exams['2학기 기말고사']) { exams['2학기 기말고사'] = event.AA_YMD; }
                        }
                    });
                    let examHtml = '';
                    let foundExam = false;
                    for (const examName in exams) {
                        const examDateStr = exams[examName];
                        if (examDateStr) {
                            foundExam = true;
                            const dDay = calculateDday(examDateStr);
                            let statusText = dDay;
                            let statusColor = 'text-[--color-blue]';
                            if (dDay.startsWith('D-') && parseInt(dDay.split('-')[1]) <= 7) { statusColor = 'text-red-500'; }
                            if (!dDay.startsWith('D+')) {
                                examHtml += `<div class="p-4 bg-[--bg-secondary] rounded-2xl flex flex-col items-center justify-center h-24"><p class="font-medium">${examName}</p><p class="font-bold text-2xl ${statusColor}">${statusText}</p></div>`;
                            }
                        }
                    }
                    if (foundExam && examHtml !== '') {
                        examDdaySection.innerHTML = examHtml;
                    } else {
                        examDdaySection.innerHTML = `<div class="flex items-center justify-center col-span-2 sm:col-span-3 h-24"><p class="text-gray-400">예정된 시험 정보가 없습니다.</p></div>`;
                    }
                } else {
                    examDdaySection.innerHTML = `<div class="flex items-center justify-center col-span-2 sm:col-span-3 h-24"><p class="text-red-500">시험 정보를 가져올 수 없습니다.</p></div>`;
                }
            } catch (error) {
                console.error('Failed to fetch exam D-day data:', error);
                examDdaySection.innerHTML = `<div class="flex items-center justify-center col-span-2 sm:col-span-3 h-24"><p class="text-red-500">네트워크 오류가 발생했습니다. 잠시 후 다시 시도해주세요.</p></div>`;
            }
        }
        
        async function fetchAcademicSchedule(schoolCode, officeCode, academicScheduleContent) {
            academicScheduleContent.innerHTML = `<div class="animate-pulse space-y-4"><div class="flex items-center justify-between p-4 rounded-2xl bg-[--bg-secondary]"><div class="h-4 bg-gray-700 rounded w-1/3"></div><div class="h-4 bg-gray-700 rounded w-1/4"></div></div><div class="flex items-center justify-between p-4 rounded-2xl bg-[--bg-secondary]"><div class="h-4 bg-gray-700 rounded w-2/3"></div><div class="h-4 bg-gray-700 rounded w-1/4"></div></div></div>`;
            const today = new Date();
            const year = today.getFullYear();
            const month = today.getMonth() + 1;
            const AA_FROM_YMD = `${year}${String(month).padStart(2, '0')}01`;
            const AA_TO_YMD = `${year}${String(month).padStart(2, '0')}${new Date(year, month, 0).getDate()}`;
            const apiKey = '0c3b4def034a4eb5b75e830500a30898';
            const apiUrl = `https://open.neis.go.kr/hub/SchoolSchedule?KEY=${apiKey}&Type=json&pIndex=1&pSize=100&ATPT_OFCDC_SC_CODE=${officeCode}&SD_SCHUL_CODE=${schoolCode}&AA_FROM_YMD=${AA_FROM_YMD}&AA_TO_YMD=${AA_TO_YMD}`;

            try {
                const response = await fetch(apiUrl);
                const data = await response.json();
                if (data.RESULT && data.RESULT.CODE === 'INFO-200') {
                    academicScheduleContent.innerHTML = `<div class="flex items-center justify-center p-4"><p class="text-gray-400">학사일정 정보가 없습니다.</p></div>`;
                    return;
                }
                if (data.SchoolSchedule && data.SchoolSchedule.length > 1 && data.SchoolSchedule[1].row) {
                    const scheduleData = data.SchoolSchedule[1].row;
                    const filteredData = scheduleData.filter(event => event.EVENT_NM !== '토요휴업일');
                    const eventCounts = new Map();
                    filteredData.forEach(event => { eventCounts.set(event.EVENT_NM, (eventCounts.get(event.EVENT_NM) || 0) + 1); });
                    const displayedEvents = new Set();
                    filteredData.sort((a, b) => a.AA_YMD.localeCompare(b.AA_YMD));
                    academicScheduleContent.innerHTML = '';
                    if (filteredData.length === 0) {
                        academicScheduleContent.innerHTML = `<div class="flex items-center justify-center p-4"><p class="text-gray-400">학사일정 정보가 없습니다.</p></div>`;
                        return;
                    }
                    filteredData.forEach(event => {
                        const eventName = event.EVENT_NM;
                        const isDuplicate = eventCounts.get(eventName) > 1;
                        if (!isDuplicate || !displayedEvents.has(eventName)) {
                            const eventDate = isDuplicate ? '' : formatDisplayDate(event.AA_YMD);
                            const eventHtml = `<div class="flex items-center justify-between"><div class="flex items-center"><span class="text-xs text-white rounded-full px-2 py-1 mr-2 bg-[--bg-hover]">${event.SCHUL_EVENT_NM || '일반'}</span><span class="font-medium">${eventName}</span></div><span class="text-sm text-gray-400">${eventDate}</span></div>`;
                            academicScheduleContent.innerHTML += eventHtml;
                            displayedEvents.add(eventName);
                        }
                    });
                } else {
                    academicScheduleContent.innerHTML = `<div class="p-4"><p class="text-red-500">학사일정 정보를 가져올 수 없습니다.</p></div>`;
                }
            } catch (error) {
                console.error('Failed to fetch academic schedule data:', error);
                academicScheduleContent.innerHTML = `<div class="p-4"><p class="text-red-500">네트워크 오류가 발생했습니다. 잠시 후 다시 시도해주세요.</p></div>`;
            }
        }
        
        function renderCalendar(date) {
            const year = date.getFullYear();
            const month = date.getMonth();
            const today = new Date();
            const todayYear = today.getFullYear();
            const todayMonth = today.getMonth();
            const todayDay = today.getDate();
            const firstDayOfMonth = new Date(year, month, 1);
            const lastDayOfMonth = new Date(year, month + 1, 0);
            const daysInMonth = lastDayOfMonth.getDate();
            const firstDayOfWeek = firstDayOfMonth.getDay();
            currentDate = date;
            let calendarHtml = `<div class="flex justify-between items-center mb-4"><button id="prev-month-button" class="p-2 rounded-full hover:bg-[--bg-hover]"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-chevron-left"><path d="m15 18-6-6 6-6"/></svg></button><span id="current-month-year" class="font-bold text-lg">${year}년 ${month + 1}월</span><button id="next-month-button" class="p-2 rounded-full hover:bg-[--bg-hover]"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-chevron-right"><path d="m9 18 6-6-6-6"/></svg></button></div><div class="grid grid-cols-7 text-center text-sm font-medium text-gray-400 mb-2"><div>일</div><div>월</div><div>화</div><div>수</div><div>목</div><div>금</div><div>토</div></div><div id="calendar-days-grid" class="grid grid-cols-7 text-center">`;
            for (let i = 0; i < firstDayOfWeek; i++) { calendarHtml += `<div class="p-2"></div>`; }
            for (let day = 1; day <= daysInMonth; day++) {
                const isToday = todayYear === year && todayMonth === month && todayDay === day;
                const dateStr = `${year}${String(month + 1).padStart(2, '0')}${String(day).padStart(2, '0')}`;
                calendarHtml += `<button class="p-2 rounded-full font-medium ${isToday ? 'bg-[--color-blue] text-white' : 'hover:bg-[--bg-hover]'}" data-date="${dateStr}">${day}</button>`;
            }
            calendarHtml += `</div>`;
            calendarContainer.innerHTML = calendarHtml;
            document.getElementById('prev-month-button').addEventListener('click', () => {
                const prevMonth = new Date(currentDate.getFullYear(), currentDate.getMonth() - 1, 1);
                renderCalendar(prevMonth);
            });
            document.getElementById('next-month-button').addEventListener('click', () => {
                const nextMonth = new Date(currentDate.getFullYear(), currentDate.getMonth() + 1, 1);
                renderCalendar(nextMonth);
            });
            document.querySelectorAll('#calendar-days-grid button').forEach(button => {
                button.addEventListener('click', (event) => {
                    const selectedDate = event.target.dataset.date;
                    handleDateClick(selectedDate);
                });
            });
        }
        
        function handleDateClick(dateStr) {
            const mealCard = document.getElementById('meal-card');
            const dateDisplay = document.getElementById('date-display');
            if (userProfile) {
                fetchMealData(dateStr, userProfile.sdSchulCode, userProfile.atptOfcdcScCode, mealCard, dateDisplay);
            } else {
                mealCard.innerHTML = `<div class="p-4 text-center"><p class="text-gray-400">로그인하여 급식 정보를 확인하세요.</p></div>`;
            }
            datePickerPanel.classList.remove('is-visible');
        }

        function showLoginRequiredState(mealCard, timetableTitle, timetableContent, academicScheduleContent, examDdaySection) {
            timetableTitle.textContent = `시간표`;
            mealCard.innerHTML = `<div class="text-center p-4"><p class="font-medium text-lg">로그인하여 맞춤형 정보를 확인하세요</p><p class="text-sm text-gray-400 mt-1">로그인 버튼을 눌러주세요!</p></div>`;
            timetableContent.innerHTML = `<div class="text-center text-gray-400 flex flex-col items-center justify-center min-h-[35rem] p-4"><p>로그인하여 시간표를 확인하세요.</p></div>`;
            academicScheduleContent.innerHTML = `<div class="flex items-center justify-center p-4"><p class="text-gray-400">로그인하여 학사일정을 확인하세요.</p></div>`;
            examDdaySection.innerHTML = `<div class="flex items-center justify-center col-span-2 sm:col-span-3 h-24"><p class="text-gray-400">로그인하여 시험 일정을 확인하세요.</p></div>`;
        }

        function showProfileSetupRequiredState(mealCard, timetableTitle, timetableContent, academicScheduleContent, examDdaySection) {
             timetableTitle.textContent = `시간표`;
             mealCard.innerHTML = `<div class="text-center p-4"><p class="font-medium text-lg">프로필 설정을 완료해주세요</p><p class="text-sm text-gray-400 mt-1">학교, 학년, 반 정보를 입력해야 급식 및 시간표를 확인할 수 있어요.</p></div>`;
             timetableContent.innerHTML = `<div class="text-center text-gray-400 flex flex-col items-center justify-center min-h-[35rem] p-4"><p>프로필 정보를 불러올 수 없습니다.</p><p>프로필 설정을 완료해주세요.</p></div>`;
             academicScheduleContent.innerHTML = `<div class="flex items-center justify-center p-4"><p class="text-gray-400">프로필 설정을 완료해야 학사일정을 확인할 수 있어요.</p></div>`;
             examDdaySection.innerHTML = `<div class="flex items-center justify-center col-span-2 sm:col-span-3 h-24"><p class="text-gray-400">프로필 설정을 완료해야 시험 일정을 확인할 수 있어요.</p></div>`;
        }
    </script>
</body>
</html>
