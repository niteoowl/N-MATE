<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>YouTube Ultimate Fixed</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@24,300,0,0" />
    
    <style>
        /* --- 1. Reset & Layout --- */
        :root { --bg: #0f0f0f; --header: 48px; --nav: 50px; }
        * { margin:0; padding:0; box-sizing:border-box; font-family:'Roboto', sans-serif; -webkit-tap-highlight-color:transparent; }
        
        html, body { 
            background: var(--bg); color: #fff; 
            width: 100%; height: 100dvh; /* 모바일 주소창 대응 */
            overflow: hidden; 
        }

        button { background:none; border:none; color:#fff; cursor:pointer; }
        .material-symbols-outlined { vertical-align:middle; font-size:24px; }
        .filled { font-variation-settings:'FILL' 1; }

        /* --- 2. Pages --- */
        .page {
            position: absolute; inset: 0; /* top,left,right,bottom: 0 */
            background: var(--bg); 
            transform: translate3d(100%, 0, 0); 
            transition: transform 0.25s cubic-bezier(0.2, 0, 0, 1);
            z-index: 10; display: flex; flex-direction: column;
        }
        #page-home { transform: translate3d(0, 0, 0); z-index: 5; }
        #page-search { z-index: 20; }
        #page-search.active { transform: translate3d(0, 0, 0); }
        #page-library { z-index: 15; }
        #page-library.active { transform: translate3d(0, 0, 0); }

        /* --- 3. Watch Page (Player) --- */
        #page-watch { 
            z-index: 50; background: #000;
            transform: translate3d(0, 100%, 0); 
            transition: transform 0.3s cubic-bezier(0.2, 0, 0, 1);
        }
        #page-watch.active { transform: translate3d(0, 0, 0); }

        /* 미니 플레이어 스타일 */
        #page-watch.mini {
            transform: translate3d(0, 0, 0) !important;
            top: auto !important; bottom: var(--nav); 
            height: 60px; width: 100%;
            background: #212121; border-top: 1px solid #333;
            display: flex; flex-direction: row; 
            z-index: 95;
        }
        /* 미니 모드일 때 숨김 요소 */
        #page-watch.mini .watch-header,
        #page-watch.mini .watch-actions,
        #page-watch.mini .watch-scroll { display: none !important; }

        /* 미니 모드일 때 플레이어 크기 */
        #page-watch.mini .player-container {
            width: 106px; height: 100%; padding-bottom: 0;
            pointer-events: none; /* 미니일땐 터치 통과 */
        }
        #page-watch.mini .mini-ctrl { display: flex; }

        .mini-ctrl { 
            display: none; flex: 1; align-items: center; 
            justify-content: space-between; padding: 0 12px; 
        }

        /* --- 4. Player Container --- */
        .player-container {
            width: 100%; background: #000; position: relative;
            /* 16:9 Aspect Ratio */
            height: 0; padding-bottom: 56.25%; 
            transition: all 0.3s;
        }
        /* CSS 전체화면 */
        .player-container.css-fullscreen {
            position: fixed !important; top: 0; left: 0; 
            width: 100% !important; height: 100% !important; 
            padding-bottom: 0 !important; z-index: 9999;
        }
        #yt-player { position: absolute; top: 0; left: 0; width: 100%; height: 100%; }

        /* --- 5. UI Elements --- */
        .header {
            height: var(--header); display: flex; align-items: center; 
            justify-content: space-between; padding: 0 12px;
            border-bottom: 1px solid #222; background: rgba(15,15,15,0.98);
        }
        .scroll-area {
            flex: 1; overflow-y: auto; -webkit-overflow-scrolling: touch;
            position: relative;
        }
        .btm-nav {
            height: var(--nav); border-top: 1px solid #222; 
            display: flex; justify-content: space-around; align-items: center;
            background: #0f0f0f;
        }
        
        .video-item { margin-bottom: 15px; cursor: pointer; }
        .thumb { width: 100%; aspect-ratio: 16/9; background: #333; }
        .thumb img { width: 100%; height: 100%; object-fit: cover; display: block; }
        .info { display: flex; padding: 10px 12px 0; }
        .avatar { width: 36px; height: 36px; border-radius: 50%; background: #444; margin-right: 10px; overflow: hidden; }
        .avatar img { width:100%; height:100%; object-fit:cover; }
        .txt { flex: 1; }
        .ti { font-size: 14px; font-weight: 500; line-height: 1.3; margin-bottom: 3px; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; }
        .meta { font-size: 12px; color: #aaa; }

        /* 로딩/에러 메시지 */
        .msg-box { padding: 40px 20px; text-align: center; color: #aaa; font-size: 14px; }
        
        /* 모달 */
        .modal { position: fixed; inset: 0; background: rgba(0,0,0,0.7); display: none; z-index: 200; justify-content: center; align-items: center; }
        .modal-inner { background: #212121; width: 80%; padding: 20px; border-radius: 12px; }
    </style>
</head>
<body>

    <!-- 유튜브 API -->
    <script src="https://www.youtube.com/iframe_api"></script>

    <!-- [1] 홈 -->
    <div id="page-home" class="page">
        <div class="header">
            <div style="display:flex; align-items:center; gap:5px;" onclick="location.reload()">
                <span class="material-symbols-outlined filled" style="color:red;">play_circle</span>
                <span style="font-weight:700; font-size:20px;">YouTube</span>
            </div>
            <div style="display:flex; gap:15px;">
                <span class="material-symbols-outlined">cast</span>
                <span class="material-symbols-outlined">notifications</span>
                <button onclick="openSearch()"><span class="material-symbols-outlined">search</span></button>
            </div>
        </div>
        <!-- 칩 -->
        <div style="display:flex; gap:8px; padding:8px 12px; overflow-x:auto; background:var(--bg); border-bottom:1px solid #222; flex-shrink:0;">
            <div style="background:#fff; color:#000; padding:6px 12px; border-radius:8px; font-size:13px; white-space:nowrap;">전체</div>
            <div style="background:#222; color:#fff; padding:6px 12px; border-radius:8px; font-size:13px; white-space:nowrap;">음악</div>
            <div style="background:#222; color:#fff; padding:6px 12px; border-radius:8px; font-size:13px; white-space:nowrap;">게임</div>
        </div>
        <!-- 리스트 -->
        <div id="list-home" class="scroll-area"></div>
        <!-- 하단바 -->
        <div class="btm-nav">
            <div style="text-align:center; opacity:1;"><span class="material-symbols-outlined filled">home</span><br><span style="font-size:10px;">홈</span></div>
            <div style="text-align:center; opacity:0.6;"><span class="material-symbols-outlined">slow_motion_video</span><br><span style="font-size:10px;">Shorts</span></div>
            <div style="text-align:center; opacity:1;"><span class="material-symbols-outlined" style="font-size:32px;">add_circle</span></div>
            <div style="text-align:center; opacity:0.6;"><span class="material-symbols-outlined">subscriptions</span><br><span style="font-size:10px;">구독</span></div>
            <div style="text-align:center; opacity:0.6;" onclick="openLibrary()"><span class="material-symbols-outlined">video_library</span><br><span style="font-size:10px;">보관함</span></div>
        </div>
    </div>

    <!-- [2] 검색 -->
    <div id="page-search" class="page">
        <div class="header">
            <button onclick="history.back()"><span class="material-symbols-outlined">arrow_back</span></button>
            <input type="text" id="inp-search" placeholder="검색" style="flex:1; background:#121212; border:none; color:#fff; padding:8px 15px; border-radius:20px; margin:0 10px; font-size:16px;">
            <button onclick="doSearch()"><span class="material-symbols-outlined">search</span></button>
        </div>
        <div id="list-search" class="scroll-area"></div>
    </div>

    <!-- [3] 보관함 -->
    <div id="page-library" class="page">
        <div class="header">
            <span style="font-size:18px; font-weight:700;">보관함</span>
            <button onclick="goHomeForce()"><span class="material-symbols-outlined">close</span></button>
        </div>
        <div class="scroll-area" style="padding:15px;">
            <h3 style="margin-bottom:10px;">내 재생목록</h3>
            <div id="list-library"></div>
        </div>
    </div>

    <!-- [4] 재생 페이지 (제스처 적용) -->
    <div id="page-watch" class="page">
        <!-- 헤더 바 (여기를 쓸어내리면 미니화) -->
        <div class="watch-header" id="gesture-header" style="height:50px; background:#000; display:flex; align-items:center; padding:0 10px; flex-shrink:0;">
            <button onclick="minimizePlayer()"><span class="material-symbols-outlined">keyboard_arrow_down</span></button>
        </div>

        <!-- 플레이어 -->
        <div id="player-container" class="player-container">
            <div id="yt-player"></div>
        </div>

        <!-- 미니 컨트롤 (미니일 때만 보임, 누르면 복원) -->
        <div class="mini-ctrl" onclick="restorePlayer()">
            <div style="flex:1; overflow:hidden;">
                <div id="mini-title" style="font-size:13px; font-weight:bold; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">제목</div>
                <div id="mini-ch" style="font-size:11px; color:#aaa;">채널</div>
            </div>
            <button onclick="togglePlay(event)"><span id="mini-play-btn" class="material-symbols-outlined">pause</span></button>
            <button onclick="closePlayer(event)"><span class="material-symbols-outlined">close</span></button>
        </div>

        <!-- 액션 바 -->
        <div class="watch-actions" style="padding:10px; background:#1e1e1e; display:flex; justify-content:space-around; align-items:center; flex-shrink:0;">
            <div onclick="openPlModal()" style="display:flex; flex-direction:column; align-items:center; font-size:10px; gap:3px;">
                <span class="material-symbols-outlined">playlist_add</span>저장
            </div>
            <div style="display:flex; flex-direction:column; align-items:center; font-size:10px; gap:3px;">
                <span class="material-symbols-outlined">thumb_up</span>좋아요
            </div>
            <div style="display:flex; flex-direction:column; align-items:center; font-size:10px; gap:3px;">
                <span class="material-symbols-outlined">share</span>공유
            </div>
        </div>

        <!-- 정보 및 추천 (여기를 쓸어내려도 미니화, 쓸어올리면 전체화면) -->
        <div id="watch-info" class="watch-scroll scroll-area" style="padding:15px;">
            <h3 id="wp-title" style="font-size:18px; line-height:1.3;">제목</h3>
            <div id="wp-meta" style="font-size:12px; color:#aaa; margin:5px 0 15px;">조회수 • 시간</div>
            
            <div style="display:flex; align-items:center; padding:10px 0; border-top:1px solid #222; border-bottom:1px solid #222;">
                <img id="wp-avatar" style="width:36px; height:36px; border-radius:50%; background:#333;">
                <div style="flex:1; margin-left:10px; font-weight:bold;" id="wp-ch">채널</div>
                <button style="background:#fff; color:#000; padding:6px 14px; border-radius:18px; font-size:12px; font-weight:600;">구독</button>
            </div>

            <div style="margin-top:20px; font-weight:bold; margin-bottom:10px;">추천 동영상</div>
            <div id="list-related"></div>
        </div>
    </div>

    <!-- 모달 -->
    <div id="pl-modal" class="modal" onclick="if(event.target===this) this.style.display='none'">
        <div class="modal-inner">
            <h3>재생목록 저장</h3>
            <div id="pl-list-modal" style="margin:15px 0;"></div>
            <input id="new-pl" type="text" placeholder="새 목록 이름" style="width:100%; padding:10px; background:#333; border:none; color:#fff; margin-bottom:10px;">
            <div style="text-align:right;"><button onclick="createPl()" style="color:#3ea6ff;">만들기</button></div>
        </div>
    </div>

    <script>
        // API 키 (차단 시 Mock Data 자동 전환)
        const API_KEY = 'AIzaSyD9gpmEbUyP9h9Rm3nayK7PLYek5Ja7B38';
        
        let player;
        let videoCache = JSON.parse(localStorage.getItem('yt_cache')) || {};
        let playlists = JSON.parse(localStorage.getItem('yt_pl')) || {};
        let curVid = null;

        // 제스처 변수
        let startY = 0;

        window.onload = () => {
            history.replaceState({page:'home'},'','');
            
            // 검색 엔터
            document.getElementById('inp-search').addEventListener('keyup', e=>{ if(e.key==='Enter') doSearch(); });

            // 제스처 (헤더 & 정보창에 적용 -> 비디오 위는 터치 가능하게!)
            const attachSwipe = (id) => {
                const el = document.getElementById(id);
                el.addEventListener('touchstart', e => startY=e.touches[0].clientY, {passive:true});
                el.addEventListener('touchend', e => handleSwipe(startY - e.changedTouches[0].clientY), {passive:true});
            };
            attachSwipe('gesture-header');
            attachSwipe('watch-info');

            // 초기 로딩 (실패시 Mock)
            loadData('popular');
        };

        function handleSwipe(diff) {
            const wp = document.getElementById('page-watch');
            const pc = document.getElementById('player-container');
            
            if (diff > 60) { // 위로 쓸기 (전체화면)
                if (wp.classList.contains('mini')) restorePlayer();
                else pc.classList.add('css-fullscreen');
            } else if (diff < -60) { // 아래로 쓸기 (미니화/해제)
                if (pc.classList.contains('css-fullscreen')) pc.classList.remove('css-fullscreen');
                else minimizePlayer();
            }
        }

        async function loadData(type, query) {
            const targets = { popular:'list-home', search:'list-search', related:'list-related' };
            const div = document.getElementById(targets[type]);
            div.innerHTML = '<div class="msg-box">로딩 중...</div>';

            let url = `https://www.googleapis.com/youtube/v3/videos?part=snippet&chart=mostPopular&maxResults=10&regionCode=KR&key=${API_KEY}`;
            if(type==='search') url = `https://www.googleapis.com/youtube/v3/search?part=snippet&q=${query}&type=video&maxResults=10&key=${API_KEY}`;
            if(type==='related') url = `https://www.googleapis.com/youtube/v3/search?part=snippet&channelId=${query}&type=video&maxResults=10&key=${API_KEY}`; // API 아끼기 위해 채널검색으로 대체

            try {
                const res = await fetch(url);
                if(!res.ok) throw new Error();
                const data = await res.json();
                div.innerHTML = '';
                render(data.items, div);
            } catch(e) {
                console.log("API Fail -> Mock Data");
                div.innerHTML = '';
                renderMock(div, type);
            }
        }

        function render(items, container) {
            items.forEach(item => {
                const id = item.id.videoId || item.id;
                if(!id || typeof id!=='string') return;
                const s = item.snippet;
                const info = { id, title:s.title, ch:s.channelTitle, img:s.thumbnails.medium.url, desc:s.description };
                
                videoCache[id] = info;
                localStorage.setItem('yt_cache', JSON.stringify(videoCache));
                
                const el = document.createElement('div');
                el.className = 'video-item';
                el.innerHTML = `
                    <div class="thumb"><img src="${info.img}"></div>
                    <div class="info">
                        <div class="avatar"><img src="https://ui-avatars.com/api/?name=${info.ch}"></div>
                        <div class="txt"><div class="ti">${info.title}</div><div class="meta">${info.ch}</div></div>
                    </div>
                `;
                el.onclick = () => openWatch(id);
                container.appendChild(el);
            });
        }

        function renderMock(container, type) {
            if(type==='search') {
                const notice = document.createElement('div');
                notice.className='msg-box'; notice.innerText = "API 할당량 초과됨. 데모 영상이 표시됩니다.";
                container.appendChild(notice);
            }
            const mocks = [
                {id:'jNQXAC9IVRw', t:'Me at the zoo', c:'jawed'},
                {id:'kJQP7kiw5Fk', t:'Despacito', c:'Luis Fonsi'},
                {id:'JGwWNGJdvx8', t:'Shape of You', c:'Ed Sheeran'},
                {id:'9bZkp7q19f0', t:'Gangnam Style', c:'Psy'}
            ];
            mocks.forEach(m => {
                const info = { id:m.id, title:m.t, ch:m.c, img:`https://img.youtube.com/vi/${m.id}/mqdefault.jpg` };
                videoCache[m.id] = info;
                const el = document.createElement('div');
                el.className = 'video-item';
                el.innerHTML = `
                    <div class="thumb"><img src="${info.img}"></div>
                    <div class="info"><div class="avatar"></div><div class="txt"><div class="ti">${m.t}</div><div class="meta">${m.c} • Demo</div></div></div>
                `;
                el.onclick = () => openWatch(m.id);
                container.appendChild(el);
            });
        }

        function openWatch(id) {
            const info = videoCache[id];
            curVid = info;
            const wp = document.getElementById('page-watch');
            wp.classList.remove('mini');
            wp.classList.add('active');
            history.pushState({page:'watch'},'','#watch');

            document.getElementById('wp-title').innerText = info.title;
            document.getElementById('wp-ch').innerText = info.ch;
            document.getElementById('wp-avatar').src = `https://ui-avatars.com/api/?name=${info.ch}`;
            document.getElementById('mini-title').innerText = info.title;
            document.getElementById('mini-ch').innerText = info.ch;

            if(player && player.loadVideoById) player.loadVideoById(id);
            else {
                new YT.Player('yt-player', {
                    height: '100%', width: '100%', videoId: id,
                    playerVars: { 'playsinline':1, 'controls':1, 'rel':0 },
                    events: { 
                        'onReady': e=>e.target.playVideo(),
                        'onStateChange': e => document.getElementById('mini-play-btn').innerText = e.data===1?'pause':'play_arrow'
                    }
                });
            }
            loadData('related', 'UC_x5XG1OV2P6uZZ5FSM9Ttw'); // 데모용 채널ID
        }

        // 제스처 & UI
        function minimizePlayer() {
            document.getElementById('page-watch').classList.add('mini');
            document.getElementById('player-container').classList.remove('css-fullscreen');
        }
        function restorePlayer() { document.getElementById('page-watch').classList.remove('mini'); }
        function closePlayer(e) { 
            e.stopPropagation(); 
            const wp = document.getElementById('page-watch');
            wp.classList.remove('active', 'mini');
            if(player) player.stopVideo();
        }
        function togglePlay(e) {
            e.stopPropagation();
            if(player) player.getPlayerState()===1 ? player.pauseVideo() : player.playVideo();
        }
        function toggleFs() { document.getElementById('player-container').classList.toggle('css-fullscreen'); }

        function openSearch() {
            document.getElementById('page-search').classList.add('active');
            setTimeout(()=>document.getElementById('inp-search').focus(), 300);
        }
        function doSearch() {
            const q = document.getElementById('inp-search').value;
            if(q) { document.getElementById('inp-search').blur(); loadData('search', q); }
        }
        function goHomeForce() {
            if(document.getElementById('page-watch').classList.contains('active')) minimizePlayer();
            document.getElementById('page-search').classList.remove('active');
            document.getElementById('page-library').classList.remove('active');
        }

        /* 보관함 로직 */
        function openLibrary() {
            goHomeForce();
            document.getElementById('page-library').classList.add('active');
            const d = document.getElementById('list-library'); d.innerHTML='';
            if(Object.keys(playlists).length===0) d.innerHTML='<div class="msg-box">저장된 목록 없음</div>';
            for(let k in playlists) {
                const row = document.createElement('div');
                row.style.cssText="padding:15px; border-bottom:1px solid #333; cursor:pointer;";
                row.innerText = `${k} (${playlists[k].length}개)`;
                row.onclick=()=> { if(playlists[k].length) openWatch(playlists[k][0]); };
                d.appendChild(row);
            }
        }
        function openPlModal() { document.getElementById('pl-modal').style.display='flex'; renderPlModal(); }
        function renderPlModal() {
            const d = document.getElementById('pl-list-modal'); d.innerHTML='';
            for(let k in playlists) {
                const r = document.createElement('div'); r.innerText=k;
                r.style.cssText="padding:10px; cursor:pointer;";
                r.onclick=()=>addToPl(k);
                d.appendChild(r);
            }
        }
        function createPl() {
            const n = document.getElementById('new-pl').value;
            if(n) { playlists[n]=[]; localStorage.setItem('yt_pl',JSON.stringify(playlists)); renderPlModal(); }
        }
        function addToPl(n) {
            if(curVid && !playlists[n].includes(curVid.id)) {
                playlists[n].push(curVid.id);
                localStorage.setItem('yt_pl',JSON.stringify(playlists));
                alert('저장됨');
                document.getElementById('pl-modal').style.display='none';
            }
        }

        window.onpopstate = function(e) {
            const s = e.state || {page:'home'};
            const wp = document.getElementById('page-watch');
            if(s.page!=='watch') {
                if(wp.classList.contains('active')) minimizePlayer();
                document.getElementById('page-search').classList.remove('active');
                document.getElementById('page-library').classList.remove('active');
            } else {
                wp.classList.remove('mini'); wp.classList.add('active');
            }
        }
    </script>
</body>
</html>
