<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>부산남중학교 N-MATE - 캘린더</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Inter 및 Noto Sans KR 폰트 설정 -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Noto+Sans+KR:wght@400;700&display=swap" rel="stylesheet">
    <!-- Lucide Icons CDN -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <!-- Firebase SDK CDN (v8.10.1로 유지) -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <style>
        /* Body styles for overall layout */
        body {
            font-family: 'Noto Sans KR', 'Inter', sans-serif; /* Noto Sans KR 우선 적용 */
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            display: flex;
            flex-direction: column;
            min-height: 100vh;
            background-color: #ffffff; /* Light gray background */
        }

        /* Main content container for centering and max-width */
        .main-content-container {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            align-items: flex-start; /* Aligns content to the left */
            max-width: 36rem; /* Max width for content (consistent) */
            margin-left: auto;
            margin-right: auto;
            width: 100%;
            position: relative; /* For absolute positioning of dropdown menu */
            padding-bottom: 70px; /* Space for fixed bottom navigation */
        }

        /* Dropdown menu styles (for account) */
        .dropdown-menu {
            position: absolute;
            background-color: white;
            border-radius: 0.5rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            padding-top: 0.25rem;
            padding-bottom: 0.25rem;
            min-width: 8rem;
            right: 0;
            top: calc(100% + 0.5rem);
            z-index: 20;
        }

        .dropdown-menu button {
            width: 100%;
            text-align: left;
            padding: 0.5rem 1rem;
            font-size: 0.875rem;
            color: #374151;
            transition: background-color 0.2s ease;
        }

        .dropdown-menu button:hover {
            background-color: #f3f4f6;
        }

        /* Bottom Navigation Bar Styles */
        .nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 0.5rem; /* p-2 */
            border-radius: 0.75rem; /* rounded-xl */
            transition: all 0.3s ease; /* transition-all duration-300 */
            color: #6b7280; /* text-gray-500 */
        }
        .nav-item:hover {
            color: #3b82f6; /* hover:text-blue-500 */
            background-color: #f9fafb; /* hover:bg-gray-50 */
        }
        .nav-item.active {
            color: #2563eb; /* text-blue-600 */
        }
        .nav-item.active span {
            font-weight: 700; /* font-bold */
        }
        .nav-item.active svg {
            color: #2563eb; /* text-blue-600 */
        }

        /* Custom message box and event modal style */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.6);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease, visibility 0.3s ease;
        }
        .modal-overlay.visible {
            opacity: 1;
            visibility: visible;
        }
        .modal-box {
            background-color: #fff;
            padding: 2rem;
            border-radius: 1rem;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.4);
            text-align: center;
            max-width: 450px;
            width: 90%;
            transform: translateY(-30px);
            transition: transform 0.3s ease;
        }
        .modal-overlay.visible .modal-box {
            transform: translateY(0);
        }
        .modal-box p {
            font-size: 1.25rem;
            margin-bottom: 2rem;
            color: #333;
        }
        .modal-box button {
            background-color: #007bff;
            color: white;
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 0.5rem;
            cursor: pointer;
            font-size: 1rem;
            transition: background-color 0.3s ease;
        }
        .modal-box button:hover {
            background-color: #0056b3;
        }
        .modal-box h3 {
            font-size: 1.5rem;
            font-weight: 700;
            margin-bottom: 1.5rem;
            color: #1f2937;
        }
        .modal-box label {
            display: block;
            text-align: left;
            margin-bottom: 0.5rem;
            font-weight: 600;
            color: #374151;
            font-size: 0.875rem;
        }
        .modal-box input[type="text"],
        .modal-box input[type="date"],
        .modal-box textarea {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid #d1d5db;
            border-radius: 0.5rem;
            margin-bottom: 1rem;
            font-size: 1rem;
            color: #374151;
        }
        .modal-box textarea {
            min-height: 80px;
            resize: vertical;
        }
        .modal-box .button-group {
            display: flex;
            justify-content: flex-end;
            gap: 0.75rem;
            margin-top: 1.5rem;
        }
        .modal-box .button-group button {
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.2s ease, color 0.2s ease;
        }
        .modal-box .button-group .save-button {
            background-color: #2563eb;
            color: white;
        }
        .modal-box .button-group .save-button:hover {
            background-color: #1d4ed8;
        }
        .modal-box .button-group .cancel-button {
            background-color: #e5e7eb;
            color: #4b5563;
        }
        .modal-box .button-group .cancel-button:hover {
            background-color: #d1d5db;
        }

        /* Added for square boxes */
        .square-box {
            background-color: #ffffff;
            border: 1px solid #e2e8f0;
            border-radius: 0.75rem; /* rounded-xl */
            padding: 1rem;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            flex: 1; /* Allows boxes to take equal space */
            aspect-ratio: 1 / 1; /* Makes the box square based on its width */
            text-align: center;
            cursor: pointer; /* Indicate it's clickable */
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }
        .square-box:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 16px rgba(0, 0, 0, 0.1);
        }


        /* Academic schedule content box styles */
        .academic-schedule-content-box {
            background-color: #ffffff;
            border-radius: 0.75rem;
            border: 1px solid #e2e8f0;
            text-align: left;
            min-height: 200px;
            width: 100%;
            overflow: hidden;
        }
        /* Calendar navigation styles */
        .calendar-nav {
            display: flex;
            justify-content: space-between;
            align-items: center;
            width: 100%;
            margin-bottom: 1rem;
            padding: 0.5rem 0;
        }
        .calendar-nav button {
            background-color: transparent;
            color: #4b5563;
            padding: 0;
            border-radius: 0;
            transition: color 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            border: none;
            outline: none;
        }
        .calendar-nav button:hover {
            color: #3b82f6;
            background-color: transparent;
        }
        .calendar-nav span {
            font-size: 1.25rem;
            font-weight: 600;
            color: #1f2937;
        }
        /* Calendar grid specific styles */
        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 1px;
            width: 100%;
            background-color: #e2e8f0;
        }
        .calendar-header-day {
            background-color: #ffffff;
            font-weight: 600;
            text-align: center;
            padding: 0.75rem 0.25rem;
            font-size: 0.75rem;
            color: #4a5568;
        }
        .calendar-cell {
            background-color: #ffffff;
            min-height: 80px;
            padding: 0.5rem;
            display: flex;
            flex-direction: column;
            align-items: flex-start;
            justify-content: flex-start;
            font-size: 0.75rem;
            color: #4a5568;
            overflow: hidden;
            position: relative;
        }
        .calendar-cell.inactive-month {
            background-color: #f3f4f6;
            color: #9ca3af;
        }
        .calendar-cell.today {
            background-color: #e5e7eb;
            font-weight: 600;
        }
        .calendar-cell-date {
            font-weight: 700;
            margin-bottom: 0.25rem;
            color: #1f2937;
        }
        .calendar-cell-event {
            font-size: 0.625rem;
            line-height: 1.2;
            margin-bottom: 0.2rem;
            color: #1f2937;
            white-space: normal;
            word-break: break-word;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .calendar-cell-event.user-event { /* New style for user-added events */
            background-color: #e0f2fe; /* Light blue background */
            border-left: 3px solid #38b2ac; /* Teal left border */
            padding-left: 0.25rem;
            color: #0056b3; /* Darker blue text */
            font-weight: 500;
        }
        .calendar-cell-event:last-child {
            margin-bottom: 0;
        }

        /* Skeleton Loader animation for loading states */
        .skeleton {
            animation: pulse 1.5s infinite ease-in-out;
            background: linear-gradient(-90deg, #f0f0f0 0%, #f8f8f8 50%, #f0f0f0 100%);
            background-size: 200% 100%;
        }
        @keyframes pulse {
            0% {
                background-position: -200% 0;
            }
            100% {
                background-position: 200% 0;
            }
        }
        .skeleton-text {
            height: 1em; /* Adjust as needed */
            width: 80%; /* Adjust as needed */
            margin-bottom: 0.5em;
            border-radius: 4px;
        }
    </style>
</head>
<body>

    <!-- Main content area -->
    <div class="main-content-container">

        <!-- Header: Logo and Account/Login section -->
        <div class="w-full flex justify-between items-center px-6 pt-4">
            <!-- Logo -->
            <div class="flex items-center">
                <img src="/image/logo.png" alt="가로형 로고" class="h-12">
            </div>

            <!-- Account/Login section with dropdown -->
            <div class="relative">
                <div id="accountStatusArea" class="flex items-center">
                    <!-- Conditional content injected by JavaScript -->
                    <span class="text-gray-500 text-sm">계정 정보 로딩 중...</span>
                </div>
                <!-- Dropdown menu (initially hidden) -->
                <div id="accountDropdown" class="dropdown-menu hidden">
                    <button id="settingsButton" class="block">설정</button>
                    <button id="logoutButton" class="block">로그아웃</button>
                </div>
            </div>
        </div>

        <!-- Calendar Section Content -->
        <div class="w-full flex flex-col items-start px-6 mt-8 mb-4">
            <div class="flex justify-between items-center w-full mb-4">
                <h2 class="text-left text-xl font-bold text-gray-800">캘린더</h2>
                <!-- Add Event Button (visible only for logged-in users) -->
                <button id="addEventButton" class="hidden bg-blue-500 hover:bg-blue-600 text-white font-medium py-2 px-4 rounded-full shadow transition duration-300 text-sm">
                    일정 추가
                </button>
            </div>


            <!-- Two square boxes for Calendar functions -->
            <div class="w-full flex gap-4 mb-6">
                <div id="homeworkBox" class="square-box">
                    <!-- Homework icon -->
                    <img src="/image/homework.png" alt="숙제 아이콘" class="w-16 h-16 mb-4 object-contain">
                    <h3 class="text-lg font-semibold text-gray-800 mb-2">숙제 관리</h3>
                    <p class="text-gray-600 text-sm">여기에서 숙제를 추가하고 확인할 수 있습니다.</p>
                </div>
                <div id="gradesBox" class="square-box">
                    <!-- Grades icon -->
                    <img src="/image/sexual.png" alt="성적 아이콘" class="w-16 h-16 mb-4 object-contain">
                    <h3 class="text-lg font-semibold text-gray-800 mb-2">성적 관리</h3>
                    <p class="text-gray-600 text-sm">여기에서 성적을 기록하고 추적할 수 있습니다.</p>
                </div>
            </div>

            <!-- Academic Calendar Section -->
            <div class="w-full flex flex-col items-start gap-y-2 mt-4">
                <!-- Calendar Navigation (Month selection) -->
                <div class="calendar-nav">
                    <button id="academic-prevMonthButton" aria-label="Previous Month"><i data-lucide="chevron-left" class="w-5 h-5"></i></button>
                    <span id="academic-calendar-month-year"></span>
                    <button id="academic-nextMonthButton" aria-label="Next Month"><i data-lucide="chevron-right" class="w-5 h-5"></i></button>
                </div>

                <!-- Academic Schedule display area -->
                <div id="academic-schedule-display-section" class="w-full academic-schedule-content-box">
                    <!-- Academic calendar will be rendered here -->
                    <div class="w-full calendar-grid">
                        <!-- Skeleton header days -->
                        ${Array(5).fill(0).map((_, i) => `<div class="calendar-header-day skeleton skeleton-text w-full !h-auto !mb-0 !rounded-none py-3"></div>`).join('')}
                        <!-- Skeleton cells -->
                        ${Array(35).fill(0).map((_, i) => `
                            <div class="calendar-cell">
                                <div class="skeleton skeleton-text w-8 h-4 mb-2"></div>
                                <div class="skeleton skeleton-text w-full h-3 mb-1"></div>
                                <div class="skeleton skeleton-text w-3/4 h-3"></div>
                            </div>
                        `).join('')}
                    </div>
                </div>
            </div>
        </div>

    </div>

    <!-- Event Add Modal (Hidden by default) -->
    <div id="eventModalOverlay" class="modal-overlay">
        <div class="modal-box">
            <h3>새 일정 추가</h3>
            <form id="eventForm">
                <label for="eventName">일정명:</label>
                <input type="text" id="eventName" placeholder="예: 수학 숙제 제출" required>

                <label for="eventDate">날짜:</label>
                <input type="date" id="eventDate" required>

                <label for="eventDescription">설명 (선택 사항):</label>
                <textarea id="eventDescription" placeholder="추가 설명..."></textarea>

                <div class="button-group">
                    <button type="button" id="cancelEventButton" class="cancel-button">취소</button>
                    <button type="submit" id="saveEventButton" class="save-button">저장</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Bottom Navigation Bar -->
    <nav class="fixed bottom-0 left-0 right-0 bg-white p-3 border-t border-gray-300 max-w-xl mx-auto w-full z-10">
        <div class="flex justify-around items-center h-12">
            <!-- Home Navigation Item -->
            <button id="nav-home" class="nav-item flex flex-col items-center justify-center p-2 rounded-xl transition-all duration-300 text-gray-500 hover:text-blue-500 hover:bg-gray-50" data-tab="홈" data-path="/">
                <svg viewBox="0 0 24 24" fill="currentColor" class="w-6 h-6 mb-1" xmlns="http://www.w3.org/2000/svg">
                    <path d="M10 20V14H14V20H19V12H22L12 3L2 12H5V20H10Z"/>
                </svg>
                <span class="text-xs font-medium">홈</span>
            </button>

            <!-- School Life Navigation Item (consolidated) -->
            <button id="nav-school-life" class="nav-item flex flex-col items-center justify-center p-2 rounded-xl transition-all duration-300 text-gray-500 hover:text-blue-500 hover:bg-gray-50" data-tab="학교생활" data-path="/sclife/timetable">
                <svg viewBox="0 0 24 24" fill="currentColor" class="w-6 h-6 mb-1" xmlns="http://www.w3.org/2000/svg">
                    <path d="M4 19V6.5C4 5.94772 4.44772 5.5 5 5.5H19C19.5523 5.5 20 5.94772 20 6.5V19C20 19.5523 19.5523 20 19 20H5C4.44772 20 4 19.5523 4 19ZM6 17H18V7.5H6V17ZM9 10H15V12H9V10Z"/>
                </svg>
                <span class="text-xs font-medium">학교생활</span>
            </button>

            <!-- Community Navigation Item -->
            <button id="nav-community" class="nav-item flex flex-col items-center justify-center p-2 rounded-xl transition-all duration-300 text-gray-500 hover:text-blue-500 hover:bg-gray-50" data-tab="커뮤니티" data-path="/community">
                <svg viewBox="0 0 24 24" fill="currentColor" class="w-6 h-6 mb-1" xmlns="http://www.w3.org/2000/svg">
                    <path d="M16 11C18.21 11 20 9.21 20 7C20 4.79 18.21 3 16 3C13.79 3 12 4.79 12 7C12 9.21 13.79 11 16 11ZM8 11C10.21 11 12 9.21 12 7C12 4.79 10.21 3 8 3C5.79 3 4 4.79 4 7C4 9.21 5.79 11 8 11ZM16 13C13.67 13 9.34 14.28 9 17V19H23V17C22.66 14.28 18.33 13 16 13ZM8 13C5.33 13 0 14.33 0 17V19H9V17C8.67 14.33 4.33 13 8 13Z"/>
                </svg>
                <span class="text-xs font-medium">커뮤니티</span>
            </button>

            <!-- Calendar Navigation Item -->
            <button id="nav-calendar" class="nav-item flex flex-col items-center justify-center p-2 rounded-xl transition-all duration-300 text-gray-500 hover:text-blue-500 hover:bg-gray-50" data-tab="캘린더" data-path="/calendar">
                <svg viewBox="0 0 24 24" fill="currentColor" class="w-6 h-6 mb-1" xmlns="http://www.w3.org/2000/svg">
                    <path d="M19 4H18V2H16V4H8V2H6V4H5C3.89 4 3 4.9 3 6V20C3 21.1 3.89 22 5 22H19C20.1 22 21 21.1 21 20V6C21 4.9 20.1 4 19 4ZM19 20H5V9H19V20Z"/>
                </svg>
                <span class="text-xs font-medium">캘린더</span>
            </button>

            <!-- More Navigation Item -->
            <button id="nav-more" class="nav-item flex flex-col items-center justify-center p-2 rounded-xl transition-all duration-300 text-gray-500 hover:text-blue-500 hover:bg-blue-50" data-tab="더보기" data-path="/plus">
                <svg viewBox="0 0 24 24" fill="currentColor" class="w-6 h-6 mb-1" xmlns="http://www.w3.org/2000/svg">
                    <path d="M12 10C10.9 10 10 10.9 10 12C10 13.1 10.9 14 12 14C13.1 14 14 13.1 14 12C14 10.9 13.1 10 12 10ZM19 10C17.9 10 17 10.9 17 12C17 13.1 17.9 14 19 14C20.1 14 21 13.1 21 12C21 10.9 20.1 10 19 10ZM5 10C3.9 10 3 10.9 3 12C3 13.1 3.9 14 5 14C6.1 14 7 13.1 7 12C7 10.9 6.1 10 5 10Z"/>
                </svg>
                <span class="text-xs font-medium">더보기</span>
            </button>
        </div>
    </nav>

    <script>
        // Global variables for Firebase configuration (provided by Canvas environment)
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = {
            apiKey: "AIzaSyC_SHRcQ9hXmjVbP3km4rdR4UvKIoqpLHo",
            authDomain: "n-mate.firebaseapp.com",
            projectId: "n-mate",
            storageBucket: "n-mate.firebasestorage.app",
            appId: "1:691313471077:web:3066aaeca0a1d9e448e08c",
            measurementId: "G-0LCGVBKXLQ",
            messagingSenderId: "691313471077"
        };

        // Firebase app, auth, and firestore instances
        let app;
        let auth;
        let db;

        // NEIS API common information
        const neisApiKey = "cbb4da48e87445f68c2732368454ebc3"; // Replace with your API key
        const eduCode = "C10"; // Replace with your school's education office code
        const schoolCode = "7171018"; // Replace with your school's standard code

        // DOM elements
        const accountStatusArea = document.getElementById('accountStatusArea');
        const accountDropdown = document.getElementById('accountDropdown');
        const homeworkBox = document.getElementById('homeworkBox'); // Homework box
        const gradesBox = document.getElementById('gradesBox');     // Grades box

        // DOM elements (Academic Schedule / Calendar)
        const academicScheduleDisplaySection = document.getElementById('academic-schedule-display-section');
        const academicCalendarMonthYearSpan = document.getElementById('academic-calendar-month-year');
        const academicPrevMonthButton = document.getElementById('academic-prevMonthButton');
        const academicNextMonthButton = document.getElementById('academic-nextMonthButton');
        let academicCurrentDate = new Date(); // Current date object for academic calendar
        let academicCalendarEvents = []; // Store fetched academic calendar events globally
        let userCalendarEvents = []; // Store user-added calendar events globally

        // DOM elements for Event Add Modal
        const addEventButton = document.getElementById('addEventButton');
        const eventModalOverlay = document.getElementById('eventModalOverlay');
        const eventForm = document.getElementById('eventForm');
        const eventNameInput = document.getElementById('eventName');
        const eventDateInput = document.getElementById('eventDate');
        const eventDescriptionInput = document.getElementById('eventDescription');
        const saveEventButton = document.getElementById('saveEventButton');
        const cancelEventButton = document.getElementById('cancelEventButton');

        /**
         * Toggles the visibility of the account dropdown menu.
         */
        function toggleDropdown() {
            accountDropdown.classList.toggle('hidden');
        }

        /**
         * Handles user logout.
         */
        async function handleLogout() {
            if (auth) {
                try {
                    await auth.signOut();
                    console.log('로그아웃 성공.');
                    window.location.href = '/login';
                } catch (error) {
                    console.error('로그아웃 오류:', error);
                }
            }
        }

        /**
         * Handles navigation to the settings page.
         */
        function handleSettingsClick() {
            window.location.href = '/settings';
        }

        /**
         * Updates the account UI based on user authentication status.
         * Displays email prefix if logged in, otherwise "로그인" button.
         * Shows/hides the "일정 추가" button based on login status.
         *
         * @param {firebase.User} user - The authenticated user object or null.
         */
        async function updateAccountUI(user) {
            if (user && user.email) { // 사용자가 로그인되어 있고 이메일이 있는 경우
                const emailPrefix = user.email.split('@')[0];
                accountStatusArea.innerHTML = `
                    <button id="accountTabButton" class="flex items-center space-x-2 p-2 rounded-full hover:bg-gray-100 focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <span class="text-gray-700 text-sm font-medium">${emailPrefix}</span>
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-user-circle-2"><path d="M18 20a6 6 0 0 0-12 0"/><circle cx="12" cy="10" r="4"/><circle cx="12" cy="12" r="10"/></svg>
                    </button>
                `;
                document.getElementById('accountTabButton').addEventListener('click', toggleDropdown);

                const settingsButton = document.getElementById('settingsButton');
                if (settingsButton && !settingsButton.dataset.listenerAdded) {
                    settingsButton.addEventListener('click', handleSettingsClick);
                    settingsButton.dataset.listenerAdded = 'true';
                }
                const logoutButton = document.getElementById('logoutButton');
                if (logoutButton && !logoutButton.dataset.listenerAdded) {
                    logoutButton.addEventListener('click', handleLogout);
                    logoutButton.dataset.listenerAdded = 'true';
                }
                addEventButton.classList.remove('hidden'); // Show add event button
                setupUserEventsListener(user.uid); // Setup listener for user events
            } else { // 사용자가 로그아웃되었거나 이메일이 없는 경우 (예: 익명 사용자)
                accountStatusArea.innerHTML = `
                    <button id="loginRedirectButton" class="bg-blue-500 hover:bg-blue-600 text-white font-medium py-2 px-4 rounded-full shadow transition duration-300">
                        로그인
                    </button>
                `;
                document.getElementById('loginRedirectButton').addEventListener('click', () => {
                    window.location.href = '/login';
                });
                accountDropdown.classList.add('hidden'); // Hide dropdown
                addEventButton.classList.add('hidden'); // Hide add event button
                userCalendarEvents = []; // Clear user events if logged out
                renderAcademicCalendar(academicCurrentDate, academicCalendarEvents, userCalendarEvents); // Re-render without user events
            }
            lucide.createIcons(); // Lucide 아이콘이 동적으로 추가/변경될 때 렌더링되도록 호출
        }

        /**
         * Updates the active state of the navigation bar buttons based on the current URL path.
         * 현재 URL 경로에 따라 하단 내비게이션 바의 활성 상태를 업데이트합니다.
         */
        function updateNavigationActiveState() {
            const currentPath = window.location.pathname;
            const navItems = document.querySelectorAll('.nav-item');

            navItems.forEach(item => {
                const itemPath = item.dataset.path;
                const spanElement = item.querySelector('span');
                const svgElement = item.querySelector('svg');

                // 모든 내비게이션 아이템을 기본(비활성) 상태로 재설정합니다.
                item.classList.remove('text-blue-600', 'active');
                item.classList.add('text-gray-500', 'hover:text-blue-500', 'hover:bg-gray-50');
                if (spanElement) {
                    spanElement.classList.remove('font-bold');
                    spanElement.classList.add('font-medium');
                }
                if (svgElement) {
                    svgElement.classList.remove('text-blue-600');
                    svgElement.classList.add('text-gray-500');
                }

                // 현재 경로와 일치하거나 카테고리 버튼인 경우 활성 상태를 설정합니다.
                if (currentPath === itemPath) {
                    item.classList.add('text-blue-600', 'active');
                    item.classList.remove('text-gray-500', 'hover:text-blue-500', 'hover:bg-gray-50');
                    if (spanElement) {
                        spanElement.classList.add('font-bold');
                        spanElement.classList.remove('font-medium');
                    }
                    if (svgElement) {
                        svgElement.classList.add('text-blue-600');
                        svgElement.classList.remove('text-gray-500');
                    }
                } else if (item.id === 'nav-school-life' && currentPath.startsWith('/sclife')) {
                    item.classList.add('text-blue-600', 'active');
                    item.classList.remove('text-gray-500', 'hover:text-blue-500', 'hover:bg-gray-50');
                    if (spanElement) {
                        spanElement.classList.add('font-bold');
                        spanElement.classList.remove('font-medium');
                    }
                    if (svgElement) {
                        svgElement.classList.add('text-blue-600');
                        svgElement.classList.remove('text-gray-500');
                    }
                } else if (item.id === 'nav-community' && (currentPath.startsWith('/community') || currentPath.startsWith('/write') || currentPath.startsWith('/view'))) {
                    item.classList.add('text-blue-600', 'active');
                    item.classList.remove('text-gray-500', 'hover:text-blue-500', 'hover:bg-gray-50');
                    if (spanElement) {
                        spanElement.classList.add('font-bold');
                        spanElement.classList.remove('font-medium');
                    }
                    if (svgElement) {
                        svgElement.classList.add('text-blue-600');
                        svgElement.classList.remove('text-gray-500');
                    }
                } else if (item.id === 'nav-more' && (currentPath.startsWith('/plus') || currentPath.startsWith('/legal') || currentPath.startsWith('/info') || currentPath.startsWith('/faq') || currentPath.startsWith('/verinfo') || currentPath.startsWith('/contact') || currentPath.startsWith('/settings'))) {
                    item.classList.add('text-blue-600', 'active');
                    item.classList.remove('text-gray-500', 'hover:text-blue-500', 'hover:bg-gray-50');
                    if (spanElement) {
                        spanElement.classList.add('font-bold');
                        spanElement.classList.remove('font-medium');
                    }
                    if (svgElement) {
                        svgElement.classList.add('text-blue-600');
                        svgElement.classList.remove('text-gray-500');
                    }
                }
                // /calendar 경로에 대해 nav-calendar 아이템을 활성화합니다.
                if (currentPath === '/calendar' && item.id === 'nav-calendar') {
                     item.classList.add('text-blue-600', 'active');
                    item.classList.remove('text-gray-500', 'hover:text-blue-500', 'hover:bg-gray-50');
                    if (spanElement) {
                        spanElement.classList.add('font-bold');
                        spanElement.classList.remove('font-medium');
                    }
                    if (svgElement) {
                        svgElement.classList.add('text-blue-600');
                        svgElement.classList.remove('text-gray-500');
                    }
                }
            });
        }

        /**
         * Sets up click event listeners for navigation items.
         * 내비게이션 아이템에 클릭 이벤트 리스너를 설정합니다.
         */
        function setupNavigationEvents() {
            const navItems = document.querySelectorAll('.nav-item');
            navItems.forEach(item => {
                item.addEventListener('click', () => {
                    const path = item.dataset.path;
                    const currentPathname = window.location.pathname;

                    // 현재 경로와 다를 경우에만 페이지 이동
                    if (currentPathname !== path) {
                        // 학교생활 탭 클릭 시 초기 탭 상태 저장 (필요시 사용)
                        if (item.id === 'nav-school-life') {
                            localStorage.setItem('initialSchoolLifeTab', 'timetableContent');
                        } else {
                            localStorage.removeItem('initialSchoolLifeTab');
                        }
                        window.location.href = path; // 해당 경로로 페이지 이동
                    }
                });
            });

            // Add navigation for Homework and Grades boxes
            homeworkBox.addEventListener('click', () => {
                window.location.href = '/homework';
            });
            gradesBox.addEventListener('click', () => {
                window.location.href = '/sexual';
            });
        }

        /**
         * Displays a custom message box.
         * 네이티브 alert() 대신 사용자 지정 메시지 상자를 표시합니다.
         * @param {string} message - 표시할 메시지.
         */
        function showMessageBox(message) {
            const messageBox = document.createElement('div');
            messageBox.classList.add('modal-overlay', 'visible'); // Use modal-overlay for consistency
            messageBox.innerHTML = `
                <div class="modal-box">
                    <p class="text-gray-800 text-lg mb-4">${message}</p>
                    <button id="messageBoxClose" class="bg-blue-500 hover:bg-blue-600 text-white font-semibold py-2 px-4 rounded-md transition duration-300">확인</button>
                </div>
            `;
            document.body.appendChild(messageBox);

            document.getElementById('messageBoxClose').addEventListener('click', () => {
                document.body.removeChild(messageBox);
            });
        }

        // --- Academic Schedule Functions ---

        /**
         * Renders the calendar grid view for a given month and populates it with events.
         * Merges academic events and user events.
         * @param {Date} monthDate - The Date object representing the month to display.
         * @param {Array} academicEvents - An array of academic event objects from the NEIS API.
         * @param {Array} userEvents - An array of user-added event objects from Firestore.
         */
        function renderAcademicCalendar(monthDate, academicEvents, userEvents) {
            const today = new Date();
            const currentYear = monthDate.getFullYear();
            const currentMonth = monthDate.getMonth(); // 0-indexed

            const firstDayOfMonth = new Date(currentYear, currentMonth, 1);
            const lastDayOfMonth = new Date(currentYear, currentMonth + 1, 0);

            const dayNames = ['월', '화', '수', '목', '금']; // Only display weekdays in header

            let calendarHtml = '<div class="calendar-grid">';

            // Add day headers (Mon-Fri)
            dayNames.forEach(dayName => {
                calendarHtml += `<div class="calendar-header-day">${dayName}</div>`;
            });

            // Determine the starting day for the calendar grid
            let startCalendarDate = new Date(firstDayOfMonth);
            const firstDayWeekday = firstDayOfMonth.getDay(); // 0=Sun, 1=Mon, ..., 6=Sat

            if (firstDayWeekday === 0) { // If first day is Sunday, go back 6 days to Monday of previous week
                startCalendarDate.setDate(firstDayOfMonth.getDate() - 6);
            } else if (firstDayWeekday !== 1) { // If not Monday, go back to the previous Monday
                startCalendarDate.setDate(firstDayOfMonth.getDate() - (firstDayWeekday - 1));
            }

            // Determine the ending day for the calendar grid
            let endCalendarDate = new Date(lastDayOfMonth);
            const lastDayWeekday = lastDayOfMonth.getDay();

            if (lastDayWeekday === 0) { // If last day is Sunday, go forward 5 days to Friday of next week
                endCalendarDate.setDate(lastDayOfMonth.getDate() + 5);
            } else if (lastDayWeekday !== 5) { // If not Friday, go forward to the next Friday
                endCalendarDate.setDate(lastDayOfMonth.getDate() + (5 - lastDayWeekday + 7) % 7);
            }

            // Iterate through each day from startCalendarDate to endCalendarDate
            let currentIterationDate = new Date(startCalendarDate);
            while (currentIterationDate <= endCalendarDate) {
                const dayOfWeek = currentIterationDate.getDay(); // 0=Sun, 1=Mon, ..., 6=Sat

                // Only render Mon-Fri cells
                if (dayOfWeek >= 1 && dayOfWeek <= 5) {
                    const cellDateString = `${currentIterationDate.getFullYear()}${String(currentIterationDate.getMonth() + 1).padStart(2, '0')}${String(currentIterationDate.getDate()).padStart(2, '0')}`;
                    const isToday = currentIterationDate.toDateString() === today.toDateString();
                    const isCurrentMonth = currentIterationDate.getMonth() === currentMonth && currentIterationDate.getFullYear() === currentYear;

                    let cellClass = 'calendar-cell';
                    if (!isCurrentMonth) {
                        cellClass += ' inactive-month';
                    }
                    if (isToday) {
                        cellClass += ' today';
                    }

                    let eventHtml = '';
                    const dailyAcademicEvents = academicEvents.filter(event => event.AA_YMD === cellDateString);
                    const dailyUserEvents = userEvents.filter(event => event.eventDate === cellDateString);

                    // Sort events by time if available, or just by type
                    const allDailyEvents = [
                        ...dailyAcademicEvents.map(event => ({ type: 'academic', name: event.EVENT_NM })),
                        ...dailyUserEvents.map(event => ({ type: 'user', name: event.eventName }))
                    ];

                    allDailyEvents.forEach(event => {
                        const eventClass = event.type === 'user' ? 'user-event' : '';
                        eventHtml += `<p class="calendar-cell-event ${eventClass}">${event.name}</p>`;
                    });

                    calendarHtml += `
                        <div class="${cellClass}">
                            <div class="calendar-cell-date">${currentIterationDate.getDate()}</div>
                            ${eventHtml}
                        </div>
                    `;
                }
                currentIterationDate.setDate(currentIterationDate.getDate() + 1);
            }

            calendarHtml += '</div>'; // Close calendar-grid
            academicScheduleDisplaySection.innerHTML = calendarHtml;
            lucide.createIcons(); // Re-create Lucide icons for new content (calendar navigation arrows)
        }

        /**
         * NEIS API를 사용하여 학사일정을 불러오는 함수
         * 인자로 표시할 달의 Date 객체를 받도록 수정
         * @param {Date} monthDate - 학사일정을 불러올 월의 Date 객체.
         */
        async function getAcademicCalendar(monthDate = academicCurrentDate) {
            academicCalendarMonthYearSpan.textContent = `${monthDate.getFullYear()}년 ${monthDate.getMonth() + 1}월`;

            // Display skeleton loader while fetching
            academicScheduleDisplaySection.innerHTML = `
                <div class="w-full calendar-grid">
                    ${['월', '화', '수', '목', '금'].map(dayName => `<div class="calendar-header-day skeleton skeleton-text w-full !h-auto !mb-0 !rounded-none py-3"></div>`).join('')}
                    ${Array(35).fill(0).map((_, i) => `
                        <div class="calendar-cell">
                            <div class="skeleton skeleton-text w-8 h-4 mb-2"></div>
                            <div class="skeleton skeleton-text w-full h-3 mb-1"></div>
                            <div class="skeleton skeleton-text w-3/4 h-3"></div>
                        </div>
                    `).join('')}
                </div>
            `;

            const year = monthDate.getFullYear();
            const month = monthDate.getMonth();

            const fromDate = new Date(year, month, 1);
            const toDate = new Date(year, month + 1, 0);

            const fromYmd = `${fromDate.getFullYear()}${('0' + (fromDate.getMonth() + 1)).slice(-2)}${('0' + fromDate.getDate()).slice(-2)}`;
            const toYmd = `${toDate.getFullYear()}${('0' + (toDate.getMonth() + 1)).slice(-2)}${('0' + toDate.getDate()).slice(-2)}`;

            const apiUrl = `https://open.neis.go.kr/hub/SchoolSchedule?KEY=${neisApiKey}&Type=json&pIndex=1&pSize=100&ATPT_OFCDC_SC_CODE=${eduCode}&SD_SCHUL_CODE=${schoolCode}&AA_FROM_YMD=${fromYmd}&AA_TO_YMD=${toYmd}`;

            try {
                const response = await fetch(apiUrl);
                const data = await response.json();

                let events = [];
                if (data.SchoolSchedule && data.SchoolSchedule[1] && data.SchoolSchedule[1].row) {
                    events = data.SchoolSchedule[1].row;
                    events.sort((a, b) => parseInt(a.AA_YMD) - parseInt(b.AA_YMD));
                } else if (data.RESULT && data.RESULT.CODE === 'INFO-200') {
                    console.log(`No academic schedule for ${year}년 ${month + 1}월`);
                } else {
                    console.error(`API response error for academic schedule:`, data);
                }

                academicCalendarEvents = events;
                // Re-render calendar with both academic and user events
                renderAcademicCalendar(monthDate, academicCalendarEvents, userCalendarEvents);
            } catch (error) {
                console.error('Error fetching academic schedule data:', error);
                academicScheduleDisplaySection.innerHTML = '<p class="text-base text-red-500">학사일정 정보를 가져오는 중 오류가 발생했습니다.</p>';
            }
        }

        /**
         * 이전 달로 이동합니다.
         */
        function goToPrevAcademicMonth() {
            academicCurrentDate.setMonth(academicCurrentDate.getMonth() - 1);
            getAcademicCalendar(academicCurrentDate);
        }

        /**
         * 다음 달로 이동합니다.
         */
        function goToNextAcademicMonth() {
            academicCurrentDate.setMonth(academicCurrentDate.getMonth() + 1);
            getAcademicCalendar(academicCurrentDate);
        }

        /**
         * Shows the event addition modal.
         */
        function showEventModal() {
            eventModalOverlay.classList.add('visible');
            eventNameInput.value = '';
            eventDateInput.value = '';
            eventDescriptionInput.value = '';

            // Set default date to today
            const today = new Date();
            const year = today.getFullYear();
            const month = String(today.getMonth() + 1).padStart(2, '0');
            const day = String(today.getDate()).padStart(2, '0');
            eventDateInput.value = `${year}-${month}-${day}`;
        }

        /**
         * Hides the event addition modal.
         */
        function hideEventModal() {
            eventModalOverlay.classList.remove('visible');
        }

        /**
         * Saves a new event to Firestore.
         */
        async function saveEvent() {
            const eventName = eventNameInput.value.trim();
            const eventDate = eventDateInput.value.replace(/-/g, ''); // YYYYMMDD format
            const eventDescription = eventDescriptionInput.value.trim();

            if (!eventName || !eventDate) {
                showMessageBox('일정명과 날짜를 입력해주세요.');
                return;
            }

            if (!auth.currentUser) {
                showMessageBox('로그인이 필요합니다.');
                return;
            }

            try {
                const userId = auth.currentUser.uid;
                const userEventsCollectionRef = db.collection(`artifacts/${appId}/users/${userId}/user_events`);

                await userEventsCollectionRef.add({
                    eventName: eventName,
                    eventDate: eventDate,
                    description: eventDescription,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                    userId: userId
                });
                showMessageBox('일정이 성공적으로 추가되었습니다!');
                hideEventModal();
                // onSnapshot listener will automatically re-render the calendar
            } catch (error) {
                console.error('일정 추가 오류:', error);
                showMessageBox('일정 추가 중 오류가 발생했습니다: ' + error.message);
            }
        }

        /**
         * Sets up real-time listener for user-specific events.
         * @param {string} userId - The current user's ID.
         */
        function setupUserEventsListener(userId) {
            if (!db || !userId) {
                console.error("Firestore 또는 userId가 유효하지 않아 사용자 일정 리스너를 설정할 수 없습니다.");
                return;
            }
            const userEventsCollectionRef = db.collection(`artifacts/${appId}/users/${userId}/user_events`);
            // Clear previous listener if any to avoid duplicates
            if (window.userEventsUnsubscribe) {
                window.userEventsUnsubscribe();
            }

            window.userEventsUnsubscribe = userEventsCollectionRef.onSnapshot(snapshot => {
                userCalendarEvents = snapshot.docs.map(doc => ({
                    id: doc.id,
                    ...doc.data()
                }));
                // Sort by date to ensure proper display
                userCalendarEvents.sort((a, b) => parseInt(a.eventDate) - parseInt(b.eventDate));
                console.log("사용자 일정 업데이트:", userCalendarEvents);
                // Re-render the calendar with updated user events
                renderAcademicCalendar(academicCurrentDate, academicCalendarEvents, userCalendarEvents);
            }, error => {
                console.error("사용자 일정 가져오기 오류:", error);
            });
        }


        // 페이지 데이터 초기화 (캘린더 데이터 로딩 포함)
        async function initializePageData() {
            console.log("캘린더 페이지가 초기화되었습니다.");
            // 캘린더 페이지 로드 시 학사일정 불러오기
            // 사용자 인증 상태는 onAuthStateChanged에서 처리되므로, 여기서는 단순히 학사일정만 불러옵니다.
            // 사용자 일정은 updateAccountUI에서 setupUserEventsListener를 통해 로드됩니다.
            await getAcademicCalendar(academicCurrentDate);
        }

        document.addEventListener('DOMContentLoaded', async () => {
            // Firebase 초기화
            if (firebaseConfig && firebaseConfig.apiKey) {
                if (firebase.apps.length === 0) {
                    try {
                        app = firebase.initializeApp(firebaseConfig);
                        auth = firebase.auth();
                        db = firebase.firestore();
                        console.log('Firebase 앱, 인증, Firestore 초기화 성공.');

                        // 인증 상태 변경 리스너 설정
                        auth.onAuthStateChanged(async (user) => {
                            await updateAccountUI(user); // 사용자 UI 업데이트 (여기서 일정 추가 버튼 표시 및 사용자 일정 로드)
                            initializePageData(); // 페이지 데이터 초기화 (학사일정 로드)
                        });

                    } catch (error) {
                        console.error('Firebase 초기화 실패:', error);
                        await updateAccountUI(null); // 오류 발생 시 UI를 로그아웃 상태로 업데이트
                        initializePageData(); // 페이지 데이터 초기화는 계속 진행
                    }
                } else {
                    app = firebase.app();
                    auth = firebase.auth();
                    db = firebase.firestore();
                    console.log('Firebase 앱이 이미 초기화되었습니다. 기존 인스턴스를 사용합니다.');
                    auth.onAuthStateChanged(async (user) => {
                        await updateAccountUI(user); // 사용자 UI 업데이트
                        initializePageData(); // 페이지 데이터 초기화
                    });
                }
            } else {
                console.warn('Firebase 구성이 제대로 제공되지 않았습니다. Firebase를 초기화할 수 없습니다.');
                await updateAccountUI(null); // 구성이 없을 시 UI 업데이트
                initializePageData(); // 페이지 데이터 초기화는 계속 진행
            }

            // 드롭다운 외부 클릭 시 닫기 위한 전역 클릭 리스너
            window.addEventListener('click', function(e) {
                const accountTabButton = document.getElementById('accountTabButton');
                // 계정 탭 버튼 또는 드롭다운 메뉴 자체가 아닌 다른 곳을 클릭했을 때 드롭다운 숨기기
                if (accountTabButton && !accountTabButton.contains(e.target) && !accountDropdown.contains(e.target)) {
                    accountDropdown.classList.add('hidden');
                }
            });

            // 내비게이션 클릭 핸들러 설정
            setupNavigationEvents();
            // 초기 로드 시 내비게이션 활성 상태 업데이트
            updateNavigationActiveState();

            // 학사일정 캘린더 버튼 이벤트 리스너 추가
            academicPrevMonthButton.addEventListener('click', goToPrevAcademicMonth);
            academicNextMonthButton.addEventListener('click', goToNextAcademicMonth);

            // 일정 추가 모달 관련 이벤트 리스너
            addEventButton.addEventListener('click', showEventModal);
            cancelEventButton.addEventListener('click', hideEventModal);
            eventForm.addEventListener('submit', function(e) {
                e.preventDefault(); // Prevent default form submission
                saveEvent();
            });

            // 초기 아이콘 렌더링
            lucide.createIcons();
        });
    </script>
</body>
</html>
