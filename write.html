<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>게시글 작성</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Inter Font -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- Quill.js CDN -->
    <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
    <script src="https://cdn.quilljs.com/1.3.6/quill.js"></script>
    <!-- Phosphor Icons for mobile header -->
    <script src="https://unpkg.com/@phosphor-icons/web@2.1.1/dist/phosphor.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            background-color: #ffffff;
        }

        /* Quill Editor Styles */
        #editor-container {
            border: 1px solid #e2e8f0;
            border-radius: 0.5rem;
            overflow: hidden;
            background-color: #ffffff;
        }
        .ql-toolbar.ql-snow {
            border: none;
            border-bottom: 1px solid #e2e8f0;
            background-color: #ffffff;
            border-top-left-radius: 0.5rem;
            border-top-right-radius: 0.5rem;
        }
        .ql-container.ql-snow {
            border: none;
            font-size: 1rem;
        }
        .ql-editor {
            min-height: 400px;
            padding: 24px;
        }
        .ql-snow .ql-editor pre.ql-syntax {
            background-color: #272822;
            color: #f8f8f2;
            overflow: visible;
        }
        
        /* Custom HR button style */
        .ql-toolbar.ql-snow .ql-hr:before {
            content: 'HR';
            font-weight: bold;
            font-size: 10px;
            line-height: 12px;
            padding: 0 4px;
        }

        /* Mobile Header */
        @media (max-width: 767px) {
            .mobile-header { display: flex; }
            .desktop-header { display: none; }
        }
        /* PC Header */
        @media (min-width: 768px) {
            .mobile-header { display: none; }
            .desktop-header { display: flex; }
        }

        /* Loading Spinner */
        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3b82f6;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* Modal Overlay */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 50;
        }

        .disabled-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(255, 255, 255, 0.6);
            display: flex;
            justify-content: center;
            align-items: center;
            text-align: center;
            font-weight: 500;
            color: #4b5563;
            border-radius: 0.5rem;
            z-index: 10;
        }
    </style>
</head>
<body class="bg-white text-gray-800">

    <!-- Mobile Header -->
    <header class="mobile-header p-4 bg-white shadow-sm sticky top-0 z-10 md:hidden justify-between items-center">
        <button onclick="window.history.back()" class="text-gray-500 hover:text-gray-700 transition-colors">
            <i class="ph ph-arrow-left text-2xl"></i>
        </button>
        <h1 class="text-lg font-semibold">게시글 작성</h1>
        <button id="submit-btn-mobile" class="px-4 py-1 rounded-full bg-blue-500 text-white font-semibold text-sm transition-colors hover:bg-blue-600 flex items-center justify-center">
            <span id="submit-text-mobile">완료</span>
            <div id="submit-spinner-mobile" class="spinner ml-2 hidden"></div>
        </button>
    </header>

    <!-- PC Header -->
    <header class="desktop-header p-4 bg-white shadow-sm sticky top-0 z-10 hidden md:flex items-center justify-between">
        <h1 class="text-xl font-bold">새 게시글 작성</h1>
        <div class="flex items-center space-x-2">
            <button onclick="window.history.back()" class="px-4 py-2 rounded-full text-gray-600 border border-gray-300 hover:bg-gray-100 transition-colors">취소</button>
            <button id="submit-btn-desktop" class="px-6 py-2 rounded-full bg-blue-500 text-white font-semibold transition-colors hover:bg-blue-600 flex items-center justify-center">
                <span id="submit-text-desktop">게시글 올리기</span>
                <div id="submit-spinner-desktop" class="spinner ml-2 hidden"></div>
            </button>
        </div>
    </header>

    <!-- Main Content -->
    <main class="container mx-auto px-4 py-8">
        <div class="bg-white rounded-xl p-6 md:p-10 relative">
            <div id="auth-overlay" class="disabled-overlay hidden">
                <div>게시글을 작성하려면 로그인이 필요합니다.</div>
            </div>
            <div class="space-y-6">
                <!-- Title Input -->
                <div class="flex flex-col">
                    <label for="post-title" class="text-sm font-medium text-gray-700 mb-1">제목</label>
                    <input type="text" id="post-title" placeholder="게시글 제목을 입력하세요." class="w-full px-4 py-3 border-b border-gray-300 rounded-none focus:outline-none focus:ring-0 focus:border-blue-500 transition-colors">
                </div>

                <!-- Quill Editor Container -->
                <div id="editor-container">
                    <div id="editor">
                        <p>내용을 입력하세요...</p>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Modal UI -->
    <div id="modal-container" class="hidden modal-overlay">
        <div class="bg-white rounded-xl shadow-2xl p-6 w-11/12 max-w-sm text-center transform transition-transform duration-300 scale-95">
            <h3 id="modal-title" class="text-xl font-bold mb-2"></h3>
            <p id="modal-message" class="text-gray-600 mb-6"></p>
            <div id="modal-buttons" class="flex justify-center space-x-4">
                <button id="modal-cancel-btn" class="px-4 py-2 rounded-lg text-gray-600 border border-gray-300 hover:bg-gray-100 transition-colors">취소</button>
                <button id="modal-confirm-btn" class="px-4 py-2 rounded-lg bg-blue-500 text-white hover:bg-blue-600 transition-colors">확인</button>
            </div>
        </div>
    </div>

    <!-- Toast UI for messages -->
    <div id="toast-container" class="fixed bottom-4 right-4 z-50 flex flex-col items-end space-y-2"></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, collection, addDoc, getDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // Firestore 디버그 로깅 활성화
        setLogLevel('debug');

        // Firebase configuration and initialization
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        
        let userId = null;
        let userName = "익명";
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

        // UI Elements
        const postTitleInput = document.getElementById('post-title');
        const submitBtnMobile = document.getElementById('submit-btn-mobile');
        const submitBtnDesktop = document.getElementById('submit-btn-desktop');
        const submitTextMobile = document.getElementById('submit-text-mobile');
        const submitTextDesktop = document.getElementById('submit-text-desktop');
        const submitSpinnerMobile = document.getElementById('submit-spinner-mobile');
        const submitSpinnerDesktop = document.getElementById('submit-spinner-desktop');
        const modalContainer = document.getElementById('modal-container');
        const modalTitle = document.getElementById('modal-title');
        const modalMessage = document.getElementById('modal-message');
        const modalConfirmBtn = document.getElementById('modal-confirm-btn');
        const modalCancelBtn = document.getElementById('modal-cancel-btn');
        const authOverlay = document.getElementById('auth-overlay');

        // Quill.js initialization with a richer toolbar
        const toolbarOptions = [
            [{ 'header': [1, 2, 3, 4, 5, 6, false] }],
            [{ 'font': [] }],
            [{ 'size': ['small', false, 'large', 'huge'] }],

            ['bold', 'italic', 'underline', 'strike'],
            [{ 'color': [] }, { 'background': [] }],

            ['blockquote', 'code-block'],
            [{ 'list': 'ordered'}, { 'list': 'bullet' }],
            [{ 'list': 'checked' }],
            [{ 'script': 'sub'}, { 'script': 'super' }],
            [{ 'indent': '-1'}, { 'indent': '+1' }],
            [{ 'direction': 'rtl' }],

            ['link', 'image', 'video'],
            ['hr'],
            [{ 'align': [] }],
            ['clean']
        ];

        Quill.register('modules/hr', function(quill, options) {
            this.quill = quill;
            this.toolbar = quill.getModule('toolbar');
            this.toolbar.addHandler('hr', this.insertHr);
        });

        let Embed = Quill.import('blots/embed');
        class HorizontalRule extends Embed {
            static create() {
                let node = super.create();
                return node;
            }
        }
        HorizontalRule.blotName = 'hr';
        HorizontalRule.tagName = 'hr';
        Quill.register(HorizontalRule);

        const quill = new Quill('#editor', {
            theme: 'snow',
            placeholder: '내용을 입력하세요...',
            modules: {
                toolbar: toolbarOptions,
                'hr': true
            }
        });
        
        // Toast message function
        const showToast = (message, type = 'info') => {
            const toastContainer = document.getElementById('toast-container');
            const toast = document.createElement('div');
            toast.className = `p-4 rounded-lg shadow-lg mb-2 transition-transform transform translate-x-full duration-300 ease-out text-white ${
                type === 'success' ? 'bg-green-500' :
                type === 'error' ? 'bg-red-500' :
                'bg-gray-800'
            }`;
            toast.textContent = message;
            
            toastContainer.appendChild(toast);
            
            setTimeout(() => toast.classList.remove('translate-x-full'), 100);
            setTimeout(() => {
                toast.classList.add('translate-x-full');
                toast.addEventListener('transitionend', () => toast.remove());
            }, 3000);
        };
        
        // Custom modal function
        const showModal = (title, message, onConfirm, onCancel = null) => {
            modalTitle.textContent = title;
            modalMessage.textContent = message;
            modalContainer.classList.remove('hidden');

            const confirmListener = () => {
                onConfirm();
                modalContainer.classList.add('hidden');
                modalConfirmBtn.removeEventListener('click', confirmListener);
                if (onCancel) modalCancelBtn.removeEventListener('click', cancelListener);
            };

            const cancelListener = () => {
                if (onCancel) onCancel();
                modalContainer.classList.add('hidden');
                modalConfirmBtn.removeEventListener('click', confirmListener);
                modalCancelBtn.removeEventListener('click', cancelListener);
            };

            modalConfirmBtn.addEventListener('click', confirmListener);
            if (onCancel) {
                modalCancelBtn.classList.remove('hidden');
                modalCancelBtn.addEventListener('click', cancelListener);
            } else {
                modalCancelBtn.classList.add('hidden');
            }
        };

        // Submit post to Firestore
        const submitPost = async () => {
            if (!userId) {
                showToast("로그인이 필요합니다.", 'error');
                return;
            }

            const title = postTitleInput.value.trim();
            const content = quill.root.innerHTML.trim();
            
            if (!title || content.replace(/<[^>]*>/g, '').trim() === '') {
                showModal("작성 오류", "제목과 내용을 모두 입력해 주세요.");
                return;
            }

            showModal("게시글 등록", "게시글을 등록하시겠습니까?", async () => {
                try {
                    setLoading(true);
                    const communityRef = collection(db, `artifacts/${appId}/public/data/community_posts`);
                    
                    await addDoc(communityRef, {
                        title: title,
                        content: content,
                        authorId: userId,
                        authorName: userName,
                        createdAt: serverTimestamp(),
                        viewCount: 0,
                        likeCount: 0,
                    });
                    
                    showToast("게시글이 성공적으로 등록되었습니다!", 'success');
                    setTimeout(() => window.history.back(), 1500);

                } catch (error) {
                    console.error("Error adding document: ", error);
                    showToast("게시글 등록 중 오류가 발생했습니다.", 'error');
                } finally {
                    setLoading(false);
                }
            });
        };

        // Show/hide loading state
        const setLoading = (isLoading) => {
            if (isLoading) {
                submitTextMobile.classList.add('hidden');
                submitTextDesktop.classList.add('hidden');
                submitSpinnerMobile.classList.remove('hidden');
                submitSpinnerDesktop.classList.remove('hidden');
                submitBtnMobile.disabled = true;
                submitBtnDesktop.disabled = true;
            } else {
                submitTextMobile.classList.remove('hidden');
                submitTextDesktop.classList.remove('hidden');
                submitSpinnerMobile.classList.add('hidden');
                submitSpinnerDesktop.classList.add('hidden');
                submitBtnMobile.disabled = false;
                submitBtnDesktop.disabled = false;
            }
        };

        // Toggle UI based on auth state
        const toggleUI = (isLoggedIn) => {
            if (isLoggedIn) {
                authOverlay.classList.add('hidden');
                postTitleInput.disabled = false;
                quill.enable(true);
                submitBtnMobile.disabled = false;
                submitBtnDesktop.disabled = false;
            } else {
                authOverlay.classList.remove('hidden');
                postTitleInput.disabled = true;
                quill.enable(false);
                submitBtnMobile.disabled = true;
                submitBtnDesktop.disabled = true;
            }
        };

        // Initialization and event listeners
        document.addEventListener('DOMContentLoaded', async () => {
            const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
            if (initialAuthToken) {
                try {
                    await signInWithCustomToken(auth, initialAuthToken);
                    console.log("Signed in with custom token.");
                } catch (error) {
                    console.error("Error signing in with custom token:", error);
                }
            } else {
                console.log("No custom auth token provided. Waiting for authentication.");
            }
        });

        // Auth state change listener
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                userId = user.uid;
                toggleUI(true);
                const profileDocPath = `artifacts/${appId}/users/${userId}/profile/user_data`;
                
                const profileRef = doc(db, profileDocPath);
                try {
                    const profileSnapshot = await getDoc(profileRef);
                    if (profileSnapshot.exists()) {
                        userName = profileSnapshot.data().name || "익명";
                    }
                } catch (e) {
                    console.error("Error fetching user profile:", e);
                }
            } else {
                userId = null;
                userName = "익명";
                toggleUI(false);
            }
        });

        // Event listeners
        if (submitBtnMobile) { submitBtnMobile.addEventListener('click', submitPost); }
        if (submitBtnDesktop) { submitBtnDesktop.addEventListener('click', submitPost); }
    </script>
</body>
</html>
