<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>부산남중학교 N-MATE - 글쓰기</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Inter 및 Noto Sans KR 폰트 설정 (기본 body 폰트로 유지) -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Noto+Sans+KR:wght@400;700&display=swap" rel="stylesheet">
    <!-- Lucide Icons CDN -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <!-- Firebase SDK CDN (v9.6.1로 업데이트) -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, addDoc, updateDoc, collection, serverTimestamp } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore.js";

        // 전역 변수로 Firebase 인스턴스 노출
        window.firebaseApp = initializeApp;
        window.getFirebaseAuth = getAuth;
        window.firebaseSignInAnonymously = signInAnonymously;
        window.firebaseSignInWithCustomToken = signInWithCustomToken;
        window.firebaseOnAuthStateChanged = onAuthStateChanged;
        window.getFirebaseFirestore = getFirestore;
        window.firebaseDoc = doc;
        window.firebaseGetDoc = getDoc;
        window.firebaseAddDoc = addDoc;
        window.firebaseUpdateDoc = updateDoc;
        window.firebaseCollection = collection;
        window.firebaseServerTimestamp = serverTimestamp;
    </script>
    <!-- Quill.js CSS CDN -->
    <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
    <style>
        /* Body styles for overall layout */
        body {
            font-family: 'Noto Sans KR', 'Inter', sans-serif; /* Noto Sans KR 우선 적용 */
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            display: flex;
            flex-direction: column;
            min-height: 100vh;
            background-color: #ffffff; /* Light gray background */
        }
        /* Skeleton Loader animation for loading states (kept for consistency, not directly used here) */
        .skeleton {
            animation: pulse 1.5s infinite ease-in-out;
            background: linear-gradient(-90deg, #f0f0f0 0%, #f8f8f8 50%, #f0f0f0 100%);
            background-size: 200% 100%;
        }
        @keyframes pulse {
            0% {
                background-position: -200% 0;
            }
            100% {
                background-position: 200% 0;
            }
        }
        .skeleton-text {
            height: 1em; /* Adjust as needed */
            width: 80%; /* Adjust as needed */
            margin-bottom: 0.5em;
            border-radius: 4px;
        }

        /* Main content container for centering and max-width */
        .main-content-container {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            align-items: flex-start; /* Aligns content to the left */
            max-width: 36rem; /* Max width for content (reduced from 42rem) */
            margin-left: auto;
            margin-right: auto;
            width: 100%;
            position: relative; /* For absolute positioning of dropdown menu */
            padding-bottom: 70px; /* Space for fixed bottom navigation */
        }

        /* Dropdown menu styles */
        .dropdown-menu {
            position: absolute; /* Relative to the parent with position: relative */
            background-color: white;
            border-radius: 0.5rem; /* rounded-md */
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2 px 4px -1px rgba(0, 0, 0, 0.06); /* shadow-lg */
            padding-top: 0.25rem; /* py-1 */
            padding-bottom: 0.25rem;
            min-width: 8rem; /* w-40 */
            right: 0; /* Aligns to the right of the account tab button */
            top: calc(100% + 0.5rem); /* Positions below the button with 0.5rem gap */
            z-index: 20; /* Ensures it appears above other content */
        }

        .dropdown-menu button {
            width: 100%;
            text-align: left;
            padding: 0.5rem 1rem; /* px-4 py-2 */
            font-size: 0.875rem; /* text-sm */
            color: #374151; /* text-gray-700 */
            transition: background-color 0.2s ease;
        }

        .dropdown-menu button:hover {
            background-color: #f3f4f6; /* hover:bg-gray-100 */
        }

        /* Bottom Navigation Bar Styles */
        .nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 0.5rem; /* p-2 */
            border-radius: 0.75rem; /* rounded-xl */
            transition: all 0.3s ease; /* transition-all duration-300 */
            color: #6b7280; /* text-gray-500 */
        }
        .nav-item:hover {
            color: #3b82f6; /* hover:text-blue-500 */
            background-color: #f9fafb; /* hover:bg-gray-50 */
        }
        .nav-item.active {
            color: #2563eb; /* text-blue-600 */
        }
        .nav-item.active span {
            font-weight: 700; /* font-bold */
        }
        .nav-item.active svg {
            color: #2563eb; /* text-blue-600 */
        }

        /* Quill Editor specific styles to fit Tailwind */
        /* Ensure the main editor container has proper box-sizing */
        #editor {
            box-sizing: border-box;
        }
        .ql-toolbar.ql-snow {
            border-top-left-radius: 0.5rem; /* rounded-lg */
            border-top-right-radius: 0.5rem; /* rounded-lg */
            border-color: #d1d5db; /* gray-300 */
            border-bottom: none; /* No bottom border for toolbar */
            width: 100%; /* Explicitly set width to 100% */
            box-sizing: border-box; /* Ensure padding and border are included in width */
        }
        .ql-container.ql-snow {
            border-bottom-left-radius: 0.5rem; /* rounded-lg */
            border-bottom-right-radius: 0.5rem; /* rounded-lg */
            border-color: #d1d5db; /* gray-300 */
            min-height: 12rem; /* h-48 */
            font-size: 1rem; /* default text size */
            color: #1f2937; /* gray-900 for text */
            padding: 1rem; /* p-4 */
            width: 100%; /* Explicitly set width to 100% */
            box-sizing: border-box; /* Ensure padding and border are included in width */
        }

        /* Default font for Quill editor content (now relies on body font-family) */
        .ql-editor {
            font-family: inherit; /* Inherit font from body */
        }

        /* Quill Font Families - Custom styles are no longer needed as font selection is removed */
    </style>
</head>
<body>

    <!-- Main content area -->
    <div class="main-content-container">

        <!-- Header: Logo and Account/Login section -->
        <div class="w-full flex justify-between items-center px-6 pt-4">
            <!-- Logo -->
            <div class="flex items-center">
                <img src="/image/logo.png" alt="가로형 로고" class="h-12">
            </div>

            <!-- Account/Login section with dropdown -->
            <div class="relative">
                <div id="accountStatusArea" class="flex items-center">
                    <!-- 초기 로딩 중 메시지 -->
                    <span class="text-gray-500 text-sm">계정 정보 로딩 중...</span>
                </div>
                <!-- Dropdown menu (initially hidden) -->
                <div id="accountDropdown" class="dropdown-menu hidden">
                    <button id="settingsButton" class="block">설정</button>
                    <button id="logoutButton" class="block">로그아웃</button>
                </div>
            </div>
        </div>

        <!-- Community Write Post Section Content -->
        <div class="w-full flex flex-col items-start px-6 mt-8 mb-4">
            <!-- Section title -->
            <h2 class="text-left text-xl font-bold text-gray-800 mb-4">글쓰기</h2>

            <!-- Post Title Input -->
            <input type="text" id="postTitle" placeholder="제목을 입력하세요"
                   class="w-full p-3 mb-4 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 text-gray-800">

            <!-- Category Select -->
            <select id="postCategory"
                    class="w-full p-3 mb-4 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 text-gray-800">
                <option value="">카테고리 선택</option>
                <option value="자유 게시판">자유 게시판</option>
                <option value="정보 공유">정보 공유</option>
                <option value="질문 게시판">질문 게시판</option>
            </select>

            <!-- Quill Editor Container -->
            <div id="editor" class="w-full mb-6 border border-gray-300 rounded-lg">
                <!-- Quill will initialize here -->
            </div>

            <!-- Hidden input to store Quill's HTML content before submission -->
            <input type="hidden" id="postContentHtml" name="postContentHtml">

            <!-- Policy Checkbox -->
            <div class="flex items-center mb-4">
                <input type="checkbox" id="policyCheckbox" class="mr-2 h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded">
                <label for="policyCheckbox" class="text-gray-700 text-sm">운영정책을 확인했고, 이에 동의합니다.</label>
            </div>

            <!-- Submit Button -->
            <button id="submitPostButton"
                    class="w-full bg-blue-500 hover:bg-blue-600 text-white font-semibold py-3 px-6 rounded-lg shadow-md transition duration-300 ease-in-out transform hover:scale-105">
                작성하기
            </button>
        </div>

        <!-- Placeholder for additional content -->
        <p class="text-2xl text-gray-700 px-6 mt-1"></p>
    </div>

    <!-- Bottom Navigation Bar -->
    <nav class="fixed bottom-0 left-0 right-0 bg-white p-3 border-t border-gray-300 max-w-xl mx-auto w-full z-10">
        <div class="flex justify-around items-center h-12">
            <!-- Home Navigation Item -->
            <button id="nav-home" class="nav-item flex flex-col items-center justify-center p-2 rounded-xl transition-all duration-300 text-gray-500 hover:text-blue-500 hover:bg-gray-50" data-tab="홈" data-path="/">
                <svg viewBox="0 0 24 24" fill="currentColor" class="w-6 h-6 mb-1" xmlns="http://www.w3.org/2000/svg">
                    <path d="M10 20V14H14V20H19V12H22L12 3L2 12H5V20H10Z"/>
                </svg>
                <span class="text-xs font-medium">홈</span>
            </button>

            <!-- School Life Navigation Item (consolidated) -->
            <button id="nav-school-life" class="nav-item flex flex-col items-center justify-center p-2 rounded-xl transition-all duration-300 text-gray-500 hover:text-blue-500 hover:bg-gray-50" data-tab="학교생활" data-path="/sclife/timetable">
                <svg viewBox="0 0 24 24" fill="currentColor" class="w-6 h-6 mb-1" xmlns="http://www.w3.org/2000/svg">
                    <path d="M4 19V6.5C4 5.94772 4.44772 5.5 5 5.5H19C19.5523 5.5 20 5.94772 20 6.5V19C20 19.5523 19.5523 20 19 20H5C4.44772 20 4 19.5523 4 19ZM6 17H18V7.5H6V17ZM9 10H15V12H9V10Z"/>
                </svg>
                <span class="text-xs font-medium">학교생활</span>
            </button>

            <!-- Community Navigation Item -->
            <button id="nav-community" class="nav-item flex flex-col items-center justify-center p-2 rounded-xl transition-all duration-300 text-gray-500 hover:text-blue-500 hover:bg-gray-50" data-tab="커뮤니티" data-path="/community">
                <svg viewBox="0 0 24 24" fill="currentColor" class="w-6 h-6 mb-1" xmlns="http://www.w3.org/2000/svg">
                    <path d="M16 11C18.21 11 20 9.21 20 7C20 4.79 18.21 3 16 3C13.79 3 12 4.79 12 7C12 9.21 13.79 11 16 11ZM8 11C10.21 11 12 9.21 12 7C12 4.79 10.21 3 8 3C5.79 3 4 4.79 4 7C4 9.21 5.79 11 8 11ZM16 13C13.67 13 9.34 14.28 9 17V19H23V17C22.66 14.28 18.33 13 16 13ZM8 13C5.33 13 0 14.33 0 17V19H9V17C8.67 14.33 4.33 13 8 13Z"/>
                </svg>
                <span class="text-xs font-medium">커뮤니티</span>
            </button>

            <!-- Calendar Navigation Item -->
            <button id="nav-calendar" class="nav-item flex flex-col items-center justify-center p-2 rounded-xl transition-all duration-300 text-gray-500 hover:text-blue-500 hover:bg-gray-50" data-tab="캘린더" data-path="/calendar">
                <svg viewBox="0 0 24 24" fill="currentColor" class="w-6 h-6 mb-1" xmlns="http://www.w3.org/2000/svg">
                    <path d="M19 4H18V2H16V4H8V2H6V4H5C3.89 4 3 4.9 3 6V20C3 21.1 3.89 22 5 22H19C20.1 22 21 21.1 21 20V6C21 4.9 20.1 4 19 4ZM19 20H5V9H19V20Z"/>
                </svg>
                <span class="text-xs font-medium">캘린더</span>
            </button>

            <!-- More Navigation Item -->
            <button id="nav-more" class="nav-item flex flex-col items-center justify-center p-2 rounded-xl transition-all duration-300 text-gray-500 hover:text-blue-500 hover:bg-gray-50" data-tab="더보기" data-path="/plus">
                <svg viewBox="0 0 24 24" fill="currentColor" class="w-6 h-6 mb-1" xmlns="http://www.w3.org/2000/svg">
                    <path d="M12 10C10.9 10 10 10.9 10 12C10 13.1 10.9 14 12 14C13.1 14 14 13.1 14 12C14 10.9 13.1 10 12 10ZM19 10C17.9 10 17 10.9 17 12C17 13.1 17.9 14 19 14C20.1 14 21 13.1 21 12C21 10.9 20.1 10 19 10ZM5 10C3.9 10 3 10.9 3 12C3 13.1 3.9 14 5 14C6.1 14 7 13.1 7 12C7 10.9 6.1 10 5 10Z"/>
                </svg>
                <span class="text-xs font-medium">더보기</span>
            </button>
        </div>
    </nav>

    <!-- Quill.js JavaScript CDN -->
    <script src="https://cdn.quilljs.com/1.3.6/quill.js"></script>

    <script type="module">
        // Firebase 전역 변수 참조
        const initializeApp = window.firebaseApp;
        const getAuth = window.getFirebaseAuth;
        const signInAnonymously = window.firebaseSignInAnonymously;
        const signInWithCustomToken = window.firebaseSignInWithCustomToken;
        const onAuthStateChanged = window.firebaseOnAuthStateChanged;
        const getFirestore = window.getFirebaseFirestore;
        const doc = window.firebaseDoc;
        const getDoc = window.firebaseGetDoc;
        const addDoc = window.firebaseAddDoc;
        const updateDoc = window.firebaseUpdateDoc;
        const collection = window.firebaseCollection;
        const serverTimestamp = window.firebaseServerTimestamp;

        // Global variables for Firebase configuration (provided by Canvas environment)
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');

        // Firebase app, auth, and firestore instances
        let app;
        let auth;
        let db;

        // Quill Editor instance
        let quill;

        // DOM elements
        const accountStatusArea = document.getElementById('accountStatusArea');
        const accountDropdown = document.getElementById('accountDropdown');
        const submitPostButton = document.getElementById('submitPostButton'); // Get the submit button
        const postTitleInput = document.getElementById('postTitle'); // Get the title input
        const postCategorySelect = document.getElementById('postCategory'); // Get the category select
        const policyCheckbox = document.getElementById('policyCheckbox'); // Get the policy checkbox
        const postContentHtmlInput = document.getElementById('postContentHtml'); // Hidden input for HTML content

        // Allowed font sizes for Quill editor (remains for size buttons if needed)
        const allowedFontSizes = ['12px', '14px', '16px', '18px', '20px', '24px', '32px'];

        // Store post ID if editing an existing post
        let currentPostId = null;

        /**
         * Toggles the visibility of the account dropdown menu.
         */
        function toggleDropdown() {
            accountDropdown.classList.toggle('hidden');
        }

        /**
         * Handles user logout.
         */
        async function handleLogout() {
            if (auth) {
                try {
                    await auth.signOut();
                    console.log('로그아웃 성공.');
                    window.location.href = '/login';
                } catch (error) {
                    console.error('로그아웃 오류:', error);
                }
            }
        }

        /**
         * Handles navigation to the settings page.
         */
        function handleSettingsClick() {
            window.location.href = '/settings';
        }

        /**
         * Updates the account UI based on user authentication status.
         * Displays email prefix if logged in, otherwise "로그인" button.
         * @param {firebase.User} user - The authenticated user object or null.
         */
        async function updateAccountUI(user) {
            if (user && user.email) { // Check if a user is logged in and has an email
                const emailPrefix = user.email.split('@')[0];
                accountStatusArea.innerHTML = `
                    <button id="accountTabButton" class="flex items-center space-x-2 p-2 rounded-full hover:bg-gray-100 focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <span class="text-gray-700 text-sm font-medium">${emailPrefix}</span>
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-user-circle-2"><path d="M18 20a6 6 0 0 0-12 0"/><circle cx="12" cy="10" r="4"/><circle cx="12" cy="12" r="10"/></svg>
                    </button>
                `;
                document.getElementById('accountTabButton').addEventListener('click', toggleDropdown);

                // Attach event listeners for dropdown buttons
                const settingsButton = document.getElementById('settingsButton');
                if (settingsButton && !settingsButton.dataset.listenerAdded) {
                    settingsButton.addEventListener('click', handleSettingsClick);
                    settingsButton.dataset.listenerAdded = 'true';
                }
                const logoutButton = document.getElementById('logoutButton');
                if (logoutButton && !logoutButton.dataset.listenerAdded) {
                    logoutButton.addEventListener('click', handleLogout);
                    logoutButton.dataset.listenerAdded = 'true';
                }

            } else {
                // User is logged out or does not have an email (e.g., anonymous, but we don't use it now)
                accountStatusArea.innerHTML = `
                    <button id="loginRedirectButton" class="bg-blue-500 hover:bg-blue-600 text-white font-medium py-2 px-4 rounded-full shadow transition duration-300">
                        로그인
                    </button>
                `;
                document.getElementById('loginRedirectButton').addEventListener('click', () => {
                    window.location.href = '/login';
                });
                accountDropdown.classList.add('hidden'); // Hide dropdown if no user or email
            }
            lucide.createIcons(); // Refresh Lucide icons
        }

        /**
         * Updates the active state of the navigation bar buttons based on the current URL path.
         */
        function updateNavigationActiveState() {
            const currentPath = window.location.pathname;
            const navItems = document.querySelectorAll('.nav-item');

            navItems.forEach(item => {
                const itemPath = item.dataset.path;
                const spanElement = item.querySelector('span');
                const svgElement = item.querySelector('svg');

                // Reset classes
                item.classList.remove('text-blue-600');
                item.classList.add('text-gray-500', 'hover:text-blue-500', 'hover:bg-gray-50');
                if (spanElement) {
                    spanElement.classList.remove('font-bold');
                    spanElement.classList.add('font-medium');
                }
                if (svgElement) {
                    svgElement.classList.remove('text-blue-600');
                    svgElement.classList.add('text-gray-500'); // Ensure SVG also has gray base color
                }

                // Check for exact path match or if it's the community button and current path is within /community or /write section
                if (currentPath === itemPath || (item.id === 'nav-community' && (currentPath.startsWith('/community') || currentPath.startsWith('/write')))) {
                    item.classList.add('text-blue-600');
                    item.classList.remove('text-gray-500', 'hover:text-blue-500', 'hover:bg-gray-50');
                    if (spanElement) {
                        spanElement.classList.add('font-bold');
                        spanElement.classList.remove('font-medium');
                    }
                    if (svgElement) {
                        svgElement.classList.add('text-blue-600');
                        svgElement.classList.remove('text-gray-500');
                    }
                } else if (item.id === 'nav-school-life' && currentPath.startsWith('/sclife')) {
                    // Specific handling for school life tab if the current path is /sclife or a sub-path
                    item.classList.add('text-blue-600');
                    item.classList.remove('text-gray-500', 'hover:text-blue-500', 'hover:bg-gray-50');
                    if (spanElement) {
                        spanElement.classList.add('font-bold');
                        spanElement.classList.remove('font-medium');
                    }
                    if (svgElement) {
                        svgElement.classList.add('text-blue-600');
                        svgElement.classList.remove('text-gray-500');
                    }
                }
            });
        }

        /**
         * Sets up click event listeners for navigation items.
         */
        function setupNavigationEvents() {
            const navItems = document.querySelectorAll('.nav-item');
            navItems.forEach(item => {
                item.addEventListener('click', () => {
                    const path = item.dataset.path;
                    const currentPathname = window.location.pathname;

                    // If the target path is different from the current path, navigate.
                    if (currentPathname !== path) {
                        // Special handling for School Life button to set initial tab in localStorage
                        if (item.id === 'nav-school-life') {
                            localStorage.setItem('initialSchoolLifeTab', 'timetableContent');
                        } else {
                            localStorage.removeItem('initialSchoolLifeTab');
                        }
                        window.location.href = path;
                    }
                });
            });
        }

        /**
         * Increases the font size in the Quill editor.
         */
        function increaseFontSize() {
            if (!quill) return;

            const range = quill.getSelection(true);
            if (!range) return;

            let currentSize = 16; // Default to 16px
            const format = quill.getFormat(range.index, range.length);

            if (format && typeof format.size === 'string' && format.size.endsWith('px')) {
                currentSize = parseInt(format.size.replace('px', ''));
            } else if (range.length === 0) { // If no explicit format on selection, check current line format
                const lineFormat = quill.getFormat(); // Get format at current cursor position
                if (lineFormat && typeof lineFormat.size === 'string' && lineFormat.size.endsWith('px')) {
                    currentSize = parseInt(lineFormat.size.replace('px', ''));
                }
            }

            const currentIndex = allowedFontSizes.indexOf(currentSize + 'px');
            if (currentIndex !== -1 && currentIndex < allowedFontSizes.length - 1) {
                const newSize = allowedFontSizes[currentIndex + 1];
                quill.format('size', newSize, Quill.sources.USER);
            } else if (currentIndex === -1) {
                // If current size is not in whitelist, try to find the closest greater size or just use the smallest allowed
                let foundIndex = allowedFontSizes.findIndex(s => parseInt(s.replace('px', '')) > currentSize);
                if (foundIndex !== -1) {
                    quill.format('size', allowedFontSizes[foundIndex], Quill.sources.USER);
                } else if (allowedFontSizes.length > 0) {
                    // If no larger size found, and current size is outside whitelist, default to largest
                    quill.format('size', allowedFontSizes[allowedFontSizes.length - 1], Quill.sources.USER);
                }
            }
        }

        /**
         * Decreases the font size in the Quill editor.
         */
        function decreaseFontSize() {
            if (!quill) return;

            const range = quill.getSelection(true);
            if (!range) return;

            let currentSize = 16; // Default to 16px
            const format = quill.getFormat(range.index, range.length);

            if (format && typeof format.size === 'string' && format.size.endsWith('px')) {
                currentSize = parseInt(format.size.replace('px', ''));
            } else if (range.length === 0) { // If no explicit format on selection, check current line format
                const lineFormat = quill.getFormat(); // Get format at current cursor position
                if (lineFormat && typeof lineFormat.size === 'string' && lineFormat.size.endsWith('px')) {
                    currentSize = parseInt(lineFormat.size.replace('px', ''));
                }
            }

            const currentIndex = allowedFontSizes.indexOf(currentSize + 'px');
            if (currentIndex !== -1 && currentIndex > 0) {
                const newSize = allowedFontSizes[currentIndex - 1];
                quill.format('size', newSize, Quill.sources.USER);
            } else if (currentIndex === -1) {
                // If current size is not in whitelist, try to find the closest smaller size or just use the largest allowed
                let foundIndex = allowedFontSizes.slice().reverse().findIndex(s => parseInt(s.replace('px', '')) < currentSize);
                if (foundIndex !== -1) {
                    quill.format('size', allowedFontSizes[allowedFontSizes.length - 1 - foundIndex], Quill.sources.USER);
                } else if (allowedFontSizes.length > 0) {
                    // If no smaller size found, and current size is outside whitelist, default to smallest
                    quill.format('size', allowedFontSizes[0], Quill.sources.USER);
                }
            }
        }

        /**
         * Handles local image selection and converts it to Base64 for insertion into Quill.
         */
        function selectLocalImage() {
            const input = document.createElement('input');
            input.setAttribute('type', 'file');
            input.setAttribute('accept', 'image/*'); // Only accept image files
            input.click(); // Programmatically click the file input to open the file dialog

            input.onchange = () => {
                const file = input.files[0];
                if (file) {
                    // Basic file size validation (5MB for Base64 to prevent immediate Firestore limits for single image)
                    // Note: Multiple small images can still exceed the 1MB Firestore document limit.
                    if (file.size > 5 * 1024 * 1024) {
                        showMessageBox('이미지 파일 크기가 너무 큽니다. 5MB 이하의 파일을 선택해주세요.');
                        return;
                    }

                    const reader = new FileReader();
                    reader.onload = (e) => {
                        const imageUrl = e.target.result; // This is the Base64 data URL
                        const range = quill.getSelection(true); // Get current cursor position or selection

                        if (range) {
                            // Insert the Base64 image at the current cursor position
                            quill.insertEmbed(range.index, 'image', imageUrl, Quill.sources.USER);
                            // Move cursor after the inserted image
                            quill.setSelection(range.index + 1, Quill.sources.SILENT);
                        } else {
                            // If no selection, insert at the end of the content
                            quill.insertEmbed(quill.getLength(), 'image', imageUrl, Quill.sources.USER);
                            quill.setSelection(quill.getLength(), Quill.sources.SILENT);
                        }
                    };
                    reader.onerror = (error) => {
                        console.error('파일 읽기 오류:', error);
                        showMessageBox('이미지 파일을 읽는 중 오류가 발생했습니다.');
                    };
                    reader.readAsDataURL(file); // Read the file as a Base64 data URL
                }
            };
        }

        /**
         * Loads post data into the form for editing.
         * @param {string} postIdToLoad - The ID of the post to load.
         */
        async function loadPostForEdit(postIdToLoad) {
            try {
                const postRef = doc(db, 'artifacts', appId, 'public', 'posts', postIdToLoad);
                const postSnap = await getDoc(postRef);

                if (postSnap.exists()) {
                    const postData = postSnap.data();
                    // Check if the current user is the author of the post
                    if (auth.currentUser && auth.currentUser.uid === postData.authorUid) {
                        postTitleInput.value = postData.title || '';
                        postCategorySelect.value = postData.category || '';
                        quill.root.innerHTML = postData.contentHtml || ''; // Set Quill content
                        submitPostButton.textContent = '게시물 수정'; // Change button text
                        document.querySelector('h2').textContent = '게시물 수정'; // Change section title
                        currentPostId = postIdToLoad; // Store post ID for update
                    } else {
                        showMessageBox('이 게시물을 수정할 권한이 없습니다.');
                        window.location.href = `/view/${postIdToLoad}`; // Redirect to view page
                    }
                } else {
                    showMessageBox('수정할 게시물을 찾을 수 없습니다.');
                    window.location.href = '/community'; // Redirect if post not found
                }
            } catch (error) {
                console.error('게시물 로드 오류:', error);
                showMessageBox('게시물 로드 중 오류가 발생했습니다: ' + error.message);
            }
        }

        document.addEventListener('DOMContentLoaded', async () => {
            // 초기 계정 로딩 메시지 표시
            accountStatusArea.innerHTML = `<span class="text-gray-500 text-sm">계정 정보 로딩 중...</span>`;

            // Firebase initialization
            if (firebaseConfig && firebaseConfig.apiKey) {
                if (!app) { // 앱이 초기화되지 않았다면 초기화
                    try {
                        app = initializeApp(firebaseConfig);
                        auth = getAuth(app);
                        db = getFirestore(app);
                        console.log('Firebase 앱, 인증, Firestore 초기화 성공.');

                        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
                        if (initialAuthToken) {
                            try {
                                await signInWithCustomToken(auth, initialAuthToken);
                                console.log('Custom token을 사용하여 로그인 성공.');
                            } catch (error) {
                                console.error('Custom token 로그인 실패:', error);
                                // 커스텀 토큰 실패 시 익명 로그인 시도
                                try {
                                    await signInAnonymously(auth);
                                    console.log('익명 로그인 성공.');
                                } catch (anonError) {
                                    console.error('익명 로그인 실패:', anonError);
                                }
                            }
                        } else {
                            // 초기 토큰이 없다면 익명 로그인 시도
                            try {
                                await signInAnonymously(auth);
                                console.log('익명 로그인 성공.');
                            } catch (error) {
                                console.error('익명 로그인 실패:', error);
                            }
                        }

                        // IMPORTANT: onAuthStateChanged 리스너에만 의존하여 UI 업데이트
                        onAuthStateChanged(auth, async (user) => {
                            await updateAccountUI(user);
                            // 페이지 특정 로직: 글쓰기 페이지에서 로그인 상태 확인
                            if (window.location.pathname === '/write' && !user) {
                                showMessageBox('로그인해야 글을 작성할 수 있습니다.');
                                window.location.href = '/login';
                            }
                        });

                    } catch (error) {
                        console.error('Firebase 초기화 실패:', error);
                        await updateAccountUI(null); // 초기화 실패 시에도 UI를 로그아웃 상태로 업데이트
                        if (window.location.pathname === '/write') {
                            showMessageBox('Firebase 초기화에 실패했습니다. 글쓰기 기능을 사용할 수 없습니다. 관리자에게 문의하세요.');
                        }
                    }
                } else { // 앱이 이미 초기화되었다면 (예: SPA 탐색 또는 핫 리로드)
                    // 기존 인스턴스 가져오기
                    auth = getAuth(app);
                    db = getFirestore(app);
                    console.log('Firebase 앱이 이미 초기화되었습니다. 기존 인스턴스를 사용합니다.');

                    // 이미 초기화된 상태이므로 onAuthStateChanged 리스너만 다시 연결
                    // onAuthStateChanged는 현재 인증 상태를 즉시 보고할 것임
                    onAuthStateChanged(auth, async (user) => {
                        await updateAccountUI(user);
                        // 페이지 특정 로직: 글쓰기 페이지에서 로그인 상태 확인
                        if (window.location.pathname === '/write' && !user) {
                            showMessageBox('로그인해야 글을 작성할 수 있습니다.');
                            window.location.href = '/login';
                        }
                    });
                }
            } else {
                console.warn('Firebase 구성이 제대로 제공되지 않았습니다. Firebase를 초기화할 수 없습니다.');
                await updateAccountUI(null); // 구성이 없을 시에도 UI 업데이트
                if (window.location.pathname === '/write') {
                    showMessageBox('Firebase 구성이 누락되었습니다. 글쓰기 기능을 사용할 수 없습니다.');
                }
            }

            // Define custom sizes for Quill editor
            const Size = Quill.import('attributors/style/size');
            Size.whitelist = allowedFontSizes; // Use the globally defined allowedFontSizes array
            Quill.register(Size, true);

            const toolbarOptions = [
                ['bold', 'italic', 'underline', 'strike'],        // 볼드, 기울임꼴, 밑줄, 취소선
                ['image'],                                        // 이미지 삽입
                [{ 'list': 'ordered'}, { 'list': 'bullet' }],     // 순서 있는 리스트, 순서 없는 리스트
                [{ 'align': [] }],                                // 텍스트 정렬
                [{ 'color': [] }, { 'background': [] }],          // 텍스트 색상, 배경 색상
                ['clean']                                         // 서식 지우기
            ];

            quill = new Quill('#editor', {
                theme: 'snow',
                placeholder: '내용을 입력하세요',
                modules: {
                    toolbar: {
                        container: toolbarOptions,
                        handlers: {
                            // Custom handler for image button
                            'image': () => {
                                selectLocalImage();
                            }
                        }
                    }
                }
            });

            // Dynamically add font size adjustment buttons to the toolbar
            const toolbar = quill.getModule('toolbar');
            const firstFormatsGroup = toolbar.container.querySelector('.ql-formats');
            if (firstFormatsGroup) { // Ensure there's at least one ql-formats group
                const sizeControlsContainer = document.createElement('span');
                sizeControlsContainer.classList.add('ql-formats'); // Use ql-formats to group buttons
                sizeControlsContainer.innerHTML = `
                    <button type="button" class="ql-font-size-decrease">
                        <svg viewBox="0 0 18 18"> <line class="ql-stroke" x1="5" x2="13" y1="9" y2="9"></line> </svg>
                    </button>
                    <button type="button" class="ql-font-size-increase">
                        <svg viewBox="0 0 18 18"> <line class="ql-stroke" x1="5" x2="13" y1="9" y2="9"></line> <line class="ql-stroke" x1="9" x2="9" y1="5" y2="13"></line> </svg>
                    </button>
                `;
                toolbar.container.insertBefore(sizeControlsContainer, firstFormatsGroup);

                sizeControlsContainer.querySelector('.ql-font-size-decrease').addEventListener('click', decreaseFontSize);
                sizeControlsContainer.querySelector('.ql-font-size-increase').addEventListener('click', increaseFontSize);
            }

            // Check if we are editing an existing post
            const urlParams = new URLSearchParams(window.location.search);
            const postIdFromUrl = urlParams.get('postId');
            if (postIdFromUrl) {
                await loadPostForEdit(postIdFromUrl);
            }

            // Handle submit button click
            submitPostButton.addEventListener('click', async () => {
                const title = postTitleInput.value.trim();
                const category = postCategorySelect.value;
                const contentHtml = quill.root.innerHTML; // Get Quill editor content as HTML
                const contentText = quill.getText().trim(); // Get plain text for validation

                // Validate inputs
                if (!auth.currentUser) {
                    showMessageBox('로그인해야 글을 작성하거나 수정할 수 있습니다.');
                    window.location.href = '/login';
                    return;
                }
                if (title === '') {
                    showMessageBox('제목을 입력해주세요.');
                    return;
                }
                if (category === '') {
                    showMessageBox('카테고리를 선택해주세요.');
                    return;
                }
                if (contentText === '' || contentText === '내용을 입력하세요') { // Add check for placeholder text
                    showMessageBox('내용을 입력해주세요.');
                    return;
                }
                if (!policyCheckbox.checked) {
                    showMessageBox('운영정책 확인에 동의해주세요.');
                    return;
                }

                try {
                    const postData = {
                        title: title,
                        category: category,
                        contentHtml: contentHtml,
                        authorUid: auth.currentUser.uid,
                        authorEmail: auth.currentUser.email,
                        updatedAt: serverTimestamp() // Update timestamp on every save
                    };

                    if (currentPostId) {
                        // Update existing post
                        await updateDoc(doc(db, 'artifacts', appId, 'public', 'posts', currentPostId), postData);
                        showMessageBox('게시물이 성공적으로 수정되었습니다!');
                        window.location.href = `/view/${currentPostId}`; // Redirect to updated post with new URL format
                    } else {
                        // Create new post
                        postData.createdAt = serverTimestamp(); // Set creation timestamp only for new posts
                        postData.likes = 0;
                        postData.views = 0;
                        const docRef = await addDoc(collection(db, 'artifacts', appId, 'public', 'posts'), postData);
                        showMessageBox('게시물이 성공적으로 작성되었습니다!');
                        window.location.href = `/view/${docRef.id}`; // Redirect to newly created post with new URL format
                    }

                    // Clear form after successful submission (if creating new)
                    if (!currentPostId) {
                        postTitleInput.value = '';
                        postCategorySelect.value = '';
                        policyCheckbox.checked = false;
                        quill.setContents([]); // Clears the editor
                    }

                } catch (error) {
                    console.error('게시물 작성/수정 오류:', error);
                    // Check for Firestore specific errors like document size limit
                    if (error.code === 'resource-exhausted' || error.message.includes('Document exceeds maximum size')) {
                        showMessageBox('게시물 크기가 너무 큽니다. 이미지 수를 줄이거나 이미지 크기를 조정해주세요.');
                    } else {
                        showMessageBox('게시물 작성/수정 중 오류가 발생했습니다: ' + error.message);
                    }
                }
            });

            /**
             * Displays a custom message box.
             * Replaces native alert() for better UI control in an iframe environment.
             * @param {string} message - The message to display.
             */
            function showMessageBox(message) {
                const messageBox = document.createElement('div');
                messageBox.classList.add('fixed', 'inset-0', 'flex', 'items-center', 'justify-center', 'bg-black', 'bg-opacity-50', 'z-50');
                messageBox.innerHTML = `
                    <div class="bg-white p-6 rounded-lg shadow-xl max-w-sm w-full mx-4 text-center">
                        <p class="text-gray-800 text-lg mb-4">${message}</p>
                        <button id="messageBoxClose" class="bg-blue-500 hover:bg-blue-600 text-white font-semibold py-2 px-4 rounded-md transition duration-300">확인</button>
                    </div>
                `;
                document.body.appendChild(messageBox);

                document.getElementById('messageBoxClose').addEventListener('click', () => {
                    document.body.removeChild(messageBox);
                });
            }

            // Global click listener to close dropdown when clicking outside
            window.addEventListener('click', function(e) {
                const accountTabButton = document.getElementById('accountTabButton');
                if (accountTabButton && !accountTabButton.contains(e.target) && !accountDropdown.contains(e.target)) {
                    accountDropdown.classList.add('hidden');
                }
            });

            // Setup navigation click handlers
            setupNavigationEvents();
            // Update navigation active state on initial load
            updateNavigationActiveState();

            // Initial icon creation
            lucide.createIcons();
        });
    </script>
</body>
</html>
