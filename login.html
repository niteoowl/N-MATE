<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>N-MATE 로그인</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts Material Symbols -->
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@24,400,0,0" />
    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // 전역 변수로 Firebase 서비스 인스턴스를 저장합니다.
        window.firebase = {};
        window.firebase.getAuth = getAuth;
        window.firebase.signInWithEmailAndPassword = signInWithEmailAndPassword;
        window.firebase.createUserWithEmailAndPassword = createUserWithEmailAndPassword;
        window.firebase.getFirestore = getFirestore;
        window.firebase.doc = doc;
        window.firebase.setDoc = setDoc;

        // 제공된 Firebase 설정을 사용하거나 전역 변수에서 가져옵니다.
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {
            apiKey: "AIzaSyC_SHRcQ9hXmjVbP3km4rdR4UvKIoqpLHo",
            authDomain: "n-mate.firebaseapp.com",
            projectId: "n-mate",
            storageBucket: "n-mate.firebasestorage.app",
            messagingSenderId: "691313471077",
            appId: "1:691313471077:web:3066aaeca0a1d9e448e08c",
            measurementId: "G-0LCGVBKXLQ"
        };
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        // Firebase 앱 초기화
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // 전역 변수에 인스턴스를 저장하여 다른 스크립트에서 접근할 수 있게 합니다.
        window.firebase.app = app;
        window.firebase.auth = auth;
        window.firebase.db = db;
        window.firebase.appId = appId;
        window.firebase.initialAuthToken = initialAuthToken;

        // 커스텀 토큰이 제공되면 로그인 시도
        if (initialAuthToken) {
            signInWithCustomToken(auth, initialAuthToken).catch((error) => {
                console.error("Custom token login failed", error);
            });
        }
    </script>
    <style>
        /* CSS 변수를 사용하여 색상을 정의합니다. */
        :root {
            --bg-primary: #121212;
            --bg-secondary: #1F1F1F;
            --text-primary: #E0E0E0;
            --text-secondary: #A0A0A0;
            --color-blue: #007BFF;
            --border-color: #333333;
            --checkbox-border: #4a4a4a;
            --overlay-bg: rgba(0, 0, 0, 0.7);
        }

        /* wanted-sans 폰트를 로드합니다. */
        @import url('https://fastly.jsdelivr.dev/gh/wanteddev/wanted-sans@v1.0.1/packages/wanted-sans/fonts/webfonts/variable/split/WantedSansVariable.min.css');
        
        body {
            font-family: 'WantedSansVariable', sans-serif;
            background-color: var(--bg-primary);
            color: var(--text-primary);
        }

        /* 입력 필드에 포커스 시 테두리 색상 변경 */
        input:focus {
            outline: none;
            border-color: var(--color-blue);
        }
        
        select:focus {
            outline: none;
            border-color: var(--color-blue);
        }

        /* 단계별 컨테이너를 상대 위치로 설정하고, 넘치는 내용을 숨깁니다. */
        .steps-container {
            position: relative;
            flex-grow: 1;
        }

        /* 각 단계에 대한 기본 스타일. 애니메이션 효과를 모두 제거했습니다. */
        .step-content {
            display: none;
            flex-direction: column;
            padding: 1rem;
            width: 100%;
            height: 100%;
        }

        /* 현재 활성화된 단계 */
        .step-content.is-active {
            display: flex;
        }
        
        /* 커스텀 체크박스 스타일 */
        .custom-checkbox {
            position: relative;
            cursor: pointer;
            width: 24px;
            height: 24px;
            border: 2px solid var(--checkbox-border);
            border-radius: 8px;
            transition: all 0.2s;
        }
        .custom-checkbox input {
            position: absolute;
            opacity: 0;
            cursor: pointer;
            height: 0;
            width: 0;
        }
        .custom-checkbox svg {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) scale(0);
            transition: transform 0.2s;
            color: white;
        }
        .custom-checkbox input:checked ~ .checkmark {
            background-color: var(--color-blue);
            border-color: var(--color-blue);
        }
        .custom-checkbox input:checked ~ svg {
            transform: translate(-50%, -50%) scale(1);
        }
        
        /* 로딩 오버레이 스타일 */
        #loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: var(--overlay-bg);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 100;
        }

        /* 로딩 스피너 스타일 */
        .spinner {
            border: 4px solid rgba(255, 255, 255, 0.1);
            width: 36px;
            height: 36px;
            border-radius: 50%;
            border-left-color: var(--color-blue);
            animation: spin 1s ease infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* 메시지 박스 스타일 */
        #message-box {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: var(--bg-secondary);
            color: var(--text-primary);
            padding: 2rem;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.25);
            z-index: 101;
            display: none;
            flex-direction: column;
            text-align: center;
            max-width: 90%;
        }

        #message-box-close {
            background-color: var(--color-blue);
            color: white;
            padding: 0.75rem 1.5rem;
            border-radius: 9999px;
            margin-top: 1.5rem;
            font-weight: bold;
            cursor: pointer;
        }
    </style>
</head>
<body class="bg-[--bg-primary] text-[--text-primary] flex flex-col min-h-screen">

    <!-- 로딩 오버레이 -->
    <div id="loading-overlay">
        <div class="spinner"></div>
    </div>

    <!-- 메시지 박스 -->
    <div id="message-box">
        <p id="message-box-text" class="text-lg font-bold"></p>
        <button id="message-box-close">확인</button>
    </div>

    <!-- 메인 컨테이너 -->
    <div class="container mx-auto p-4 md:p-8 max-w-screen-sm flex-grow">
        
        <!-- 헤더: 뒤로 가기 및 닫기 버튼만 남겼습니다. -->
        <header class="flex items-center justify-between py-4">
            <button id="back-button" class="text-[--text-secondary] hover:text-[--text-primary] hidden">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-chevron-left"><path d="m15 18-6-6 6-6"/></svg>
            </button>
            <div class="flex-grow"></div> <!-- 버튼을 양 끝에 배치하기 위한 빈 공간 -->
            <button class="text-[--text-secondary] hover:text-[--text-primary]">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-x"><path d="M18 6 6 18"/><path d="m6 6 12 12"/></svg>
            </button>
        </header>

        <!-- 단계별 컨테이너 -->
        <main class="flex flex-col justify-center flex-grow p-4">
            <div class="steps-container">

                <!-- Step 0: 환영 화면 -->
                <div id="step-0" class="step-content">
                    <div class="text-left">
                        <h1 class="text-3xl font-bold mb-2">N-MATE 3.0에 오신 걸 환영해요!</h1>
                        <p class="text-[--text-secondary]">로그인하면 다음과 같은 기능을 사용할 수 있어요.</p>
                    </div>
                    <!-- 기능 목록 -->
                    <ul class="space-y-4 mt-8">
                        <li class="flex items-start space-x-3">
                            <span class="material-symbols-outlined text-[--color-blue] mt-1">calendar_month</span>
                            <div>
                                <p class="font-bold">스마트한 시간표 관리</p>
                                <p class="text-[--text-secondary] text-sm">급식, 시간표, 시험까지 한눈에!</p>
                            </div>
                        </li>
                        <li class="flex items-start space-x-3">
                            <span class="material-symbols-outlined text-[--color-blue] mt-1">group</span>
                            <div>
                                <p class="font-bold">우리 학교 커뮤니티</p>
                                <p class="text-[--text-secondary] text-sm">친구들과 자유롭게 소통하고 정보 공유!</p>
                            </div>
                        </li>
                        <li class="flex items-start space-x-3">
                            <span class="material-symbols-outlined text-[--color-blue] mt-1">lightbulb</span>
                            <div>
                                <p class="font-bold">맞춤형 학습 정보</p>
                                <p class="text-[--text-secondary] text-sm">나에게 필요한 정보만 쏙쏙!</p>
                            </div>
                        </li>
                    </ul>
                </div>

                <!-- Step 1: 로그인/회원가입 선택 -->
                <div id="step-1" class="step-content">
                    <div class="text-left">
                        <h1 class="text-3xl font-bold mb-2">계정이 있으신가요?</h1>
                        <p class="text-[--text-secondary]">아래에서 선택해주세요.</p>
                    </div>
                    <div class="mt-8 flex flex-col space-y-4">
                         <!-- 로그인 버튼 -->
                         <button id="to-login-button" class="bg-[--color-blue] text-white font-bold py-4 rounded-full shadow-lg hover:bg-blue-600 transition-colors duration-200">
                             네, 계속할게요
                         </button>
                         <!-- 회원가입 버튼 -->
                         <button id="to-signup-button" class="bg-transparent border-2 border-[--color-blue] text-[--color-blue] font-bold py-4 rounded-full shadow-lg hover:bg-blue-900 transition-colors duration-200">
                             아니요, 생성할게요
                         </button>
                    </div>
                </div>
                
                <!-- Step 2: 로그인 - 이메일 또는 전화번호 입력 -->
                <div id="step-2" class="step-content">
                    <div class="text-left">
                        <h1 class="text-3xl font-bold mb-2">로그인</h1>
                        <p class="text-[--text-secondary]">이메일 또는 전화번호를 입력해주세요.</p>
                    </div>
                    <div class="mt-8">
                        <input type="text" id="login-email-input" placeholder="이메일 또는 전화번호" class="w-full bg-transparent border-b-2 border-[--border-color] text-lg py-2 focus:border-[--color-blue] transition-colors duration-200">
                    </div>
                </div>

                <!-- Step 3: 로그인 - 비밀번호 입력 -->
                <div id="step-3" class="step-content">
                    <div class="text-left">
                        <h1 class="text-3xl font-bold mb-2">비밀번호를 입력해주세요</h1>
                        <p class="text-[--text-secondary]"><span id="login-user-identifier" class="text-[--text-primary] font-medium"></span>에 대한</p>
                    </div>
                    <div class="mt-8">
                        <input type="password" id="login-password-input" placeholder="비밀번호" class="w-full bg-transparent border-b-2 border-[--border-color] text-lg py-2 focus:border-[--color-blue] transition-colors duration-200">
                    </div>
                </div>

                <!-- Step 4: 회원가입 - 이름, 이메일, 전화번호 입력 -->
                <div id="step-4" class="step-content">
                    <div class="text-left">
                        <h1 class="text-3xl font-bold mb-2">회원가입</h1>
                        <p class="text-[--text-secondary]">기본 정보를 입력해주세요.</p>
                    </div>
                    <div class="mt-8 space-y-6">
                        <input type="text" id="signup-name-input" placeholder="이름" class="w-full bg-transparent border-b-2 border-[--border-color] text-lg py-2 focus:border-[--color-blue] transition-colors duration-200">
                        <input type="text" id="signup-email-input" placeholder="이메일 (예: user@example.com)" class="w-full bg-transparent border-b-2 border-[--border-color] text-lg py-2 focus:border-[--color-blue] transition-colors duration-200">
                    </div>
                </div>

                <!-- Step 5: 회원가입 - 비밀번호 설정 -->
                <div id="step-5" class="step-content">
                    <div class="text-left">
                        <h1 class="text-3xl font-bold mb-2">비밀번호 설정</h1>
                        <p class="text-[--text-secondary]">사용하실 비밀번호를 입력해주세요.</p>
                    </div>
                    <div class="mt-8 space-y-6">
                        <input type="password" id="signup-password-input" placeholder="비밀번호 (8자 이상)" class="w-full bg-transparent border-b-2 border-[--border-color] text-lg py-2 focus:border-[--color-blue] transition-colors duration-200">
                        <input type="password" id="signup-password-confirm-input" placeholder="비밀번호 확인" class="w-full bg-transparent border-b-2 border-[--border-color] text-lg py-2 focus:border-[--color-blue] transition-colors duration-200">
                    </div>
                </div>
                
                <!-- Step 6: 이용약관 및 개인정보 동의 -->
                <div id="step-6" class="step-content">
                    <div class="text-left">
                        <h1 class="text-3xl font-bold mb-2">약관에 동의해주세요</h1>
                        <p class="text-[--text-secondary]">N-MATE 서비스 이용을 위해 동의가 필요해요.</p>
                    </div>
                    <div class="mt-8 space-y-4">
                        <!-- 전체 동의 -->
                        <div class="flex items-center justify-between p-4 bg-[--bg-secondary] rounded-xl">
                            <label for="all-agree-checkbox" class="flex items-center space-x-4 flex-grow cursor-pointer">
                                <span class="custom-checkbox flex-shrink-0">
                                    <input type="checkbox" id="all-agree-checkbox">
                                    <svg class="checkmark" width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                        <path d="M5 13L9 17L19 7" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"/>
                                    </svg>
                                </span>
                                <span class="text-lg font-bold text-[--text-primary]">전체 동의</span>
                            </label>
                        </div>
                        
                        <!-- 구분선 -->
                        <div class="border-t border-[--border-color] my-4"></div>

                        <!-- 개별 약관 동의 목록 -->
                        <div class="space-y-4">
                            <!-- 이용약관 동의 (필수) -->
                            <div class="flex items-center justify-between">
                                <label for="tos-checkbox" class="flex items-center space-x-4 flex-grow cursor-pointer">
                                    <span class="custom-checkbox flex-shrink-0">
                                        <input type="checkbox" id="tos-checkbox" class="required">
                                        <svg class="checkmark" width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                            <path d="M5 13L9 17L19 7" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"/>
                                        </svg>
                                    </span>
                                    <span class="text-sm text-[--text-secondary]">(필수) N-MATE 이용약관</span>
                                </label>
                                <a href="#" class="text-[--text-secondary] text-xs hover:underline">자세히 보기</a>
                            </div>

                            <!-- 개인정보처리방침 동의 (필수) -->
                            <div class="flex items-center justify-between">
                                <label for="privacy-checkbox" class="flex items-center space-x-4 flex-grow cursor-pointer">
                                    <span class="custom-checkbox flex-shrink-0">
                                        <input type="checkbox" id="privacy-checkbox" class="required">
                                        <svg class="checkmark" width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                            <path d="M5 13L9 17L19 7" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"/>
                                        </svg>
                                    </span>
                                    <span class="text-sm text-[--text-secondary]">(필수) 개인정보처리방침</span>
                                </label>
                                <a href="#" class="text-[--text-secondary] text-xs hover:underline">자세히 보기</a>
                            </div>

                            <!-- 마케팅 수신 동의 (선택) -->
                            <div class="flex items-center justify-between">
                                <label for="marketing-checkbox" class="flex items-center space-x-4 flex-grow cursor-pointer">
                                    <span class="custom-checkbox flex-shrink-0">
                                        <input type="checkbox" id="marketing-checkbox">
                                        <svg class="checkmark" width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                            <path d="M5 13L9 17L19 7" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"/>
                                        </svg>
                                    </span>
                                    <span class="text-sm text-[--text-secondary]">(선택) 마케팅 정보 수신 동의</span>
                                </label>
                                <a href="#" class="text-[--text-secondary] text-xs hover:underline">자세히 보기</a>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Step 7: 학교 정보 등록 -->
                <div id="step-7" class="step-content">
                    <div class="text-left">
                        <h1 class="text-3xl font-bold mb-2">학교를 등록해주세요</h1>
                        <p class="text-[--text-secondary]">학교 정보를 등록해야 서비스 이용이 가능해요.</p>
                    </div>
                    <div class="mt-8 space-y-6">
                        <!-- 학교 검색 입력창 -->
                        <div class="relative">
                            <input type="text" id="school-search-input" placeholder="학교 검색" class="w-full bg-transparent border-b-2 border-[--border-color] text-lg py-2 focus:border-[--color-blue] transition-colors duration-200">
                            <ul id="school-suggestions" class="absolute z-10 w-full bg-[--bg-secondary] mt-2 rounded-xl shadow-lg max-h-60 overflow-y-auto hidden"></ul>
                        </div>
                        
                        <!-- 선택된 학교 표시 -->
                        <div id="selected-school-display" class="hidden p-4 bg-[--bg-secondary] rounded-xl flex justify-between items-center">
                            <span id="selected-school-name" class="text-lg"></span>
                            <button id="change-school-button" class="text-sm text-[--color-blue] hover:underline">변경</button>
                        </div>
                        
                        <!-- 학년, 반 드롭다운 -->
                        <div class="flex space-x-4">
                            <div class="w-1/2">
                                <label for="grade-select" class="block text-sm text-[--text-secondary] mb-2">학년</label>
                                <select id="grade-select" class="w-full bg-[--bg-secondary] text-lg py-3 px-4 rounded-xl border-2 border-transparent focus:border-[--color-blue] transition-colors duration-200" disabled>
                                    <option value="" selected disabled>학년 선택</option>
                                </select>
                            </div>
                            <div class="w-1/2">
                                <label for="class-select" class="block text-sm text-[--text-secondary] mb-2">반</label>
                                <select id="class-select" class="w-full bg-[--bg-secondary] text-lg py-3 px-4 rounded-xl border-2 border-transparent focus:border-[--color-blue] transition-colors duration-200" disabled>
                                    <option value="" selected disabled>반 선택</option>
                                </select>
                            </div>
                        </div>
                    </div>
                </div>

            </div>
        </main>
        
    </div>

    <!-- 하단 고정 버튼 -->
    <footer class="fixed bottom-0 left-0 right-0 z-50 bg-[--bg-primary] p-4">
        <div class="container mx-auto max-w-screen-sm">
            <!-- nextButton은 step-1에서 숨김 처리됨. -->
            <button id="next-button" class="block mx-auto bg-[--color-blue] text-white font-bold py-4 rounded-full shadow-lg hover:bg-blue-600 transition-colors duration-200 w-full sm:w-[550px] disabled:bg-gray-700 disabled:text-gray-400" disabled>
                다음
            </button>
        </div>
    </footer>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // Firebase 전역 객체 가져오기
            const { auth, db, appId, signInWithEmailAndPassword, createUserWithEmailAndPassword, doc, setDoc } = window.firebase;

            // NEIS API 설정
            const NEIS_API_KEY = "0c3b4def034a4eb5b75e830500a30898";
            const NEIS_API_URL = "https://open.neis.go.kr/hub/schoolInfo";

            const step0 = document.getElementById('step-0');
            const step1 = document.getElementById('step-1');
            const step2 = document.getElementById('step-2');
            const step3 = document.getElementById('step-3');
            const step4 = document.getElementById('step-4');
            const step5 = document.getElementById('step-5');
            const step6 = document.getElementById('step-6');
            const step7 = document.getElementById('step-7'); // 학교 정보 단계

            const nextButton = document.getElementById('next-button');
            const backButton = document.getElementById('back-button');
            const loadingOverlay = document.getElementById('loading-overlay');
            const messageBox = document.getElementById('message-box');
            const messageBoxText = document.getElementById('message-box-text');
            const messageBoxClose = document.getElementById('message-box-close');

            const toLoginButton = document.getElementById('to-login-button');
            const toSignupButton = document.getElementById('to-signup-button');

            const loginEmailInput = document.getElementById('login-email-input');
            const loginPasswordInput = document.getElementById('login-password-input');
            const loginUserIdentifier = document.getElementById('login-user-identifier');
            
            const signupNameInput = document.getElementById('signup-name-input');
            const signupEmailInput = document.getElementById('signup-email-input');
            const signupPasswordInput = document.getElementById('signup-password-input');
            const signupPasswordConfirmInput = document.getElementById('signup-password-confirm-input');

            // 약관 동의 관련 요소들
            const allAgreeCheckbox = document.getElementById('all-agree-checkbox');
            const tosCheckbox = document.getElementById('tos-checkbox');
            const privacyCheckbox = document.getElementById('privacy-checkbox');
            const marketingCheckbox = document.getElementById('marketing-checkbox');

            // 학교 정보 관련 요소들
            const schoolSearchInput = document.getElementById('school-search-input');
            const schoolSuggestions = document.getElementById('school-suggestions');
            const selectedSchoolDisplay = document.getElementById('selected-school-display');
            const selectedSchoolName = document.getElementById('selected-school-name');
            const changeSchoolButton = document.getElementById('change-school-button');
            const gradeSelect = document.getElementById('grade-select');
            const classSelect = document.getElementById('class-select');
            
            const steps = [step0, step1, step2, step3, step4, step5, step6, step7];
            let currentStep = 0;

            // 로딩 상태를 보여주는 함수
            const showLoading = (show) => {
                loadingOverlay.style.display = show ? 'flex' : 'none';
            };

            // 메시지 박스를 보여주는 함수
            const showMessage = (text) => {
                messageBoxText.textContent = text;
                messageBox.style.display = 'flex';
            };

            messageBoxClose.addEventListener('click', () => {
                messageBox.style.display = 'none';
            });

            // 버튼 상태 업데이트 함수
            const updateButtonState = () => {
                switch(currentStep) {
                    case 4: // 회원가입 - 기본 정보
                        nextButton.disabled = (signupNameInput.value.trim() === '' || signupEmailInput.value.trim() === '');
                        break;
                    case 5: // 회원가입 - 비밀번호
                        nextButton.disabled = (signupPasswordInput.value.length < 8 || signupPasswordInput.value !== signupPasswordConfirmInput.value);
                        break;
                    case 6: // 약관 동의
                        const requiredChecked = tosCheckbox.checked && privacyCheckbox.checked;
                        nextButton.disabled = !requiredChecked;
                        break;
                    case 7: // 학교 정보
                        const isSchoolSelected = selectedSchoolName.textContent.trim() !== '';
                        const isGradeSelected = gradeSelect.value !== '';
                        const isClassSelected = classSelect.value !== '';
                        nextButton.disabled = !(isSchoolSelected && isGradeSelected && isClassSelected);
                        break;
                    default:
                        nextButton.disabled = false;
                        break;
                }
            };
            
            // 입력 필드와 체크박스에 이벤트 리스너 추가
            [signupNameInput, signupEmailInput, signupPasswordInput, signupPasswordConfirmInput].forEach(input => {
                input.addEventListener('input', updateButtonState);
            });
            [tosCheckbox, privacyCheckbox, marketingCheckbox].forEach(checkbox => {
                checkbox.addEventListener('change', () => {
                    allAgreeCheckbox.checked = tosCheckbox.checked && privacyCheckbox.checked && marketingCheckbox.checked;
                    updateButtonState();
                });
            });

            allAgreeCheckbox.addEventListener('change', () => {
                const isChecked = allAgreeCheckbox.checked;
                tosCheckbox.checked = isChecked;
                privacyCheckbox.checked = isChecked;
                marketingCheckbox.checked = isChecked;
                updateButtonState();
            });

            // 학교 검색 로직 (NEIS API 연동)
            const searchSchools = async (query) => {
                if (query.length < 2) {
                    schoolSuggestions.innerHTML = '';
                    schoolSuggestions.classList.add('hidden');
                    return;
                }

                const url = `${NEIS_API_URL}?KEY=${NEIS_API_KEY}&Type=json&pIndex=1&pSize=10&SCHUL_NM=${encodeURIComponent(query)}`;
                
                try {
                    showLoading(true);
                    const response = await fetch(url);
                    const data = await response.json();
                    
                    schoolSuggestions.innerHTML = '';

                    // 응답 데이터 구조 확인
                    if (data && data.schoolInfo && data.schoolInfo[1] && data.schoolInfo[1].row) {
                        const schools = data.schoolInfo[1].row;
                        schools.forEach(school => {
                            const li = document.createElement('li');
                            // 학교 이름과 지역명을 함께 표시
                            li.textContent = `${school.SCHUL_NM} (${school.LCTN_SC_NM})`;
                            li.dataset.schoolName = school.SCHUL_NM; // 실제 학교 이름 저장
                            li.dataset.schoolCode = school.SD_SCHUL_CODE; // 학교 코드 저장
                            li.dataset.schoolKind = school.SCHUL_KND_SC_NM; // 학교 종류 저장 (학년 수 결정을 위함)
                            li.dataset.officeCode = school.ATPT_OFCDC_SC_CODE; // 교육청 코드 저장
                            li.classList.add('p-4', 'hover:bg-gray-700', 'cursor-pointer', 'rounded-lg');
                            li.addEventListener('click', () => {
                                // 학교 종류(li.dataset.schoolKind)도 함께 전달
                                selectSchool(li.dataset.schoolName, li.textContent, li.dataset.schoolCode, li.dataset.schoolKind, li.dataset.officeCode);
                            });
                            schoolSuggestions.appendChild(li);
                        });
                        schoolSuggestions.classList.remove('hidden');
                    } else {
                        const li = document.createElement('li');
                        li.textContent = '검색 결과가 없습니다.';
                        li.classList.add('p-4', 'text-[--text-secondary]');
                        schoolSuggestions.appendChild(li);
                        schoolSuggestions.classList.remove('hidden');
                    }
                } catch (error) {
                    console.error("학교 검색 실패:", error);
                    showMessage("학교 검색 중 오류가 발생했습니다. 다시 시도해주세요.");
                } finally {
                    showLoading(false);
                }
            };

            // debounce 함수로 API 호출 빈도 제어
            let debounceTimer;
            schoolSearchInput.addEventListener('input', (e) => {
                clearTimeout(debounceTimer);
                debounceTimer = setTimeout(() => {
                    searchSchools(e.target.value);
                }, 500);
            });

            // 학교 선택 함수
            const selectSchool = (schoolName, fullSchoolName, schoolCode, schoolKind, schoolOfficeCode) => {
                schoolSearchInput.value = '';
                schoolSearchInput.classList.add('hidden');
                schoolSuggestions.classList.add('hidden');
                
                selectedSchoolName.textContent = fullSchoolName; // UI에는 전체 이름을 표시
                selectedSchoolName.dataset.schoolName = schoolName; // 실제 학교 이름 저장
                selectedSchoolName.dataset.schoolCode = schoolCode; // 학교 코드 저장
                selectedSchoolName.dataset.schoolKind = schoolKind; // 학교 종류 저장
                selectedSchoolName.dataset.schoolOfficeCode = schoolOfficeCode; // 교육청 코드 저장
                selectedSchoolDisplay.classList.remove('hidden');

                // 학년 드롭다운 동적 생성
                populateGradeSelect(schoolKind);

                gradeSelect.disabled = false;
                classSelect.disabled = false;
                updateButtonState();
            };

            // 학교 종류에 따라 학년 드롭다운을 채우는 함수
            const populateGradeSelect = (schoolKind) => {
                gradeSelect.innerHTML = '<option value="" selected disabled>학년 선택</option>';
                let maxGrade = 3;

                // 학교 종류에 따라 최대 학년 설정
                if (schoolKind.includes('초등학교')) {
                    maxGrade = 6;
                } else if (schoolKind.includes('중학교') || schoolKind.includes('고등학교')) {
                    maxGrade = 3;
                }
                
                for (let i = 1; i <= maxGrade; i++) {
                    const option = document.createElement('option');
                    option.value = i;
                    option.textContent = `${i}학년`;
                    gradeSelect.appendChild(option);
                }

                // 학년이 변경되면 반 드롭다운을 초기화
                gradeSelect.addEventListener('change', () => {
                    populateClassSelect();
                    updateButtonState();
                }, { once: true }); // 첫 번째 변경에만 반응하도록 설정

                // 반 드롭다운 초기화
                populateClassSelect();
            };
            
            // 반 드롭다운을 채우는 함수
            const populateClassSelect = () => {
                classSelect.innerHTML = '<option value="" selected disabled>반 선택</option>';
                // NEIS API에서 반 정보를 제공하지 않으므로, 임시로 10반까지 표시
                for (let i = 1; i <= 10; i++) {
                    const option = document.createElement('option');
                    option.value = i;
                    option.textContent = `${i}반`;
                    classSelect.appendChild(option);
                }
            };


            // 학교 변경 버튼 클릭 이벤트
            changeSchoolButton.addEventListener('click', () => {
                schoolSearchInput.classList.remove('hidden');
                selectedSchoolDisplay.classList.add('hidden');
                selectedSchoolName.textContent = '';
                selectedSchoolName.dataset.schoolName = '';
                selectedSchoolName.dataset.schoolCode = '';
                selectedSchoolName.dataset.schoolKind = '';
                selectedSchoolName.dataset.schoolOfficeCode = '';
                gradeSelect.disabled = true;
                classSelect.disabled = true;
                gradeSelect.innerHTML = '<option value="" selected disabled>학년 선택</option>';
                classSelect.innerHTML = '<option value="" selected disabled>반 선택</option>';
                updateButtonState();
            });
            
            [gradeSelect, classSelect].forEach(select => {
                select.addEventListener('change', updateButtonState);
            });

            // 로그인 처리 함수
            const handleLogin = async () => {
                const email = loginEmailInput.value.trim();
                const password = loginPasswordInput.value;

                if (!email || !password) {
                    showMessage("이메일과 비밀번호를 입력해주세요.");
                    return;
                }

                showLoading(true);
                try {
                    await signInWithEmailAndPassword(auth, email, password);
                    showMessage("로그인에 성공했습니다!");
                    console.log("로그인 성공!");
                } catch (error) {
                    console.error("로그인 실패:", error);
                    let errorMessage = "로그인에 실패했습니다. 이메일과 비밀번호를 확인해주세요.";
                    if (error.code === 'auth/wrong-password') {
                        errorMessage = "비밀번호가 올바르지 않습니다.";
                    } else if (error.code === 'auth/user-not-found') {
                        errorMessage = "해당 이메일의 사용자를 찾을 수 없습니다.";
                    }
                    showMessage(errorMessage);
                } finally {
                    showLoading(false);
                }
            };

            // 회원가입 처리 함수
            const handleSignup = async () => {
                const name = signupNameInput.value.trim();
                const email = signupEmailInput.value.trim();
                const password = signupPasswordInput.value;
                const schoolName = selectedSchoolName.dataset.schoolName; 
                const schoolCode = selectedSchoolName.dataset.schoolCode;
                const schoolOfficeCode = selectedSchoolName.dataset.schoolOfficeCode;
                const grade = gradeSelect.value;
                const classNum = classSelect.value;
                
                if (!name || !email || !password || !schoolName || !schoolCode || !schoolOfficeCode || !grade || !classNum) {
                    showMessage("모든 정보를 올바르게 입력해주세요.");
                    return;
                }

                showLoading(true);
                try {
                    const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                    const user = userCredential.user;
                    
                    // Firestore에 사용자 추가 정보 저장 - 요청하신 형식으로 변경
                    // 예시에서 제공된 'studentNum' 필드는 사용자 입력으로 제공되지 않아 제거했습니다.
                    const userRef = doc(db, `artifacts/${appId}/users/${user.uid}/profile/user_data`);
                    await setDoc(userRef, {
                        atptOfcdcScCode: schoolOfficeCode,
                        classNum: parseInt(classNum, 10),
                        grade: parseInt(grade, 10),
                        schoolName: schoolName,
                        sdSchulCode: schoolCode,
                        updatedAt: new Date()
                    });
                    
                    // 기존에 저장되던 uid, name, email 필드는 요청하신 형식에 없으므로 제외했습니다.

                    showMessage("회원가입에 성공했습니다! 환영합니다!");
                    console.log("회원가입 성공!");

                } catch (error) {
                    console.error("회원가입 실패:", error);
                    let errorMessage = "회원가입에 실패했습니다. 다시 시도해주세요.";
                    if (error.code === 'auth/email-already-in-use') {
                        errorMessage = "이미 사용 중인 이메일 주소입니다.";
                    } else if (error.code === 'auth/weak-password') {
                        errorMessage = "비밀번호는 최소 6자 이상이어야 합니다.";
                    }
                    showMessage(errorMessage);
                } finally {
                    showLoading(false);
                }
            };


            // 단계 업데이트 함수
            const updateStep = (newStep) => {
                if (steps[currentStep]) {
                    steps[currentStep].classList.remove('is-active');
                }
                
                if (steps[newStep]) {
                    steps[newStep].classList.add('is-active');
                }
                
                currentStep = newStep;

                switch(currentStep) {
                    case 0:
                        nextButton.classList.remove('hidden');
                        nextButton.textContent = '다음';
                        backButton.classList.add('hidden');
                        break;
                    case 1:
                        nextButton.classList.add('hidden');
                        backButton.classList.remove('hidden');
                        break;
                    case 2: // 로그인
                        nextButton.classList.remove('hidden');
                        nextButton.textContent = '다음';
                        backButton.classList.remove('hidden');
                        break;
                    case 3: // 로그인 - 비밀번호
                        nextButton.classList.remove('hidden');
                        const loginIdentifier = loginEmailInput.value;
                        if (loginIdentifier === '') {
                             updateStep(2);
                             return;
                        }
                        loginUserIdentifier.textContent = loginIdentifier;
                        nextButton.textContent = '로그인';
                        backButton.classList.remove('hidden');
                        break;
                    case 4: // 회원가입 - 기본 정보
                        nextButton.classList.remove('hidden');
                        nextButton.textContent = '다음';
                        backButton.classList.remove('hidden');
                        break;
                    case 5: // 회원가입 - 비밀번호
                        nextButton.classList.remove('hidden');
                        nextButton.textContent = '다음';
                        backButton.classList.remove('hidden');
                        break;
                    case 6: // 이용약관 및 개인정보 동의
                        nextButton.classList.remove('hidden');
                        nextButton.textContent = '다음';
                        backButton.classList.remove('hidden');
                        break;
                    case 7: // 학교 정보
                        nextButton.classList.remove('hidden');
                        nextButton.textContent = '가입 완료';
                        backButton.classList.remove('hidden');
                        break;
                    default:
                        break;
                }
                updateButtonState();
            };

            nextButton.addEventListener('click', () => {
                if (currentStep === 0) {
                    updateStep(1);
                } else if (currentStep === 2) {
                    updateStep(3);
                } else if (currentStep === 3) {
                    handleLogin();
                } else if (currentStep === 4) {
                    updateStep(5);
                } else if (currentStep === 5) {
                    updateStep(6);
                } else if (currentStep === 6) {
                    updateStep(7);
                } else if (currentStep === 7) {
                    handleSignup();
                }
            });

            backButton.addEventListener('click', () => {
                if (currentStep === 1) {
                    updateStep(0);
                } else if (currentStep === 2) {
                    updateStep(1);
                } else if (currentStep === 3) {
                    updateStep(2);
                } else if (currentStep === 4) {
                    updateStep(1);
                } else if (currentStep === 5) {
                    updateStep(4);
                } else if (currentStep === 6) {
                    updateStep(5);
                } else if (currentStep === 7) {
                    updateStep(6);
                }
            });

            toLoginButton.addEventListener('click', () => updateStep(2));
            toSignupButton.addEventListener('click', () => updateStep(4));

            // 초기 단계 설정
            step0.classList.add('is-active');
            nextButton.textContent = '다음';
            updateButtonState();
        });
    </script>
</body>
</html>
