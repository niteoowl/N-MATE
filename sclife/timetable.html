<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <link rel="icon" type="image/png" href="/image/simbol.png" media="(prefers-color-scheme: light)">
    <link rel="icon" type="image/png" href="/image/dark_simbol.png" media="(prefers-color-scheme: dark)">
    <meta name="description" content="우리반 시간표를 확인하세요! 부산남중 학생을 위한 간편한 시간표 조회 서비스를 제공합니다.">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>부산남중학교 N-MATE - 학교생활</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Inter 폰트 설정 (비동기 로딩) -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet" media="print" onload="this.media='all'">
    <style>
        /* Pretendard-Regular 웹폰트 정의 */
        @font-face {
            font-family: 'Pretendard-Regular';
            src: url('https://fastly.jsdelivr.net/gh/Project-Noonnu/noonfonts_2107@1.1/Pretendard-Regular.woff') format('woff');
            font-weight: 400;
            font-style: normal;
            font-display: swap; /* 폰트 로드 중 텍스트 표시 */
        }
        
        /* Body styles for overall layout */
        body {
            font-family: 'Pretendard-Regular', sans-serif;
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            display: flex;
            flex-direction: column;
            min-height: 100vh;
            background-color: #ffffff; /* Light gray background */
        }
        /* Skeleton Loader animation for loading states */
        .skeleton {
            animation: pulse 1.5s infinite ease-in-out;
            background: linear-gradient(-90deg, #f0f0f0 0%, #f8f8f8 50%, #f0f0f0 100%);
            background-size: 200% 100%;
        }
        @keyframes pulse {
            0% {
                background-position: -200% 0;
            }
            100% {
                background-position: 200% 0;
            }
        }
        .skeleton-text {
            height: 1em; /* Adjust as needed */
            width: 80%; /* Adjust as needed */
            margin-bottom: 0.5em;
            border-radius: 4px;
        }

        /* Main content container for centering and max-width */
        .main-content-container {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            align-items: flex-start; /* Aligns content to the left */
            max-width: 36rem; /* Max width for content */
            margin-left: auto;
            margin-right: auto;
            width: 100%;
            position: relative; /* For absolute positioning of dropdown menu */
            padding-bottom: 70px; /* Space for fixed bottom navigation */
        }

        /* Dropdown menu styles */
        .dropdown-menu {
            position: absolute; /* Relative to the parent with position: relative */
            background-color: white;
            border-radius: 0.5rem; /* rounded-md */
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06); /* shadow-lg */
            padding-top: 0.25rem; /* py-1 */
            padding-bottom: 0.25rem;
            min-width: 8rem; /* w-40 */
            right: 0; /* Aligns to the right of the account tab button */
            top: calc(100% + 0.5rem); /* Positions below the button with 0.5rem gap */
            z-index: 20; /* Ensures it appears above other content */
        }

        .dropdown-menu button {
            width: 100%;
            text-align: left;
            padding: 0.5rem 1rem; /* px-4 py-2 */
            font-size: 0.875rem; /* text-sm */
            color: #374151; /* text-gray-700 */
            transition: background-color 0.2s ease;
        }

        .dropdown-menu button:hover {
            background-color: #f3f4f6; /* hover:bg-gray-100 */
        }

        /* Tab buttons container for switching between sections */
        .tab-buttons-container {
            display: flex;
            width: 100%; /* Adjusted to take full width of its px-6 parent */
            margin-top: 1.5rem; /* Top margin for separation */
            margin-bottom: 0.5rem; /* Bottom margin */
            border-bottom: 2px solid #e5e7eb; /* Gray-200 for separator */
        }
        .tab-button {
            flex-grow: 1;
            padding: 0.75rem 1rem;
            font-size: 1rem;
            font-weight: 600;
            color: #374151; /* Gray-700 (접근성 개선) */
            background-color: transparent;
            border: none;
            border-bottom: 2px solid transparent; /* Transparent border for inactive */
            transition: all 0.2s ease;
            cursor: pointer;
            outline: none;
            text-align: center;
        }
        .tab-button.active {
            color: #3b82f6; /* Blue-500 */
            border-bottom-color: #3b82f6; /* Blue-500 for active tab */
        }
        .tab-button:hover:not(.active) {
            color: #4f46e5; /* Indigo-600 on hover */
            background-color: #f9fafb; /* Lighter background on hover */
        }

        /* Specific styles for academic schedule content area */
        .academic-schedule-content-box {
            background-color: #ffffff;
            border-radius: 0.75rem;
            border: 1px solid #e2e8f0;
            text-align: left;
            min-height: 200px;
            width: 100%;
            overflow: hidden;
        }
        /* Calendar navigation styles */
        .calendar-nav {
            display: flex;
            justify-content: space-between;
            align-items: center;
            width: 100%;
            margin-bottom: 1rem;
            padding: 0.5rem 0;
        }
        .calendar-nav button {
            background-color: transparent;
            color: #4b5563;
            padding: 0;
            border-radius: 0;
            transition: color 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            border: none;
            outline: none;
        }
        .calendar-nav button:hover {
            color: #3b82f6;
            background-color: transparent;
        }
        .calendar-nav span {
            font-size: 1.25rem;
            font-weight: 600;
            color: #1f2937;
        }
        /* Calendar grid specific styles */
        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 1px;
            width: 100%;
            background-color: #e2e8f0;
        }
        .calendar-header-day {
            background-color: #ffffff;
            font-weight: 600;
            text-align: center;
            padding: 0.75rem 0.25rem;
            font-size: 0.75rem;
            color: #1f2937; /* Gray-900 (접근성 개선) */
        }
        .calendar-cell {
            background-color: #ffffff;
            min-height: 80px;
            padding: 0.5rem;
            display: flex;
            flex-direction: column;
            align-items: flex-start;
            justify-content: flex-start;
            font-size: 0.75rem;
            color: #374151; /* Gray-700 (접근성 개선) */
            overflow: hidden;
            position: relative;
        }
        .calendar-cell.inactive-month {
            background-color: #f3f4f6;
            color: #9ca3af;
        }
        .calendar-cell.today {
            background-color: #e5e7eb;
            font-weight: 600;
        }
        .calendar-cell-date {
            font-weight: 700;
            margin-bottom: 0.25rem;
            color: #1f2937;
        }
        .calendar-cell-event {
            font-size: 0.625rem;
            line-height: 1.2;
            margin-bottom: 0.2rem;
            color: #1f2937;
            white-space: normal;
            word-break: break-word;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .calendar-cell-event:last-child {
            margin-bottom: 0;
        }

        /* Specific styles for the timetable table */
        .timetable-table {
            border-collapse: collapse;
            width: 100%;
            border-radius: 0.75rem;
        }
        .timetable-table thead th {
            border-bottom: 1px solid #e2e8f0;
            padding: 1rem 0.75rem;
            text-align: center;
            font-size: 1rem;
            font-weight: 700;
            color: #374151; /* Gray-700 (접근성 개선) */
            background-color: #ffffff;
        }
        .timetable-table tbody td {
            border-bottom: 1px solid #e2e8f0;
            vertical-align: top;
            padding: 1rem 0.75rem;
            word-break: keep-all;
            white-space: normal;
            text-align: center;
            font-size: 0.875rem;
            color: #374151; /* Gray-700 */
        }
        .timetable-table tbody tr:last-child td {
            border-bottom: none;
        }
        .timetable-table .lunch-break {
            background-color: #ffffff;
            color: #374151; /* Gray-700 */
            font-weight: 600;
            border-top: 1px solid #cbd5e1;
            border-bottom: 1px solid #cbd5e1;
            padding: 1rem 0.75rem;
        }

        /* Specific styles for the meal content area */
        .meal-content-box {
            background-color: #ffffff;
            border-radius: 0.75rem;
            border: 1px solid #e2e8f0;
            padding: 1.5rem;
            text-align: left;
            min-height: 150px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: flex-start;
        }
        .meal-content-box p {
            margin-bottom: 0.5rem;
            font-size: 0.875rem;
            line-height: 1.5;
            color: #374151; /* Gray-700 */
        }
        .meal-content-box p:last-child {
            margin-bottom: 0;
        }
        /* Styles for date selection buttons (meal) */
        .date-button-container {
            display: flex;
            justify-content: space-around;
            width: 100%;
            background-color: #f8f8f8;
            border-radius: 0.5rem;
            overflow: hidden;
            padding: 0.25rem;
            gap: 0.25rem;
        }
        .date-button {
            flex-grow: 1;
            padding: 0.75rem 0.5rem;
            border-radius: 0.375rem;
            font-size: 0.875rem;
            font-weight: 500;
            color: #374151; /* Gray-700 (접근성 개선) */
            background-color: transparent;
            transition: all 0.2s ease;
            text-align: center;
            cursor: pointer;
            border: none;
            outline: none;
        }
        .date-button.active {
            background-color: #3b82f6;
            color: #ffffff;
            box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
        }
        .date-button:not(.active):hover {
            background-color: #e5e7eb;
        }
    </style>
</head>
<body>

    <!-- Main content area -->
    <div class="main-content-container">

        <!-- Header: Logo and Account/Login section -->
        <div class="w-full flex justify-between items-center px-6 pt-4">
            <!-- Logo -->
            <div class="flex items-center">
                <!-- LCP 개선: 이미지에 width, height 속성 추가 및 .webp 형식 사용 -->
                <img src="/image/logo.webp" alt="가로형 로고" class="h-12 w-auto" width="192" height="48">
            </div>

            <!-- Account/Login section with dropdown -->
            <div class="relative">
                <div id="accountStatusArea" class="flex items-center">
                    <!-- Conditional content injected by JavaScript -->
                </div>
                <!-- Dropdown menu (initially hidden) -->
                <div id="accountDropdown" class="dropdown-menu hidden">
                    <button id="settingsButton" class="block">설정</button>
                    <button id="logoutButton" class="block">로그아웃</button>
                </div>
            </div>
        </div>

        <!-- School Life section container -->
        <div class="w-full flex flex-col items-start px-6 mt-8 mb-4">
            <!-- Section title -->
            <h2 class="text-left text-xl font-bold text-gray-800">학교생활</h2>

            <!-- Tab buttons for switching between sections (Order: 시간표, 급식, 학사일정) -->
            <div class="tab-buttons-container">
                <button id="tab-timetable" class="tab-button" data-tab-id="timetableContent" data-path="/sclife/timetable">시간표</button>
                <button id="tab-meal" class="tab-button" data-tab-id="mealContent" data-path="/sclife/meal">급식</button>
                <button id="tab-academic" class="tab-button" data-tab-id="academicScheduleContent" data-path="/sclife/schedule">학사일정</button>
            </div>

            <!-- Content sections -->

            <!-- Timetable Section -->
            <div id="timetableContent" class="tab-content hidden w-full flex flex-col items-start gap-y-2 mt-4">
                <div class="w-full bg-white rounded-xl border border-gray-300 flex overflow-x-auto overflow-y-hidden">
                    <div id="timetable-display-section" class="w-full h-full bg-white flex flex-col items-center justify-center">
                        <!-- Skeleton Loader for Timetable content -->
                    </div>
                </div>
            </div>

            <!-- Meal Section -->
            <div id="mealContent" class="tab-content hidden w-full flex flex-col items-start gap-y-2 mt-4">
                <!-- Date selection buttons -->
                <div id="meal-date-buttons-container" class="date-button-container">
                    <!-- Date buttons will be rendered here by JavaScript -->
                </div>

                <!-- Date picker input, initially hidden -->
                <input type="date" id="mealDatePicker" class="hidden w-full mt-2 p-2 border border-gray-300 rounded-md text-gray-700 focus:ring-blue-500 focus:border-blue-500">

                <!-- Meal display area -->
                <div id="meal-display-section" class="w-full meal-content-box mt-4">
                    <!-- Skeleton Loader for Meal content -->
                    <div class="w-full">
                        <div class="skeleton skeleton-text w-full"></div>
                        <div class="skeleton skeleton-text w-5/6"></div>
                        <div class="skeleton skeleton-text w-3/4"></div>
                        <div class="skeleton skeleton-text w-1/2"></div>
                    </div>
                </div>
            </div>

            <!-- Academic Schedule Section -->
            <div id="academicScheduleContent" class="tab-content hidden w-full flex flex-col items-start gap-y-2 mt-4">
                <!-- Calendar Navigation (Month selection) -->
                <div class="calendar-nav">
                    <button id="academic-prevMonthButton" aria-label="Previous Month"><i data-lucide="chevron-left" class="w-5 h-5"></i></button>
                    <span id="academic-calendar-month-year"></span>
                    <button id="academic-nextMonthButton" aria-label="Next Month"><i data-lucide="chevron-right" class="w-5 h-5"></i></button>
                </div>

                <!-- Academic Schedule display area -->
                <div id="academic-schedule-display-section" class="w-full academic-schedule-content-box">
                    <!-- Academic calendar will be rendered here -->
                    <div class="w-full calendar-grid">
                        <!-- Skeleton header days -->
                        ${Array(5).fill(0).map((_, i) => `<div class="calendar-header-day skeleton skeleton-text w-full !h-auto !mb-0 !rounded-none py-3"></div>`).join('')}
                        <!-- Skeleton cells -->
                        ${Array(35).fill(0).map((_, i) => `
                            <div class="calendar-cell">
                                <div class="skeleton skeleton-text w-8 h-4 mb-2"></div>
                                <div class="skeleton skeleton-text w-full h-3 mb-1"></div>
                                <div class="skeleton skeleton-text w-3/4 h-3"></div>
                            </div>
                        `).join('')}
                    </div>
                </div>
                <!-- Removed date picker input and button for specific date selection -->
            </div>
        </div>
    </div>

    <!-- Bottom Navigation Bar -->
    <nav class="fixed bottom-0 left-0 right-0 bg-white p-3 border-t border-gray-300 max-w-xl mx-auto w-full z-10">
        <div class="flex justify-around items-center h-12">
            <!-- Home Navigation Item -->
            <button id="nav-home" class="nav-item flex flex-col items-center justify-center p-2 rounded-xl transition-all duration-300 text-gray-500 hover:text-blue-500 hover:bg-gray-50" data-tab="홈" data-path="/">
                <svg viewBox="0 0 24 24" fill="currentColor" class="w-6 h-6 mb-1" xmlns="http://www.w3.org/2000/svg">
                    <path d="M10 20V14H14V20H19V12H22L12 3L2 12H5V20H10Z"/>
                </svg>
                <span class="text-xs font-medium">홈</span>
            </button>

            <!-- School Life Navigation Item (consolidated) -->
            <button id="nav-school-life" class="nav-item flex flex-col items-center justify-center p-2 rounded-xl transition-all duration-300 text-gray-500 hover:text-blue-500 hover:bg-gray-50" data-tab="학교생활" data-path="/school-life">
                <svg viewBox="0 0 24 24" fill="currentColor" class="w-6 h-6 mb-1" xmlns="http://www.w3.org/2000/svg">
                    <path d="M4 19V6.5C4 5.94772 4.44772 5.5 5 5.5H19C19.5523 5.5 20 5.94772 20 6.5V19C20 19.5523 19.5523 20 19 20H5C4.44772 20 4 19.5523 4 19ZM6 17H18V7.5H6V17ZM9 10H15V12H9V10Z"/>
                </svg>
                <span class="text-xs font-medium">학교생활</span>
            </button>

            <!-- Community Navigation Item -->
            <button id="nav-community" class="nav-item flex flex-col items-center justify-center p-2 rounded-xl transition-all duration-300 text-gray-500 hover:text-blue-500 hover:bg-gray-50" data-tab="커뮤니티" data-path="/community">
                <svg viewBox="0 0 24 24" fill="currentColor" class="w-6 h-6 mb-1" xmlns="http://www.w3.org/2000/svg">
                    <path d="M16 11C18.21 11 20 9.21 20 7C20 4.79 18.21 3 16 3C13.79 3 12 4.79 12 7C12 9.21 13.79 11 16 11ZM8 11C10.21 11 12 9.21 12 7C12 4.79 10.21 3 8 3C5.79 3 4 4.79 4 7C4 9.21 5.79 11 8 11ZM16 13C13.67 13 9.34 14.28 9 17V19H23V17C22.66 14.28 18.33 13 16 13ZM8 13C5.33 13 0 14.33 0 17V19H9V17C8.67 14.33 4.33 13 8 13Z"/>
                </svg>
                <span class="text-xs font-medium">커뮤니티</span>
            </button>

            <!-- Calendar Navigation Item (as a separate item if needed, but '/school-life' is already for academic calendar) -->
            <!-- If this is meant to be a new, separate feature, its path needs to be defined.
                 For now, I'll assume it's for a future feature and add a placeholder path. -->
            <button id="nav-calendar" class="nav-item flex flex-col items-center justify-center p-2 rounded-xl transition-all duration-300 text-gray-500 hover:text-blue-500 hover:bg-gray-50" data-tab="캘린더" data-path="/calendar">
                <svg viewBox="0 0 24 24" fill="currentColor" class="w-6 h-6 mb-1" xmlns="http://www.w3.org/2000/svg">
                    <path d="M19 4H18V2H16V4H8V2H6V4H5C3.89 4 3 4.9 3 6V20C3 21.1 3.89 22 5 22H19C20.1 22 21 21.1 21 20V6C21 4.9 20.1 4 19 4ZM19 20H5V9H19V20Z"/>
                </svg>
                <span class="text-xs font-medium">캘린더</span>
            </button>

            <!-- More Navigation Item -->
            <button id="nav-more" class="nav-item flex flex-col items-center justify-center p-2 rounded-xl transition-all duration-300 text-gray-500 hover:text-blue-500 hover:bg-blue-50" data-tab="더보기" data-path="/more">
                <svg viewBox="0 0 24 24" fill="currentColor" class="w-6 h-6 mb-1" xmlns="http://www.w3.org/2000/svg">
                    <path d="M12 10C10.9 10 10 10.9 10 12C10 13.1 10.9 14 12 14C13.1 14 14 13.1 14 12C14 10.9 13.1 10 12 10ZM19 10C17.9 10 17 10.9 17 12C17 13.1 17.9 14 19 14C20.1 14 21 13.1 21 12C21 10.9 20.1 10 19 10ZM5 10C3.9 10 3 10.9 3 12C3 13.1 3.9 14 5 14C6.1 14 7 13.1 7 12C7 10.9 6.1 10 5 10Z"/>
                </svg>
                <span class="text-xs font-medium">더보기</span>
            </button>
        </div>
    </nav>

    <!-- Firebase SDK CDN (defer 로드) -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js" defer></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js" defer></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js" defer></script>
    <!-- Lucide Icons CDN (defer 로드) -->
    <script src="https://unpkg.com/lucide@latest" defer></script>

    <script>
        // Global variables for Firebase configuration (provided by Canvas environment)
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = {
            apiKey: "AIzaSyC_SHRcQ9hXmjVbP3km4rdR4UvKIoqpLHo",
            authDomain: "n-mate.firebaseapp.com",
            projectId: "n-mate",
            storageBucket: "n-mate.firebasestorage.app",
            appId: "1:691313471077:web:3066aaeca0a1d9e448e08c",
            measurementId: "G-0LCGVBKXLQ",
            messagingSenderId: "691313471077"
        };

        // Firebase app, auth, and firestore instances
        let app;
        let auth;
        let db;

        // NEIS API common information
        const neisApiKey = "cbb4da48e87445f68c2732368454ebc3"; // Replace with your API key
        const eduCode = "C10"; // Replace with your school's education office code
        const schoolCode = "7171018"; // Replace with your school's standard code

        // DOM elements (general)
        const accountStatusArea = document.getElementById('accountStatusArea');
        const accountDropdown = document.getElementById('accountDropdown');

        // DOM elements (tabs)
        const tabButtons = document.querySelectorAll('.tab-button');
        const academicScheduleContent = document.getElementById('academicScheduleContent');
        const timetableContent = document.getElementById('timetableContent');
        const mealContent = document.getElementById('mealContent');

        // DOM elements (Academic Schedule)
        const academicScheduleDisplaySection = document.getElementById('academic-schedule-display-section');
        const academicCalendarMonthYearSpan = document.getElementById('academic-calendar-month-year');
        const academicPrevMonthButton = document.getElementById('academic-prevMonthButton');
        const academicNextMonthButton = document.getElementById('academic-nextMonthButton');
        // Removed academicDatePicker and academicShowDatePickerButton as per request
        let academicCurrentDate = new Date(); // Current date object for academic calendar

        // DOM elements (Timetable)
        const timetableDisplaySection = document.getElementById('timetable-display-section');
        let timetableUserGrade = "1";
        let timetableUserClassNum = "1";

        // DOM elements (Meal)
        const mealDisplaySection = document.getElementById('meal-display-section');
        const mealDateButtonsContainer = document.getElementById('meal-date-buttons-container');
        const mealDatePicker = document.getElementById('mealDatePicker');
        let mealCurrentSelectedDate = ''; // To keep track of the currently selected date for meal

        // Store fetched academic calendar events globally
        let academicCalendarEvents = [];

        // Track if data for each tab has been loaded to avoid redundant API calls
        const loadedTabs = {
            academicScheduleContent: false,
            timetableContent: false,
            mealContent: false
        };


        /**
         * Shows the specified tab content and updates the active state of tab buttons.
         * Fetches data for the tab if it hasn't been loaded yet.
         * @param {string} tabId - The ID of the tab content to show (e.g., 'academicScheduleContent').
         */
        async function showTab(tabId) {
            // Hide all tab content
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.add('hidden');
            });

            // Deactivate all tab buttons
            tabButtons.forEach(button => {
                button.classList.remove('active');
            });

            // Show the selected tab content
            document.getElementById(tabId).classList.remove('hidden');
            // Activate the corresponding tab button
            document.querySelector(`.tab-button[data-tab-id="${tabId}"]`).classList.add('active');

            // Load data for the tab if it hasn't been loaded yet
            if (!loadedTabs[tabId]) {
                if (tabId === 'academicScheduleContent') {
                    await getAcademicCalendar(academicCurrentDate);
                } else if (tabId === 'timetableContent') {
                    // Display skeleton immediately
                    timetableDisplaySection.innerHTML = generateTimetableSkeleton();
                    // Fetch profile and then timetable
                    if (auth.currentUser) {
                        const profile = await getUserProfile(auth.currentUser.uid);
                        if (profile && profile.grade && profile.classNum) {
                            timetableUserGrade = profile.grade;
                            timetableUserClassNum = profile.classNum;
                        }
                    }
                    await fetchTimetableData(timetableUserGrade, timetableUserClassNum);
                } else if (tabId === 'mealContent') {
                    // Initialize meal date buttons and fetch for today
                    const todayDate = new Date();
                    const year = todayDate.getFullYear();
                    const month = String(todayDate.getMonth() + 1).padStart(2, '0');
                    const day = String(todayDate.getDate()).padStart(2, '0');
                    const todayYYYYMMDD = `${year}${month}${day}`;
                    renderMealDateButtons(todayYYYYMMDD); // Render date buttons with today as active
                    await fetchMealData(todayYYYYMMDD); // Fetch meal for today's date initially
                }
                loadedTabs[tabId] = true; // Mark as loaded
            }
            // lucide.createIcons(); // Keep this for other parts of the page where Lucide is still used
        }

        // --- Academic Schedule Functions ---

        /**
         * Renders the calendar grid view for a given month and populates it with events.
         * @param {Date} monthDate - The Date object representing the month to display.
         * @param {Array} events - An array of event objects from the NEIS API.
         */
        function renderAcademicCalendar(monthDate, events) {
            const today = new Date();
            const currentYear = monthDate.getFullYear();
            const currentMonth = monthDate.getMonth(); // 0-indexed

            const firstDayOfMonth = new Date(currentYear, currentMonth, 1);
            const lastDayOfMonth = new Date(currentYear, currentMonth + 1, 0);

            const dayNames = ['월', '화', '수', '목', '금']; // Only display weekdays in header

            let calendarHtml = '<div class="calendar-grid">';

            // Add day headers (Mon-Fri)
            dayNames.forEach(dayName => {
                calendarHtml += `<div class="calendar-header-day">${dayName}</div>`;
            });

            // Determine the starting day for the calendar grid
            let startCalendarDate = new Date(firstDayOfMonth);
            const firstDayWeekday = firstDayOfMonth.getDay(); // 0=Sun, 1=Mon, ..., 6=Sat

            if (firstDayWeekday === 0) {
                startCalendarDate.setDate(firstDayOfMonth.getDate() - 6);
            } else if (firstDayWeekday !== 1) {
                startCalendarDate.setDate(firstDayOfMonth.getDate() - (firstDayWeekday - 1));
            }

            // Determine the ending day for the calendar grid
            let endCalendarDate = new Date(lastDayOfMonth);
            const lastDayWeekday = lastDayOfMonth.getDay();

            if (lastDayWeekday === 0) {
                endCalendarDate.setDate(lastDayOfMonth.getDate() + 5);
            } else if (lastDayWeekday !== 5) {
                endCalendarDate.setDate(lastDayOfMonth.getDate() + (5 - lastDayWeekday + 7) % 7);
            }

            // Iterate through each day from startCalendarDate to endCalendarDate
            let currentIterationDate = new Date(startCalendarDate);
            while (currentIterationDate <= endCalendarDate) {
                const dayOfWeek = currentIterationDate.getDay(); // 0=Sun, 1=Mon, ..., 6=Sat

                // Only render Mon-Fri cells
                if (dayOfWeek >= 1 && dayOfWeek <= 5) {
                    const cellDateString = `${currentIterationDate.getFullYear()}${String(currentIterationDate.getMonth() + 1).padStart(2, '0')}${String(currentIterationDate.getDate()).padStart(2, '0')}`;
                    const isToday = currentIterationDate.toDateString() === today.toDateString();
                    const isCurrentMonth = currentIterationDate.getMonth() === currentMonth && currentIterationDate.getFullYear() === currentYear;

                    let cellClass = 'calendar-cell';
                    if (!isCurrentMonth) {
                        cellClass += ' inactive-month';
                    }
                    if (isToday) {
                        cellClass += ' today';
                    }

                    let eventHtml = '';
                    const dailyEvents = events.filter(event => event.AA_YMD === cellDateString);
                    dailyEvents.forEach(event => {
                        eventHtml += `<p class="calendar-cell-event">${event.EVENT_NM}</p>`;
                    });

                    calendarHtml += `
                        <div class="${cellClass}">
                            <div class="calendar-cell-date">${currentIterationDate.getDate()}</div>
                            ${eventHtml}
                        </div>
                    `;
                }
                currentIterationDate.setDate(currentIterationDate.getDate() + 1);
            }

            calendarHtml += '</div>'; // Close calendar-grid
            academicScheduleDisplaySection.innerHTML = calendarHtml;
            // lucide.createIcons(); // No longer needed here as it will be called once on DOMContentLoaded
        }

        /**
         * NEIS API를 사용하여 학사일정을 불러오는 함수
         * 인자로 표시할 달의 Date 객체를 받도록 수정
         * @param {Date} monthDate - 학사일정을 불러올 월의 Date 객체.
         */
        async function getAcademicCalendar(monthDate = academicCurrentDate) {
            academicCalendarMonthYearSpan.textContent = `${monthDate.getFullYear()}년 ${monthDate.getMonth() + 1}월`;

            academicScheduleDisplaySection.innerHTML = `
                <div class="w-full calendar-grid">
                    ${['월', '화', '수', '목', '금'].map(dayName => `<div class="calendar-header-day skeleton skeleton-text w-full !h-auto !mb-0 !rounded-none py-3"></div>`).join('')}
                    ${Array(35).fill(0).map((_, i) => `
                        <div class="calendar-cell">
                            <div class="skeleton skeleton-text w-8 h-4 mb-2"></div>
                            <div class="skeleton skeleton-text w-full h-3 mb-1"></div>
                            <div class="skeleton skeleton-text w-3/4 h-3"></div>
                        </div>
                    `).join('')}
                </div>
            `;

            const year = monthDate.getFullYear();
            const month = monthDate.getMonth();

            const fromDate = new Date(year, month, 1);
            const toDate = new Date(year, month + 1, 0);

            const fromYmd = `${fromDate.getFullYear()}${('0' + (fromDate.getMonth() + 1)).slice(-2)}${('0' + fromDate.getDate()).slice(-2)}`;
            const toYmd = `${toDate.getFullYear()}${('0' + (toDate.getMonth() + 1)).slice(-2)}${('0' + toDate.getDate()).slice(-2)}`;

            const apiUrl = `https://open.neis.go.kr/hub/SchoolSchedule?KEY=${neisApiKey}&Type=json&pIndex=1&pSize=100&ATPT_OFCDC_SC_CODE=${eduCode}&SD_SCHUL_CODE=${schoolCode}&AA_FROM_YMD=${fromYmd}&AA_TO_YMD=${toYmd}`;

            try {
                const response = await fetch(apiUrl);
                const data = await response.json();

                let events = [];
                if (data.SchoolSchedule && data.SchoolSchedule[1] && data.SchoolSchedule[1].row) {
                    events = data.SchoolSchedule[1].row;
                    events.sort((a, b) => parseInt(a.AA_YMD) - parseInt(b.AA_YMD));
                } else if (data.RESULT && data.RESULT.CODE === 'INFO-200') {
                    console.log(`No academic schedule for ${year}년 ${month + 1}월`);
                } else {
                    console.error(`API response error for academic schedule:`, data);
                }

                academicCalendarEvents = events;
                renderAcademicCalendar(monthDate, academicCalendarEvents);
            } catch (error) {
                console.error('Error fetching academic schedule data:', error);
                academicScheduleDisplaySection.innerHTML = '<p class="text-base text-red-500">학사일정 정보를 가져오는 중 오류가 발생했습니다.</p>';
            }
        }

        /**
         * 이전 달로 이동합니다.
         */
        function goToPrevAcademicMonth() {
            academicCurrentDate.setMonth(academicCurrentDate.getMonth() - 1);
            getAcademicCalendar(academicCurrentDate);
        }

        /**
         * 다음 달로 이동합니다.
         */
        function goToNextAcademicMonth() {
            academicCurrentDate.setMonth(academicCurrentDate.getMonth() + 1);
            getAcademicCalendar(academicCurrentDate);
        }


        // --- Timetable Functions ---

        /**
         * Calculates the dates for Monday to Friday of the current week.
         * @returns {string[]} An array of dates in `YYYYMMDD` format (e.g., ["20231023", "20231024", ...]).
         */
        function getWeekDates() {
            const today = new Date();
            const dayOfWeek = today.getDay(); // 0 for Sunday, 1 for Monday, ..., 6 for Saturday
            const diff = today.getDate() - dayOfWeek + (dayOfWeek === 0 ? -6 : 1); // Adjust to Monday
            const monday = new Date(today.setDate(diff));

            const weekDates = [];
            for (let i = 0; i < 5; i++) { // Monday to Friday
                const date = new Date(monday);
                date.setDate(monday.getDate() + i);
                const year = date.getFullYear();
                const month = String(date.getMonth() + 1).padStart(2, '0');
                const day = String(date.getDate()).padStart(2, '0');
                weekDates.push(`${year}${month}${day}`);
            }
            return weekDates;
        }

        /**
         * Fetches user profile from Firestore.
         * @param {string} userId - The unique ID of the current user.
         * @returns {Object|null} The user profile data or null if not found/error.
         */
        async function getUserProfile(userId) {
            if (!db) {
                console.error('Firestore instance is not initialized.');
                return null;
            }
            const userProfileRef = db.collection(`artifacts/${appId}/users/${userId}/profile`).doc('user_data');
            try {
                const doc = await userProfileRef.get();
                if (doc.exists) {
                    return doc.data();
                } else {
                    console.log('User profile data not found.');
                    return null;
                }
            } catch (error) {
                console.error('Error fetching user profile:', error);
                return null;
            }
        }

        /**
         * Generates the HTML for the timetable skeleton loader.
         * @returns {string} The HTML string for the skeleton loader.
         */
        function generateTimetableSkeleton() {
            const maxPeriodsSkeleton = 7; // Assuming max 7 periods for skeleton

            let skeletonHtml = `
                <table class="timetable-table w-full">
                    <thead>
                        <tr class="bg-white">
                            <th><div class="skeleton skeleton-text w-12 mx-auto"></div></th>
                            <th><div class="skeleton skeleton-text w-12 mx-auto"></div></th>
                            <th><div class="skeleton skeleton-text w-12 mx-auto"></div></th>
                            <th><div class="skeleton skeleton-text w-12 mx-auto"></div></th>
                            <th><div class="skeleton skeleton-text w-12 mx-auto"></div></th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            for (let i = 1; i <= maxPeriodsSkeleton; i++) {
                if (i === 5) { // Lunch break
                    skeletonHtml += `
                        <tr>
                            <td colspan="5" class="lunch-break"><div class="skeleton skeleton-text w-24 h-4 mx-auto"></div></td>
                        </tr>
                    `;
                }
                skeletonHtml += `
                    <tr>
                        <td><div class="skeleton skeleton-text w-20 h-4 mx-auto"></div></td>
                        <td><div class="skeleton skeleton-text w-20 h-4 mx-auto"></div></td>
                        <td><div class="skeleton skeleton-text w-20 h-4 mx-auto"></div></td>
                        <td><div class="skeleton skeleton-text w-20 h-4 mx-auto"></div></td>
                        <td><div class="skeleton skeleton-text w-20 h-4 mx-auto"></div></td>
                    </tr>
                `;
            }

            skeletonHtml += `
                    </tbody>
                </table>
            `;
            return skeletonHtml;
        }

        /**
         * Fetches and displays weekly timetable data from the NEIS API.
         * @param {string} grade - The selected grade.
         * @param {string} classNum - The selected class number.
         */
        async function fetchTimetableData(grade, classNum) {
            if (!grade || !classNum) {
                timetableDisplaySection.innerHTML = '<p class="text-lg text-gray-700">학년과 반 정보가 유효하지 않습니다.</p>'; // (접근성 개선)
                return;
            }

            const weekDates = getWeekDates();
            const fetchPromises = weekDates.map(date => {
                const apiUrl = `https://open.neis.go.kr/hub/misTimetable?KEY=${neisApiKey}&Type=json&pIndex=1&pSize=100&ATPT_OFCDC_SC_CODE=${eduCode}&SD_SCHUL_CODE=${schoolCode}&ALL_TI_YMD=${date}&GRADE=${grade}&CLASS_NM=${classNum}`;
                return fetch(apiUrl)
                    .then(response => response.json())
                    .then(data => {
                        const currentDay = new Date(parseInt(date.substring(0,4)), parseInt(date.substring(4,6)) - 1, parseInt(date.substring(6,8))).getDay();
                        const dailyTimetable = {};
                        if (data.misTimetable && data.misTimetable[1] && data.misTimetable[1].row) {
                            data.misTimetable[1].row.forEach(period => {
                                let content = period.ITRT_CNTNT.replace(/\(자\)(주제선택활동|진로탐색활동)/g, (match, p1) => {
                                    return p1 === '주제선택활동' ? '주제선택' : '진로탐색';
                                });
                                content = content.replace(/\(창\)동아리활동/g, '동아리');
                                content = content.replace(/\(창\)자율·자치활동/g, '창체');
                                dailyTimetable[parseInt(period.PERIO)] = content;
                            });
                        } else if (data.RESULT && data.RESULT.CODE === 'INFO-200') {
                            console.log(`No timetable for ${date}`);
                        } else {
                            console.error(`API response error for date ${date}:`, data);
                        }
                        return { date: currentDay, data: dailyTimetable };
                    })
                    .catch(error => {
                        console.error(`Error fetching timetable data for date ${date}:`, error);
                        return { date: new Date(parseInt(date.substring(0,4)), parseInt(date.substring(4,6)) - 1, parseInt(date.substring(6,8))).getDay(), data: {} }; // Return empty data on error
                    });
            });

            try {
                const results = await Promise.all(fetchPromises);
                const weeklyTimetableData = {};
                results.forEach(result => {
                    weeklyTimetableData[result.date] = result.data;
                });
                renderWeeklyTimetable(weeklyTimetableData);
            } catch (error) {
                console.error('Error in Promise.all for timetable data:', error);
                timetableDisplaySection.innerHTML = '<p class="text-base text-red-500">시간표 정보를 가져오는 중 오류가 발생했습니다.</p>';
            }
        }

        /**
         * Renders the fetched weekly timetable data into an HTML table.
         * @param {Object} weeklyTimetableData - The object containing timetable data.
         */
        function renderWeeklyTimetable(weeklyTimetableData) {
            const daysHeaders = ['월', '화', '수', '목', '금'];
            const daysMapping = [1, 2, 3, 4, 5];
            const maxPeriods = 7;

            let tableHtml = `
                <table class="timetable-table">
                    <thead>
                        <tr class="bg-white">
                            ${daysHeaders.map(day => `<th>${day}</th>`).join('')}
                        </tr>
                    </thead>
                    <tbody>
            `;

            for (let i = 1; i <= maxPeriods; i++) {
                if (i === 5) { // Lunch break
                    tableHtml += `
                        <tr>
                            <td colspan="5" class="lunch-break">점심시간</td>
                        </tr>
                    `;
                }

                tableHtml += `
                    <tr>
                `;
                for (let j = 0; j < daysMapping.length; j++) {
                    const dayKey = daysMapping[j];
                    const subject = weeklyTimetableData[dayKey] && weeklyTimetableData[dayKey][i] ? weeklyTimetableData[dayKey][i] : '';
                    tableHtml += `
                        <td>
                            <div class="whitespace-normal">${subject}</div>
                        </td>
                    `;
                }
                tableHtml += `</tr>`;
            }

            tableHtml += `
                    </tbody>
                </table>
            `;

            timetableDisplaySection.innerHTML = tableHtml;
        }


        // --- Meal Functions ---

        /**
         * Calculates the dates and names for Monday to Friday of the current week.
         * @returns {Array<Object>} An array of objects, each with { dayName: string, date: string (YYYYMMDD) }.
         */
        function getMealWeekdaysInfo() {
            const today = new Date();
            const dayOfWeek = today.getDay(); // 0: Sunday, 1: Monday, ..., 6: Saturday
            const monday = new Date(today);
            monday.setDate(today.getDate() - dayOfWeek + (dayOfWeek === 0 ? -6 : 1));

            const weekdaysInfo = [];
            const dayNames = ['월', '화', '수', '목', '금'];

            for (let i = 0; i < 5; i++) {
                const date = new Date(monday);
                date.setDate(monday.getDate() + i);
                const year = date.getFullYear();
                const month = String(date.getMonth() + 1).padStart(2, '0');
                const day = String(date.getDate()).padStart(2, '0');
                weekdaysInfo.push({
                    dayName: dayNames[i],
                    date: `${year}${month}${day}`
                });
            }
            return weekdaysInfo;
        }

        /**
         * Renders the date selection buttons (월~금) and the "날짜 선택" button for meal.
         * Attaches event listeners.
         * @param {string} initialDateYYYYMMDD - The date to be initially selected/active.
         */
        function renderMealDateButtons(initialDateYYYYMMDD) {
            const weekdaysInfo = getMealWeekdaysInfo();
            mealDateButtonsContainer.innerHTML = '';
            mealDatePicker.classList.add('hidden');

            weekdaysInfo.forEach(dayInfo => {
                const button = document.createElement('button');
                button.classList.add('date-button');
                button.textContent = dayInfo.dayName;
                button.dataset.date = dayInfo.date;

                button.addEventListener('click', () => {
                    handleMealDateButtonClick(button, dayInfo.date);
                });
                mealDateButtonsContainer.appendChild(button);
            });

            const customDateButton = document.createElement('button');
            customDateButton.id = 'mealCustomDateSelectButton';
            customDateButton.classList.add('date-button');
            customDateButton.textContent = '날짜 선택';
            customDateButton.addEventListener('click', showMealDatePicker);
            mealDateButtonsContainer.appendChild(customDateButton);

            let foundActiveWeekday = false;
            weekdaysInfo.forEach(dayInfo => {
                if (dayInfo.date === initialDateYYYYMMDD) {
                    document.querySelector(`#meal-date-buttons-container .date-button[data-date="${dayInfo.date}"]`).classList.add('active');
                    foundActiveWeekday = true;
                }
            });

            if (!foundActiveWeekday) {
                customDateButton.classList.add('active');
            }
        }

        /**
         * Handles clicks on weekday date buttons for meal.
         * @param {HTMLElement} clickedButton - The button element that was clicked.
         * @param {string} selectedDate - The date string associated with the button.
         */
        function handleMealDateButtonClick(clickedButton, selectedDate) {
            mealDatePicker.classList.add('hidden');

            document.querySelectorAll('#meal-date-buttons-container .date-button').forEach(btn => btn.classList.remove('active'));
            clickedButton.classList.add('active');

            mealCurrentSelectedDate = selectedDate;
            fetchMealData(mealCurrentSelectedDate);
        }

        /**
         * Shows the date picker input for meal and clears active state from other buttons.
         */
        function showMealDatePicker() {
            document.querySelectorAll('#meal-date-buttons-container .date-button').forEach(btn => btn.classList.remove('active'));
            document.getElementById('mealCustomDateSelectButton').classList.add('active');

            mealDatePicker.classList.remove('hidden');
            if (mealCurrentSelectedDate) {
                mealDatePicker.value = `${mealCurrentSelectedDate.substring(0,4)}-${mealCurrentSelectedDate.substring(4,6)}-${mealCurrentSelectedDate.substring(6,8)}`;
            } else {
                const today = new Date();
                const year = today.getFullYear();
                const month = String(today.getMonth() + 1).padStart(2, '0');
                const day = String(today.getDate()).padStart(2, '0');
                mealDatePicker.value = `${year}-${month}-${day}`;
            }
        }

        /**
         * Handles date selection from the date picker input for meal.
         */
        function handleMealDatePickerChange() {
            const selectedDate = mealDatePicker.value.replace(/-/g, '');
            if (selectedDate) {
                document.querySelectorAll('#meal-date-buttons-container .date-button').forEach(btn => btn.classList.remove('active'));
                document.getElementById('mealCustomDateSelectButton').classList.add('active');

                mealCurrentSelectedDate = selectedDate;
                fetchMealData(mealCurrentSelectedDate);
            }
        }

        /**
         * Fetches and displays meal data from NEIS API for a specific date.
         * @param {string} date - The date in INSEE_MMDD format for which to fetch meal data.
         */
        async function fetchMealData(date) {
            mealDisplaySection.innerHTML = `
                <div class="w-full">
                    <div class="skeleton skeleton-text w-full"></div>
                    <div class="skeleton skeleton-text w-5/6"></div>
                    <div class="skeleton skeleton-text w-3/4"></div>
                    <div class="skeleton skeleton-text w-1/2"></div>
                </div>
            `;

            const apiUrl = `https://open.neis.go.kr/hub/mealServiceDietInfo?KEY=${neisApiKey}&Type=json&pIndex=1&pSize=100&ATPT_OFCDC_SC_CODE=${eduCode}&SD_SCHUL_CODE=${schoolCode}&MLSV_YMD=${date}`;

            try {
                const response = await fetch(apiUrl);
                const data = await response.json();

                if (data.mealServiceDietInfo && data.mealServiceDietInfo[1] && data.mealServiceDietInfo[1].row) {
                    const meals = data.mealServiceDietInfo[1].row;
                    const lunchMeal = meals.find(meal => meal.MMEAL_SC_NM === '중식');

                    if (lunchMeal) {
                        const menu = lunchMeal.DDISH_NM.replace(/\([^)]*\)/g, '').trim();
                        const menuItems = menu.split('<br/>').map(item => item.trim()).filter(item => item !== '');

                        let menuHtml = '<div class="text-left">';
                        if (menuItems.length > 0) {
                            menuItems.forEach(item => {
                                menuHtml += `<p class="text-base font-medium text-gray-800">${item}</p>`;
                            });
                        } else {
                            menuHtml += `<p class="text-base text-gray-700">이 날짜의 중식 메뉴는 비어 있습니다.</p>`; // (접근성 개선)
                        }
                        menuHtml += '</div>';
                        mealDisplaySection.innerHTML = menuHtml;
                    } else {
                        mealDisplaySection.innerHTML = '<p class="text-base text-gray-700">선택된 날짜의 중식 정보가 없어요.</p>'; // (접근성 개선)
                    }
                } else if (data.RESULT && data.RESULT.CODE === 'INFO-200') {
                    mealDisplaySection.innerHTML = '<p class="text-base text-gray-700">등록된 급식이 없어요.</p>'; // (접근성 개선)
                } else {
                    mealDisplaySection.innerHTML = '<p class="text-base text-red-500">급식 정보를 가져오는 데 실패했습니다.</p>';
                }
            } catch (error) {
                console.error('Error fetching meal data:', error);
                mealDisplaySection.innerHTML = '<p class="text-base text-red-500">급식 정보를 가져오는 중 오류가 발생했습니다.</p>';
            }
        }


        // --- Common Functions (Account, Navigation) ---

        /**
         * Toggles the visibility of the account dropdown menu.
         */
        function toggleDropdown() {
            accountDropdown.classList.toggle('hidden');
        }

        /**
         * Handles user logout.
         */
        async function handleLogout() {
            if (auth) {
                try {
                    await auth.signOut();
                    console.log('로그아웃 성공.');
                    window.location.href = '/login';
                } catch (error) {
                    console.error('로그아웃 오류:', error);
                }
            }
        }

        /**
         * Handles navigation to the settings page.
         */
        function handleSettingsClick() {
            window.location.href = '/settings';
        }

        /**
         * Updates the account UI based on user authentication status.
         * Displays email prefix if logged in, otherwise "로그인" button.
         * @param {firebase.User} user - The authenticated user object or null.
         */
        async function updateAccountUI(user) {
            if (user && user.email) {
                const emailPrefix = user.email.split('@')[0];
                accountStatusArea.innerHTML = `
                    <button id="accountTabButton" class="flex items-center space-x-2 p-2 rounded-full hover:bg-gray-100 focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <span class="text-gray-700 text-sm font-medium">${emailPrefix}</span>
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-user-circle-2"><path d="M18 20a6 6 0 0 0-12 0"/><circle cx="12" cy="10" r="4"/><circle cx="12" cy="12" r="10"/></svg>
                    </button>
                `;
                document.getElementById('accountTabButton').addEventListener('click', toggleDropdown);

                const settingsButton = document.getElementById('settingsButton');
                if (settingsButton && !settingsButton.dataset.listenerAdded) {
                    settingsButton.addEventListener('click', handleSettingsClick);
                    settingsButton.dataset.listenerAdded = 'true';
                }
                const logoutButton = document.getElementById('logoutButton');
                if (logoutButton && !logoutButton.dataset.listenerAdded) {
                    logoutButton.addEventListener('click', handleLogout);
                    logoutButton.dataset.listenerAdded = 'true';
                }
            } else {
                accountStatusArea.innerHTML = `
                    <button id="loginRedirectButton" class="bg-blue-500 hover:bg-blue-600 text-white font-medium py-2 px-4 rounded-full shadow transition duration-300">
                        로그인
                    </button>
                `;
                document.getElementById('loginRedirectButton').addEventListener('click', () => {
                    window.location.href = '/login';
                });
                accountDropdown.classList.add('hidden');
            }
            lucide.createIcons(); // Still need to create Lucide icons for the account status area (user-circle-2)
        }

        /**
         * Updates the active state of the navigation bar buttons based on the current URL path.
         */
        function updateNavigationActiveState() {
            const currentPath = window.location.pathname;
            const navItems = document.querySelectorAll('.nav-item');

            navItems.forEach(item => {
                const itemPath = item.dataset.path;
                const spanElement = item.querySelector('span');
                const svgElement = item.querySelector('svg');

                item.classList.remove('text-blue-600');
                item.classList.add('text-gray-500', 'hover:text-blue-500', 'hover:bg-gray-50');
                if (spanElement) {
                    spanElement.classList.remove('font-bold');
                    spanElement.classList.add('font-medium');
                }
                if (svgElement) {
                    svgElement.classList.remove('text-blue-600');
                    svgElement.classList.add('text-gray-500'); // Ensure SVG also has gray base color
                }

                // Check for exact path match or if it's the school-life button and current path is one of the sub-paths
                if (currentPath === itemPath || (itemPath === '/school-life' && (currentPath === '/sclife/timetable' || currentPath === '/sclife/meal' || currentPath === '/sclife/schedule'))) {
                    item.classList.add('text-blue-600');
                    item.classList.remove('text-gray-500', 'hover:text-blue-500', 'hover:bg-gray-50');
                    if (spanElement) {
                        spanElement.classList.add('font-bold');
                        spanElement.classList.remove('font-medium');
                    }
                    if (svgElement) {
                        svgElement.classList.add('text-blue-600'); // Apply blue color to active SVG
                        svgElement.classList.remove('text-gray-500');
                    }
                }
            });
        }

        /**
         * Sets up click event listeners for navigation items.
         */
        function setupNavigationEvents() {
            const navItems = document.querySelectorAll('.nav-item');
            navItems.forEach(item => {
                item.addEventListener('click', () => {
                    const path = item.dataset.path;
                    if (window.location.pathname !== path) {
                        // Store the current tab if navigating to school-life from another school-life tab
                        // or from a different page to a specific school-life tab.
                        const currentActiveTab = document.querySelector('.tab-button.active');
                        // Store the current active sub-tab if navigating to or within school-life paths
                        if (currentActiveTab && (path === '/school-life' || path.startsWith('/sclife/'))) {
                             localStorage.setItem('initialSchoolLifeTab', currentActiveTab.dataset.tabId);
                        }
                        window.location.href = path;
                    }
                });
            });
        }


        // --- Initialization on DOMContentLoaded ---
        document.addEventListener('DOMContentLoaded', async () => {
            // Firebase initialization
            if (firebaseConfig && firebaseConfig.apiKey) {
                if (firebase.apps.length === 0) {
                    try {
                        app = firebase.initializeApp(firebaseConfig);
                        auth = firebase.auth();
                        db = firebase.firestore();
                        console.log('Firebase 앱, 인증, Firestore 초기화 성공.');

                        auth.onAuthStateChanged(async (user) => {
                            await updateAccountUI(user);
                            const currentPath = window.location.pathname;
                            let initialTab = 'timetableContent'; // Default tab

                            // Determine initial tab to show based on URL
                            if (currentPath === '/sclife/timetable') {
                                initialTab = 'timetableContent';
                            } else if (currentPath === '/sclife/meal') {
                                initialTab = 'mealContent';
                            } else if (currentPath === '/sclife/schedule') {
                                initialTab = 'academicScheduleContent';
                            } else {
                                // If not a specific /sclife/ path, check localStorage (e.g., from bottom nav or direct /school-life)
                                initialTab = localStorage.getItem('initialSchoolLifeTab') || 'timetableContent';
                                localStorage.removeItem('initialSchoolLifeTab'); // Clear after use
                            }
                            showTab(initialTab);
                        });

                    } catch (error) {
                        console.error('Firebase 초기화 실패:', error);
                        await updateAccountUI(null);
                        const currentPath = window.location.pathname;
                        let initialTab = 'timetableContent';
                        if (currentPath === '/sclife/timetable') {
                            initialTab = 'timetableContent';
                        } else if (currentPath === '/sclife/meal') {
                            initialTab = 'mealContent';
                        } else if (currentPath === '/sclife/schedule') {
                            initialTab = 'academicScheduleContent';
                        } else {
                            initialTab = localStorage.getItem('initialSchoolLifeTab') || 'timetableContent';
                            localStorage.removeItem('initialSchoolLifeTab');
                        }
                        showTab(initialTab);
                    }
                } else {
                    app = firebase.app();
                    auth = firebase.auth();
                    db = firebase.firestore();
                    console.log('Firebase 앱이 이미 초기화되었습니다. 기존 인스턴스를 사용합니다.');
                    auth.onAuthStateChanged(async (user) => {
                        await updateAccountUI(user);
                        const currentPath = window.location.pathname;
                        let initialTab = 'timetableContent';
                        if (currentPath === '/sclife/timetable') {
                            initialTab = 'timetableContent';
                        } else if (currentPath === '/sclife/meal') {
                            initialTab = 'mealContent';
                        } else if (currentPath === '/sclife/schedule') {
                            initialTab = 'academicScheduleContent';
                        } else {
                            initialTab = localStorage.getItem('initialSchoolLifeTab') || 'timetableContent';
                            localStorage.removeItem('initialSchoolLifeTab');
                        }
                        showTab(initialTab);
                    });
                }
            } else {
                console.warn('Firebase 구성이 제대로 제공되지 않았습니다. Firebase를 초기화할 수 없습니다.');
                await updateAccountUI(null);
                const currentPath = window.location.pathname;
                let initialTab = 'timetableContent';
                if (currentPath === '/sclife/timetable') {
                    initialTab = 'timetableContent';
                } else if (currentPath === '/sclife/meal') {
                    initialTab = 'mealContent';
                } else if (currentPath === '/sclife/schedule') {
                    initialTab = 'academicScheduleContent';
                } else {
                    initialTab = localStorage.getItem('initialSchoolLifeTab') || 'timetableContent';
                    localStorage.removeItem('initialSchoolLifeTab');
                }
                showTab(initialTab);
            }

            // Attach event listeners for tab buttons
            tabButtons.forEach(button => {
                button.addEventListener('click', () => {
                    const path = button.dataset.path;
                    if (window.location.pathname !== path) {
                        window.location.href = path;
                    } else if (path && window.location.pathname === path) {
                        // If already on the same path, just ensure the tab is displayed (e.g., after initial load)
                        showTab(button.dataset.tabId);
                    }
                });
            });

            // Attach event listeners for Academic Schedule (only prev/next month)
            academicPrevMonthButton.addEventListener('click', goToPrevAcademicMonth);
            academicNextMonthButton.addEventListener('click', goToNextAcademicMonth);

            // Attach event listener for Meal Date Picker
            mealDatePicker.addEventListener('change', handleMealDatePickerChange);

            // Global click listener to close dropdown when clicking outside
            window.addEventListener('click', function(e) {
                const accountTabButton = document.getElementById('accountTabButton');
                if (accountTabButton && !accountTabButton.contains(e.target) && !accountDropdown.contains(e.target)) {
                    accountDropdown.classList.add('hidden');
                }
            });

            // Setup navigation click handlers
            setupNavigationEvents();
            // Update navigation active state on initial load
            updateNavigationActiveState();

            // Re-render timetable on window resize (to adjust content dynamically if needed)
            let resizeTimeout;
            window.addEventListener('resize', () => {
                clearTimeout(resizeTimeout);
                resizeTimeout = setTimeout(() => {
                    // Only re-fetch if the timetable tab is currently active
                    if (!timetableContent.classList.contains('hidden') && loadedTabs['timetableContent']) {
                        fetchTimetableData(timetableUserGrade, timetableUserClassNum);
                    }
                }, 200);
            });

            // Initial icon creation for Lucide icons still used (e.g., account dropdown, calendar navigation)
            lucide.createIcons();
        });
    </script>
</body>
</html>
