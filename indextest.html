<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>학교생활 정보 앱</title>
<link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@24,400,0,0" />
<style>
:root{
  /* 다크모드 테마 (토스 앱 느낌) */
  --brand:#6A5AF8;
  --brand-600:#5748D8;
  --brand-50:#2E265C;

  --bg:#121212;
  --surface:#1F1F1F;
  --text:#FFFFFF;
  --muted:#A9A9A9;
  --hairline:#333333;

  --radius:16px;
  --radius-sm:12px;

  --app-max:1024px;
  --app-pad:16px;
  --bar-h:56px;
  --tab-h:64px;
}

/* 라이트모드 테마 (다크모드 변수 오버라이드) */
body.light-mode {
  --bg:#F5F7FA;
  --surface:#FFFFFF;
  --text:#0F172A;
  --muted:#667085;
  --hairline:#E5E7EB;

  /* 라이트모드에서 일부 요소 색상 재정의 */
  --brand:#4A90E2;
  --brand-600:#3A7ACF;
  --brand-50:#EAF2FF;
}

/* 전체 화면에 중앙 앱 캔버스(태블릿) 고정 */
html,body{height:100%; margin:0}
body{
  background:var(--bg);
  color:var(--text);
  font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Noto Sans KR","Apple SD Gothic Neo","Pretendard","Malgun Gothic",sans-serif;
  -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale;
}
.app-wrap{
  height:100dvh;
  display:grid; place-items:center;
  padding:calc(env(safe-area-inset-top,0px)) 0 calc(env(safe-area-inset-bottom,0px));
}
.shell{
  width:clamp(360px, 78vw, var(--app-max));
  height:100dvh;
  display:grid; grid-template-rows:var(--bar-h) 1fr var(--tab-h);
  background:var(--surface);
  border-left:1px solid var(--hairline);
  border-right:1px solid var(--hairline);
}

/* 상단 앱바 */
.appbar{
  display:flex; align-items:center; justify-content:space-between;
  padding:0 14px;
  border-bottom:1px solid var(--hairline);
  background:var(--surface);
}
.appbar .title{font-weight:800; letter-spacing:-0.2px}
.appbar .actions{display:flex; gap:8px; position: relative;}

/* 모든 버튼에 클릭 효과 적용 */
.btn, .chip, .icon-btn, .quick-item, .fab, .card-link, .dropdown-btn {
    transition: transform 0.1s ease-in-out;
}
.btn:active, .chip:active, .icon-btn:active, .quick-item:active, .fab:active, .card-link:active, .dropdown-btn:active {
    transform: scale(0.98);
}

.btn, .chip{
  border:1px solid var(--hairline); background:var(--surface); color:var(--text);
  height:34px; padding:0 12px; border-radius:12px; font-weight:700; cursor:pointer;
}
.icon-btn{
  width:34px; height:34px; border:1px solid var(--hairline); border-radius:12px; background:var(--surface); color:var(--text); cursor:pointer;
  display: grid;
  place-items: center;
}
.material-symbols-outlined {
    font-size: 20px;
    font-variation-settings:
    'FILL' 0,
    'wght' 400,
    'GRAD' 0,
    'opsz' 24
}
.icon-btn .moon-icon {
    display: none;
}
body.light-mode .icon-btn .sun-icon {
    display: none;
}
body.light-mode .icon-btn .moon-icon {
    display: block;
}
/* 라이트 모드에서 아이콘 색상 변경 */
body.light-mode .material-symbols-outlined {
    color: var(--text);
}


/* 페이지 컨테이너: 스크롤 방지 */
.page-container {
    width: 100%;
    height: 100%;
    overflow: hidden;
}
.page{
  display: none; /* 기본적으로 페이지를 숨김 */
  width: 100%;
  height: 100%;
  overflow-y: auto; /* 개별 페이지 스크롤 허용 */
  padding:var(--app-pad) var(--app-pad) calc(var(--app-pad) + 24px);
  box-sizing: border-box; /* 패딩이 너비/높이에 포함되도록 설정 */
}
.page.active {
    display: block; /* 활성화된 페이지를 표시 */
}

.section-title{margin:6px 2px 10px; font-weight:800; font-size:15px}
.sub{font-size:12px; color:var(--muted)}
.card-title-row {
    display: flex;
    justify-content: space-between;
    align-items: center;
}
.hidden{display: none;}

/* 카드/라인: 그림자 없음 */
.card{
  background:var(--surface); border:1px solid var(--hairline);
  border-radius:var(--radius); padding:16px;
}
.card-link {
    display: block;
    cursor: pointer;
    text-decoration: none;
    color: inherit;
    transition: background-color 0.1s ease-in-out;
}
.card-link:hover {
    background-color: var(--hairline);
}

/* 리스트 */
.list{margin-top:10px; border:1px solid var(--hairline); border-radius:14px; overflow:hidden}
.cell{display:flex; align-items:center; gap:12px; padding:14px 16px; border-bottom:1px solid var(--hairline); background:var(--surface)}
.cell:last-child{border-bottom:none}
.avatar{width:40px; height:40px; border-radius:12px; background:var(--brand-50); color:var(--brand); display:grid; place-items:center; font-weight:800}
.cell .meta{flex:1}
.title{font-weight:700}
.amount{font-weight:800}
.positive{color:#16A34A}
.negative{color:#DC2626}

/* FAB + 탭바: 앱 패턴 유지 */
.fab{
  position:fixed;
  left:50%;
  transform:translateX(calc(-50% + min(39vw, var(--app-max)/2 - 24px)));
  bottom:calc(var(--tab-h) + 18px);
  width:56px; height:56px; border-radius:16px;
  background:var(--brand); color:#fff; display:grid; place-items:center; font-weight:800; border:0;
}
.tabbar{
  border-top:1px solid var(--hairline);
  background:rgba(31,31,31,0.96); backdrop-filter:saturate(180%) blur(8px);
}
body.light-mode .tabbar {
  background:rgba(255,255,255,0.96);
}

.tabs{height:var(--tab-h); display:grid; grid-template-columns:repeat(4,1fr)}
.tab{
  display:flex; flex-direction:column; align-items:center; justify-content:center; gap:4px;
  color:var(--muted); font-size:12px; border:0; background:transparent; cursor:pointer;
}
.tab .dot{width:6px; height:6px; border-radius:50%; background:transparent}
.tab.active{color:var(--brand)}
.tab.active .dot{background:var(--brand)}

/* 링크/포커스 */
a, button{color:inherit}
:focus-visible{outline:2px solid var(--brand); outline-offset:2px; border-radius:10px}

/* 반응형: 폰에서는 2열 그리드, 태블릿은 4열 유지 */
@media (max-width: 560px){
  .quick-grid{grid-template-columns:repeat(2,1fr)}
}
/* 넓은 데스크톱에서도 ‘앱 한 장’ 느낌 유지 */
@media (min-width: 1400px){
  .shell{width:clamp(360px, 56vw, var(--app-max))}
}

/* iOS 홈 인디케이터 여백 */
.tabbar{padding-bottom:calc(env(safe-area-inset-bottom, 0px) + 0px);}

/* 학교생활 서브 탭 */
.school-tabs {
    display: flex;
    gap: 10px;
    margin-bottom: 20px;
}
.school-tabs .chip {
    flex: 1;
    border: 1px solid var(--hairline);
    background: var(--surface);
    color: var(--muted);
    height: 40px;
    padding: 0 16px;
    border-radius: 12px;
    font-weight: 700;
    cursor: pointer;
    display: grid;
    place-items: center;
}
.school-tabs .chip.active {
    background: var(--brand-50);
    color: var(--brand);
    border-color: var(--brand-50);
}

/* 모달 스타일 */
.modal-overlay {
    position: absolute;
    top: 0; left: 0;
    width: 100%; height: 100%;
    backdrop-filter: blur(8px);
    background: rgba(0, 0, 0, 0.4);
    display: none;
    z-index: 10;
}
.modal-overlay.open {
    display: block;
}
.modal-content {
    position: absolute;
    bottom: 0; left: 0;
    width: 100%;
    max-height: 80%; /* 모달 최대 높이 설정 */
    overflow-y: auto; /* 내용이 넘치면 스크롤 가능 */
    background: var(--surface);
    border-top-left-radius: var(--radius);
    border-top-right-radius: var(--radius);
    padding: 16px;
    transform: translateY(100%);
    transition: transform 0.3s ease-in-out;
    box-sizing: border-box; /* 패딩이 너비/높이에 포함되도록 설정 */
}
.modal-content.is-open {
    transform: translateY(0);
}
.modal-close-handle {
    width: 40px;
    height: 4px;
    background-color: var(--muted);
    border-radius: 2px;
    margin: 0 auto 16px;
    cursor: pointer;
}

/* 달력 스타일 */
.calendar-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 16px;
}
.calendar-header .month-year {
    font-size: 18px;
    font-weight: 700;
}
.calendar-grid {
    display: grid;
    grid-template-columns: repeat(7, 1fr);
    text-align: center;
    gap: 8px;
}
.calendar-grid .day {
    padding: 8px;
    font-weight: 500;
    border-radius: 50%;
    cursor: pointer;
}
.calendar-grid .day.today {
    background: var(--brand);
    color: white;
}
.calendar-grid .weekday {
    font-weight: 700;
    color: var(--muted);
}

/* 커스텀 스크롤바 스타일 */
body::-webkit-scrollbar,
.page::-webkit-scrollbar,
.modal-content::-webkit-scrollbar {
    width: 6px;
}

body::-webkit-scrollbar-thumb,
.page::-webkit-scrollbar-thumb,
.modal-content::-webkit-scrollbar-thumb {
    background-color: rgba(255, 255, 255, 0.2);
    border-radius: 10px;
}

body.light-mode::-webkit-scrollbar-thumb,
.page.light-mode::-webkit-scrollbar-thumb,
.modal-content.light-mode::-webkit-scrollbar-thumb {
    background-color: rgba(0, 0, 0, 0.2);
}

body::-webkit-scrollbar-track,
.page::-webkit-scrollbar-track,
.modal-content::-webkit-scrollbar-track {
    background: transparent;
}

/* 커뮤니티 그리드 스타일 */
.community-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
    gap: 12px;
    margin-top: 10px;
}

.community-item {
  border: 1px solid var(--hairline);
  background: var(--surface);
  border-radius: var(--radius);
  padding: 14px;
  cursor: pointer;
  display: flex;
  flex-direction: column;
  gap: 8px;
}

.community-item .category {
    font-size: 12px;
    color: var(--brand);
}

.community-item .post-title {
    font-weight: 700;
    font-size: 15px;
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
    word-break: break-word;
}

.community-item .preview {
    font-size: 13px;
    line-height: 1.4;
    color: var(--muted);
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
    word-break: break-word;
}

.community-item .meta {
    font-size: 12px;
    color: var(--muted);
    margin-top: auto;
}

/* 사용자 드롭다운 메뉴 스타일 */
.user-dropdown-container {
    position: relative;
    display: none; /* 기본적으로 숨김 */
}

.user-dropdown-btn {
    display: flex;
    align-items: center;
    gap: 8px;
    border: 1px solid var(--hairline);
    background: var(--surface);
    color: var(--text);
    height: 34px;
    padding: 0 12px;
    border-radius: 12px;
    font-weight: 700;
    cursor: pointer;
}

.user-dropdown-menu {
    position: absolute;
    top: 40px;
    right: 0;
    width: 150px;
    background: var(--surface);
    border: 1px solid var(--hairline);
    border-radius: 12px;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    z-index: 20;
    display: none;
    flex-direction: column;
    overflow: hidden;
}

.user-dropdown-menu.active {
    display: flex;
}

.user-dropdown-menu button {
    background: transparent;
    border: none;
    color: var(--text);
    padding: 12px 16px;
    text-align: left;
    cursor: pointer;
    font-size: 14px;
    transition: background-color 0.1s ease-in-out;
}

.user-dropdown-menu button:hover {
    background-color: var(--hairline);
}
</style>
</head>
<body>
  <div class="app-wrap">
    <div class="shell" aria-label="앱 캔버스">

      <!-- 앱바 -->
      <header class="appbar">
        <div class="title" id="appTitle">홈</div>
        <div class="actions">
          <!-- 로그인 버튼 -->
          <a href="/login" class="btn" id="loginBtn">로그인</a>

          <!-- 사용자 드롭다운 (로그인 시 표시) -->
          <div class="user-dropdown-container" id="userDropdownContainer">
              <button class="user-dropdown-btn" id="userDropdownBtn">
                  <span id="userName">사용자</span>
                  <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24"><path d="M7 10l5 5 5-5z"/></svg>
              </button>
              <div class="user-dropdown-menu" id="userDropdownMenu">
                  <button id="editProfileBtn">프로필 편집</button>
                  <button id="logoutBtn">로그아웃</button>
              </div>
          </div>
          <button class="icon-btn" id="modeToggleBtn" aria-label="라이트모드/다크모드 토글">
            <span class="material-symbols-outlined sun-icon">light_mode</span>
            <span class="material-symbols-outlined moon-icon">dark_mode</span>
          </button>
        </div>
      </header>
      
      <!-- 페이지 컨테이너 -->
      <div class="page-container" id="pageContainer">
        <!-- 페이지: 홈 -->
        <main class="page active" id="page-home" role="region" aria-label="홈">
          <section class="card">
            <div class="card-title-row">
                <div class="section-title">오늘의 학교생활</div>
                <button id="today-info-btn" class="icon-btn" aria-label="오늘의 학교생활 정보 더보기">
                  <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24"><path d="M7 10l5 5 5-5z"/></svg>
                </button>
            </div>
            <div class="sub">오늘의 급식과 시간표를 확인하세요.</div>
            <div style="margin-top:10px; display:grid; gap:10px; grid-template-columns:repeat(2,1fr)">
              <div class="card" style="padding:12px">
                <div class="title">점심 급식</div>
                <div class="sub" style="margin-top:4px" id="mealMenu">급식 정보를 불러오는 중...</div>
              </div>
              <div class="card card-link timetable-quick-card" style="padding:12px">
                <div class="title">오늘의 시간표</div>
                <div class="sub" style="margin-top:4px" id="timetableInfo">시간표 정보를 불러오는 중...</div>
              </div>
            </div>
          </section>

          <div class="card-title-row">
              <h3 class="section-title">커뮤니티 새 소식 🔥</h3>
              <button class="btn" style="height:28px">더보기</button>
          </div>
          <div class="community-grid" role="region" aria-label="커뮤니티 최신 글">
              <div class="community-item">
                  <div class="category">#자유게시판</div>
                  <div class="post-title">봉사활동 신청 안내</div>
                  <div class="preview">이번 학기 봉사활동 신청을 6월 25일까지 받습니다. 신청서 양식은 학생회관 2층 게시판에서 확인해 주세요.</div>
                  <div class="meta">이종현 · 4일 전</div>
              </div>
              <div class="community-item">
                  <div class="category">#자유게시판</div>
                  <div class="post-title">학교 축제 아이디어 공모</div>
                  <div class="preview">다가오는 가을 축제 '하나 되는 우리'의 아이디어를 공모합니다! 공연, 부스, 이벤트 등 자유롭게 제안해 주세요.</div>
                  <div class="meta">코코몽 · 9일 전</div>
              </div>
              <div class="community-item">
                  <div class="category">#자유게시판</div>
                  <div class="post-title">기숙사생 외박 신청 안내</div>
                  <div class="preview">여름방학 기간 동안 기숙사 외박을 희망하는 학생들은 7월 5일까지 신청해 주시기 바랍니다.</div>
                  <div class="meta">오렌지 · 13일 전</div>
              </div>
              <div class="community-item">
                  <div class="category">#자유게시판</div>
                  <div class="post-title">체육대회 종목 투표</div>
                  <div class="preview">올해 체육대회에서 진행할 종목을 투표로 결정합니다. 농구, 피구, 이어달리기 등 선호하는 종목에 투표해 주세요.</div>
                  <div class="meta">체육부 · 18일 전</div>
              </div>
          </div>

          <h3 class="section-title">다가오는 학사일정</h3>
          <div class="list" role="list">
            <div class="cell" role="listitem">
              <div class="avatar">기</div>
              <div class="meta">
                <div class="title">기말고사 시작</div>
                <div class="sub">2025.07.01</div>
              </div>
            </div>
            <div class="cell" role="listitem">
              <div class="avatar">여</div>
              <div class="meta">
                <div class="title">여름방학식</div>
                <div class="sub">2025.07.10</div>
              </div>
            </div>
          </div>
        </main>

        <!-- 페이지: 학교생활 -->
        <main class="page" id="page-school" role="region" aria-label="학교생활">
          <div class="school-tabs">
            <button class="chip active" data-target="meal">급식</button>
            <button class="chip" data-target="timetable">시간표</button>
            <button class="chip" data-target="schedule">학사일정</button>
          </div>
          
          <div id="content-meal">
              <section class="card">
                  <div class="section-title">급식</div>
                  <div class="sub">오늘의 점심 메뉴</div>
                  <div style="margin-top:10px;">
                      <div class="list">
                          <div class="cell">
                              <div class="meta">
                                  <div class="title">점심</div>
                                  <div class="sub" id="schoolMealMenu">급식 정보를 불러오는 중...</div>
                              </div>
                          </div>
                      </div>
                  </div>
              </section>
          </div>

          <!-- initially hidden -->
          <div id="content-timetable" class="hidden">
              <section class="card">
                  <div class="section-title">시간표</div>
                  <div class="sub">오늘의 수업 시간표</div>
                  <div style="margin-top:10px;">
                      <div class="list" id="schoolTimetable">
                          <!-- Nice API data will be inserted here -->
                      </div>
                  </div>
              </section>
          </div>

          <!-- initially hidden -->
          <div id="content-schedule" class="hidden">
              <section class="card">
                  <div class="section-title">학사일정</div>
                  <div class="sub">다가오는 주요 일정</div>
                  <div style="margin-top:10px;">
                      <div class="list">
                          <div class="cell">
                              <div class="meta">
                                  <div class="title">7월 1일</div>
                                  <div class="sub">기말고사 시작</div>
                              </div>
                          </div>
                          <div class="cell">
                              <div class="meta">
                                  <div class="title">7월 10일</div>
                                  <div class="sub">여름방학식</div>
                              </div>
                          </div>
                      </div>
                  </div>
              </section>
          </div>
        </main>

        <!-- 페이지: 커뮤니티 -->
        <main class="page" id="page-community" role="region" aria-label="커뮤니티">
          <section class="card">
            <div class="section-title">커뮤니티</div>
            <div class="sub">자유 게시판, 동아리</div>
            <div style="margin-top:10px; border:1px dashed var(--hairline); border-radius:12px; padding:16px; text-align:center;">
              <p style="color:var(--muted)">다양한 소식을 공유해보세요!</p>
              <button class="chip" style="margin-top:12px; background:var(--brand); color:white; border-color:var(--brand);">글쓰기</button>
            </div>
          </section>
        </main>

        <!-- 페이지: 더보기 -->
        <main class="page" id="page-more" role="region" aria-label="더보기">
          <section class="card">
            <div class="section-title">더보기</div>
            <div class="sub">설정, 정보, 고객센터</div>
            <div style="margin-top:10px; display:grid; grid-template-columns:repeat(3,1fr); gap:10px">
              <button class="quick-item"><div class="quick-ico">설</div><div>설정</div></button>
              <button class="quick-item"><div class="quick-ico">공</div><div>공지사항</div></button>
              <button class="quick-item"><div class="quick-ico">도</div><div>도움말</div></button>
            </div>
          </section>
        </main>
      </div>

      <!-- 하단 탭바 -->
      <nav class="tabbar" role="tablist" aria-label="하단 내비게이션">
        <div class="tabs">
          <button class="tab active" data-target="home" role="tab" aria-selected="true">홈<span class="dot" aria-hidden="true"></span></button>
          <button class="tab" data-target="school" role="tab" aria-selected="false">학교생활<span class="dot" aria-hidden="true"></span></button>
          <button class="tab" data-target="community" role="tab" aria-selected="false">커뮤니티<span class="dot" aria-hidden="true"></span></button>
          <button class="tab" data-target="more" role="tab" aria-selected="false">더보기<span class="dot" aria-hidden="true"></span></button>
        </div>
      </nav>

      <!-- FAB -->
      <button class="fab" aria-label="새 글쓰기">＋</button>
    </div>
  </div>

  <!-- 달력 모달 -->
  <div class="modal-overlay" id="calendarModal">
    <div class="modal-content">
        <div class="modal-close-handle" id="modalCloseHandle"></div>
        <div class="calendar-header">
            <button class="icon-btn prev-month">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24"><path d="M15 19l-7-7 7-7z"/></svg>
            </button>
            <span class="month-year">2025년 9월</span>
            <button class="icon-btn next-month">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24"><path d="M10 6l-6 6 6 6z" transform="rotate(180 12 12)"/></svg>
            </button>
        </div>
        <div class="calendar-grid">
            <span class="weekday" style="color:#DC2626">일</span>
            <span class="weekday">월</span>
            <span class="weekday">화</span>
            <span class="weekday">수</span>
            <span class="weekday">목</span>
            <span class="weekday">금</span>
            <span class="weekday" style="color:#4A90E2">토</span>
            <span class="day muted">31</span>
            <span class="day">1</span>
            <span class="day">2</span>
            <span class="day">3</span>
            <span class="day">4</span>
            <span class="day">5</span>
            <span class="day">6</span>
            <span class="day">7</span>
            <span class="day">8</span>
            <span class="day">9</span>
            <span class="day">10</span>
            <span class="day">11</span>
            <span class="day">12</span>
            <span class="day">13</span>
            <span class="day">14</span>
            <span class="day">15</span>
            <span class="day">16</span>
            <span class="day">17</span>
            <span class="day">18</span>
            <span class="day">19</span>
            <span class="day">20</span>
            <span class="day">21</span>
            <span class="day">22</span>
            <span class="day">23</span>
            <span class="day">24</span>
            <span class="day">25</span>
            <span class="day">26</span>
            <span class="day">27</span>
            <span class="day">28</span>
            <span class="day">29</span>
            <span class="day">30</span>
        </div>
    </div>
  </div>

<script type="module">
  // Firebase SDK imports
  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
  import { getAuth, signInWithCustomToken, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
  import { getFirestore, doc, getDoc, setDoc, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

  // Global variables provided by the Canvas environment
  const __app_id = "n-mate";
  const __firebase_config = { 
    apiKey: "AIzaSyC_SHRcQ9hXmjVbP3km4rdR4UvKIoqpLHo", 
    authDomain: "n-mate.firebaseapp.com", 
    projectId: "n-mate", 
    storageBucket: "n-mate.firebasestorage.app", 
    messagingSenderId: "691313471077", 
    appId: "1:691313471077:web:3066aaeca0a1d9e448e08c", 
    measurementId: "G-0LCGVBKXLQ" 
  };
  
  // Set up Firebase and Firestore
  const firebaseConfig = __firebase_config;
  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);
  const auth = getAuth(app);
  setLogLevel('debug'); // Enable Firestore debug logs

  // Nice API key
  const NICE_API_KEY = "cbb4da48e87445f68c2732368454ebc3";

  // UI elements
  const loginBtn = document.getElementById('loginBtn');
  const userDropdownContainer = document.getElementById('userDropdownContainer');
  const userDropdownBtn = document.getElementById('userDropdownBtn');
  const userDropdownMenu = document.getElementById('userDropdownMenu');
  const userNameEl = document.getElementById('userName');
  const logoutBtn = document.getElementById('logoutBtn');
  const editProfileBtn = document.getElementById('editProfileBtn');
  const mealMenuEl = document.getElementById('mealMenu');
  const schoolMealMenuEl = document.getElementById('schoolMealMenu');
  const timetableInfoEl = document.getElementById('timetableInfo');
  const schoolTimetableEl = document.getElementById('schoolTimetable');

  // Utility function for displaying messages
  const showMessagePopup = (message) => {
    const messagePopup = document.createElement('div');
    messagePopup.textContent = message;
    messagePopup.style.cssText = `
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        padding: 16px 24px;
        background-color: rgba(0, 0, 0, 0.8);
        color: white;
        border-radius: 12px;
        z-index: 1000;
        opacity: 0;
        transition: opacity 0.3s ease-in-out;
    `;
    document.body.appendChild(messagePopup);
    setTimeout(() => messagePopup.style.opacity = '1', 10);
    setTimeout(() => {
        messagePopup.style.opacity = '0';
        setTimeout(() => document.body.removeChild(messagePopup), 300);
    }, 1500);
  };

  // Function to fetch and display user data
  async function fetchUserData(user) {
    if (!user) return;
    try {
      const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
      const userRef = doc(db, `artifacts/${appId}/users/${user.uid}/profile/user_data`);
      const userSnap = await getDoc(userRef);

      if (userSnap.exists()) {
        const userData = userSnap.data();
        console.log("Firebase user data retrieved:", userData);

        // Update UI with user's name
        userNameEl.textContent = userData.name || "사용자";

        // Call Nice API with fetched data (simulated)
        fetchNiceAPIData(userData.atptOfcdcScCode, userData.sdSchulCode, userData.grade, userData.classNum);
      } else {
        console.log("No user data found in Firestore.");
        // If no data, show message to set up profile.
        showMessagePopup("프로필을 설정해주세요.");
        // Set a default name
        userNameEl.textContent = "새 사용자";
      }
    } catch (error) {
      console.error("Error fetching user data:", error);
      showMessagePopup("사용자 정보를 불러오는 데 실패했습니다.");
    }
  }

  // Function to fetch Nice API data (simulated)
  const fetchNiceAPIData = (atptOfcdcScCode, sdSchulCode, grade, classNum) => {
    console.log(`Nice API key: ${NICE_API_KEY}`);
    console.log(`Simulating call to Nice API with parameters: 
        atptOfcdcScCode: ${atptOfcdcScCode}, 
        sdSchulCode: ${sdSchulCode},
        grade: ${grade},
        classNum: ${classNum}`);

    // Mock data based on the Nice API format
    const mockMealData = {
      mealServiceDietInfo: [
        {
          head: [{
            list_total_count: 1
          }, {
            RESULT: {
              CODE: "INFO-000",
              MESSAGE: "정상 처리되었습니다."
            }
          }],
          row: [{
            DDISH_NM: "혼합잡곡밥, 돼지고기김치찌개, 닭볶음탕, 오징어채볶음, 배추김치, 찐빵"
          }]
        }
      ]
    };

    const mockTimetableData = {
      elsTimetable: [
        {
          head: [{
            list_total_count: 6
          }, {
            RESULT: {
              CODE: "INFO-000",
              MESSAGE: "정상 처리되었습니다."
            }
          }],
          row: [{
            PERIO: 1,
            ITRT_CHTNM: "국어"
          }, {
            PERIO: 2,
            ITRT_CHTNM: "수학"
          }, {
            PERIO: 3,
            ITRT_CHTNM: "영어"
          }, {
            PERIO: 4,
            ITRT_CHTNM: "과학"
          }, {
            PERIO: 5,
            ITRT_CHTNM: "미술"
          }, {
            PERIO: 6,
            ITRT_CHTNM: "체육"
          }]
        }
      ]
    };
    
    // Process mock meal data
    const meal = mockMealData.mealServiceDietInfo[0].row[0].DDISH_NM;
    const formattedMeal = meal.replace(/ /g, ', ').replace(/,/g, ', '); // Simple formatting
    
    // Update UI with mock data
    mealMenuEl.textContent = formattedMeal;
    schoolMealMenuEl.textContent = formattedMeal;
    
    // Process mock timetable data
    const timetable = mockTimetableData.elsTimetable[0].row;
    let timetableHtml = '';
    let periods = 0;
    timetable.forEach(item => {
      timetableHtml += `
        <div class="cell">
          <div class="meta">
            <div class="title">${item.PERIO}교시</div>
            <div class="sub">${item.ITRT_CHTNM} (1학년 3반 교실)</div>
          </div>
        </div>`;
      periods++;
    });

    timetableInfoEl.textContent = `총 ${periods}교시`;
    schoolTimetableEl.innerHTML = timetableHtml;
  };

  // Auth state change listener
  onAuthStateChanged(auth, async (user) => {
    if (user) {
      // User is signed in
      loginBtn.style.display = 'none';
      userDropdownContainer.style.display = 'block';
      await fetchUserData(user);
    } else {
      // User is signed out
      loginBtn.style.display = 'block';
      userDropdownContainer.style.display = 'none';
      userNameEl.textContent = "사용자";
    }
  });

  // Initial sign-in with custom token
  if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token !== null) {
      signInWithCustomToken(auth, __initial_auth_token).catch((error) => {
          console.error("Custom token sign-in failed:", error);
      });
  } else {
      // No custom token provided. User cannot be authenticated.
      console.warn("사용자 정의 토큰이 제공되지 않아 로그인이 불가능합니다.");
  }

  // Event Listeners for the new UI elements
  userDropdownBtn.addEventListener('click', () => {
      userDropdownMenu.classList.toggle('active');
  });

  logoutBtn.addEventListener('click', () => {
      signOut(auth).then(() => {
          console.log("User signed out.");
          showMessagePopup("로그아웃 되었습니다.");
      }).catch((error) => {
          console.error("Sign out error:", error);
          showMessagePopup("로그아웃 중 오류가 발생했습니다.");
      });
  });

  editProfileBtn.addEventListener('click', () => {
      showMessagePopup("프로필 편집 페이지로 이동합니다!");
      // window.location.href = "/edit-profile"; // In a real app, you would navigate here
      userDropdownMenu.classList.remove('active');
  });

  // Close dropdown when clicking outside
  window.addEventListener('click', (event) => {
      if (!userDropdownContainer.contains(event.target)) {
          userDropdownMenu.classList.remove('active');
      }
  });

  // --- 기존 코드 유지 ---

  // 탭 라우팅
  const tabs = document.querySelectorAll('.tab');
  const pages = document.querySelectorAll('.page');
  const appTitle = document.getElementById('appTitle');

  const updatePage = (targetId) => {
    // 탭 활성화 상태 변경
    tabs.forEach(t => {
      t.classList.remove('active');
      t.setAttribute('aria-selected', 'false');
      if (t.dataset.target === targetId) {
        t.classList.add('active');
        t.setAttribute('aria-selected', 'true');
      }
    });

    // 페이지 가시성 변경
    pages.forEach(page => {
      if (page.id === `page-${targetId}`) {
        page.classList.add('active');
      } else {
        page.classList.remove('active');
      }
    });

    // 앱바 타이틀 변경
    const titles = {home:'홈', school:'학교생활', community:'커뮤니티', more:'더보기'};
    appTitle.textContent = titles[targetId] || '앱';
  };

  tabs.forEach(tab => {
    tab.addEventListener('click', () => {
      updatePage(tab.dataset.target);
    });
  });

  // 학교생활 페이지 서브 탭 라우팅
  const schoolTabs = document.querySelectorAll('.school-tabs .chip');
  const schoolContents = {
      meal: document.getElementById('content-meal'),
      timetable: document.getElementById('content-timetable'),
      schedule: document.getElementById('content-schedule')
  };

  const updateSchoolContent = (target) => {
      schoolTabs.forEach(t => t.classList.remove('active'));
      const activeTab = document.querySelector(`.school-tabs .chip[data-target="${target}"]`);
      if (activeTab) activeTab.classList.add('active');
      Object.entries(schoolContents).forEach(([k, el]) => el.classList.toggle('hidden', k !== target));
  };

  schoolTabs.forEach(tab => {
      tab.addEventListener('click', () => {
          updateSchoolContent(tab.dataset.target);
      });
  });

  // 홈 화면 시간표 카드 클릭 시 상세 시간표로 이동
  const timetableQuickCard = document.querySelector('.timetable-quick-card');
  if (timetableQuickCard) {
      timetableQuickCard.addEventListener('click', () => {
          updatePage('school');
          updateSchoolContent('timetable');
      });
  }

  // 모드 토글
  const modeToggleBtn = document.getElementById('modeToggleBtn');
  modeToggleBtn.addEventListener('click', () => {
    document.body.classList.toggle('light-mode');
    const isLightMode = document.body.classList.contains('light-mode');
    modeToggleBtn.setAttribute('aria-label', isLightMode ? '다크모드로 전환' : '라이트모드로 전환');
  });

  // FAB 클릭 시 메시지 표시
  document.querySelector('.fab').addEventListener('click', ()=>{
    showMessagePopup('새 글쓰기 페이지로 이동합니다!');
  });

  // 달력 모달 로직
  const calendarModal = document.getElementById('calendarModal');
  const modalContent = document.querySelector('.modal-content');
  const todayInfoBtn = document.getElementById('today-info-btn');
  const modalCloseHandle = document.getElementById('modalCloseHandle');

  todayInfoBtn.addEventListener('click', () => {
      calendarModal.classList.add('open');
      setTimeout(() => {
          modalContent.classList.add('is-open');
      }, 10);
  });

  function closeModal() {
      modalContent.classList.remove('is-open');
      modalContent.addEventListener('transitionend', () => {
          calendarModal.classList.remove('open');
      }, { once: true });
  }

  modalCloseHandle.addEventListener('click', closeModal);
  calendarModal.addEventListener('click', (e) => {
      if (e.target.id === 'calendarModal') {
          closeModal();
      }
  });

</script>
</body>
</html>
