<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>커뮤니티</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Nanum+Gothic:wght@400;700;800&display=swap');

        body {
            font-family: 'Nanum Gothic', sans-serif;
            background-color: #fff;
            margin: 0;
            padding: 0;
            color: #333;
        }

        .dc-top-bar {
            background-color: #2e64b3;
            height: 5px;
        }

        .dc-header {
            background-color: #f7f7f7;
            border-bottom: 1px solid #c7c7c7;
            padding: 10px 0;
        }

        .dc-header-inner {
            max-width: 1000px;
            margin: 0 auto;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .dc-logo-container {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 1.5rem;
            font-weight: 800;
            color: #2e64b3;
        }

        .dc-logo-container img {
            height: 30px;
        }

        .dc-search-form {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .dc-search-input {
            border: 1px solid #ccc;
            padding: 5px 10px;
            border-radius: 0;
            width: 300px;
            font-size: 0.875rem;
        }

        .dc-search-btn {
            background-color: #333;
            color: #fff;
            padding: 5px 10px;
            border-radius: 0;
            cursor: pointer;
        }

        .dc-nav {
            background-color: #3f7ac2;
        }

        .dc-nav-inner {
            max-width: 1000px;
            margin: 0 auto;
            display: flex;
            justify-content: flex-start;
            align-items: center;
            padding: 5px 0;
            font-size: 0.875rem;
        }

        .dc-nav-links {
            display: flex;
            gap: 1rem;
            color: #fff;
        }

        .dc-nav-links a {
            color: #fff;
            text-decoration: none;
        }

        .dc-nav-links a:hover {
            text-decoration: underline;
        }

        .dc-container {
            max-width: 1000px;
            margin: 1rem auto;
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 1rem;
        }
        
        @media (max-width: 768px) {
            .dc-container {
                grid-template-columns: 1fr;
            }
            .dc-right-sidebar {
                display: none;
            }
            .dc-header-inner {
                flex-direction: column;
                align-items: flex-start;
                gap: 10px;
            }
            .dc-search-form {
                width: 100%;
            }
            .dc-search-input {
                width: 100%;
            }
            .dc-nav-inner {
                flex-direction: row;
                justify-content: center;
                gap: 1rem;
                padding: 10px;
            }
            .dc-main-content {
                border: none;
            }
        }

        .dc-main-content {
            background-color: #fff;
            padding: 1rem;
            border: 1px solid #ccc;
        }

        .dc-sidebar {
            background-color: #f0f0f0;
            border: 1px solid #ccc;
            padding: 1rem;
        }

        .dc-section-title {
            font-weight: 700;
            color: #333;
            border-bottom: 2px solid #ccc;
            padding-bottom: 5px;
            margin-bottom: 1rem;
        }

        .dc-post-item {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
        }

        .dc-post-item img {
            width: 60px;
            height: 60px;
            object-fit: cover;
            border-radius: 0;
        }

        .dc-post-info {
            flex-grow: 1;
        }

        .dc-post-title {
            font-weight: 700;
            font-size: 0.9rem;
        }
        
        .dc-post-meta {
            font-size: 0.8rem;
            color: #888;
        }

        .dc-right-sidebar {
            background-color: #fff;
            padding: 1rem;
        }

        .dc-login-box {
            border: 1px solid #ccc;
            padding: 1rem;
            margin-bottom: 1rem;
            text-align: center;
        }

        .dc-login-box input {
            width: 100%;
            padding: 5px;
            border: 1px solid #ccc;
            margin-bottom: 5px;
        }

        .dc-login-btn {
            background-color: #2e64b3;
            color: #fff;
            width: 100%;
            padding: 8px;
            font-weight: 700;
            border-radius: 0;
            cursor: pointer;
            margin-top: 5px;
        }
        
        .dc-sub-list li {
            padding: 5px 0;
            font-size: 0.875rem;
        }
        .dc-channel-list {
            display: grid;
            gap: 1rem;
        }
        .dc-channel-group-title {
            font-size: 0.9rem;
            font-weight: bold;
            color: #333;
            padding-bottom: 5px;
            border-bottom: 1px solid #ccc;
            margin-top: 10px;
            margin-bottom: 5px;
        }
        .dc-channel-group-title:first-of-type {
            margin-top: 0;
        }
        .dc-channel-item-text {
            padding: 5px 0;
            font-size: 0.875rem;
        }
    </style>
</head>
<body>
    <div class="dc-top-bar"></div>
    <header class="dc-header">
        <div class="dc-header-inner">
            <div class="dc-logo-container">
                <img src="https://i.postimg.cc/rscRF3ky/simbol.webp" alt="커뮤니티 로고">
                <span>커뮤니티</span>
            </div>
            <div class="dc-search-form">
                <input type="text" placeholder="채널 & 통합검색" class="dc-search-input">
                <button class="dc-search-btn">Q</button>
            </div>
        </div>
    </header>
    <nav class="dc-nav">
        <div class="dc-nav-inner">
            <div class="dc-nav-links">
                <a href="#">채널</a>
                <a href="#">채널 히스토리</a>
            </div>
        </div>
    </nav>

    <div class="dc-container">
        <!-- 메인 콘텐츠 영역 -->
        <main class="dc-main-content">
            <div class="dc-section-title">
                <h2>전체 최신 글</h2>
            </div>
            <div id="latest-posts" class="mb-4"></div>
            
            <div class="flex items-center justify-between mb-2">
                <h2 class="font-bold text-lg">BEST</h2>
                <span class="text-sm">1 / 10</span>
            </div>
            <div id="realtime-best-posts" class="mb-4"></div>
            
            <div class="dc-section-title">
                <h2>전체 채널</h2>
            </div>
            <div id="all-channels" class="dc-channel-list"></div>
        </main>

        <!-- 오른쪽 사이드바 -->
        <aside class="dc-right-sidebar">
            <div id="auth-ui-container">
                <!-- 로그인 UI가 여기에 동적으로 삽입됩니다. -->
            </div>
            <!-- 인기 채널 리스트 -->
            <div class="dc-section-title">
                <h2>인기 채널</h2>
            </div>
            <ul id="popular-channels" class="dc-sub-list"></ul>
        </aside>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Global variables provided by the Canvas environment
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        // Firebase configuration provided by the user
        const firebaseConfig = {
            apiKey: "AIzaSyC_SHRcQ9hXmjVbP3km4rdR4UvKIoqpLHo",
            authDomain: "n-mate.firebaseapp.com",
            projectId: "n-mate",
            storageBucket: "n-mate.firebasestorage.app",
            messagingSenderId: "691313471077",
            appId: "1:691313471077:web:3066aaeca0a1d9e448e08c",
            measurementId: "G-0LCGVBKXLQ"
        };

        let auth, db;
        let isFirebaseReady = false;

        const authUIContainer = document.getElementById('auth-ui-container');

        // Check for valid Firebase configuration before initialization
        if (firebaseConfig && firebaseConfig.apiKey) {
            try {
                const app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);
                isFirebaseReady = true;
                
                // Listen for authentication state changes only if Firebase is ready
                onAuthStateChanged(auth, (user) => {
                    renderAuthUI(user);
                });
            } catch (error) {
                console.error("Firebase 초기화 중 오류가 발생했습니다:", error);
                authUIContainer.innerHTML = `<div class="dc-login-box text-red-500 font-bold">Firebase 초기화 실패.<br>설정을 확인하세요.</div>`;
            }
        } else {
            console.error("Firebase 설정이 유효하지 않습니다.");
            authUIContainer.innerHTML = `<div class="dc-login-box text-red-500 font-bold">Firebase 설정이 누락되었습니다.<br>일부 기능이 동작하지 않습니다.</div>`;
        }

        // Function to render UI based on authentication state
        async function renderAuthUI(user) {
            authUIContainer.innerHTML = '';
            
            if (user && db) {
                // User is signed in, show profile and logout button
                const userId = user.uid;
                const profileDocRef = doc(db, 'artifacts/' + appId + '/users/' + userId + '/user_data/profile');
                const profileDocSnap = await getDoc(profileDocRef);
                
                let userName = '손님';
                if (profileDocSnap.exists()) {
                    userName = profileDocSnap.data().name;
                } else {
                    // For demonstration, save a sample name
                    await setDoc(profileDocRef, { name: '테스트유저' });
                    userName = '테스트유저';
                }

                authUIContainer.innerHTML = `
                    <div class="dc-login-box">
                        <div class="text-lg font-bold mb-2">${userName}님</div>
                        <button id="logout-btn" class="dc-login-btn">로그아웃</button>
                    </div>
                `;
                document.getElementById('logout-btn').addEventListener('click', () => {
                    signOut(auth);
                });

            } else {
                // User is signed out, show login form
                authUIContainer.innerHTML = `
                    <div class="dc-login-box">
                        <input type="text" placeholder="아이디" id="username-input">
                        <input type="password" placeholder="비밀번호" id="password-input">
                        <button id="login-btn" class="dc-login-btn" ${isFirebaseReady ? '' : 'disabled'}>로그인</button>
                    </div>
                `;
                if (isFirebaseReady) {
                    document.getElementById('login-btn').addEventListener('click', async () => {
                        try {
                            if (initialAuthToken) {
                                await signInWithCustomToken(auth, initialAuthToken);
                            }
                        } catch (error) {
                            console.error("Error signing in: ", error);
                        }
                    });
                }
            }
        }

        // Call renderAuthUI for initial render
        renderAuthUI(null);

        // 나머지 기존 코드
        const realtimePostsData = [
            { title: 'BEST 게시글 1입니다.', author: 'BEST-1', date: '10:00', comments: 15, thumbnail: 'https://placehold.co/60x60/EFEFEF/999999?text=Image' },
            { title: 'BEST 게시글 2입니다.', author: 'BEST-2', date: '09:50', comments: 3, thumbnail: 'https://placehold.co/60x60/EFEFEF/999999?text=Image' },
            { title: 'BEST 게시글 3입니다.', author: 'BEST-3', date: '09:40', comments: 20, thumbnail: 'https://placehold.co/60x60/EFEFEF/999999?text=Image' },
            { title: 'BEST 게시글 4입니다.', author: 'BEST-4', date: '09:30', comments: 7, thumbnail: 'https://placehold.co/60x60/EFEFEF/999999?text=Image' },
            { title: 'BEST 게시글 5입니다.', author: 'BEST-5', date: '09:20', comments: 10, thumbnail: 'https://placehold.co/60x60/EFEFEF/999999?text=Image' },
        ];
        
        const latestPostsData = [
            { title: '최신 게시글 1', author: '작성자1', channel: '애니메이션', date: '10:10', comments: 2 },
            { title: '최신 게시글 2', author: '작성자2', channel: '방송', date: '10:09', comments: 5 },
            { title: '최신 게시글 3', author: '작성자3', channel: '스포츠', date: '10:08', comments: 1 },
            { title: '최신 게시글 4', author: '작성자4', channel: '게임', date: '10:07', comments: 9 },
            { title: '최신 게시글 5', author: '작성자5', channel: '음악', date: '10:06', comments: 0 },
        ];

        const channelListData = {
            "주제별 채널": ['게임', '음악', '방송', '스포츠'],
            "지역별 채널": ['서울', '경기', '부산', '대구']
        };

        const popularChannelsData = [
            '야구', '주식', '롤', 'IT', '음악', '연예인', '요리', '여행'
        ];

        const realtimePostsContainer = document.getElementById('realtime-best-posts');
        realtimePostsData.forEach(post => {
            const postItem = document.createElement('div');
            postItem.className = 'dc-post-item';
            postItem.innerHTML = `
                <img src="${post.thumbnail}" alt="thumbnail">
                <div class="dc-post-info">
                    <div class="dc-post-title">${post.title}</div>
                    <div class="dc-post-meta">
                        <span>${post.author}</span> | <span>${post.date}</span> | <span class="text-blue-500">댓글 ${post.comments}</span>
                    </div>
                </div>
            `;
            realtimePostsContainer.appendChild(postItem);
        });

        const latestPostsContainer = document.getElementById('latest-posts');
        latestPostsData.forEach(post => {
            const postItem = document.createElement('div');
            postItem.className = 'flex items-center py-1 border-b border-gray-200';
            postItem.innerHTML = `
                <span class="text-blue-500 font-bold w-1/4 md:w-auto">[${post.channel}]</span>
                <a href="#" class="hover:underline flex-grow overflow-hidden whitespace-nowrap overflow-ellipsis mr-2">${post.title}</a>
                <span class="text-gray-400 mr-2">(${post.comments})</span>
                <div class="text-xs text-gray-500">${post.date}</div>
            `;
            latestPostsContainer.appendChild(postItem);
        });

        const allChannelsContainer = document.getElementById('all-channels');
        for (const group in channelListData) {
            const groupTitle = document.createElement('div');
            groupTitle.className = 'dc-channel-group-title';
            groupTitle.textContent = group;
            allChannelsContainer.appendChild(groupTitle);

            channelListData[group].forEach(channel => {
                const channelItem = document.createElement('div');
                channelItem.className = 'dc-channel-item-text';
                channelItem.innerHTML = `<a href="#">${channel} 채널</a>`;
                allChannelsContainer.appendChild(channelItem);
            });
        }

        const popularChannelsContainer = document.getElementById('popular-channels');
        popularChannelsData.forEach(channel => {
            const listItem = document.createElement('li');
            listItem.className = 'border-b border-gray-200';
            listItem.innerHTML = `<a href="#">${channel}</a>`;
            popularChannelsContainer.appendChild(listItem);
        });
    </script>
</body>
</html>
