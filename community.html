
<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>부산남중학교 N-MATE - 커뮤니티</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Inter 및 Noto Sans KR 폰트 설정 -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Noto+Sans+KR:wght@400;700&display=swap" rel="stylesheet">
    <meta name="description" content="부산남중 학생들끼리 자유롭게 소통하는 커뮤니티! 고민, 정보, 잡담까지 친구들과 함께 나눠보세요.">
    <!-- Lucide Icons CDN -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <!-- Firebase SDK CDN (v8.10.1로 유지) -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <style>
                /* Pretendard-Regular 웹폰트 정의 */
        @font-face {
            font-family: 'Pretendard-Regular';
            src: url('https://fastly.jsdelivr.net/gh/Project-Noonnu/noonfonts_2107@1.1/Pretendard-Regular.woff') format('woff');
            font-weight: 400;
            font-style: normal;
        }
        /* Body styles for overall layout */
        body {
            font-family: 'Pretendard-Regular', 'Inter', sans-serif; /* Noto Sans KR 우선 적용 */
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            display: flex;
            flex-direction: column;
            min-height: 100vh;
            background-color: #ffffff; /* Light gray background */
        }
        /* Skeleton Loader animation for loading states */
        .skeleton {
            animation: pulse 1.5s infinite ease-in-out;
            background: linear-gradient(-90deg, #f0f0f0 0%, #f8f8f8 50%, #f0f0f0 100%);
            background-size: 200% 100%;
        }
        @keyframes pulse {
            0% {
                background-position: -200% 0;
            }
            100% {
                background-position: 200% 0;
            }
        }
        /* Adjusted skeleton specific styles for better mimicry */
        .skeleton-title {
            height: 1.5em; /* Matches h3 text-lg roughly */
            width: 60%; /* Variable width for title */
            margin-bottom: 0.75em; /* Matches h3 margin */
            border-radius: 4px;
        }
        /* Generic skeleton text/block, can be overridden by more specific classes */
        .skeleton-text {
            height: 1em; /* Base height for text lines */
            width: 80%; /* Base width for text lines */
            margin-bottom: 0.5em;
            border-radius: 4px;
        }
        .skeleton-meta-item {
            height: 0.75em; /* Matches text-xs roughly */
            border-radius: 4px;
        }


        /* Main content container for centering and max-width */
        .main-content-container {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            align-items: flex-start; /* Aligns content to the left */
            max-width: 36rem; /* Max width for content (reduced from 42rem) */
            margin-left: auto;
            margin-right: auto;
            width: 100%;
            position: relative; /* For absolute positioning of dropdown menu and FAB */
            padding-bottom: 70px; /* Space for fixed bottom navigation */
        }

        /* Dropdown menu styles (for account) */
        .dropdown-menu {
            position: absolute; /* Relative to the parent with position: relative */
            background-color: white;
            border-radius: 0.5rem; /* rounded-md */
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06); /* shadow-lg */
            padding-top: 0.25rem; /* py-1 */
            padding-bottom: 0.25rem;
            min-width: 8rem; /* w-40 */
            right: 0; /* Aligns to the right of the account tab button */
            top: calc(100% + 0.5rem); /* Positions below the button with 0.5rem gap */
            z-index: 20; /* Ensures it appears above other content */
        }

        .dropdown-menu button {
            width: 100%;
            text-align: left;
            padding: 0.5rem 1rem; /* px-4 py-2 */
            font-size: 0.875rem; /* text-sm */
            color: #374151; /* text-gray-700 */
            transition: background-color 0.2s ease;
        }

        .dropdown-menu button:hover {
            background-color: #f3f4f6; /* hover:bg-gray-100 */
        }

        /* Bottom Navigation Bar Styles */
        .nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 0.5rem; /* p-2 */
            border-radius: 0.75rem; /* rounded-xl */
            transition: all 0.3s ease; /* transition-all duration-300 */
            color: #6b7280; /* text-gray-500 */
        }
        .nav-item:hover {
            color: #3b82f6; /* hover:text-blue-500 */
            background-color: #f9fafb; /* hover:bg-gray-50 */
        }
        .nav-item.active {
            color: #2563eb; /* text-blue-600 */
        }
        .nav-item.active span {
            font-weight: 700; /* font-bold */
        }
        .nav-item.active svg {
            color: #2563eb; /* text-blue-600 */
        }

        /* Floating Action Button (FAB) */
        .fab {
            position: absolute; /* Changed from fixed to absolute */
            bottom: 80px; /* Adjust based on bottom navigation bar height */
            right: 20px;
            background-color: #2563eb; /* blue-600 */
            color: white;
            border-radius: 9999px; /* full rounded */
            width: 56px;
            height: 56px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2rem; /* Larger plus sign */
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            transition: background-color 0.3s ease;
            z-index: 30; /* Above nav bar */
            cursor: pointer;
        }
        .fab:hover {
            background-color: #1d4ed8; /* blue-700 */
        }

        /* Custom message box style */
        .message-box-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.6);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease, visibility 0.3s ease;
        }
        .message-box-overlay.visible {
            opacity: 1;
            visibility: visible;
        }
        .message-box {
            background-color: #fff;
            padding: 2.5rem;
            border-radius: 1rem;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.4);
            text-align: center;
            max-width: 450px;
            width: 90%;
            transform: translateY(-30px);
            transition: transform 0.3s ease;
        }
        .message-box-overlay.visible .message-box {
            transform: translateY(0);
        }
        .message-box p {
            font-size: 1.25rem;
            margin-bottom: 2rem;
            color: #333;
        }
        .message-box button {
            background-color: #007bff;
            color: white;
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 0.5rem;
            cursor: pointer;
            font-size: 1rem;
            transition: background-color 0.3s ease;
        }
        .message-box button:hover {
            background-color: #0056b3;
        }

        /* Category Modal Styles */
        .category-modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.6);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 999; /* Below message box, above other content */
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease, visibility 0.3s ease;
        }
        .category-modal-overlay.visible {
            opacity: 1;
            visibility: visible;
        }
        .category-modal {
            background-color: #fff;
            padding: 2rem;
            border-radius: 1rem;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.4);
            max-width: 500px;
            width: 90%;
            max-height: 80%; /* Limit height to prevent overflow on small screens */
            overflow-y: auto; /* Enable scrolling for modal content */
            transform: translateY(-30px);
            transition: transform 0.3s ease;
        }
        .category-modal-overlay.visible .category-modal {
            transform: translateY(0);
        }
        .category-modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
            border-bottom: 1px solid #eee;
            padding-bottom: 1rem;
        }
        .category-modal-header h3 {
            font-size: 1.5rem;
            font-weight: bold;
            color: #333;
        }
        .category-modal-close-button {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: #666;
            transition: color 0.2s ease;
        }
        .category-modal-close-button:hover {
            color: #333;
        }
        .category-list optgroup {
            font-weight: bold;
            font-size: 1.1rem;
            color: #333;
            margin-top: 1rem;
            display: block; /* Make optgroup act like a block for styling */
            padding: 0.5rem 0;
        }
        .category-list button {
            display: block; /* Each option as a block */
            width: 100%;
            text-align: left;
            padding: 0.75rem 1rem;
            background-color: transparent;
            border: none;
            font-size: 1rem;
            color: #555;
            cursor: pointer;
            transition: background-color 0.2s ease, color 0.2s ease;
            border-radius: 0.5rem;
        }
        .category-list button:hover {
            background-color: #f0f2f5;
            color: #2563eb;
        }
    </style>
</head>
<body>

    <!-- Main content area -->
    <div class="main-content-container">

        <!-- Header: Logo and Account/Login section -->
        <div class="w-full flex justify-between items-center px-6 pt-4">
            <!-- Logo -->
            <div class="flex items-center">
                <img src="/image/logo.png" alt="가로형 로고" class="h-12">
            </div>

            <!-- Account/Login section with dropdown -->
            <div class="relative">
                <div id="accountStatusArea" class="flex items-center">
                    <!-- 초기 로딩 중 메시지 -->
                    <span class="text-gray-500 text-sm">계정 정보 로딩 중...</span>
                </div>
                <!-- Dropdown menu (initially hidden) -->
                <div id="accountDropdown" class="dropdown-menu hidden">
                    <button id="settingsButton" class="block">설정</button>
                    <button id="logoutButton" class="block">로그아웃</button>
                </div>
            </div>
        </div>

        <!-- Community Section Content -->
        <div class="w-full flex flex-col items-start px-6 mt-8 mb-4">
            <!-- Section title -->
            <h2 class="text-left text-xl font-bold text-gray-800 mb-4">커뮤니티</h2>

            <!-- Three rounded rectangular boxes below the title -->
            <!-- Updated: Removed w-1/3 to allow natural sizing, adjusted padding -->
            <div class="w-full flex justify-start gap-2 mb-4">
                <!-- '전체' 박스 -->
                <div id="category-all" class="community-category-box rounded-full border p-2 px-4 flex items-center justify-center text-center h-8 cursor-pointer whitespace-nowrap" data-filter="all">
                    <p class="text-sm font-medium">전체</p>
                </div>
                <!-- '인기' 박스 -->
                <div id="category-popular" class="community-category-box rounded-full border border-gray-300 p-2 px-4 flex items-center justify-center text-center h-8 cursor-pointer whitespace-nowrap" data-filter="popular">
                    <p class="text-sm text-gray-700 font-medium">인기</p>
                </div>
                <!-- '카테고리' 박스 (동적으로 텍스트 변경) -->
                <div id="category-specific" class="community-category-box rounded-full border border-gray-300 p-2 px-4 flex items-center justify-center text-center h-8 cursor-pointer whitespace-nowrap" data-filter="category">
                    <p class="text-sm text-gray-700 font-medium">카테고리</p>
                </div>
            </div>

            <!-- Posts List Section -->
            <div id="postsList" class="w-full mt-4">
                <!-- Posts will be dynamically loaded here, or skeleton loader shown -->
            </div>
        </div>

        <!-- Floating Action Button for writing a new post -->
        <div id="writePostFab" class="fab">
            <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-plus"><path d="M12 5v14"/><path d="M5 12h14"/></svg>
        </div>

        <!-- Placeholder for additional content -->
        <p class="text-2xl text-gray-700 px-6 mt-1"></p>
    </div>

    <!-- Category Selection Modal -->
    <div id="categoryModalOverlay" class="category-modal-overlay">
        <div class="category-modal">
            <div class="category-modal-header">
                <h3>카테고리 선택</h3>
                <button id="categoryModalCloseButton" class="category-modal-close-button">&times;</button>
            </div>
            <div class="category-list">
                <optgroup label="일상">
                    <button data-category="일상_이야기">이야기</button>
                    <button data-category="일상_사진">사진</button>
                    <button data-category="일상_고민">고민</button>
                    <button data-category="일상_정보">정보</button>
                    <button data-category="일상_질문">질문</button>
                    <button data-category="일상_자유">자유</button>
                    <button data-category="일상_뻘글">뻘글</button>
                    <button data-category="일상_썰">썰</button>
                    <button data-category="일상_연재">연재</button>
                    <button data-category="일상_기타">기타 일상</button>
                </optgroup>
                <optgroup label="스포츠">
                    <button data-category="스포츠_야구">야구</button>
                    <button data-category="스포츠_농구">농구</button>
                    <button data-category="스포츠_축구">축구</button>
                    <button data-category="스포츠_배구">배구</button>
                    <button data-category="스포츠_탁구">탁구</button>
                    <button data-category="스포츠_테니스">테니스</button>
                    <button data-category="스포츠_수영">수영</button>
                    <button data-category="스포츠_배드민턴">배드민턴</button>
                    <button data-category="스포츠_볼링">볼링</button>
                    <button data-category="스포츠_골프">골프</button>
                    <button data-category="스포츠_육상">육상</button>
                    <button data-category="스포츠_기타">기타 스포츠</button>
                </optgroup>
                <optgroup label="예술">
                    <button data-category="예술_미술">미술</button>
                    <button data-category="예술_음악">음악</button>
                    <button data-category="예술_영화">영화</button>
                    <button data-category="예술_문학">문학</button>
                    <button data-category="예술_공연">공연</button>
                    <button data-category="예술_사진">사진</button>
                    <button data-category="예술_디자인">디자인</button>
                    <button data-category="예술_건축">건축</button>
                    <button data-category="예술_기타">기타 예술</button>
                </optgroup>
                <optgroup label="학업">
                    <button data-category="학업_국어">국어</button>
                    <button data-category="학업_수학">수학</button>
                    <button data-category="학업_영어">영어</button>
                    <button data-category="학업_과학">과학</button>
                    <button data-category="학업_사회">사회</button>
                    <button data-category="학업_역사">역사</button>
                    <button data-category="학업_코딩">코딩</button>
                    <button data-category="학업_기타">기타 학업</button>
                </optgroup>
                <optgroup label="취미/여가">
                    <button data-category="취미_게임">게임</button>
                    <button data-category="취미_독서">독서</button>
                    <button data-category="취미_여행">여행</button>
                    <button data-category="취미_요리">요리</button>
                    <button data-category="취미_반려동물">반려동물</button>
                    <button data-category="취미_패션">패션</button>
                    <button data-category="취미_IT기기">IT/기기</button>
                    <button data-category="취미_기타">기타 취미</button>
                </optgroup>
                <optgroup label="학교생활">
                    <button data-category="학교생활_급식">급식</button>
                    <button data-category="학교생활_교복">교복</button>
                    <button data-category="학교생활_선생님">선생님</button>
                    <button data-category="학교생활_친구">친구</button>
                    <button data-category="학교생활_수업">수업</button>
                    <button data-category="학교생활_동아리">동아리</button>
                    <button data-category="학교생활_행사">행사</button>
                    <button data-category="학교생활_기타">기타 학교생활</button>
                </optgroup>
            </div>
        </div>
    </div>


    <!-- Bottom Navigation Bar -->
    <nav class="fixed bottom-0 left-0 right-0 bg-white p-3 border-t border-gray-300 max-w-xl mx-auto w-full z-10">
        <div class="flex justify-around items-center h-12">
            <!-- Home Navigation Item -->
            <button id="nav-home" class="nav-item flex flex-col items-center justify-center p-2 rounded-xl transition-all duration-300 text-gray-500 hover:text-blue-500 hover:bg-gray-50" data-tab="홈" data-path="/">
                <svg viewBox="0 0 24 24" fill="currentColor" class="w-6 h-6 mb-1" xmlns="http://www.w3.org/2000/svg">
                    <path d="M10 20V14H14V20H19V12H22L12 3L2 12H5V20H10Z"/>
                </svg>
                <span class="text-xs font-medium">홈</span>
            </button>

            <!-- School Life Navigation Item (consolidated) -->
            <button id="nav-school-life" class="nav-item flex flex-col items-center justify-center p-2 rounded-xl transition-all duration-300 text-gray-500 hover:text-blue-500 hover:bg-gray-50" data-tab="학교생활" data-path="/sclife/timetable">
                <svg viewBox="0 0 24 24" fill="currentColor" class="w-6 h-6 mb-1" xmlns="http://www.w3.org/2000/svg">
                    <path d="M4 19V6.5C4 5.94772 4.44772 5.5 5 5.5H19C19.5523 5.5 20 5.94772 20 6.5V19C20 19.5523 19.5523 20 19 20H5C4.44772 20 4 19.5523 4 19ZM6 17H18V7.5H6V17ZM9 10H15V12H9V10Z"/>
                </svg>
                <span class="text-xs font-medium">학교생활</span>
            </button>

            <!-- Community Navigation Item -->
            <button id="nav-community" class="nav-item flex flex-col items-center justify-center p-2 rounded-xl transition-all duration-300 text-gray-500 hover:text-blue-500 hover:bg-gray-50 active" data-tab="커뮤니티" data-path="/community">
                <svg viewBox="0 0 24 24" fill="currentColor" class="w-6 h-6 mb-1" xmlns="http://www.w3.org/2000/svg">
                    <path d="M16 11C18.21 11 20 9.21 20 7C20 4.79 18.21 3 16 3C13.79 3 12 4.79 12 7C12 9.21 13.79 11 16 11ZM8 11C10.21 11 12 9.21 12 7C12 4.79 10.21 3 8 3C5.79 3 4 4.79 4 7C4 9.21 5.79 11 8 11ZM16 13C13.67 13 9.34 14.28 9 17V19H23V17C22.66 14.28 18.33 13 16 13ZM8 13C5.33 13 0 14.33 0 17V19H9V17C8.67 14.33 4.33 13 8 13Z"/>
                </svg>
                <span class="text-xs font-medium">커뮤니티</span>
            </button>

            <!-- Calendar Navigation Item -->
            <button id="nav-calendar" class="nav-item flex flex-col items-center justify-center p-2 rounded-xl transition-all duration-300 text-gray-500 hover:text-blue-500 hover:bg-gray-50" data-tab="캘린더" data-path="/calendar">
                <svg viewBox="0 0 24 24" fill="currentColor" class="w-6 h-6 mb-1" xmlns="http://www.w3.org/2000/svg">
                    <path d="M19 4H18V2H16V4H8V2H6V4H5C3.89 4 3 4.9 3 6V20C3 21.1 3.89 22 5 22H19C20.1 22 21 21.1 21 20V6C21 4.9 20.1 4 19 4ZM19 20H5V9H19V20Z"/>
                </svg>
                <span class="text-xs font-medium">캘린더</span>
            </button>

            <!-- More Navigation Item -->
            <button id="nav-more" class="nav-item flex flex-col items-center justify-center p-2 rounded-xl transition-all duration-300 text-gray-500 hover:text-blue-500 hover:bg-blue-50" data-tab="더보기" data-path="/more">
                <svg viewBox="0 0 24 24" fill="currentColor" class="w-6 h-6 mb-1" xmlns="http://www.w3.org/2000/svg">
                    <path d="M12 10C10.9 10 10 10.9 10 12C10 13.1 10.9 14 12 14C13.1 14 14 13.1 14 12C14 10.9 13.1 10 12 10ZM19 10C17.9 10 17 10.9 17 12C17 13.1 17.9 14 19 14C20.1 14 21 13.1 21 12C21 10.9 20.1 10 19 10ZM5 10C3.9 10 3 10.9 3 12C3 13.1 3.9 14 5 14C6.1 14 7 13.1 7 12C7 10.9 6.1 10 5 10Z"/>
                </svg>
                <span class="text-xs font-medium">더보기</span>
            </button>
        </div>
    </nav>

    <script>
        // Global variables for Firebase configuration (provided by Canvas environment)
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = {
            apiKey: "AIzaSyC_SHRcQ9hXmjVbP3km4rdR4UvKIoqpLHo",
            authDomain: "n-mate.firebaseapp.com",
            projectId: "n-mate",
            storageBucket: "n-mate.firebasestorage.app",
            appId: "1:691313471077:web:3066aaeca0a1d9e448e08c",
            measurementId: "G-0LCGVBKXLQ",
            messagingSenderId: "691313471077"
        };

        // Firebase app, auth, and firestore instances
        let app;
        let auth;
        let db;

        // DOM elements
        const accountStatusArea = document.getElementById('accountStatusArea');
        const accountDropdown = document.getElementById('accountDropdown');
        const postsList = document.getElementById('postsList'); // 게시물 목록을 표시할 DOM 요소
        const writePostFab = document.getElementById('writePostFab'); // 글쓰기 FAB

        // Category filter related variables
        let currentFilter = 'all'; // 'all', 'popular', 'category'
        let currentSpecificCategory = null; // Stores the currently selected specific category (e.g., '스포츠_야구')
        const categoryAllBox = document.getElementById('category-all');
        const categoryPopularBox = document.getElementById('category-popular');
        const categorySpecificBox = document.getElementById('category-specific');
        const categorySpecificText = categorySpecificBox.querySelector('p');

        // Category Modal Elements
        const categoryModalOverlay = document.getElementById('categoryModalOverlay');
        const categoryModalCloseButton = document.getElementById('categoryModalCloseButton');
        const categoryListContainer = document.querySelector('.category-list');

        /**
         * Toggles the visibility of the account dropdown menu.
         */
        function toggleDropdown() {
            accountDropdown.classList.toggle('hidden');
        }

        /**
         * Handles user logout.
         */
        async function handleLogout() {
            if (auth) {
                try {
                    await auth.signOut();
                    console.log('로그아웃 성공.');
                    window.location.href = '/login';
                } catch (error) {
                    console.error('로그아웃 오류:', error);
                }
            }
        }

        /**
         * Handles navigation to the settings page.
         */
        function handleSettingsClick() {
            window.location.href = '/settings';
        }

        /**
         * Updates the account UI based on user authentication status.
         * 게시물 보기는 로그인 여부와 관계없이 가능하며, 글쓰기 기능만 로그인 사용자에게 제공됩니다.
         * @param {firebase.User} user - The authenticated user object or null.
         */
        async function updateAccountUI(user) {
            if (user && user.email) {
                const emailPrefix = user.email.split('@')[0];
                accountStatusArea.innerHTML = `
                    <button id="accountTabButton" class="flex items-center space-x-2 p-2 rounded-full hover:bg-gray-100 focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <span class="text-gray-700 text-sm font-medium">${emailPrefix}</span>
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-user-circle-2"><path d="M18 20a6 6 0 0 0-12 0"/><circle cx="12" cy="10" r="4"/><circle cx="12" cy="12" r="10"/></svg>
                    </button>
                `;
                document.getElementById('accountTabButton').addEventListener('click', toggleDropdown);

                const settingsButton = document.getElementById('settingsButton');
                if (settingsButton && !settingsButton.dataset.listenerAdded) {
                    settingsButton.addEventListener('click', handleSettingsClick);
                    settingsButton.dataset.listenerAdded = 'true';
                }
                const logoutButton = document.getElementById('logoutButton');
                if (logoutButton && !logoutButton.dataset.listenerAdded) {
                    logoutButton.addEventListener('click', handleLogout);
                    logoutButton.dataset.listenerAdded = 'true';
                }
                // 로그인 시 FAB 활성화
                writePostFab.classList.remove('hidden'); 
            } else {
                accountStatusArea.innerHTML = `
                    <button id="loginRedirectButton" class="bg-blue-500 hover:bg-blue-600 text-white font-medium py-2 px-4 rounded-full shadow transition duration-300">
                        로그인
                    </button>
                `;
                document.getElementById('loginRedirectButton').addEventListener('click', () => {
                    window.location.href = '/login';
                });
                accountDropdown.classList.add('hidden');
                // 로그아웃 시 FAB 숨기기
                writePostFab.classList.add('hidden');
            }
            lucide.createIcons();
        }

        /**
         * Updates the active state of the navigation bar buttons based on the current URL path.
         */
        function updateNavigationActiveState() {
            const currentPath = window.location.pathname;
            const navItems = document.querySelectorAll('.nav-item');

            navItems.forEach(item => {
                const itemPath = item.dataset.path;
                const spanElement = item.querySelector('span');
                const svgElement = item.querySelector('svg'); // Changed from 'i' to 'svg'

                // Reset all nav items to default (inactive) state
                item.classList.remove('text-blue-600', 'active');
                item.classList.add('text-gray-500', 'hover:text-blue-500', 'hover:bg-gray-50');
                if (spanElement) {
                    spanElement.classList.remove('font-bold');
                    spanElement.classList.add('font-medium');
                }
                if (svgElement) {
                    svgElement.classList.remove('text-blue-600');
                    svgElement.classList.add('text-gray-500');
                }

                // Check for exact path match or if it's the community button and current path is within /community or /write section
                if (currentPath === itemPath || (item.id === 'nav-community' && (currentPath.startsWith('/community') || currentPath.startsWith('/write') || currentPath.startsWith('/view')))) {
                    item.classList.add('text-blue-600', 'active');
                    item.classList.remove('text-gray-500', 'hover:text-blue-500', 'hover:bg-gray-50');
                    if (spanElement) {
                        spanElement.classList.add('font-bold');
                        spanElement.classList.remove('font-medium');
                    }
                    if (svgElement) {
                        svgElement.classList.add('text-blue-600');
                        svgElement.classList.remove('text-gray-500');
                    }
                } else if (item.id === 'nav-school-life' && currentPath.startsWith('/sclife')) {
                    item.classList.add('text-blue-600', 'active');
                    item.classList.remove('text-gray-500', 'hover:text-blue-500', 'hover:bg-gray-50');
                    if (spanElement) {
                        spanElement.classList.add('font-bold');
                        spanElement.classList.remove('font-medium');
                    }
                    if (svgElement) {
                        svgElement.classList.add('text-blue-600');
                        svgElement.classList.remove('text-gray-500');
                    }
                }
            });
        }

        /**
         * Sets up click event listeners for navigation items.
         */
        function setupNavigationEvents() {
            const navItems = document.querySelectorAll('.nav-item');
            navItems.forEach(item => {
                item.addEventListener('click', () => {
                    const path = item.dataset.path;
                    const currentPathname = window.location.pathname;

                    if (currentPathname !== path) {
                        if (item.id === 'nav-school-life') {
                            localStorage.setItem('initialSchoolLifeTab', 'timetableContent');
                        } else {
                            localStorage.removeItem('initialSchoolLifeTab');
                        }
                        window.location.href = path;
                    }
                });
            });
        }

        /**
         * Renders a single post item.
         * @param {Object} postData - The post data object.
         * @param {string} postId - The ID of the post document.
         */
        function renderPostItem(postData, postId) {
            const postDiv = document.createElement('div');
            postDiv.classList.add('p-4', 'cursor-pointer', 'hover:bg-gray-50', 'transition-colors', 'duration-200');
            postDiv.dataset.postId = postId; // Store post ID for navigation

            const author = postData.authorEmail ? postData.authorEmail.split('@')[0] : '익명';
            const postDate = postData.createdAt ? new Date(postData.createdAt.seconds * 1000).toLocaleString('ko-KR') : '날짜 없음';

            postDiv.innerHTML = `
                <h3 class="text-lg font-semibold text-gray-800 mb-1">${postData.title}</h3>
                <div class="flex items-center text-gray-500 text-xs">
                    <!-- Likes -->
                    <span class="flex items-center mr-3">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-heart mr-1"><path d="M19 14c1.49-1.46 3-3.21 3-5.5A5.5 5.5 0 0 0 16.5 3c-1.76 0-3 .5-4.5 2-1.5-1.5-2.74-2-4.5-2A5.5 5.5 0 0 0 2 8.5c0 2.3 1.5 4.05 3 5.5l7 7Z"/></svg>
                        <span>${postData.likes !== undefined ? postData.likes : 0}</span>
                    </span>
                    <!-- Views -->
                    <span class="flex items-center mr-3">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-eye mr-1"><path d="M2 12s3-7 10-7 10 7 10 7-3 7-10 7-10-7-10-7Z"/><circle cx="12" cy="12" r="3"/></svg>
                        <span>${postData.views !== undefined ? postData.views : 0}</span>
                    </span>
                    <!-- Author -->
                    <span class="mr-3">${author}</span>
                    <!-- Date -->
                    <span>${postDate}</span>
                    <!-- Category Badge -->
                    <span class="ml-auto px-2 py-0.5 bg-gray-200 text-gray-700 rounded-full text-xs font-semibold">${postData.category || '기타'}</span>
                </div>
            `;
            postsList.appendChild(postDiv);

            // Add click listener to navigate to post view page
            postDiv.addEventListener('click', () => {
                window.location.href = `/view/${postId}`;
            });
            lucide.createIcons(); // Ensure icons are rendered for each new post item
        }

        /**
         * Generates and inserts skeleton loader items into the posts list.
         * @param {number} count - The number of skeleton items to generate.
         */
        function showSkeletonLoader(count = 3) {
            postsList.innerHTML = ''; // Clear existing content
            for (let i = 0; i < count; i++) {
                const skeletonDiv = document.createElement('div');
                skeletonDiv.classList.add('p-4', 'border-b', 'border-gray-200');
                skeletonDiv.innerHTML = `
                    <div class="skeleton skeleton-title"></div>
                    <div class="flex items-center mt-2"> <!-- Added mt-2 for spacing -->
                        <!-- Likes, Views, Author, Date placeholders -->
                        <div class="skeleton w-12 h-4 rounded-md mr-3"></div>
                        <div class="skeleton w-12 h-4 rounded-md mr-3"></div>
                        <div class="skeleton w-20 h-4 rounded-md mr-3"></div>
                        <div class="skeleton w-24 h-4 rounded-md"></div>
                        <!-- Category Badge placeholder, ml-auto to push right -->
                        <div class="skeleton w-16 h-5 rounded-full ml-auto"></div>
                    </div>
                `;
                postsList.appendChild(skeletonDiv);
            }
        }

        /**
         * Fetches and displays posts based on the current filter and category.
         * 로그인 여부와 관계없이 게시물을 가져와 표시합니다.
         * @param {string} filterType - 'all', 'popular', 'category'
         * @param {string|null} specificCategory - Specific category name if filterType is 'category', otherwise null.
         */
        function fetchAndDisplayPosts(filterType, specificCategory = null) {
            if (!db) {
                console.error('Firestore가 초기화되지 않았습니다.');
                postsList.innerHTML = '<p class="text-red-500 text-center">데이터베이스 연결 오류. 관리자에게 문의하세요.</p>';
                return;
            }

            const postsCollection = db.collection('artifacts').doc(appId).collection('public').doc('data').collection('posts');
            let baseQuery = postsCollection;

            // Apply category filter if specified
            if (filterType === 'category' && specificCategory) {
                baseQuery = baseQuery.where('category', '==', specificCategory);
                console.log(`Firestore 쿼리: category == ${specificCategory}로 필터링 중...`);
            } else {
                console.log(`Firestore 쿼리: ${filterType} 필터 적용 중 (카테고리 필터 없음).`);
            }

            // Unsubscribe from previous snapshot listener if exists to avoid multiple listeners
            if (window.postsUnsubscribe) {
                window.postsUnsubscribe();
                console.log('이전 Firestore 스냅샷 리스너 해제됨.');
            }

            showSkeletonLoader(); // Show skeleton loader while fetching

            window.postsUnsubscribe = baseQuery.onSnapshot((snapshot) => {
                let posts = [];
                snapshot.forEach(doc => {
                    posts.push({ id: doc.id, ...doc.data() });
                });

                // Client-side sorting
                if (filterType === 'popular') {
                    // Sort by views in descending order
                    posts.sort((a, b) => (b.views || 0) - (a.views || 0));
                    console.log('클라이언트 측 정렬: 인기순 (조회수)으로 정렬 완료.');
                } else {
                    // Default sort by createdAt in descending order (newest first)
                    posts.sort((a, b) => {
                        const dateA = a.createdAt ? (a.createdAt.seconds * 1000 + a.createdAt.nanoseconds / 1000000) : 0;
                        const dateB = b.createdAt ? (b.createdAt.seconds * 1000 + b.createdAt.nanoseconds / 1000000) : 0;
                        return dateB - dateA; // 최신순
                    });
                    console.log('클라이언트 측 정렬: 최신순으로 정렬 완료.');
                }

                postsList.innerHTML = ''; // Clear skeleton loader and current posts
                if (posts.length === 0) {
                    postsList.innerHTML = '<p class="text-gray-500 text-center">게시물이 없습니다.</p>';
                    console.log('필터링된 게시물이 없습니다.');
                } else {
                    posts.forEach((post, index) => {
                        renderPostItem(post, post.id);
                        if (index < posts.length - 1) { // Add separator for all but the last post
                            postsList.appendChild(document.createElement('hr')).classList.add('border-gray-200', 'my-2');
                        }
                    });
                    console.log(`${posts.length}개의 게시물 렌더링 완료.`);
                }
            }, (error) => {
                console.error('게시물 실시간 업데이트 오류:', error);
                showMessageBox('게시물을 불러오는 중 오류가 발생했습니다: ' + error.message);
                postsList.innerHTML = '<p class="text-red-500 text-center">게시물을 불러오지 못했습니다.</p>';
            });
        }

        /**
         * Updates the visual active state of the community category boxes.
         * @param {string} activeBoxId - The ID of the box to set as active.
         */
        function updateCommunityCategoryActiveState(activeBoxId) {
            const categoryBoxes = document.querySelectorAll('.community-category-box');

            categoryBoxes.forEach(box => {
                const textElement = box.querySelector('p');

                // Reset to default (inactive) state
                box.classList.remove('bg-blue-500', 'border-blue-500');
                box.classList.add('bg-white', 'border-gray-300');
                if (textElement) {
                    textElement.classList.remove('text-white');
                    textElement.classList.add('text-gray-700');
                }

                // Apply active state if ID matches
                if (box.id === activeBoxId) {
                    box.classList.add('bg-blue-500', 'border-blue-500');
                    box.classList.remove('bg-white', 'border-gray-300');
                    if (textElement) {
                        textElement.classList.add('text-white');
                        textElement.classList.remove('text-gray-700');
                    }
                }
            });
        }

        /**
         * Displays a custom message box.
         * Replaces native alert() for better UI control in an iframe environment.
         * @param {string} message - The message to display.
         */
        function showMessageBox(message) {
            const messageBox = document.createElement('div');
            messageBox.classList.add('fixed', 'inset-0', 'flex', 'items-center', 'justify-center', 'bg-black', 'bg-opacity-50', 'z-50');
            messageBox.innerHTML = `
                <div class="bg-white p-6 rounded-lg shadow-xl max-w-sm w-full mx-4 text-center">
                    <p class="text-gray-800 text-lg mb-4">${message}</p>
                    <button id="messageBoxClose" class="bg-blue-500 hover:bg-blue-600 text-white font-semibold py-2 px-4 rounded-md transition duration-300">확인</button>
                </div>
            `;
            document.body.appendChild(messageBox);

            document.getElementById('messageBoxClose').addEventListener('click', () => {
                document.body.removeChild(messageBox);
            });
        }

        /**
         * Shows the category selection modal.
         */
        function showCategoryModal() {
            categoryModalOverlay.classList.add('visible');
            console.log('카테고리 모달 표시.');
        }

        /**
         * Hides the category selection modal.
         */
        function hideCategoryModal() {
            categoryModalOverlay.classList.remove('visible');
            console.log('카테고리 모달 숨김.');
        }


        document.addEventListener('DOMContentLoaded', async () => {
            // Firebase initialization
            if (firebaseConfig && firebaseConfig.apiKey) {
                if (firebase.apps.length === 0) { // 앱이 초기화되지 않았다면 초기화
                    try {
                        app = firebase.initializeApp(firebaseConfig);
                        auth = firebase.auth();
                        db = firebase.firestore();
                        console.log('Firebase 앱, 인증, Firestore 초기화 성공.');

                        // `onAuthStateChanged` 리스너만 설정하여 인증 상태 변경에 따라 UI 업데이트
                        // 이 리스너는 로그인 상태와 관계없이 항상 호출되므로, 비로그인 사용자도 게시물을 볼 수 있습니다.
                        auth.onAuthStateChanged(async (user) => {
                            await updateAccountUI(user);
                            // 인증 상태가 결정된 후 게시물 로드 시작 (로그인 여부와 관계없이 실행)
                            fetchAndDisplayPosts(currentFilter);
                            updateCommunityCategoryActiveState('category-all'); // 초기에는 '전체' 활성화
                        });

                    } catch (error) {
                        console.error('Firebase 초기화 실패:', error);
                        showMessageBox('Firebase 초기화에 실패했습니다. 관리자에게 문의하세요.');
                        await updateAccountUI(null); // 초기화 실패 시에도 UI를 로그아웃 상태로 업데이트
                    }
                } else { // 앱이 이미 초기화되었다면 (예: SPA 탐색 또는 핫 리로드)
                    app = firebase.app();
                    auth = firebase.auth();
                    db = firebase.firestore();
                    console.log('Firebase 앱이 이미 초기화되었습니다. 기존 인스턴스를 사용합니다.');
                    
                    // `onAuthStateChanged` 리스너만 다시 연결
                    auth.onAuthStateChanged(async (user) => {
                        await updateAccountUI(user);
                        // 인증 상태가 결정된 후 게시물 로드 시작 (로그인 여부와 관계없이 실행)
                        fetchAndDisplayPosts(currentFilter);
                        updateCommunityCategoryActiveState('category-all'); // 초기에는 '전체' 활성화
                    });
                }
            } else {
                console.warn('Firebase 구성이 제대로 제공되지 않았습니다. Firebase를 초기화할 수 없습니다.');
                showMessageBox('Firebase 구성이 누락되었습니다. 일부 기능을 사용할 수 없습니다.');
                await updateAccountUI(null); // 구성이 없을 시에도 UI 업데이트
            }

            // Event Listeners for category filter boxes
            categoryAllBox.addEventListener('click', () => {
                currentFilter = 'all';
                currentSpecificCategory = null; // Reset specific category
                categorySpecificText.textContent = '카테고리'; // Reset category box text
                console.log('\'전체\' 필터 선택됨.');
                fetchAndDisplayPosts(currentFilter);
                updateCommunityCategoryActiveState('category-all');
            });

            categoryPopularBox.addEventListener('click', () => {
                currentFilter = 'popular';
                currentSpecificCategory = null; // Reset specific category
                categorySpecificText.textContent = '카테고리'; // Reset category box text
                console.log('\'인기\' 필터 선택됨.');
                fetchAndDisplayPosts(currentFilter);
                updateCommunityCategoryActiveState('category-popular');
            });

            categorySpecificBox.addEventListener('click', () => {
                showCategoryModal(); // Show the category selection modal
            });

            // Event listener for category modal close button
            categoryModalCloseButton.addEventListener('click', hideCategoryModal);

            // Event listener for clicking outside the modal to close it
            categoryModalOverlay.addEventListener('click', (e) => {
                if (e.target === categoryModalOverlay) {
                    hideCategoryModal();
                }
            });

            // Event listeners for individual category buttons in the modal
            categoryListContainer.querySelectorAll('button').forEach(button => {
                console.log(`카테고리 버튼에 이벤트 리스너 부착 중: ${button.textContent}`); // 디버깅: 리스너 부착 확인
                button.addEventListener('click', () => {
                    console.log(`카테고리 버튼 클릭됨: ${button.textContent}`); // 디버깅: 어떤 카테고리 버튼이 클릭되었는지 확인
                    currentSpecificCategory = button.dataset.category;
                    currentFilter = 'category';
                    categorySpecificText.textContent = button.textContent; // Update category box text with selected category
                    console.log(`카테고리 선택됨: ${currentSpecificCategory}. fetchAndDisplayPosts 호출 준비.`);
                    fetchAndDisplayPosts(currentFilter, currentSpecificCategory);
                    updateCommunityCategoryActiveState('category-specific');
                    hideCategoryModal();
                });
            });

            // Event Listener for FAB
            writePostFab.addEventListener('click', () => {
                // 글쓰기 기능은 로그인한 사용자만 사용할 수 있도록 제한합니다.
                if (auth.currentUser) {
                    window.location.href = '/write'; // Navigate to the write page
                } else {
                    showMessageBox('글을 작성하려면 로그인해야 합니다.');
                }
            });

            // Global click listener to close dropdown when clicking outside
            window.addEventListener('click', function(e) {
                const accountTabButton = document.getElementById('accountTabButton');
                if (accountTabButton && !accountTabButton.contains(e.target) && !accountDropdown.contains(e.target)) {
                    accountDropdown.classList.add('hidden');
                }
            });

            // Setup navigation click handlers
            setupNavigationEvents();
            // Update navigation active state on initial load
            updateNavigationActiveState();

            // Initial icon creation
            lucide.createIcons();
        });
    </script>
</body>
</html>
