<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>부산남중학교 N-MATE - 게시물 보기</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Inter 및 Noto Sans KR 폰트 설정 -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Noto+Sans+KR:wght@400;700&display=swap" rel="stylesheet">
    <!-- Lucide Icons CDN -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <!-- Firebase SDK CDN (제공된 '더보기' 페이지와 동일한 v8.10.1로 변경) -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <style>
        /* Body styles for overall layout */
        body {
            font-family: 'Noto Sans KR', 'Inter', sans-serif; /* Noto Sans KR 우선 적용 */
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            display: flex;
            flex-direction: column;
            min-height: 100vh;
            background-color: #ffffff; /* Light gray background */
        }

        /* Main content container for centering and max-width */
        .main-content-container {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            align-items: flex-start; /* Aligns content to the left */
            max-width: 36rem; /* Max width for content */
            margin-left: auto;
            margin-right: auto;
            width: 100%;
            position: relative; /* For absolute positioning of dropdown menu */
            padding-bottom: 70px; /* Space for fixed bottom navigation */
        }

        /* Dropdown menu styles (reused from other pages) */
        .dropdown-menu {
            position: absolute;
            background-color: white;
            border-radius: 0.5rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            padding-top: 0.25rem;
            padding-bottom: 0.25rem;
            min-width: 8rem;
            right: 0;
            top: calc(100% + 0.5rem);
            z-index: 20;
        }

        .dropdown-menu button {
            width: 100%;
            text-align: left;
            padding: 0.5rem 1rem;
            font-size: 0.875rem;
            color: #374151;
            transition: background-color 0.2s ease;
        }

        .dropdown-menu button:hover {
            background-color: #f3f4f6;
        }

        /* Bottom Navigation Bar Styles (reused from other pages) */
        .nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 0.5rem;
            border-radius: 0.75rem;
            transition: all 0.3s ease;
            color: #6b7280;
        }
        .nav-item:hover {
            color: #3b82f6;
            background-color: #f9fafb;
        }
        .nav-item.active {
            color: #2563eb;
        }
        .nav-item.active span {
            font-weight: 700;
        }
        .nav-item.active svg {
            color: #2563eb;
        }

        /* Styles for post content and comments section */
        .post-content-area img {
            max-width: 100%;
            height: auto;
            border-radius: 0.5rem;
            margin-top: 1rem;
            margin-bottom: 1rem;
        }
        .comment-item {
            border-bottom: 1px solid #e5e7eb; /* gray-200 */
            padding-top: 1rem;
            padding-bottom: 1rem;
        }
        .comment-item:last-child {
            border-bottom: none;
        }
        /* Specific adjustments for text-only display */
        #postDetailArea {
            /* No background, no shadow, no border, no overall padding */
            padding-top: 1rem; /* Added back minimal top padding */
            padding-bottom: 1rem; /* Added back minimal bottom padding */
        }
        #commentsList {
            /* No background, no shadow, no border, no overall padding */
            padding-top: 1rem; /* Added back minimal top padding */
            padding-bottom: 1rem; /* Added back minimal bottom padding */
        }
        #submitCommentButton {
            width: 100%; /* Ensure button still spans full width */
        }
    </style>
</head>
<body>

    <!-- Main content area -->
    <div class="main-content-container">

        <!-- Header: Logo and Account/Login section -->
        <div class="w-full flex justify-between items-center px-6 pt-4">
            <!-- Logo -->
            <div class="flex items-center">
                <img src="/image/logo.png" alt="가로형 로고" class="h-12">
            </div>

            <!-- Account/Login section with dropdown -->
            <div class="relative">
                <div id="accountStatusArea" class="flex items-center">
                    <!-- 초기 로딩 중 메시지 -->
                    <span class="text-gray-500 text-sm">계정 정보 로딩 중...</span>
                </div>
                <!-- Dropdown menu (initially hidden) -->
                <div id="accountDropdown" class="dropdown-menu hidden">
                    <button id="settingsButton" class="block">설정</button>
                    <button id="logoutButton" class="block">로그아웃</button>
                </div>
            </div>
        </div>

        <!-- Post View Section Content -->
        <div class="w-full flex flex-col items-start px-6 mt-8 mb-4">
            <!-- Back Button -->
            <button id="backButton" class="flex items-center text-blue-600 hover:text-blue-800 transition-colors duration-200 mb-4">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-chevron-left mr-1"><path d="m15 18-6-6 6-6"/></svg>
                <span class="font-medium">뒤로가기</span>
            </button>

            <!-- Post Detail Area (Box styles removed) -->
            <div id="postDetailArea" class="w-full mb-6">
                <!-- Post Title -->
                <h1 id="postTitle" class="text-2xl font-bold text-gray-800 mb-2">게시물 로딩 중...</h1>

                <!-- Post Meta Info -->
                <div class="flex items-center text-gray-500 text-sm mb-4">
                    <span id="postAuthor" class="mr-3"></span>
                    <span id="postDate" class="mr-3"></span>
                    <span id="postCategory" class="px-2 py-0.5 bg-blue-100 text-blue-600 rounded-full text-xs font-semibold"></span>
                </div>

                <!-- Post Actions (Edit/Delete - conditionally visible) -->
                <div id="postActions" class="flex justify-end space-x-2 mb-4 hidden">
                    <button id="editPostButton" class="text-gray-600 hover:text-blue-600 flex items-center text-sm">
                        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-square-pen mr-1"><path d="M12 3H5a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.375 2.625a2.121 2.121 0 1 1 3 3L12 15l-4 1 1-4Z"/></svg>
                        수정
                    </button>
                    <button id="deletePostButton" class="text-gray-600 hover:text-red-600 flex items-center text-sm">
                        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-trash-2"><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/><line x1="10" x2="10" y1="11" y2="17"/><line x1="14" x2="14" y1="11" y2="17"/></svg>
                        삭제
                    </button>
                </div>

                <!-- Post Content (Placeholder for HTML from Quill) -->
                <div id="postContent" class="post-content-area text-gray-700 leading-relaxed mb-6">
                    <p>게시물 내용을 로딩 중입니다...</p>
                </div>

                <!-- Post Stats (Likes, Views, Comments) -->
                <div class="flex items-center text-gray-500 text-sm border-t border-gray-200 pt-4">
                    <!-- Likes -->
                    <span class="flex items-center mr-4">
                        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-heart mr-1"><path d="M19 14c1.49-1.46 3-3.21 3-5.5A5.5 5.5 0 0 0 16.5 3c-1.76 0-3 .5-4.5 2-1.5-1.5-2.74-2-4.5-2A5.5 5.5 0 0 0 2 8.5c0 2.3 1.5 4.05 3 5.5l7 7Z"/></svg>
                        <span id="postLikes">0</span>
                    </span>
                    <!-- Views -->
                    <span class="flex items-center mr-4">
                        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-eye mr-1"><path d="M2 12s3-7 10-7 10 7 10 7-3 7-10 7-10-7-10-7Z"/><circle cx="12" cy="12" r="3"/></svg>
                        <span id="postViews">0</span>
                    </span>
                    <!-- Comments Count -->
                    <span class="flex items-center">
                        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-message-circle mr-1"><path d="M7.9 20A9.9 9.9 0 1 0 4 16.1L2 22Z"/></svg>
                        <span id="postCommentsCount">0</span>
                    </span>
                </div>
            </div>

            <!-- Comments Section (Box styles removed) -->
            <div class="w-full mb-6">
                <h2 class="text-xl font-bold text-gray-800 mb-4">댓글 (<span id="commentsSectionCount">0</span>)</h2>

                <!-- New Comment Input -->
                <div class="mb-6">
                    <textarea id="commentInput" placeholder="로그인해야 댓글을 작성할 수 있습니다."
                              class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 text-gray-800 resize-y min-h-[60px]"
                              disabled></textarea>
                    <button id="submitCommentButton"
                            class="mt-2 w-full bg-blue-300 text-white font-semibold py-2 px-4 rounded-lg shadow-md transition duration-300 ease-in-out cursor-not-allowed"
                            disabled>
                        댓글 작성
                    </button>
                </div>

                <!-- Existing Comments List -->
                <div id="commentsList">
                    <p class="text-gray-500 text-center">댓글이 없습니다.</p>
                    <!-- Comments will be dynamically loaded here -->
                </div>
            </div>
        </div>

        <!-- Placeholder for additional content -->
        <p class="text-2xl text-gray-700 px-6 mt-1"></p>
    </div>

    <!-- Bottom Navigation Bar (reused) -->
    <nav class="fixed bottom-0 left-0 right-0 bg-white p-3 border-t border-gray-300 max-w-xl mx-auto w-full z-10">
        <div class="flex justify-around items-center h-12">
            <!-- Home Navigation Item -->
            <button id="nav-home" class="nav-item flex flex-col items-center justify-center p-2 rounded-xl transition-all duration-300 text-gray-500 hover:text-blue-500 hover:bg-gray-50" data-tab="홈" data-path="/">
                <svg viewBox="0 0 24 24" fill="currentColor" class="w-6 h-6 mb-1" xmlns="http://www.w3.org/2000/svg">
                    <path d="M10 20V14H14V20H19V12H22L12 3L2 12H5V20H10Z"/>
                </svg>
                <span class="text-xs font-medium">홈</span>
            </button>

            <!-- School Life Navigation Item (consolidated) -->
            <button id="nav-school-life" class="nav-item flex flex-col items-center justify-center p-2 rounded-xl transition-all duration-300 text-gray-500 hover:text-blue-500 hover:bg-gray-50" data-tab="학교생활" data-path="/sclife/timetable">
                <svg viewBox="0 0 24 24" fill="currentColor" class="w-6 h-6 mb-1" xmlns="http://www.w3.org/2000/svg">
                    <path d="M4 19V6.5C4 5.94772 4.44772 5.5 5 5.5H19C19.5523 5.5 20 5.94772 20 6.5V19C20 19.5523 19.5523 20 19 20H5C4.44772 20 4 19.5523 4 19ZM6 17H18V7.5H6V17ZM9 10H15V12H9V10Z"/>
                </svg>
                <span class="text-xs font-medium">학교생활</span>
            </button>

            <!-- Community Navigation Item -->
            <button id="nav-community" class="nav-item flex flex-col items-center justify-center p-2 rounded-xl transition-all duration-300 text-gray-500 hover:text-blue-500 hover:bg-gray-50" data-tab="커뮤니티" data-path="/community">
                <svg viewBox="0 0 24 24" fill="currentColor" class="w-6 h-6 mb-1" xmlns="http://www.w3.org/2000/svg">
                    <path d="M16 11C18.21 11 20 9.21 20 7C20 4.79 18.21 3 16 3C13.79 3 12 4.79 12 7C12 9.21 13.79 11 16 11ZM8 11C10.21 11 12 9.21 12 7C12 4.79 10.21 3 8 3C5.79 3 4 4.79 4 7C4 9.21 5.79 11 8 11ZM16 13C13.67 13 9.34 14.28 9 17V19H23V17C22.66 14.28 18.33 13 16 13ZM8 13C5.33 13 0 14.33 0 17V19H9V17C8.67 14.33 4.33 13 8 13Z"/>
                </svg>
                <span class="text-xs font-medium">커뮤니티</span>
            </button>

            <!-- Calendar Navigation Item -->
            <button id="nav-calendar" class="nav-item flex flex-col items-center justify-center p-2 rounded-xl transition-all duration-300 text-gray-500 hover:text-blue-500 hover:bg-gray-50" data-tab="캘린더" data-path="/calendar">
                <svg viewBox="0 0 24 24" fill="currentColor" class="w-6 h-6 mb-1" xmlns="http://www.w3.org/2000/svg">
                    <path d="M19 4H18V2H16V4H8V2H6V4H5C3.89 4 3 4.9 3 6V20C3 21.1 3.89 22 5 22H19C20.1 22 21 21.1 21 20V6C21 4.9 20.1 4 19 4ZM19 20H5V9H19V20Z"/>
                </svg>
                <span class="text-xs font-medium">캘린더</span>
            </button>

            <!-- More Navigation Item -->
            <button id="nav-more" class="nav-item flex flex-col items-center justify-center p-2 rounded-xl transition-all duration-300 text-gray-500 hover:text-blue-500 hover:bg-blue-50" data-tab="더보기" data-path="/plus">
                <svg viewBox="0 0 24 24" fill="currentColor" class="w-6 h-6 mb-1" xmlns="http://www.w3.org/2000/svg">
                    <path d="M12 10C10.9 10 10 10.9 10 12C10 13.1 10.9 14 12 14C13.1 14 14 13.1 14 12C14 10.9 13.1 10 12 10ZM19 10C17.9 10 17 10.9 17 12C17 13.1 17.9 14 19 14C20.1 14 21 13.1 21 12C21 10.9 20.1 10 19 10ZM5 10C3.9 10 3 10.9 3 12C3 13.1 3.9 14 5 14C6.1 14 7 13.1 7 12C7 10.9 6.1 10 5 10Z"/>
                </svg>
                <span class="text-xs font-medium">더보기</span>
            </button>
        </div>
    </nav>

    <script>
        // Global variables for Firebase configuration (provided by Canvas environment)
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = {
            apiKey: "AIzaSyC_SHRcQ9hXmjVbP3km4rdR4UvKIoqpLHo",
            authDomain: "n-mate.firebaseapp.com",
            projectId: "n-mate",
            storageBucket: "n-mate.firebasestorage.app",
            appId: "1:691313471077:web:3066aaeca0a1d9e448e08c",
            measurementId: "G-0LCGVBKXLQ",
            messagingSenderId: "691313471077"
        };

        // Firebase app, auth, and firestore instances
        let app;
        let auth;
        let db;

        // Current post ID from URL
        let postId = null;

        // DOM elements
        const accountStatusArea = document.getElementById('accountStatusArea');
        const accountDropdown = document.getElementById('accountDropdown');
        const backButton = document.getElementById('backButton');
        const postActions = document.getElementById('postActions'); // Edit/Delete buttons container
        const editPostButton = document.getElementById('editPostButton');
        const deletePostButton = document.getElementById('deletePostButton');
        const submitCommentButton = document.getElementById('submitCommentButton');
        const commentInput = document.getElementById('commentInput');
        const commentsList = document.getElementById('commentsList');
        const postCommentsCount = document.getElementById('postCommentsCount');
        const commentsSectionCount = document.getElementById('commentsSectionCount');
        const postTitleElem = document.getElementById('postTitle');
        const postAuthorElem = document.getElementById('postAuthor');
        const postDateElem = document.getElementById('postDate');
        const postCategoryElem = document.getElementById('postCategory');
        const postContentElem = document.getElementById('postContent');
        const postLikesElem = document.getElementById('postLikes');
        const postViewsElem = document.getElementById('postViews');


        // Placeholder for current user ID (for conditional display of edit/delete)
        let currentUserId = null;
        // Placeholder for post author ID (will be fetched from Firestore)
        let postAuthorId = null;

        /**
         * Toggles the visibility of the account dropdown menu.
         */
        function toggleDropdown() {
            accountDropdown.classList.toggle('hidden');
        }

        /**
         * Handles user logout.
         */
        async function handleLogout() {
            if (auth) {
                try {
                    await auth.signOut();
                    console.log('로그아웃 성공.');
                    window.location.href = '/login';
                } catch (error) {
                    console.error('로그아웃 오류:', error);
                }
            }
        }

        /**
         * Handles navigation to the settings page.
         */
        function handleSettingsClick() {
            window.location.href = '/settings';
        }

        /**
         * Updates the account UI based on user authentication status.
         * Displays email prefix if logged in, otherwise "로그인" button.
         * 게시물 보기는 로그인 여부와 관계없이 가능하며, 댓글 작성 기능만 로그인 사용자에게 제공됩니다.
         * @param {firebase.User} user - The authenticated user object or null.
         */
        async function updateAccountUI(user) {
            if (user && user.email) {
                const emailPrefix = user.email.split('@')[0];
                accountStatusArea.innerHTML = `
                    <button id="accountTabButton" class="flex items-center space-x-2 p-2 rounded-full hover:bg-gray-100 focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <span class="text-gray-700 text-sm font-medium">${emailPrefix}</span>
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-user-circle-2"><path d="M18 20a6 6 0 0 0-12 0"/><circle cx="12" cy="10" r="4"/><circle cx="12" cy="12" r="10"/></svg>
                    </button>
                `;
                document.getElementById('accountTabButton').addEventListener('click', toggleDropdown);

                const settingsButton = document.getElementById('settingsButton');
                if (settingsButton && !settingsButton.dataset.listenerAdded) {
                    settingsButton.addEventListener('click', handleSettingsClick);
                    settingsButton.dataset.listenerAdded = 'true';
                }
                const logoutButton = document.getElementById('logoutButton');
                if (logoutButton && !logoutButton.dataset.listenerAdded) {
                    logoutButton.addEventListener('click', handleLogout);
                    logoutButton.dataset.listenerAdded = 'true';
                }
                currentUserId = user.uid; // Set current user ID
                updatePostActionsVisibility(); // Update visibility based on logged-in user
                
                // Enable comment input for logged-in users
                commentInput.removeAttribute('disabled');
                commentInput.placeholder = "댓글을 입력하세요...";
                submitCommentButton.removeAttribute('disabled');
                submitCommentButton.classList.remove('bg-blue-300', 'cursor-not-allowed');
                submitCommentButton.classList.add('bg-blue-500', 'hover:bg-blue-600');

            } else {
                accountStatusArea.innerHTML = `
                    <button id="loginRedirectButton" class="bg-blue-500 hover:bg-blue-600 text-white font-medium py-2 px-4 rounded-full shadow transition duration-300">
                        로그인
                    </button>
                `;
                document.getElementById('loginRedirectButton').addEventListener('click', () => {
                    window.location.href = '/login';
                });
                accountDropdown.classList.add('hidden');
                currentUserId = null; // Clear current user ID
                updatePostActionsVisibility(); // Hide actions if not logged in

                // Disable comment input for logged-out users
                commentInput.setAttribute('disabled', 'true');
                commentInput.placeholder = "로그인해야 댓글을 작성할 수 있습니다.";
                submitCommentButton.setAttribute('disabled', 'true');
                submitCommentButton.classList.add('bg-blue-300', 'cursor-not-allowed');
                submitCommentButton.classList.remove('bg-blue-500', 'hover:bg-blue-600');
            }
            lucide.createIcons();
        }

        /**
         * Updates the active state of the navigation bar buttons based on the current URL path.
         */
        function updateNavigationActiveState() {
            const currentPath = window.location.pathname;
            const navItems = document.querySelectorAll('.nav-item');

            navItems.forEach(item => {
                const itemPath = item.dataset.path;
                const spanElement = item.querySelector('span');
                const svgElement = item.querySelector('svg'); 

                // Reset all nav items to default (inactive) state
                item.classList.remove('text-blue-600');
                item.classList.add('text-gray-500', 'hover:text-blue-500', 'hover:bg-gray-50');
                if (spanElement) {
                    spanElement.classList.remove('font-bold');
                    spanElement.classList.add('font-medium');
                }
                if (svgElement) { 
                    svgElement.classList.remove('text-blue-600');
                    svgElement.classList.add('text-gray-500'); // Ensure icon also has gray base color
                }

                // Check for exact path match or if it's the community button and current path is within /community or /view section
                if (currentPath === itemPath || (item.id === 'nav-community' && (currentPath.startsWith('/community') || currentPath.startsWith('/view') || currentPath.startsWith('/write')))) {
                    item.classList.add('text-blue-600');
                    item.classList.remove('text-gray-500', 'hover:text-blue-500', 'hover:bg-gray-50');
                    if (spanElement) {
                        spanElement.classList.add('font-bold');
                        spanElement.classList.remove('font-medium');
                    }
                    if (svgElement) { 
                        svgElement.classList.add('text-blue-600');
                        svgElement.classList.remove('text-gray-500');
                    }
                } else if (item.id === 'nav-school-life' && currentPath.startsWith('/sclife')) {
                    item.classList.add('text-blue-600');
                    item.classList.remove('text-gray-500', 'hover:text-blue-500', 'hover:bg-gray-50');
                    if (spanElement) {
                        spanElement.classList.add('font-bold');
                        spanElement.classList.remove('font-medium');
                    }
                    if (svgElement) { 
                        svgElement.classList.add('text-blue-600');
                        svgElement.classList.remove('text-gray-500');
                    }
                }
            });
        }

        /**
         * Sets up click event listeners for navigation items.
         */
        function setupNavigationEvents() {
            const navItems = document.querySelectorAll('.nav-item');
            navItems.forEach(item => {
                item.addEventListener('click', () => {
                    const path = item.dataset.path;
                    const currentPathname = window.location.pathname;

                    if (currentPathname !== path) {
                        if (item.id === 'nav-school-life') {
                            localStorage.setItem('initialSchoolLifeTab', 'timetableContent');
                        } else {
                            localStorage.removeItem('initialSchoolLifeTab');
                        }
                        window.location.href = path;
                    }
                });
            });
        }

        /**
         * Updates the visibility of the edit/delete buttons based on current user and post author.
         */
        function updatePostActionsVisibility() {
            if (currentUserId && currentUserId === postAuthorId) {
                postActions.classList.remove('hidden');
            } else {
                postActions.classList.add('hidden');
            }
        }

        /**
         * Handles the click event for the back button.
         * Navigates back to the community page.
         */
        function handleBackButtonClick() {
            window.location.href = '/community';
        }

        /**
         * Handles editing the post.
         */
        function handleEditPost() {
            if (!postId) {
                showMessageBox('게시물 ID를 찾을 수 없습니다.');
                return;
            }
            // Navigate to the write page with the post ID as a query parameter for editing
            window.location.href = `/write?postId=${postId}`;
        }

        /**
         * Handles deleting the post.
         */
        async function handleDeletePost() {
            if (!postId) {
                showMessageBox('게시물 ID를 찾을 수 없습니다.');
                return;
            }
            // Use a custom message box for confirmation instead of native confirm()
            showConfirmBox('정말로 이 게시물을 삭제하시겠습니까?', async () => {
                try {
                    // Delete the post document from Firestore
                    await db.collection('artifacts').doc(appId).collection('public').doc('data').collection('posts').doc(postId).delete();
                    showMessageBox('게시물이 성공적으로 삭제되었습니다.');
                    window.location.href = '/community'; // Redirect to community page after deletion
                } catch (error) {
                    console.error('게시물 삭제 오류:', error);
                    showMessageBox('게시물 삭제 중 오류가 발생했습니다: ' + error.message);
                }
            });
        }

        /**
         * Renders a single comment element.
         * @param {Object} commentData - The comment data object.
         */
        function renderComment(commentData) {
            const commentDiv = document.createElement('div');
            commentDiv.classList.add('comment-item');

            const author = commentData.authorEmail ? commentData.authorEmail.split('@')[0] : '익명';
            const date = commentData.timestamp ? new Date(commentData.timestamp.seconds * 1000).toLocaleString('ko-KR') : '날짜 없음';

            commentDiv.innerHTML = `
                <div class="flex justify-between items-center mb-1">
                    <span class="font-semibold text-gray-800">${author}</span>
                    <span class="text-gray-500 text-xs">${date}</span>
                </div>
                <p class="text-gray-700 text-sm">${commentData.text}</p>
            `;
            commentsList.appendChild(commentDiv);
        }

        /**
         * Handles submitting a new comment.
         */
        async function handleSubmitComment() {
            // 댓글 작성은 로그인한 사용자만 가능합니다.
            if (!currentUserId) {
                showMessageBox('로그인해야 댓글을 작성할 수 있습니다.');
                return;
            }
            if (!postId) {
                showMessageBox('게시물 ID를 찾을 수 없어 댓글을 작성할 수 없습니다.');
                return;
            }

            const commentText = commentInput.value.trim();
            if (commentText === '') {
                showMessageBox('댓글 내용을 입력해주세요.');
                return;
            }

            try {
                await db.collection('artifacts').doc(appId).collection('public').doc('data').collection('posts').doc(postId).collection('comments').add({
                    text: commentText,
                    authorUid: auth.currentUser.uid,
                    authorEmail: auth.currentUser.email, // Use email as display name
                    timestamp: firebase.firestore.FieldValue.serverTimestamp()
                });
                commentInput.value = ''; // Clear input field
                // Comments will be updated via the onSnapshot listener
                // showMessageBox('댓글이 성공적으로 작성되었습니다.'); // Removed as onSnapshot handles update
            } catch (error) {
                console.error('댓글 작성 오류:', error);
                showMessageBox('댓글 작성 중 오류가 발생했습니다: ' + error.message);
            }
        }

        /**
         * Fetches and displays a specific post's data.
         * 이 함수는 로그인 여부와 관계없이 게시물 데이터를 가져옵니다.
         * @param {string} id - The ID of the post to fetch.
         */
        async function fetchPostData(id) {
            try {
                const postRef = db.collection('artifacts').doc(appId).collection('public').doc('data').collection('posts').doc(id);
                const postSnap = await postRef.get();

                if (postSnap.exists) {
                    const postData = postSnap.data();
                    postAuthorId = postData.authorUid; // Set post author ID

                    postTitleElem.textContent = postData.title;
                    // Update the document title based on the post title
                    document.title = `${postData.title} - N-MATE`;

                    postAuthorElem.textContent = `작성자: ${postData.authorEmail ? postData.authorEmail.split('@')[0] : '익명'}`;
                    postDateElem.textContent = postData.createdAt ? new Date(postData.createdAt.seconds * 1000).toLocaleString('ko-KR') : '날짜 없음';
                    postCategoryElem.textContent = postData.category || '기타';
                    postContentElem.innerHTML = postData.contentHtml || '<p>내용 없음</p>';
                    postLikesElem.textContent = postData.likes !== undefined ? postData.likes : 0;
                    postViewsElem.textContent = postData.views !== undefined ? postData.views : 0;

                    // Increment view count if user is not the author (to prevent self-inflating views)
                    // Or, for simplicity, increment regardless, or use a more robust tracking method if needed
                    // For this exercise, we'll increment for any view for now.
                    const newViews = (postData.views || 0) + 1;
                    await postRef.update({ views: newViews });
                    postViewsElem.textContent = newViews; // Update displayed views immediately

                    updatePostActionsVisibility(); // Update edit/delete button visibility
                    setupCommentsListener(id); // Start listening for comments
                } else {
                    postTitleElem.textContent = '게시물을 찾을 수 없습니다.';
                    postContentElem.innerHTML = '<p>요청하신 게시물이 존재하지 않거나 삭제되었습니다.</p>';
                    postAuthorElem.textContent = '';
                    postDateElem.textContent = '';
                    postCategoryElem.textContent = '';
                    postLikesElem.textContent = 0;
                    postViewsElem.textContent = 0;
                    postCommentsCount.textContent = 0;
                    commentsSectionCount.textContent = 0;
                    document.title = '게시물 찾을 수 없음 - N-MATE'; // Update title for not found
                    console.log('게시물 없음:', id);
                }
            } catch (error) {
                console.error('게시물 가져오기 오류:', error);
                showMessageBox('게시물을 가져오는 중 오류가 발생했습니다: ' + error.message);
                postTitleElem.textContent = '게시물 로드 오류';
                postContentElem.innerHTML = '<p>게시물을 로드하는 중 오류가 발생했습니다.</p>';
                document.title = '오류 - N-MATE'; // Update title on error
            }
        }

        /**
         * Sets up a real-time listener for comments on the current post.
         * @param {string} postId - The ID of the post.
         */
        function setupCommentsListener(postId) {
            const commentsCollectionRef = db.collection('artifacts').doc(appId).collection('public').doc('data').collection('posts').doc(postId).collection('comments');
            const q = commentsCollectionRef.orderBy('timestamp', 'asc');

            q.onSnapshot((snapshot) => {
                commentsList.innerHTML = ''; // Clear existing comments
                if (snapshot.empty) {
                    commentsList.innerHTML = '<p class="text-gray-500 text-center">댓글이 없습니다.</p>';
                    postCommentsCount.textContent = 0;
                    commentsSectionCount.textContent = 0;
                } else {
                    snapshot.forEach((doc) => {
                        renderComment(doc.data());
                    });
                    postCommentsCount.textContent = snapshot.size;
                    commentsSectionCount.textContent = snapshot.size;
                }
            }, (error) => {
                console.error('댓글 실시간 업데이트 오류:', error);
                showMessageBox('댓글을 불러오는 중 오류가 발생했습니다: ' + error.message);
            });
        }

        /**
         * Displays a custom message box.
         * Replaces native alert() for better UI control in an iframe environment.
         * @param {string} message - The message to display.
         */
        function showMessageBox(message) {
            const messageBox = document.createElement('div');
            messageBox.classList.add('fixed', 'inset-0', 'flex', 'items-center', 'justify-center', 'bg-black', 'bg-opacity-50', 'z-50');
            messageBox.innerHTML = `
                <div class="bg-white p-6 rounded-lg shadow-xl max-w-sm w-full mx-4 text-center">
                    <p class="text-gray-800 text-lg mb-4">${message}</p>
                    <button id="messageBoxClose" class="bg-blue-500 hover:bg-blue-600 text-white font-semibold py-2 px-4 rounded-md transition duration-300">확인</button>
                </div>
            `;
            document.body.appendChild(messageBox);

            document.getElementById('messageBoxClose').addEventListener('click', () => {
                document.body.removeChild(messageBox);
            });
        }

        /**
         * Displays a custom confirmation box.
         * Replaces native confirm() for better UI control in an iframe environment.
         * @param {string} message - The confirmation message to display.
         * @param {Function} onConfirm - Callback function to execute if user confirms.
         * @param {Function} [onCancel] - Optional callback function to execute if user cancels.
         */
        function showConfirmBox(message, onConfirm, onCancel) {
            const confirmBox = document.createElement('div');
            confirmBox.classList.add('fixed', 'inset-0', 'flex', 'items-center', 'justify-center', 'bg-black', 'bg-opacity-50', 'z-50');
            confirmBox.innerHTML = `
                <div class="bg-white p-6 rounded-lg shadow-xl max-w-sm w-full mx-4 text-center">
                    <p class="text-gray-800 text-lg mb-4">${message}</p>
                    <div class="flex justify-center space-x-4">
                        <button id="confirmBoxConfirm" class="bg-blue-500 hover:bg-blue-600 text-white font-semibold py-2 px-4 rounded-md transition duration-300">확인</button>
                        <button id="confirmBoxCancel" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-semibold py-2 px-4 rounded-md transition duration-300">취소</button>
                    </div>
                </div>
            `;
            document.body.appendChild(confirmBox);

            document.getElementById('confirmBoxConfirm').addEventListener('click', () => {
                document.body.removeChild(confirmBox);
                if (onConfirm) onConfirm();
            });

            document.getElementById('confirmBoxCancel').addEventListener('click', () => {
                document.body.removeChild(confirmBox);
                if (onCancel) onCancel();
            });
        }


        document.addEventListener('DOMContentLoaded', async () => {
            // Firebase initialization
            if (firebaseConfig && firebaseConfig.apiKey) {
                if (firebase.apps.length === 0) {
                    try {
                        app = firebase.initializeApp(firebaseConfig);
                        auth = firebase.auth();
                        db = firebase.firestore();
                        console.log('Firebase 앱, 인증, Firestore 초기화 성공.');

                        // `onAuthStateChanged` 리스너만 설정하여 인증 상태 변경에 따라 UI 업데이트
                        // 이 리스너는 로그인 상태와 관계없이 항상 호출되므로, 비로그인 사용자도 게시물을 볼 수 있습니다.
                        auth.onAuthStateChanged(async (user) => {
                            await updateAccountUI(user);
                        });

                    } catch (error) {
                        console.error('Firebase 초기화 실패:', error);
                        await updateAccountUI(null); // 초기화 실패 시에도 UI를 로그아웃 상태로 업데이트
                    }
                } else {
                    app = firebase.app();
                    auth = firebase.auth();
                    db = firebase.firestore();
                    console.log('Firebase 앱이 이미 초기화되었습니다. 기존 인스턴스를 사용합니다.');
                    
                    // `onAuthStateChanged` 리스너만 다시 연결
                    auth.onAuthStateChanged(async (user) => {
                        await updateAccountUI(user);
                    });
                }
            } else {
                console.warn('Firebase 구성이 제대로 제공되지 않았습니다. Firebase를 초기화할 수 없습니다.');
                await updateAccountUI(null); // 구성이 없을 시에도 UI 업데이트
            }

            // Get post ID from URL (e.g., /view/your-post-id)
            const pathParts = window.location.pathname.split('/');
            // Expecting URL like /view/{postId}
            if (pathParts.length > 2 && pathParts[1] === 'view') {
                postId = pathParts[2];
            }
            
            // 게시물 ID가 있으면 게시물 데이터를 가져옵니다. 로그인 여부와 관계없이 게시물을 표시합니다.
            if (postId) {
                fetchPostData(postId);
            } else {
                postTitleElem.textContent = '게시물 ID를 찾을 수 없습니다.';
                postContentElem.innerHTML = '<p>URL에 게시물 ID가 없습니다. 올바른 접근 경로를 통해 게시물에 접근해주세요.</p>';
                document.title = '게시물 찾을 수 없음 - N-MATE'; // Default title if no post ID
            }

            // Event Listeners
            backButton.addEventListener('click', handleBackButtonClick);
            editPostButton.addEventListener('click', handleEditPost);
            deletePostButton.addEventListener('click', handleDeletePost);
            submitCommentButton.addEventListener('click', handleSubmitComment);

            // Global click listener to close dropdown when clicking outside
            window.addEventListener('click', function(e) {
                const accountTabButton = document.getElementById('accountTabButton');
                if (accountTabButton && !accountTabButton.contains(e.target) && !accountDropdown.contains(e.target)) {
                    accountDropdown.classList.add('hidden');
                }
            });

            // Setup navigation click handlers
            setupNavigationEvents();
            // Update navigation active state on initial load (for current page)
            updateNavigationActiveState();

            // Initial icon creation
            lucide.createIcons();
        });
    </script>
</body>
</html>
