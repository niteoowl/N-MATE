<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MATH-ABLE Exam Editor Pro</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-kopub@1.0">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200" />
    <style>
        :root {
            --editor-bg: #1e1e1e;
            --accent-color: #2c3e50;
            --main-font: 'KoPub Batang', serif;
            --sub-font: 'KoPub Dotum', sans-serif;
            --math-font: 'Times New Roman', serif;
            --grid-color: #e0e0e0;
        }

        body { margin: 0; padding: 0; min-height: 100vh; display: flex; flex-direction: column; background: #333; overflow: hidden; }
        * { box-sizing: border-box; }

        /* Toolbar */
        .toolbar { 
            background: #fff; padding: 0 15px; border-bottom: 1px solid #ccc; 
            display: flex; justify-content: space-between; align-items: center; 
            height: 70px; z-index: 100;
        }
        .toolbar-group { display: flex; gap: 8px; align-items: center; }
        .logo { font-family: var(--sub-font); font-weight: 900; color: var(--accent-color); font-size: 1.1rem; margin-right: 10px; }

        .control-item { display: flex; flex-direction: column; gap: 2px; }
        .control-label { font-size: 10px; color: #666; font-weight: bold; margin-left: 2px; }

        button, select, input { 
            padding: 6px 10px; border: 1px solid #ccc; background: #fff; border-radius: 4px; 
            cursor: pointer; font-size: 12px; font-weight: bold; display: flex; align-items: center; gap: 4px; 
            height: 32px;
        }
        input[type="number"] { width: 60px; cursor: text; }
        .btn-primary { background-color: var(--accent-color); color: white; border: none; padding: 0 15px; }
        .btn-primary:hover { opacity: 0.9; }
        .btn-primary:disabled { background-color: #ccc; cursor: not-allowed; }
        
        /* Layout */
        .workspace { display: flex; flex: 1; height: calc(100vh - 70px); overflow: hidden; position: relative; }
        
        .editor-pane { 
            width: 350px; background: var(--editor-bg); display: flex; flex-direction: column; 
            transition: transform 0.3s ease; border-right: 1px solid #000;
        }
        .editor-pane.collapsed { transform: translateX(-350px); width: 0; }
        textarea#codeInput { 
            flex: 1; width: 100%; background: transparent; color: #d4d4d4; border: none; 
            padding: 20px; font-family: 'Consolas', monospace; font-size: 12px; 
            line-height: 1.6; resize: none; outline: none;
        }

        #toggle-btn {
            position: absolute; left: 350px; top: 50%; transform: translateY(-50%);
            z-index: 150; width: 24px; height: 60px; background: #fff; border: 1px solid #ccc;
            border-left: none; border-radius: 0 6px 6px 0; cursor: pointer; display: flex; align-items: center; justify-content: center;
            transition: left 0.3s ease;
        }
        .editor-pane.collapsed + #toggle-btn { left: 0; }

        .preview-pane { 
            flex: 1; background: #525659; overflow-y: auto; padding: 20px 0; 
            display: flex; flex-direction: column; align-items: center;
        }

        /* Loading Indicator */
        #loading-overlay {
            display: none; position: fixed; top: 70px; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.5); z-index: 200; align-items: center; justify-content: center;
            flex-direction: column; color: white;
        }

        .page-wrapper { width: 210mm; margin-bottom: 20px; flex-shrink: 0; display: flex; justify-content: center; }

        .page-container {
            width: 210mm; height: 297mm; background: white; 
            padding: 15mm 15mm 10mm 15mm;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3); 
            font-family: var(--main-font); color: #111; 
            position: relative; display: flex; flex-direction: column;
            overflow: hidden; transform-origin: top center;
        }

        /* Exam Content */
        .exam-header {
            width: 100%; border-top: 3px solid var(--accent-color); border-bottom: 1.2px solid #000;
            padding: 8px 0; margin-bottom: 15px; display: flex; justify-content: space-between; align-items: flex-end;
        }
        .h-title { font-family: var(--sub-font); font-size: 18pt; font-weight: 800; color: var(--accent-color); }
        .h-info { font-family: var(--sub-font); font-size: 10.5pt; }
        .h-info b { display: inline-block; width: 80px; border-bottom: 1px solid #000; margin-left: 5px; height: 1.2em; }

        .exam-body { column-count: 2; column-gap: 15mm; column-rule: 0.2px solid #eee; flex: 1; }
        .q-block { margin-bottom: 30px; break-inside: avoid; position: relative; }
        .q-num { font-family: var(--sub-font); font-weight: 900; color: var(--accent-color); font-size: 12pt; margin-bottom: 10px; }
        
        /* Advanced Vertical Division Style */
        .vertical-division-wrapper {
            display: flex;
            flex-direction: column;
            margin-left: 5px;
            margin-top: 15px;
        }
        
        .division-main-row {
            display: flex;
            align-items: center;
            font-family: var(--math-font);
            font-size: 24pt;
            line-height: 1;
            position: relative;
        }

        .divisor {
            padding-right: 8px;
            text-align: right;
            min-width: 45px;
        }

        .dividend-box {
            position: relative;
            padding: 8px 15px 5px 15px;
            letter-spacing: 5px;
        }

        .division-svg {
            position: absolute;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
        }

        /* Calculation Grid for solving */
        .calc-grid {
            margin-top: -5px;
            margin-left: 53px; /* Align with dividend-box */
            width: 140px;
            height: 180px;
            background-image: 
                linear-gradient(to right, var(--grid-color) 1px, transparent 1px),
                linear-gradient(to bottom, var(--grid-color) 1px, transparent 1px);
            background-size: 25px 30px; /* Cell size */
            border-left: 1.5px solid #ccc;
            border-top: none;
            opacity: 0.6;
            position: relative;
        }

        /* Horizontal Style */
        .math-horizontal { 
            font-size: 22pt; 
            font-family: var(--math-font); 
            margin: 30px 0; 
            letter-spacing: 2px; 
            display: flex;
            align-items: center;
        }

        .answer-area { 
            margin-top: 20px; 
            padding-top: 10px;
            border-top: 1px solid #f0f0f0;
            font-size: 10pt; 
            color: #444; 
            display: flex;
            gap: 15px;
        }
        .ans-slot { border-bottom: 1px solid #999; width: 60px; display: inline-block; text-align: center; height: 1.2em; }

        .instr-tag { display: inline-block; background: #000; color: #fff; font-size: 8pt; padding: 2px 8px; font-weight: bold; margin-bottom: 6px; }
        .instr-text { font-size: 11pt; font-weight: bold; margin-bottom: 20px; border-bottom: 1px dashed #eee; padding-bottom: 8px; }
        .exam-footer { margin-top: auto; padding-top: 8px; text-align: center; font-size: 8pt; color: #bbb; }

        /* Answer Page */
        .answer-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; margin-top: 20px; }
        .ans-box { border: 1px solid #eee; padding: 8px; text-align: center; font-size: 10pt; border-radius: 4px; }
        .ans-num { font-weight: bold; color: var(--accent-color); margin-right: 5px; }

        @media print {
            @page { size: A4; margin: 0; }
            body { background: white !important; overflow: visible !important; }
            .toolbar, .editor-pane, #toggle-btn, #loading-overlay { display: none !important; }
            .workspace { display: block !important; height: auto !important; }
            .preview-pane { display: block !important; padding: 0 !important; background: white !important; width: 100% !important; }
            .page-wrapper { margin: 0 !important; width: 210mm !important; height: auto !important; page-break-after: always !important; }
            .page-container { transform: none !important; box-shadow: none !important; padding: 15mm !important; }
        }
    </style>
</head>
<body>

<div id="loading-overlay">
    <div style="font-size: 24px; margin-bottom: 10px;">대량 문제 생성 및 렌더링 중...</div>
    <div id="loading-progress" style="font-size: 14px;">준비 중</div>
</div>

<div class="toolbar">
    <div class="toolbar-group">
        <div class="logo">MATH-ABLE Pro</div>
        
        <div class="control-item">
            <span class="control-label">문제 수</span>
            <input type="number" id="count-input" value="12" min="1" max="1000">
        </div>

        <div class="control-item">
            <span class="control-label">문제 유형</span>
            <select id="type-select">
                <option value="vertical">세로셈 (풀이 격자 포함)</option>
                <option value="mix">유형 섞기</option>
                <option value="horizontal">가로셈</option>
            </select>
        </div>

        <button class="btn-primary" id="gen-btn" onclick="generateProblems()">
            <span class="material-symbols-outlined">refresh</span>새 문제 생성
        </button>
    </div>
    
    <div class="toolbar-group">
        <label style="font-size: 12px; display: flex; align-items: center; gap: 5px; cursor: pointer; margin-right: 10px;">
            <input type="checkbox" id="check-ans" checked onchange="updatePreview()"> 답안지 포함
        </label>
        <button class="btn-primary" onclick="window.print()">
            <span class="material-symbols-outlined">picture_as_pdf</span> PDF 저장
        </button>
    </div>
</div>

<div class="workspace">
    <div class="editor-pane" id="editor">
        <div style="padding: 10px; color: #888; font-size: 11px; border-bottom: 1px solid #333;">EXAM DATA EDITOR</div>
        <textarea id="codeInput" oninput="debouncedPreview()" spellcheck="false"></textarea>
    </div>
    <div id="toggle-btn" onclick="toggleEditor()">
        <span class="material-symbols-outlined" id="toggle-icon">chevron_left</span>
    </div>
    <div class="preview-pane" id="preview-area"></div>
</div>

<script>
    const codeInput = document.getElementById('codeInput');
    const previewArea = document.getElementById('preview-area');
    const loadingOverlay = document.getElementById('loading-overlay');
    const loadingProgress = document.getElementById('loading-progress');
    const genBtn = document.getElementById('gen-btn');
    
    let examData = {
        title: "초등 나눗셈 정복 실전",
        subtitle: "세 자릿수 ÷ 두 자릿수",
        problems: []
    };

    window.onload = () => {
        generateProblems();
        window.addEventListener('resize', autoScale);
    };

    function generateProblems() {
        const count = parseInt(document.getElementById('count-input').value) || 12;
        const typeMode = document.getElementById('type-select').value;
        
        genBtn.disabled = true;
        
        const newProblems = [];
        // 연산 부하가 큰 경우도 루프를 최적화하여 생성
        for(let i=0; i<count; i++) {
            let b = Math.floor(Math.random() * 89) + 10; 
            let a = Math.floor(Math.random() * 899) + 100;
            if (a < b * 2) a += b * 5; 
            if (a > 999) a = Math.floor(Math.random() * 800) + 150;

            let type = typeMode;
            if (typeMode === 'mix') type = Math.random() > 0.7 ? 'horizontal' : 'vertical';

            newProblems.push({ a, b, type });
        }
        
        examData.problems = newProblems;
        codeInput.value = JSON.stringify(examData, null, 2);
        updatePreview();
    }

    // 디바운스 처리로 텍스트 입력 시 렉 방지
    let previewTimer;
    function debouncedPreview() {
        clearTimeout(previewTimer);
        previewTimer = setTimeout(updatePreview, 500);
    }

    function autoScale() {
        const pane = document.querySelector('.preview-pane');
        const wrappers = document.querySelectorAll('.page-wrapper');
        const pages = document.querySelectorAll('.page-container');
        if(!pages.length) return;

        const availableWidth = pane.clientWidth - 40;
        const scale = Math.min(1, availableWidth / 794); 

        pages.forEach((page, i) => {
            page.style.transform = `scale(${scale})`;
            if (wrappers[i]) wrappers[i].style.height = (1123 * scale) + 'px';
        });
    }

    function getVerticalDivisionHtml(divisor, dividend) {
        return `
        <div class="vertical-division-wrapper">
            <div class="division-main-row">
                <div class="divisor">${divisor}</div>
                <div class="dividend-box">
                    <svg class="division-svg" viewBox="0 0 100 100" preserveAspectRatio="none">
                        <path d="M 12 92 Q -5 50 12 8 L 100 8" 
                              fill="none" stroke="black" stroke-width="2.5" 
                              stroke-linecap="round" stroke-linejoin="round" />
                    </svg>
                    ${dividend}
                </div>
            </div>
            <div class="calc-grid"></div>
        </div>`;
    }

    async function updatePreview() {
        try {
            const data = JSON.parse(codeInput.value);
            previewArea.innerHTML = '';
            
            const problemsPerPage = 8; 
            const chunks = [];
            for (let i = 0; i < data.problems.length; i += problemsPerPage) {
                chunks.push(data.problems.slice(i, i + problemsPerPage));
            }

            loadingOverlay.style.display = 'flex';
            
            // 대량 렌더링 시 Chunk 단위로 처리하여 브라우저 멈춤 방지 (Virtual Batch Rendering)
            for (let pageIdx = 0; pageIdx < chunks.length; pageIdx++) {
                const chunk = chunks[pageIdx];
                
                // 50페이지(400문제)마다 화면 갱신을 위해 비동기 양보
                if (pageIdx % 50 === 0) {
                    loadingProgress.innerText = `렌더링 진행률: ${Math.round((pageIdx / chunks.length) * 100)}%`;
                    await new Promise(resolve => setTimeout(resolve, 0));
                }

                const wrapper = document.createElement('div');
                wrapper.className = 'page-wrapper';
                
                const page = document.createElement('div');
                page.className = 'page-container';
                
                // HTML 문자열 생성을 한 번에 수행하여 DOM 접근 최소화
                let bodyHtml = '';
                chunk.forEach((prob, i) => {
                    const qIdx = pageIdx * problemsPerPage + i + 1;
                    let contentHtml = prob.type === 'vertical' 
                        ? getVerticalDivisionHtml(prob.b, prob.a) 
                        : `<div class="math-horizontal">${prob.a} ÷ ${prob.b} = </div>`;

                    bodyHtml += `
                        <div class="q-block">
                            <div class="q-num">${qIdx}.</div>
                            <div class="math-container">${contentHtml}</div>
                            <div class="answer-area">
                                <span>몫: <span class="ans-slot"></span></span>
                                <span>나머지: <span class="ans-slot"></span></span>
                            </div>
                        </div>
                    `;
                });

                page.innerHTML = `
                    <div class="exam-header">
                        <div class="h-title">${data.title} <span style="font-size:12pt; font-weight:400; color:#888;">| ${data.subtitle}</span></div>
                        <div class="h-info">이름: <b></b></div>
                    </div>
                    <div class="instr-tag">세로셈 풀이</div>
                    <div class="instr-text">격자 칸을 활용하여 자릿수를 맞추어 정확하게 계산하시오.</div>
                    <div class="exam-body">${bodyHtml}</div>
                    <div class="exam-footer">MATH-ABLE Education • Professional Mathematical Typesetting System</div>
                `;

                wrapper.appendChild(page);
                previewArea.appendChild(wrapper);
            }

            // 답안지 렌더링 최적화
            if (document.getElementById('check-ans').checked) {
                const ansWrapper = document.createElement('div');
                ansWrapper.className = 'page-wrapper';
                const ansPage = document.createElement('div');
                ansPage.className = 'page-container';
                
                let ansGridHtml = '';
                data.problems.forEach((prob, i) => {
                    const q = Math.floor(prob.a / prob.b);
                    const r = prob.a % prob.b;
                    ansGridHtml += `
                        <div class="ans-box">
                            <span class="ans-num">${i + 1}.</span> 
                            <b>${q}</b> ${r > 0 ? `<small style="color:#e74c3c; font-weight:bold; margin-left:5px;">… ${r}</small>` : ''}
                        </div>`;
                });

                ansPage.innerHTML = `
                    <div class="exam-header"><div class="h-title">정답지</div></div>
                    <div class="answer-grid">${ansGridHtml}</div>
                `;
                ansWrapper.appendChild(ansPage);
                previewArea.appendChild(ansWrapper);
            }

            loadingOverlay.style.display = 'none';
            genBtn.disabled = false;
            setTimeout(autoScale, 100);
        } catch(e) {
            console.error("Renderer Error:", e);
            loadingOverlay.style.display = 'none';
            genBtn.disabled = false;
        }
    }

    function toggleEditor() {
        const ed = document.getElementById('editor');
        const btn = document.getElementById('toggle-btn');
        const icon = document.getElementById('toggle-icon');
        ed.classList.toggle('collapsed');
        btn.style.left = ed.classList.contains('collapsed') ? '0' : '350px';
        icon.innerText = ed.classList.contains('collapsed') ? 'chevron_right' : 'chevron_left';
        setTimeout(autoScale, 310);
    }
</script>
</body>
</html>
