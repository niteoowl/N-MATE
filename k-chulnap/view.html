<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>[ë¶€ëª¨ìš©] K-ì¶œë‚©ë¶€</title>
    <!-- Tailwind CSS ë¡œë“œ -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* í°íŠ¸ ë° ê¸°ë³¸ ì„¤ì • */
        body {
            font-family: 'Dotum', 'Gulim', sans-serif;
            background-color: #EFEFEF; 
            font-size: 13px;
        }
        /* 2000ë…„ëŒ€ ìŠ¤íƒ€ì¼ 3D ë²„íŠ¼ */
        .classic-button {
            border: 1px solid #000;
            border-color: #DFDFDF #808080 #808080 #DFDFDF;
            background-color: #D3D3D3;
            box-shadow: 1px 1px 0px #F0F0F0 inset, -1px -1px 0px #A0A0A0 inset;
            user-select: none;
        }
        .classic-button:hover:not(:disabled) {
            background-color: #BCBCBC;
        }
        .classic-button:active:not(:disabled) {
            border-color: #808080 #DFDFDF #DFDFDF #808080; /* ëˆŒë¦° íš¨ê³¼ */
            box-shadow: -1px -1px 0px #F0F0F0 inset, 1px 1px 0px #A0A0A0 inset;
        }
        .classic-button:disabled {
            background-color: #F0F0F0;
            color: #A0A0A0;
            cursor: not-allowed;
        }
        /* ê¹Šê²Œ íŒŒì¸ ì…ë ¥ í•„ë“œ/ì˜ì—­ (ì—¬ê¸°ì—ì„  readonly display) */
        .classic-output-area {
            border: 1px solid #808080;
            background-color: white;
            padding: 4px;
            box-shadow: 1px 1px 0px #FFFFFF inset;
            min-height: 50px;
        }
        /* í—¤ë” ê·¸ë¼ë°ì´ì…˜ */
        .classic-header-gradient {
            background: linear-gradient(to bottom, #A0C4E6 0%, #2B5876 100%);
            color: white;
            text-shadow: 1px 1px #000000;
        }
        /* í”„ë ˆì„/ê·¸ë£¹ ë°•ìŠ¤ */
        .classic-frame {
            border: 1px solid #808080;
            padding: 4px;
            background-color: #F0F0F0;
        }
        /* íƒ€ì´í‹€ ë°” (íŒŒë€ìƒ‰) */
        .classic-title-bar {
            background-color: #0000AA;
            color: white;
            padding: 2px 8px;
            font-weight: bold;
        }
        /* í…Œì´ë¸” ìŠ¤íƒ€ì¼ */
        .report-table th, .report-table td {
            border: 1px solid #808080;
            padding: 4px;
        }
        .report-table th {
            background-color: #BDBDBD;
        }
        .report-table {
            border-collapse: collapse;
        }
        /* ë¡œë”© ìŠ¤í”¼ë„ˆ */
        .loading-spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform rotate(360deg); }
        }
    </style>
</head>

<body class="min-h-screen flex flex-col"> 
    <!-- ì „ì²´ ì»¨í…Œì´ë„ˆ -->
    <div class="classic-frame min-h-screen flex flex-col p-2 max-w-4xl mx-auto w-full"> 
        
        <!-- 1. í—¤ë” (íƒ€ì´í‹€ ë° ë¡œê³ ) -->
        <header class="classic-header-gradient p-3 text-lg font-bold flex justify-between items-center mb-2 flex-shrink-0">
            <div class="flex items-center">
                <img src="https://i.postimg.cc/Z5p1HfXG/image01-Photoroom.png" alt="ì‹œìŠ¤í…œ ë¡œê³ " class="h-10 w-10 mr-3 object-contain" onerror="this.style.display='none'">
                <span>K-ì¶œë‚©ë¶€</span>
            </div>
            <div class="text-sm font-normal" id="share-info">
                ê³µìœ  ë³´ê³ ì„œ ID: <span id="share-id-display">ë¡œë“œ ì¤‘...</span>
            </div>
        </header>

        <!-- 2. ë©”ì¸ ë³´ê³ ì„œ ì˜ì—­ -->
        <main class="flex-grow bg-[#F0F0F0] p-4 border border-[#BDBDBD] flex flex-col">
            <div class="classic-title-bar text-sm mb-3 flex-shrink-0">
                [ìë…€ì˜ ì›”ê°„ ìš©ëˆê¸°ì…ì¥ ë³´ê³ ì„œ] - <span id="report-month-display"></span>
            </div>

            <!-- ë¡œë”©/ì—ëŸ¬ ë©”ì‹œì§€ -->
            <div id="loading-status" class="classic-output-area text-center p-8 bg-yellow-50">
                <div class="loading-spinner mx-auto mb-2"></div>
                <p class="font-bold text-gray-700">ë³´ê³ ì„œ ë°ì´í„°ë¥¼ ë¡œë“œí•˜ëŠ” ì¤‘ì…ë‹ˆë‹¤...</p>
                <p class="text-xs mt-1 text-gray-500">ì ì‹œë§Œ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”.</p>
            </div>

            <!-- ë³´ê³ ì„œ ì½˜í…ì¸  (ë¡œë“œ ì™„ë£Œ ì‹œ í‘œì‹œ) -->
            <div id="report-content" class="hidden flex flex-col space-y-4">
                
                <!-- ì¬ì • ì§‘ê³„ í˜„í™© -->
                <div class="classic-frame bg-white p-3 border border-[#BDBDBD] flex-shrink-0">
                    <h2 class="text-sm font-bold mb-2 text-blue-700">â–¶ ì›”ê°„ ìš”ì•½ í˜„í™©</h2>
                    <div class="grid grid-cols-3 gap-3 text-center p-2 bg-[#D3D3D3] text-black">
                        <div class="classic-output-area p-2 bg-green-50">
                            <div class="text-xs text-gray-600 font-bold">ì´ ìˆ˜ì…ì•¡ (+)</div>
                            <div class="text-lg font-extrabold text-green-700" id="view-total-income">ï¿¦ 0</div>
                        </div>
                        <div class="classic-output-area p-2 bg-red-50">
                            <div class="text-xs text-gray-600 font-bold">ì´ ì§€ì¶œì•¡ (-)</div>
                            <div class="text-lg font-extrabold text-red-700" id="view-total-expense">ï¿¦ 0</div>
                        </div>
                        <div class="classic-output-area p-2 bg-yellow-50">
                            <div class="text-xs text-gray-600 font-bold">ìˆœ ì”ì•¡</div>
                            <div class="text-lg font-extrabold text-blue-700" id="view-net-balance">ï¿¦ 0</div>
                        </div>
                    </div>
                </div>

                <!-- ìƒì„¸ ê±°ë˜ ë‚´ì—­ -->
                <div class="classic-frame bg-white p-3 border border-[#BDBDBD] flex-grow flex flex-col">
                    <h2 class="text-sm font-bold mb-2 text-blue-700">â–¶ ìƒì„¸ ê±°ë˜ ë‚´ì—­</h2>
                    <div class="overflow-auto flex-grow classic-output-area p-0">
                        <table class="report-table w-full text-sm">
                            <thead class="bg-[#BDBDBD] text-black sticky top-0">
                                <tr>
                                    <th class="p-2 w-[10%]">No.</th>
                                    <th class="p-2 w-[15%]">ë‚ ì§œ</th>
                                    <th class="p-2 w-[15%]">êµ¬ë¶„</th>
                                    <th class="p-2 w-[40%]">ë‚´ìš©</th>
                                    <th class="p-2 w-[20%]">ê¸ˆì•¡ (ì›)</th>
                                </tr>
                            </thead>
                            <tbody id="view-transaction-list-body">
                                <!-- ë°ì´í„°ê°€ ì—¬ê¸°ì— ë¡œë“œë©ë‹ˆë‹¤ -->
                            </tbody>
                            <tfoot>
                                <tr class="bg-[#DFDFDF] font-bold">
                                    <td class="p-2 text-right" colspan="4">ì›” í•©ê³„ ì”ì•¡:</td>
                                    <td class="p-2 text-right text-blue-800" id="view-monthly-net-balance-footer">0</td>
                                </tr>
                            </tfoot>
                        </table>
                    </div>
                </div>
            </div>
            
            <!-- ë¶€ëª¨ ìŠ¹ì¸/ë©”ì‹œì§€ ì„¹ì…˜ (ìƒˆë¡œ ì¶”ê°€) -->
            <div id="approval-section" class="mt-4 classic-frame bg-white p-3 border border-[#BDBDBD] flex-shrink-0">
                <h2 class="text-sm font-bold mb-2 text-blue-700" id="approval-title">â–¶ ë³´ê³ ì„œ ìŠ¹ì¸ ë° ë©”ì‹œì§€ ì‘ì„±</h2>
                
                <div id="approval-form">
                    <textarea id="parent-message" rows="3" placeholder="ë©”ì‹œì§€" 
                              class="w-full classic-output-area mb-3 text-sm resize-none"></textarea>
                    
                    <div class="flex flex-col sm:flex-row justify-between items-center space-y-2 sm:space-y-0">
                        <p class="text-xs text-red-500 font-bold flex items-center">
                            <svg class="w-4 h-4 inline-block align-text-bottom mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path></svg>
                            <span class="text-[10px] sm:text-xs">ìŠ¹ì¸ í›„ ìë…€ê°€ í™•ì¸ ì‹œ ì´ ë¬¸ì„œëŠ” ì‚­ì œë©ë‹ˆë‹¤.</span>
                        </p>
                        <button id="approve-button" class="px-4 py-2 classic-button font-bold bg-green-200 hover:bg-green-300 transition duration-100 w-full sm:w-auto" disabled>
                            ìŠ¹ì¸ & ë©”ì‹œì§€ ì „ì†¡
                        </button>
                    </div>
                </div>

                <div id="approval-status" class="hidden p-3 bg-gray-100 border border-gray-300 rounded">
                    <p class="text-lg font-bold text-green-700 mb-2 text-center">âœ… ì´ ë³´ê³ ì„œëŠ” ìŠ¹ì¸ë˜ì—ˆìŠµë‹ˆë‹¤.</p>
                    <p class="text-xs text-gray-600 mb-2 text-center" id="approved-by-info"></p>
                    <div class="classic-title-bar text-xs">ë¶€ëª¨ ë©”ì‹œì§€</div>
                    <div id="approved-message-display" class="classic-output-area mt-0 text-sm text-gray-800 text-left"></div>
                </div>
            </div>
            
            <p id="shared-by-info" class="text-xs text-gray-600 mt-4 text-center hidden">
                ì´ ë³´ê³ ì„œëŠ” <span id="shared-by-user"></span> ë‹˜ì´ <span id="shared-at-time"></span>ì— ê³µìœ í•˜ì…¨ìŠµë‹ˆë‹¤.
            </p>
        </main>

        <!-- ì‹œìŠ¤í…œ ìƒíƒœ ë©”ì‹œì§€ -->
        <div class="mt-4 text-xs p-1 classic-frame bg-white border border-[#BDBDBD] shadow-inner flex-shrink-0" id="status-message">
            [ì‹œìŠ¤í…œ ìƒíƒœ]: ê³µìœ  ID í™•ì¸ ì¤‘...
        </div>

    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getFirestore, doc, getDoc, updateDoc, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getAuth, signInAnonymously, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js"; 

        // ë””ë²„ê·¸ ë¡œê¹… í™œì„±í™”
        setLogLevel('Debug');
        
        // --- Firebase ì„¤ì • ë° ì „ì—­ ë³€ìˆ˜ ---
        // Canvas í™˜ê²½ì—ì„œ ì œê³µë˜ëŠ” ì „ì—­ ë³€ìˆ˜ ì‚¬ìš© (MUST BE USED)
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : { /* Fallback for local testing */ };
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        const appId = typeof __app_id !== 'undefined' ? __app_id : firebaseConfig.projectId; 

        let db;
        let auth;
        let currentUserId = null; // ìµëª… ì¸ì¦ í›„ ì–»ëŠ” ì‹œìŠ¤í…œ ID (ì“°ê¸° ê¶Œí•œìš©)
        let shareIdCache = null;
        
        // UI Elements
        const statusElement = document.getElementById('status-message');
        const loadingStatus = document.getElementById('loading-status');
        const reportContent = document.getElementById('report-content');
        const shareIdDisplay = document.getElementById('share-id-display');
        const reportMonthDisplay = document.getElementById('report-month-display');

        // Approval Elements (New)
        const parentMessageEl = document.getElementById('parent-message');
        const approveButton = document.getElementById('approve-button');
        const approvalSection = document.getElementById('approval-section');
        const approvalForm = document.getElementById('approval-form');
        const approvalStatus = document.getElementById('approval-status');
        const approvedByInfoEl = document.getElementById('approved-by-info');
        const approvedMessageDisplayEl = document.getElementById('approved-message-display');
        const approvalTitleEl = document.getElementById('approval-title');

        // Summary Elements
        const incomeEl = document.getElementById('view-total-income');
        const expenseEl = document.getElementById('view-total-expense');
        const netBalanceEl = document.getElementById('view-net-balance');
        const footerNetBalanceEl = document.getElementById('view-monthly-net-balance-footer');
        const listBody = document.getElementById('view-transaction-list-body');
        const sharedByInfo = document.getElementById('shared-by-info');
        const sharedByUser = document.getElementById('shared-by-user');
        const sharedAtTime = document.getElementById('shared-at-time');

        // Helper for Currency Formatting
        const formatCurrency = (amount) => {
            if (typeof amount !== 'number') return 'ï¿¦ 0';
            const sign = amount < 0 ? 'ï¿¦ -' : 'ï¿¦ ';
            return sign + Math.abs(amount).toLocaleString('ko-KR');
        };
        
        // Helper for Status Messages
        const setStatus = (message, isError = false) => {
            statusElement.innerHTML = `[ì‹œìŠ¤í…œ ìƒíƒœ]: ${isError ? 'ì˜¤ë¥˜: ' : ''}${message}`;
            if (isError) {
                statusElement.classList.add('error-status');
                console.error(message);
            } else {
                statusElement.classList.remove('error-status');
                console.log(message);
            }
        };

        // --- Core Logic ---

        function initFirebase() {
            try {
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app); 

                // Firebase ì¸ì¦ ì²˜ë¦¬: ì“°ê¸° ê¶Œí•œ í™•ë³´ë¥¼ ìœ„í•´ ìµëª…/í† í° ì¸ì¦ì„ ì‹œë„í•©ë‹ˆë‹¤.
                if (initialAuthToken) {
                    signInWithCustomToken(auth, initialAuthToken)
                        .then((userCredential) => {
                            currentUserId = userCredential.user.uid;
                            setStatus(`ì¸ì¦ ì™„ë£Œ. ì‹œìŠ¤í…œ ID í• ë‹¹: ${currentUserId.substring(0, 8)}...`);
                            
                            const shareId = getShareIdFromUrl();
                            if (shareId) {
                                shareIdCache = shareId;
                                loadReport(shareId);
                            } else {
                                loadingStatus.innerHTML = '<p class="font-bold text-red-700">ğŸš¨ ì˜¤ë¥˜: ê³µìœ  ë§í¬ê°€ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤. (shareId ëˆ„ë½)</p>';
                                shareIdDisplay.textContent = 'N/A';
                            }
                        })
                        .catch((error) => {
                            // í† í° ì¸ì¦ ì‹¤íŒ¨ ì‹œ ìµëª… ëª¨ë“œë¡œ ì „í™˜ (ì“°ê¸° ê¶Œí•œ ìœ ì§€ë¥¼ ìœ„í•´)
                            setStatus(`ì¸ì¦ ì‹¤íŒ¨ (í† í° ì˜¤ë¥˜): ${error.message}. ìµëª… ëª¨ë“œë¡œ ì „í™˜í•©ë‹ˆë‹¤.`, true);
                            return signInAnonymously(auth);
                        });
                } else {
                    // í† í°ì´ ì—†ëŠ” í™˜ê²½ì—ì„œëŠ” ìµëª… ì¸ì¦
                    signInAnonymously(auth).then((userCredential) => {
                        currentUserId = userCredential.user.uid;
                        setStatus(`ìµëª… ì¸ì¦ ì™„ë£Œ. ì‹œìŠ¤í…œ ID í• ë‹¹: ${currentUserId.substring(0, 8)}...`);
                    });
                }
                
                // onAuthStateChangedë¥¼ ì‚¬ìš©í•˜ì—¬ ìµœì¢… ì¸ì¦ ìƒíƒœ í™•ì¸ ë° ë³´ê³ ì„œ ë¡œë“œ
                auth.onAuthStateChanged(user => {
                    if (user) {
                        currentUserId = user.uid;
                        // ë³´ê³ ì„œ ë¡œë“œê°€ ì•„ì§ ì•ˆë˜ì—ˆìœ¼ë©´ ì‹œì‘
                        if (!shareIdCache) {
                            const shareId = getShareIdFromUrl();
                            if (shareId) {
                                shareIdCache = shareId;
                                loadReport(shareId);
                            } else {
                                if (document.getElementById('loading-status').innerHTML.includes('ë¡œë“œí•˜ëŠ” ì¤‘')) {
                                    loadingStatus.innerHTML = '<p class="font-bold text-red-700">ğŸš¨ ì˜¤ë¥˜: ê³µìœ  ë§í¬ê°€ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤. (shareId ëˆ„ë½)</p>';
                                    shareIdDisplay.textContent = 'N/A';
                                }
                            }
                        }
                    } else {
                         // ìµëª… ì‚¬ìš©ìë¼ë„ currentUserIdë¥¼ ì„¤ì •
                         if (auth.currentUser) currentUserId = auth.currentUser.uid;
                         // ì¸ì¦ ì •ë³´ê°€ ì—†ì–´ë„ ì¼ë‹¨ ë¡œë“œëŠ” ì‹œë„ (ì½ê¸° ê¶Œí•œì€ publicì´ê¸° ë•Œë¬¸)
                         if (!shareIdCache) {
                            const shareId = getShareIdFromUrl();
                            if (shareId) {
                                shareIdCache = shareId;
                                loadReport(shareId);
                            }
                         }
                    }
                });


                setStatus("Firebase ì´ˆê¸°í™” ì™„ë£Œ. ì¸ì¦ ì§„í–‰ ì¤‘...");
            } catch (error) {
                setStatus(`Firebase ì´ˆê¸°í™” ì‹¤íŒ¨: ${error.message}`, true);
            }
        }

        function getShareIdFromUrl() {
            const params = new URLSearchParams(window.location.search);
            return params.get('shareId');
        }

        async function loadReport(shareId) {
            if (!db || !shareId) {
                loadingStatus.innerHTML = '<p class="font-bold text-red-700">ğŸš¨ ì˜¤ë¥˜: ìœ íš¨í•œ ê³µìœ  IDê°€ URLì— í¬í•¨ë˜ì–´ ìˆì§€ ì•ŠìŠµë‹ˆë‹¤.</p>';
                return;
            }

            shareIdDisplay.textContent = shareId.substring(0, 8) + '...';
            setStatus(`ê³µìœ  ID (${shareId.substring(0, 5)}...)ë¡œ ë³´ê³ ì„œë¥¼ ë¡œë“œí•˜ëŠ” ì¤‘...`);

            try {
                const reportRef = doc(db, `artifacts/${appId}/public/data/sharedReports`, shareId);
                const docSnap = await getDoc(reportRef);

                if (docSnap.exists()) {
                    const reportData = docSnap.data();
                    renderReport(reportData);
                    setStatus("ë³´ê³ ì„œ ë¡œë“œ ì„±ê³µ. ì•„ë˜ ë‚´ìš©ì„ í™•ì¸í•˜ì„¸ìš”.");
                } else {
                    loadingStatus.innerHTML = '<p class="font-bold text-red-700">ğŸš¨ ì˜¤ë¥˜: í•´ë‹¹ IDì— í•´ë‹¹í•˜ëŠ” ê³µìœ  ë³´ê³ ì„œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. (ID ë§Œë£Œ ë˜ëŠ” ì‚­ì œ)</p>';
                }
            } catch (error) {
                console.error("ë³´ê³ ì„œ ë¡œë“œ ì˜¤ë¥˜:", error);
                loadingStatus.innerHTML = `<p class="font-bold text-red-700">ğŸš¨ ë³´ê³ ì„œ ë¡œë“œ ì¤‘ ì‹¬ê°í•œ ì˜¤ë¥˜ ë°œìƒ: ${error.message}</p>`;
                setStatus(`ë³´ê³ ì„œ ë¡œë“œ ì‹¤íŒ¨: ${error.message}`, true);
            }
        }

        function renderReport(data) {
            // 1. ë¡œë”© ìƒíƒœ ìˆ¨ê¸°ê¸°, ì½˜í…ì¸  í‘œì‹œ
            loadingStatus.classList.add('hidden');
            reportContent.classList.remove('hidden');

            // 2. ì œëª© ë° ê³µìœ  ì •ë³´ ì—…ë°ì´íŠ¸
            const [year, month] = data.month.split('-');
            reportMonthDisplay.textContent = `${year}ë…„ ${month}ì›”`;
            
            const sharedDate = new Date(data.createdAt).toLocaleString('ko-KR');
            sharedByUser.textContent = data.sharedBy.substring(0, 8) + '...';
            sharedAtTime.textContent = sharedDate;
            sharedByInfo.classList.remove('hidden');

            // 3. ìš”ì•½ ì •ë³´ ì—…ë°ì´íŠ¸
            const { income, expense, netBalance } = data.summary;
            incomeEl.textContent = formatCurrency(income);
            expenseEl.textContent = formatCurrency(expense);
            netBalanceEl.textContent = formatCurrency(netBalance);
            footerNetBalanceEl.textContent = netBalance.toLocaleString('ko-KR');

            // 4. ìƒì„¸ ê±°ë˜ ë‚´ì—­ ì—…ë°ì´íŠ¸
            renderTransactions(data.transactions);
            
            // 5. ìŠ¹ì¸ ìƒíƒœ ì—…ë°ì´íŠ¸
            renderApprovalStatus(data);
        }
        
        function renderApprovalStatus(data) {
            // approvedBy í•„ë“œëŠ” ë” ì´ìƒ ê¸°ë¡í•˜ì§€ ì•Šìœ¼ë¯€ë¡œ, ë°ì´í„° êµ¬ì¡°ì—ì„œ ì œì™¸í•©ë‹ˆë‹¤.
            const { approved, parentMessage, approvedAt } = data;
            
            if (approved) {
                // ìŠ¹ì¸ ì™„ë£Œ ìƒíƒœ í‘œì‹œ
                approvalForm.classList.add('hidden');
                approvalStatus.classList.remove('hidden');
                approvalTitleEl.textContent = 'â–¶ ìŠ¹ì¸ ì™„ë£Œ ì •ë³´';

                const approvedDate = approvedAt ? new Date(approvedAt).toLocaleString('ko-KR') : 'ì •ë³´ ì—†ìŒ';
                
                // ìŠ¹ì¸ì ID ëŒ€ì‹  ë‹¨ìˆœ 'ìŠ¹ì¸ ì™„ë£Œ' ë©”ì‹œì§€ì™€ ì¼ì‹œë§Œ í‘œì‹œ
                approvedByInfoEl.textContent = `ìŠ¹ì¸ ì™„ë£Œ | ìŠ¹ì¸ ì¼ì‹œ: ${approvedDate}`;
                
                approvedMessageDisplayEl.innerHTML = `
                    <p class="p-1">${parentMessage || 'ë©”ì‹œì§€ ì—†ìŒ'}</p>
                `;
                
            } else {
                // ìŠ¹ì¸ ëŒ€ê¸° ìƒíƒœ (í¼ í‘œì‹œ)
                approvalForm.classList.remove('hidden');
                approvalStatus.classList.add('hidden');
                approvalTitleEl.textContent = 'â–¶ ë³´ê³ ì„œ ìŠ¹ì¸ ë° ë©”ì‹œì§€ ì‘ì„±';
                
                // ë²„íŠ¼ í™œì„±í™”
                approveButton.disabled = false;
                approveButton.onclick = handleApproval;
                approveButton.textContent = 'ìŠ¹ì¸ & ë©”ì‹œì§€ ì „ì†¡';
            }
        }
        
        function renderTransactions(transactions) {
            listBody.innerHTML = '';
            
            if (!transactions || transactions.length === 0) {
                listBody.innerHTML = `<tr><td class="p-2 text-center text-gray-500" colspan="5">ë“±ë¡ëœ ê±°ë˜ ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤.</td></tr>`;
                return;
            }
            
            transactions.forEach((tx, index) => {
                const isIncome = tx.amount > 0;
                const rowClass = isIncome ? 'bg-green-50' : 'bg-red-50';
                const amountClass = isIncome ? 'text-green-700' : 'text-red-700';
                const displayAmount = Math.abs(tx.amount).toLocaleString('ko-KR');

                const row = document.createElement('tr');
                row.className = `text-xs ${rowClass}`;
                row.innerHTML = `
                    <td class="text-center">${transactions.length - index}</td>
                    <td class="text-center">${tx.date.substring(5)}</td>
                    <td class="text-center">${isIncome ? 'ìˆ˜ì… (+)' : 'ì§€ì¶œ (-)'}</td>
                    <td>${tx.memo} (${tx.method})</td>
                    <td class="text-right font-bold ${amountClass}">${isIncome ? '+' : '-'}${displayAmount}</td>
                `;
                listBody.appendChild(row);
            });
        }
        
        async function handleApproval() {
            // ì“°ê¸° ê¶Œí•œì€ ì¸ì¦ì„ í†µí•´ í™•ë³´ë˜ì—ˆìœ¼ë¯€ë¡œ, ê³µìœ  IDë§Œ í™•ì¸í•©ë‹ˆë‹¤.
            if (!shareIdCache) {
                setStatus("ìŠ¹ì¸ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: ê³µìœ  IDê°€ ì—†ìŠµë‹ˆë‹¤.", true);
                return;
            }
            
            // UI ë¡œë”© ìƒíƒœ ë° ë²„íŠ¼ ë¹„í™œì„±í™”
            approveButton.disabled = true;
            approveButton.textContent = 'ì „ì†¡ ì¤‘...';

            const message = parentMessageEl.value.trim() || 'í™•ì¸í–ˆìŠµë‹ˆë‹¤. ìˆ˜ê³ í–ˆì–´!';
            
            try {
                const reportRef = doc(db, `artifacts/${appId}/public/data/sharedReports`, shareIdCache);
                
                // Firestore ë¬¸ì„œ ì—…ë°ì´íŠ¸: ìŠ¹ì¸ì IDëŠ” ì €ì¥í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.
                await updateDoc(reportRef, {
                    approved: true,
                    parentMessage: message,
                    approvedAt: new Date().toISOString()
                    // approvedBy í•„ë“œ ì œê±°ë¨
                });

                // ì„±ê³µ í›„ UI ì—…ë°ì´íŠ¸
                setStatus("ë³´ê³ ì„œ ìŠ¹ì¸ ë° ë©”ì‹œì§€ ì „ì†¡ ì„±ê³µ!");
                
                // UIë¥¼ ìˆ˜ë™ìœ¼ë¡œ ì—…ë°ì´íŠ¸í•˜ì—¬ ì¦‰ì‹œ ë°˜ì˜ (ìŠ¹ì¸ì ID ì—†ì´)
                renderApprovalStatus({ 
                    approved: true, 
                    parentMessage: message, 
                    approvedAt: new Date().toISOString()
                });

            } catch (error) {
                setStatus(`ë³´ê³ ì„œ ìŠ¹ì¸ ì¤‘ ì˜¤ë¥˜ ë°œìƒ: ${error.message}`, true);
                approveButton.disabled = false;
                approveButton.textContent = 'ìŠ¹ì¸ & ë©”ì‹œì§€ ì „ì†¡';
            }
        }

        // --- Initialization ---
        document.addEventListener('DOMContentLoaded', () => {
            initFirebase();
            // loadReportëŠ” initFirebase ë‚´ì—ì„œ ì¸ì¦ ì™„ë£Œ í›„ í˜¸ì¶œë©ë‹ˆë‹¤.
        });
    </script>
</body>
</html>
