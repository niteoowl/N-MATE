<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>[ë¶€ëª¨í™•ì¸ìš©] K-ì¶œë‚©ë¶€</title>
    <!-- Tailwind CSS ë¡œë“œ -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* í°íŠ¸ ë° ê¸°ë³¸ ì„¤ì • */
        body {
            font-family: 'Dotum', 'Gulim', sans-serif;
            background-color: #EFEFEF; 
            font-size: 13px;
        }
        /* 2000ë…„ëŒ€ ìŠ¤íƒ€ì¼ 3D ë²„íŠ¼ */
        .classic-button {
            border: 1px solid #000;
            border-color: #DFDFDF #808080 #808080 #DFDFDF;
            background-color: #D3D3D3;
            box-shadow: 1px 1px 0px #F0F0F0 inset, -1px -1px 0px #A0A0A0 inset;
            user-select: none;
        }
        .classic-button:active:not(:disabled) {
            border-color: #808080 #DFDFDF #DFDFDF #808080;
            box-shadow: -1px -1px 0px #F0F0F0 inset, 1px 1px 0px #A0A0A0 inset;
        }
        .classic-button:disabled {
            color: #808080;
        }
        /* ì•¡ì…˜ ë²„íŠ¼ í˜¸ë²„ íš¨ê³¼ë¥¼ ì‹œê°ì ìœ¼ë¡œ ê°•ì¡° */
        .classic-button:hover:not(:disabled) {
            background-color: #EAEAEA;
        }
        
        /* í—¤ë” ê·¸ë¼ë°ì´ì…˜ */
        .classic-header-gradient {
            background: linear-gradient(to bottom, #A0C4E6 0%, #2B5876 100%);
            color: white;
            text-shadow: 1px 1px #000000;
        }
        /* í”„ë ˆì„/ê·¸ë£¹ ë°•ìŠ¤ */
        .classic-frame {
            border: 1px solid #808080;
            padding: 4px;
            background-color: #F0F0F0;
        }
        /* íƒ€ì´í‹€ ë°” (íŒŒë€ìƒ‰) */
        .classic-title-bar {
            background-color: #0000AA;
            color: white;
            padding: 2px 8px;
            font-weight: bold;
        }
        /* ë¡œë”© ìŠ¤í”¼ë„ˆ */
        .loading-spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        /* ë°ì´í„° í–‰ ë†’ì´ ê³ ì • */
        .data-row td { height: 28px; }
        /* í…Œì´ë¸” í—¤ë” ìŠ¤íƒ€ì¼ */
        #report-table thead th { border: 1px solid #808080; padding: 4px; }
        #report-table tbody td { border: 1px solid #D3D3D3; padding: 4px; }
    </style>
</head>

<body class="min-h-screen flex flex-col"> 
    <!-- ì „ì²´ ì»¨í…Œì´ë„ˆ -->
    <div class="classic-frame min-h-screen flex flex-col p-2"> 
        
        <!-- 1. í—¤ë” (íƒ€ì´í‹€ ë° ë¡œê³ ) -->
        <header class="classic-header-gradient p-3 text-lg font-bold flex justify-between items-center mb-1 flex-shrink-0">
            <div class="flex items-center">
                <img src="https://i.postimg.cc/Z5p1HfXG/image01-Photoroom.png" alt="ì‹œìŠ¤í…œ ë¡œê³ " class="h-12 w-12 mr-3 object-contain" onerror="this.style.display='none'">
                <span>K-ì¶œë‚©ë¶€</span>
            </div>
            <div class="text-sm font-normal flex items-center">
                <span id="report-info">ê³µìœ  ID: ë¡œë“œ ì¤‘...</span>
            </div>
        </header>

        <!-- 2. ë©”ì¸ ë³´ê³ ì„œ ì˜ì—­ -->
        <main class="flex-grow bg-[#F0F0F0] p-4 border border-[#BDBDBD] flex flex-col">
            <div class="classic-title-bar text-sm mb-3 flex-shrink-0 flex justify-between items-center">
                <span id="report-title">[ì›”ê°„ ì¬ì • ê¸°ë¡ ë³´ê³ ì„œ] - <span id="report-month-year"></span></span>
                <span id="share-status" class="text-xs font-normal bg-yellow-400 text-black px-2 py-0.5 border border-black">ì½ê¸° ì „ìš©</span>
            </div>

            <!-- ë¡œë”© ë° ì˜¤ë¥˜ ë©”ì‹œì§€ -->
            <div id="loading-view" class="flex flex-col items-center justify-center flex-grow p-10">
                <div class="loading-spinner"></div>
                <p class="mt-4 text-gray-700 font-bold">ê³µìœ  ë³´ê³ ì„œ ë°ì´í„° ë¡œë“œ ì¤‘...</p>
            </div>
            
            <div id="error-view" class="hidden classic-frame p-6 bg-red-100 border-red-800 text-red-800 text-center flex-grow">
                <p class="text-lg font-bold mb-3">ë³´ê³ ì„œ ë¡œë“œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤</p>
                <p id="error-message" class="text-sm">URLì„ í™•ì¸í•˜ê±°ë‚˜ ìë…€ì—ê²Œ ë‹¤ì‹œ ê³µìœ ë¥¼ ìš”ì²­í•˜ì„¸ìš”.</p>
            </div>

            <!-- ë³´ê³ ì„œ ë‚´ìš© (ë°ì´í„° ë¡œë“œ ì„±ê³µ ì‹œ í‘œì‹œ) -->
            <div id="report-content" class="hidden flex flex-col flex-grow">
                
                <!-- ì§‘ê³„ ìš”ì•½ -->
                <div class="classic-frame bg-white p-3 mb-4 border border-[#808080] flex-shrink-0">
                    <div class="classic-title-bar text-xs mb-1 bg-green-700">
                        [ì›”ê°„ ì¬ì • ì§‘ê³„ ìš”ì•½]
                    </div>
                    <div class="grid grid-cols-3 gap-4 text-center p-2 bg-[#D3D3D3]">
                        <div class="classic-frame p-2 bg-green-50">
                            <div class="text-xs text-gray-600 font-bold">ì´ ìˆ˜ì…ì•¡ (+)</div>
                            <div class="text-lg font-extrabold text-green-700" id="summary-income">ï¿¦ 0</div>
                        </div>
                        <div class="classic-frame p-2 bg-red-50">
                            <div class="text-xs text-gray-600 font-bold">ì´ ì§€ì¶œì•¡ (-)</div>
                            <div class="text-lg font-extrabold text-red-700" id="summary-expense">ï¿¦ 0</div>
                        </div>
                        <div class="classic-frame p-2 bg-yellow-50">
                            <div class="text-xs text-gray-600 font-bold">ìˆœ ì”ì•¡</div>
                            <div class="text-lg font-extrabold text-blue-700" id="summary-balance">ï¿¦ 0</div>
                        </div>
                    </div>
                </div>

                <!-- ìƒì„¸ ë‚´ì—­ í‘œ -->
                <div class="flex flex-col flex-grow">
                    <div class="classic-title-bar text-xs mb-1 bg-blue-700">
                        [ìƒì„¸ ê±°ë˜ ë‚´ì—­]
                    </div>
                    <div class="border border-[#808080] bg-white overflow-auto flex-grow">
                        <table class="w-full text-sm" id="report-table">
                            <thead class="bg-[#BDBDBD] text-black sticky top-0">
                                <tr>
                                    <th class="w-[10%]">No.</th>
                                    <th class="w-[20%]">ë‚ ì§œ</th>
                                    <th class="w-[15%]">ìˆ˜ë‹¨</th>
                                    <th class="w-[45%]">ë‚´ìš©</th>
                                    <th class="w-[10%]">ê¸ˆì•¡ (ì›)</th>
                                </tr>
                            </thead>
                            <tbody id="transaction-list-body">
                                <!-- ê±°ë˜ ë°ì´í„°ê°€ ì—¬ê¸°ì— ì‚½ì…ë©ë‹ˆë‹¤ -->
                            </tbody>
                            <tfoot>
                                <tr class="bg-[#DFDFDF] font-bold">
                                    <td class="border p-1 text-right" colspan="4">ì›” í•©ê³„ ì”ì•¡:</td>
                                    <td class="border p-1 text-right text-green-800" id="monthly-net-balance-footer">0</td>
                                </tr>
                            </tfoot>
                        </table>
                    </div>
                </div>

                <!-- 3. ìŠ¹ì¸/í™•ì¸ ì˜ì—­ (ìŠ¹ì¸/ë°˜ë ¤ ê¸°ëŠ¥) -->
                <div id="approval-section" class="mt-4 classic-frame bg-white p-3 border border-[#808080] flex-shrink-0 text-center">
                    <div id="approval-status-display" class="font-bold text-base mb-2 text-gray-700">
                        ë³´ê³ ì„œ í™•ì¸ í›„, ì•„ë˜ ë²„íŠ¼ì„ ëˆŒëŸ¬ ìŠ¹ì¸/ë°˜ë ¤í•´ì£¼ì„¸ìš”.
                    </div>
                    
                    <!-- ë¶€ëª¨ë‹˜ ì½”ë©˜íŠ¸ ì…ë ¥ ì˜ì—­ -->
                    <textarea id="approval-comment" class="w-full classic-frame p-2 mb-3 text-sm resize-y" rows="3" placeholder="ìë…€ì—ê²Œ ì „ë‹¬í•  ìŠ¹ì¸/ë°˜ë ¤ ë©”ì‹œì§€ë‚˜ ê°„ë‹¨í•œ ì½”ë©˜íŠ¸ë¥¼ ë‚¨ê²¨ì£¼ì„¸ìš”. (ë°˜ë ¤ ì‹œ ì½”ë©˜íŠ¸ ê¶Œì¥)"></textarea>

                    <!-- ì•¡ì…˜ ë²„íŠ¼ ê·¸ë£¹ -->
                    <div class="flex justify-center space-x-4">
                        <button id="reject-button" class="classic-button text-base px-6 py-2 flex-1 max-w-[180px] disabled:opacity-50 hover:bg-red-200">
                            âŒ ë°˜ë ¤ (ìˆ˜ì • ìš”ì²­)
                        </button>
                        <button id="approve-button" class="classic-button text-base px-6 py-2 flex-1 max-w-[180px] disabled:opacity-50 hover:bg-green-200">
                            âœ… í™•ì¸ ë° ìŠ¹ì¸
                        </button>
                    </div>

                    <!-- ì €ì¥ëœ ìŠ¹ì¸/ë°˜ë ¤ ë©”ì‹œì§€ í‘œì‹œ ì˜ì—­ (ì•¡ì…˜ ì™„ë£Œ ì‹œ í‘œì‹œ) -->
                    <div id="saved-approval-message" class="hidden mt-3 p-3 classic-frame bg-yellow-100 text-left text-sm whitespace-pre-wrap">
                        <!-- ì €ì¥ëœ ë©”ì‹œì§€ê°€ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤ -->
                    </div>
                </div>

            </div>
            
        </main>

        <!-- ì‹œìŠ¤í…œ ìƒíƒœ ë©”ì‹œì§€ -->
        <div class="mt-4 text-xs p-1 classic-frame bg-white border border-[#BDBDBD] shadow-inner flex-shrink-0" id="status-message">
            [ì‹œìŠ¤í…œ ìƒíƒœ]: ì¤€ë¹„ ì¤‘...
        </div>
        <div class="mt-2 text-xs text-center text-gray-600">
            * ì´ ë³´ê³ ì„œëŠ” ìë…€ê°€ íŠ¹ì • ì‹œì ì— ê³µìœ í•œ ì½ê¸° ì „ìš© ë°ì´í„°ì…ë‹ˆë‹¤.
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        // Auth ê´€ë ¨ í•¨ìˆ˜: signInAnonymouslyë¥¼ ì¶”ê°€í•©ë‹ˆë‹¤.
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        // updateDoc ì‚¬ìš©ì„ ìœ„í•´ updateDocì„ ì¶”ê°€í•˜ê³  addDoc, collectionì€ ë©”ì‹œì§€ ì‹œìŠ¤í…œ ì œê±°ë¡œ ì¸í•´ ë” ì´ìƒ í•„ìš”í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.
        import { getFirestore, doc, getDoc, updateDoc, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        setLogLevel('Debug');

        // --- Firebase/Auth/Global Setup ---
        
        // ì‚¬ìš©ìê°€ ì œê³µí•œ Firebase êµ¬ì„± (í™˜ê²½ ë³€ìˆ˜ê°€ ì—†ì„ ê²½ìš° ì‚¬ìš©ë  ëŒ€ì²´ êµ¬ì„±)
        const providedFirebaseConfig = {
            apiKey: "AIzaSyCgZL83YJIM0iXXRttTmoeyJvekBBkOhX4",
            authDomain: "k-chulnap.firebaseapp.com",
            projectId: "k-chulnap",
            storageBucket: "k-chulnap.firebasestorage.app",
            messagingSenderId: "169980642255",
            appId: "1:169980642255:web:572c781aa6b010de6e08ba",
            measurementId: "G-49GQLQ5HLC"
        };
        
        // í™˜ê²½ ë³€ìˆ˜ì—ì„œ êµ¬ì„±ì„ ë¡œë“œ
        const envFirebaseConfigString = typeof __firebase_config !== 'undefined' ? __firebase_config : '{}';
        const envFirebaseConfig = JSON.parse(envFirebaseConfigString);

        // í™˜ê²½ ë³€ìˆ˜ë¥¼ ë¨¼ì € ì‚¬ìš©í•˜ê³ , ì—†ìœ¼ë©´ ì œê³µëœ ì„¤ì •ì„ ì‚¬ìš©
        const firebaseConfig = Object.keys(envFirebaseConfig).length > 0 ? envFirebaseConfig : providedFirebaseConfig;

        // appIdëŠ” í™˜ê²½ ë³€ìˆ˜ë¥¼ ìš°ì„  ì‚¬ìš©í•˜ê³ , ì—†ìœ¼ë©´ firebaseConfigì˜ projectIdë¥¼ ì‚¬ìš©í•©ë‹ˆë‹¤.
        const appId = typeof __app_id !== 'undefined' ? __app_id : firebaseConfig.projectId;
        
        let app;
        let db;
        let auth; 

        // UI Elements
        const statusElement = document.getElementById('status-message');
        const loadingView = document.getElementById('loading-view');
        const errorView = document.getElementById('error-view');
        const errorMessageEl = document.getElementById('error-message');
        const reportContent = document.getElementById('report-content');
        const reportTitleEl = document.getElementById('report-month-year');
        const reportInfoEl = document.getElementById('report-info');
        const approveButton = document.getElementById('approve-button');
        const rejectButton = document.getElementById('reject-button'); // ìƒˆë¡œ ì¶”ê°€ë¨
        const approvalStatusDisplay = document.getElementById('approval-status-display');
        const approvalCommentInput = document.getElementById('approval-comment'); 
        const savedApprovalMessageEl = document.getElementById('saved-approval-message'); 
        
        // Summary Elements
        const incomeEl = document.getElementById('summary-income');
        const expenseEl = document.getElementById('summary-expense');
        const netBalanceEl = document.getElementById('summary-balance');
        const footerNetBalanceEl = document.getElementById('monthly-net-balance-footer');
        const listBody = document.getElementById('transaction-list-body');


        // Helper for Currency Formatting
        const formatCurrency = (amount) => {
            if (typeof amount !== 'number') return 'ï¿¦ 0';
            const sign = amount < 0 ? 'ï¿¦ -' : 'ï¿¦ ';
            return sign + Math.abs(amount).toLocaleString('ko-KR');
        };

        // Helper for Status Messages
        const setStatus = (message, isError = false) => {
            statusElement.innerHTML = `[ì‹œìŠ¤í…œ ìƒíƒœ]: ${isError ? 'ì˜¤ë¥˜: ' : ''}${message}`;
            if (isError) {
                statusElement.classList.add('error-status');
                console.error(message);
            } else {
                statusElement.classList.remove('error-status');
                console.log(message);
            }
        };

        // --- Initialization and Data Load (ìµëª… ì¸ì¦ ì¶”ê°€) ---
        async function initFirebase() {
            try {
                // 1. Firebase Config ìœ íš¨ì„± í™•ì¸
                if (!firebaseConfig || Object.keys(firebaseConfig).length === 0 || !firebaseConfig.apiKey) {
                    setStatus("Firebase ì„¤ì •ì´ ì˜¬ë°”ë¥´ì§€ ì•Šì•„ ì´ˆê¸°í™”í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. (ì„¤ì • ê°ì²´ ë¹„ì–´ìˆìŒ)", true);
                    return;
                }
                
                // 2. Firebase Appê³¼ Firestore ì´ˆê¸°í™”
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app); 

                // 3. ì¸ì¦ ë‹¨ê³„: ìµëª… ë¡œê·¸ì¸
                setStatus("Firebase ì´ˆê¸°í™” ì„±ê³µ. ë¶€ëª¨ë‹˜ í™•ì¸ì„ ìœ„í•´ ìµëª… ë¡œê·¸ì¸ ì¤‘...");
                await signInAnonymously(auth);

                setStatus("ìµëª… ë¡œê·¸ì¸ ì„±ê³µ. ê³µìœ  ë³´ê³ ì„œ ë¡œë“œë¥¼ ì‹œì‘í•©ë‹ˆë‹¤.");
                loadSharedReport();
                
            } catch (error) {
                console.error("Firebase ì´ˆê¸°í™” ë˜ëŠ” ìµëª… ë¡œê·¸ì¸ ì˜¤ë¥˜:", error);
                showError(`Firebase ì´ˆê¸°í™” ë˜ëŠ” ìµëª… ë¡œê·¸ì¸ ì‹¤íŒ¨. (${error.message})`);
            }
        }
        
        function showError(message) {
            loadingView.classList.add('hidden');
            reportContent.classList.add('hidden');
            errorView.classList.remove('hidden');
            errorMessageEl.textContent = message;
            setStatus(message, true);
        }

        // --- Main Logic: Load Shared Report ---

        // URLì—ì„œ shareIdë¥¼ ê°€ì ¸ì˜¤ëŠ” í•¨ìˆ˜
        function getShareIdFromUrl() {
            const params = new URLSearchParams(window.location.search);
            return params.get('shareId');
        }

        async function loadSharedReport() {
            const shareId = getShareIdFromUrl();

            if (!shareId) {
                reportInfoEl.textContent = "ê³µìœ  ID ì—†ìŒ";
                showError("URLì— ìœ íš¨í•œ 'shareId' ë§¤ê°œë³€ìˆ˜ê°€ í¬í•¨ë˜ì–´ ìˆì§€ ì•ŠìŠµë‹ˆë‹¤.");
                return;
            }
            
            reportInfoEl.textContent = `ê³µìœ  ID: ${shareId.substring(0, 8)}...`;

            try {
                // ê³µìš© ë°ì´í„° ê²½ë¡œ: artifacts/{appId}/public/data/sharedReports/{shareId}
                const docRef = doc(db, `artifacts/${appId}/public/data/sharedReports`, shareId);
                
                // Firestore ë°ì´í„° ë¡œë“œ
                const docSnap = await getDoc(docRef);

                if (docSnap.exists()) {
                    const reportData = docSnap.data();
                    renderReport(reportData, shareId);
                    setStatus("ê³µìœ  ë³´ê³ ì„œ ë¡œë“œ ì„±ê³µ.");
                } else {
                    showError(`í•´ë‹¹ ID (${shareId.substring(0, 8)}...)ì— í•´ë‹¹í•˜ëŠ” ê³µìœ  ë³´ê³ ì„œê°€ ì¡´ì¬í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤. URLì„ í™•ì¸í•˜ì„¸ìš”.`);
                }

            } catch (error) {
                console.error("ê³µìœ  ë³´ê³ ì„œ ë¡œë“œ ì˜¤ë¥˜:", error);
                // Firestore ê·œì¹™ ì˜¤ë¥˜ê°€ ë°œìƒí•˜ë©´ (Permission denied)ê°€ ëœ° ê²ƒì…ë‹ˆë‹¤.
                showError(`ë°ì´í„°ë² ì´ìŠ¤ ì ‘ê·¼ ì˜¤ë¥˜. (FireStore ê¶Œí•œ ë˜ëŠ” ë„¤íŠ¸ì›Œí¬ ë¬¸ì œ): ${error.message}`);
            }
        }

        // --- Action Logic (ìŠ¹ì¸/ë°˜ë ¤ í†µí•©) ---

        /**
         * ë¶€ëª¨ê°€ ë³´ê³ ì„œë¥¼ ìŠ¹ì¸í•˜ê±°ë‚˜ ë°˜ë ¤í•˜ê³  Firestore ë¬¸ì„œì— ìƒíƒœì™€ ì½”ë©˜íŠ¸ë¥¼ ì—…ë°ì´íŠ¸í•©ë‹ˆë‹¤.
         * @param {string} action - 'Approved' ë˜ëŠ” 'Rejected'
         */
        async function handleReportAction(action) {
            const shareId = getShareIdFromUrl();
            if (!shareId || !db || !auth.currentUser) {
                setStatus("ì•¡ì…˜ ì²˜ë¦¬ì— í•„ìš”í•œ ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤.", true);
                return;
            }
            
            const parentUserId = auth.currentUser.uid;
            const comment = approvalCommentInput.value.trim();
            
            // ë°˜ë ¤ ì‹œ ì½”ë©˜íŠ¸ í•„ìˆ˜ ìš”êµ¬ (ì„ íƒ ì‚¬í•­ìœ¼ë¡œ ë³€ê²½)
            // if (action === 'Rejected' && !comment) {
            //     setStatus("ë°˜ë ¤í•  ê²½ìš°, ìë…€ì—ê²Œ ì „ë‹¬í•  ì‚¬ìœ (ì½”ë©˜íŠ¸)ë¥¼ ë°˜ë“œì‹œ ì‘ì„±í•´ì£¼ì„¸ìš”.", true);
            //     return; 
            // }

            const actionText = action === 'Approved' ? 'ìŠ¹ì¸' : 'ë°˜ë ¤';
            const actionSymbol = action === 'Approved' ? 'âœ…' : 'âŒ';
            const defaultComment = action === 'Approved' ? 'í™•ì¸í–ˆìŠµë‹ˆë‹¤.' : 'ìˆ˜ì • í›„ ë‹¤ì‹œ ê³µìœ í•´ ì£¼ì„¸ìš”.';
            const commentToSave = comment || defaultComment;

            // Determine the button to update
            const targetButton = action === 'Approved' ? approveButton : rejectButton;
            const otherButton = action === 'Approved' ? rejectButton : approveButton;

            // Disable buttons and show loading
            approveButton.disabled = true;
            rejectButton.disabled = true;
            approvalCommentInput.disabled = true; 
            targetButton.textContent = 'ì²˜ë¦¬ ì¤‘...';
            setStatus(`ë³´ê³ ì„œ ${actionText} ì •ë³´ë¥¼ ë°ì´í„°ë² ì´ìŠ¤ì— ê¸°ë¡í•˜ëŠ” ì¤‘...`);
            
            try {
                const reportRef = doc(db, `artifacts/${appId}/public/data/sharedReports`, shareId);

                // 1. sharedReports ë¬¸ì„œ ì—…ë°ì´íŠ¸ (messages ì»¬ë ‰ì…˜ ê¸°ë¡ ì œê±°)
                await updateDoc(reportRef, {
                    status: action, // 'Approved' or 'Rejected'
                    approvedBy: parentUserId, // ìµëª… ë¡œê·¸ì¸ UID ê¸°ë¡
                    approvedAt: new Date().getTime(),
                    parentComment: commentToSave
                });

                // ì„±ê³µ ë©”ì‹œì§€ ë° UI ì—…ë°ì´íŠ¸
                const now = new Date().toLocaleString('ko-KR');
                const completionMessage = `ğŸ‰ ${actionText} ì™„ë£Œ: ${now}ì— ì²˜ë¦¬ë˜ì—ˆìŠµë‹ˆë‹¤.`;
                approvalStatusDisplay.textContent = completionMessage;
                approvalStatusDisplay.classList.remove('text-gray-700', 'text-green-700', 'text-red-700');
                approvalStatusDisplay.classList.add(action === 'Approved' ? 'text-green-700' : 'text-red-700');
                
                targetButton.textContent = `${actionSymbol} ${actionText} ì™„ë£Œë¨`;
                targetButton.disabled = true; 
                otherButton.style.display = 'none'; // ë‹¤ë¥¸ ë²„íŠ¼ ìˆ¨ê¸°ê¸°
                
                // ì €ì¥ëœ ì½”ë©˜íŠ¸ í‘œì‹œ
                savedApprovalMessageEl.innerHTML = `<strong>ë¶€ëª¨ë‹˜ ${actionText} ì½”ë©˜íŠ¸:</strong><br>${commentToSave}`;
                savedApprovalMessageEl.classList.remove('hidden');

                setStatus(completionMessage);

            } catch (error) {
                // ì—ëŸ¬ ë°œìƒ ì‹œ ë²„íŠ¼/ì…ë ¥ ë‹¤ì‹œ í™œì„±í™” ë° UI ë³µêµ¬
                approveButton.disabled = false;
                rejectButton.disabled = false;
                approvalCommentInput.disabled = false; 
                approveButton.textContent = 'âœ… í™•ì¸ ë° ìŠ¹ì¸';
                rejectButton.textContent = 'âŒ ë°˜ë ¤ (ìˆ˜ì • ìš”ì²­)';
                
                setStatus(`${actionText} ì‹¤íŒ¨: ${error.message}. Firestore ë³´ì•ˆ ê·œì¹™ì„ í™•ì¸í•˜ì„¸ìš”.`, true);
            }
        }


        // --- Report Rendering (Updated to display Rejected status) ---

        function renderReport(data, shareId) {
            loadingView.classList.add('hidden');
            reportContent.classList.remove('hidden');

            const month = data.month || 'ì•Œ ìˆ˜ ì—†ëŠ” ì›”';
            const year = month.substring(0, 4);
            const monthPart = month.substring(5, 7);
            const reportMonthName = `${year}ë…„ ${monthPart}ì›”`;
            
            reportTitleEl.textContent = reportMonthName;
            
            // 1. ìŠ¹ì¸/ë°˜ë ¤ ìƒíƒœ í™•ì¸ ë° UI ì—…ë°ì´íŠ¸
            if (data.status === 'Approved' || data.status === 'Rejected') {
                const actionText = data.status === 'Approved' ? 'ìŠ¹ì¸' : 'ë°˜ë ¤';
                const actionColor = data.status === 'Approved' ? 'text-green-700' : 'text-red-700';
                const actionSymbol = data.status === 'Approved' ? 'ğŸ‰' : 'âŒ';
                
                const approvedAtDate = new Date(data.approvedAt).toLocaleString('ko-KR');
                const parentComment = data.parentComment || 'ì½”ë©˜íŠ¸ ì—†ìŒ';

                approvalStatusDisplay.textContent = `${actionSymbol} ${actionText} ì™„ë£Œ: ${approvedAtDate}ì— ì²˜ë¦¬ë˜ì—ˆìŠµë‹ˆë‹¤.`;
                approvalStatusDisplay.classList.remove('text-gray-700', 'text-green-700', 'text-red-700');
                approvalStatusDisplay.classList.add(actionColor);
                
                // ë²„íŠ¼ ìˆ¨ê¸°ê¸° ë° ì…ë ¥ ë¹„í™œì„±í™”
                approveButton.style.display = 'none';
                rejectButton.style.display = 'none';

                approvalCommentInput.disabled = true; 
                
                // ì €ì¥ëœ ì½”ë©˜íŠ¸ í‘œì‹œ
                savedApprovalMessageEl.innerHTML = `<strong>ë¶€ëª¨ë‹˜ ${actionText} ì½”ë©˜íŠ¸:</strong><br>${parentComment}`;
                savedApprovalMessageEl.classList.remove('hidden');
                
            } else {
                 approvalStatusDisplay.textContent = 'ë³´ê³ ì„œ í™•ì¸ í›„, ì•„ë˜ ë²„íŠ¼ì„ ëˆŒëŸ¬ ìŠ¹ì¸/ë°˜ë ¤í•´ì£¼ì„¸ìš”.';
                 approvalStatusDisplay.classList.add('text-gray-700');
                 
                 // ë²„íŠ¼ ë³´ì´ê¸° ë° ì…ë ¥ í™œì„±í™”
                 approveButton.style.display = 'flex'; // flex-1ì´ ì ìš©ë˜ë„ë¡ flexë¡œ ë³€ê²½
                 rejectButton.style.display = 'flex';
                 
                 approveButton.disabled = false;
                 rejectButton.disabled = false;
                 approvalCommentInput.disabled = false; 
                 
                 savedApprovalMessageEl.classList.add('hidden'); // ë©”ì‹œì§€ ì˜ì—­ ìˆ¨ê¹€
            }


            // 2. ìš”ì•½ ì •ë³´ ì—…ë°ì´íŠ¸
            const summary = data.summary || { income: 0, expense: 0, netBalance: 0 };
            
            incomeEl.textContent = formatCurrency(summary.income);
            expenseEl.textContent = formatCurrency(summary.expense);
            netBalanceEl.textContent = formatCurrency(summary.netBalance);
            footerNetBalanceEl.textContent = summary.netBalance.toLocaleString('ko-KR');
            
            // 3. ìƒì„¸ ê±°ë˜ ë‚´ì—­ ì—…ë°ì´íŠ¸
            listBody.innerHTML = '';
            const transactions = data.transactions || [];
            
            if (transactions.length === 0) {
                listBody.innerHTML = `<tr class="data-row"><td colspan="5" class="p-4 text-center text-gray-500">ë“±ë¡ëœ ê±°ë˜ ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤.</td></tr>`;
                return;
            }

            // ë‚ ì§œ ìˆœì„œë¡œ ì •ë ¬ (ì›ë˜ ë³´ê³ ì„œì™€ ë™ì¼í•˜ê²Œ ìµœì‹ ìˆœ)
            transactions.sort((a, b) => {
                if (a.date === b.date) {
                    return b.timestamp - a.timestamp; 
                }
                return b.date.localeCompare(a.date); 
            });

            transactions.forEach((tx, index) => {
                const isIncome = tx.amount > 0;
                const rowClass = isIncome ? 'bg-green-50' : '';
                const amountClass = isIncome ? 'text-green-600' : 'text-red-600';
                const displayAmount = Math.abs(tx.amount).toLocaleString('ko-KR');

                const row = document.createElement('tr');
                row.className = `data-row hover:bg-gray-100 ${rowClass}`;
                row.innerHTML = `
                    <td class="text-center">${transactions.length - index}</td>
                    <td class="text-center">${tx.date}</td>
                    <td class="text-center">${tx.method}</td>
                    <td class="px-2">${tx.memo}</td>
                    <td class="text-right ${amountClass} font-bold pr-2">${isIncome ? '+' : ''}${displayAmount}</td>
                `;
                listBody.appendChild(row);
            });
        }

        // --- Event Listeners and Initialization ---
        document.addEventListener('DOMContentLoaded', () => {
            initFirebase();
            // ìŠ¹ì¸/ë°˜ë ¤ ì•¡ì…˜ì— ëŒ€í•œ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì—°ê²°
            approveButton.addEventListener('click', () => handleReportAction('Approved'));
            rejectButton.addEventListener('click', () => handleReportAction('Rejected'));
        });
    </script>
</body>
</html>
