<!DOCTYPE html>
<html lang="ko">
<head>
    <link rel="icon" type="image/png" href="/image/favicon.png">
    <meta name="naver-site-verification" content="aaafe41f7a0c71624b1fa0fe8913a0520113a2df" />
    <meta name="description" content="중학생을 위한 정보 플랫폼 Nmate! 급식표, 시간표, 학사일정, 커뮤니티까지 모두 한 곳에서 간편하게 확인하세요.">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>N-MATE | 학교생활</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>

    <style>
        /* CSS 변수를 사용하여 색상을 정의합니다. */
        :root {
            --bg-primary: #17171c; /* 업데이트된 배경색 */
            --bg-secondary: #201f27; /* 업데이트된 박스색 */
            --text-primary: #E0E0E0;
            --text-secondary: #A0A0A0;
            --color-blue: #007BFF;
            --border-color: #201f27; /* 박스색과 동일하게 설정 */
            --bg-hover: #33323a; /* 버튼 호버를 위해 약간 더 밝은 색으로 설정 */
        }
        
        /* wanted-sans 폰트를 로드합니다. */
        @import url('https://fastly.jsdelivr.dev/gh/wanteddev/wanted-sans@v1.0.1/packages/wanted-sans/fonts/webfonts/variable/split/WantedSansVariable.min.css');
        
        body {
            font-family: 'WantedSansVariable', sans-serif;
            background-color: var(--bg-primary);
            color: var(--text-primary);
            padding-bottom: 5rem;
            /* 애니메이션이 부드럽게 시작되도록 초기 상태 설정 */
            opacity: 0;
            transition: opacity 0.5s ease-in-out;
        }

        body.loaded {
            opacity: 1;
        }

        /* 스크롤바 숨기기 */
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        
        /* 헤더 스타일을 항상 고정된 작은 크기로 변경 */
        .header-fixed {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 50;
            background-color: rgba(23, 23, 28, 0.8);
            backdrop-filter: blur(8px);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }

        .nav-inner { width: 100%; }
        @media (min-width: 768px) { .nav-inner { max-width: 768px; margin-left: auto; margin-right: auto; } }

        .invert-icon { filter: invert(1); }
        
        /* 하단 네비게이션 스타일 */
        .nav-bottom {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            z-index: 50;
            background-color: var(--bg-primary);
            box-shadow: 0 -4px 6px -1px rgba(0, 0, 0, 0.1);
            padding: 0.5rem 0;
        }

        /* 탭 버튼 활성화 스타일 */
        .tab-button.active {
            background-color: var(--color-blue);
            color: white;
            font-weight: 500;
        }

        /* 새로운 애니메이션 정의 */
        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        @keyframes fadeIn {
            from {
                opacity: 0;
            }
            to {
                opacity: 1;
            }
        }
        
        /* 개별 요소에 애니메이션 적용 */
        .animate-fadeInUp {
            animation: fadeInUp 0.6s ease-out forwards;
            opacity: 0;
        }
        .animate-fadeIn {
            animation: fadeIn 0.6s ease-out forwards;
            opacity: 0;
        }
    </style>
    <!-- Firebase SDK Scripts -->
    <script type="module" src="firebase-config.js"></script>
</head>
<body class="bg-[--bg-primary] text-white">

    <!-- 헤더 섹션: 항상 고정된 작은 크기로 변경 -->
    <header id="main-header" class="header-fixed animate-fadeIn" style="animation-delay: 0.1s;">
        <div class="header-inner container mx-auto max-w-screen-md px-4 md:px-8 py-2 flex items-center justify-between">
            <div class="flex items-center">
                <img src="https://i.postimg.cc/XvKJktcP/001-2025-08-01-T220040-650.png" alt="hanilians 로고" class="h-8 md:h-8 w-auto">
            </div>
            <div id="auth-ui-container" class="flex items-center space-x-2">
                <!-- JavaScript로 로그인 버튼 또는 사용자 프로필이 여기에 동적으로 추가됩니다 -->
            </div>
        </div>
    </header>

    <!-- 메인 컨테이너 -->
    <div class="container mx-auto px-4 md:px-8 max-w-screen-md pt-24 md:pt-28 pb-20">
        <h1 class="text-3xl font-bold mb-6 animate-fadeInUp" style="animation-delay: 0.1s;">학교생활</h1>

        <!-- 탭 콘텐츠 영역 -->
        <div id="tab-content" class="animate-fadeInUp" style="animation-delay: 0.3s;">
            <!-- 급식 탭 콘텐츠 -->
            <div id="meal-tab" data-content="meal">
                <div id="meal-date-container" class="flex items-center justify-between bg-[--bg-secondary] p-3 rounded-xl mb-4">
                    <button id="prevDayButton" class="p-2 rounded-full text-white hover:bg-[--bg-hover] transition-colors duration-200">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-chevron-left"><path d="m15 18-6-6 6-6"/></svg>
                    </button>
                    <span id="mealDateDisplay" class="font-medium text-base text-white"></span>
                    <button id="nextDayButton" class="p-2 rounded-full text-white hover:bg-[--bg-hover] transition-colors duration-200">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-chevron-right"><path d="m9 18 6-6-6-6"/></svg>
                    </button>
                </div>
                <div id="meal-content-area" class="bg-[--bg-secondary] p-4 rounded-xl min-h-[15rem] flex items-center justify-center text-[--text-secondary]">
                    <p>급식 정보가 없습니다. 학교와 학년을 설정해 주세요.</p>
                </div>
            </div>

            <!-- 시간표 탭 콘텐츠 -->
            <div id="timetable-tab" data-content="timetable" class="hidden">
                <div class="flex items-center justify-between mb-4">
                    <h2 class="text-xl font-bold">주간 시간표</h2>
                    <div class="flex items-center ml-2">
                        <span id="currentWeekDisplay" class="text-sm text-[--text-secondary] mr-2"></span>
                        <button id="prevWeekButton" class="p-2 rounded-full text-white hover:bg-[--bg-hover] transition-colors duration-200">
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-chevron-left"><path d="m15 18-6-6 6-6"/></svg>
                        </button>
                        <button id="nextWeekButton" class="p-2 rounded-full text-white hover:bg-[--bg-hover] transition-colors duration-200">
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucude-chevron-right"><path d="m9 18 6-6-6-6"/></svg>
                        </button>
                    </div>
                </div>
                <div id="timetable-content-area" class="bg-[--bg-secondary] rounded-xl overflow-hidden shadow-lg">
                    <div class="animate-pulse grid grid-cols-6 text-center text-sm font-medium timetable-grid overflow-x-auto no-scrollbar">
                        <div class="grid-cell-day min-w-[50px] md:min-w-0">교시</div>
                        <div class="grid-cell-day min-w-[100px] md:min-w-0">월</div>
                        <div class="grid-cell-day min-w-[100px] md:min-w-0">화</div>
                        <div class="grid-cell-day min-w-[100px] md:min-w-0">수</div>
                        <div class="grid-cell-day min-w-[100px] md:min-w-0">목</div>
                        <div class="grid-cell-day min-w-[100px] md:min-w-0">금</div>
                        <div class="grid-cell-hour min-w-[50px] md:min-w-0">1</div><div class="grid-cell min-w-[100px] md:min-w-0"></div><div class="grid-cell min-w-[100px] md:min-w-0"></div><div class="grid-cell min-w-[100px] md:min-w-0"></div><div class="grid-cell min-w-[100px] md:min-w-0"></div><div class="grid-cell min-w-[100px] md:min-w-0"></div>
                        <div class="grid-cell-hour min-w-[50px] md:min-w-0">2</div><div class="grid-cell min-w-[100px] md:min-w-0"></div><div class="grid-cell min-w-[100px] md:min-w-0"></div><div class="grid-cell min-w-[100px] md:min-w-0"></div><div class="grid-cell min-w-[100px] md:min-w-0"></div><div class="grid-cell min-w-[100px] md:min-w-0"></div>
                        <div class="grid-cell-hour min-w-[50px] md:min-w-0">3</div><div class="grid-cell min-w-[100px] md:min-w-0"></div><div class="grid-cell min-w-[100px] md:min-w-0"></div><div class="grid-cell min-w-[100px] md:min-w-0"></div><div class="grid-cell min-w-[100px] md:min-w-0"></div><div class="grid-cell min-w-[100px] md:min-w-0"></div>
                        <div class="grid-cell-hour min-w-[50px] md:min-w-0">4</div><div class="grid-cell min-w-[100px] md:min-w-0"></div><div class="grid-cell min-w-[100px] md:min-w-0"></div><div class="grid-cell min-w-[100px] md:min-w-0"></div><div class="grid-cell min-w-[100px] md:min-w-0"></div><div class="grid-cell min-w-[100px] md:min-w-0"></div>
                        <div class="grid-cell-hour min-w-[50px] md:min-w-0">5</div><div class="grid-cell min-w-[100px] md:min-w-0"></div><div class="grid-cell min-w-[100px] md:min-w-0"></div><div class="grid-cell min-w-[100px] md:min-w-0"></div><div class="grid-cell min-w-[100px] md:min-w-0"></div><div class="grid-cell min-w-[100px] md:min-w-0"></div>
                        <div class="grid-cell-hour min-w-[50px] md:min-w-0">6</div><div class="grid-cell min-w-[100px] md:min-w-0"></div><div class="grid-cell min-w-[100px] md:min-w-0"></div><div class="grid-cell min-w-[100px] md:min-w-0"></div><div class="grid-cell min-w-[100px] md:min-w-0"></div><div class="grid-cell min-w-[100px] md:min-w-0"></div>
                        <div class="grid-cell-hour min-w-[50px] md:min-w-0">7</div><div class="grid-cell min-w-[100px] md:min-w-0"></div><div class="grid-cell min-w-[100px] md:min-w-0"></div><div class="grid-cell min-w-[100px] md:min-w-0"></div><div class="grid-cell min-w-[100px] md:min-w-0"></div><div class="grid-cell min-w-[100px] md:min-w-0"></div>
                    </div>
                </div>
            </div>

            <!-- 학사일정 탭 콘텐츠 -->
            <div id="schedule-tab" data-content="schedule" class="hidden">
                <div id="schedule-month-container" class="flex items-center justify-between bg-[--bg-secondary] p-3 rounded-xl mb-4">
                    <button id="prevMonthButton" class="p-2 rounded-full text-white hover:bg-[--bg-hover] transition-colors duration-200">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-chevron-left"><path d="m15 18-6-6 6-6"/></svg>
                    </button>
                    <span id="currentMonthDisplay" class="font-medium text-base text-white"></span>
                    <button id="nextMonthButton" class="p-2 rounded-full text-white hover:bg-[--bg-hover] transition-colors duration-200">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucude-chevron-right"><path d="m9 18 6-6-6-6"/></svg>
                    </button>
                </div>
                <div id="schedule-content-area" class="bg-[--bg-secondary] p-4 rounded-xl min-h-[15rem] flex items-center justify-center text-[--text-secondary]">
                    <p>학사일정 정보가 없습니다. 학교와 학년을 설정해 주세요.</p>
                </div>
            </div>
        </div>
    </div>

    <!-- 하단 네비게이션바 -->
    <nav class="nav-bottom animate-fadeInUp" style="animation-delay: 0.2s;">
        <div class="nav-inner flex justify-around items-center">
            <a href="index-1.html" class="flex flex-col items-center p-2 rounded-xl text-[--text-secondary] transition-colors duration-200 hover:text-white">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-home"><path d="m3 9 9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg>
                <span class="text-xs mt-1">홈</span>
            </a>
            <a href="#" class="flex flex-col items-center p-2 rounded-xl text-white transition-colors duration-200 hover:text-white">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-school"><path d="M14 22v-4a2 2 0 1 0-4 0v4"/><path d="m18 10 4 2v8a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2v-8l4-2"/><path d="M18 10V6.5a2.5 2.5 0 0 0-5 0V10"/><path d="M6 10V6.5a2.5 2.5 0 0 1 5 0V10"/><path d="M12 15h.01"/></svg>
                <span class="text-xs mt-1">학교생활</span>
            </a>
            <a href="#" class="flex flex-col items-center p-2 rounded-xl text-[--text-secondary] transition-colors duration-200 hover:text-white">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-message-square"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></svg>
                <span class="text-xs mt-1">커뮤니티</span>
            </a>
            <a href="#" class="flex flex-col items-center p-2 rounded-xl text-[--text-secondary] transition-colors duration-200 hover:text-white">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-user"><path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>
                <span class="text-xs mt-1">MY</span>
            </a>
        </div>
    </nav>

    <!-- 기존 스크립트 -->
    <script>
        // DOM 요소 가져오기
        const mealContentArea = document.getElementById('meal-content-area');
        const timetableContentArea = document.getElementById('timetable-content-area');
        const scheduleContentArea = document.getElementById('schedule-content-area');

        const mealDateDisplay = document.getElementById('mealDateDisplay');
        const currentWeekDisplay = document.getElementById('currentWeekDisplay');
        const currentMonthDisplay = document.getElementById('currentMonthDisplay');

        const prevDayButton = document.getElementById('prevDayButton');
        const nextDayButton = document.getElementById('nextDayButton');
        const prevWeekButton = document.getElementById('prevWeekButton');
        const nextWeekButton = document.getElementById('nextWeekButton');
        const prevMonthButton = document.getElementById('prevMonthButton');
        const nextMonthButton = document.getElementById('nextMonthButton');
        
        // 탭 버튼 및 탭 콘텐츠 요소 가져오기
        const tabButtons = document.querySelectorAll('.tab-button');
        const tabContents = document.querySelectorAll('[data-content]');
        
        let currentMealDate = new Date();
        let currentTimetableMonday = new Date();
        let currentScheduleMonth = new Date();
        let userProfile = null;
        let activeTab = 'meal';

        // Helper function to format date
        const formatDate = (date) => {
            const year = date.getFullYear();
            const month = (date.getMonth() + 1).toString().padStart(2, '0');
            const day = date.getDate().toString().padStart(2, '0');
            const dayOfWeek = ['일', '월', '화', '수', '목', '금', '토'][date.getDay()];
            return { year, month, day, dayOfWeek, fullDate: `${year}.${month}.${day}` };
        };

        // Helper function to get the Monday of the current week
        const getMonday = (date) => {
            date = new Date(date);
            const day = date.getDay();
            const diff = date.getDate() - day + (day === 0 ? -6 : 1);
            return new Date(date.setDate(diff));
        };
        
        // 초기 로딩 시 오늘 날짜의 급식 데이터 가져오기 및 표시
        const fetchMealData = async (date, schulCode, atptOfcdcScCode, contentArea, dateDisplay) => {
            const { year, month, day, dayOfWeek } = formatDate(date);
            dateDisplay.textContent = `${year}년 ${parseInt(month, 10)}월 ${parseInt(day, 10)}일 (${dayOfWeek})`;
            contentArea.innerHTML = `<p>급식 정보를 불러오는 중...</p>`;
            
            try {
                const response = await fetch(`https://open.neis.go.kr/hub/mealServiceDietInfo?KEY=76e3391b1a7d4a259c11874917416301&Type=json&ATPT_OFCDC_SC_CODE=${atptOfcdcScCode}&SD_SCHUL_CODE=${schulCode}&MLSV_YMD=${year}${month}${day}`);
                const data = await response.json();
                
                if (data.mealServiceDietInfo && data.mealServiceDietInfo[1].row.length > 0) {
                    const mealInfo = data.mealServiceDietInfo[1].row[0];
                    let meal = mealInfo.DDISH_NM.replace(/<br\/>/g, ', ');
                    meal = meal.replace(/\(\d{1,2}\.?\)/g, '').replace(/,/g, '<br>');
                    
                    let cal = mealInfo.CAL_INFO;
                    if (cal) {
                        cal = cal.replace('Kcal', 'kcal');
                    } else {
                        cal = '칼로리 정보 없음';
                    }

                    const origin = mealInfo.ORGN_INFO;
                    const originHtml = origin ? origin.replace(/<br\/>/g, ', ').split(', ').map(item => `<p class="text-sm text-[--text-secondary]">${item}</p>`).join('') : '';

                    contentArea.innerHTML = `
                        <div class="space-y-4 w-full">
                            <div>
                                <h3 class="text-lg font-bold">${mealInfo.MMEAL_SC_NM}</h3>
                                <p class="text-white mt-2 leading-relaxed">${meal}</p>
                            </div>
                            <div>
                                <p class="text-sm font-bold text-[--text-secondary] mb-2">영양정보</p>
                                <p class="text-sm text-white">${cal}</p>
                            </div>
                            <div>
                                <p class="text-sm font-bold text-[--text-secondary] mb-2">원산지</p>
                                ${originHtml}
                            </div>
                        </div>
                    `;
                } else {
                    contentArea.innerHTML = `<p>해당 날짜에 급식 정보가 없습니다.</p>`;
                }
            } catch (error) {
                console.error('Error fetching meal data:', error);
                contentArea.innerHTML = `<p>급식 정보를 불러오는 중 오류가 발생했습니다.</p>`;
            }
        };

        // 주간 시간표 데이터 가져오기 및 표시
        const fetchAndRenderWeeklyTimetable = async (monday, schulCode, grade, classNum, atptOfcdcScCode, contentArea, weekDisplay) => {
            const { year, month, day } = formatDate(monday);
            const { year: endYear, month: endMonth, day: endDay } = formatDate(new Date(monday).setDate(monday.getDate() + 4));
            
            weekDisplay.textContent = `${year}년 ${parseInt(month, 10)}월 ${parseInt(day, 10)}일 ~ ${parseInt(endMonth, 10)}월 ${parseInt(endDay, 10)}일`;
            contentArea.innerHTML = `<p>시간표를 불러오는 중...</p>`;

            try {
                const response = await fetch(`https://open.neis.go.kr/hub/hisTimetable?KEY=76e3391b1a7d4a259c11874917416301&Type=json&ATPT_OFCDC_SC_CODE=${atptOfcdcScCode}&SD_SCHUL_CODE=${schulCode}&GRADE=${grade}&CLASS_NM=${classNum}&TI_FROM_YMD=${year}${month}${day}&TI_TO_YMD=${endYear}${endMonth}${endDay}`);
                const data = await response.json();

                const timetableGrid = document.createElement('div');
                timetableGrid.className = 'grid grid-cols-6 text-center text-sm font-medium timetable-grid overflow-x-auto no-scrollbar';

                const days = ['월', '화', '수', '목', '금'];
                timetableGrid.innerHTML = `
                    <div class="grid-cell-day min-w-[50px] md:min-w-0">교시</div>
                    ${days.map(day => `<div class="grid-cell-day min-w-[100px] md:min-w-0">${day}</div>`).join('')}
                `;

                const periods = Array.from({ length: 7 }, (_, i) => i + 1);
                
                // 시간표 데이터 구조화
                const structuredTimetable = {};
                if (data.hisTimetable && data.hisTimetable[1].row) {
                    data.hisTimetable[1].row.forEach(item => {
                        const day = parseInt(item.ALL_TI_YMD.slice(-1), 10); // '20231120' -> 20 (월요일)
                        const period = parseInt(item.PERIO, 10);
                        const subject = item.ITRT_CNTNT;
                        
                        if (!structuredTimetable[period]) {
                            structuredTimetable[period] = {};
                        }
                        structuredTimetable[period][day] = subject;
                    });
                }
                
                // 시간표 그리드 렌더링
                periods.forEach(period => {
                    timetableGrid.innerHTML += `<div class="grid-cell-hour min-w-[50px] md:min-w-0">${period}</div>`;
                    for (let i = 1; i <= 5; i++) {
                        const dayData = structuredTimetable[period] ? structuredTimetable[period][i] : '';
                        timetableGrid.innerHTML += `<div class="grid-cell min-w-[100px] md:min-w-0">${dayData || ''}</div>`;
                    }
                });

                contentArea.innerHTML = '';
                contentArea.appendChild(timetableGrid);

                if (!data.hisTimetable) {
                    contentArea.innerHTML = `<p>해당 주간에 시간표 정보가 없습니다.</p>`;
                }
                
            } catch (error) {
                console.error('Error fetching timetable data:', error);
                contentArea.innerHTML = `<p>시간표를 불러오는 중 오류가 발생했습니다.</p>`;
            }
        };

        // 월간 학사일정 데이터 가져오기 및 표시
        const fetchAndRenderMonthlySchedule = async (date, schulCode, atptOfcdcScCode, contentArea, monthDisplay) => {
            const { year, month } = formatDate(date);
            monthDisplay.textContent = `${year}년 ${parseInt(month, 10)}월`;
            contentArea.innerHTML = `<p>학사일정을 불러오는 중...</p>`;

            try {
                const response = await fetch(`https://open.neis.go.kr/hub/SchoolSchedule?KEY=76e3391b1a7d4a259c11874917416301&Type=json&ATPT_OFCDC_SC_CODE=${atptOfcdcScCode}&SD_SCHUL_CODE=${schulCode}&AA_FROM_YMD=${year}${month}01&AA_TO_YMD=${year}${month}31`);
                const data = await response.json();

                if (data.SchoolSchedule && data.SchoolSchedule[1].row) {
                    const schedules = data.SchoolSchedule[1].row;
                    const sortedSchedules = schedules.sort((a, b) => parseInt(a.AA_YMD) - parseInt(b.AA_YMD));
                    
                    let scheduleHtml = sortedSchedules.map(schedule => {
                        const date = schedule.AA_YMD;
                        const day = date.slice(-2);
                        const event = schedule.EVENT_NM;
                        return `
                            <div class="flex items-start mb-4">
                                <div class="w-10 text-center flex-shrink-0">
                                    <span class="text-xl font-bold">${day}</span>
                                </div>
                                <div class="ml-4">
                                    <p class="text-white font-medium">${event}</p>
                                </div>
                            </div>
                        `;
                    }).join('');
                    
                    contentArea.innerHTML = `<div class="p-4 space-y-4">${scheduleHtml}</div>`;
                } else {
                    contentArea.innerHTML = `<p>해당 월에 학사일정 정보가 없습니다.</p>`;
                }
            } catch (error) {
                console.error('Error fetching schedule data:', error);
                contentArea.innerHTML = `<p>학사일정을 불러오는 중 오류가 발생했습니다.</p>`;
            }
        };
        
        // 로그인 상태에 따른 UI 변경
        const showLoginRequiredState = () => {
            mealContentArea.innerHTML = `<p>학교생활 정보를 보려면 로그인해 주세요.</p>`;
            timetableContentArea.innerHTML = `<p>학교생활 정보를 보려면 로그인해 주세요.</p>`;
            scheduleContentArea.innerHTML = `<p>학교생활 정보를 보려면 로그인해 주세요.</p>`;
        };

        // 탭 전환 함수
        const switchTab = (tabName) => {
            // 모든 탭 버튼에서 'active' 클래스 제거
            tabButtons.forEach(button => button.classList.remove('active', 'bg-[--color-blue]', 'text-white', 'hover:bg-[--bg-hover]'));
            tabButtons.forEach(button => button.classList.add('text-[--text-secondary]', 'hover:bg-[--bg-hover]'));

            // 모든 탭 콘텐츠 숨기기
            tabContents.forEach(content => content.classList.add('hidden'));

            // 선택된 탭 활성화
            const selectedTabButton = document.querySelector(`[data-tab="${tabName}"]`);
            if (selectedTabButton) {
                selectedTabButton.classList.remove('text-[--text-secondary]', 'hover:bg-[--bg-hover]');
                selectedTabButton.classList.add('active', 'bg-[--color-blue]', 'text-white');
            }
            const selectedTabContent = document.getElementById(`${tabName}-tab`);
            if (selectedTabContent) {
                selectedTabContent.classList.remove('hidden');
            }
            
            activeTab = tabName;

            // 탭 변경 시 데이터 새로고침
            if (userProfile) {
                if (activeTab === 'meal') {
                    fetchMealData(currentMealDate, userProfile.sdSchulCode, userProfile.atptOfcdcScCode, mealContentArea, mealDateDisplay);
                } else if (activeTab === 'timetable' && userProfile.grade && userProfile.classNum) {
                    currentTimetableMonday = getMonday(new Date());
                    fetchAndRenderWeeklyTimetable(currentTimetableMonday, userProfile.sdSchulCode, userProfile.grade, userProfile.classNum, userProfile.atptOfcdcScCode, timetableContentArea, currentWeekDisplay);
                } else if (activeTab === 'schedule') {
                    currentScheduleMonth = new Date();
                    fetchAndRenderMonthlySchedule(currentScheduleMonth, userProfile.sdSchulCode, userProfile.atptOfcdcScCode, scheduleContentArea, currentMonthDisplay);
                }
            } else {
                showLoginRequiredState();
            }
        };

        // 탭 버튼 클릭 이벤트
        tabButtons.forEach(button => {
            button.addEventListener('click', () => {
                const tabName = button.getAttribute('data-tab');
                switchTab(tabName);
            });
        });

        // 네비게이션 버튼 이벤트 리스너
        prevDayButton.addEventListener('click', () => {
            currentMealDate.setDate(currentMealDate.getDate() - 1);
            if (userProfile) {
                fetchMealData(currentMealDate, userProfile.sdSchulCode, userProfile.atptOfcdcScCode, mealContentArea, mealDateDisplay);
            }
        });

        nextDayButton.addEventListener('click', () => {
            currentMealDate.setDate(currentMealDate.getDate() + 1);
            if (userProfile) {
                fetchMealData(currentMealDate, userProfile.sdSchulCode, userProfile.atptOfcdcScCode, mealContentArea, mealDateDisplay);
            }
        });
        
        prevWeekButton.addEventListener('click', () => {
            currentTimetableMonday.setDate(currentTimetableMonday.getDate() - 7);
            if (userProfile && userProfile.grade && userProfile.classNum) {
                fetchAndRenderWeeklyTimetable(currentTimetableMonday, userProfile.sdSchulCode, userProfile.grade, userProfile.classNum, userProfile.atptOfcdcScCode, timetableContentArea, currentWeekDisplay);
            }
        });

        nextWeekButton.addEventListener('click', () => {
            currentTimetableMonday.setDate(currentTimetableMonday.getDate() + 7);
            if (userProfile && userProfile.grade && userProfile.classNum) {
                fetchAndRenderWeeklyTimetable(currentTimetableMonday, userProfile.sdSchulCode, userProfile.grade, userProfile.classNum, userProfile.atptOfcdcScCode, timetableContentArea, currentWeekDisplay);
            }
        });

        prevMonthButton.addEventListener('click', () => {
            currentScheduleMonth.setMonth(currentScheduleMonth.getMonth() - 1);
            if (userProfile) {
                fetchAndRenderMonthlySchedule(currentScheduleMonth, userProfile.sdSchulCode, userProfile.atptOfcdcScCode, scheduleContentArea, currentMonthDisplay);
            }
        });

        nextMonthButton.addEventListener('click', () => {
            currentScheduleMonth.setMonth(currentScheduleMonth.getMonth() + 1);
            if (userProfile) {
                fetchAndRenderMonthlySchedule(currentScheduleMonth, userProfile.sdSchulCode, userProfile.atptOfcdcScCode, scheduleContentArea, currentMonthDisplay);
            }
        });

        // 유저 프로필 가져오기
        const fetchUserProfile = async (uid) => {
            const userDocRef = window.doc(window.db, "userProfiles", uid);
            try {
                const userDocSnap = await window.getDoc(userDocRef);
                if (userDocSnap.exists()) {
                    return userDocSnap.data();
                } else {
                    return null;
                }
            } catch (error) {
                console.error("Error fetching user profile:", error);
                return null;
            }
        };

        // 인증 상태 변경 리스너
        window.addEventListener('load', () => {
            window.onAuthStateChanged(window.auth, async (user) => {
                if (user) {
                    userProfile = await fetchUserProfile(user.uid);
                    if (userProfile) {
                        // 로그인 후 프로필 데이터 로드 성공
                        if (activeTab === 'meal') {
                            fetchMealData(currentMealDate, userProfile.sdSchulCode, userProfile.atptOfcdcScCode, mealContentArea, mealDateDisplay);
                        } else if (activeTab === 'timetable' && userProfile.grade && userProfile.classNum) {
                            currentTimetableMonday = getMonday(new Date());
                            fetchAndRenderWeeklyTimetable(currentTimetableMonday, userProfile.sdSchulCode, userProfile.grade, userProfile.classNum, userProfile.atptOfcdcScCode, timetableContentArea, currentWeekDisplay);
                        } else if (activeTab === 'schedule') {
                            currentScheduleMonth = new Date();
                            fetchAndRenderMonthlySchedule(currentScheduleMonth, userProfile.sdSchulCode, userProfile.atptOfcdcScCode, scheduleContentArea, currentMonthDisplay);
                        }
                    } else {
                        // 프로필 데이터가 없는 경우
                        showLoginRequiredState();
                    }
                } else {
                    // 로그아웃 상태
                    userProfile = null;
                    showLoginRequiredState();
                }
            });
            document.body.classList.add('loaded');
            // 초기 탭 활성화 (meal)
            switchTab('meal');
        });
    </script>
</body>
</html>
