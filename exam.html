<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>시험지 에디터 (이미지 링크 추가)</title>
    
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-kopub@1.0">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200" />

    <style>
        /* =========================================
           1. 기본 설정
           ========================================= */
        :root { 
            --editor-bg: #2d3436; 
            --accent-color: #1a3c6e; 
            --main-font: 'KoPub Batang', serif;
        }
        body { margin: 0; padding: 0; height: 100vh; overflow: hidden; display: flex; flex-direction: column; background: #333; }
        * { box-sizing: border-box; -webkit-print-color-adjust: exact; }

        .font-dotum { font-family: 'KoPub Dotum', sans-serif !important; }
        .font-batang { font-family: 'KoPub Batang', serif !important; }

        /* 스타일 클래스 */
        .u-text { text-decoration: underline; text-underline-position: under; text-decoration-thickness: 1px; text-underline-offset: 2px; }
        .u-blank-inline { display: inline-block; border-bottom: 1px solid #000; text-align: center; min-width: 30px; padding: 0 5px; font-family: 'KoPub Dotum'; font-weight: bold; }

        /* [추가] 인라인 이미지 스타일 */
        .inline-img-box { display: block; text-align: center; margin: 10px 0; }
        .inline-img-box img { max-width: 98%; height: auto; border: 1px solid #eee; }

        /* 툴바 */
        .toolbar { background: #fff; padding: 5px 15px; border-bottom: 1px solid #ccc; display: flex; justify-content: space-between; align-items: center; height: 60px; gap: 10px; }
        .toolbar-group { display: flex; gap: 5px; align-items: center; border-right: 1px solid #ddd; padding-right: 10px; }
        .toolbar-group:last-child { border-right: none; }
        
        button { padding: 6px 10px; border: 1px solid #ccc; background: #f8f9fa; border-radius: 4px; cursor: pointer; font-size: 13px; font-weight: bold; display: flex; align-items: center; gap: 4px; white-space: nowrap; }
        button:hover { background: #e9ecef; }
        .btn-primary { background-color: var(--accent-color); color: white; border: none; }
        .btn-primary:hover { background-color: #132d52; }

        .workspace { display: flex; flex: 1; height: calc(100vh - 60px); }
        .editor-pane { width: 35%; background: var(--editor-bg); display: flex; flex-direction: column; border-right: 1px solid #555; }
        textarea#codeInput { flex: 1; width: 100%; background: transparent; color: #f1f2f6; border: none; padding: 20px; font-family: 'Consolas', monospace; font-size: 14px; line-height: 1.6; resize: none; outline: none; }
        
        .preview-pane { width: 65%; background: #555; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; align-items: center; }

        /* =========================================
           2. 시험지 레이아웃
           ========================================= */
        .page-container {
            width: 210mm; min-height: 297mm; background: white; 
            padding: 0; margin-bottom: 20px; 
            box-shadow: 0 0 15px rgba(0,0,0,0.3);
            font-family: var(--main-font); color: #111; line-height: 1.5;
            break-after: always; position: relative; overflow: hidden;
        }

        .exam-header {
            width: 100%; border-top: 4px solid var(--accent-color); border-bottom: 1px solid #aaa;
            padding: 10px 10mm; margin-bottom: 15px; 
            display: flex; justify-content: space-between; align-items: flex-end;
            font-family: 'KoPub Dotum', sans-serif;
        }
        .h-title { font-size: 16pt; font-weight: 800; color: var(--accent-color); letter-spacing: -1px; width: 70%; }
        .h-info { font-size: 10pt; color: #444; text-align: right; width: 30%; font-weight: bold; }

        .exam-body-content { 
            width: 100%; padding: 0 7mm; 
            column-count: 2; column-gap: 8mm; column-rule: 0.5px solid #ccc; 
            text-align: justify; height: 940px; overflow: hidden; 
        }
        .exam-footer { position: absolute; bottom: 10mm; left: 0; width: 100%; text-align: center; font-family: 'KoPub Dotum'; font-size: 10pt; color: #666; }

        /* =========================================
           3. 인쇄 설정
           ========================================= */
        @media print {
            .toolbar, .editor-pane { display: none !important; }
            body, html { margin: 0; padding: 0; width: 100%; height: 100%; background: #fff; }
            .workspace, .preview-pane { display: block; padding: 0; margin: 0; background: #fff; width: 100%; height: auto; }
            @page { margin: 0; size: A4; } 
            .page-container {
                width: 100% !important; height: 297mm !important;
                margin: 0 !important; padding: 0 !important;
                box-shadow: none; border: none;
                break-after: page; page-break-after: always;
            }
            .exam-body-content { display: block; column-fill: auto; height: 250mm !important; max-height: 250mm !important; overflow: hidden; }
            .exam-footer { bottom: 10mm !important; }
        }

        /* =========================================
           4. 컴포넌트 스타일
           ========================================= */
        .question-block-wrapper { margin-bottom: 15px; break-inside: avoid; width: 100%; display: inline-block; }
        
        .guide-box {
            width: 100%; margin-bottom: 8px; padding-bottom: 5px;
            font-family: 'KoPub Dotum'; font-size: 11pt; font-weight: bold; color: #222;
            border-bottom: 2px solid #eee; line-height: 1.3;
        }
        .guide-num { color: var(--accent-color); font-weight: 900; margin-right: 6px; font-size: 12pt; }

        .layout-row { display: flex; align-items: flex-start; width: 100%; margin-bottom: 5px; }
        .col-num { flex-shrink: 0; width: 50px; text-align: right; padding-right: 8px; font-family: 'KoPub Dotum'; font-size: 14pt; font-weight: 900; color: var(--accent-color); line-height: 1.2; letter-spacing: -0.5px; }
        .col-content { flex-grow: 1; width: calc(100% - 50px); font-size: 10.5pt; color: #000; }

        .q-text { font-family: 'KoPub Dotum'; font-weight: bold; margin-bottom: 6px; line-height: 1.4; word-break: keep-all; }
        .common-box { width: 100%; border: 1px solid #000; padding: 8px 10px; font-size: 9.5pt; text-align: justify; margin-bottom: 8px; line-height: 1.6; }
        .bogi-box { width: 100%; border: 1px solid #000; padding: 5px 10px 10px 10px; font-size: 9.5pt; text-align: justify; margin-bottom: 8px; line-height: 1.6; position: relative; }
        .bogi-title { text-align: center; font-family: 'KoPub Dotum'; font-weight: bold; margin-bottom: 5px; display: block; }
        
        .choices { list-style: none; padding: 0; margin: 0; width: 100%; font-family: 'KoPub Dotum'; font-size: 10.2pt; }
        .choices li { margin-bottom: 3px; padding-left: 10px; text-indent: -10px; margin-left: 5px; }

        table.custom-table { width: 100%; border-collapse: collapse; margin: 5px 0 15px 0; font-family: 'KoPub Dotum'; font-size: 9pt; table-layout: fixed; }
        table.custom-table th, table.custom-table td { border: 1px solid #333; padding: 5px; text-align: center; }
        table.custom-table th { background-color: #f7f7f7; font-weight: bold; }

        .subjective-line { display: block; width: 100%; border-bottom: 1px solid #000; margin: 20px 0 5px 0; }
        .blank-inline { display: inline-block; min-width: 30px; border-bottom: 1px solid #000; margin: 0 2px; }
        .q-image-area { display: block; text-align: center; margin: 10px 0; width: 100%; }
        .q-image-area img { max-width: 100%; border: 1px solid #eee; }

        #measurementDiv { position: absolute; visibility: hidden; width: 210mm; padding: 0 7mm; column-count: 2; column-gap: 8mm; }
    </style>
</head>
<body>

    <div class="toolbar">
        <div class="toolbar-group">
            <span style="font-weight:bold; color:var(--accent-color);">꾸미기:</span>
            <button onclick="wrapSelection('U')" title="밑줄">
                <span class="material-symbols-outlined" style="font-size:16px;">format_underlined</span> 밑줄
            </button>
            <button onclick="wrapSelection('DOTUM')" title="돋음체">
                <span class="material-symbols-outlined" style="font-size:16px;">format_bold</span> 돋음
            </button>
        </div>
        
        <div class="toolbar-group">
            <span style="font-weight:bold; color:var(--accent-color);">요소:</span>
            <button onclick="insertTag('BOGI')">
                <span class="material-symbols-outlined" style="font-size:16px;">wysiwyg</span> 보기
            </button>
            <button onclick="insertTag('T')">
                <span class="material-symbols-outlined" style="font-size:16px;">article</span> 지문
            </button>
            <button onclick="insertImgLink()">
                <span class="material-symbols-outlined" style="font-size:16px;">link</span> 링크
            </button>
        </div>

        <div class="toolbar-group">
            <button class="btn-file">
                <span class="material-symbols-outlined">image</span> 파일
                <input type="file" id="imgInput" multiple accept="image/*" onchange="handleFiles(this.files)">
            </button>
            <span id="fileCount" style="font-size:11px; color:#555;"></span>
        </div>

        <div class="toolbar-group">
            <button class="btn-primary" onclick="renderExam()">
                <span class="material-symbols-outlined">refresh</span> 적용
            </button>
            <button onclick="window.print()">
                <span class="material-symbols-outlined">print</span> 인쇄
            </button>
        </div>
    </div>

    <div class="workspace">
        <div class="editor-pane">
            <textarea id="codeInput" spellcheck="false" placeholder="내용을 입력하세요...">
[TITLE] 2025학년도 1학기 기말고사 [/TITLE]
[SUB] 2학년 국어 | 배점 : 100점 [/SUB]

[GUIDE] [01~02] 다음 글을 읽고 물음에 답하시오. [/GUIDE]
[T]
(가) 현대 사회에서 [DOTUM]정보의 홍수[/DOTUM]는 심각한 문제다.
[IMG]https://dummyimage.com/600x150/000/fff&text=Example+Image+URL[/IMG]
(나) [U]이 문장은 밑줄이 그어집니다.[/U]
[/T]
[Q] (가)의 핵심 내용으로 적절한 것은? [/Q]
[BOGI]
ㄱ. 정보는 기하급수적으로 늘어난다.
ㄴ. [U]기술 발전[/U]은 필수적이다.
[/BOGI]
[O]
[I]① ㄱ[/I]
[I]② ㄴ[/I]
[I]③ ㄱ, ㄴ[/I]
[/O]

[SEP]

[Q] 다음 빈칸 __A__와 __(B)__에 들어갈 말은? [/Q]
[T]
인공지능은 데이터를 통해 스스로 __학습__한다.
이것을 __( 머신 러닝 )__이라고 부른다.
[/T]
[O]
[I]① 창의성, 딥러닝[/I]
[I]② 효율성, 지도학습[/I]
[/O]

[SEP]

[Q] 다음 빈칸을 채우시오. [/Q]
[T]
그는 집에 가자마자 _______을 열었다.
[/T]
정답 : [LINE]
</textarea>
        </div>

        <div class="preview-pane">
            <div id="measurementDiv"></div>
            <div id="examSheetContainer"></div>
        </div>
    </div>

    <script>
        const imageAssets = {};
        const PAGE_CONTENT_HEIGHT_PX = 920; 

        // 1. 선택 영역 감싸기 (밑줄, 돋음 등)
        function wrapSelection(tagType) {
            const textarea = document.getElementById('codeInput');
            const start = textarea.selectionStart;
            const end = textarea.selectionEnd;
            const text = textarea.value;

            if (start === end) {
                alert("텍스트를 드래그해서 선택해주세요.");
                return;
            }

            const replacement = `[${tagType}]${text.substring(start, end)}[/${tagType}]`;
            textarea.value = text.substring(0, start) + replacement + text.substring(end);
            
            textarea.selectionStart = start + replacement.length;
            textarea.selectionEnd = start + replacement.length;
            textarea.focus();
            renderExam(); 
        }

        // 2. 태그 삽입 (지문, 보기)
        function insertTag(tagType) {
            const textarea = document.getElementById('codeInput');
            const pos = textarea.selectionStart;
            const text = textarea.value;
            
            let content = '';
            if(tagType === 'BOGI') content = `\n[BOGI]\n내용을 입력하세요\n[/BOGI]\n`;
            else if(tagType === 'T') content = `\n[T]\n내용을 입력하세요\n[/T]\n`;
            
            textarea.value = text.substring(0, pos) + content + text.substring(pos);
            renderExam();
        }

        // 3. 이미지 링크 삽입 (Prompt)
        function insertImgLink() {
            const url = prompt("이미지 주소(URL)를 입력하세요:");
            if(url) {
                const textarea = document.getElementById('codeInput');
                const pos = textarea.selectionStart;
                const text = textarea.value;
                const imgTag = `\n[IMG]${url}[/IMG]\n`;
                textarea.value = text.substring(0, pos) + imgTag + text.substring(pos);
                renderExam();
            }
        }

        function handleFiles(files) {
            document.getElementById('fileCount').innerText = `${files.length}개`;
            for (let file of files) {
                if (imageAssets[file.name]) URL.revokeObjectURL(imageAssets[file.name]);
                imageAssets[file.name] = URL.createObjectURL(file);
            }
        }

        function createPage(pageIndex, totalPages, headerHtml, footerText) {
            const pageDiv = document.createElement('div');
            pageDiv.className = 'page-container';
            pageDiv.setAttribute('data-page', pageIndex);

            const header = document.createElement('div');
            header.className = 'exam-header';
            header.innerHTML = headerHtml;
            pageDiv.appendChild(header);

            const body = document.createElement('div');
            body.className = 'exam-body-content';
            pageDiv.appendChild(body);

            const footer = document.createElement('div');
            footer.className = 'exam-footer';
            footer.innerText = footerText.replace('PAGE_INDEX', pageIndex).replace('TOTAL_PAGES', totalPages);
            pageDiv.appendChild(footer);

            return { pageDiv, body };
        }

        function padNum(num) { return String(num).padStart(2, '0'); }

        function createRowHtml(numContent, bodyContent) {
            return `
                <div class="layout-row">
                    <div class="col-num">${numContent}</div>
                    <div class="col-content">${bodyContent}</div>
                </div>
            `;
        }

        function renderExam() {
            let raw = document.getElementById('codeInput').value;
            const container = document.getElementById('examSheetContainer');
            container.innerHTML = '';
            
            const measurementDiv = document.getElementById('measurementDiv');
            measurementDiv.innerHTML = '';
            measurementDiv.style.display = 'block';

            const titleMatch = raw.match(/\[TITLE\]([\s\S]*?)\[\/TITLE\]/);
            const title = titleMatch ? titleMatch[1].trim() : '시험 제목';
            const subMatch = raw.match(/\[SUB\]([\s\S]*?)\[\/SUB\]/);
            const sub = subMatch ? subMatch[1].trim() : '시험 정보';
            const headerHtml = `<div class="h-title">${title}</div><div class="h-info">${sub}</div>`;
            const footerTemplate = `PAGE_INDEX / TOTAL_PAGES`;
            raw = raw.replace(titleMatch ? titleMatch[0] : '', '').replace(subMatch ? subMatch[0] : '', '');

            const imgMapping = {};
            const imgListMatch = raw.match(/\[IMAGE_LIST\]([\s\S]*?)\[\/IMAGE_LIST\]/);
            if (imgListMatch) {
                imgListMatch[1].trim().split('\n').forEach(line => {
                    const parts = line.split(':');
                    if (parts.length >= 2) imgMapping[parts[0].trim()] = parts.slice(1).join(':').trim();
                });
                raw = raw.replace(imgListMatch[0], '');
            }

            const questionBlocks = raw.split('[SEP]').map(q => q.trim()).filter(q => q.length > 0);
            
            let qCounter = 0;
            let currentPageBody = null;
            const pages = [];

            const firstPage = createPage(1, 1, headerHtml, footerTemplate);
            pages.push(firstPage);
            currentPageBody = firstPage.body;

            for (let qBlock of questionBlocks) {
                let isQuestion = qBlock.includes('[Q]');
                
                let guideHtml = '';
                let passageHtml = '';
                let mainBodyHtml = qBlock;

                // [파싱 순서]
                // 1. 인라인 이미지 (NEW)
                mainBodyHtml = mainBodyHtml.replace(/\[IMG\]([\s\S]*?)\[\/IMG\]/g, '<div class="inline-img-box"><img src="$1" alt="Image"></div>');

                // 2. 밑줄 빈칸
                mainBodyHtml = mainBodyHtml.replace(/__([\s\S]*?)__/g, '<span class="u-blank-inline">$1</span>');

                // 3. 일반 태그
                mainBodyHtml = mainBodyHtml.replace(/\[U\]([\s\S]*?)\[\/U\]/g, '<span class="u-text">$1</span>');
                mainBodyHtml = mainBodyHtml.replace(/\[DOTUM\]([\s\S]*?)\[\/DOTUM\]/g, '<span class="font-dotum">$1</span>');
                mainBodyHtml = mainBodyHtml.replace(/\[BATANG\]([\s\S]*?)\[\/BATANG\]/g, '<span class="font-batang">$1</span>');

                // 4. 보기 박스 (BOGI)
                mainBodyHtml = mainBodyHtml.replace(/\[BOGI\]([\s\S]*?)\[\/BOGI\]/g, (match, content) => {
                    return `<div class="bogi-box"><span class="bogi-title">&lt; 보 기 &gt;</span>${content}</div>`;
                });

                // 5. GUIDE
                if (mainBodyHtml.includes('[GUIDE]')) {
                    mainBodyHtml = mainBodyHtml.replace(/\[GUIDE\]([\s\S]*?)\[\/GUIDE\]/g, (match, content) => {
                        const rangeMatch = content.match(/\[\s*(\d+)\s*~\s*(\d+)\s*\](.*)/);
                        let numPart = '';
                        let textPart = content;
                        if (rangeMatch) {
                            numPart = `${padNum(rangeMatch[1])}~${padNum(rangeMatch[2])}`;
                            textPart = rangeMatch[3].trim();
                        }
                        guideHtml = `
                            <div class="guide-box">
                                <span class="guide-num">${numPart}</span> ${textPart}
                            </div>
                        `;
                        return '';
                    });
                }

                // 6. 지문 (T)
                if (mainBodyHtml.includes('[T]')) {
                    mainBodyHtml = mainBodyHtml.replace(/\[T\]([\s\S]*?)\[\/T\]/g, (match, content) => {
                        passageHtml += createRowHtml('', `<div class="common-box">${content}</div>`);
                        return '';
                    });
                }

                // 7. 표 (TABLE)
                mainBodyHtml = mainBodyHtml.replace(/\[TABLE\]([\s\S]*?)\[\/TABLE\]/g, function(match, content) {
                    let rows = content.trim().split('\n');
                    let tableHtml = '<table class="custom-table">';
                    rows.forEach((row, idx) => {
                        tableHtml += '<tr>';
                        row.split('|').forEach(col => {
                            let tag = idx === 0 ? 'th' : 'td';
                            tableHtml += `<${tag}>${col.trim()}</${tag}>`;
                        });
                        tableHtml += '</tr>';
                    });
                    tableHtml += '</table>';
                    return tableHtml;
                });

                mainBodyHtml = mainBodyHtml.replace(/\[LINE\]/g, '<div class="subjective-line"></div>');
                mainBodyHtml = mainBodyHtml.replace(/_+/g, '<span class="blank-inline"></span>');
                mainBodyHtml = mainBodyHtml.replace(/\[Q\]([\s\S]*?)\[\/Q\]/g, '<div class="q-text">$1</div>');
                mainBodyHtml = mainBodyHtml.replace(/\[O\]([\s\S]*?)\[\/O\]/g, '<ul class="choices">$1</ul>');
                mainBodyHtml = mainBodyHtml.replace(/\[I\]([\s\S]*?)\[\/I\]/g, '<li>$1</li>');

                let questionRowHtml = '';
                if(isQuestion) {
                    qCounter++;
                    let qNumStr = padNum(qCounter);
                    let imgTag = '';
                    if (imgMapping[qCounter]) {
                        const src = imageAssets[imgMapping[qCounter]] || imgMapping[qCounter];
                        if (src) imgTag = `<div class="q-image-area"><img src="${src}" alt="Q${qCounter}"></div>`;
                    }
                    questionRowHtml = createRowHtml(qNumStr, mainBodyHtml + imgTag);
                } else {
                    if (mainBodyHtml.trim().length > 0) {
                        questionRowHtml = createRowHtml('', mainBodyHtml);
                    }
                }

                let finalBlockHtml = `
                    <div class="question-block-wrapper">
                        ${guideHtml}
                        ${passageHtml}
                        ${questionRowHtml}
                    </div>
                `;

                measurementDiv.innerHTML = currentPageBody.innerHTML + finalBlockHtml;
                if (measurementDiv.offsetHeight > PAGE_CONTENT_HEIGHT_PX) {
                    const newPage = createPage(pages.length + 1, 1, headerHtml, footerTemplate);
                    pages.push(newPage);
                    currentPageBody = newPage.body;
                    currentPageBody.innerHTML = finalBlockHtml;
                    measurementDiv.innerHTML = finalBlockHtml;
                } else {
                    currentPageBody.innerHTML += finalBlockHtml;
                }
            }

            pages.forEach((p, idx) => {
                p.pageDiv.querySelector('.exam-footer').innerText = footerTemplate
                    .replace('PAGE_INDEX', idx + 1)
                    .replace('TOTAL_PAGES', pages.length);
                container.appendChild(p.pageDiv);
            });
            measurementDiv.style.display = 'none';
        }

        window.onload = renderExam;
    </script>
</body>
</html>
