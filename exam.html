<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>시험지 에디터 (완전 밀착 & 글꼴 기능)</title>
    
    <!-- 폰트 로드 -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-kopub@1.0">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200" />

    <style>
        /* =========================================
           1. 기본 설정
           ========================================= */
        :root { 
            --editor-bg: #2d3436; 
            --accent-color: #1a3c6e; 
            --main-font: 'KoPub Batang', serif; /* 기본 바탕체 */
        }
        body { margin: 0; padding: 0; height: 100vh; overflow: hidden; display: flex; flex-direction: column; background: #333; }
        * { box-sizing: border-box; -webkit-print-color-adjust: exact; }

        /* 폰트 클래스 (부분 적용용) */
        .font-dotum { font-family: 'KoPub Dotum', sans-serif !important; }
        .font-batang { font-family: 'KoPub Batang', serif !important; }

        /* 툴바 */
        .toolbar { background: #fff; padding: 5px 15px; border-bottom: 1px solid #ccc; display: flex; justify-content: space-between; align-items: center; height: 65px; gap: 10px; }
        .toolbar-group { display: flex; gap: 5px; align-items: center; border-right: 1px solid #ddd; padding-right: 10px; }
        .toolbar-group:last-child { border-right: none; }
        
        button { padding: 6px 10px; border: 1px solid #ccc; background: #f8f9fa; border-radius: 4px; cursor: pointer; font-size: 13px; font-weight: bold; display: flex; align-items: center; gap: 4px; white-space: nowrap; }
        button:hover { background: #e9ecef; }
        button:active { background: #dee2e6; transform: translateY(1px); }
        
        .btn-primary { background-color: var(--accent-color); color: white; border: none; }
        .btn-primary:hover { background-color: #132d52; }

        .workspace { display: flex; flex: 1; height: calc(100vh - 65px); }
        .editor-pane { width: 35%; background: var(--editor-bg); display: flex; flex-direction: column; border-right: 1px solid #555; }
        textarea#codeInput { flex: 1; width: 100%; background: transparent; color: #f1f2f6; border: none; padding: 20px; font-family: 'Consolas', monospace; font-size: 14px; line-height: 1.6; resize: none; outline: none; }
        
        .preview-pane { width: 65%; background: #555; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; align-items: center; }

        /* =========================================
           2. 시험지 레이아웃 (화면 & 인쇄 공통)
           ========================================= */
        .page-container {
            width: 210mm; min-height: 297mm; background: white; 
            margin-bottom: 20px; 
            /* [수정] 패딩 0으로 설정하여 헤더가 끝까지 닿게 함 */
            padding: 0; 
            box-shadow: 0 0 15px rgba(0,0,0,0.3);
            font-family: var(--main-font); color: #111; line-height: 1.5;
            break-after: always; position: relative; overflow: hidden;
        }

        /* 헤더 스타일 [완전 밀착 수정] */
        .exam-header {
            width: 100%;
            /* 상단 남색 바 두께 키움 */
            border-top: 15px solid var(--accent-color); 
            border-bottom: 1px solid #888;
            /* 헤더 내부 여백으로 텍스트 위치 잡음 */
            padding: 10px 10mm; 
            margin-bottom: 10px; 
            display: flex; justify-content: space-between; align-items: flex-end;
            font-family: 'KoPub Dotum', sans-serif;
        }
        .h-title { font-size: 18pt; font-weight: 900; color: var(--accent-color); letter-spacing: -1px; }
        .h-info { font-size: 10pt; color: #444; text-align: right; font-weight: bold; }

        /* 본문 영역 [패딩으로 안전 여백 확보] */
        .exam-body-content { 
            padding: 0 10mm; /* 좌우 여백 10mm */
            column-count: 2; 
            column-gap: 8mm; /* 단 간격 */
            column-rule: 0.5px solid #ccc; 
            text-align: justify; 
            height: 940px; /* 한 페이지 내용 높이 */
            overflow: hidden; 
        }

        .exam-footer { 
            position: absolute; bottom: 10mm; left: 0; width: 100%; 
            text-align: center; font-family: 'KoPub Dotum'; font-size: 10pt; color: #666; 
        }

        /* =========================================
           3. 인쇄 전용 (여백 0, 100% 밀착)
           ========================================= */
        @media print {
            .toolbar, .editor-pane { display: none !important; }
            body, html { margin: 0; padding: 0; width: 100%; height: 100%; background: #fff; }
            .workspace, .preview-pane { display: block; padding: 0; margin: 0; background: #fff; width: 100%; height: auto; }
            
            /* 핵심: 브라우저 마진 0 */
            @page { margin: 0; size: A4; }

            .page-container {
                width: 100% !important; height: 297mm !important;
                margin: 0 !important; padding: 0 !important;
                box-shadow: none; border: none;
                break-after: page; page-break-after: always;
            }
            
            .exam-body-content { height: auto !important; display: block; column-fill: auto; }
            /* 인쇄 시 푸터 위치 고정 */
            .exam-footer { bottom: 10mm !important; }
        }

        /* =========================================
           4. 문제 컴포넌트 디자인
           ========================================= */
        .question-block-wrapper { margin-bottom: 15px; break-inside: avoid; width: 100%; display: inline-block; }
        .layout-row { display: flex; align-items: flex-start; width: 100%; }
        
        .col-num {
            flex-shrink: 0; width: 50px; text-align: right; padding-right: 5px; 
            font-family: 'KoPub Dotum'; font-size: 14pt; font-weight: 900; 
            color: var(--accent-color); line-height: 1.2; letter-spacing: -0.5px;
        }
        .col-content { flex-grow: 1; width: calc(100% - 50px); font-size: 10.5pt; color: #000; }

        .guide-text { font-family: 'KoPub Dotum'; font-weight: bold; margin-bottom: 5px; background: #f1f3f5; padding: 2px 5px; border-radius: 3px; display: inline-block; }
        .q-text { font-family: 'KoPub Dotum'; font-weight: bold; margin-bottom: 6px; line-height: 1.4; word-break: keep-all; }

        .common-box { width: 100%; border: 1px solid #444; padding: 8px; font-size: 9.5pt; text-align: justify; margin-bottom: 8px; line-height: 1.5; }

        .choices { list-style: none; padding: 0; margin: 0; width: 100%; font-family: 'KoPub Dotum'; font-size: 10pt; }
        .choices li { margin-bottom: 3px; padding-left: 10px; text-indent: -10px; }

        table.custom-table { width: 100%; border-collapse: collapse; margin: 5px 0 10px 0; font-family: 'KoPub Dotum'; font-size: 9pt; table-layout: fixed; }
        table.custom-table th, table.custom-table td { border: 1px solid #333; padding: 4px; text-align: center; }
        table.custom-table th { background-color: #eee; font-weight: bold; }

        .subjective-line { display: block; width: 100%; border-bottom: 1px solid #000; margin: 20px 0 5px 0; }
        .blank-inline { display: inline-block; min-width: 30px; border-bottom: 1px solid #000; margin: 0 2px; }

        #measurementDiv { position: absolute; visibility: hidden; width: 210mm; padding: 0 10mm; column-count: 2; column-gap: 8mm; }
    </style>
</head>
<body>

    <div class="toolbar">
        <div class="toolbar-group">
            <span style="font-weight:bold; color:var(--accent-color);">디자인:</span>
            <button onclick="changeGlobalFont('batang')">전체 바탕</button>
            <button onclick="changeGlobalFont('dotum')">전체 돋음</button>
        </div>
        
        <div class="toolbar-group">
            <span style="font-weight:bold; color:var(--accent-color);">부분 선택:</span>
            <!-- 드래그 후 클릭하면 태그 씌워주는 버튼 -->
            <button onclick="wrapSelection('DOTUM')" title="선택한 텍스트 돋음체 적용">
                <span class="material-symbols-outlined" style="font-size:16px;">format_bold</span> 드래그 돋음
            </button>
            <button onclick="wrapSelection('BATANG')" title="선택한 텍스트 바탕체 적용">
                <span class="material-symbols-outlined" style="font-size:16px;">serif</span> 드래그 바탕
            </button>
        </div>

        <div class="toolbar-group">
            <button class="btn-file">
                <span class="material-symbols-outlined">image</span> 이미지
                <input type="file" id="imgInput" multiple accept="image/*" onchange="handleFiles(this.files)">
            </button>
            <span id="fileCount" style="font-size:11px; color:#555;"></span>
        </div>

        <div class="toolbar-group">
            <button class="btn-primary" onclick="renderExam()">
                <span class="material-symbols-outlined">refresh</span> 적용
            </button>
            <button onclick="window.print()">
                <span class="material-symbols-outlined">print</span> 인쇄
            </button>
        </div>
    </div>

    <div class="workspace">
        <div class="editor-pane">
            <textarea id="codeInput" spellcheck="false" placeholder="내용을 입력하세요...">
[TITLE] 2025학년도 1학기 기말고사 [/TITLE]
[SUB] 2학년 국어 | 배점 : 100점 [/SUB]

[GUIDE] [01~02] 다음 글을 읽고 물음에 답하시오. [/GUIDE]
[T]
(가) 현대 사회에서 [DOTUM]정보의 홍수[/DOTUM]는 심각한 문제다.
(나) 이에 대해 전문가는...
[/T]
[Q] (가)의 핵심 내용으로 적절한 것은? [/Q]
[O]
[I]① 정보는 기하급수적으로 늘어난다.[/I]
[I]② [DOTUM]기술 발전[/DOTUM]은 필수적이다.[/I]
[I]③ 현대 사회는 정보화 사회이다.[/I]
[I]④ 데이터 처리가 중요하다.[/I]
[I]⑤ 기술 발전은 가속화된다.[/I]
[/O]

[SEP]

[Q] [DOTUM]윗글[/DOTUM]을 참고하여 아래 표를 완성하시오. [/Q]
[TABLE]
구분 | (가) 관점 | (나) 관점
긍정적 | 정보 접근성 | 문제 해결력
부정적 | 정보 과부하 | 신뢰성 하락
[/TABLE]
[O]
[I]① 창의성[/I]
[I]② 효율성[/I]
[/O]

[SEP]

[Q] 다음 빈칸을 채우시오. [/Q]
[T]
그는 집에 가자마자 _______을 열었다.
[/T]
정답 : [LINE]
</textarea>
        </div>

        <div class="preview-pane">
            <div id="measurementDiv"></div>
            <div id="examSheetContainer"></div>
        </div>
    </div>

    <script>
        const imageAssets = {};
        const PAGE_CONTENT_HEIGHT_PX = 940; 
        let globalFontMode = 'batang'; // 기본 글꼴 모드

        // 1. 전체 글꼴 변경
        function changeGlobalFont(mode) {
            globalFontMode = mode;
            const root = document.documentElement;
            if (mode === 'dotum') {
                root.style.setProperty('--main-font', "'KoPub Dotum', sans-serif");
            } else {
                root.style.setProperty('--main-font', "'KoPub Batang', serif");
            }
            renderExam(); // 다시 그리기
        }

        // 2. 선택 영역 글꼴 태그 감싸기
        function wrapSelection(tagType) {
            const textarea = document.getElementById('codeInput');
            const start = textarea.selectionStart;
            const end = textarea.selectionEnd;
            
            if (start === end) {
                alert("텍스트를 드래그해서 선택한 후 버튼을 눌러주세요.");
                return;
            }

            const text = textarea.value;
            const selectedText = text.substring(start, end);
            const before = text.substring(0, start);
            const after = text.substring(end);

            // [DOTUM]...[/DOTUM] 형태로 감싸기
            const replacement = `[${tagType}]${selectedText}[/${tagType}]`;
            
            textarea.value = before + replacement + after;
            
            // 커서 위치 재조정 (선택 편의성)
            textarea.selectionStart = start + replacement.length;
            textarea.selectionEnd = start + replacement.length;
            textarea.focus();

            renderExam(); // 즉시 반영
        }

        function handleFiles(files) {
            document.getElementById('fileCount').innerText = `${files.length}개`;
            for (let file of files) {
                if (imageAssets[file.name]) URL.revokeObjectURL(imageAssets[file.name]);
                imageAssets[file.name] = URL.createObjectURL(file);
            }
        }

        function createPage(pageIndex, totalPages, headerHtml, footerText) {
            const pageDiv = document.createElement('div');
            pageDiv.className = 'page-container';
            pageDiv.setAttribute('data-page', pageIndex);

            const header = document.createElement('div');
            header.className = 'exam-header';
            header.innerHTML = headerHtml;
            pageDiv.appendChild(header);

            const body = document.createElement('div');
            body.className = 'exam-body-content';
            pageDiv.appendChild(body);

            const footer = document.createElement('div');
            footer.className = 'exam-footer';
            footer.innerText = footerText.replace('PAGE_INDEX', pageIndex).replace('TOTAL_PAGES', totalPages);
            pageDiv.appendChild(footer);

            return { pageDiv, body };
        }

        function padNum(num) { return String(num).padStart(2, '0'); }

        function createRowHtml(numContent, bodyContent) {
            return `
                <div class="layout-row">
                    <div class="col-num">${numContent}</div>
                    <div class="col-content">${bodyContent}</div>
                </div>
            `;
        }

        function renderExam() {
            let raw = document.getElementById('codeInput').value;
            const container = document.getElementById('examSheetContainer');
            container.innerHTML = '';
            
            const measurementDiv = document.getElementById('measurementDiv');
            measurementDiv.innerHTML = '';
            measurementDiv.style.display = 'block';

            // 1. 헤더 파싱
            const titleMatch = raw.match(/\[TITLE\]([\s\S]*?)\[\/TITLE\]/);
            const title = titleMatch ? titleMatch[1].trim() : '시험 제목';
            const subMatch = raw.match(/\[SUB\]([\s\S]*?)\[\/SUB\]/);
            const sub = subMatch ? subMatch[1].trim() : '시험 정보';
            const headerHtml = `<div class="h-title">${title}</div><div class="h-info">${sub}</div>`;
            const footerTemplate = `PAGE_INDEX / TOTAL_PAGES`;
            raw = raw.replace(titleMatch ? titleMatch[0] : '', '').replace(subMatch ? subMatch[0] : '', '');

            // 2. 이미지 매핑
            const imgMapping = {};
            const imgListMatch = raw.match(/\[IMAGE_LIST\]([\s\S]*?)\[\/IMAGE_LIST\]/);
            if (imgListMatch) {
                imgListMatch[1].trim().split('\n').forEach(line => {
                    const parts = line.split(':');
                    if (parts.length >= 2) imgMapping[parts[0].trim()] = parts.slice(1).join(':').trim();
                });
                raw = raw.replace(imgListMatch[0], '');
            }

            // 3. 문항 분리
            const questionBlocks = raw.split('[SEP]').map(q => q.trim()).filter(q => q.length > 0);
            
            let qCounter = 0;
            let currentPageBody = null;
            const pages = [];

            // 첫 페이지 생성
            const firstPage = createPage(1, 1, headerHtml, footerTemplate);
            pages.push(firstPage);
            currentPageBody = firstPage.body;

            for (let qBlock of questionBlocks) {
                let isQuestion = qBlock.includes('[Q]');
                
                let guideHtml = '';
                let passageHtml = '';
                let mainBodyHtml = qBlock;

                // 공통 파싱 로직 (글꼴 태그 처리 포함)
                // [DOTUM] -> span class="font-dotum"
                mainBodyHtml = mainBodyHtml.replace(/\[DOTUM\]([\s\S]*?)\[\/DOTUM\]/g, '<span class="font-dotum">$1</span>');
                mainBodyHtml = mainBodyHtml.replace(/\[BATANG\]([\s\S]*?)\[\/BATANG\]/g, '<span class="font-batang">$1</span>');

                // [GUIDE] 처리
                if (mainBodyHtml.includes('[GUIDE]')) {
                    mainBodyHtml = mainBodyHtml.replace(/\[GUIDE\]([\s\S]*?)\[\/GUIDE\]/g, (match, content) => {
                        const rangeMatch = content.match(/\[\s*(\d+)\s*~\s*(\d+)\s*\](.*)/);
                        let numPart = '';
                        let textPart = content;
                        if (rangeMatch) {
                            numPart = `${padNum(rangeMatch[1])}~${padNum(rangeMatch[2])}`;
                            textPart = rangeMatch[3].trim();
                        }
                        guideHtml = createRowHtml(numPart, `<div class="guide-text">${textPart}</div>`);
                        return '';
                    });
                }

                // [T] 지문 처리
                if (mainBodyHtml.includes('[T]')) {
                    mainBodyHtml = mainBodyHtml.replace(/\[T\]([\s\S]*?)\[\/T\]/g, (match, content) => {
                        passageHtml += createRowHtml('', `<div class="common-box">${content}</div>`);
                        return '';
                    });
                }

                // [TABLE]
                mainBodyHtml = mainBodyHtml.replace(/\[TABLE\]([\s\S]*?)\[\/TABLE\]/g, function(match, content) {
                    let rows = content.trim().split('\n');
                    let tableHtml = '<table class="custom-table">';
                    rows.forEach((row, idx) => {
                        tableHtml += '<tr>';
                        row.split('|').forEach(col => {
                            let tag = idx === 0 ? 'th' : 'td';
                            tableHtml += `<${tag}>${col.trim()}</${tag}>`;
                        });
                        tableHtml += '</tr>';
                    });
                    tableHtml += '</table>';
                    return tableHtml;
                });

                // 기타 태그
                mainBodyHtml = mainBodyHtml.replace(/\[LINE\]/g, '<div class="subjective-line"></div>');
                mainBodyHtml = mainBodyHtml.replace(/_+/g, '<span class="blank-inline"></span>');
                mainBodyHtml = mainBodyHtml.replace(/\[Q\]([\s\S]*?)\[\/Q\]/g, '<div class="q-text">$1</div>');
                mainBodyHtml = mainBodyHtml.replace(/\[O\]([\s\S]*?)\[\/O\]/g, '<ul class="choices">$1</ul>');
                mainBodyHtml = mainBodyHtml.replace(/\[I\]([\s\S]*?)\[\/I\]/g, '<li>$1</li>');

                let questionRowHtml = '';
                if(isQuestion) {
                    qCounter++;
                    let qNumStr = padNum(qCounter);
                    let imgTag = '';
                    if (imgMapping[qCounter]) {
                        const src = imageAssets[imgMapping[qCounter]] || imgMapping[qCounter];
                        if (src) imgTag = `<div class="q-image-area"><img src="${src}" alt="Q${qCounter}"></div>`;
                    }
                    questionRowHtml = createRowHtml(qNumStr, mainBodyHtml + imgTag);
                } else {
                    if (mainBodyHtml.trim().length > 0) {
                        questionRowHtml = createRowHtml('', mainBodyHtml);
                    }
                }

                let finalBlockHtml = `
                    <div class="question-block-wrapper">
                        ${guideHtml}
                        ${passageHtml}
                        ${questionRowHtml}
                    </div>
                `;

                // 높이 계산 및 페이지 나누기
                measurementDiv.innerHTML = currentPageBody.innerHTML + finalBlockHtml;
                if (measurementDiv.offsetHeight > PAGE_CONTENT_HEIGHT_PX) {
                    const newPage = createPage(pages.length + 1, 1, headerHtml, footerTemplate);
                    pages.push(newPage);
                    currentPageBody = newPage.body;
                    currentPageBody.innerHTML = finalBlockHtml;
                    measurementDiv.innerHTML = finalBlockHtml;
                } else {
                    currentPageBody.innerHTML += finalBlockHtml;
                }
            }

            // 페이지 번호 업데이트 및 렌더링
            pages.forEach((p, idx) => {
                p.pageDiv.querySelector('.exam-footer').innerText = footerTemplate
                    .replace('PAGE_INDEX', idx + 1)
                    .replace('TOTAL_PAGES', pages.length);
                container.appendChild(p.pageDiv);
            });
            measurementDiv.style.display = 'none';
        }

        window.onload = renderExam;
    </script>
</body>
</html>
