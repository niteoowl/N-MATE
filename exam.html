<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>시험지 에디터 (정렬 완벽판)</title>
    
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-kopub@1.0">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200" />

    <style>
        /* =========================================
           1. 기본 설정
           ========================================= */
        :root { --editor-bg: #2d3436; --accent-color: #1a3c6e; }
        body { margin: 0; padding: 0; height: 100vh; overflow: hidden; display: flex; flex-direction: column; background: #333; }
        * { box-sizing: border-box; }

        /* 툴바 */
        .toolbar { background: #fff; padding: 10px 20px; border-bottom: 1px solid #ccc; display: flex; justify-content: space-between; align-items: center; height: 60px; }
        .brand { height: 40px; width: auto; }
        .toolbar-right { display: flex; gap: 10px; align-items: center; }
        button { padding: 8px 15px; border: none; border-radius: 4px; cursor: pointer; font-family: 'KoPub Dotum', sans-serif; font-weight: bold; display: flex; align-items: center; gap: 5px; }
        .btn-file { background-color: #00b894; color: white; position: relative; overflow: hidden; }
        .btn-file input { position: absolute; left: 0; top: 0; opacity: 0; cursor: pointer; height: 100%; width: 100%; }
        .btn-run { background-color: var(--accent-color); color: white; }
        .btn-print { background-color: #636e72; color: white; }

        .workspace { display: flex; flex: 1; height: calc(100vh - 60px); }
        .editor-pane { width: 35%; background: var(--editor-bg); display: flex; flex-direction: column; border-right: 1px solid #555; }
        textarea#codeInput { flex: 1; width: 100%; background: transparent; color: #f1f2f6; border: none; padding: 20px; font-family: 'Consolas', monospace; font-size: 14px; line-height: 1.6; resize: none; outline: none; }
        .preview-pane { width: 65%; background: #ecf0f1; overflow-y: auto; padding: 40px 0; display: flex; flex-direction: column; align-items: center; }

        /* =========================================
           2. 시험지 레이아웃 (여백 최소화)
           ========================================= */
        .page-container {
            width: 210mm; min-height: 297mm; background: white; 
            padding: 0 8mm; /* 여백 8mm (공간 확보) */
            box-shadow: 0 0 15px rgba(0,0,0,0.1); margin-bottom: 20px; 
            font-family: 'KoPub Batang', serif; color: #111; line-height: 1.5;
            break-after: always; position: relative;
        }
        
        @media print {
            .toolbar, .editor-pane { display: none !important; }
            .workspace, .preview-pane { display: block; width: 100vw; height: auto; overflow: visible; padding: 0; background: white; margin: 0; }
            body { overflow: visible; height: auto; background: white; width: 100vw; }
            .page-container { box-shadow: none !important; margin: 0 !important; width: 210mm !important; min-height: 297mm; padding: 0 8mm; }
            .exam-body-content { 
                column-count: 2 !important; 
                column-gap: 7mm !important; 
                column-rule: 0.5px solid #ddd !important; height: auto !important; 
            }
            @page { size: a4; margin: 0; }
        }

        .exam-header { font-family: 'KoPub Dotum', sans-serif; border-top: 4px solid var(--accent-color); border-bottom: 1px solid #aaa; padding: 12px 5px; margin-bottom: 20px; display: flex; justify-content: space-between; align-items: flex-end; }
        .h-title { font-size: 16pt; font-weight: 800; color: var(--accent-color); letter-spacing: -1px; width: 65%; }
        .h-info { font-size: 10pt; color: #444; text-align: right; width: 35%; line-height: 1.4; }

        .exam-body-content { 
            column-count: 2; column-gap: 7mm; 
            column-rule: 0.5px solid #ddd; text-align: justify; height: 900px; overflow: hidden; 
        }
        .exam-footer { position: absolute; bottom: 12mm; left: 0; width: 100%; text-align: center; font-family: 'KoPub Dotum'; font-size: 10pt; color: #666; }

        /* =========================================
           3. 2열 레이아웃 (정렬 최우선)
           ========================================= */
        
        .question-block-wrapper { margin-bottom: 20px; break-inside: avoid; width: 100%; }
        .layout-row { display: flex; align-items: flex-start; width: 100%; margin-bottom: 6px; }

        /* [수정] 번호 칸 너비 58px 고정
           - 01~02(14pt)가 넉넉히 들어감
           - 01도 이 안에서 우측 정렬되어, 텍스트와의 간격이 항상 일정함
        */
        .col-num {
            flex-shrink: 0;
            width: 58px; 
            text-align: right; /* 번호는 우측 정렬 (텍스트와 붙이기 위해) */
            padding-right: 6px; /* 텍스트와의 간격 */
            
            font-family: 'KoPub Dotum'; 
            font-size: 14pt; 
            font-weight: 900;
            color: var(--accent-color);
            line-height: 1.2;
            letter-spacing: -0.5px;
            white-space: nowrap;
        }

        /* [수정] 콘텐츠는 남은 공간 사용 */
        .col-content {
            flex-grow: 1;
            width: calc(100% - 58px); 
            font-size: 11pt; color: #000;
        }

        .guide-text { font-family: 'KoPub Dotum'; font-weight: bold; margin-bottom: 5px; line-height: 1.4; }
        .q-text { font-family: 'KoPub Dotum'; font-weight: bold; margin-bottom: 8px; line-height: 1.45; word-break: keep-all; }

        .common-box {
            width: 100%; border: 1px solid #000; background-color: #fff;
            padding: 10px; font-family: 'KoPub Batang'; font-size: 9.8pt; line-height: 1.6;
            text-align: justify; margin-bottom: 10px;
        }

        .choices { list-style: none; padding: 0; margin: 0; width: 100%; font-family: 'KoPub Dotum'; font-size: 10.5pt; }
        .choices li { margin-bottom: 4px; padding-left: 0; text-indent: -10px; margin-left: 10px; }

        table.custom-table {
            width: 100%; border-collapse: collapse; margin: 5px 0 15px 0;
            font-family: 'KoPub Dotum'; font-size: 9.5pt; table-layout: fixed;
        }
        table.custom-table th, table.custom-table td { border: 1px solid #000; padding: 6px 4px; text-align: center; word-break: break-all; }
        table.custom-table th { background-color: #f7f7f7; font-weight: bold; }

        .subjective-line { display: block; width: 100%; border-bottom: 1px solid #000; margin: 25px 0 10px 0; }
        .blank-inline { display: inline-block; min-width: 40px; border-bottom: 1px solid #000; margin: 0 2px; }

        .q-image-area { display: block; text-align: center; margin: 10px 0; width: 100%; }
        .q-image-area img { max-width: 100%; border: 1px solid #eee; }

        #measurementDiv { position: absolute; visibility: hidden; width: 210mm; padding: 0 8mm; }
        #measurementDiv .question-block-wrapper { width: 48%; display: inline-block; vertical-align: top; }

    </style>
</head>
<body>

    <div class="toolbar">
        <img class="brand" src="https://i.postimg.cc/Nj2q8jb0/cropped-jemog-eul-iblyeoghaejuseyo-(10)-Photoroom.png" alt="Logo" />
        <div class="toolbar-right">
            <button class="btn-file">
                <span class="material-symbols-outlined">image</span> 이미지
                <input type="file" id="imgInput" multiple accept="image/*" onchange="handleFiles(this.files)">
            </button>
            <span id="fileCount" style="font-size:12px; color:#555;"></span>
            <button class="btn-run" onclick="renderExam()">
                <span class="material-symbols-outlined">refresh</span> 변환
            </button>
            <button class="btn-print" onclick="window.print()">
                <span class="material-symbols-outlined">print</span> 인쇄
            </button>
        </div>
    </div>

    <div class="workspace">
        <div class="editor-pane">
            <textarea id="codeInput" spellcheck="false" placeholder="내용을 입력하세요...">
[TITLE] 2025학년도 1학기 기말고사 [/TITLE]
[SUB] 2학년 국어 | 배점 : 100점 [/SUB]

[GUIDE] [1~2] 다음 글을 읽고 물음에 답하시오. [/GUIDE]
[T]
(가) 현대 사회에서 정보의 홍수는... 
(나) 이에 대해 전문가들은...
[/T]
[Q] (가)의 내용과 일치하지 않는 것은? [/Q]
[O]
[I]① 정보는 기하급수적으로 늘어난다.[/I]
[I]② 전문가는 부정적인 견해를 보인다.[/I]
[I]③ 현대 사회는 정보화 사회이다.[/I]
[I]④ 데이터 처리가 중요하다.[/I]
[I]⑤ 기술 발전은 가속화된다.[/I]
[/O]

[SEP]

[Q] 윗글을 참고하여 아래 표를 완성하시오. [/Q]
[TABLE]
구분 | (가) 관점 | (나) 관점
긍정적 | 정보 접근성 | 문제 해결력
부정적 | 정보 과부하 | 신뢰성 하락
[/TABLE]
[O]
[I]① 창의성[/I]
[I]② 효율성[/I]
[/O]

[SEP]

[Q] 다음 빈칸을 채우시오. [/Q]
[T]
그는 집에 가자마자 _______을 열었다.
[/T]
정답 : [LINE]
</textarea>
        </div>

        <div class="preview-pane">
            <div id="measurementDiv"></div>
            <div id="examSheetContainer" class="exam-sheet"></div>
        </div>
    </div>

    <script>
        const imageAssets = {};
        const PAGE_CONTENT_HEIGHT_PX = 900; 

        function handleFiles(files) {
            document.getElementById('fileCount').innerText = `${files.length}개`;
            for (let file of files) {
                if (imageAssets[file.name]) URL.revokeObjectURL(imageAssets[file.name]);
                imageAssets[file.name] = URL.createObjectURL(file);
            }
        }

        function createPage(pageIndex, totalPages, headerHtml, footerText) {
            const pageDiv = document.createElement('div');
            pageDiv.className = 'page-container';
            pageDiv.setAttribute('data-page', pageIndex);

            const header = document.createElement('div');
            header.className = 'exam-header';
            header.innerHTML = headerHtml;
            pageDiv.appendChild(header);

            const body = document.createElement('div');
            body.className = 'exam-body-content';
            pageDiv.appendChild(body);

            const footer = document.createElement('div');
            footer.className = 'exam-footer';
            footer.innerText = footerText.replace('PAGE_INDEX', pageIndex).replace('TOTAL_PAGES', totalPages);
            pageDiv.appendChild(footer);

            return { pageDiv, body };
        }

        function padNum(num) { return String(num).padStart(2, '0'); }

        function createRowHtml(numContent, bodyContent) {
            return `
                <div class="layout-row">
                    <div class="col-num">${numContent}</div>
                    <div class="col-content">${bodyContent}</div>
                </div>
            `;
        }

        function renderExam() {
            let raw = document.getElementById('codeInput').value;
            const container = document.getElementById('examSheetContainer');
            container.innerHTML = '';
            
            const measurementDiv = document.getElementById('measurementDiv');
            measurementDiv.innerHTML = '';
            measurementDiv.style.display = 'block';

            const titleMatch = raw.match(/\[TITLE\]([\s\S]*?)\[\/TITLE\]/);
            const title = titleMatch ? titleMatch[1].trim() : '시험 제목';
            const subMatch = raw.match(/\[SUB\]([\s\S]*?)\[\/SUB\]/);
            const sub = subMatch ? subMatch[1].trim() : '시험 정보';
            const headerHtml = `<div class="h-title">${title}</div><div class="h-info">${sub}</div>`;
            const footerTemplate = `PAGE_INDEX / TOTAL_PAGES`;
            raw = raw.replace(titleMatch ? titleMatch[0] : '', '').replace(subMatch ? subMatch[0] : '', '');

            const imgMapping = {};
            const imgListMatch = raw.match(/\[IMAGE_LIST\]([\s\S]*?)\[\/IMAGE_LIST\]/);
            if (imgListMatch) {
                imgListMatch[1].trim().split('\n').forEach(line => {
                    const parts = line.split(':');
                    if (parts.length >= 2) imgMapping[parts[0].trim()] = parts.slice(1).join(':').trim();
                });
                raw = raw.replace(imgListMatch[0], '');
            }

            const questionBlocks = raw.split('[SEP]').map(q => q.trim()).filter(q => q.length > 0);
            
            let qCounter = 0;
            let currentPageBody = null;
            const pages = [];

            const firstPage = createPage(1, 1, headerHtml, footerTemplate);
            pages.push(firstPage);
            currentPageBody = firstPage.body;

            for (let qBlock of questionBlocks) {
                let isQuestion = qBlock.includes('[Q]');
                
                let guideHtml = '';
                let passageHtml = '';
                let mainBodyHtml = qBlock;

                // [GUIDE] : 이제 왼쪽 번호 칸(col-num)을 사용함 (정렬 맞춤)
                if (mainBodyHtml.includes('[GUIDE]')) {
                    mainBodyHtml = mainBodyHtml.replace(/\[GUIDE\]([\s\S]*?)\[\/GUIDE\]/g, (match, content) => {
                        const rangeMatch = content.match(/\[\s*(\d+)\s*~\s*(\d+)\s*\](.*)/);
                        let numPart = '';
                        let textPart = content;
                        if (rangeMatch) {
                            numPart = `${padNum(rangeMatch[1])}~${padNum(rangeMatch[2])}`;
                            textPart = rangeMatch[3].trim();
                        }
                        // numPart를 왼쪽 col-num에 전달하여 정렬 통일
                        guideHtml = createRowHtml(numPart, `<div class="guide-text">${textPart}</div>`);
                        return '';
                    });
                }

                // [T]
                if (mainBodyHtml.includes('[T]')) {
                    mainBodyHtml = mainBodyHtml.replace(/\[T\]([\s\S]*?)\[\/T\]/g, (match, content) => {
                        passageHtml += createRowHtml('', `<div class="common-box">${content}</div>`);
                        return '';
                    });
                }

                mainBodyHtml = mainBodyHtml.replace(/\[TABLE\]([\s\S]*?)\[\/TABLE\]/g, function(match, content) {
                    let rows = content.trim().split('\n');
                    let tableHtml = '<table class="custom-table">';
                    rows.forEach((row, idx) => {
                        tableHtml += '<tr>';
                        row.split('|').forEach(col => {
                            let tag = idx === 0 ? 'th' : 'td';
                            tableHtml += `<${tag}>${col.trim()}</${tag}>`;
                        });
                        tableHtml += '</tr>';
                    });
                    tableHtml += '</table>';
                    return tableHtml;
                });
                mainBodyHtml = mainBodyHtml.replace(/\[LINE\]/g, '<div class="subjective-line"></div>');
                mainBodyHtml = mainBodyHtml.replace(/_+/g, '<span class="blank-inline"></span>');
                mainBodyHtml = mainBodyHtml.replace(/\[Q\]([\s\S]*?)\[\/Q\]/g, '<div class="q-text">$1</div>');
                mainBodyHtml = mainBodyHtml.replace(/\[O\]([\s\S]*?)\[\/O\]/g, '<ul class="choices">$1</ul>');
                mainBodyHtml = mainBodyHtml.replace(/\[I\]([\s\S]*?)\[\/I\]/g, '<li>$1</li>');

                let questionRowHtml = '';
                if(isQuestion) {
                    qCounter++;
                    let qNumStr = padNum(qCounter);
                    let imgTag = '';
                    if (imgMapping[qCounter]) {
                        const src = imageAssets[imgMapping[qCounter]] || imgMapping[qCounter];
                        if (src) imgTag = `<div class="q-image-area"><img src="${src}" alt="Q${qCounter}"></div>`;
                    }
                    questionRowHtml = createRowHtml(qNumStr, mainBodyHtml + imgTag);
                } else {
                    if (mainBodyHtml.trim().length > 0) {
                        questionRowHtml = createRowHtml('', mainBodyHtml);
                    }
                }

                let finalBlockHtml = `
                    <div class="question-block-wrapper">
                        ${guideHtml}
                        ${passageHtml}
                        ${questionRowHtml}
                    </div>
                `;

                measurementDiv.innerHTML = currentPageBody.innerHTML + finalBlockHtml;
                if (measurementDiv.offsetHeight > PAGE_CONTENT_HEIGHT_PX) {
                    const newPage = createPage(pages.length + 1, 1, headerHtml, footerTemplate);
                    pages.push(newPage);
                    currentPageBody = newPage.body;
                    currentPageBody.innerHTML = finalBlockHtml;
                    measurementDiv.innerHTML = finalBlockHtml;
                } else {
                    currentPageBody.innerHTML += finalBlockHtml;
                }
            }

            pages.forEach((p, idx) => {
                p.pageDiv.querySelector('.exam-footer').innerText = footerTemplate
                    .replace('PAGE_INDEX', idx + 1)
                    .replace('TOTAL_PAGES', pages.length);
                container.appendChild(p.pageDiv);
            });
            measurementDiv.style.display = 'none';
        }

        window.onload = renderExam;
    </script>
</body>
</html>
