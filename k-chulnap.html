<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>[ì²­ì†Œë…„ìš©] K-ì¶œë‚©ë¶€</title>
    <!-- Tailwind CSS ë¡œë“œ -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* í°íŠ¸ ë° ê¸°ë³¸ ì„¤ì • */
        body {
            font-family: 'Dotum', 'Gulim', sans-serif;
            background-color: #EFEFEF; 
            font-size: 13px;
        }
        /* 2000ë…„ëŒ€ ìŠ¤íƒ€ì¼ 3D ë²„íŠ¼ */
        .classic-button {
            border: 1px solid #000;
            border-color: #DFDFDF #808080 #808080 #DFDFDF;
            background-color: #D3D3D3;
            box-shadow: 1px 1px 0px #F0F0F0 inset, -1px -1px 0px #A0A0A0 inset;
            transition: all 0.05s;
            user-select: none;
        }
        .classic-button:active {
            border-color: #808080 #DFDFDF #DFDFDF #808080;
            box-shadow: 1px 1px 0px #A0A0A0 inset, -1px -1px 0px #F0F0F0 inset;
        }
        /* ê¹Šê²Œ íŒŒì¸ ì…ë ¥ í•„ë“œ */
        .classic-input {
            border: 1px solid #808080;
            background-color: white;
            padding: 2px 4px;
            box-shadow: 1px 1px 0px #FFFFFF inset;
        }
        /* í—¤ë” ê·¸ë¼ë°ì´ì…˜ */
        .classic-header-gradient {
            background: linear-gradient(to bottom, #A0C4E6 0%, #2B5876 100%);
            color: white;
            text-shadow: 1px 1px #000000;
        }
        /* í”„ë ˆì„/ê·¸ë£¹ ë°•ìŠ¤ */
        .classic-frame {
            border: 1px solid #808080;
            padding: 4px;
            background-color: #F0F0F0;
        }
        /* íƒ€ì´í‹€ ë°” (íŒŒë€ìƒ‰) */
        .classic-title-bar {
            background-color: #0000AA;
            color: white;
            padding: 2px 8px;
            font-weight: bold;
        }
        /* ê¸°íƒ€ UI ìš”ì†Œ */
        .classic-menu-bar { background-color: #D3D3D3; border-top: 1px solid #DFDFDF; border-bottom: 1px solid #808080; }
        .classic-active-menu { 
            background-color: #FFC06C; 
            border: 1px dashed #000000; 
            margin: -1px;
            box-shadow: none !important;
        }
        .table-input { width: 100%; height: 100%; border: none; outline: none; background-color: transparent; padding: 2px 4px; }
        .content-area-wrapper { flex-grow: 1; }
        
        /* ìº˜ë¦°ë” ìŠ¤íƒ€ì¼ */
        #calendar-days td span { display: block; width: 100%; height: 100%; cursor: pointer; padding: 2px 0; text-align: center; }
        #calendar-days td span:hover { background-color: #C0C0C0; }
        /* ë°ì´í„° í–‰ ë†’ì´ ê³ ì • */
        .data-row td { height: 28px; }

        /* ë¡œë”© ìŠ¤í”¼ë„ˆ */
        .loading-spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        /* ì‹œìŠ¤í…œ ìƒíƒœ ì˜¤ë¥˜ ë©”ì‹œì§€ ìŠ¤íƒ€ì¼ ì¶”ê°€ */
        .error-status {
            background-color: #FFDDDD !important; /* Light Red */
            color: #CC0000 !important; /* Dark Red Text */
            font-weight: bold;
            border: 2px solid #CC0000 !important;
        }

        /* Modal Backdrop */
        .modal-backdrop {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 50;
        }

        /* Report View Style */
        #report-output-area {
            white-space: pre-wrap;
            font-family: 'Malgun Gothic', 'Dotum', monospace;
            font-size: 14px;
            line-height: 1.5;
            min-height: 200px;
            background-color: #FFFFFF;
            padding: 10px;
            border: 1px solid #808080;
            box-shadow: 1px 1px 0px #A0A0A0 inset;
            overflow: auto;
        }
    </style>
</head>

<body class="min-h-screen flex flex-col"> 
    <!-- ì „ì²´ ì»¨í…Œì´ë„ˆ -->
    <div class="classic-frame min-h-screen flex flex-col p-2"> 
        
        <!-- 1. í—¤ë” (íƒ€ì´í‹€ ë° ë¡œê³ ) -->
        <header class="classic-header-gradient p-3 text-lg font-bold flex justify-between items-center mb-1 flex-shrink-0">
            <div class="flex items-center">
                <img src="https://i.postimg.cc/Z5p1HfXG/image01-Photoroom.png" alt="ì‹œìŠ¤í…œ ë¡œê³ " class="h-12 w-12 mr-3 object-contain" onerror="this.style.display='none'">
                <span>K-ì¶œë‚©ë¶€</span>
            </div>
            <div class="text-sm font-normal flex items-center" id="user-info-container">
                <span id="user-info">
                    ì‹œìŠ¤í…œ ë¡œë“œ ì¤‘...
                </span>
                <button id="logout-button" class="classic-button text-xs ml-4 px-2 py-0.5 hidden">
                    ë¡œê·¸ì•„ì›ƒ
                </button>
            </div>
        </header>

        <!-- 2. ë©”ë‰´ ë°” -->
        <div id="menu-bar" class="classic-menu-bar flex text-sm p-0.5 mb-2 flex-shrink-0 hidden">
            <span class="px-2 cursor-pointer hover:bg-white border-r border-gray-400">ë°ì´í„°(D)</span>
            <span class="px-2 cursor-pointer hover:bg-white border-r border-gray-400">ì„¤ì •(S)</span>
            <span class="px-2 cursor-pointer hover:bg-white border-r border-gray-400">ë³´ê³ ì„œ(R)</span>
            <span class="px-2 cursor-pointer hover:bg-white">ì •ë³´(I)</span>
        </div>
        
        <!-- 5. ë¡œê·¸ì¸ í¼ -->
        <div id="auth-view" class="flex flex-grow justify-center items-center p-4">
            <div id="login-form-card" class="classic-frame bg-white p-6 w-full max-w-sm shadow-xl">
                <div class="classic-title-bar text-sm mb-4 text-center">
                    [ê³„ì • ì¸ì¦ í•„ìš”]
                </div>
                <div id="auth-loading" class="text-center hidden">
                    <div class="loading-spinner mx-auto"></div>
                    <p class="mt-2 text-gray-700">ì¸ì¦ ì²˜ë¦¬ ì¤‘...</p>
                </div>
                <form id="auth-form">
                    <div class="mb-3">
                        <label class="block text-xs font-bold mb-1">ì´ë©”ì¼:</label>
                        <input type="email" id="auth-email" placeholder="example@domain.com" class="classic-input w-full" required>
                    </div>
                    <div class="mb-4">
                        <label class="block text-xs font-bold mb-1">ë¹„ë°€ë²ˆí˜¸ (6ìë¦¬ ì´ìƒ):</label>
                        <input type="password" id="auth-password" placeholder="******" class="classic-input w-full" required>
                    </div>
                    <div class="flex flex-col space-y-2">
                        <button type="submit" id="login-button" class="px-4 py-1 classic-button font-bold text-blue-800 w-full">
                            ë¡œê·¸ì¸
                        </button>
                        <button type="button" id="signup-button" class="px-4 py-1 classic-button w-full">
                            ê³„ì • ìƒì„± (íšŒì›ê°€ì…)
                        </button>
                    </div>
                    <p class="mt-4 text-xs text-red-600 text-center" id="auth-error-message"></p>
                    <div class="mt-6 text-xs p-2 classic-frame bg-gray-100 border border-gray-400">
                        <p class="font-bold mb-1">ğŸš¨ ì¤‘ìš” ê³µì§€ (ìµëª… ë¡œê·¸ì¸ ë¹„í™œì„±í™”):</p>
                        <p>- ì»¤ìŠ¤í…€ í† í°ì´ ì—†ê±°ë‚˜ ë§Œë£Œë˜ë©´ ìë™ìœ¼ë¡œ ë¡œê·¸ì•„ì›ƒ ìƒíƒœê°€ ë©ë‹ˆë‹¤.</p>
                        <p>- ë°˜ë“œì‹œ **'ê³„ì • ìƒì„±'** ë²„íŠ¼ì„ ëˆŒëŸ¬ í…ŒìŠ¤íŠ¸ ê³„ì •ì„ ë§Œë“¤ì–´ì•¼ ì •ìƒì ìœ¼ë¡œ ì´ìš© ê°€ëŠ¥í•©ë‹ˆë‹¤.</p>
                    </div>
                </form>
            </div>
        </div>


        <!-- 3 & 4. ë©”ì¸ ì•± ì½˜í…ì¸  (ì¸ì¦ ìƒíƒœì— ë”°ë¼ ìˆ¨ê¹€/í‘œì‹œ) -->
        <div id="app-content" class="flex flex-col flex-grow hidden">
            <!-- 3. ì¬ì • í˜„í™©íŒ (ì‹¤ì‹œê°„ ë°ì´í„° ë°˜ì˜) -->
            <div class="classic-frame bg-white p-2 mb-3 border-2 border-[#808080] flex-shrink-0">
                <div class="classic-title-bar text-xs mb-1">
                    [ì›”ê°„ ì¬ì • ì§‘ê³„ í˜„í™©] (<span id="summary-month-year">2025ë…„ 11ì›”</span> ê¸°ì¤€)
                </div>
                <div class="grid grid-cols-3 gap-4 text-center p-2 bg-[#D3D3D3]">
                    <div class="classic-frame p-2 bg-green-50">
                        <div class="text-xs text-gray-600 font-bold">ì›”ê°„ ì´ ìˆ˜ì…ì•¡ (+)</div>
                        <div class="text-lg font-extrabold text-green-700" id="total-income">ï¿¦ 0</div>
                    </div>
                    <div class="classic-frame p-2 bg-red-50">
                        <div class="text-xs text-gray-600 font-bold">ì›”ê°„ ì´ ì§€ì¶œì•¡ (-)</div>
                        <div class="text-lg font-extrabold text-red-700" id="total-expense">ï¿¦ 0</div>
                    </div>
                    <div class="classic-frame p-2 bg-yellow-50">
                        <div class="text-xs text-gray-600 font-bold">ì›”ê°„ ìˆœ ì”ì•¡</div>
                        <div class="text-lg font-extrabold text-blue-700" id="net-balance">ï¿¦ 0</div>
                    </div>
                </div>
            </div>
            
            <!-- 4. ë©”ì¸ ì‘ì—… ì˜ì—­ -->
            <div class="content-area-wrapper flex flex-grow">
                
                <!-- 4.1. ì¢Œì¸¡ ë©”ë‰´ (ì›”ë³„ ê¸°ë¡ íƒìƒ‰ê¸°) -->
                <aside class="w-64 bg-white border border-[#BDBDBD] mr-3 overflow-auto flex-shrink-0">
                    <div class="classic-title-bar text-xs">
                        [ì›”ë³„ ê¸°ë¡ íƒìƒ‰ê¸°]
                    </div>
                    <ul class="p-1 text-sm space-y-1" id="month-explorer-list">
                        <!-- ë™ì ìœ¼ë¡œ ë‚´ìš©ì´ ì±„ì›Œì§‘ë‹ˆë‹¤. -->
                        <li class="p-1 text-gray-500">ê±°ë˜ ë‚´ì—­ ë¡œë“œ ì¤‘...</li>
                    </ul>
                </aside>
                
                <!-- 4.2. ë©”ì¸ ì‘ì—… ì˜ì—­ -->
                <main class="flex-grow bg-[#F0F0F0] p-4 border border-[#BDBDBD] flex flex-col">
                    <div class="classic-title-bar text-sm mb-3 flex-shrink-0">
                        [ê±°ë˜ ë‚´ì—­ ì…ë ¥ ë° ë“±ë¡] - ê¸°ì¤€ ì¼ì: <span id="current-transaction-date-display">2025-11-08</span>
                    </div>

                    <!-- ì§€ì¶œ/ìˆ˜ì… ë“±ë¡ í”„ë ˆì„ -->
                    <div class="classic-frame bg-white p-3 mb-4 shadow-inner border border-[#BDBDBD] flex-shrink-0">
                        <h2 class="text-sm font-bold mb-2">â‘  ê±°ë˜ ë‚´ì—­ ë“±ë¡</h2>
                        <div class="grid grid-cols-4 gap-x-4 gap-y-2">
                            
                            <!-- 1. ì¼ì -->
                            <label class="col-span-1 flex items-center font-bold">ì¼ì:</label>
                            <div class="col-span-3 flex classic-input p-0 relative" id="dateInputContainer">
                                <input type="text" id="transaction-date" value="2025-11-08" readonly class="table-input flex-grow cursor-pointer" style="box-shadow: none;">
                                <button id="calendar-toggle-button" class="classic-button px-2 py-0 border-none" style="border: none; margin: -1px; background-color: #D3D3D3;">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-black" viewBox="0 0 20 20" fill="currentColor">
                                        <path fill-rule="evenodd" d="M6 2a1 1 0 00-1 1v1H4a2 2 0 00-2 2v10a2 2 0 002 2h12a2 2 0 002-2V6a2 2 0 00-2-2h-1V3a1 1 0 10-2 0v1H7V3a1 1 0 00-1-1zm0 5a1 1 0 000 2h8a1 1 0 100-2H6z" clip-rule="evenodd" />
                                    </svg>
                                </button>
                                <!-- Custom Calendar UI -->
                                <div id="custom-calendar" class="absolute z-10 top-full right-0 mt-1 hidden w-64 classic-frame p-1 bg-white shadow-xl" style="border: 2px solid #0000AA;">
                                    <div class="classic-title-bar flex justify-between items-center text-xs mb-1">
                                        <button class="text-xs classic-button px-1" id="prev-month-button">&#9664;</button>
                                        <span id="calendar-month-year"></span>
                                        <button class="text-xs classic-button px-1" id="next-month-button">&#9654;</button>
                                    </div>
                                    <table class="w-full text-center text-xs border border-collapse border-[#808080]">
                                        <thead class="bg-[#DFDFDF]">
                                            <tr><th class="border border-[#808080] p-1 w-[8%]">ì¼</th><th class="border border-[#808080]">ì›”</th><th class="border border-[#808080]">í™”</th><th class="border border-[#808080]">ìˆ˜</th><th class="border border-[#808080]">ëª©</th><th class="border border-[#808080]">ê¸ˆ</th><th class="border border-[#808080] text-blue-600">í† </th></tr>
                                        </thead>
                                        <tbody id="calendar-days"></tbody>
                                    </table>
                                </div>
                            </div>
                            
                            <!-- 2. êµ¬ë¶„ & ê¸ˆì•¡ -->
                            <label class="col-span-1 flex items-center font-bold">êµ¬ë¶„/ê¸ˆì•¡:</label>
                            <div class="col-span-3 flex space-x-2">
                                <select id="transaction-type" class="classic-input w-1/3 bg-yellow-100">
                                    <option value="expense">ì§€ì¶œ (-)</option>
                                    <option value="income">ìˆ˜ì… (+)</option>
                                </select>
                                <input type="text" id="transaction-amount" placeholder="ê¸ˆì•¡ (ìˆ«ìë§Œ ì…ë ¥)" class="classic-input w-2/3 text-right" required>
                            </div>

                            <!-- 3. ê²°ì œ ìˆ˜ë‹¨ (Method) -->
                            <label class="col-span-1 flex items-center font-bold">ê²°ì œ ìˆ˜ë‹¨:</label>
                            <div class="col-span-3 flex">
                                <select id="transaction-method" class="classic-input w-full">
                                    <option value="í˜„ê¸ˆ">í˜„ê¸ˆ</option>
                                    <option value="ì¹´ë“œ">ì¹´ë“œ</option>
                                    <option value="ê³„ì¢Œì´ì²´">ê³„ì¢Œì´ì²´</option>
                                    <option value="ê¸°íƒ€">ê¸°íƒ€</option>
                                </select>
                            </div>


                            <!-- 4. ì ìš” (ë‚´ìš©) -->
                            <label class="col-span-1 flex items-center font-bold">ë‚´ìš©:</label>
                            <input type="text" id="transaction-memo" placeholder="ê°„ë‹¨í•œ ê±°ë˜ ë‚´ì—­ ê¸°ë¡" class="col-span-3 classic-input w-full" required>
                        </div>
                        
                        <div class="flex justify-end mt-4 space-x-2">
                            <button id="register-button" class="px-4 py-1 classic-button font-bold text-blue-800">
                                ê¸°ë¡ ë“±ë¡ (A)
                            </button>
                            <button id="reset-button" class="px-4 py-1 classic-button">
                                ì´ˆê¸°í™”
                            </button>
                        </div>
                    </div>

                    <!-- íƒ­ ë©”ë‰´ -->
                    <div class="flex space-x-0.5 -mb-px flex-shrink-0">
                        <div class="px-3 py-1 classic-button border-b-0 classic-active-menu bg-white text-black font-bold">ì›”ë³„ ê¸°ë¡ ëª©ë¡</div>
                        <div class="px-3 py-1 classic-button border-b-0">ìì‚° ê³„ì • ê´€ë¦¬</div>
                    </div>
                    
                    <!-- ìƒì„¸ ë‚´ì—­ í‘œ (ìŠ¤í¬ë¡¤ ì˜ì—­) -->
                    <div class="border border-[#808080] bg-white overflow-auto flex-grow">
                        <table class="w-full text-sm">
                            <thead class="bg-[#BDBDBD] text-black sticky top-0">
                                <tr>
                                    <th class="border border-[#808080] p-1 w-[8%]">No.</th>
                                    <th class="border border-[#808080] p-1 w-[18%]">ë‚ ì§œ</th>
                                    <th class="border border-[#808080] p-1 w-[14%]">ìˆ˜ë‹¨</th>
                                    <th class="border border-[#808080] p-1 w-[42%]">ë‚´ìš©</th>
                                    <th class="border border-[#808080] p-1 w-[12%]">ê¸ˆì•¡ (ì›)</th>
                                    <th class="border border-[#808080] p-1 w-[6%]">ì•¡ì…˜</th>
                                </tr>
                            </thead>
                            <tbody id="transaction-list-body">
                                <!-- ê±°ë˜ ë°ì´í„°ê°€ ì—¬ê¸°ì— ì‚½ì…ë©ë‹ˆë‹¤ -->
                                <tr class="data-row"><td class="border p-1 text-center" colspan="6">ê±°ë˜ ë‚´ì—­ ë¡œë“œ ì¤‘...</td></tr>
                            </tbody>
                            <tfoot>
                                <tr class="bg-[#DFDFDF] font-bold">
                                    <td class="border p-1 text-right" colspan="4">ì›” í•©ê³„ ì”ì•¡:</td>
                                    <td class="border p-1 text-right text-green-800" id="monthly-net-balance-footer">0</td>
                                    <td class="border"></td>
                                </tr>
                            </tfoot>
                        </table>
                    </div>
                    
                    <!-- í•˜ë‹¨ ë²„íŠ¼ ê·¸ë£¹/ìƒíƒœ í‘œì‹œì¤„ -->
                    <div class="mt-4 flex justify-center space-x-4 p-2 bg-[#D3D3D3] border border-[#808080] shadow-inner flex-shrink-0">
                        <button id="report-button" class="px-4 py-2 classic-button font-bold text-black bg-yellow-400">ë³´ê³ ì„œ ì¶œë ¥ (P)</button>
                        <button id="excel-button" class="px-4 py-2 classic-button font-bold text-green-700">ì—‘ì…€ ì €ì¥ (E)</button>
                        <button id="share-button" class="px-4 py-2 classic-button font-bold text-blue-700">ë¶€ëª¨ë‹˜ì—ê²Œ ì „ë‹¬ (S)</button>
                    </div>

                    <!-- ë³´ê³ ì„œ ì¶œë ¥ ê²°ê³¼ ì˜ì—­ (ìˆ¨ê²¨ì ¸ ìˆìŒ) -->
                    <div id="report-output-container" class="classic-frame mt-4 hidden bg-white p-3 flex-shrink-0">
                        <div class="classic-title-bar text-xs mb-2 flex justify-between items-center">
                            <span>[ì›”ê°„ ë³´ê³ ì„œ ë¯¸ë¦¬ë³´ê¸°] - <span id="report-month-display"></span></span>
                            <button class="classic-button px-2 py-0.5 text-xs" onclick="document.getElementById('report-output-container').classList.add('hidden')">ë‹«ê¸°</button>
                        </div>
                        <pre id="report-output-area"></pre>
                    </div>

                </main>
            </div>
        </div>
        <!-- ì‹œìŠ¤í…œ ìƒíƒœ ë©”ì‹œì§€ëŠ” ë¡œê·¸ì¸ ìƒíƒœì™€ ìƒê´€ì—†ì´ í‘œì‹œ -->
        <div class="mt-4 text-xs p-1 classic-frame bg-white border border-[#BDBDBD] shadow-inner flex-shrink-0" id="status-message">
            [ì‹œìŠ¤í…œ ìƒíƒœ]: Firebase ë¡œë“œ ì¤‘...
        </div>

    </div>

    <!-- ê³µìœ  ëª¨ë‹¬ (Share Modal) -->
    <div id="share-modal" class="modal-backdrop hidden">
        <div class="classic-frame bg-white p-6 w-full max-w-lg shadow-2xl" style="border: 2px solid #0000AA;">
            <div class="classic-title-bar text-sm mb-4 flex justify-between items-center">
                <span>[ìš©ëˆê¸°ì…ì¥ ê³µìœ í•˜ê¸°]</span>
                <button id="modal-close-button" class="classic-button px-2 py-0.5 text-xs">X</button>
            </div>
            
            <p class="text-sm font-bold mb-3 text-red-700">âš ï¸ ê³µìœ í•  ì›”: <span id="share-month-display"></span>ì˜ ê¸°ë¡ë§Œ ê³µê°œë©ë‹ˆë‹¤.</p>
            
            <div id="share-input-section">
                <label class="block text-xs font-bold mb-1">ë¶€ëª¨ë‹˜ ì „í™”ë²ˆí˜¸:</label>
                <input type="text" id="parent-phone-number" placeholder="'-' ì—†ì´ ìˆ«ìë§Œ ì…ë ¥ (ì˜ˆ: 01012345678)" class="classic-input w-full mb-4">
                <p id="share-status-message" class="text-xs text-gray-600 mb-4"></p>
                <button id="share-submit-button" class="px-4 py-1 classic-button font-bold text-blue-800 w-full">
                    ê³µìœ  ë³´ê³ ì„œ ìƒì„± (ë°ì´í„° ì €ì¥)
                </button>
            </div>

            <div id="share-result-section" class="hidden mt-4 p-3 classic-frame bg-green-50">
                <p class="font-bold text-sm text-green-800 mb-2">âœ… ê³µìœ  ë³´ê³ ì„œê°€ ì„±ê³µì ìœ¼ë¡œ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤!</p>
                <p class="text-xs mb-3">ğŸ“ ë¶€ëª¨ë‹˜ ì „í™”ë²ˆí˜¸ (<span id="simulated-phone"></span>)ë¡œ ì•„ë˜ ë§í¬ê°€ ë°œì†¡ë  ì˜ˆì •ì…ë‹ˆë‹¤. **ì•„ë˜ ë²„íŠ¼ì„ ëˆ„ë¥´ë©´ ë©”ì‹œì§€ ì•±ìœ¼ë¡œ ì´ë™í•©ë‹ˆë‹¤.**</p>
                
                <label class="block text-xs font-bold mb-1">ê³µìœ  ë§í¬ (ë³µì‚¬í•´ì„œ ì „ë‹¬í•˜ì„¸ìš”):</label>
                <input type="text" id="generated-share-link" class="classic-input w-full text-xs bg-yellow-100" readonly>
                
                <a id="send-message-button" href="#" class="mt-4 px-4 py-2 classic-button font-bold text-white bg-green-600 hover:bg-green-700 block text-center border-none">
                    [ë©”ì‹œì§€ ì•±ìœ¼ë¡œ ì´ë™í•˜ì—¬] ë¶€ëª¨ë‹˜ê»˜ ê³µìœ  ë§í¬ ì „ë‹¬
                </a>
                
                <p class="mt-3 text-xs text-blue-700">ì´ ë§í¬ëŠ” í˜„ì¬ ì›”ì˜ ê±°ë˜ ë‚´ì—­ì„ ë³¼ ìˆ˜ ìˆëŠ” (ì‹œë®¬ë ˆì´ì…˜ëœ) *ì½ê¸° ì „ìš© ë·°*ì…ë‹ˆë‹¤.</p>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { 
            getAuth, 
            onAuthStateChanged, 
            signOut,
            signInWithEmailAndPassword,
            createUserWithEmailAndPassword,
            signInWithCustomToken
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { 
            getFirestore, 
            doc, 
            addDoc, 
            onSnapshot, 
            collection, 
            query, 
            deleteDoc,
            setDoc, // setDoc ì¶”ê°€ (ê³µìœ  ë°ì´í„° ì €ì¥ìš©)
            setLogLevel 
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        setLogLevel('Debug');
        
        // --- Firebase/Auth/Global Setup ---
        // ì‚¬ìš©ì ìš”ì²­ì— ë”°ë¼ Firebase ì„¤ì •ì„ ì§ì ‘ ì •ì˜í•©ë‹ˆë‹¤.
        const firebaseConfig = {
            apiKey: "AIzaSyCgZL83YJIM0iXXRttTmoeyJvekBBkOhX4",
            authDomain: "k-chulnap.firebaseapp.com",
            projectId: "k-chulnap",
            storageBucket: "k-chulnap.firebasestorage.app",
            messagingSenderId: "169980642255",
            appId: "1:169980642255:web:572c781aa6b010de6e08ba",
            measurementId: "G-49GQLQ5HLC"
        };
        // Canvas í™˜ê²½ ë³€ìˆ˜ ëŒ€ì‹  projectIdë¥¼ ì‚¬ìš©í•˜ì—¬ appIdë¥¼ ì„¤ì •í•©ë‹ˆë‹¤.
        const appId = firebaseConfig.projectId; 
        
        let app;
        let db;
        let auth;
        let userId = null;
        let allTransactions = []; 
        
        // ì´ˆê¸° ë‚ ì§œë¥¼ 2025ë…„ 11ì›” 8ì¼ë¡œ ì„¤ì •
        const TODAY = new Date('2025-11-08'); 
        let currentMonthFilter = '2025-11'; 
        let unsubscribeFromFirestore = null; 
        
        // UI Elements
        const userInfoElement = document.getElementById('user-info');
        const statusElement = document.getElementById('status-message');
        const listBody = document.getElementById('transaction-list-body');
        const registerButton = document.getElementById('register-button');
        const resetButton = document.getElementById('reset-button');
        const appContent = document.getElementById('app-content');
        const authView = document.getElementById('auth-view');
        const logoutButton = document.getElementById('logout-button');
        const menuBar = document.getElementById('menu-bar');
        const monthExplorerList = document.getElementById('month-explorer-list'); 

        // Auth Elements
        const authForm = document.getElementById('auth-form');
        const authEmailInput = document.getElementById('auth-email');
        const authPasswordInput = document.getElementById('auth-password');
        const loginButton = document.getElementById('login-button');
        const signupButton = document.getElementById('signup-button');
        const authErrorMessage = document.getElementById('auth-error-message');
        const authLoading = document.getElementById('auth-loading');
        
        // Transaction Input Elements
        const dateInput = document.getElementById('transaction-date');
        const typeSelect = document.getElementById('transaction-type');
        const amountInput = document.getElementById('transaction-amount');
        const methodSelect = document.getElementById('transaction-method'); 
        const memoInput = document.getElementById('transaction-memo');
        const dateDisplay = document.getElementById('current-transaction-date-display');

        // Summary Elements
        const incomeEl = document.getElementById('total-income');
        const expenseEl = document.getElementById('total-expense');
        const netBalanceEl = document.getElementById('net-balance');
        const footerNetBalanceEl = document.getElementById('monthly-net-balance-footer');
        const summaryMonthYearEl = document.getElementById('summary-month-year');
        
        // New Feature Elements
        const reportOutputContainer = document.getElementById('report-output-container');
        const reportOutputArea = document.getElementById('report-output-area');
        const reportMonthDisplay = document.getElementById('report-month-display');
        const shareModal = document.getElementById('share-modal');
        const shareMonthDisplay = document.getElementById('share-month-display');
        const parentPhoneNumberInput = document.getElementById('parent-phone-number');
        const shareStatusMessage = document.getElementById('share-status-message');
        const shareResultSection = document.getElementById('share-result-section');
        const shareInputSection = document.getElementById('share-input-section');
        const generatedShareLink = document.getElementById('generated-share-link');
        const simulatedPhone = document.getElementById('simulated-phone');
        const sendMessageButton = document.getElementById('send-message-button'); // ì¶”ê°€ë¨


        // Helper for Currency Formatting
        const formatCurrency = (amount) => {
            const sign = amount < 0 ? 'ï¿¦ -' : 'ï¿¦ ';
            return sign + Math.abs(amount).toLocaleString('ko-KR');
        };
        const formatNumber = (amount) => {
            return amount.toLocaleString('ko-KR');
        };

        // Helper for Status Messages
        const setStatus = (message, isError = false) => {
            statusElement.innerHTML = `[ì‹œìŠ¤í…œ ìƒíƒœ]: ${isError ? 'ì˜¤ë¥˜: ' : ''}${message}`;
            if (isError) {
                statusElement.classList.add('error-status');
                console.error(message);
            } else {
                statusElement.classList.remove('error-status');
                console.log(message);
            }
        };

        // UUID Generator (for unique share IDs)
        function generateUUID() {
            return crypto.randomUUID();
        }

        function setAuthLoading(isLoading, error = null) {
            authLoading.classList.toggle('hidden', !isLoading);
            authForm.classList.toggle('hidden', isLoading);
            authErrorMessage.textContent = error || '';
            
            loginButton.disabled = isLoading;
            signupButton.disabled = isLoading;
        }

        async function initFirebase() {
            try {
                if (!firebaseConfig || Object.keys(firebaseConfig).length === 0) {
                    setStatus("Firebase ì„¤ì •ì´ ì˜¬ë°”ë¥´ì§€ ì•Šì•„ ì´ˆê¸°í™”í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.", true);
                    return;
                }
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                
                // ì „ì—­ ë³€ìˆ˜ ëŒ€ì‹  nullë¡œ ì„¤ì •í•˜ì—¬ ì»¤ìŠ¤í…€ í† í° ì¸ì¦ ì‹œë„ë¥¼ ê±´ë„ˆëœë‹ˆë‹¤.
                const initialAuthToken = null; // typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
                
                // ìµëª… ë¡œê·¸ì¸ ì—†ì´, ì´ˆê¸° í† í°ë§Œ ì‹œë„í•˜ê³  ì‹¤íŒ¨í•˜ë©´ ë¡œê·¸ì¸ í™”ë©´ ìœ ì§€
                if (initialAuthToken) {
                    try {
                        await signInWithCustomToken(auth, initialAuthToken);
                        setStatus("ì´ˆê¸° ì¸ì¦ í† í°ìœ¼ë¡œ ìë™ ë¡œê·¸ì¸ ì„±ê³µ.");
                    } catch (e) {
                        console.warn("ì»¤ìŠ¤í…€ í† í° ë¡œê·¸ì¸ ì‹¤íŒ¨. ìˆ˜ë™ ë¡œê·¸ì¸ í•„ìš”.", e.message);
                        setStatus("ì´ˆê¸° ì¸ì¦ í† í° ì‹¤íŒ¨. ì´ë©”ì¼/ë¹„ë°€ë²ˆí˜¸ë¡œ ë¡œê·¸ì¸í•˜ê±°ë‚˜ ê³„ì •ì„ ë§Œë“œì„¸ìš”.", true);
                    }
                } else {
                    setStatus("ìë™ ì¸ì¦ í† í° ì—†ìŒ. ì´ë©”ì¼/ë¹„ë°€ë²ˆí˜¸ë¡œ ë¡œê·¸ì¸í•˜ê±°ë‚˜ ê³„ì •ì„ ë§Œë“œì„¸ìš”.");
                }

                onAuthStateChanged(auth, handleAuthStateChange);

            } catch (error) {
                console.error("Firebase ì´ˆê¸°í™” ì˜¤ë¥˜:", error);
                setStatus(`Firebase ì´ˆê¸°í™” ì‹¤íŒ¨. (${error.message})`, true);
            }
        }
        
        // --- AUTH LOGIC (Actual Login) ---
        function handleAuthStateChange(user) {
            if (user) {
                // ë¡œê·¸ì¸ ìƒíƒœ
                userId = user.uid;
                userInfoElement.innerHTML = `ì‚¬ìš©ì ID: ${userId.substring(0, 8)}... | ì ‘ì† ì¼ì: ${new Date().toLocaleDateString('ko-KR')}`;
                setStatus(`ë¡œê·¸ì¸ ì„±ê³µ. ì‚¬ìš©ì: ${userId.substring(0, 8)}... ë°ì´í„° ë¡œë“œë¥¼ ì‹œì‘í•©ë‹ˆë‹¤.`);
                
                authView.classList.add('hidden');
                appContent.classList.remove('hidden');
                logoutButton.classList.remove('hidden');
                menuBar.classList.remove('hidden');
                
                loadAllTransactions(); // ì¸ì¦ ì™„ë£Œ í›„ ëª¨ë“  ë°ì´í„° ë¡œë“œ ì‹œì‘
            } else {
                // ë¡œê·¸ì•„ì›ƒ ìƒíƒœ
                userId = null;
                allTransactions = [];
                userInfoElement.innerHTML = `ì‚¬ìš©ì ID: (ë¡œê·¸ì•„ì›ƒë¨)`;
                setStatus("ë¡œê·¸ì•„ì›ƒ ìƒíƒœì…ë‹ˆë‹¤. ì´ë©”ì¼/ë¹„ë°€ë²ˆí˜¸ë¡œ ë¡œê·¸ì¸í•´ì£¼ì„¸ìš”.", true);
                
                authView.classList.remove('hidden');
                appContent.classList.add('hidden');
                logoutButton.classList.add('hidden');
                menuBar.classList.add('hidden');

                if (unsubscribeFromFirestore) {
                    unsubscribeFromFirestore();
                    unsubscribeFromFirestore = null;
                }
                
                listBody.innerHTML = `<tr class="data-row"><td class="border p-2 text-center text-red-500" colspan="6">ë¡œê·¸ì¸ ìƒíƒœê°€ ì•„ë‹™ë‹ˆë‹¤. ê±°ë˜ ë‚´ì—­ì„ ë³¼ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</td></tr>`;
                updateSummary(0, 0); 
                monthExplorerList.innerHTML = `<li class="p-1 text-gray-500">ë¡œê·¸ì¸ í•„ìš”</li>`;
            }
            setAuthLoading(false);
        }

        async function handleAuthAction(isSignUp) {
            const email = authEmailInput.value.trim();
            const password = authPasswordInput.value;
            
            if (!email || !password) {
                authErrorMessage.textContent = "ì´ë©”ì¼ê³¼ ë¹„ë°€ë²ˆí˜¸ë¥¼ ëª¨ë‘ ì…ë ¥í•´ì£¼ì„¸ìš”.";
                return;
            }

            setAuthLoading(true);
            authErrorMessage.textContent = '';

            try {
                if (isSignUp) {
                    await createUserWithEmailAndPassword(auth, email, password);
                    setStatus("íšŒì›ê°€ì… ë° ìë™ ë¡œê·¸ì¸ ì„±ê³µ!");
                } else {
                    await signInWithEmailAndPassword(auth, email, password);
                    setStatus("ë¡œê·¸ì¸ ì„±ê³µ!");
                }
                // onAuthStateChangedê°€ ë‚˜ë¨¸ì§€ë¥¼ ì²˜ë¦¬í•©ë‹ˆë‹¤.

            } catch (error) {
                setAuthLoading(false, `ì¸ì¦ ì˜¤ë¥˜: ${authErrorToKorean(error.code)}`);
                console.error("ì¸ì¦ ì˜¤ë¥˜:", error.message);
            }
        }
        
        function authErrorToKorean(code) {
            switch (code) {
                case 'auth/invalid-email': return 'ìœ íš¨í•˜ì§€ ì•Šì€ ì´ë©”ì¼ í˜•ì‹ì…ë‹ˆë‹¤.';
                case 'auth/user-disabled': return 'ë¹„í™œì„±í™”ëœ ì‚¬ìš©ì ê³„ì •ì…ë‹ˆë‹¤.';
                case 'auth/user-not-found': return 'ë“±ë¡ë˜ì§€ ì•Šì€ ì´ë©”ì¼ì…ë‹ˆë‹¤.';
                case 'auth/wrong-password': return 'ë¹„ë°€ë²ˆí˜¸ê°€ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.';
                case 'auth/email-already-in-use': return 'ì´ë¯¸ ì‚¬ìš© ì¤‘ì¸ ì´ë©”ì¼ì…ë‹ˆë‹¤.';
                case 'auth/weak-password': return 'ë¹„ë°€ë²ˆí˜¸ëŠ” 6ìë¦¬ ì´ìƒì´ì–´ì•¼ í•©ë‹ˆë‹¤.';
                case 'auth/operation-not-allowed': return 'ì´ë©”ì¼/ë¹„ë°€ë²ˆí˜¸ ë¡œê·¸ì¸ì´ í™œì„±í™”ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.';
                default: return `ì•Œ ìˆ˜ ì—†ëŠ” ì¸ì¦ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤ (${code}).`;
            }
        }
        
        function handleLogout() {
            if (auth) {
                signOut(auth).then(() => {
                    setStatus("ì„±ê³µì ìœ¼ë¡œ ë¡œê·¸ì•„ì›ƒë˜ì—ˆìŠµë‹ˆë‹¤.");
                }).catch((error) => {
                    setStatus(`ë¡œê·¸ì•„ì›ƒ ì˜¤ë¥˜: ${error.message}`, true);
                });
            }
        }
        
        // --- Transaction Logic ---
        function loadAllTransactions() {
            if (!userId || !db) { return; }
            
            const transactionsColRef = collection(db, `artifacts/${appId}/users/${userId}/transactions`);
            const q = query(transactionsColRef);

            if (unsubscribeFromFirestore) {
                unsubscribeFromFirestore();
            }

            // ëª¨ë“  ê±°ë˜ ë‚´ì—­ì„ ì‹¤ì‹œê°„ìœ¼ë¡œ ê°€ì ¸ì™€ allTransactions ë°°ì—´ì— ì €ì¥
            unsubscribeFromFirestore = onSnapshot(q, (snapshot) => {
                allTransactions = [];
                snapshot.forEach(doc => {
                    allTransactions.push({ id: doc.id, ...doc.data() });
                });
                
                // ë°ì´í„°ê°€ ë³€ê²½ë  ë•Œë§ˆë‹¤ ì‚¬ì´ë“œë°”ì™€ ëª©ë¡ì„ ëª¨ë‘ ì—…ë°ì´íŠ¸
                renderMonthExplorer();
                filterAndRenderTransactions(currentMonthFilter);
                
            }, (error) => {
                console.error("ê±°ë˜ ëª©ë¡ ë¡œë“œ ì˜¤ë¥˜:", error);
                setStatus('ê±°ë˜ ëª©ë¡ ë¡œë“œ ì‹¤íŒ¨. (ë„¤íŠ¸ì›Œí¬ ë˜ëŠ” ê¶Œí•œ í™•ì¸ í•„ìš”)', true);
                listBody.innerHTML = `<tr class="data-row"><td class="border p-2 text-center text-red-700" colspan="6">ğŸš¨ ë°ì´í„° ë¡œë“œ ì˜¤ë¥˜.</td></tr>`;
            });
        }
        
        // --- ì‚¬ì´ë“œë°” ë° ëª©ë¡ í•„í„°ë§ í•¨ìˆ˜ ---

        // ì›”ë³„ë¡œ ë°ì´í„°ë¥¼ í•„í„°ë§í•˜ê³  UIë¥¼ ì—…ë°ì´íŠ¸í•˜ëŠ” í•¨ìˆ˜
        function filterAndRenderTransactions(monthFilter) {
            currentMonthFilter = monthFilter;

            const filteredTransactions = allTransactions.filter(tx => 
                tx.date.startsWith(monthFilter)
            );

            let totalIncome = 0;
            let totalExpense = 0;

            filteredTransactions.forEach(tx => {
                if (tx.amount > 0) {
                    totalIncome += tx.amount;
                } else {
                    totalExpense += tx.amount;
                }
            });

            // ì •ë ¬ (ìµœì‹ ìˆœ)
            filteredTransactions.sort((a, b) => {
                if (a.date === b.date) {
                    return b.timestamp - a.timestamp; 
                }
                return b.date.localeCompare(a.date); 
            });

            renderTransactionList(filteredTransactions);
            updateSummary(totalIncome, totalExpense);
            setStatus(`í•„í„°ë§ëœ ê±°ë˜ ë‚´ì—­ (${monthFilter}): ì´ ${filteredTransactions.length}ê±´`);
            
            // ì‚¬ì´ë“œë°”ì˜ í™œì„±í™” ìƒíƒœ ì—…ë°ì´íŠ¸
            document.querySelectorAll('.month-nav-link').forEach(el => {
                el.classList.remove('classic-active-menu');
                if (el.dataset.month === monthFilter) {
                    el.classList.add('classic-active-menu');
                }
            });

            // ë³´ê³ ì„œ/ì—‘ì…€ì— ì‚¬ìš©ë  í˜„ì¬ í•„í„°ë§ëœ ë°ì´í„° ë°˜í™˜
            return filteredTransactions;
        }

        // --- ê¸°íƒ€ UI/Render í•¨ìˆ˜ë“¤ì€ ìƒëµ ---
        function updateSummary(income, expense) {
            const netBalance = income + expense;
            const year = currentMonthFilter.substring(0, 4);
            const month = currentMonthFilter.substring(5, 7);

            incomeEl.textContent = formatCurrency(income);
            expenseEl.textContent = formatCurrency(expense);
            netBalanceEl.textContent = formatCurrency(netBalance);
            footerNetBalanceEl.textContent = netBalance.toLocaleString('ko-KR');

            summaryMonthYearEl.textContent = `${year}ë…„ ${month}ì›”`;
        }
        function renderMonthExplorer() { /* ... ê¸°ì¡´ê³¼ ë™ì¼ ... */ 
            monthExplorerList.innerHTML = '';

            if (allTransactions.length === 0) {
                 monthExplorerList.innerHTML = `<li class="p-1 text-gray-500">ë“±ë¡ëœ ê±°ë˜ê°€ ì—†ìŠµë‹ˆë‹¤.</li>`;
                 return;
            }

            const months = [...new Set(allTransactions.map(tx => tx.date.substring(0, 7)))];
            months.sort().reverse(); 

            const years = [...new Set(months.map(m => m.substring(0, 4)))];
            years.sort().reverse();

            let outputHtml = '';

            years.forEach(year => {
                outputHtml += `
                    <li class="p-1 font-bold flex items-center year-toggle" data-year="${year}">
                        <span class="mr-1 year-icon">â–¼</span> ${year}ë…„ ê¸°ë¡
                    </li>
                `;
                
                const yearMonths = months.filter(m => m.startsWith(year));
                yearMonths.forEach(month => {
                    const monthName = month.substring(5, 7);
                    const isActive = month === currentMonthFilter;
                    
                    outputHtml += `
                        <li class="pl-4 cursor-pointer month-nav-link ${isActive ? 'classic-active-menu font-bold text-black' : 'hover:bg-gray-200'}" 
                            data-month="${month}">
                            ã„´ ${monthName}ì›”
                        </li>
                    `;
                });
            });

            monthExplorerList.innerHTML = outputHtml;
            
            monthExplorerList.querySelectorAll('.month-nav-link').forEach(link => {
                link.addEventListener('click', (e) => {
                    filterAndRenderTransactions(e.target.dataset.month);
                });
            });
        }
        function renderTransactionList(transactions) { /* ... ê¸°ì¡´ê³¼ ë™ì¼ ... */
             listBody.innerHTML = '';
            
            if (transactions.length === 0) {
                listBody.innerHTML = `<tr class="data-row"><td class="border p-2 text-center text-gray-500" colspan="6">ì„ íƒí•œ ì›”ì— ë“±ë¡ëœ ê±°ë˜ ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤.</td></tr>`;
                return;
            }
            
            transactions.forEach((tx, index) => {
                const isIncome = tx.amount > 0;
                const rowClass = isIncome ? 'bg-green-50' : '';
                const amountClass = isIncome ? 'text-green-600' : 'text-red-600';
                const displayAmount = Math.abs(tx.amount).toLocaleString('ko-KR');

                const row = document.createElement('tr');
                row.className = `data-row hover:bg-blue-100 ${rowClass}`;
                row.innerHTML = `
                    <td class="border p-1 text-center">${transactions.length - index}</td>
                    <td class="border p-1"><span class="block px-1">${tx.date}</span></td>
                    <td class="border p-1"><span class="block px-1">${tx.method}</span></td>
                    <td class="border p-1"><span class="block px-1">${tx.memo}</span></td>
                    <td class="border text-right ${amountClass} p-1"><span class="block px-1">${isIncome ? '+' : '-'}${displayAmount}</span></td>
                    <td class="border text-center">
                        <button class="text-xs text-red-500 hover:text-red-800 delete-btn classic-button px-1" data-id="${tx.id}">ì‚­ì œ</button>
                    </td>
                `;
                listBody.appendChild(row);
            });
            
            listBody.querySelectorAll('.delete-btn').forEach(button => {
                button.addEventListener('click', (e) => {
                    const docId = e.target.getAttribute('data-id');
                    deleteTransaction(docId);
                });
            });
        }

        // --- CRUD Operations ---
        function resetForm() { /* ... ê¸°ì¡´ê³¼ ë™ì¼ ... */
            amountInput.value = '';
            memoInput.value = '';
            typeSelect.value = 'expense';
            if (methodSelect) methodSelect.value = 'í˜„ê¸ˆ'; 
            setStatus("ì…ë ¥ í•„ë“œë¥¼ ì´ˆê¸°í™”í–ˆìŠµë‹ˆë‹¤.");
        }
        async function saveTransaction() { /* ... ê¸°ì¡´ê³¼ ë™ì¼ ... */
            if (!userId || !db) {
                setStatus('ì¸ì¦ë˜ì§€ ì•Šì€ ì‚¬ìš©ìì…ë‹ˆë‹¤. ê¸°ë¡ ë“±ë¡ ë¶ˆê°€.', true);
                return;
            }
            
            const date = dateInput.value;
            const type = typeSelect.value;
            const rawAmount = amountInput.value.replace(/[^0-9.]/g, ''); 
            const method = methodSelect.value; 
            const memo = memoInput.value.trim();

            if (!date || !rawAmount || !memo) {
                setStatus("ëª¨ë“  í•„ë“œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”. (ë‚ ì§œ, ê¸ˆì•¡, ë‚´ìš©)", true);
                return;
            }
            
            const amount = parseFloat(rawAmount);
            if (isNaN(amount) || amount <= 0) {
                setStatus("ìœ íš¨í•œ ê¸ˆì•¡ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.", true);
                return;
            }

            const finalAmount = type === 'expense' ? -amount : amount;

            const transactionData = {
                date,
                type, 
                amount: finalAmount,
                method,
                memo,
                timestamp: new Date().getTime(),
            };

            try {
                const transactionsColRef = collection(db, `artifacts/${appId}/users/${userId}/transactions`);
                await addDoc(transactionsColRef, transactionData);
                
                const newMonth = date.substring(0, 7);
                if (newMonth !== currentMonthFilter) {
                    currentMonthFilter = newMonth;
                }
                
                resetForm();
                setStatus(`ê±°ë˜ ê¸°ë¡ì´ ì„±ê³µì ìœ¼ë¡œ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤: ${date} - ${memo}`);
                
            } catch (error) {
                console.error("ê±°ë˜ ë“±ë¡ ì˜¤ë¥˜:", error);
                setStatus(`ê±°ë˜ ë“±ë¡ ì‹¤íŒ¨: ${error.message}`, true);
            }
        }
        async function deleteTransaction(docId) { /* ... ê¸°ì¡´ê³¼ ë™ì¼ ... */
            if (!userId || !db) {
                setStatus('ì¸ì¦ë˜ì§€ ì•Šì€ ì‚¬ìš©ìì…ë‹ˆë‹¤. ì‚­ì œ ë¶ˆê°€.', true);
                return;
            }
            
            setStatus("ê±°ë˜ë¥¼ ì‚­ì œí•©ë‹ˆë‹¤... (ì‹¤ì œ ì•±ì—ì„œëŠ” í™•ì¸ ëª¨ë‹¬ì´ í•„ìš”í•©ë‹ˆë‹¤)");

            try {
                const docRef = doc(db, `artifacts/${appId}/users/${userId}/transactions`, docId);
                await deleteDoc(docRef);
                setStatus(`ê±°ë˜ (${docId.substring(0, 5)}...)ê°€ ì„±ê³µì ìœ¼ë¡œ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.`);
            } catch (error) {
                console.error("ê±°ë˜ ì‚­ì œ ì˜¤ë¥˜:", error);
                setStatus(`ê±°ë˜ ì‚­ì œ ì‹¤íŒ¨: ${error.message}`, true);
            }
        }

        // --- NEW FEATURE: Report Generation ---
        function generateReport() {
            if (!userId) {
                setStatus('ë³´ê³ ì„œë¥¼ ì¶œë ¥í•˜ë ¤ë©´ ë¡œê·¸ì¸í•´ì•¼ í•©ë‹ˆë‹¤.', true);
                return;
            }

            const filteredData = filterAndRenderTransactions(currentMonthFilter);
            const totalIncome = parseFloat(incomeEl.textContent.replace(/[ï¿¦, -]/g, ''));
            const totalExpense = parseFloat(expenseEl.textContent.replace(/[ï¿¦, -]/g, ''));
            const netBalance = totalIncome - totalExpense; 

            const monthName = summaryMonthYearEl.textContent;
            reportMonthDisplay.textContent = monthName;

            let reportText = `[ ${monthName} ìš©ëˆê¸°ì…ì¥ ì›”ê°„ ìš”ì•½ ë³´ê³ ì„œ ]\n`;
            reportText += `===========================================================\n`;
            reportText += `\n`;
            reportText += `â–¶ ì´ ìˆ˜ì…ì•¡: ${formatCurrency(totalIncome)}\n`;
            reportText += `â–¶ ì´ ì§€ì¶œì•¡: ${formatCurrency(totalExpense)}\n`;
            reportText += `-----------------------------------------------------------\n`;
            reportText += `â–¶ ìˆœ ì”ì•¡: ${formatCurrency(netBalance)}\n`;
            reportText += `\n`;
            reportText += `[ ìƒì„¸ ê±°ë˜ ë‚´ì—­ (${filteredData.length}ê±´) ]\n`;
            reportText += `-----------------------------------------------------------\n`;
            reportText += `ë‚ ì§œ      | ê¸ˆì•¡ (ì›) | ìˆ˜ë‹¨ | ë‚´ìš©\n`;
            reportText += `-----------------------------------------------------------\n`;

            if (filteredData.length === 0) {
                reportText += `í•´ë‹¹ ì›”ì— ë“±ë¡ëœ ê±°ë˜ ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤.\n`;
            } else {
                filteredData.forEach(tx => {
                    const datePart = tx.date.substring(5); // MM-DD
                    const amountSign = tx.amount > 0 ? '+' : '-';
                    const amountDisplay = formatNumber(Math.abs(tx.amount));
                    const line = 
                        `${datePart} | ` + 
                        `${amountSign}${amountDisplay.padEnd(8)} | ` + 
                        `${tx.method.padEnd(4)} | ` + 
                        `${tx.memo.substring(0, 20)}\n`;
                    reportText += line;
                });
            }
            reportText += `===========================================================\n`;
            reportText += `\në³´ê³ ì„œ ìƒì„± ì¼ì‹œ: ${new Date().toLocaleString('ko-KR')}\n`;


            reportOutputArea.textContent = reportText;
            reportOutputContainer.classList.remove('hidden');
            setStatus('ì›”ê°„ ë³´ê³ ì„œë¥¼ ìƒì„±í–ˆìŠµë‹ˆë‹¤. í™”ë©´ì—ì„œ í™•ì¸í•´ì£¼ì„¸ìš”.');
        }

        // --- NEW FEATURE: Excel (CSV) Export ---
        function exportToCsv() {
            if (!userId) {
                setStatus('ì—‘ì…€ë¡œ ì €ì¥í•˜ë ¤ë©´ ë¡œê·¸ì¸í•´ì•¼ í•©ë‹ˆë‹¤.', true);
                return;
            }

            const filteredData = filterAndRenderTransactions(currentMonthFilter);
            if (filteredData.length === 0) {
                setStatus('ë‚´ë³´ë‚¼ ê±°ë˜ ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤.', true);
                return;
            }
            
            let csv = "No,ë‚ ì§œ,êµ¬ë¶„,ê¸ˆì•¡,ìˆ˜ë‹¨,ë‚´ìš©,íƒ€ì„ìŠ¤íƒ¬í”„\n";

            filteredData.forEach((tx, index) => {
                const row = [
                    filteredData.length - index,
                    tx.date,
                    tx.amount > 0 ? 'ìˆ˜ì…' : 'ì§€ì¶œ',
                    tx.amount, // ìˆ«ì ê·¸ëŒ€ë¡œ CSVì— ì €ì¥
                    tx.method,
                    `"${tx.memo.replace(/"/g, '""')}"`, // ì½¤ë§ˆ í¬í•¨ ë¬¸ì œ ë°©ì§€
                    tx.timestamp
                ].join(',');
                csv += row + "\n";
            });

            const blob = new Blob(["\ufeff" + csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement("a");
            
            const url = URL.createObjectURL(blob);
            link.setAttribute("href", url);
            link.setAttribute("download", `ìš©ëˆê¸°ì…ì¥_ë‚´ì—­_${currentMonthFilter}.csv`);
            link.style.visibility = 'hidden';
            
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);

            setStatus(`[${currentMonthFilter}] ê±°ë˜ ë‚´ì—­ì„ CSV íŒŒì¼ë¡œ ë‚´ë³´ëƒˆìŠµë‹ˆë‹¤.`);
        }

        // --- NEW FEATURE: Share with Parent ---

        function openShareModal() {
            if (!userId) {
                setStatus('ê³µìœ  ê¸°ëŠ¥ì„ ì‚¬ìš©í•˜ë ¤ë©´ ë¡œê·¸ì¸í•´ì•¼ í•©ë‹ˆë‹¤.', true);
                return;
            }
            shareModal.classList.remove('hidden');
            shareMonthDisplay.textContent = summaryMonthYearEl.textContent;
            shareStatusMessage.textContent = 'ì „í™”ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ê³  ê³µìœ  ë²„íŠ¼ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”.';
            shareResultSection.classList.add('hidden');
            shareInputSection.classList.remove('hidden');
            parentPhoneNumberInput.value = '';
            generatedShareLink.value = '';
            // ë²„íŠ¼ ë¹„í™œì„±í™” í•´ì œ (ì¬ì‹œë„ ëŒ€ë¹„)
            parentPhoneNumberInput.disabled = false;
            document.getElementById('share-submit-button').disabled = false;
            sendMessageButton.removeEventListener('click', handleSendMessage);
        }

        // ìƒˆë¡­ê²Œ ì¶”ê°€ëœ ë©”ì‹œì§€ ì „ì†¡ ì‹œë®¬ë ˆì´ì…˜ í•¸ë“¤ëŸ¬
        function handleSendMessage(event) {
            const phone = simulatedPhone.textContent.replace(/[^0-9]/g, '');
            const link = generatedShareLink.value;
            const messageBody = encodeURIComponent(`[${shareMonthDisplay.textContent} ìš©ëˆê¸°ì…ì¥]\nìì„¸í•œ ë‚´ì—­ì€ ì•„ë˜ ë§í¬ì—ì„œ í™•ì¸í•´ì£¼ì„¸ìš”:\n${link}`);
            
            // sms: í”„ë¡œí† ì½œì„ ì‚¬ìš©í•˜ì—¬ ë©”ì‹œì§€ ì•±ìœ¼ë¡œ ì´ë™ ì‹œë®¬ë ˆì´ì…˜
            const smsLink = `sms:${phone}?body=${messageBody}`;
            
            // A íƒœê·¸ì˜ hrefë¥¼ ì—…ë°ì´íŠ¸í•˜ê³  í´ë¦­ì„ ì‹œë®¬ë ˆì´ì…˜
            sendMessageButton.setAttribute('href', smsLink);
            
            setStatus("ë©”ì‹œì§€ ì•±ìœ¼ë¡œ ì´ë™í•˜ëŠ” ê²ƒì„ ì‹œë®¬ë ˆì´ì…˜í–ˆìŠµë‹ˆë‹¤. (ì‹¤ì œ ì „ì†¡ì€ ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤)");
        }


        async function generateShareLink() {
            if (!db || !userId) return;

            const phone = parentPhoneNumberInput.value.replace(/[^0-9]/g, '');
            if (phone.length < 8) {
                shareStatusMessage.textContent = 'ìœ íš¨í•œ ì „í™”ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.';
                return;
            }

            shareStatusMessage.textContent = 'ê³µìœ  ë³´ê³ ì„œ ìƒì„± ì¤‘... (ë°ì´í„°ë¥¼ ê³µìš© DBì— ì €ì¥)';
            parentPhoneNumberInput.disabled = true;
            document.getElementById('share-submit-button').disabled = true;


            const filteredData = filterAndRenderTransactions(currentMonthFilter);
            if (filteredData.length === 0) {
                shareStatusMessage.textContent = 'ê³µìœ í•  ê±°ë˜ ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤.';
                parentPhoneNumberInput.disabled = false;
                document.getElementById('share-submit-button').disabled = false;
                return;
            }

            try {
                const shareId = generateUUID();
                const shareData = {
                    sharedBy: userId,
                    month: currentMonthFilter,
                    transactions: filteredData.map(({ id, ...rest }) => rest), // Firestore Doc ID ì œì™¸
                    summary: {
                        income: parseFloat(incomeEl.textContent.replace(/[ï¿¦, -]/g, '')),
                        expense: parseFloat(expenseEl.textContent.replace(/[ï¿¦, -]/g, '')),
                        netBalance: parseFloat(netBalanceEl.textContent.replace(/[ï¿¦, ]/g, '')),
                    },
                    createdAt: new Date().toISOString(),
                };
                
                // ê³µìš© ì»¬ë ‰ì…˜ì— ë°ì´í„° ì €ì¥
                const publicReportRef = doc(db, `artifacts/${appId}/public/data/sharedReports`, shareId);
                await setDoc(publicReportRef, shareData);
                
                // ìš”ì²­í•˜ì‹  ê²½ë¡œì™€ shareIdë¥¼ í¬í•¨í•œ ë§í¬ ìƒì„±
                const simulatedLink = `https://yourdomain.com/k-chulnap/view.html?shareId=${shareId}`;

                // UI ì—…ë°ì´íŠ¸
                generatedShareLink.value = simulatedLink;
                simulatedPhone.textContent = phone.replace(/^(\d{3})(\d{3,4})(\d{4})$/, `$1-$2-$3`); // ì „í™”ë²ˆí˜¸ í˜•ì‹í™”
                
                shareInputSection.classList.add('hidden');
                shareResultSection.classList.remove('hidden');
                shareStatusMessage.textContent = `ë³´ê³ ì„œ ìƒì„± ì™„ë£Œ. ì•„ë˜ ë²„íŠ¼ì„ ëˆŒëŸ¬ ë©”ì‹œì§€ë¥¼ ì „ì†¡í•˜ì„¸ìš”.`;

                setStatus(`[${currentMonthFilter}] ë³´ê³ ì„œê°€ ê³µìš© ID (${shareId.substring(0, 5)}...)ë¡œ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.`);

                // ë©”ì‹œì§€ ì „ì†¡ ë²„íŠ¼ì— ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì¶”ê°€ (ë§í¬ ìƒì„± í›„)
                sendMessageButton.addEventListener('click', handleSendMessage);

            } catch (error) {
                shareStatusMessage.textContent = `ê³µìœ  ë³´ê³ ì„œ ìƒì„± ì¤‘ ì˜¤ë¥˜ ë°œìƒ: ${error.message}`;
                setStatus(`ê³µìœ  ë³´ê³ ì„œ ìƒì„± ì‹¤íŒ¨: ${error.message}`, true);
                parentPhoneNumberInput.disabled = false;
                document.getElementById('share-submit-button').disabled = false;
            }
        }


        // --- Calendar Logic ---
        const dateInputContainer = document.getElementById('dateInputContainer');
        const calendarToggleButton = document.getElementById('calendar-toggle-button');
        const customCalendar = document.getElementById('custom-calendar');
        const transactionDateInput = document.getElementById('transaction-date');
        const calendarDays = document.getElementById('calendar-days');
        const monthYearSpan = document.getElementById('calendar-month-year');
        const prevMonthButton = document.getElementById('prev-month-button');
        const nextMonthButton = document.getElementById('next-month-button');
        
        let calendarCurrentDate = new Date(TODAY.getFullYear(), TODAY.getMonth(), 1); 

        const toggleCalendar = (event) => { /* ... ê¸°ì¡´ê³¼ ë™ì¼ ... */
            if (!userId) {
                setStatus('ë¡œê·¸ì¸ í›„ ë‚ ì§œë¥¼ ì„ íƒí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.', true);
                return;
            }
            event.stopPropagation();
            customCalendar.classList.toggle('hidden');
            if (!customCalendar.classList.contains('hidden')) {
                const inputDateValue = transactionDateInput.value;
                let dateToView = TODAY;
                if (inputDateValue) {
                    const parts = inputDateValue.split('-');
                    dateToView = new Date(parseInt(parts[0]), parseInt(parts[1]) - 1, parseInt(parts[2]));
                }
                calendarCurrentDate = new Date(dateToView.getFullYear(), dateToView.getMonth(), 1);
                renderCalendar(calendarCurrentDate);
            }
        };

        function renderCalendar(date) { /* ... ê¸°ì¡´ê³¼ ë™ì¼ ... */
            const year = date.getFullYear();
            const month = date.getMonth(); 
            const today = TODAY; 
            const selectedDateString = transactionDateInput.value;
            
            monthYearSpan.textContent = `${year}ë…„ ${month + 1}ì›”`;
            calendarDays.innerHTML = '';
            
            const firstDayOfMonth = new Date(year, month, 1).getDay(); 
            const daysInMonth = new Date(year, month + 1, 0).getDate();

            let day = 1;
            let tableHtml = '';
            
            for (let i = 0; i < 6; i++) {
                tableHtml += '<tr>';
                for (let j = 0; j < 7; j++) {
                    tableHtml += '<td class="border border-[#D3D3D3] text-center">';
                    
                    if (i === 0 && j < firstDayOfMonth) {
                        tableHtml += '&nbsp;';
                    } else if (day <= daysInMonth) {
                        const cellDateString = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                        
                        const isToday = (cellDateString === `${today.getFullYear()}-${String(today.getMonth() + 1).padStart(2, '0')}-${String(today.getDate()).padStart(2, '0')}`);
                        const isCurrentSelection = (cellDateString === selectedDateString);
                        
                        let classes = 'p-1';
                        if (j === 0) classes += ' text-red-600';
                        else if (j === 6) classes += ' text-blue-600';
                        
                        if (isToday) classes += ' bg-blue-100 border border-blue-500 font-bold';
                        if (isCurrentSelection) classes = 'p-1 bg-yellow-400 border border-black font-bold';

                        tableHtml += `<span class="${classes.trim()} cursor-pointer" data-day="${day}">${day}</span>`;
                        day++;
                    }
                    
                    tableHtml += '</td>';
                }
                tableHtml += '</tr>';
                if (day > daysInMonth) break;
            }
            calendarDays.innerHTML = tableHtml;
        }

        function selectDate(e) { /* ... ê¸°ì¡´ê³¼ ë™ì¼ ... */
            const daySpan = e.target.closest('[data-day]');
            if (!daySpan || !daySpan.classList.contains('cursor-pointer')) return;

            const day = daySpan.getAttribute('data-day');
            const year = calendarCurrentDate.getFullYear();
            const month = calendarCurrentDate.getMonth() + 1;

            const newDateString = `${year}-${String(month).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
            transactionDateInput.value = newDateString;
            dateDisplay.textContent = newDateString; 

            customCalendar.classList.add('hidden');
        }

        function handleMonthChange(delta, e) { /* ... ê¸°ì¡´ê³¼ ë™ì¼ ... */
            if (e) e.stopPropagation();
            calendarCurrentDate.setMonth(calendarCurrentDate.getMonth() + delta);
            renderCalendar(calendarCurrentDate);
        }

        // --- Event Listeners and Initialization ---
        document.addEventListener('DOMContentLoaded', () => {
            // 1. Firebase/Auth Initialization
            initFirebase();

            // 2. Initial Date Setup (2025-11-08)
            const year = TODAY.getFullYear();
            const month = String(TODAY.getMonth() + 1).padStart(2, '0');
            const day = String(TODAY.getDate()).padStart(2, '0');
            const todayString = `${year}-${month}-${day}`;
            
            transactionDateInput.value = todayString;
            dateDisplay.textContent = todayString;
            currentMonthFilter = `${year}-${month}`; // 2025-11
            
            calendarCurrentDate = new Date(year, TODAY.getMonth(), 1); 
            renderCalendar(calendarCurrentDate);

            // Calendar Listeners
            if (calendarToggleButton) calendarToggleButton.addEventListener('click', toggleCalendar);
            if (transactionDateInput) transactionDateInput.addEventListener('click', toggleCalendar);
            if (prevMonthButton) prevMonthButton.addEventListener('click', (e) => handleMonthChange(-1, e));
            if (nextMonthButton) nextMonthButton.addEventListener('click', (e) => handleMonthChange(1, e));
            if (calendarDays) calendarDays.addEventListener('click', selectDate);

            document.addEventListener('click', (event) => {
                if (customCalendar && !customCalendar.contains(event.target) && !dateInputContainer.contains(event.target)) {
                    customCalendar.classList.add('hidden');
                }
            });
            
            // 3. Transaction/Auth Listeners
            if (registerButton) registerButton.addEventListener('click', saveTransaction);
            if (resetButton) resetButton.addEventListener('click', resetForm);
            if (logoutButton) logoutButton.addEventListener('click', handleLogout);

            // Auth Form Listeners
            if (authForm) authForm.addEventListener('submit', (e) => {
                e.preventDefault();
                handleAuthAction(false); // Login
            });
            if (signupButton) signupButton.addEventListener('click', (e) => {
                e.preventDefault();
                handleAuthAction(true); // Sign Up
            });

            // NEW FEATURE Listeners
            document.getElementById('report-button').addEventListener('click', generateReport);
            document.getElementById('excel-button').addEventListener('click', exportToCsv);
            document.getElementById('share-button').addEventListener('click', openShareModal);
            document.getElementById('share-submit-button').addEventListener('click', generateShareLink);
            document.getElementById('modal-close-button').addEventListener('click', () => shareModal.classList.add('hidden'));

            // ëª¨ë‹¬ ë‹«ê¸°
            shareModal.addEventListener('click', (e) => {
                if (e.target === shareModal) {
                    shareModal.classList.add('hidden');
                }
            });

            // ë©”ì‹œì§€ ì „ì†¡ ë²„íŠ¼ì— ì´ˆê¸°ì—ëŠ” ë¦¬ìŠ¤ë„ˆë¥¼ ì¶”ê°€í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤. (generateShareLink ì„±ê³µ í›„ ì¶”ê°€)
        });
    </script>
</body>
</html>
