<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>250KB ë¯¸ë§Œ ì´ë¯¸ì§€ ìµœì í™” ë„êµ¬</title>
    <!-- Tailwind CSS CDN ë¡œë“œ -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* í°íŠ¸ ì„¤ì • ë° ê¸°ë³¸ ìŠ¤íƒ€ì¼ */
        body { font-family: 'Inter', sans-serif; background-color: #f7f7f7; }
        .card { box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1), 0 0 10px -5px rgba(0, 0, 0, 0.04); }
        /* ìˆ¨ê²¨ì§„ ìº”ë²„ìŠ¤ */
        #processingCanvas { display: none; }
    </style>
</head>
<body class="flex items-center justify-center min-h-screen p-4">

    <div id="appContainer" class="card bg-white p-8 rounded-xl w-full max-w-lg">
        <h1 class="text-3xl font-bold text-gray-800 mb-6 text-center">
            2F9
        </h1>
        <p class="text-center text-sm text-gray-500 mb-8">
            íŒŒì¼ì„ ì„ íƒí•˜ì‹œë©´ ìë™ìœ¼ë¡œ  ìµœì í™”í•©ë‹ˆë‹¤. (JPG, PNG ì§€ì›)
        </p>

        <!-- íŒŒì¼ ì…ë ¥ ì„¹ì…˜ -->
        <div class="mb-6">
            <label for="fileInput" class="block text-sm font-medium text-gray-700 mb-2">ì´ë¯¸ì§€ íŒŒì¼ ì—…ë¡œë“œ</label>
            <input type="file" id="fileInput" accept="image/jpeg, image/png" class="block w-full text-sm text-gray-900 border border-gray-300 rounded-lg cursor-pointer bg-gray-50 p-2.5" onchange="handleFileSelect(this.files)">
        </div>

        <!-- ìƒíƒœ ë° ê²°ê³¼ í‘œì‹œ ì„¹ì…˜ -->
        <div id="statusMessage" class="text-center text-sm text-blue-600 font-semibold mb-4 hidden">
            ì´ë¯¸ì§€ ìµœì í™” ì¤‘... ì ì‹œë§Œ ê¸°ë‹¤ë ¤ ì£¼ì„¸ìš”.
        </div>

        <div id="resultSection" class="border border-gray-200 rounded-xl p-4 bg-gray-50 hidden">
            <h2 class="text-lg font-semibold text-gray-800 mb-3">ë³€í™˜ ê²°ê³¼</h2>
            <div id="sizeInfo" class="mb-4 text-sm space-y-1">
                <!-- ì—¬ê¸°ì— ì›ë³¸/ê²°ê³¼ ìš©ëŸ‰ ì •ë³´ í‘œì‹œ -->
            </div>
            
            <div id="imagePreviewContainer" class="flex justify-center mb-4">
                <img id="compressedImagePreview" class="rounded-lg max-w-full h-auto border border-gray-300" alt="ìµœì í™”ëœ ì´ë¯¸ì§€ ë¯¸ë¦¬ë³´ê¸°" style="max-height: 200px;">
            </div>

            <!-- ë‹¤ìš´ë¡œë“œ ë²„íŠ¼ -->
            <button id="downloadButton" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg transition duration-150 ease-in-out" onclick="downloadImage()" disabled>
                ğŸ’¾ ìµœì í™”ëœ ì´ë¯¸ì§€ ë‹¤ìš´ë¡œë“œ
            </button>
        </div>

        <!-- ì—ëŸ¬ ë©”ì‹œì§€ -->
        <div id="errorMessage" class="mt-4 p-3 bg-red-100 border border-red-400 text-red-700 rounded-lg hidden">
            <!-- ì—ëŸ¬ ë©”ì‹œì§€ í‘œì‹œ -->
        </div>

        <!-- ì´ë¯¸ì§€ ì²˜ë¦¬ë¥¼ ìœ„í•œ ìº”ë²„ìŠ¤ (ìˆ¨ê¹€) -->
        <canvas id="processingCanvas"></canvas>
    </div>

    <script>
        // ëª©í‘œ ìš©ëŸ‰: 250 KB (ë°”ì´íŠ¸ë¡œ ë³€í™˜)
        const MAX_SIZE_BYTES = 250 * 1024;

        const fileInput = document.getElementById('fileInput');
        const statusMessage = document.getElementById('statusMessage');
        const errorMessage = document.getElementById('errorMessage');
        const resultSection = document.getElementById('resultSection');
        const sizeInfo = document.getElementById('sizeInfo');
        const compressedImagePreview = document.getElementById('compressedImagePreview');
        const downloadButton = document.getElementById('downloadButton');
        const canvas = document.getElementById('processingCanvas');
        const ctx = canvas.getContext('2d');
        
        let finalDataUrl = ''; // ìµœì¢… ì••ì¶•ëœ ì´ë¯¸ì§€ Data URL ì €ì¥

        /**
         * Data URL ë¬¸ìì—´ì˜ í¬ê¸°ë¥¼ ë°”ì´íŠ¸ ë‹¨ìœ„ë¡œ ê³„ì‚°í•©ë‹ˆë‹¤.
         * @param {string} dataUrl - 'data:image/jpeg;base64,...' í˜•ì‹ì˜ ë¬¸ìì—´
         * @returns {number} - ë°”ì´íŠ¸ í¬ê¸°
         */
        function getDataUrlSize(dataUrl) {
            // Data URLì—ì„œ 'data:mime/type;base64,' ë¶€ë¶„ì„ ì œì™¸í•œ ìˆœìˆ˜ base64 ë¬¸ìì—´ë§Œ ì¶”ì¶œ
            const base64 = dataUrl.split(',')[1];
            // base64 ë¬¸ìì—´ì˜ ê¸¸ì´ (ë°”ì´íŠ¸ë‹¹ 6ë¹„íŠ¸, 4ê¸€ìë‹¹ 3ë°”ì´íŠ¸)ë¥¼ ì´ìš©í•´ ì‹¤ì œ ë°ì´í„° í¬ê¸° ê³„ì‚°
            // = íŒ¨ë”© ë¬¸ìëŠ” ì œì™¸í•´ì•¼ ì •í™•í•˜ì§€ë§Œ, ê·¼ì‚¬ì¹˜ë¡œ ê³„ì‚°
            return (base64.length * 0.75) - (base64.indexOf('=') > 0 ? (base64.length - base64.indexOf('=')) : 0);
        }

        /**
         * ë°”ì´íŠ¸ í¬ê¸°ë¥¼ KB ë˜ëŠ” MBë¡œ ë³€í™˜í•˜ì—¬ ë³´ê¸° ì‰½ê²Œ í¬ë§·í•©ë‹ˆë‹¤.
         * @param {number} bytes - ë°”ì´íŠ¸ í¬ê¸°
         * @returns {string} - í¬ë§·ëœ ë¬¸ìì—´
         */
        function formatBytes(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        /**
         * ì´ë¯¸ì§€ë¥¼ ë¡œë“œí•˜ê³  ì••ì¶• í”„ë¡œì„¸ìŠ¤ë¥¼ ì‹œì‘í•©ë‹ˆë‹¤.
         * @param {File[]} files - ì„ íƒëœ íŒŒì¼ ë°°ì—´
         */
        function handleFileSelect(files) {
            if (!files || files.length === 0) return;
            
            const file = files[0];
            
            // UI ì´ˆê¸°í™”
            errorMessage.classList.add('hidden');
            resultSection.classList.add('hidden');
            statusMessage.classList.remove('hidden');
            downloadButton.disabled = true;

            if (file.size <= MAX_SIZE_BYTES) {
                // ì´ë¯¸ ìš©ëŸ‰ ë¯¸ë§Œì¼ ê²½ìš° ì²˜ë¦¬
                statusMessage.classList.add('hidden');
                resultSection.classList.remove('hidden');
                sizeInfo.innerHTML = `
                    <p class="text-green-600 font-medium">âœ¨ íŒŒì¼ì´ ì´ë¯¸ 250KB ë¯¸ë§Œì…ë‹ˆë‹¤! (ì›ë³¸ ìš©ëŸ‰: ${formatBytes(file.size)})</p>
                    <p>ë³„ë„ì˜ ì••ì¶• ì—†ì´ ë‹¤ìš´ë¡œë“œ ê°€ëŠ¥í•©ë‹ˆë‹¤.</p>
                `;
                const reader = new FileReader();
                reader.onload = function(e) {
                    finalDataUrl = e.target.result;
                    compressedImagePreview.src = finalDataUrl;
                    downloadButton.disabled = false;
                };
                reader.readAsDataURL(file);
                return;
            }

            if (!file.type.match('image.*')) {
                displayError('âš ï¸ ì´ë¯¸ì§€ íŒŒì¼ë§Œ ì—…ë¡œë“œí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.');
                return;
            }

            const reader = new FileReader();
            reader.onload = function(event) {
                const img = new Image();
                img.onload = function() {
                    // ì´ë¯¸ì§€ ì²˜ë¦¬ë¥¼ ë¹„ë™ê¸°ë¡œ ì‹œì‘
                    processImage(img, file.size);
                };
                img.onerror = function() {
                    displayError('ì´ë¯¸ì§€ë¥¼ ë¡œë“œí•˜ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                };
                img.src = event.target.result;
            };
            reader.readAsDataURL(file);
        }

        /**
         * ì´ë¯¸ì§€ ê°ì²´ë¥¼ ë°›ì•„ 250KB ë¯¸ë§Œì´ ë  ë•Œê¹Œì§€ ë°˜ë³µì ìœ¼ë¡œ ì••ì¶•í•©ë‹ˆë‹¤.
         * @param {Image} img - ë¡œë“œëœ ì´ë¯¸ì§€ ê°ì²´
         * @param {number} originalSize - ì›ë³¸ íŒŒì¼ í¬ê¸° (ë°”ì´íŠ¸)
         */
        function processImage(img, originalSize) {
            // ìº”ë²„ìŠ¤ í¬ê¸° ì„¤ì • (ì›ë³¸ í¬ê¸° ìœ ì§€)
            canvas.width = img.width;
            canvas.height = img.height;
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            ctx.drawImage(img, 0, 0);

            // ì••ì¶• í’ˆì§ˆ (0.0 - 1.0)
            let quality = 0.9; 
            // í’ˆì§ˆ ê°ì†Œ ë‹¨ê³„
            const step = 0.05; 
            let compressedSize = originalSize;

            console.log('--- ì••ì¶• ì‹œì‘ ---');
            
            // ë°˜ë³µì ìœ¼ë¡œ í’ˆì§ˆì„ ë‚®ì¶°ê°€ë©° ì••ì¶• ì‹œë„
            while (compressedSize > MAX_SIZE_BYTES && quality > 0.1) {
                // JPGë¡œ ì••ì¶•í•˜ì—¬ Data URL ìƒì„±
                finalDataUrl = canvas.toDataURL('image/jpeg', quality);
                compressedSize = getDataUrlSize(finalDataUrl);

                console.log(`í’ˆì§ˆ: ${quality.toFixed(2)}, í¬ê¸°: ${formatBytes(compressedSize)}`);

                if (compressedSize <= MAX_SIZE_BYTES) {
                    break; // ëª©í‘œ ë‹¬ì„±
                }

                // í’ˆì§ˆ ê°ì†Œ
                quality -= step;
                // ìµœì†Œ í’ˆì§ˆ ë³´ì¥ (ë„ˆë¬´ ë‚®ì•„ì§€ë©´ í€„ë¦¬í‹°ê°€ ì‹¬í•˜ê²Œ ì €í•˜ë¨)
                if (quality < 0.1) quality = 0.1; 
            }

            statusMessage.classList.add('hidden');
            resultSection.classList.remove('hidden');

            if (compressedSize <= MAX_SIZE_BYTES) {
                // ì„±ê³µì ìœ¼ë¡œ ì••ì¶•ëœ ê²½ìš°
                compressedImagePreview.src = finalDataUrl;
                downloadButton.disabled = false;
                downloadButton.classList.remove('bg-gray-400');
                downloadButton.classList.add('bg-green-600');

                sizeInfo.innerHTML = `
                    <p>âœ… **ì›ë³¸ ìš©ëŸ‰**: ${formatBytes(originalSize)}</p>
                    <p>ğŸ‰ **ìµœì í™” ìš©ëŸ‰**: <span class="text-green-600 font-bold">${formatBytes(compressedSize)}</span></p>
                    <p>ğŸ”’ **ì‚¬ìš©ëœ í’ˆì§ˆ**: ${quality.toFixed(2)}</p>
                `;

            } else {
                // ìµœëŒ€ ì••ì¶•ì—ë„ ëª©í‘œ ë‹¬ì„± ì‹¤íŒ¨í•œ ê²½ìš°
                finalDataUrl = canvas.toDataURL('image/jpeg', 0.1); // ìµœì†Œ í’ˆì§ˆë¡œ ìµœì¢… ë³€í™˜
                compressedSize = getDataUrlSize(finalDataUrl);
                compressedImagePreview.src = finalDataUrl;
                downloadButton.disabled = false; // ë‹¤ìš´ë¡œë“œëŠ” ê°€ëŠ¥í•˜ê²Œ í•˜ë˜, ê²½ê³  í‘œì‹œ

                sizeInfo.innerHTML = `
                    <p>âœ… **ì›ë³¸ ìš©ëŸ‰**: ${formatBytes(originalSize)}</p>
                    <p>âš ï¸ **ìµœì í™” ìš©ëŸ‰**: <span class="text-red-600 font-bold">${formatBytes(compressedSize)}</span></p>
                    <p class="text-red-600 font-semibold mt-2">ìµœì†Œ í’ˆì§ˆ(0.1)ë¡œ ì••ì¶•í–ˆìœ¼ë‚˜ 250KBë¥¼ ì´ˆê³¼í–ˆìŠµë‹ˆë‹¤. ë” í° ì´ë¯¸ì§€ì¼ ê²½ìš° ë¦¬ì‚¬ì´ì¦ˆ(í¬ê¸° ì¡°ì ˆ)ê°€ í•„ìš”í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
                `;
            }
            
            console.log('--- ì••ì¶• ì™„ë£Œ ---');
        }

        /**
         * ë³€í™˜ëœ ì´ë¯¸ì§€ë¥¼ ë‹¤ìš´ë¡œë“œí•©ë‹ˆë‹¤.
         */
        function downloadImage() {
            if (!finalDataUrl) {
                displayError('ë‹¤ìš´ë¡œë“œí•  ì´ë¯¸ì§€ê°€ ì—†ìŠµë‹ˆë‹¤.');
                return;
            }

            const a = document.createElement('a');
            a.href = finalDataUrl;
            // íŒŒì¼ ì´ë¦„ì„ 'compressed_ì´ë¯¸ì§€ëª….jpg' í˜•ì‹ìœ¼ë¡œ ì„¤ì •
            const originalFileName = fileInput.files[0] ? fileInput.files[0].name.split('.')[0] : 'image';
            a.download = `compressed_${originalFileName}.jpg`;
            
            // ë‹¤ìš´ë¡œë“œ ë§í¬ë¥¼ DOMì— ì¶”ê°€í–ˆë‹¤ê°€ ë°”ë¡œ í´ë¦­ í›„ ì œê±°
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
        }

        /**
         * ì—ëŸ¬ ë©”ì‹œì§€ë¥¼ ì‚¬ìš©ìì—ê²Œ í‘œì‹œí•©ë‹ˆë‹¤.
         * @param {string} message - í‘œì‹œí•  ì—ëŸ¬ ë©”ì‹œì§€
         */
        function displayError(message) {
            statusMessage.classList.add('hidden');
            resultSection.classList.add('hidden');
            errorMessage.innerHTML = message;
            errorMessage.classList.remove('hidden');
            // íŒŒì¼ ì…ë ¥ ì´ˆê¸°í™” (ì„ íƒëœ íŒŒì¼ëª… ì œê±°)
            fileInput.value = '';
        }
    </script>
</body>
</html>
