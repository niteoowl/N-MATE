<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>N-MATE</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* CSS 변수를 사용하여 색상을 정의합니다. */
        :root {
            --bg-primary: #17171c; /* 업데이트된 배경색 */
            --bg-secondary: #201f27; /* 업데이트된 박스색 */
            --text-primary: #E0E0E0;
            --text-secondary: #A0A0A0;
            --color-blue: #007BFF;
            --border-color: #201f27; /* 박스색과 동일하게 설정 */
            --bg-hover: #33323a; /* 버튼 호버를 위해 약간 더 밝은 색으로 설정 */
        }

        /* wanted-sans 폰트를 로드합니다. */
        @import url('https://fastly.jsdelivr.dev/gh/wanteddev/wanted-sans@v1.0.1/packages/wanted-sans/fonts/webfonts/variable/split/WantedSansVariable.min.css');
        
        body {
            font-family: 'WantedSansVariable', sans-serif;
            background-color: var(--bg-primary);
            color: var(--text-primary);
            padding-bottom: 5rem;
        }
        
        /* 스크롤바 숨기기 */
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        
        /* 슬라이드 패널 애니메이션 */
        .slide-panel { transform: translateY(100%); transition: transform 0.3s ease-in-out; z-index: 60; }
        .slide-panel.is-visible { transform: translateY(0); }
        
        /* 스크롤 시 헤더 스타일 */
        .header-scrolled {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 50;
            background-color: rgba(23, 23, 28, 0.8);
            backdrop-filter: blur(8px);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }
        .header-scrolled .header-inner { padding-top: 0.5rem; padding-bottom: 0.5rem; }
        .header-scrolled .header-inner img { height: 2rem; }
        
        header, .header-inner, .header-inner img, .header-inner button { transition: all 0.3s ease-in-out; }
        
        .nav-inner { width: 100%; }
        @media (min-width: 768px) { .nav-inner { max-width: 768px; margin-left: auto; margin-right: auto; } }
        
        .invert-icon { filter: invert(1); }
        
        /* 새로운 시간표 그리드 셀 스타일 */
        .timetable-grid > div {
            border-right: 1px solid var(--border-color);
            border-bottom: 1px solid var(--border-color);
            background-color: var(--bg-secondary);
        }
        .timetable-grid > div:nth-child(6n) { border-right: none; }
        .timetable-grid > div:nth-last-child(-n+6) { border-bottom: none; }
        .timetable-grid .grid-cell-day,
        .timetable-grid .grid-cell-hour {
            min-height: 3rem;
            background-color: var(--bg-secondary);
            font-weight: bold;
            color: var(--text-primary);
            font-size: 0.875rem;
            padding: 1rem 0.75rem;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        .timetable-grid .grid-cell-hour {
            min-height: 5rem;
            font-size: 1.125rem;
            padding: 0.5rem;
        }
        .timetable-grid .grid-cell {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            padding: 0.5rem;
            min-height: 5rem;
            transition: background-color 0.2s;
        }
        .timetable-grid .grid-cell:hover {
            background-color: var(--bg-hover);
        }
        .dropdown-menu {
            opacity: 0;
            visibility: hidden;
            transform: translateY(10px);
            transition: all 0.2s ease-in-out;
        }
        .dropdown-menu.is-visible {
            opacity: 1;
            visibility: visible;
            transform: translateY(0);
        }
        
        /* 커뮤니티 배너 컨테이너의 최소 높이 상향 조정 */
        .community-banner {
            min-height: 200px; /* 모바일에서 충분한 높이를 확보 */
            position: relative; /* 자식 요소의 절대 위치 기준 */
        }
        
        /* 텍스트 컨테이너의 높이를 조정 */
        .community-text-container {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            padding: 1rem;
            display: flex;
            flex-direction: column;
            justify-content: flex-end;
            min-height: 100px; /* 텍스트가 들어갈 최소 높이 */
            background: linear-gradient(to top, rgba(0, 0, 0, 0.8) 0%, rgba(0, 0, 0, 0) 100%);
        }

        /* 반응형 폰트 크기 및 패딩 재조정 */
        @media (min-width: 768px) {
            .community-banner {
                min-height: 250px; /* 데스크톱에서 더 높은 높이 확보 */
            }
            .community-text-container {
                padding: 1.5rem;
                min-height: 120px;
            }
        }
    </style>
    <!-- Firebase SDK Scripts -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.0.0/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.0.0/firebase-auth.js";
        import { getFirestore, doc, getDoc } from "https://www.gstatic.com/firebasejs/10.0.0/firebase-firestore.js";

        // Firebase 설정. 사용자가 제공한 설정 정보를 사용합니다.
        const firebaseConfig = {
            apiKey: "AIzaSyC_SHRcQ9hXmjVbP3km4rdR4UvKIoqpLHo",
            authDomain: "n-mate.firebaseapp.com",
            projectId: "n-mate",
            storageBucket: "n-mate.firebasestorage.app",
            messagingSenderId: "691313471077",
            appId: "1:691313471077:web:3066aaeca0a1d9e448e08c",
            measurementId: "G-0LCGVBKXLQ"
        };
        
        // 앱 ID를 전역 변수에서 가져옵니다. 없을 경우 'default-app-id'를 사용합니다.
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

        // Firebase 앱 초기화
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // 전역 변수 설정
        window.auth = auth;
        window.db = db;
        window.appId = appId;
    </script>
</head>
<body class="bg-[--bg-primary] text-white">

    <!-- 메인 컨테이너 -->
    <div class="container mx-auto px-4 md:px-8 max-w-screen-md pt-24 md:pt-28">

        <!-- 헤더 섹션 -->
        <header id="main-header" class="fixed top-0 left-0 right-0 z-50 bg-[--bg-primary] transition-all duration-300">
            <div class="header-inner container mx-auto max-w-screen-md px-4 md:px-8 py-4 flex items-center justify-between">
                <div class="flex items-center">
                    <img src="https://i.postimg.cc/XvKJktcP/001-2025-08-01-T220040-650.png" alt="hanilians 로고" class="h-8 md:h-10 w-auto transition-all duration-300">
                </div>
                <div id="auth-ui-container" class="flex items-center space-x-2">
                    <!-- JavaScript로 로그인 버튼 또는 사용자 프로필이 여기에 동적으로 추가됩니다 -->
                </div>
            </div>
        </header>

        <!-- 알림/정보 섹션 -->
        <div class="bg-[--bg-secondary] rounded-2xl p-4 flex items-start space-x-2 mb-6">
            <span class="text-2xl mt-1 flex-shrink-0">✨</span>
            <div>
                <!-- 텍스트 수정 -->
                <p class="font-medium text-base">새로워진 N-MATE, 어떠세요?</p>
                <!-- 텍스트 및 색상 수정 -->
                <p class="text-white font-medium text-sm">피드백하러 가기</p>
            </div>
            <button class="ml-auto p-1.5 rounded-full text-white hover:bg-[--bg-secondary] transition-colors duration-200">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-chevron-right"><path d="m9 18 6-6-6-6"/></svg>
            </button>
        </div>

        <!-- 커뮤니티 섹션 -->
        <!-- 이미지 높이 문제 해결을 위해 min-height를 설정하고 텍스트 컨테이너를 조정 -->
        <div class="relative bg-gray-800 rounded-3xl overflow-hidden mb-6 community-banner">
            <img src="https://i.postimg.cc/wv0jSJrc/001-88.png" alt="커뮤니티 배경" class="w-full h-full absolute top-0 left-0 object-cover">
            <div class="absolute inset-0 bg-black bg-opacity-50 p-4 md:p-6 flex flex-col justify-between">
                <button class="ml-auto p-2 rounded-full text-white hover:bg-gray-700 hover:bg-opacity-75 transition-colors duration-200">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-x"><path d="M18 6 6 18"/><path d="m6 6 12 12"/></svg>
                </button>
                <div class="mt-auto">
                    <!-- 텍스트 잘림 문제를 해결하기 위해 폰트 크기를 모바일 우선으로 수정 -->
                    <h2 class="text-white text-base md:text-xl font-bold mb-2">N-MATE 3.0으로 완전히 달라졌어요!</h2>
                    <p class="text-white text-xs md:text-sm mb-4">오늘도 N-MATE는 변화합니다</p>
                    <button class="bg-gray-700 bg-opacity-50 hover:bg-opacity-75 text-white font-medium py-2 px-4 rounded-full flex items-center space-x-2 transition-colors duration-200">
                        <span>더 보기</span>
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-arrow-right"><path d="M5 12h14"/><path d="m12 5 7 7-7 7"/></svg>
                    </button>
                </div>
            </div>
        </div>

        <!-- 오늘의 메뉴 & 날씨 탭 섹션 -->
        <div class="mb-4">
            <div class="flex items-end justify-between">
                <div class="flex items-center space-x-4">
                    <button id="menu-tab" class="font-bold text-xl pb-1 border-b-2 border-white transition-colors duration-200">오늘의 급식</button>
                    <button id="weather-tab" class="font-bold text-xl pb-1 text-gray-400 border-b-2 border-transparent hover:text-white transition-colors duration-200">날씨</button>
                </div>
                <button id="date-picker-toggle" class="p-2 rounded-full text-white hover:bg-[--bg-secondary] transition-colors duration-200">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-chevron-down"><path d="m6 9 6 6 6-6"/></svg>
                </button>
            </div>
            <div id="date-display" class="text-gray-400 text-sm mt-2"></div>
        </div>

        <!-- 오늘의 메뉴 카드 섹션 (동적 콘텐츠) -->
        <div id="menu-content" class="mb-8">
            <div id="meal-card" class="bg-[--bg-secondary] p-4 rounded-2xl w-full flex items-center justify-center min-h-[10rem]">
                <p class="text-gray-400">급식 정보를 불러오는 중...</p>
            </div>
        </div>
        
        <!-- 날씨 섹션 (동적 콘텐츠) -->
        <div id="weather-content" class="hidden mb-8">
            <div id="weather-card" class="bg-[--bg-secondary] p-6 rounded-2xl flex items-center justify-center min-h-[10rem]">
                <p class="text-gray-400">날씨 정보를 불러오는 중...</p>
            </div>
        </div>
        
        <!-- 이미지에 맞춰 추가된 섹션들 -->
        <div class="space-y-4 mt-6">
            <div class="flex items-center justify-between mb-4">
                <h1 id="timetable-title" class="text-xl font-bold">시간표</h1>
                <div class="flex items-center ml-2">
                    <span id="current-week-display" class="text-sm text-gray-400 mr-2"></span>
                    <button id="prev-week-button" class="p-2 rounded-full text-white hover:bg-[--bg-secondary] transition-colors duration-200">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-chevron-left"><path d="m15 18-6-6 6-6"/></svg>
                    </button>
                    <button id="next-week-button" class="p-2 rounded-full text-white hover:bg-[--bg-secondary] transition-colors duration-200">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucude-chevron-right"><path d="m9 18 6-6-6-6"/></svg>
                    </button>
                </div>
            </div>

            <!-- 시간표 섹션 -->
            <div id="timetable-content" class="bg-[--bg-secondary] rounded-3xl overflow-hidden shadow-lg mb-4">
                <!-- 동적으로 생성될 주간 시간표 컨테이너 -->
                <div class="text-center text-gray-400 flex flex-col items-center justify-center min-h-[35rem]">
                    <p>로그인하여 시간표를 확인하세요.</p>
                </div>
            </div>
            
            <!-- 두근두근 설레는 시험 섹션 (수정된 부분) -->
            <div class="mt-8">
                <h3 class="text-xl font-bold mb-4">두근두근 설레는 시험</h3>
                <div id="exam-dday-section" class="grid grid-cols-2 sm:grid-cols-3 gap-4 text-center">
                    <!-- JavaScript로 동적으로 시험 디데이가 추가됩니다 -->
                    <div class="flex items-center justify-center col-span-2 sm:col-span-3 h-24">
                        <p class="text-gray-400">시험 일정을 불러오는 중...</p>
                    </div>
                </div>
            </div>
            
            <hr class="my-6 border-gray-700">

            <!-- 학사일정 섹션 (동적으로 생성될 컨테이너) -->
            <div>
                <h3 class="text-xl font-bold mb-4">학사일정</h3>
                <div id="academic-schedule-content" class="space-y-4">
                    <!-- JavaScript로 동적으로 학사일정 정보가 여기에 추가됩니다 -->
                    <div class="flex items-center justify-center p-4">
                        <p class="text-gray-400">학사일정을 불러오는 중...</p>
                    </div>
                </div>
            </div>
            
            <hr class="my-6 border-gray-700">
        </div>
    </div>

    <!-- 날짜 선택 패널 -->
    <div id="date-picker-panel" class="fixed bottom-0 left-0 right-0 bg-[--bg-secondary] rounded-t-3xl shadow-lg transition-transform duration-300 slide-panel">
        <div class="flex justify-between items-center p-4 border-b border-gray-700">
            <h3 class="text-lg font-bold">날짜 선택</h3>
            <button id="close-panel" class="p-2 rounded-full text-white hover:bg-[--bg-hover] transition-colors duration-200">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-x"><path d="M18 6 6 18"/><path d="m6 6 12 12"/></svg>
            </button>
        </div>
        <!-- 달력 UI가 들어갈 곳 -->
        <div id="calendar-container" class="p-4 h-64 overflow-y-auto no-scrollbar">
            <!-- JavaScript로 달력이 여기에 동적으로 생성됩니다. -->
        </div>
    </div>

    <!-- 하단 내비게이션 바 -->
    <nav class="fixed bottom-0 left-0 right-0 bg-[#17171b] border-t border-gray-700 z-50">
        <div class="nav-inner py-1 px-4 flex justify-around items-center">
            <a href="#" class="flex flex-col items-center p-1 rounded-xl text-white hover:bg-[--bg-hover] transition-colors duration-200">
                <img src="https://www.hanilians.xyz/header/home-filled.svg" alt="홈 아이콘" class="w-7 h-7 invert-icon">
                <span class="text-xs">홈</span>
            </a>
            <!-- 아이콘 색상을 통일하고 텍스트 색상을 일관성 있게 수정합니다. -->
            <a href="#" class="flex flex-col items-center p-1 rounded-xl text-[--text-secondary] hover:bg-[--bg-hover] hover:text-white transition-colors duration-200">
                <svg width="28" height="28" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" stroke="currentColor" stroke-width="2" style="color: var(--text-secondary);" class="w-7 h-7">
                    <path d="M7 4h10a3 3 0 0 1 3 3v6a3 3 0 0 1-3 3H11l-3 3v-3H7a3 3 0 0 1-3-3V7a3 3 0 0 1 3-3z" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
                <span class="text-xs">학교생활</span>
            </a>
            <!-- '커뮤니티' 텍스트와 아이콘 색상을 통일성 있게 수정합니다. -->
            <a href="#" class="flex flex-col items-center p-1 rounded-xl text-[--text-secondary] hover:bg-[--bg-hover] hover:text-white transition-colors duration-200">
                <img src="https://www.hanilians.xyz/header/news.svg" alt="커뮤니티 아이콘" class="w-7 h-7" style="filter: brightness(0) invert(0.6);">
                <span class="text-xs">커뮤니티</span>
            </a>
            <!-- '더보기' 텍스트와 아이콘 색상을 통일성 있게 수정합니다. -->
            <a href="#" class="flex flex-col items-center p-1 rounded-xl text-[--text-secondary] hover:bg-[--bg-hover] hover:text-white transition-colors duration-200">
                <svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-ellipsis" style="color: var(--text-secondary);">
                    <circle cx="12" cy="12" r="1"/>
                    <circle cx="19" cy="12" r="1"/>
                    <circle cx="5" cy="12" r="1"/>
                </svg>
                <span class="text-xs">더보기</span>
            </a>
        </div>
    </nav>
    
    <script type="module">
        import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.0.0/firebase-auth.js";
        import { getFirestore, doc, getDoc } from "https://www.gstatic.com/firebasejs/10.0.0/firebase-firestore.js";

        // Firebase 인스턴스는 전역적으로 사용 가능
        const auth = window.auth;
        const db = window.db;
        const appId = window.appId;

        const datePickerToggle = document.getElementById('date-picker-toggle');
        const datePickerPanel = document.getElementById('date-picker-panel');
        const closePanelButton = document.getElementById('close-panel');
        const mainHeader = document.getElementById('main-header');
        const menuTab = document.getElementById('menu-tab');
        const weatherTab = document.getElementById('weather-tab');
        const menuContent = document.getElementById('menu-content');
        const weatherContent = document.getElementById('weather-content');
        const mealCard = document.getElementById('meal-card');
        const weatherCard = document.getElementById('weather-card');
        const dateDisplay = document.getElementById('date-display');
        const calendarContainer = document.getElementById('calendar-container');
        const timetableContent = document.getElementById('timetable-content');
        const prevWeekButton = document.getElementById('prev-week-button');
        const nextWeekButton = document.getElementById('next-week-button');
        const currentWeekDisplay = document.getElementById('current-week-display');
        const timetableTitle = document.getElementById('timetable-title');
        const authUiContainer = document.getElementById('auth-ui-container');
        const academicScheduleContent = document.getElementById('academic-schedule-content');
        // 새로운 시험 디데이 섹션
        const examDdaySection = document.getElementById('exam-dday-section');

        let currentDate = new Date();
        let currentWeekMonday = getMonday(currentDate);

        // 사용자의 프로필 데이터를 저장할 변수
        let userProfile = null;

        // Firebase Auth 상태 변화를 감지하는 리스너
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                try {
                    // 새로운 사용자 문서 경로를 사용합니다.
                    const profileRef = doc(db, 'artifacts', appId, 'users', user.uid, 'profile', 'user_data');
                    const profileSnap = await getDoc(profileRef);

                    if (profileSnap.exists()) {
                        userProfile = profileSnap.data();
                        
                        // 새로운 데이터 형식의 필드 존재 여부를 확인합니다.
                        if (!userProfile.sdSchulCode || !userProfile.atptOfcdcScCode) {
                            console.error("사용자 프로필에 학교 정보가 없거나 코드가 누락되었습니다.");
                            showProfileSetupRequiredState();
                            return;
                        }
                        
                        // schoolName 대신 userProfile.name을 표시하도록 수정합니다.
                        // name 필드가 없으면 schoolName을 사용합니다.
                        const userNameToDisplay = userProfile.name || userProfile.schoolName || user.email || '사용자';
                        
                        console.log("User profile loaded:", userProfile);
                        updateAuthUI(userNameToDisplay); // 이름으로 UI 업데이트
                        loadPersonalizedContent();
                    } else {
                        console.log("No user profile document found, but user is logged in.");
                        const userName = user.email || '사용자';
                        userProfile = null;
                        updateAuthUI(userName);
                        showProfileSetupRequiredState();
                    }
                } catch (error) {
                    console.error("Error fetching user profile:", error);
                    updateAuthUI(user.email || '사용자');
                    showProfileSetupRequiredState();
                }
            } else {
                console.log("User is signed out.");
                userProfile = null;
                updateAuthUI(null);
                showLoginRequiredState();
            }
        });

        // 로그인 상태에 따라 UI를 업데이트하는 함수
        function updateAuthUI(userName) {
            authUiContainer.innerHTML = '';
            if (userName) {
                // 로그인 상태: 사용자 이름과 드롭다운
                const dropdownHtml = `
                    <div class="relative group">
                        <button id="user-name-button" class="bg-gray-700 bg-opacity-50 hover:bg-opacity-75 text-white font-medium py-1.5 px-4 rounded-full flex items-center space-x-2 transition-colors duration-200">
                            <span>${userName}</span>
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-chevron-down"><path d="m6 9 6 6 6-6"/></svg>
                        </button>
                        <div id="dropdown-menu" class="dropdown-menu absolute right-0 mt-2 py-2 w-48 bg-[--bg-secondary] rounded-md shadow-lg z-50">
                            <button id="logout-button" class="block w-full text-left px-4 py-2 text-sm text-white hover:bg-[--bg-hover]">로그아웃</button>
                        </div>
                    </div>
                `;
                authUiContainer.innerHTML = dropdownHtml;

                const dropdownButton = document.getElementById('user-name-button');
                const dropdownMenu = document.getElementById('dropdown-menu');
                const logoutButton = document.getElementById('logout-button');

                dropdownButton.addEventListener('click', () => {
                    dropdownMenu.classList.toggle('is-visible');
                });
                logoutButton.addEventListener('click', () => {
                    signOut(auth)
                        .then(() => console.log('Signed out successfully.'))
                        .catch(error => console.error('Sign out error:', error));
                });
            } else {
                // 로그아웃 상태: 로그인 버튼
                const loginButtonHtml = `
                    <button id="login-button" class="login-button bg-transparent font-medium py-1.5 px-4 rounded-full text-sm border border-gray-700 hover:bg-[--bg-hover] transition-colors duration-200">로그인</button>
                `;
                authUiContainer.innerHTML = loginButtonHtml;
                document.getElementById('login-button').addEventListener('click', () => {
                    // 로그인 페이지로 이동 (예시)
                    // window.location.href = '/login'; 
                    // 현재는 기능이 없으므로 콘솔 로그만 남깁니다.
                    console.log('로그인 버튼 클릭됨');
                });
            }
        }
        
        // 로그인 상태에 따라 콘텐츠를 로드하거나 로그인 요청 메시지를 표시하는 함수
        function loadPersonalizedContent() {
            if (userProfile) {
                // 사용자 프로필이 있는 경우
                timetableTitle.textContent = `${userProfile.grade}학년 ${userProfile.classNum}반 시간표`;
                const today = new Date();
                const todayStr = formatDate(today);
                
                const dayOfWeek = today.getDay(); // 0 = Sunday, 6 = Saturday
                if (dayOfWeek === 0 || dayOfWeek === 6) {
                    // 주말인 경우
                    mealCard.innerHTML = `<p class="text-gray-400">주말에는 급식 정보가 제공되지 않아요.</p>`;
                    timetableContent.innerHTML = `
                        <div class="text-center text-gray-400 flex flex-col items-center justify-center min-h-[35rem] p-4">
                            <p>주말에는 시간표 정보가 제공되지 않아요.</p>
                        </div>
                    `;
                } else {
                    // 평일인 경우
                    // 업데이트된 함수 호출: 새로운 필드 이름을 사용합니다.
                    fetchMealData(todayStr, userProfile.sdSchulCode, userProfile.atptOfcdcScCode);
                    fetchAndRenderWeeklyTimetable(currentWeekMonday, userProfile.sdSchulCode, userProfile.grade, userProfile.classNum, userProfile.atptOfcdcScCode);
                }
                
                // 학사일정 정보 가져오기
                fetchAcademicSchedule(userProfile.sdSchulCode, userProfile.atptOfcdcScCode);
                // 시험 디데이 정보 가져오기 (새로 추가)
                fetchAndRenderExamDdays(userProfile.sdSchulCode, userProfile.atptOfcdcScCode);

            } else {
                // 사용자 프로필이 없는 경우
                showLoginRequiredState();
            }
        }
        
        // 로그인 필요 상태 UI
        function showLoginRequiredState() {
            timetableTitle.textContent = `시간표`;
            mealCard.innerHTML = `
                <div class="text-center p-4">
                    <p class="font-medium text-lg">로그인하여 맞춤형 정보를 확인하세요</p>
                    <p class="text-sm text-gray-400 mt-1">로그인 버튼을 눌러주세요!</p>
                </div>
            `;
            timetableContent.innerHTML = `
                <div class="text-center text-gray-400 flex flex-col items-center justify-center min-h-[35rem] p-4">
                    <p>로그인하여 시간표를 확인하세요.</p>
                </div>
            `;
            academicScheduleContent.innerHTML = `
                <div class="flex items-center justify-center p-4">
                    <p class="text-gray-400">로그인하여 학사일정을 확인하세요.</p>
                </div>
            `;
            examDdaySection.innerHTML = `
                <div class="flex items-center justify-center col-span-2 sm:col-span-3 h-24">
                    <p class="text-gray-400">로그인하여 시험 일정을 확인하세요.</p>
                </div>
            `;
        }

        // 프로필 설정 필요 상태 UI (로그인은 되었지만 프로필이 없는 경우)
        function showProfileSetupRequiredState() {
             timetableTitle.textContent = `시간표`;
             mealCard.innerHTML = `
                <div class="text-center p-4">
                    <p class="font-medium text-lg">프로필 설정을 완료해주세요</p>
                    <p class="text-sm text-gray-400 mt-1">학교, 학년, 반 정보를 입력해야 급식 및 시간표를 확인할 수 있어요.</p>
                </div>
             `;
             timetableContent.innerHTML = `
                <div class="text-center text-gray-400 flex flex-col items-center justify-center min-h-[35rem] p-4">
                    <p>프로필 정보를 불러올 수 없습니다.</p>
                    <p>프로필 설정을 완료해주세요.</p>
                </div>
             `;
             academicScheduleContent.innerHTML = `
                <div class="flex items-center justify-center p-4">
                    <p class="text-gray-400">프로필 설정을 완료해야 학사일정을 확인할 수 있어요.</p>
                </div>
             `;
             examDdaySection.innerHTML = `
                <div class="flex items-center justify-center col-span-2 sm:col-span-3 h-24">
                    <p class="text-gray-400">프로필 설정을 완료해야 시험 일정을 확인할 수 있어요.</p>
                </div>
            `;
        }


        // 해당 날짜가 속한 주의 월요일을 구하는 함수
        function getMonday(d) {
            d = new Date(d);
            const day = d.getDay();
            const diff = d.getDate() - day + (day === 0 ? -6 : 1); // 월요일(1)부터 시작
            return new Date(d.setDate(diff));
        }

        // 날짜를 YYYYMMDD 형식의 문자열로 변환하는 헬퍼 함수
        function formatDate(date) {
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            return `${year}${month}${day}`;
        }
        
        // 날짜를 YYYY.MM.DD 형식으로 변환하는 헬퍼 함수
        function formatDisplayDate(dateStr) {
            const year = dateStr.substring(0, 4);
            const month = dateStr.substring(4, 6);
            const day = dateStr.substring(6, 8);
            return `${year}.${month}.${day}`;
        }
        
        // 두 날짜 간의 D-Day를 계산하는 헬퍼 함수
        function calculateDday(targetDateStr) {
            const today = new Date();
            const targetDate = new Date(targetDateStr.substring(0, 4), parseInt(targetDateStr.substring(4, 6)) - 1, targetDateStr.substring(6, 8));
            
            today.setHours(0, 0, 0, 0); // 오늘 날짜의 자정을 기준으로 계산
            targetDate.setHours(0, 0, 0, 0);

            const diffTime = targetDate.getTime() - today.getTime();
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
            
            if (diffDays === 0) {
                return 'D-Day';
            } else if (diffDays > 0) {
                return `D-${diffDays}`;
            } else {
                return `D+${Math.abs(diffDays)}`;
            }
        }

        // NEIS API에서 급식 데이터를 가져오는 함수 (매개변수 추가)
        async function fetchMealData(mlsYmd, schoolCode, officeCode) {
            mealCard.innerHTML = `<p class="text-gray-400">급식 정보를 불러오는 중...</p>`;

            const apiKey = '0c3b4def034a4eb5b75e830500a30898';
            const apiUrl = `https://open.neis.go.kr/hub/mealServiceDietInfo?KEY=${apiKey}&Type=json&pIndex=1&pSize=100&ATPT_OFCDC_SC_CODE=${officeCode}&SD_SCHUL_CODE=${schoolCode}&MLSV_YMD=${mlsYmd}`;

            try {
                const response = await fetch(apiUrl);
                const data = await response.json();
                
                if (data.RESULT && data.RESULT.CODE === 'INFO-200') {
                    mealCard.innerHTML = `
                        <div class="text-center p-4">
                            <p class="font-medium text-lg">급식 정보가 없어요</p>
                            <p class="text-sm text-gray-400 mt-1">학사 일정 또는 주말/방학 기간인지 확인해주세요!</p>
                        </div>
                    `;
                    return;
                }
                
                if (data.mealServiceDietInfo && data.mealServiceDietInfo.length > 1 && data.mealServiceDietInfo[1].row) {
                    const mealInfo = data.mealServiceDietInfo[1].row;
                    const lunchMeal = mealInfo.find(meal => meal.MMEAL_SC_NM === '중식');

                    if (lunchMeal) {
                        const rawDishName = lunchMeal.DDISH_NM;
                        const cleanedDishName = rawDishName
                            .split('<br/>')
                            .filter(item => item.trim() !== '')
                            .map(item => item.replace(/\s*\(\d+\.?\d*\.?\d*\.?\d*\.?\d*\.?\d*\.?\d*\.?\d*\.?\d*\.?\d*\.?\d*\.?\d*\.?\d*\.?\d*\.?\d*\.?\d*\.?\d*\.?\d*\.?\d*\)?/g, '').trim())
                            .join('</li><li>');

                        const mealHtml = `
                            <div class="p-4 rounded-2xl w-full">
                                <h3 class="font-bold text-lg mb-2">${lunchMeal.MMEAL_SC_NM}</h3>
                                <p class="text-sm text-gray-400 mb-2">${lunchMeal.CAL_INFO || ''}</p>
                                <ul class="text-sm space-y-1 text-white">
                                    <li>${cleanedDishName}</li>
                                </ul>
                            </div>
                        `;
                        mealCard.innerHTML = mealHtml;
                    } else {
                        mealCard.innerHTML = `
                            <div class="text-center p-4">
                                <p class="font-medium text-lg">선택한 날짜에 중식 정보가 없습니다.</p>
                                <p class="text-sm text-gray-400 mt-1">다른 식사 정보를 확인해보세요.</p>
                            </div>
                        `;
                    }
                } else {
                    mealCard.innerHTML = `<p class="text-gray-400">급식 정보를 가져올 수 없습니다.</p>`;
                }
            } catch (error) {
                console.error('Failed to fetch meal data:', error);
                mealCard.innerHTML = `<p class="text-red-500">네트워크 오류가 발생했습니다. 잠시 후 다시 시도해주세요.</p>`;
            }
        }

        // NEIS API에서 주간 시간표 데이터를 가져와서 렌더링하는 함수 (매개변수 추가)
        async function fetchAndRenderWeeklyTimetable(mondayDate, schoolCode, grade, classNm, officeCode) {
            // 데이터를 불러오는 중 상태 표시
            timetableContent.innerHTML = `
                <div class="text-center text-gray-400 flex flex-col items-center justify-center min-h-[35rem] p-4">
                    <p>시간표를 불러오는 중...</p>
                </div>
            `;

            // 이번 주 월요일과 금요일 날짜 계산
            const tiFromYmd = formatDate(mondayDate);
            const fridayDate = new Date(mondayDate);
            fridayDate.setDate(mondayDate.getDate() + 4);
            const tiToYmd = formatDate(fridayDate);

            const fromYear = mondayDate.getFullYear();
            const fromMonth = mondayDate.getMonth() + 1;
            const fromDay = mondayDate.getDate();
            const toYear = fridayDate.getFullYear();
            const toMonth = fridayDate.getMonth() + 1;
            const toDay = fridayDate.getDate();
            currentWeekDisplay.textContent = `${fromYear}.${fromMonth}.${fromDay} ~ ${toYear}.${toMonth}.${toDay}`;

            const apiKey = '0c3b4def034a4eb5b75e830500a30898';
            
            const apiUrl = `https://open.neis.go.kr/hub/misTimetable?KEY=${apiKey}&Type=json&pIndex=1&pSize=100&ATPT_OFCDC_SC_CODE=${officeCode}&SD_SCHUL_CODE=${schoolCode}&GRADE=${grade}&CLASS_NM=${classNm}&TI_FROM_YMD=${tiFromYmd}&TI_TO_YMD=${tiToYmd}`;
            
            try {
                const response = await fetch(apiUrl);
                const data = await response.json();
                
                if (data.RESULT && data.RESULT.CODE === 'INFO-200') {
                    timetableContent.innerHTML = `
                        <div class="text-center text-gray-400 flex flex-col items-center justify-center min-h-[35rem] p-4">
                            <p class="font-medium text-lg text-white">시간표 정보가 없어요</p>
                            <p class="text-sm text-gray-400 mt-1">학사 일정 또는 주말/방학 기간인지 확인해주세요!</p>
                        </div>
                    `;
                    return;
                }
                
                if (data.misTimetable && data.misTimetable.length > 1 && data.misTimetable[1].row) {
                    const timetableData = data.misTimetable[1].row;
                    renderWeeklyTimetable(timetableData);
                } else {
                    timetableContent.innerHTML = `<p class="text-red-500">시간표 정보를 가져올 수 없습니다. API 응답 구조를 확인하세요.</p>`;
                }

            } catch (error) {
            console.error('Failed to fetch weekly timetable data:', error);
            timetableContent.innerHTML = `<p class="text-red-500">네트워크 오류가 발생했습니다. 잠시 후 다시 시도해주세요.</p>`;
            }
        }
        
        // 주간 시간표 데이터를 받아와서 동적으로 HTML 테이블을 그리는 함수 (그리드 버전)
        function renderWeeklyTimetable(data) {
            data.sort((a, b) => parseInt(a.PERIO) - parseInt(b.PERIO));

            const days = ['월', '화', '수', '목', '금'];
            const timetableByDay = {};
            days.forEach(day => timetableByDay[day] = []);

            data.forEach(item => {
                const date = item.ALL_TI_YMD;
                const dayOfWeek = new Date(date.slice(0, 4), date.slice(4, 6) - 1, date.slice(6, 8)).getDay();
                if (dayOfWeek >= 1 && dayOfWeek <= 5) {
                    const dayName = days[dayOfWeek - 1];
                    timetableByDay[dayName].push(item);
                }
            });

            let gridHtml = `
                <div class="grid grid-cols-6 text-center text-sm font-medium timetable-grid overflow-x-auto no-scrollbar">
                    <div class="grid-cell-day rounded-tl-3xl min-w-[50px] md:min-w-0">교시</div>
                    <div class="grid-cell-day min-w-[100px] md:min-w-0">월</div>
                    <div class="grid-cell-day min-w-[100px] md:min-w-0">화</div>
                    <div class="grid-cell-day min-w-[100px] md:min-w-0">수</div>
                    <div class="grid-cell-day min-w-[100px] md:min-w-0">목</div>
                    <div class="grid-cell-day rounded-tr-3xl min-w-[100px] md:min-w-0">금</div>
            `;
            
            const maxPeriods = Math.max(...Object.values(timetableByDay).map(dayData => dayData.length));
            
            for (let period = 1; period <= maxPeriods; period++) {
                gridHtml += `<div class="grid-cell-hour min-w-[50px] md:min-w-0">${period}</div>`;
                days.forEach((day, index) => {
                    const subject = timetableByDay[day].find(item => parseInt(item.PERIO) === period);
                    const isLastRow = period === maxPeriods;
                    const isLastCol = index === days.length - 1;
                    let cellClasses = 'grid-cell';

                    if (isLastRow) {
                        cellClasses += (index === 0) ? ' rounded-bl-3xl' : '';
                        cellClasses += (isLastCol) ? ' rounded-br-3xl' : '';
                    }

                    gridHtml += `<div class="${cellClasses} min-w-[100px] md:min-w-0">`;
                    if (subject) {
                        gridHtml += `
                            <span class="font-medium text-sm">${subject.ITRT_CNTNT}</span>
                            ${subject.PRFN_GRNM ? `<span class="text-xs text-gray-400 mt-1">${subject.PRFN_GRNM}</span>` : ''}
                        `;
                    } else {
                        gridHtml += `<span class="font-medium text-sm">-</span><span class="text-xs text-gray-400 mt-1">-</span>`;
                    }
                    gridHtml += `</div>`;
                });
            }
            gridHtml += `</div>`;
            
            timetableContent.innerHTML = gridHtml;
        }
        
        // 새로운 함수: NEIS API에서 학사일정 데이터를 가져와서 시험 디데이를 계산하고 렌더링
        async function fetchAndRenderExamDdays(schoolCode, officeCode) {
            examDdaySection.innerHTML = `
                <div class="flex items-center justify-center col-span-2 sm:col-span-3 h-24">
                    <p class="text-gray-400">시험 일정을 불러오는 중...</p>
                </div>
            `;

            const currentYear = new Date().getFullYear();
            const AA_FROM_YMD = `${currentYear}0101`;
            const AA_TO_YMD = `${currentYear}1231`;
            const apiKey = '0c3b4def034a4eb5b75e830500a30898';
            const apiUrl = `https://open.neis.go.kr/hub/SchoolSchedule?KEY=${apiKey}&Type=json&pIndex=1&pSize=100&ATPT_OFCDC_SC_CODE=${officeCode}&SD_SCHUL_CODE=${schoolCode}&AA_FROM_YMD=${AA_FROM_YMD}&AA_TO_YMD=${AA_TO_YMD}`;

            try {
                const response = await fetch(apiUrl);
                const data = await response.json();
                
                if (data.RESULT && data.RESULT.CODE === 'INFO-200') {
                    examDdaySection.innerHTML = `
                        <div class="flex items-center justify-center col-span-2 sm:col-span-3 h-24">
                            <p class="text-gray-400">시험 정보가 없습니다.</p>
                        </div>
                    `;
                    return;
                }

                if (data.SchoolSchedule && data.SchoolSchedule.length > 1 && data.SchoolSchedule[1].row) {
                    const scheduleData = data.SchoolSchedule[1].row;
                    
                    const examDates = {
                        '중간고사': null,
                        '기말고사': null,
                        '영어듣기평가': null,
                    };
                    
                    const today = new Date();
                    today.setHours(0, 0, 0, 0);

                    // 학사일정 데이터를 순회하며 가장 빠른 시험 날짜를 찾습니다.
                    scheduleData.forEach(event => {
                        const eventName = event.EVENT_NM;
                        const eventDateStr = event.AA_YMD;
                        
                        // 이미 날짜를 찾은 시험은 건너뜁니다.
                        if (examDates['중간고사'] && examDates['기말고사'] && examDates['영어듣기평가']) return;
                        
                        // 정규표현식을 사용하여 유연하게 일정을 찾습니다.
                        if (eventName.includes('중간') && eventName.includes('고사') && !examDates['중간고사']) {
                            examDates['중간고사'] = eventDateStr;
                        } else if (eventName.includes('기말') && eventName.includes('고사') && !examDates['기말고사']) {
                            examDates['기말고사'] = eventDateStr;
                        } else if (eventName.includes('영어듣기') && eventName.includes('평가') && !examDates['영어듣기평가']) {
                            examDates['영어듣기평가'] = eventDateStr;
                        }
                    });

                    let examHtml = '';
                    let foundExam = false;

                    // 찾은 시험 날짜를 바탕으로 D-Day를 계산하고 HTML을 생성합니다.
                    for (const examName in examDates) {
                        const examDateStr = examDates[examName];
                        if (examDateStr) {
                            foundExam = true;
                            const dDay = calculateDday(examDateStr);
                            let statusText = dDay;
                            let statusColor = 'text-[--color-blue]';
                            
                            // 날짜가 이미 지났으면 "종료됨"으로 표시
                            if (dDay.startsWith('D+')) {
                                statusText = '종료됨';
                                statusColor = 'text-gray-400';
                            }

                            examHtml += `
                                <div class="p-4 bg-[--bg-secondary] rounded-2xl flex flex-col items-center justify-center h-24">
                                    <p class="font-medium">${examName}</p>
                                    <p class="font-bold ${statusColor}">${statusText}</p>
                                </div>
                            `;
                        }
                    }

                    if (foundExam) {
                        examDdaySection.innerHTML = examHtml;
                    } else {
                        examDdaySection.innerHTML = `
                            <div class="flex items-center justify-center col-span-2 sm:col-span-3 h-24">
                                <p class="text-gray-400">예정된 시험 정보가 없습니다.</p>
                            </div>
                        `;
                    }

                } else {
                    examDdaySection.innerHTML = `<p class="text-red-500">시험 정보를 가져올 수 없습니다.</p>`;
                }

            } catch (error) {
                console.error('Failed to fetch exam D-day data:', error);
                examDdaySection.innerHTML = `<p class="text-red-500">네트워크 오류가 발생했습니다. 잠시 후 다시 시도해주세요.</p>`;
            }
        }
        
        // 기존 함수: NEIS API에서 학사일정 데이터를 가져와서 렌더링하는 함수
        async function fetchAcademicSchedule(schoolCode, officeCode) {
            academicScheduleContent.innerHTML = `
                <div class="flex items-center justify-center p-4">
                    <p class="text-gray-400">학사일정을 불러오는 중...</p>
                </div>
            `;

            const today = new Date();
            const year = today.getFullYear();
            const month = today.getMonth() + 1;
            const AA_FROM_YMD = `${year}${String(month).padStart(2, '0')}01`;
            const AA_TO_YMD = `${year}${String(month).padStart(2, '0')}${new Date(year, month, 0).getDate()}`;

            const apiKey = '0c3b4def034a4eb5b75e830500a30898';
            const apiUrl = `https://open.neis.go.kr/hub/SchoolSchedule?KEY=${apiKey}&Type=json&pIndex=1&pSize=100&ATPT_OFCDC_SC_CODE=${officeCode}&SD_SCHUL_CODE=${schoolCode}&AA_FROM_YMD=${AA_FROM_YMD}&AA_TO_YMD=${AA_TO_YMD}`;

            try {
                const response = await fetch(apiUrl);
                const data = await response.json();

                if (data.RESULT && data.RESULT.CODE === 'INFO-200') {
                    academicScheduleContent.innerHTML = `
                        <div class="flex items-center justify-center p-4">
                            <p class="text-gray-400">학사일정 정보가 없습니다.</p>
                        </div>
                    `;
                    return;
                }

                if (data.SchoolSchedule && data.SchoolSchedule.length > 1 && data.SchoolSchedule[1].row) {
                    const scheduleData = data.SchoolSchedule[1].row;
                    
                    // "토요휴업일" 제외
                    const filteredData = scheduleData.filter(event => event.EVENT_NM !== '토요휴업일');
                    
                    // 중복 일정 이름 찾기
                    const eventCounts = new Map();
                    filteredData.forEach(event => {
                        const eventName = event.EVENT_NM;
                        eventCounts.set(eventName, (eventCounts.get(eventName) || 0) + 1);
                    });

                    // 중복 없는 이벤트 이름만 저장
                    const displayedEvents = new Set();
                    
                    // 날짜 순으로 정렬
                    filteredData.sort((a, b) => a.AA_YMD.localeCompare(b.AA_YMD));
                    
                    academicScheduleContent.innerHTML = ''; // 기존 로딩 메시지 제거
                    
                    if (filteredData.length === 0) {
                        academicScheduleContent.innerHTML = `
                            <div class="flex items-center justify-center p-4">
                                <p class="text-gray-400">학사일정 정보가 없습니다.</p>
                            </div>
                        `;
                        return;
                    }

                    filteredData.forEach(event => {
                        const eventName = event.EVENT_NM;
                        const isDuplicate = eventCounts.get(eventName) > 1;

                        // 중복이 있는 일정은 한 번만 표시
                        if (!isDuplicate || !displayedEvents.has(eventName)) {
                            const eventDate = isDuplicate ? '' : formatDisplayDate(event.AA_YMD);
                            
                            const eventHtml = `
                                <div class="flex items-center justify-between">
                                    <div class="flex items-center">
                                        <span class="text-xs text-white rounded-full px-2 py-1 mr-2 bg-[--bg-hover]">${event.SCHUL_EVENT_NM || '일반'}</span>
                                        <span class="font-medium">${eventName}</span>
                                    </div>
                                    <span class="text-sm text-gray-400">${eventDate}</span>
                                </div>
                            `;
                            academicScheduleContent.innerHTML += eventHtml;
                            displayedEvents.add(eventName);
                        }
                    });
                } else {
                    academicScheduleContent.innerHTML = `<p class="text-red-500">학사일정 정보를 가져올 수 없습니다.</p>`;
                }
            } catch (error) {
                console.error('Failed to fetch academic schedule data:', error);
                academicScheduleContent.innerHTML = `<p class="text-red-500">네트워크 오류가 발생했습니다. 잠시 후 다시 시도해주세요.</p>`;
            }
        }
        

        // 날씨 데이터를 가져오는 함수 (실제 API 호출을 시뮬레이션)
        async function fetchWeatherData() {
            weatherCard.innerHTML = `<p class="text-gray-400">날씨 정보를 불러오는 중...</p>`;

            try {
                const dummyWeatherData = {
                    description: '맑음, 구름 조금',
                    temp: 25,
                    temp_max: 28,
                    temp_min: 20
                };

                await new Promise(resolve => setTimeout(resolve, 1000));

                const description = dummyWeatherData.description;
                const temp = dummyWeatherData.temp;
                const tempMax = dummyWeatherData.temp_max;
                const tempMin = dummyWeatherData.temp_min;

                const weatherHtml = `
                    <div class="bg-[--bg-secondary] p-6 rounded-2xl flex items-center space-x-4 w-full">
                        <svg xmlns="http://www.w3.org/2000/svg" width="60" height="60" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-cloud-sun text-[--text-primary]">
                            <path d="M12 2v2"/><path d="m4.93 4.93 1.41 1.41"/><path d="M2 12h2"/><path d="M4.93 19.07l1.41-1.41"/><path d="M12 12a4 4 0 1 0 0-8 4 4 0 0 0 0 8Z"/><path d="M20 16a5 5 0 0 0-8.5-4H11a6 6 0 0 0-6 6v1a3 3 0 0 0 3 3h13a4 4 0 0 0 0-8Z"/>
                        </svg>
                        <div>
                            <p class="text-3xl font-bold">${temp}°C</p>
                            <p class="text-gray-400">${description}</p>
                            <p class="text-sm text-gray-500">최고 ${tempMax}°C / 최저 ${tempMin}°C</p>
                        </div>
                    </div>
                `;
                weatherCard.innerHTML = weatherHtml;
            } catch (error) {
                console.error('Failed to fetch weather data:', error);
                weatherCard.innerHTML = `<p class="text-red-500">날씨 정보를 가져오는 데 실패했습니다.</p>`;
            }
        }

        // 달력을 렌더링하는 함수
        function renderCalendar(date) {
            const year = date.getFullYear();
            const month = date.getMonth();
            const today = new Date();
            const todayYear = today.getFullYear();
            const todayMonth = today.getMonth();
            const todayDay = today.getDate();

            const firstDayOfMonth = new Date(year, month, 1);
            const lastDayOfMonth = new Date(year, month + 1, 0);
            const daysInMonth = lastDayOfMonth.getDate();
            const firstDayOfWeek = firstDayOfMonth.getDay();

            currentDate = date;

            let calendarHtml = `
                <div class="flex justify-between items-center mb-4">
                    <button id="prev-month-button" class="p-2 rounded-full hover:bg-[--bg-hover]">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-chevron-left"><path d="m15 18-6-6 6-6"/></svg>
                    </button>
                    <span id="current-month-year" class="font-bold text-lg">${year}년 ${month + 1}월</span>
                    <button id="next-month-button" class="p-2 rounded-full hover:bg-[--bg-hover]">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-chevron-right"><path d="m9 18 6-6-6-6"/></svg>
                    </button>
                </div>
                <div class="grid grid-cols-7 text-center text-sm font-medium text-gray-400 mb-2">
                    <div>일</div><div>월</div><div>화</div><div>수</div><div>목</div><div>금</div><div>토</div>
                </div>
                <div id="calendar-days-grid" class="grid grid-cols-7 text-center">
            `;

            for (let i = 0; i < firstDayOfWeek; i++) {
                calendarHtml += `<div class="p-2"></div>`;
            }

            for (let day = 1; day <= daysInMonth; day++) {
                const isToday = todayYear === year && todayMonth === month && todayDay === day;
                const dateStr = `${year}${String(month + 1).padStart(2, '0')}${String(day).padStart(2, '0')}`;
                
                calendarHtml += `
                    <button class="p-2 rounded-full font-medium ${isToday ? 'bg-[--color-blue] text-white' : 'hover:bg-[--bg-hover]'}" data-date="${dateStr}">
                        ${day}
                    </button>
                `;
            }
            
            calendarHtml += `</div>`;
            calendarContainer.innerHTML = calendarHtml;
            
            document.getElementById('prev-month-button').addEventListener('click', () => {
                const prevMonth = new Date(currentDate.getFullYear(), currentDate.getMonth() - 1, 1);
                renderCalendar(prevMonth);
            });
            document.getElementById('next-month-button').addEventListener('click', () => {
                const nextMonth = new Date(currentDate.getFullYear(), currentDate.getMonth() + 1, 1);
                renderCalendar(nextMonth);
            });
            
            document.querySelectorAll('#calendar-days-grid button').forEach(button => {
                button.addEventListener('click', (event) => {
                    const selectedDate = event.target.dataset.date;
                    handleDateClick(selectedDate);
                });
            });
        }
        
        // 날짜 선택 시 호출되는 핸들러
        function handleDateClick(dateStr) {
            const year = dateStr.substring(0, 4);
            const month = dateStr.substring(4, 6);
            const day = dateStr.substring(6, 8);
            
            const selectedDate = new Date(year, parseInt(month, 10) - 1, parseInt(day, 10));
            const daysOfWeek = ['일', '월', '화', '수', '목', '금', '토'];
            const dayName = daysOfWeek[selectedDate.getDay()];

            dateDisplay.textContent = `${year}년 ${parseInt(month, 10)}월 ${parseInt(day, 10)}일 (${dayName})`;
            if (userProfile) {
                // 업데이트된 함수 호출: 새로운 필드 이름을 사용합니다.
                fetchMealData(dateStr, userProfile.sdSchulCode, userProfile.atptOfcdcScCode);
            } else {
                mealCard.innerHTML = `<p class="text-gray-400">로그인하여 급식 정보를 확인하세요.</p>`;
            }
            datePickerPanel.classList.remove('is-visible');
        }

        const togglePanel = () => {
            datePickerPanel.classList.toggle('is-visible');
        };

        window.addEventListener('scroll', () => {
            if (window.scrollY > 50) {
                mainHeader.classList.add('header-scrolled');
            } else {
                mainHeader.classList.remove('header-scrolled');
            }
        });

        const switchTab = (activeTab) => {
            const isMenu = activeTab === 'menu';
            menuTab.classList.toggle('border-white', isMenu);
            menuTab.classList.toggle('text-gray-400', !isMenu);
            menuTab.classList.toggle('border-transparent', !isMenu);
            
            weatherTab.classList.toggle('border-white', !isMenu);
            weatherTab.classList.toggle('text-gray-400', isMenu);
            weatherTab.classList.toggle('border-transparent', isMenu);

            menuContent.classList.toggle('hidden', !isMenu);
            weatherContent.classList.toggle('hidden', isMenu);
            
            if (isMenu) {
                const today = new Date();
                const year = today.getFullYear();
                const month = String(today.getMonth() + 1).padStart(2, '0');
                const day = String(today.getDate()).padStart(2, '0');
                const dateStr = `${year}${month}${day}`;
                
                const selectedDate = new Date(year, parseInt(month, 10) - 1, parseInt(day, 10));
                const daysOfWeek = ['일', '월', '화', '수', '목', '금', '토'];
                const dayName = daysOfWeek[selectedDate.getDay()];
                dateDisplay.textContent = `${year}년 ${parseInt(month, 10)}월 ${parseInt(day, 10)}일 (${dayName})`;

                if(userProfile) {
                    // 업데이트된 함수 호출: 새로운 필드 이름을 사용합니다.
                    fetchMealData(dateStr, userProfile.sdSchulCode, userProfile.atptOfcdcScCode);
                } else {
                    mealCard.innerHTML = `<p class="text-gray-400">로그인하여 급식 정보를 확인하세요.</p>`;
                }

            } else {
                fetchWeatherData();
            }
        };

        // 주간 네비게이션 버튼 이벤트 리스너
        prevWeekButton.addEventListener('click', () => {
            if (userProfile) {
                currentWeekMonday.setDate(currentWeekMonday.getDate() - 7);
                // 업데이트된 함수 호출: 새로운 필드 이름을 사용합니다.
                fetchAndRenderWeeklyTimetable(currentWeekMonday, userProfile.sdSchulCode, userProfile.grade, userProfile.classNum, userProfile.atptOfcdcScCode);
            }
        });
        nextWeekButton.addEventListener('click', () => {
            if (userProfile) {
                currentWeekMonday.setDate(currentWeekMonday.getDate() + 7);
                // 업데이트된 함수 호출: 새로운 필드 이름을 사용합니다.
                fetchAndRenderWeeklyTimetable(currentWeekMonday, userProfile.sdSchulCode, userProfile.grade, userProfile.classNum, userProfile.atptOfcdcScCode);
            }
        });

        // 초기 탭 로드 시 데이터 가져오기
        switchTab('menu');
        // 초기 달력 렌더링
        renderCalendar(currentDate);

        datePickerToggle.addEventListener('click', togglePanel);
        closePanelButton.addEventListener('click', togglePanel);
        menuTab.addEventListener('click', () => switchTab('menu'));
        weatherTab.addEventListener('click', () => switchTab('weather'));
    </script>
</body>
</html>
